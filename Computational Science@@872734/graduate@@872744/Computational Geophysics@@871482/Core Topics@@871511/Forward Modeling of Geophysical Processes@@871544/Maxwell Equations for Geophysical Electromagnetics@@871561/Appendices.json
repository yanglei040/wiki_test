{"hands_on_practices": [{"introduction": "Before building complex simulations, it is essential to understand the numerical stability and accuracy of the underlying algorithms. This exercise explores these foundational concepts for the magnetic diffusion equation, which governs Time Domain Electromagnetics (TDEM) phenomena. By applying von Neumann stability analysis to both explicit and implicit time-stepping schemes, you will gain practical skills in determining the maximum allowable time step to ensure a simulation is both stable and accurate, a critical first step in any computational modeling endeavor [@problem_id:3610044].", "problem": "Consider Time Domain Electromagnetics (TDEM) governed by the magnetic diffusion equation for the magnetic flux density $\\mathbf{B}$,\n$$\\partial_{t}\\mathbf{B} = -\\nabla\\times\\left(\\rho\\,\\nabla\\times \\mathbf{B}\\right),$$\nwhere the magnetic diffusivity is $\\rho = \\frac{1}{\\mu \\sigma}$, with $\\mu$ the magnetic permeability and $\\sigma$ the electrical conductivity. In a homogeneous medium with constant $\\mu$ and $\\sigma$, assume $\\nabla\\cdot\\mathbf{B}=0$ is satisfied initially and is preserved.\n\nYou will analyze two time-stepping schemes applied to the semi-discrete system obtained from second-order centered finite differences on a uniform Yee staggered grid in a triply periodic cubic domain of side $L$, with grid spacings $\\Delta x = \\Delta y = \\Delta z = \\Delta$. Use Von Neumann Fourier analysis. For this grid and discretization, the discrete curl-curl operator acting on divergence-free Fourier modes with wave vector $\\mathbf{k} = (k_{x},k_{y},k_{z})$ has an eigenvalue of the form $\\rho\\,\\omega(\\mathbf{k})$, where\n$$\\omega(\\mathbf{k}) = \\sum_{i\\in\\{x,y,z\\}} \\frac{4}{\\Delta^{2}}\\sin^{2}\\left(\\frac{k_{i}\\Delta}{2}\\right).$$\nAssume periodic boundary conditions so that the discrete wavenumbers attain their maximum magnitude at $k_{i}\\Delta = \\pi$.\n\n- For the explicit forward Euler method applied to the semi-discrete system, derive the linear stability constraint on the time step $\\Delta t$ in terms of the largest-magnitude discrete eigenvalue of the right-hand side operator.\n- For the implicit Crank–Nicolson method, which is second-order accurate in time, derive an accuracy constraint on $\\Delta t$ by requiring that, for the mode with the largest $|\\lambda|$, the one-step relative amplitude error compared to the exact solution be no larger than $\\varepsilon = 0.01$.\n\nTake $\\mu = \\mu_{0} = 4\\pi\\times 10^{-7}$, $\\sigma = 1$, and $\\Delta = 25$. Using the derived constraints, compute:\n\n1. The largest stable $\\Delta t$ for explicit forward Euler.\n2. The largest $\\Delta t$ for Crank–Nicolson that satisfies the above accuracy requirement.\n\nRound your answers to four significant figures. Express both time steps in seconds.", "solution": "The problem requires the derivation of time step constraints for two different numerical schemes, explicit forward Euler and implicit Crank–Nicolson, applied to the semi-discretized magnetic diffusion equation.\n\nThe governing equation in the time domain is given by:\n$$ \\partial_{t}\\mathbf{B} = -\\nabla\\times\\left(\\rho\\,\\nabla\\times \\mathbf{B}\\right) $$\nIn a homogeneous medium with constant resistivity $\\rho$, this simplifies to $\\partial_{t}\\mathbf{B} = -\\rho\\,\\nabla\\times(\\nabla\\times \\mathbf{B})$.\nUsing the vector identity $\\nabla\\times(\\nabla\\times \\mathbf{B}) = \\nabla(\\nabla\\cdot\\mathbf{B}) - \\nabla^2\\mathbf{B}$ and the condition $\\nabla\\cdot\\mathbf{B}=0$, the equation becomes the vector diffusion equation:\n$$ \\partial_{t}\\mathbf{B} = \\rho\\nabla^2\\mathbf{B} $$\nUpon spatial discretization using second-order centered finite differences on a uniform Yee grid, a system of ordinary differential equations (ODEs) is obtained. For a single Fourier mode with wave vector $\\mathbf{k}$, this semi-discrete system takes the form:\n$$ \\frac{d\\hat{\\mathbf{B}}_{\\mathbf{k}}}{dt} = \\lambda(\\mathbf{k})\\hat{\\mathbf{B}}_{\\mathbf{k}} $$\nwhere $\\hat{\\mathbf{B}}_{\\mathbf{k}}$ is the amplitude of the Fourier mode and $\\lambda(\\mathbf{k})$ is the corresponding eigenvalue of the discretized spatial operator. The problem provides that the discrete operator for $-\\rho\\nabla\\times(\\nabla\\times \\cdot)$ has eigenvalues for divergence-free modes given by:\n$$ \\lambda(\\mathbf{k}) = -\\rho\\,\\omega(\\mathbf{k}) = -\\rho \\sum_{i\\in\\{x,y,z\\}} \\frac{4}{\\Delta^{2}}\\sin^{2}\\left(\\frac{k_{i}\\Delta}{2}\\right) $$\nSince $\\rho$, $\\Delta^2$, and $\\sin^2(\\cdot)$ are all non-negative, the eigenvalues $\\lambda(\\mathbf{k})$ are real and non-positive, i.e., $\\lambda(\\mathbf{k}) \\le 0$. The analysis of stability and accuracy depends on the eigenvalue with the largest magnitude, which corresponds to the most rapidly decaying physical mode. This occurs when the term $\\sin^2(k_i\\Delta/2)$ is maximized for all components $i \\in \\{x,y,z\\}$. The maximum value of $\\sin^2(\\cdot)$ is $1$, which is achieved when its argument is $\\pi/2$. The problem states that periodic boundary conditions are used and the maximum magnitude for the discrete wavenumbers corresponds to $k_i\\Delta = \\pi$, which means $k_i\\Delta/2 = \\pi/2$.\n\nThe eigenvalue with the largest magnitude, denoted $\\lambda_{\\text{max-abs}}$, is therefore:\n$$ |\\lambda|_{\\max} \\equiv \\lambda_{\\text{max-abs}} = \\rho \\sum_{i\\in\\{x,y,z\\}} \\frac{4}{\\Delta^{2}}(1) = \\rho \\left(\\frac{4}{\\Delta^2} + \\frac{4}{\\Delta^2} + \\frac{4}{\\Delta^2}\\right) = \\frac{12\\rho}{\\Delta^2} $$\nThe corresponding eigenvalue is $\\lambda_{\\min} = -|\\lambda|_{\\max} = -12\\rho/\\Delta^2$.\n\nFirst, we calculate the numerical values of $\\rho$ and $|\\lambda|_{\\max}$.\nGiven:\nMagnetic permeability $\\mu = \\mu_0 = 4\\pi \\times 10^{-7} \\, \\text{H/m}$.\nElectrical conductivity $\\sigma = 1 \\, \\text{S/m}$.\nGrid spacing $\\Delta = 25 \\, \\text{m}$.\n\nThe magnetic diffusivity $\\rho$ is:\n$$ \\rho = \\frac{1}{\\mu\\sigma} = \\frac{1}{(4\\pi \\times 10^{-7})(1)} = \\frac{10^7}{4\\pi} \\, \\frac{\\text{m}^2}{\\text{s}} $$\nNow, we compute the largest-magnitude eigenvalue:\n$$ |\\lambda|_{\\max} = \\frac{12}{\\Delta^2}\\rho = \\frac{12}{(25)^2} \\frac{10^7}{4\\pi} = \\frac{12}{625} \\frac{10^7}{4\\pi} = \\frac{3 \\times 10^7}{625\\pi} \\, \\text{s}^{-1} $$\n\n**1. Explicit Forward Euler Stability Constraint**\n\nThe forward Euler method applied to the model ODE $du/dt = \\lambda u$ is:\n$$ u^{n+1} = u^n + \\Delta t (\\lambda u^n) = (1 + \\lambda \\Delta t)u^n $$\nThe numerical amplification factor is $G_{FE}(\\lambda, \\Delta t) = 1 + \\lambda \\Delta t$. For stability, the magnitude of the amplification factor must be less than or equal to one for all eigenvalues in the system's spectrum: $|G_{FE}| \\le 1$.\nSince $\\lambda$ is real and non-positive, let $\\lambda = -|\\lambda|$. The condition becomes:\n$$ |1 - |\\lambda| \\Delta t| \\le 1 $$\nThis is equivalent to the two inequalities:\n$$ -1 \\le 1 - |\\lambda| \\Delta t \\quad \\text{and} \\quad 1 - |\\lambda| \\Delta t \\le 1 $$\nThe second inequality simplifies to $-|\\lambda|\\Delta t \\le 0$, which is always true for $\\Delta t > 0$ and $|\\lambda| \\ge 0$. The first inequality gives:\n$$ |\\lambda| \\Delta t \\le 2 $$\nThis must hold for all modes. The most restrictive condition is for the mode with the largest $|\\lambda|$, i.e., $|\\lambda|_{\\max}$:\n$$ \\Delta t \\le \\frac{2}{|\\lambda|_{\\max}} $$\nThis gives the maximum stable time step for the forward Euler method.\n$$ \\Delta t_{FE, \\max} = \\frac{2}{|\\lambda|_{\\max}} = \\frac{2}{\\frac{3 \\times 10^7}{625\\pi}} = \\frac{1250\\pi}{3 \\times 10^7} \\, \\text{s} $$\nNumerically:\n$$ \\Delta t_{FE, \\max} \\approx \\frac{1250 \\times 3.14159265}{3 \\times 10^7} \\approx 1.3089969 \\times 10^{-4} \\, \\text{s} $$\nRounding to four significant figures, the largest stable time step is $1.309 \\times 10^{-4} \\, \\text{s}$.\n\n**2. Crank–Nicolson Accuracy Constraint**\n\nThe Crank–Nicolson method applied to $du/dt = \\lambda u$ is:\n$$ u^{n+1} = u^n + \\frac{\\Delta t}{2}(\\lambda u^n + \\lambda u^{n+1}) $$\nSolving for $u^{n+1}$ yields:\n$$ u^{n+1} = \\frac{1 + \\lambda \\Delta t/2}{1 - \\lambda \\Delta t/2} u^n $$\nThe amplification factor is $G_{CN}(\\lambda, \\Delta t) = \\frac{1 + \\lambda \\Delta t/2}{1 - \\lambda \\Delta t/2}$. For $\\lambda \\le 0$, $|G_{CN}| \\le 1$, so the method is unconditionally stable. The constraint comes from accuracy, not stability.\n\nThe exact amplification factor over one time step is $G_{\\text{exact}}(\\lambda, \\Delta t) = e^{\\lambda \\Delta t}$.\nThe one-step relative amplitude error is defined as:\n$$ E_{\\text{rel}} = \\left| \\frac{G_{CN} - G_{\\text{exact}}}{G_{\\text{exact}}} \\right| = \\left| \\frac{G_{CN}}{G_{\\text{exact}}} - 1 \\right| $$\nWe require $E_{\\text{rel}} \\le \\varepsilon = 0.01$ for the mode with the largest eigenvalue magnitude, $\\lambda = -|\\lambda|_{\\max}$.\nLet $x = |\\lambda|_{\\max}\\Delta t$. For this mode, the argument to the functions is $\\lambda \\Delta t = -x$.\nThe constraint is:\n$$ \\left| \\frac{G_{CN}(-|\\lambda|_{\\max}, \\Delta t)}{G_{\\text{exact}}(-|\\lambda|_{\\max}, \\Delta t)} - 1 \\right| = \\left| \\frac{(1-x/2)/(1+x/2)}{e^{-x}} - 1 \\right| \\le \\varepsilon $$\nThe quantity inside the absolute value is $\\frac{(1-x/2)e^{x}}{1+x/2} - 1$. A Taylor series expansion for small $x$ shows this quantity is negative.\n$\\ln(G_{CN}) - \\ln(G_{exact}) = \\ln(\\frac{1-x/2}{1+x/2}) - (-x) = (-x - \\frac{x^3}{12} - \\dots) + x = -\\frac{x^3}{12} - \\dots$\nThus, $\\frac{G_{CN}}{G_{exact}} \\approx e^{-x^3/12} \\approx 1 - x^3/12$. The ratio is less than $1$.\nThe constraint becomes:\n$$ 1 - \\frac{(1-x/2)e^{x}}{1+x/2} \\le \\varepsilon $$\n$$ \\frac{(1-x/2)e^{x}}{1+x/2} \\ge 1-\\varepsilon $$\nWith $\\varepsilon = 0.01$, we must solve for the largest $x$ satisfying:\n$$ (1-x/2)e^{x} - 0.99(1+x/2) = 0 $$\nSolving this transcendental equation numerically (e.g., using Newton's method or a numerical solver), we find the root to be $x_{\\text{crit}} \\approx 0.487803$.\nThe accuracy constraint is $|\\lambda|_{\\max}\\Delta t \\le x_{\\text{crit}}$, so the largest permissible time step is:\n$$ \\Delta t_{CN, \\max} = \\frac{x_{\\text{crit}}}{|\\lambda|_{\\max}} = \\frac{x_{\\text{crit}}}{\\frac{3 \\times 10^7}{625\\pi}} = x_{\\text{crit}} \\frac{625\\pi}{3 \\times 10^7} \\, \\text{s} $$\nThis can also be expressed in terms of the Euler time step:\n$$ \\Delta t_{CN, \\max} = \\frac{x_{\\text{crit}}}{2} \\Delta t_{FE, \\max} $$\nNumerically:\n$$ \\Delta t_{CN, \\max} \\approx \\frac{0.487803}{2} \\times (1.3089969 \\times 10^{-4}) \\approx 3.19267 \\times 10^{-5} \\, \\text{s} $$\nRounding to four significant figures, the largest time step for Crank–Nicolson that meets the accuracy requirement is $3.193 \\times 10^{-5} \\, \\text{s}$.\n\nSummary of results:\n1.  Largest stable $\\Delta t$ for explicit forward Euler: $1.309 \\times 10^{-4} \\, \\text{s}$.\n2.  Largest accuracy-constrained $\\Delta t$ for Crank–Nicolson: $3.193 \\times 10^{-5} \\, \\text{s}$.", "answer": "$$ \\boxed{ \\begin{pmatrix} 1.309 \\times 10^{-4} & 3.193 \\times 10^{-5} \\end{pmatrix} } $$", "id": "3610044"}, {"introduction": "Geophysical media are often too complex to be modeled in full detail, necessitating the use of simplified representations like effective medium theory. This practice bridges theoretical derivation with numerical validation, a crucial skill set for a computational geophysicist. You will first derive the effective conductivity for a finely layered medium under Transverse Electric (TE) polarization and then implement a numerical model to investigate the limits of this homogenization approximation as the layering scale approaches the electromagnetic skin depth [@problem_id:3610032].", "problem": "Consider a one-dimensional, horizontally layered, electrically isotropic Earth in which two layers with conductivities $ \\sigma_1 $ and $ \\sigma_2 $ and thicknesses $ t_1 $ and $ t_2 $ repeat periodically to form a semi-infinite medium extending downward in the $ z $-direction. Assume harmonic time dependence $ e^{-i \\omega t} $ at angular frequency $ \\omega = 2 \\pi f $, magnetic permeability $ \\mu = \\mu_0 $, and neglect displacement current so that conduction current dominates. A normally incident plane wave produces fields that vary only with depth $ z $ and are polarized in the Transverse Electric (TE) configuration (electric field horizontal, magnetic field perpendicular to it and also horizontal). \n\nStart from the following fundamental base:\n- Maxwell’s equations in the frequency domain for conduction-dominated media: $ \\nabla \\times \\mathbf{E} = - i \\omega \\mu \\mathbf{H} $ and $ \\nabla \\times \\mathbf{H} = \\sigma \\mathbf{E} $.\n- Constitutive relations $ \\mathbf{B} = \\mu \\mathbf{H} $ and $ \\mathbf{J} = \\sigma \\mathbf{E} $.\n- One-dimensional reduction for TE polarization: fields depend only on $ z $ and the governing equation for the tangential electric field $ E_x(z) $ within a homogeneous layer of conductivity $ \\sigma $ is a diffusion equation of the form $ \\dfrac{d^2 E_x}{dz^2} = i \\omega \\mu \\sigma \\, E_x $. The corresponding complex propagation constant is $ \\gamma = \\sqrt{i \\omega \\mu \\sigma} $.\n- The skin depth is defined by $ \\delta(\\omega,\\sigma) = \\sqrt{\\dfrac{2}{\\mu \\, \\omega \\, \\sigma}} $ as the characteristic attenuation length in a homogeneous conductor.\n\nTask A (Homogenization): In the limit of finely layered media where the period $ p = t_1 + t_2 $ is much smaller than the skin depth $ \\delta(\\omega,\\sigma) $, derive from the one-dimensional Maxwell system and continuity of appropriate field components an effective medium description with a single scalar conductivity $ \\sigma_\\mathrm{eff} $ appropriate for TE polarization. Your derivation must rely only on the fundamental base above and the fact that, over one period, the tangential electric field component is continuous while conduction current density averages over the period. State explicitly the expression you obtain for $ \\sigma_\\mathrm{eff} $ in terms of $ \\sigma_1 $, $ \\sigma_2 $, $ t_1 $, and $ t_2 $.\n\nTask B (Surface impedance and numerical experiment): Define the surface impedance $ Z $ at the top of the periodic medium as $ Z = \\dfrac{E_x(0)}{H_y(0)} $, where $ E_x(0) $ and $ H_y(0) $ are the phasor values at $ z = 0 $. Using only the fundamental base given, formulate a stable numerical method to compute $ Z $ for:\n- the exact semi-infinite periodic stack, and\n- the homogenized semi-infinite half-space characterized by $ \\sigma_\\mathrm{eff} $.\nYour method must be valid at arbitrary $ f $ and must not assume $ p \\ll \\delta $ for the exact periodic calculation. The algorithmic description must be implementable in a modern programming language without requiring external data.\n\nTask C (Breakdown test as $ p \\to \\delta(\\omega) $): Using your method from Task B, compute for each test case the relative complex-impedance error\n$$ \\varepsilon = \\frac{|Z_\\mathrm{periodic} - Z_\\mathrm{eff}|}{|Z_\\mathrm{periodic}|} $$\nas a dimensionless float. Discuss how $ \\varepsilon $ changes with the ratio $ p / \\delta(\\omega,\\sigma_\\mathrm{eff}) $ and identify when homogenization breaks down.\n\nPhysical and numerical units: use $ \\sigma $ in $\\mathrm{S/m}$, $ t $ and $ \\delta $ in $\\mathrm{m}$, $ f $ in $\\mathrm{Hz}$, $ \\mu $ in $\\mathrm{H/m}$, and $ Z $ in $\\Omega$. Express all final numerical outputs for $ \\varepsilon $ as decimal floats rounded to six decimal places.\n\nTest suite: Your program must compute $ \\varepsilon $ for the following five parameter sets, each given as a tuple $ (\\sigma_1,\\sigma_2,t_1,t_2,f) $, with $ \\mu = \\mu_0 = 4 \\pi \\times 10^{-7} \\, \\mathrm{H/m} $:\n- Case $ 1 $: $ (1.0, \\, 0.01, \\, 0.6, \\, 1.4, \\, 100.0) $\n- Case $ 2 $: $ (1.0, \\, 0.01, \\, 6.0, \\, 14.0, \\, 100.0) $\n- Case $ 3 $: $ (1.0, \\, 0.01, \\, 15.0, \\, 35.0, \\, 100.0) $\n- Case $ 4 $: $ (1.0, \\, 0.01, \\, 60.0, \\, 140.0, \\, 100.0) $\n- Case $ 5 $: $ (0.5, \\, 0.5, \\, 15.0, \\, 35.0, \\, 100.0) $\n\nFinal output format: Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of the cases above, with each $ \\varepsilon $ rounded to six decimal places (for example, $ [0.000123,0.045678,0.500000,0.100000,0.000000] $).", "solution": "The user-provided problem is assessed to be valid as it is scientifically grounded in Maxwell's electromagnetic theory, well-posed with a clear objective, and provides a complete and consistent set of data and constraints. The solution proceeds by addressing each task in sequence.\n\n### Task A: Derivation of Effective Conductivity $\\sigma_\\mathrm{eff}$\n\nThe derivation begins with the one-dimensional frequency-domain Maxwell's equations for a Transverse Electric (TE) mode, where the electric field $\\mathbf{E}$ is polarized in the $x$-direction, $\\mathbf{E} = (E_x(z), 0, 0)$, and the magnetic field $\\mathbf{H}$ is in the $y$-direction, $\\mathbf{H} = (0, H_y(z), 0)$. The fields vary only with depth $z$.\n\nFrom $\\nabla \\times \\mathbf{E} = -i \\omega \\mu \\mathbf{H}$, the $y$-component gives:\n$$ \\frac{dE_x}{dz} = -i \\omega \\mu H_y $$\nFrom $\\nabla \\times \\mathbf{H} = \\sigma \\mathbf{E}$, the $x$-component gives:\n$$ -\\frac{dH_y}{dz} = \\sigma(z) E_x $$\nHere, $\\sigma(z)$ is the conductivity, which is a periodic function of $z$ with period $p = t_1 + t_2$. Specifically, $\\sigma(z) = \\sigma_1$ for $z \\in [np, np+t_1)$ and $\\sigma(z) = \\sigma_2$ for $z \\in [np+t_1, (n+1)p)$, for any integer $n \\geq 0$.\n\nThe homogenization hypothesis states that for long wavelengths, where the period $p$ is much smaller than the characteristic skin depth $\\delta$, the finely layered medium behaves like a single homogeneous medium with an effective conductivity $\\sigma_\\mathrm{eff}$. In this limit, the fields vary slowly over a single period $p$. We can derive $\\sigma_\\mathrm{eff}$ by averaging the microscopic fields over one period.\n\nLet $\\langle \\cdot \\rangle$ denote the spatial average over one period $p$: $\\langle f(z) \\rangle = \\frac{1}{p} \\int_z^{z+p} f(z') dz'$. We apply this averaging operator to our 1D Maxwell's equations.\n\nThe first equation becomes:\n$$ \\left\\langle \\frac{dE_x}{dz} \\right\\rangle = \\langle -i \\omega \\mu H_y \\rangle $$\nThe left side is $\\frac{1}{p} \\int_z^{z+p} \\frac{dE_x}{dz'} dz' = \\frac{E_x(z+p) - E_x(z)}{p}$. In the long-wavelength limit, this approximates the derivative of the averaged field, $\\frac{d\\langle E_x \\rangle}{dz}$. The right side becomes $-i \\omega \\mu \\langle H_y \\rangle$. So the first averaged equation relates the averaged fields:\n$$ \\frac{d\\langle E_x \\rangle}{dz} = -i \\omega \\mu \\langle H_y \\rangle $$\n\nThe second equation becomes:\n$$ \\left\\langle -\\frac{dH_y}{dz} \\right\\rangle = \\langle \\sigma(z) E_x \\rangle $$\nSimilarly, the left side becomes $-\\frac{d\\langle H_y \\rangle}{dz}$. For the right side, we use the fact that the tangential electric field $E_x$ is continuous across all layer boundaries. In the limit $p \\ll \\delta$, $E_x$ is nearly constant over a single period, so $E_x(z') \\approx \\langle E_x \\rangle$ for $z' \\in [z, z+p]$. This allows us to factor it out of the integral:\n$$ \\langle \\sigma E_x \\rangle \\approx \\langle E_x \\rangle \\langle \\sigma \\rangle $$\nThe average conductivity $\\langle \\sigma \\rangle$ is calculated as:\n$$ \\langle \\sigma \\rangle = \\frac{1}{p} \\int_0^p \\sigma(z') dz' = \\frac{1}{t_1+t_2} \\left[ \\int_0^{t_1} \\sigma_1 dz' + \\int_{t_1}^{t_1+t_2} \\sigma_2 dz' \\right] = \\frac{\\sigma_1 t_1 + \\sigma_2 t_2}{t_1 + t_2} $$\nThe second averaged equation is thus:\n$$ -\\frac{d\\langle H_y \\rangle}{dz} = \\left( \\frac{\\sigma_1 t_1 + \\sigma_2 t_2}{t_1 + t_2} \\right) \\langle E_x \\rangle $$\nBy comparing this system of equations for the averaged fields with the macroscopic Maxwell's equations for a homogeneous medium with conductivity $\\sigma_\\mathrm{eff}$, we identify the effective conductivity for the TE mode as the arithmetic average of the layer conductivities, weighted by their thicknesses:\n$$ \\sigma_\\mathrm{eff} = \\frac{\\sigma_1 t_1 + \\sigma_2 t_2}{t_1 + t_2} $$\n\n### Task B: Numerical Method for Surface Impedance\n\n#### Surface Impedance of the Homogenized Medium\nThe homogenized medium is a semi-infinite half-space with uniform conductivity $\\sigma_\\mathrm{eff}$ and magnetic permeability $\\mu_0$. The surface impedance $Z_\\mathrm{eff}$ is the intrinsic impedance of this medium. For a downward-propagating plane wave, the fields are $E_x(z) = E_0 e^{-\\gamma_\\mathrm{eff} z}$ and $H_y(z) = \\frac{\\gamma_\\mathrm{eff}}{i\\omega\\mu_0} E_x(z)$, where $\\gamma_\\mathrm{eff} = \\sqrt{i \\omega \\mu_0 \\sigma_\\mathrm{eff}}$ is the propagation constant. The impedance is:\n$$ Z_\\mathrm{eff} = \\frac{E_x(z)}{H_y(z)} = \\frac{i \\omega \\mu_0}{\\gamma_\\mathrm{eff}} = \\frac{i \\omega \\mu_0}{\\sqrt{i \\omega \\mu_0 \\sigma_\\mathrm{eff}}} = \\sqrt{\\frac{i \\omega \\mu_0}{\\sigma_\\mathrm{eff}}} $$\nThe root with a positive real part is chosen for $\\gamma_\\mathrm{eff}$ and $Z_\\mathrm{eff}$ to represent a decaying wave in a passive medium.\n\n#### Surface Impedance of the Exact Periodic Medium\nFor the exact periodic stack, we use an impedance recursion relation. The surface impedance of a layer of thickness $t$, with intrinsic impedance $\\eta$ and propagation constant $\\gamma$, overlying a medium with surface impedance $Z_\\mathrm{load}$, is given by:\n$$ Z_\\mathrm{in} = \\eta \\frac{Z_\\mathrm{load} + \\eta \\tanh(\\gamma t)}{\\eta + Z_\\mathrm{load} \\tanh(\\gamma t)} $$\nThe periodic medium is a semi-infinite stack of bilayers. Let the bilayer consist of layer 1 (thickness $t_1$, conductivity $\\sigma_1$) on top of layer 2 (thickness $t_2$, conductivity $\\sigma_2$). The surface impedance at the top of the entire stack, $Z_\\mathrm{periodic}$, must be invariant under the addition of one bilayer. This means $Z_\\mathrm{periodic}$ is a fixed point of the impedance transformation across a bilayer.\n\nLet $Z' = Z_\\mathrm{in}(t_2, \\eta_2, \\gamma_2, Z_\\mathrm{periodic})$ be the impedance at the top of the semi-infinite stack starting from layer 2, which is the load for layer 1.\n$$ Z' = \\eta_2 \\frac{Z_\\mathrm{periodic} + \\eta_2 \\tanh(\\gamma_2 t_2)}{\\eta_2 + Z_\\mathrm{periodic} \\tanh(\\gamma_2 t_2)} $$\nThen, $Z_\\mathrm{periodic}$ is the impedance at the top of layer 1 with load $Z'$:\n$$ Z_\\mathrm{periodic} = \\eta_1 \\frac{Z' + \\eta_1 \\tanh(\\gamma_1 t_1)}{\\eta_1 + Z' \\tanh(\\gamma_1 t_1)} $$\nSubstituting the expression for $Z'$ into the second equation yields a quadratic equation for $Z_\\mathrm{periodic}$ of the form $A Z_\\mathrm{periodic}^2 + B Z_\\mathrm{periodic} + C = 0$, where:\n- $\\gamma_j = \\sqrt{i \\omega \\mu_0 \\sigma_j}$ is the propagation constant in layer $j$.\n- $\\eta_j = \\sqrt{i \\omega \\mu_0 / \\sigma_j}$ is the intrinsic impedance of layer $j$.\n- $T_j = \\tanh(\\gamma_j t_j)$.\n- $A = \\eta_1 T_2 + \\eta_2 T_1$.\n- $B = (\\eta_2^2 - \\eta_1^2) T_1 T_2$.\n- $C = - \\eta_1 \\eta_2 (\\eta_1 T_1 + \\eta_2 T_2)$.\n\nThe solution is given by the quadratic formula:\n$$ Z_\\mathrm{periodic} = \\frac{-B \\pm \\sqrt{B^2 - 4AC}}{2A} $$\nFor a passive, dissipative medium, the impedance must have a non-negative real part, i.e., $\\mathrm{Re}(Z_\\mathrm{periodic}) \\ge 0$. This physical constraint uniquely determines the correct root of the quadratic equation.\n\n### Task C: Breakdown of Homogenization\n\nThe homogenization approximation is valid when the period $p = t_1 + t_2$ of the layering is much smaller than the skin depth $\\delta$ of the electromagnetic wave in the medium. The error $\\varepsilon$ is expected to be small for small values of the dimensionless ratio $p/\\delta_\\mathrm{eff}$, where $\\delta_\\mathrm{eff} = \\sqrt{2 / (\\mu_0 \\omega \\sigma_\\mathrm{eff})}$. As this ratio increases, the wave begins to resolve the individual layers, and the effective medium approximation breaks down, leading to a larger error $\\varepsilon$.\n\nThe test cases are designed to probe this breakdown:\n- Cases 1 through 4 have a fixed conductivity contrast and thickness ratio but an increasing period $p$. This systematically increases the $p/\\delta_\\mathrm{eff}$ ratio, and we expect $\\varepsilon$ to increase accordingly.\n- Case 5 represents a homogeneous medium ($\\sigma_1 = \\sigma_2$), for which the effective medium theory is exact regardless of layer thicknesses. The periodic and homogenized models are identical, so we expect $Z_\\mathrm{periodic} = Z_\\mathrm{eff}$ and $\\varepsilon = 0$. This serves as a validation of the numerical method.\n\nThe numerical algorithm proceeds as follows for each test case:\n1.  Calculate angular frequency $\\omega = 2 \\pi f$.\n2.  Calculate effective conductivity $\\sigma_\\mathrm{eff}$ using the formula from Task A.\n3.  Calculate homogenized impedance $Z_\\mathrm{eff}$ using the formula from Task B.\n4.  Calculate layer-specific parameters $\\gamma_1, \\eta_1, \\gamma_2, \\eta_2$.\n5.  Calculate the coefficients $A, B, C$ of the quadratic equation for $Z_\\mathrm{periodic}$.\n6.  Solve for the two roots of $Z_\\mathrm{periodic}$ and select the one with a non-negative real part.\n7.  Compute the relative error $\\varepsilon = |Z_\\mathrm{periodic} - Z_\\mathrm{eff}| / |Z_\\mathrm{periodic}|$, using the complex modulus for the absolute value.\nThe final output is a list of these error values.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the geophysical electromagnetics problem for a set of test cases.\n    It calculates the relative impedance error between an exact periodic model and\n    a homogenized effective medium model.\n    \"\"\"\n\n    # Define physical constants\n    MU_0 = 4 * np.pi * 1e-7  # Magnetic permeability of free space (H/m)\n    I_ = 1j                   # Complex unit\n\n    def calculate_error(sigma1, sigma2, t1, t2, f):\n        \"\"\"\n        Computes the relative complex-impedance error for a single parameter set.\n        \n        Args:\n            sigma1 (float): Conductivity of layer 1 (S/m).\n            sigma2 (float): Conductivity of layer 2 (S/m).\n            t1 (float): Thickness of layer 1 (m).\n            t2 (float): Thickness of layer 2 (m).\n            f (float): Frequency (Hz).\n\n        Returns:\n            float: The dimensionless relative impedance error, epsilon.\n        \"\"\"\n        omega = 2 * np.pi * f\n\n        # --- Homogenized Medium Calculation ---\n        # Case 5 is a special homogeneous case, handle it to avoid division by zero or NaN\n        # if t1+t2 is zero, which is not the case here but good practice.\n        if np.isclose(sigma1, sigma2):\n            sigma_eff = sigma1\n        else:\n            sigma_eff = (sigma1 * t1 + sigma2 * t2) / (t1 + t2)\n        \n        # Check for zero conductivity to prevent division by zero\n        if np.isclose(sigma_eff, 0.0):\n             # For a perfect insulator, impedance is infinite. This problem assumes conductors.\n             # In a real scenario, displacement currents would matter.\n             # Let's return 0 as per Case 5 logic if sigma1=sigma2=0.\n            if np.isclose(sigma1, sigma2):\n                return 0.0\n            else: # Should not happen with given test data\n                return np.nan\n\n        z_eff = np.sqrt(I_ * omega * MU_0 / sigma_eff)\n\n        # --- Exact Periodic Medium Calculation ---\n        \n        # If the medium is homogeneous, the periodic solution is the same as effective medium.\n        if np.isclose(sigma1, sigma2):\n            z_periodic = z_eff\n        else:\n            # Layer 1 parameters\n            gamma1 = np.sqrt(I_ * omega * MU_0 * sigma1)\n            eta1 = np.sqrt(I_ * omega * MU_0 / sigma1)\n            T1 = np.tanh(gamma1 * t1)\n\n            # Layer 2 parameters\n            gamma2 = np.sqrt(I_ * omega * MU_0 * sigma2)\n            eta2 = np.sqrt(I_ * omega * MU_0 / sigma2)\n            T2 = np.tanh(gamma2 * t2)\n\n            # Coefficients of the quadratic equation A*Z^2 + B*Z + C = 0 for Z_periodic\n            A = eta1 * T2 + eta2 * T1\n            B = (eta2**2 - eta1**2) * T1 * T2\n            C = -eta1 * eta2 * (eta1 * T1 + eta2 * T2)\n            \n            # Solve the quadratic equation\n            # Numerically stable choice of roots for quadratic equation is generally preferred,\n            # but standard formula is sufficient here.\n            discriminant = np.sqrt(B**2 - 4 * A * C)\n            \n            # The two possible roots for the impedance\n            root1 = (-B + discriminant) / (2 * A)\n            root2 = (-B - discriminant) / (2 * A)\n            \n            # The physical solution must have a non-negative real part (passive medium)\n            if root1.real >= 0:\n                z_periodic = root1\n            elif root2.real >= 0:\n                z_periodic = root2\n            else:\n                # Should not happen for a physical system\n                # Return NaN to indicate a problem with the model or parameters\n                return np.nan\n\n        # --- Relative Error Calculation ---\n        if np.isclose(np.abs(z_periodic), 0.0):\n            # If the true impedance is zero, any difference is infinitely large in relative terms.\n            # This happens for a perfect conductor. But given sigma > 0, |Z| > 0.\n            # However, if z_eff is also zero, error is 0.\n            if np.isclose(np.abs(z_eff), 0.0):\n                return 0.0\n            else:\n                 return np.inf\n\n        error = np.abs(z_periodic - z_eff) / np.abs(z_periodic)\n        \n        return error\n\n    # Test suite from the problem statement\n    test_cases = [\n        (1.0, 0.01, 0.6, 1.4, 100.0),    # Case 1\n        (1.0, 0.01, 6.0, 14.0, 100.0),   # Case 2\n        (1.0, 0.01, 15.0, 35.0, 100.0),  # Case 3\n        (1.0, 0.01, 60.0, 140.0, 100.0), # Case 4\n        (0.5, 0.5, 15.0, 35.0, 100.0)    # Case 5 (Homogeneous control case)\n    ]\n\n    results = []\n    for case in test_cases:\n        sigma1, sigma2, t1, t2, f = case\n        epsilon = calculate_error(sigma1, sigma2, t1, t2, f)\n        results.append(f\"{epsilon:.6f}\")\n    \n    # Final print statement in the exact required format\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```", "id": "3610032"}, {"introduction": "This exercise moves beyond forward modeling to the core of geophysical inversion: using measured data to infer subsurface properties. You will build a \"differentiable\" solver for the 2D Maxwell's equations and implement the powerful adjoint-state method to compute the sensitivity of data to changes in electrical conductivity. This practice provides direct experience with the foundational techniques of modern, large-scale inversion, where efficient gradient computation is paramount for imaging the Earth's interior [@problem_id:3610028].", "problem": "Consider a two-dimensional transverse electric (TE) reduction of frequency-domain Maxwell's equations appropriate for geophysical electromagnetics under the quasi-static assumption in which displacement currents are negligible. Let the out-of-plane electric field be $E_z(x,y)$ and assume isotropic magnetic permeability $\\mu(x,y)$ and electrical conductivity $\\sigma(x,y)$, with no magnetic sources. Starting from Faraday's law $\\nabla \\times \\mathbf{E} = -i \\omega \\mu \\mathbf{H}$ and Ampère's law $\\nabla \\times \\mathbf{H} = \\sigma \\mathbf{E} + \\mathbf{J}_s$ (neglecting the displacement current $\\omega \\epsilon \\mathbf{E}$), under TE conditions and constant $\\mu$ one can reduce the system to the scalar partial differential equation\n$$\n-\\nabla^2 E_z(x,y) + i \\,\\omega\\, \\mu\\, \\sigma(x,y)\\, E_z(x,y) = J_z(x,y),\n$$\nwhere $J_z$ is the out-of-plane impressed current source density, $\\omega$ is angular frequency in radians per second, $\\mu$ is magnetic permeability in henries per meter, and $\\sigma$ is conductivity in siemens per meter.\n\nDefine the discrete operator $A(\\sigma,\\omega) \\in \\mathbb{C}^{N \\times N}$ from a five-point second-order Finite Difference (FD) discretization of $-\\nabla^2$ on an interior grid with homogeneous Dirichlet boundary conditions $E_z=0$ on $\\partial \\Omega$, and add the reaction term $i \\omega \\mu \\sigma$ as a diagonal matrix. Let $u \\in \\mathbb{C}^{N}$ be the discrete solution of\n$$\nA(\\sigma,\\omega)\\, u = b,\n$$\nwith $b \\in \\mathbb{C}^{N}$ a discrete source representing $J_z$. Let $P \\in \\mathbb{R}^{M \\times N}$ be a linear projection that extracts the field at $M$ receiver indices, and define the real-valued data-misfit objective\n$$\n\\Phi(\\sigma) = \\tfrac{1}{2}\\, \\| P u - d \\|_2^2 = \\tfrac{1}{2} \\sum_{k=1}^{M} |(P u)_k - d_k|^2,\n$$\nwhere $d \\in \\mathbb{C}^M$ is observed data computed from a \"true\" conductivity field $\\sigma_{\\mathrm{true}}$.\n\nYour task is to implement a differentiable Maxwell solver for the TE equation that, for specified test cases, computes the solution $u$, evaluates the objective $\\Phi$, computes its gradient with respect to conductivity $\\nabla_\\sigma \\Phi$ using the adjoint-state method, verifies reciprocity by swapping source and receiver locations, and explores gradient pathologies as $\\omega \\to 0$.\n\nStarting from the fundamental Maxwell equations and their TE reduction, derive the adjoint-state system for a complex-valued linear operator, and implement the gradient computation without using any pre-derived shortcut formulas in the code. Specifically, use the governing linear system $A(\\sigma,\\omega) u = b$ as the base and the chain rule for differentiation, treating the real-valued objective and complex fields with appropriate conjugation to ensure correct adjointness. Reciprocity should be checked using the symmetry properties of the discrete operator under transposition for reciprocal media.\n\nPhysical units and numerical setup:\n- Angular frequency $\\omega$ must be in radians per second.\n- Magnetic permeability $\\mu$ must be in henries per meter.\n- Conductivity $\\sigma$ must be in siemens per meter.\n- Spatial lengths must be in meters.\n\nDiscretization and domain specification for the test suite:\n- Square domain of side length $L_x = L_y = 1\\,\\mathrm{m}$.\n- Interior FD grid with $N_x = N_y = 30$ points; homogeneous Dirichlet boundary conditions $E_z=0$.\n- Grid spacings $h_x = L_x/(N_x+1)$ and $h_y = L_y/(N_y+1)$.\n- Magnetic permeability $\\mu = \\mu_0 = 4\\pi \\times 10^{-7}\\,\\mathrm{H/m}$.\n- Base trial conductivity $\\sigma_0(x,y) = 0.1\\,\\mathrm{S/m}$ (uniform).\n- True conductivity $\\sigma_{\\mathrm{true}}(x,y)$ is $0.1\\,\\mathrm{S/m}$ plus an anomaly of $0.5\\,\\mathrm{S/m}$ inside a disk of radius $0.15\\,\\mathrm{m}$ centered at $(0.6\\,\\mathrm{m},\\,0.4\\,\\mathrm{m})$.\n- Single impressed current source $b$ is a point source of unit amplitude at the interior node closest to $(0.25\\,L_x,\\,0.75\\,L_y)$.\n- Receivers are three interior nodes closest to $(0.75\\,L_x,\\,0.25\\,L_y)$, $(0.5\\,L_x,\\,0.5\\,L_y)$, and $(0.25\\,L_x,\\,0.25\\,L_y)$.\n\nAdjoint gradient and checks:\n- For each frequency, construct $d$ by solving $A(\\sigma_{\\mathrm{true}},\\omega) u_{\\mathrm{true}} = b$ and setting $d = P u_{\\mathrm{true}}$.\n- Compute the adjoint-state vector by solving the conjugate-transpose system associated with the linearized objective.\n- Compute the gradient $\\nabla_\\sigma \\Phi$ and report its Euclidean norm $\\|\\nabla_\\sigma \\Phi\\|_2$.\n- Verify reciprocity by solving the forward problem with a source at the first receiver location and measuring the field at the original source location, and comparing it to the original forward solution measured at the first receiver location. Report a boolean indicating whether the relative difference is below a specified tolerance.\n\nDirectional finite-difference gradient check:\n- Generate a reproducible random direction $v \\in \\mathbb{R}^{N}$ with unit norm.\n- For a given small perturbation amplitude $\\varepsilon = 10^{-4}$ in siemens per meter, compute the centered finite-difference directional derivative $(\\Phi(\\sigma_0 + \\varepsilon v) - \\Phi(\\sigma_0 - \\varepsilon v))/(2\\varepsilon)$ and compare it against the inner product $\\nabla_\\sigma \\Phi(\\sigma_0) \\cdot v$. Report the relative error as a float.\n\nTest suite:\n- Test 1 (Reciprocity, happy path): $\\omega = 10\\,\\mathrm{rad/s}$, uniform $\\sigma = 0.1\\,\\mathrm{S/m}$; report a boolean for reciprocity using a relative tolerance of $10^{-8}$.\n- Test 2 (Adjoint gradient check, happy path): $\\omega = 10\\,\\mathrm{rad/s}$; report the relative error between adjoint directional derivative and finite-difference directional derivative as a float.\n- Test 3 (Adjoint gradient check, low frequency): $\\omega = 10^{-6}\\,\\mathrm{rad/s}$; report the relative error between adjoint and finite-difference directional derivatives as a float.\n- Test 4 (Gradient pathology magnitude, low frequency): $\\omega = 10^{-6}\\,\\mathrm{rad/s}$; report the Euclidean norm $\\|\\nabla_\\sigma \\Phi\\|_2$ as a float.\n- Test 5 (Gradient pathology at zero frequency): $\\omega = 0\\,\\mathrm{rad/s}$; report the Euclidean norm $\\|\\nabla_\\sigma \\Phi\\|_2$ as a float, which should be exactly zero.\n\nFinal output specification:\n- Your program should produce a single line of output containing the five results for the test suite as a comma-separated list enclosed in square brackets, in the order specified above. The types must be $[\\text{boolean}, \\text{float}, \\text{float}, \\text{float}, \\text{float}]$. For example: \"[True,1e-8,2.3e-6,0.12,0.0]\".", "solution": "The user has provided a valid, well-posed problem in computational geophysics. The task is to implement a differentiable solver for the 2D transverse electric (TE) Maxwell's equations under the quasi-static approximation, compute the gradient of a data-misfit objective function with respect to electrical conductivity using the adjoint-state method, and perform several numerical verifications.\n\n### 1. Governing Equation and Discretization\nThe governing partial differential equation (PDE) for the out-of-plane electric field $E_z(x,y)$ is given as:\n$$\n-\\nabla^2 E_z(x,y) + i \\omega \\mu \\sigma(x,y) E_z(x,y) = J_z(x,y)\n$$\nHere, $\\omega$ is the angular frequency, $\\mu$ is the magnetic permeability (assumed constant), $\\sigma(x,y)$ is the electrical conductivity, and $J_z(x,y)$ is the source current density. We discretize this equation on a 2D uniform grid with $N_x \\times N_y$ interior points subject to homogeneous Dirichlet boundary conditions. The total number of unknowns is $N = N_x N_y$. The spatial domain is $\\Omega = [0, L_x] \\times [0, L_y]$, with grid spacings $h_x = L_x/(N_x+1)$ and $h_y = L_y/(N_y+1)$. The field values at the interior grid nodes are represented by a vector $u \\in \\mathbb{C}^N$, where $u_k$ corresponds to $E_z$ at the $k$-th node.\n\nThe Laplacian operator $-\\nabla^2$ is approximated using a second-order five-point finite-difference stencil. This discretization results in a real, symmetric, positive-definite matrix $K \\in \\mathbb{R}^{N \\times N}$. The term $i \\omega \\mu \\sigma(x,y) E_z(x,y)$ is represented by a diagonal matrix $i \\omega \\mu \\Sigma$, where $\\Sigma = \\text{diag}(\\sigma_1, \\sigma_2, \\ldots, \\sigma_N)$ is a diagonal matrix containing the conductivity values at each grid node. The discrete source $J_z$ is represented by a vector $b \\in \\mathbb{C}^N$.\n\nThe resulting discretized system is a linear system of equations:\n$$\nA(\\sigma, \\omega) u = b\n$$\nwhere the system matrix $A(\\sigma, \\omega) \\in \\mathbb{C}^{N \\times N}$ is given by:\n$$\nA(\\sigma, \\omega) = K + i \\omega \\mu \\Sigma\n$$\nThis matrix is complex, sparse, and symmetric (since both $K$ and $\\Sigma$ are symmetric). For $\\omega > 0$ and $\\sigma > 0$, it is non-singular, guaranteeing a unique solution $u = A^{-1} b$.\n\n### 2. Objective Function and Gradient Calculation via Adjoint-State Method\nThe goal is to find the gradient of the real-valued data-misfit objective function $\\Phi(\\sigma)$ with respect to the conductivity vector $\\sigma \\in \\mathbb{R}^N$:\n$$\n\\Phi(\\sigma) = \\frac{1}{2} \\| P u - d \\|_2^2 = \\frac{1}{2} (P u - d)^H (P u - d)\n$$\nHere, $P \\in \\mathbb{R}^{M \\times N}$ is a projection matrix selecting the field values at $M$ receiver locations, and $d \\in \\mathbb{C}^M$ is the vector of observed data. The solution vector $u$ is implicitly a function of $\\sigma$, i.e., $u=u(\\sigma)$.\n\nWe use the adjoint-state method to compute the gradient $\\nabla_\\sigma \\Phi$. A small perturbation $\\delta \\sigma$ in conductivity leads to a perturbation $\\delta u$ in the field and $\\delta \\Phi$ in the objective. The first-order change in $\\Phi$ is given by its Gâteaux derivative:\n$$\n\\delta \\Phi = \\text{Re} \\left[ (P u - d)^H P \\delta u \\right]\n$$\nTo find the relationship between $\\delta u$ and $\\delta \\sigma$, we differentiate the state equation $A u = b$:\n$$\n\\delta(A u) = (\\delta A) u + A (\\delta u) = 0\n$$\nThis assumes the source $b$ is independent of $\\sigma$. This yields $\\delta u = -A^{-1} (\\delta A) u$. Substituting this into the expression for $\\delta \\Phi$:\n$$\n\\delta \\Phi = -\\text{Re} \\left[ (P u - d)^H P A^{-1} (\\delta A) u \\right]\n$$\nUsing the property that $(X Y)^H = Y^H X^H$, we can rewrite this as:\n$$\n\\delta \\Phi = -\\text{Re} \\left[ \\left( (A^H)^{-1} P^T (P u - d) \\right)^H (\\delta A) u \\right]\n$$\nWe define the adjoint-state vector $\\lambda \\in \\mathbb{C}^N$ as the solution to the adjoint equation:\n$$\nA^H \\lambda = P^T (P u - d)\n$$\nwhere $A^H = \\bar{A}^T$ is the Hermitian conjugate (or conjugate transpose) of $A$. With this definition, the change in the objective function simplifies to:\n$$\n\\delta \\Phi = -\\text{Re} \\left[ \\lambda^H (\\delta A) u \\right]\n$$\nThe perturbation in the operator $A$ due to a perturbation $\\delta \\sigma$ is $\\delta A = A(\\sigma+\\delta\\sigma) - A(\\sigma) = i \\omega \\mu \\, \\text{diag}(\\delta \\sigma)$. Substituting this expression:\n$$\n\\delta \\Phi = -\\text{Re} \\left[ \\lambda^H (i \\omega \\mu \\, \\text{diag}(\\delta \\sigma)) u \\right]\n$$\nThe term inside the real part is a scalar product which can be expanded as:\n$$\n\\lambda^H (i \\omega \\mu \\, \\text{diag}(\\delta \\sigma)) u = \\sum_{j=1}^N \\bar{\\lambda}_j (i \\omega \\mu \\, \\delta \\sigma_j) u_j = i \\omega \\mu \\sum_{j=1}^N \\bar{\\lambda}_j u_j \\delta \\sigma_j\n$$\nSince the perturbation $\\delta \\sigma_j$ is real, taking the real part of the expression yields:\n$$\n\\delta \\Phi = -\\text{Re} \\left[ i \\omega \\mu \\sum_{j=1}^N \\bar{\\lambda}_j u_j \\delta \\sigma_j \\right] = \\sum_{j=1}^N \\left( \\omega \\mu \\, \\text{Im}[\\bar{\\lambda}_j u_j] \\right) \\delta \\sigma_j\n$$\nBy definition, the total differential is $\\delta \\Phi = (\\nabla_\\sigma \\Phi)^T \\delta \\sigma = \\sum_{j=1}^N (\\nabla_\\sigma \\Phi)_j \\delta \\sigma_j$. By comparing the two expressions, we obtain the components of the gradient:\n$$\n(\\nabla_\\sigma \\Phi)_j = \\omega \\mu \\, \\text{Im}(\\bar{u}_j \\lambda_j)\n$$\nThe computational procedure is thus:\n1. For a given model $\\sigma$, solve the forward problem $A(\\sigma) u = b$ for the field $u$.\n2. Compute the data residual $r = P u - d$.\n3. Compute the adjoint source $q = P^T r$.\n4. Solve the adjoint problem $A(\\sigma)^H \\lambda = q$ for the adjoint field $\\lambda$.\n5. Assemble the gradient vector using the component-wise formula $(\\nabla_\\sigma \\Phi)_j = \\omega \\mu \\, \\text{Im}(\\bar{u}_j \\lambda_j)$.\n\n### 3. Reciprocity Verification\nFor a reciprocal medium, the system matrix $A$ is symmetric ($A=A^T$), which implies its inverse is also symmetric, $(A^{-1})=(A^{-1})^T$. Let the source be a unit impulse at node $s$, $b=e_s$, and the receiver be at node $r$. The measured field is $u_r = (A^{-1} e_s)_r = (A^{-1})_{rs}$. If we swap the source and receiver, the source is $b'=e_r$ and the field is measured at node $s$, giving $u'_s = (A^{-1} e_r)_s = (A^{-1})_{sr}$. Since $A^{-1}$ is symmetric, $(A^{-1})_{rs} = (A^{-1})_{sr}$, meaning $u_r = u'_s$. This property is verified numerically.\n\n### 4. Gradient Check via Finite Differences\nThe correctness of the adjoint-state gradient is verified by comparing its directional derivative with a finite-difference approximation. The directional derivative of $\\Phi$ at $\\sigma_0$ in a random direction $v$ is given by the inner product $D_v \\Phi = \\nabla_\\sigma \\Phi(\\sigma_0) \\cdot v$. A centered finite-difference approximation provides a benchmark:\n$$\nD_v \\Phi \\approx \\frac{\\Phi(\\sigma_0 + \\varepsilon v) - \\Phi(\\sigma_0 - \\varepsilon v)}{2\\varepsilon}\n$$\nfor a small perturbation $\\varepsilon$. The relative error between the adjoint-based and finite-difference derivatives validates the implementation.\n\n### 5. Low-Frequency Gradient Pathology\nThe derived gradient expression, $(\\nabla_\\sigma \\Phi)_j = \\omega \\mu \\, \\text{Im}(\\bar{u}_j \\lambda_j)$, contains an explicit factor of the angular frequency $\\omega$. This implies that as $\\omega \\to 0$, the gradient magnitude approaches zero. In the DC limit ($\\omega=0$), the governing equation becomes $-\\nabla^2 E_z = J_z$, which is independent of conductivity $\\sigma$. Consequently, the solution $u$ is insensitive to changes in $\\sigma$. If the true data $d$ is also generated at $\\omega=0$, then $d$ is independent of $\\sigma_{\\mathrm{true}}$. This leads to $u(\\sigma_0)$ being identical to $u_{\\text{true}}$, a zero data residual, a zero objective function value, and a zero gradient. This pathological behavior, which represents a key challenge in geophysical electromagnetic inversion, is demonstrated by computing $\\|\\nabla_\\sigma \\Phi\\|_2$ for a very small $\\omega$ and for $\\omega=0$.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.sparse import diags, eye, kron\nfrom scipy.sparse.linalg import spsolve\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem and generate results for all test cases.\n    It sets up the geophysical EM problem, computes solutions and gradients\n    using the adjoint-state method, and performs specified numerical checks.\n    \"\"\"\n    # ------------------\n    # 1. Setup and Discretization\n    # ------------------\n    # Physical and domain constants\n    Lx, Ly = 1.0, 1.0\n    Nx, Ny = 30, 30\n    mu0 = 4.0 * np.pi * 1e-7  # H/m\n    \n    # Grid parameters\n    hx, hy = Lx / (Nx + 1), Ly / (Ny + 1)\n    N = Nx * Ny\n    \n    # Create grid coordinates\n    x_coords = np.linspace(hx, Lx - hx, Nx)\n    y_coords = np.linspace(hy, Ly - hy, Ny)\n    xx, yy = np.meshgrid(x_coords, y_coords, indexing='ij')\n    grid_coords = np.vstack([xx.ravel(), yy.ravel()]).T\n\n    def get_closest_node_idx(pos):\n        \"\"\"Finds the 1D index of the grid node closest to a given (x,y) position.\"\"\"\n        return np.argmin(np.linalg.norm(grid_coords - np.array(pos), axis=1))\n\n    # Source and Receiver locations\n    source_pos = (0.25 * Lx, 0.75 * Ly)\n    receiver_pos = [(0.75 * Lx, 0.25 * Ly), (0.5 * Lx, 0.5 * Ly), (0.25 * Lx, 0.25 * Ly)]\n    \n    source_idx = get_closest_node_idx(source_pos)\n    receiver_indices = [get_closest_node_idx(p) for p in receiver_pos]\n    \n    # Source vector b\n    b = np.zeros(N, dtype=np.complex128)\n    b[source_idx] = 1.0\n\n    # Projection operator P\n    P = eye(N, format='csr')[receiver_indices]\n\n    # Conductivity models\n    sigma0_val = 0.1  # S/m\n    sigma_true_val = 0.1 # S/m\n    anomaly_val = 0.5 # S/m\n    anomaly_center = np.array([0.6, 0.4]) # m\n    anomaly_radius = 0.15 # m\n\n    sigma0 = np.full(N, sigma0_val)\n    \n    sigma_true = np.full(N, sigma_true_val)\n    dist_from_center = np.linalg.norm(grid_coords - anomaly_center, axis=1)\n    sigma_true[dist_from_center  anomaly_radius] += anomaly_val\n\n    # Construct the discrete Laplacian K = -nabla^2\n    Dxx_1d = diags([-1, 2, -1], [-1, 0, 1], shape=(Nx, Nx), format='csr') / hx**2\n    Dyy_1d = diags([-1, 2, -1], [-1, 0, 1], shape=(Ny, Ny), format='csr') / hy**2\n    K = kron(Dxx_1d, eye(Ny)) + kron(eye(Nx), Dyy_1d)\n\n    def get_system_matrix(sigma, omega, mu):\n        \"\"\"Constructs the complex system matrix A = K + i*omega*mu*Sigma.\"\"\"\n        Sigma = diags(sigma, 0, shape=(N, N), format='csr')\n        return K + 1j * omega * mu * Sigma\n\n    # ------------------\n    # 2. Test Case Execution\n    # ------------------\n    results = []\n    \n    # Test 1: Reciprocity\n    omega_test1 = 10.0  # rad/s\n    sigma_test1 = np.full(N, 0.1)\n    \n    A_recip = get_system_matrix(sigma_test1, omega_test1, mu0)\n    \n    b_orig = np.zeros(N, dtype=np.complex128)\n    b_orig[source_idx] = 1.0\n    u_orig = spsolve(A_recip, b_orig)\n    val_at_rec = u_orig[receiver_indices[0]]\n    \n    b_swap = np.zeros(N, dtype=np.complex128)\n    b_swap[receiver_indices[0]] = 1.0\n    u_swap = spsolve(A_recip, b_swap)\n    val_at_src = u_swap[source_idx]\n    \n    reciprocity_tol = 1e-8\n    reciprocity_error = np.abs(val_at_rec - val_at_src) / np.abs(val_at_rec)\n    results.append(reciprocity_error  reciprocity_tol)\n\n    def run_gradient_calculation(omega, sigma_model, sigma_true_model, src_vec):\n        \"\"\"Calculates forward/adjoint fields and the gradient.\"\"\"\n        # Generate true data d\n        A_true = get_system_matrix(sigma_true_model, omega, mu0)\n        u_true = spsolve(A_true, src_vec, use_umfpack=False) # Use SuperLU for stability\n        d = P @ u_true\n\n        # Forward solve for the model\n        A_model = get_system_matrix(sigma_model, omega, mu0)\n        u_model = spsolve(A_model, src_vec, use_umfpack=False)\n        \n        # Adjoint solve\n        residual = P @ u_model - d\n        adjoint_source = P.T @ residual\n        \n        AH = A_model.conj().T\n        lamb = spsolve(AH, adjoint_source, use_umfpack=False)\n        \n        # Gradient\n        grad = omega * mu0 * np.imag(np.conj(u_model) * lamb)\n        \n        return grad, u_model, d\n\n    def check_gradient_fd(omega, grad_adj, d, sigma_model, src_vec):\n        \"\"\"Performs a finite-difference check on the gradient.\"\"\"\n        np.random.seed(0) # For reproducible random direction\n        v = np.random.randn(N)\n        v /= np.linalg.norm(v)\n        \n        eps = 1e-4  # S/m\n        \n        # Perturb sigma\n        sigma_plus = sigma_model + eps * v\n        sigma_minus = sigma_model - eps * v\n        \n        # Evaluate objective function Phi at perturbed sigmas\n        A_plus = get_system_matrix(sigma_plus, omega, mu0)\n        u_plus = spsolve(A_plus, src_vec, use_umfpack=False)\n        phi_plus = 0.5 * np.linalg.norm(P @ u_plus - d)**2\n        \n        A_minus = get_system_matrix(sigma_minus, omega, mu0)\n        u_minus = spsolve(A_minus, src_vec, use_umfpack=False)\n        phi_minus = 0.5 * np.linalg.norm(P @ u_minus - d)**2\n        \n        # Compare directional derivatives\n        grad_fd_dot_v = (phi_plus - phi_minus) / (2.0 * eps)\n        grad_adj_dot_v = grad_adj.dot(v)\n        \n        if np.abs(grad_fd_dot_v)  1e-15:\n            return 0.0 if np.abs(grad_adj_dot_v)  1e-15 else np.inf\n        \n        rel_error = np.abs(grad_fd_dot_v - grad_adj_dot_v) / np.abs(grad_fd_dot_v)\n        return rel_error\n\n    # Test 2: Adjoint gradient check (happy path)\n    omega_test2 = 10.0  # rad/s\n    grad_2, u_2, d_2 = run_gradient_calculation(omega_test2, sigma0, sigma_true, b)\n    rel_error_2 = check_gradient_fd(omega_test2, grad_2, d_2, sigma0, b)\n    results.append(rel_error_2)\n    \n    # Test 3: Adjoint gradient check (low frequency)\n    omega_test3 = 1e-6  # rad/s\n    grad_3, u_3, d_3 = run_gradient_calculation(omega_test3, sigma0, sigma_true, b)\n    rel_error_3 = check_gradient_fd(omega_test3, grad_3, d_3, sigma0, b)\n    results.append(rel_error_3)\n\n    # Test 4: Gradient pathology magnitude (low frequency)\n    # The gradient was computed in Test 3\n    grad_norm_4 = np.linalg.norm(grad_3)\n    results.append(grad_norm_4)\n    \n    # Test 5: Gradient pathology at zero frequency\n    omega_test5 = 0.0  # rad/s\n    grad_5, _, _ = run_gradient_calculation(omega_test5, sigma0, sigma_true, b)\n    grad_norm_5 = np.linalg.norm(grad_5)\n    results.append(grad_norm_5)\n\n    # ------------------\n    # 3. Final Output\n    # ------------------\n    print(f\"[{results[0]},{results[1]},{results[2]},{results[3]},{results[4]}]\")\n\n\nif __name__ == '__main__':\n    solve()\n```", "id": "3610028"}]}