{"hands_on_practices": [{"introduction": "This first exercise is a cornerstone for understanding Darcy flow. We will return to first principles—mass conservation and Darcy's constitutive relation—to derive and solve the governing equation for the simplest non-trivial case: steady, one-dimensional flow through a homogeneous porous medium. Mastering this fundamental derivation and its solution is essential for building intuition about the direct link between hydraulic head gradient, specific discharge, and the actual speed of fluid particles within the pores. [@problem_id:3583139]", "problem": "A saturated, homogeneous, isotropic porous layer occupies a one-dimensional domain aligned with the coordinate $x$ on the interval $[0,L]$ with $L>0$. The fluid is incompressible, the solid matrix is rigid, and the porosity $n$ is constant in space and time. There are no internal sources or sinks. The hydraulic head $h(x)$ is prescribed at the boundaries: $h(0)=h_{0}$ and $h(L)=h_{L}$, where $h_{0}$ and $h_{L}$ are constants. Using only local conservation of mass, the appropriate constitutive relation for creeping flow through porous media, and the definition of hydraulic head, derive the governing boundary value problem and solve for the steady hydraulic head $h(x)$ on $[0,L]$. Then compute the constant specific discharge (Darcy flux) $q$ and the seepage (pore) velocity $v_{s}$.\n\nProvide your final results as closed-form analytic expressions in terms of $x$, $L$, $h_{0}$, $h_{L}$, $K$, and $n$. Report the final answer as a single row matrix containing the three entries $\\big(h(x),\\,q,\\,v_{s}\\big)$. No numerical evaluation or rounding is required. Do not include units in your final answer.", "solution": "The problem requires the derivation of the governing boundary value problem for steady, one-dimensional Darcy flow and its solution for the hydraulic head $h(x)$, the specific discharge $q$, and the seepage velocity $v_s$. The derivation proceeds from first principles.\n\nFirst, we apply the principle of local conservation of mass. For a saturated porous medium with a rigid solid matrix (constant porosity $n$) and an incompressible fluid (constant density $\\rho$), the steady-state mass conservation equation in the absence of sources or sinks is given by:\n$$\n\\nabla \\cdot (\\rho \\vec{q}) = 0\n$$\nwhere $\\vec{q}$ is the specific discharge vector. Since the fluid density $\\rho$ is constant, this equation simplifies to:\n$$\n\\nabla \\cdot \\vec{q} = 0\n$$\nFor a one-dimensional domain aligned with the $x$-axis, where flow occurs only in the $x$-direction, the specific discharge vector is $\\vec{q} = q\\hat{i}$, where $\\hat{i}$ is the unit vector in the $x$-direction. The divergence operator simplifies to $\\nabla \\cdot \\vec{q} = \\frac{dq}{dx}$. Therefore, the mass conservation equation becomes:\n$$\n\\frac{dq}{dx} = 0\n$$\nThis ordinary differential equation implies that the specific discharge $q$ is a constant for all $x$ in the domain $[0, L]$.\n\nSecond, we introduce the constitutive relation for creeping flow through a porous medium, which is Darcy's Law. For a homogeneous and isotropic medium, Darcy's Law in one dimension is:\n$$\nq = -K \\frac{dh}{dx}\n$$\nwhere $K$ is the hydraulic conductivity, which is a constant for a homogeneous medium, and $h(x)$ is the hydraulic head.\n\nThird, we combine the conservation law and the constitutive relation to derive the governing equation for the hydraulic head. Substituting the expression for $q$ from Darcy's Law into the conservation equation gives:\n$$\n\\frac{d}{dx}\\left(-K \\frac{dh}{dx}\\right) = 0\n$$\nBecause the hydraulic conductivity $K$ is constant, it can be factored out of the derivative:\n$$\n-K \\frac{d^2h}{dx^2} = 0\n$$\nSince $K$ is a positive constant (a medium must be permeable to have flow), we can divide by $-K$, which yields the governing differential equation for the hydraulic head $h(x)$:\n$$\n\\frac{d^2h}{dx^2} = 0\n$$\nThe complete boundary value problem (BVP) consists of this differential equation and the boundary conditions given in the problem statement:\n$$\n\\begin{cases}\n\\frac{d^2h}{dx^2} = 0, & \\text{for } x \\in (0, L) \\\\\nh(0) = h_0 \\\\\nh(L) = h_L\n\\end{cases}\n$$\nTo solve this BVP, we integrate the governing equation twice with respect to $x$. The first integration yields:\n$$\n\\frac{dh}{dx} = C_1\n$$\nwhere $C_1$ is a constant of integration. The second integration gives the general solution for the head:\n$$\nh(x) = C_1 x + C_2\n$$\nwhere $C_2$ is a second integration constant. These constants are determined by applying the boundary conditions.\nUsing the condition at $x=0$:\n$$\nh(0) = C_1(0) + C_2 = h_0 \\implies C_2 = h_0\n$$\nThe solution becomes $h(x) = C_1 x + h_0$. Now, applying the condition at $x=L$:\n$$\nh(L) = C_1 L + h_0 = h_L\n$$\nSolving for $C_1$:\n$$\nC_1 L = h_L - h_0 \\implies C_1 = \\frac{h_L - h_0}{L}\n$$\nSubstituting the expressions for $C_1$ and $C_2$ back into the general solution, we obtain the final expression for the hydraulic head profile:\n$$\nh(x) = \\left(\\frac{h_L - h_0}{L}\\right)x + h_0\n$$\nThis can be rearranged as $h(x) = h_0 + (h_L - h_0)\\frac{x}{L}$.\n\nNext, we calculate the constant specific discharge $q$ using Darcy's Law and the result for the head gradient, $\\frac{dh}{dx} = C_1$:\n$$\nq = -K \\frac{dh}{dx} = -K C_1 = -K\\left(\\frac{h_L - h_0}{L}\\right)\n$$\nThis expression is more intuitively written by factoring the negative sign into the parentheses:\n$$\nq = K\\frac{h_0 - h_L}{L}\n$$\nThis shows that flow is in the positive $x$-direction ($q > 0$) when $h_0 > h_L$, which is physically correct.\n\nFinally, we determine the seepage velocity $v_s$. The seepage velocity is the average fluid velocity within the pore space and is related to the specific discharge $q$ and the porosity $n$ by the Dupuit-Forchheimer relation, $q = n v_s$. Thus:\n$$\nv_s = \\frac{q}{n}\n$$\nSubstituting the expression for $q$, we get:\n$$\nv_s = \\frac{1}{n}\\left(K\\frac{h_0 - h_L}{L}\\right) = \\frac{K}{n}\\frac{h_0 - h_L}{L}\n$$\nThe three required quantities are $h(x)$, $q$, and $v_s$.", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\nh_0 + (h_L - h_0)\\frac{x}{L} & K\\frac{h_0 - h_L}{L} & \\frac{K}{n}\\frac{h_0 - h_L}{L}\n\\end{pmatrix}\n}\n$$", "id": "3583139"}, {"introduction": "While Darcy's law effectively describes macroscopic flow, the hydraulic conductivity $K$ (or intrinsic permeability $k$) is often treated as a given phenomenological coefficient. This practice delves deeper, bridging the gap between the macroscopic description and the microscopic structure of the porous medium. You will derive the celebrated Kozeny-Carman model, which provides a physical basis for permeability by relating it to fundamental geometric properties like grain size and porosity, offering a powerful tool for estimating permeability from rock or soil characteristics. [@problem_id:3583111]", "problem": "A saturated, isotropic, homogeneous granular medium composed of monodisperse grains of characteristic diameter $d$ and porosity $\\phi$ is subject to steady, single-phase, incompressible flow under a macroscopically uniform pressure gradient. Assume that (i) the macroscopic flux obeys Darcy’s law, (ii) within the pore space the flow is laminar and fully developed, (iii) the microstructure can be idealized as a bundle of tortuous capillaries of effective hydraulic radius proportional to a characteristic hydraulic length that can be written in terms of the pore volume and wetted surface area, and (iv) the specific surface area per unit bulk volume scales as $S_{v} \\propto (1-\\phi)/d$, with all geometric proportionality constants and tortuosity subsumed into a single unknown, dimensionless shape factor $C$.\n\nStarting only from the above assumptions and fundamental laws and definitions, derive an analytic permeability model $k(d,\\phi;C)$ that depends on $d$, $\\phi$, and $C$. Then, using your derived model, evaluate the permeability and quantify the local parametric sensitivity of $k$ to $d$ and $\\phi$ at the base state\n$$\nd = 2.8 \\times 10^{-4} \\ \\text{m}, \\quad \\phi = 0.27, \\quad C = 180.\n$$\nDefine the logarithmic (elasticity) sensitivities\n$$\nE_{d} \\equiv \\frac{\\partial \\ln k}{\\partial \\ln d}, \n\\qquad\nE_{\\phi} \\equiv \\frac{\\partial \\ln k}{\\partial \\ln \\phi},\n$$\nand evaluate $E_{d}$ and $E_{\\phi}$ at the base state. Round each component of your final answer to four significant figures. Express the permeability in square meters.\n\nReport your final answer as a row matrix $\\big[k, \\, E_{d}, \\, E_{\\phi}\\big]$ with the rounding and unit instruction above.", "solution": "**Derivation of the Permeability Model**\n\nThe derivation proceeds by relating the macroscopic Darcy's law to the microscopic flow within the pore space.\nPer assumption (i), the macroscopic flow is governed by Darcy's law, which for one-dimensional flow can be written in terms of the magnitude of the Darcy flux $q$:\n$$q = -\\frac{k}{\\mu} \\frac{dP}{dx}$$\nwhere $k$ is the intrinsic permeability, $\\mu$ is the dynamic viscosity of the fluid, and $\\frac{dP}{dx}$ is the macroscopic pressure gradient.\n\nPer assumption (ii), the flow within the pore channels is laminar. For flow through a non-circular conduit, a Poiseuille-type equation relates the average velocity within the pores, $v_p$, to the pressure gradient along the tortuous flow path, $\\frac{dP}{dl}$:\n$$v_p = -\\frac{k_0 R_h^2}{\\mu} \\frac{dP}{dl}$$\nHere, $R_h$ is the hydraulic radius of the pore channels and $k_0$ is a dimensionless pore shape factor.\n\nThe macroscopic pressure gradient is related to the microscopic gradient along the tortuous path of length $L_e$ across a straight-line macroscopic distance $L$ by the tortuosity, $\\tau = L_e/L \\ge 1$. Thus, $\\frac{dP}{dl} = \\frac{1}{\\tau}\\frac{dP}{dx}$. The average pore velocity can now be expressed in terms of the macroscopic pressure gradient:\n$$v_p = -\\frac{k_0 R_h^2}{\\tau \\mu} \\frac{dP}{dx}$$\nThe Darcy flux $q$ (also called superficial velocity) is related to the average pore velocity $v_p$ through the Dupuit-Forchheimer relationship. The actual flow path is tortuous and the cross-sectional area available for flow is only a fraction $\\phi$ of the bulk area. The seepage velocity $v_s$, which is the average velocity in the direction of the macroscopic pressure gradient, is $v_s = v_p / \\tau$. The Darcy flux is then $q = \\phi v_s = \\phi v_p / \\tau$. Substituting the expression for $v_p$:\n$$q = \\frac{\\phi}{\\tau} \\left( -\\frac{k_0 R_h^2}{\\tau \\mu} \\frac{dP}{dx} \\right) = -\\frac{k_0 \\phi R_h^2}{\\tau^2 \\mu} \\frac{dP}{dx}$$\nComparing this result with Darcy's law, we identify the permeability $k$ as:\n$$k = \\frac{k_0 \\phi R_h^2}{\\tau^2}$$\nPer assumption (iii), the hydraulic radius $R_h$ is defined as the ratio of pore volume to the total wetted surface area of the grains. For a bulk volume $V_b$ of the porous medium, the pore volume is $V_p = \\phi V_b$. The wetted surface area is $S_w = S_v V_b$, where $S_v$ is the specific surface area per unit bulk volume. Therefore:\n$$R_h = \\frac{V_p}{S_w} = \\frac{\\phi V_b}{S_v V_b} = \\frac{\\phi}{S_v}$$\nPer assumption (iv), the specific surface area $S_v$ scales as $S_v \\propto (1-\\phi)/d$. We can write this with a proportionality constant, $c_{geom}$: $S_v = c_{geom} \\frac{1-\\phi}{d}$. Substituting this into the expression for $R_h$:\n$$R_h = \\frac{\\phi}{c_{geom} \\frac{1-\\phi}{d}} = \\frac{1}{c_{geom}} \\frac{\\phi d}{1-\\phi}$$\nNow, substitute this expression for $R_h$ back into the equation for permeability $k$:\n$$k = \\frac{k_0 \\phi}{\\tau^2} \\left( \\frac{1}{c_{geom}} \\frac{\\phi d}{1-\\phi} \\right)^2 = \\frac{k_0}{c_{geom}^2 \\tau^2} d^2 \\frac{\\phi^3}{(1-\\phi)^2}$$\nPer assumption (iv), all dimensionless geometric constants ($k_0$, $c_{geom}$) and the tortuosity factor ($\\tau^2$) are subsumed into a single dimensionless shape factor $C$. Based on the derived form, this C is $C = \\frac{c_{geom}^2 \\tau^2}{k_0}$. This leads to the final permeability model:\n$$k(d,\\phi;C) = \\frac{1}{C} d^2 \\frac{\\phi^3}{(1-\\phi)^2}$$\nThis is the Kozeny-Carman equation.\n\n**Evaluation of Permeability at the Base State**\n\nThe base state is given by $d = 2.8 \\times 10^{-4} \\ \\text{m}$, $\\phi = 0.27$, and $C = 180$.\nSubstituting these values into the derived model:\n$$k = \\frac{1}{180} (2.8 \\times 10^{-4})^2 \\frac{(0.27)^3}{(1-0.27)^2}$$\n$$k = \\frac{7.84 \\times 10^{-8}}{180} \\frac{0.019683}{(0.73)^2}$$\n$$k = \\frac{7.84 \\times 10^{-8}}{180} \\frac{0.019683}{0.5329}$$\n$$k \\approx (4.3555... \\times 10^{-10}) \\times (0.0369356...)$$\n$$k \\approx 1.60873 \\times 10^{-11} \\ \\text{m}^2$$\nRounding to four significant figures, the permeability is $k = 1.609 \\times 10^{-11} \\ \\text{m}^2$.\n\n**Evaluation of Parametric Sensitivities**\n\nThe sensitivities are defined as $E_{d} = \\frac{\\partial \\ln k}{\\partial \\ln d}$ and $E_{\\phi} = \\frac{\\partial \\ln k}{\\partial \\ln \\phi}$.\nFirst, we find the natural logarithm of the permeability model:\n$$\\ln k = \\ln\\left(\\frac{1}{C} d^2 \\frac{\\phi^3}{(1-\\phi)^2}\\right) = -\\ln C + 2\\ln d + 3\\ln\\phi - 2\\ln(1-\\phi)$$\nTo find the sensitivity to grain diameter $d$, we differentiate $\\ln k$ with respect to $\\ln d$:\n$$E_{d} = \\frac{\\partial}{\\partial \\ln d} \\left( -\\ln C + 2\\ln d + 3\\ln\\phi - 2\\ln(1-\\phi) \\right)$$\nSince $C$ and $\\phi$ are held constant for this partial derivative, we get:\n$$E_{d} = 2$$\nThis sensitivity is a constant and does not depend on the base state values. For reporting consistency, we write this as $2.000$.\n\nTo find the sensitivity to porosity $\\phi$, we differentiate $\\ln k$ with respect to $\\ln \\phi$. Using the chain rule, $\\frac{\\partial f}{\\partial \\ln x} = x \\frac{\\partial f}{\\partial x}$:\n$$E_{\\phi} = \\frac{\\partial \\ln k}{\\partial \\ln \\phi} = \\phi \\frac{\\partial \\ln k}{\\partial \\phi}$$\n$$E_{\\phi} = \\phi \\frac{\\partial}{\\partial \\phi} \\left( -\\ln C + 2\\ln d + 3\\ln\\phi - 2\\ln(1-\\phi) \\right)$$\n$$E_{\\phi} = \\phi \\left( \\frac{3}{\\phi} - \\frac{2}{1-\\phi}(-1) \\right) = \\phi \\left( \\frac{3}{\\phi} + \\frac{2}{1-\\phi} \\right)$$\n$$E_{\\phi} = 3 + \\frac{2\\phi}{1-\\phi}$$\nNow, we evaluate this expression at the base state porosity $\\phi = 0.27$:\n$$E_{\\phi} = 3 + \\frac{2(0.27)}{1-0.27} = 3 + \\frac{0.54}{0.73}$$\n$$E_{\\phi} \\approx 3 + 0.739726... = 3.739726...$$\nRounding to four significant figures, the sensitivity to porosity is $E_{\\phi} = 3.740$.\n\n**Final Assembled Answer**\nThe calculated values are:\n- Permeability $k \\approx 1.609 \\times 10^{-11} \\ \\text{m}^2$.\n- Sensitivity to diameter $E_d = 2.000$.\n- Sensitivity to porosity $E_\\phi \\approx 3.740$.\nThese are assembled into a row matrix as requested.", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n1.609 \\times 10^{-11} & 2.000 & 3.740\n\\end{pmatrix}\n}\n$$", "id": "3583111"}, {"introduction": "Analytical solutions are invaluable for building understanding, but real-world geophysical systems are complex, featuring heterogeneous and anisotropic properties that defy simple formulas. This capstone practice transitions from theory to computation, guiding you through the construction of a numerical simulator for 2D Darcy flow using the Finite Volume Method (FVM). By deriving and implementing the Two-Point Flux Approximation (TPFA), you will learn a foundational technique for modeling flow in realistic geological settings and gain hands-on experience with the core of computational hydrogeology. [@problem_id:3583087]", "problem": "You are tasked with constructing a complete, cell-centered Finite Volume Method (FVM) discretization using the Two-Point Flux Approximation (TPFA) for steady-state, incompressible, single-phase Darcy flow in a two-dimensional rectangular porous medium with heterogeneous, spatially varying permeability tensor. The domain is a rectangle of width $L_x$ and height $L_y$, partitioned into a uniform Cartesian grid of $N_x \\times N_y$ rectangular control volumes (cells), each of size $\\Delta x = L_x / N_x$ and $\\Delta y = L_y / N_y$. The porous medium is characterized by an anisotropic but axis-aligned permeability tensor per cell, $\\mathbf{K} = \\mathrm{diag}(k_x, k_y)$, with $k_x$ and $k_y$ potentially varying from cell to cell (heterogeneous). The fluid has dynamic viscosity $\\mu$. The left boundary ($x = 0$) and right boundary ($x = L_x$) are prescribed Dirichlet pressures $p_\\mathrm{left}$ and $p_\\mathrm{right}$, respectively. The top and bottom boundaries ($y = 0$ and $y = L_y$) are no-flow (homogeneous Neumann) boundaries. Assume unit thickness in the out-of-plane direction so that face areas are one times the edge length.\n\nYour construction must begin from fundamental principles, specifically:\n- The definition of Darcy’s law, which relates the volumetric flux vector $\\mathbf{q}$ to the pressure gradient via $\\mathbf{q} = - \\dfrac{\\mathbf{K}}{\\mu} \\nabla p$.\n- Local mass conservation for steady state with no sources, $\\nabla \\cdot \\mathbf{q} = 0$.\n\nStarting from these principles, derive a cell-centered FVM discretization by integrating the conservation law over each control volume and using the divergence theorem to express the net outflow in terms of face fluxes. Then, adopt the Two-Point Flux Approximation (TPFA) to approximate the flux across each face using only the two neighboring cell pressures (or the boundary pressure for Dirichlet boundaries) and define the transmissibility coefficients that enforce local mass conservation across faces. Your derivation must address:\n- How to obtain face-normal effective permeability for axis-aligned faces from heterogeneous $\\mathbf{K}$, and how to combine two neighboring cell properties using a consistent averaging technique.\n- How to define transmissibilities for interior faces and for boundary faces, explicitly accounting for geometry (face area and centroid-to-face distances) and viscosity.\n- How the algebraic system reflects local mass conservation at each cell and how TPFA ensures flux continuity across interior faces.\n\nUnit requirements:\n- Pressure must be in Pascals ($\\mathrm{Pa}$).\n- Dynamic viscosity must be in Pascal seconds ($\\mathrm{Pa}\\cdot\\mathrm{s}$).\n- Permeability components $k_x$ and $k_y$ must be in square meters ($\\mathrm{m}^2$).\n- Geometric lengths $L_x$, $L_y$, $\\Delta x$, $\\Delta y$ must be in meters ($\\mathrm{m}$).\n- The volumetric flux across faces must be in cubic meters per second ($\\mathrm{m}^3/\\mathrm{s}$).\n\nImplement the discretization algorithm as a complete, runnable program. Assemble and solve the resulting linear system for the cell-centered pressures, then compute the local mass balance residual at each cell, defined as the sum of outward TPFA fluxes across all faces of the cell minus the right-hand side contribution from Dirichlet boundary pressures. Report, for each test case, the maximum absolute residual across all cells. Express the final residuals in $\\mathrm{m}^3/\\mathrm{s}$.\n\nDesign a test suite with the following four test cases, all with $L_x = N_x \\Delta x$ and $L_y = N_y \\Delta y$, unit thickness equal to $1$:\n1. A general case: $N_x = 10$, $N_y = 10$, $\\Delta x = 1\\,\\mathrm{m}$, $\\Delta y = 1\\,\\mathrm{m}$, $\\mu = 1 \\times 10^{-3}\\,\\mathrm{Pa}\\cdot\\mathrm{s}$, uniform isotropic permeability $k_x = k_y = 1 \\times 10^{-12}\\,\\mathrm{m}^2$, $p_\\mathrm{left} = 2 \\times 10^{5}\\,\\mathrm{Pa}$, $p_\\mathrm{right} = 1 \\times 10^{5}\\,\\mathrm{Pa}$.\n2. A strong heterogeneity case (step change): $N_x = 10$, $N_y = 10$, $\\Delta x = 1\\,\\mathrm{m}$, $\\Delta y = 1\\,\\mathrm{m}$, $\\mu = 1 \\times 10^{-3}\\,\\mathrm{Pa}\\cdot\\mathrm{s}$. For $x$-faces, $k_x = 1 \\times 10^{-12}\\,\\mathrm{m}^2$ on cells with $i \\leq 4$ (left half) and $k_x = 1 \\times 10^{-13}\\,\\mathrm{m}^2$ on cells with $i \\geq 5$ (right half). For $y$-faces, set $k_y = k_x$ per cell. Boundary pressures $p_\\mathrm{left} = 2 \\times 10^{5}\\,\\mathrm{Pa}$, $p_\\mathrm{right} = 1 \\times 10^{5}\\,\\mathrm{Pa}$.\n3. A strong anisotropy case: $N_x = 10$, $N_y = 10$, $\\Delta x = 1\\,\\mathrm{m}$, $\\Delta y = 1\\,\\mathrm{m}$, $\\mu = 1 \\times 10^{-3}\\,\\mathrm{Pa}\\cdot\\mathrm{s}$, $k_x = 1 \\times 10^{-11}\\,\\mathrm{m}^2$ and $k_y = 1 \\times 10^{-13}\\,\\mathrm{m}^2$ uniformly over all cells. Boundary pressures $p_\\mathrm{left} = 2 \\times 10^{5}\\,\\mathrm{Pa}$, $p_\\mathrm{right} = 1 \\times 10^{5}\\,\\mathrm{Pa}$.\n4. A high-contrast barrier case: $N_x = 10$, $N_y = 10$, $\\Delta x = 1\\,\\mathrm{m}$, $\\Delta y = 1\\,\\mathrm{m}$, $\\mu = 1 \\times 10^{-3}\\,\\mathrm{Pa}\\cdot\\mathrm{s}$, background $k_x = k_y = 1 \\times 10^{-12}\\,\\mathrm{m}^2$ except for a central block of cells with indices $i \\in \\{3,4,5,6\\}$ and $j \\in \\{3,4,5,6\\}$ where $k_x = k_y = 1 \\times 10^{-16}\\,\\mathrm{m}^2$. Boundary pressures $p_\\mathrm{left} = 2 \\times 10^{5}\\,\\mathrm{Pa}$, $p_\\mathrm{right} = 1 \\times 10^{5}\\,\\mathrm{Pa}$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[r1,r2,r3,r4]\"), where each $r_i$ is the maximum absolute local mass residual for test case $i$ in $\\mathrm{m}^3/\\mathrm{s}$, expressed as a floating-point number.\n\nAll elements of the mathematical description in your derivation must adhere to the following scientific and formatting constraints:\n- Begin from the stated fundamental principles and construct the discretization from first principles.\n- Do not provide shortcut formulas as hints; the derivation must logically progress from the principles to the discrete scheme.\n- Ensure scientific realism and consistent units throughout.\n- Every mathematical entity—symbols, variables, functions, operators, and numbers—must be written in LaTeX, using $...$ for inline math or $$...$$ for display math.\n- Define acronyms on first use, such as Finite Volume Method (FVM) and Two-Point Flux Approximation (TPFA).", "solution": "### Derivation of the Cell-Centered Finite Volume Method\n\nThe problem concerns steady-state, incompressible, single-phase fluid flow through a porous medium. The governing equations are Darcy's law and the mass conservation equation.\n\n1.  **Fundamental Principles**\n\n    The volumetric flux vector $\\mathbf{q}$ (with units of $\\mathrm{m}^3/\\mathrm{s}$ per $\\mathrm{m}^2$, or $\\mathrm{m}/\\mathrm{s}$) is given by Darcy's law:\n    $$\n    \\mathbf{q} = - \\frac{\\mathbf{K}}{\\mu} \\nabla p\n    $$\n    where $p$ is the fluid pressure in $\\mathrm{Pa}$, $\\mu$ is the dynamic viscosity in $\\mathrm{Pa}\\cdot\\mathrm{s}$, and $\\mathbf{K}$ is the permeability tensor in $\\mathrm{m}^2$. For this problem, the tensor is diagonal and aligned with the Cartesian axes: $\\mathbf{K} = \\mathrm{diag}(k_x, k_y)$.\n\n    For steady-state flow with no sources or sinks, the principle of mass conservation is expressed as:\n    $$\n    \\nabla \\cdot \\mathbf{q} = 0\n    $$\n    Substituting Darcy's law into the conservation equation yields the governing elliptic partial differential equation for pressure:\n    $$\n    \\nabla \\cdot \\left( - \\frac{\\mathbf{K}}{\\mu} \\nabla p \\right) = 0\n    $$\n\n2.  **Integral Form and Discretization**\n\n    The Finite Volume Method (FVM) starts by integrating the conservation law over a control volume $V_{i,j}$, which corresponds to a single grid cell. We use a 2D Cartesian grid where cell $(i,j)$ is centered at $(x_i, y_j)$, with $i \\in \\{0, \\dots, N_x-1\\}$ and $j \\in \\{0, \\dots, N_y-1\\}$. The cell has dimensions $\\Delta x \\times \\Delta y$.\n    $$\n    \\int_{V_{i,j}} \\nabla \\cdot \\mathbf{q} \\, dV = 0\n    $$\n    Applying the divergence theorem, we convert the volume integral into a surface integral over the boundary $\\partial V_{i,j}$ of the control volume:\n    $$\n    \\int_{\\partial V_{i,j}} \\mathbf{q} \\cdot \\mathbf{n} \\, dS = 0\n    $$\n    where $\\mathbf{n}$ is the outward-pointing unit normal vector to the cell surface.\n\n    The surface integral is discretized into a sum of total fluxes across the four faces of the rectangular cell (East, West, North, South). Let $Q_f$ be the total volumetric flux ($\\mathrm{m}^3/\\mathrm{s}$) outward across a face $f$. The equation for cell $(i,j)$ becomes:\n    $$\n    Q_{E} + Q_{W} + Q_{N} + Q_{S} = 0\n    $$\n    where, for example, $Q_{E}$ is the flux out of the east face, located at $x_{i+1/2} = x_i + \\Delta x/2$. Assuming unit thickness ($1 \\, \\mathrm{m}$), the area of this face is $A_E = \\Delta y \\cdot 1$. The total flux is approximated as the face-normal flux component multiplied by the face area:\n    $$\n    Q_E = A_E (\\mathbf{q} \\cdot \\mathbf{n})_E = \\Delta y \\, (q_x)_{i+1/2, j}\n    $$\n    Similarly, $Q_W = -\\Delta y \\, (q_x)_{i-1/2, j}$, $Q_N = \\Delta x \\, (q_y)_{i, j+1/2}$, and $Q_S = -\\Delta x \\, (q_y)_{i, j-1/2}$. The negative signs for West and South faces arise because the outward normal vectors are in the negative coordinate directions. The conservation equation is then:\n    $$\n    \\Delta y (q_x)_{i+1/2, j} - \\Delta y (q_x)_{i-1/2, j} + \\Delta x (q_y)_{i, j+1/2} - \\Delta x (q_y)_{i, j-1/2} = 0\n    $$\n\n3.  **Two-Point Flux Approximation (TPFA)**\n\n    TPFA approximates the face-normal flux using only the pressures of the two cells sharing that face. For the east face between cells $(i,j)$ and $(i+1,j)$, the $x$-component of the flux is $q_x = -(k_x/\\mu)(\\partial p / \\partial x)$. We approximate the pressure gradient using a finite difference between the cell centers:\n    $$\n    (q_x)_{i+1/2, j} \\approx - \\left( \\frac{k_x}{\\mu} \\right)_{i+1/2, j} \\frac{p_{i+1,j} - p_{i,j}}{\\Delta x}\n    $$\n    The term $p_{i,j}$ represents the pressure at the center of cell $(i,j)$. The question is how to evaluate the face permeability $(k_x)_{i+1/2, j}$ from the cell-centered permeabilities $k_{x,i,j}$ and $k_{x,i+1,j}$. To ensure flux continuity, the harmonic mean is the correct choice for one-dimensional flow between the cell centers. The effective permeability at the interface that conserves flux is:\n    $$\n    (k_x)_{i+1/2, j} = \\frac{2 \\, k_{x,i,j} \\, k_{x,i+1,j}}{k_{x,i,j} + k_{x,i+1,j}}\n    $$\n    We define a property called **transmissibility**, $T$, which combines geometry, permeability, and viscosity. The total outward flux across the east face is:\n    $$\n    Q_E = \\underbrace{\\left( \\frac{A_E (k_x)_{i+1/2, j}}{\\mu \\Delta x} \\right)}_{T_{i+1/2, j}} (p_{i,j} - p_{i+1,j}) = T_{i+1/2, j} (p_{i,j} - p_{i+1,j})\n    $$\n    The transmissibility for an interior face in the $x$-direction is:\n    $$\n    T_{i+1/2, j} = \\frac{\\Delta y}{\\mu \\Delta x} \\frac{2 \\, k_{x,i,j} \\, k_{x,i+1,j}}{k_{x,i,j} + k_{x,i+1,j}}\n    $$\n    Similarly, for an interior face in the $y$-direction:\n    $$\n    T_{i, j+1/2} = \\frac{\\Delta x}{\\mu \\Delta y} \\frac{2 \\, k_{y,i,j} \\, k_{y,i,j+1}}{k_{y,i,j} + k_{y,i,j+1}}\n    $$\n\n4.  **Handling Boundary Conditions**\n\n    -   **No-Flow (Neumann) Boundaries**: At the top ($y=L_y$, cells $j=N_y-1$) and bottom ($y=0$, cells $j=0$) boundaries, the flux is zero. This is enforced by setting the transmissibility of these boundary faces to zero. For example, for a cell $(i,0)$, $T_{i,-1/2} = 0$.\n\n    -   **Prescribed Pressure (Dirichlet) Boundaries**: At the left ($x=0$) and right ($x=L_x$) boundaries, the pressure is known. For a cell $(0,j)$ at the left boundary, the flux across its west face at $x_{-1/2}$ depends on the boundary pressure $p_\\mathrm{left}$. The distance from the cell center to the boundary is $\\Delta x/2$. The flux approximation is:\n    $$\n    (q_x)_{-1/2, j} \\approx - \\frac{k_{x,0,j}}{\\mu} \\frac{p_{0,j} - p_\\mathrm{left}}{\\Delta x/2}\n    $$\n    Note we only use the permeability of the cell itself, $k_{x,0,j}$. The total outward flux is $Q_W = T_{-1/2,j}(p_{0,j} - p_\\mathrm{left})$, with the boundary transmissibility defined as:\n    $$\n    T_{-1/2, j} = \\frac{A_W k_{x,0,j}}{\\mu (\\Delta x/2)} = \\frac{2 \\Delta y \\, k_{x,0,j}}{\\mu \\Delta x}\n    $$\n    Similarly, for a cell $(N_x-1,j)$ at the right boundary, the transmissibility is $T_{N_x-1/2, j} = \\frac{2 \\Delta y \\, k_{x,N_x-1,j}}{\\mu \\Delta x}$, and the flux contribution involves $p_\\mathrm{right}$.\n\n5.  **Assembly of the Linear System**\n\n    The mass balance for an interior cell $(i,j)$ is:\n    $$\n    T_{i+1/2, j}(p_{i,j} - p_{i+1,j}) + T_{i-1/2, j}(p_{i,j} - p_{i-1,j}) + T_{i,j+1/2}(p_{i,j} - p_{i,j+1}) + T_{i,j-1/2}(p_{i,j} - p_{i,j-1}) = 0\n    $$\n    This can be rearranged to form a linear equation for the unknown pressure $p_{i,j}$:\n    $$\n    (\\sum_{f} T_f) p_{i,j} - \\sum_{f} T_f p_{\\text{neighbor}} = 0\n    $$\n    where the sum is over the four faces. For a boundary cell, terms involving known boundary pressures are moved to the right-hand side (RHS). For example, for cell $(0,j)$:\n    $$\n    (T_{1/2,j} + T_{-1/2,j} + \\dots) p_{0,j} - T_{1/2,j}p_{1,j} - \\dots = T_{-1/2,j} p_\\mathrm{left}\n    $$\n    By applying this equation to every cell in the grid, we construct a system of $N = N_x \\times N_y$ linear equations for the $N$ unknown cell pressures. This system can be written in matrix form as $\\mathbf{A}\\mathbf{p} = \\mathbf{b}$, where $\\mathbf{p}$ is the vector of unknown cell pressures, $\\mathbf{A}$ is a sparse, symmetric positive-definite matrix of coefficients, and $\\mathbf{b}$ is the source vector containing contributions from Dirichlet boundaries. The matrix $\\mathbf{A}$ is pentadiagonal when using a natural row- or column-wise ordering of cells.\n\n6.  **Mass Balance Residual Calculation**\n\n    After solving the system $\\mathbf{A}\\mathbf{p} = \\mathbf{b}$ for the solution vector $\\mathbf{p}_{\\text{sol}}$, we can verify the quality of the solution by computing the local mass balance residual for each cell. The discrete conservation law for cell $k$ is $(\\mathbf{A}\\mathbf{p})_k = b_k$. The residual is the amount by which the numerical solution fails to satisfy this equation, defined as $r_k = (\\mathbf{A}\\mathbf{p}_{\\text{sol}})_k - b_k$. Physically, this corresponds to the net mass flow into/out of a cell based on the computed pressure field minus any explicit sources. For an exact solution, this residual would be zero. Due to finite-precision arithmetic, it will be a small number. The maximum absolute residual, $\\max_k |r_k|$, is a measure of the overall consistency of the numerical solution.", "answer": "```python\nimport numpy as np\nfrom scipy.sparse import lil_matrix, csr_matrix\nfrom scipy.sparse.linalg import spsolve\n\ndef solve_darcy_flow(\n    Nx, Ny, dx, dy, mu, kx, ky, p_left, p_right\n):\n    \"\"\"\n    Solves the 2D steady-state Darcy flow equation using a cell-centered\n    Finite Volume Method with a Two-Point Flux Approximation.\n\n    Args:\n        Nx (int): Number of cells in the x-direction.\n        Ny (int): Number of cells in the y-direction.\n        dx (float): Cell width in meters.\n        dy (float): Cell height in meters.\n        mu (float): Fluid viscosity in Pa.s.\n        kx (np.ndarray): Permeability in x-direction (m^2), shape (Ny, Nx).\n        ky (np.ndarray): Permeability in y-direction (m^2), shape (Ny, Nx).\n        p_left (float): Dirichlet boundary pressure at x=0 (Pa).\n        p_right (float): Dirichlet boundary pressure at x=Lx (Pa).\n\n    Returns:\n        float: Maximum absolute mass balance residual (m^3/s).\n    \"\"\"\n    N_cells = Nx * Ny\n    A = lil_matrix((N_cells, N_cells), dtype=np.float64)\n    b = np.zeros(N_cells, dtype=np.float64)\n\n    for j in range(Ny):\n        for i in range(Nx):\n            k = i + j * Nx\n\n            # West face\n            if i > 0:\n                k_west = i - 1 + j * Nx\n                # Harmonic mean for interior face permeability\n                kx_w_eff = 2 * kx[j, i] * kx[j, i - 1] / (kx[j, i] + kx[j, i - 1])\n                T_W = kx_w_eff * dy / (mu * dx)\n                A[k, k] += T_W\n                A[k, k_west] -= T_W\n            else:\n                # Dirichlet boundary at x=0\n                T_W_bnd = (kx[j, i] * dy) / (mu * (dx / 2.0))\n                A[k, k] += T_W_bnd\n                b[k] += T_W_bnd * p_left\n\n            # East face\n            if i  Nx - 1:\n                k_east = i + 1 + j * Nx\n                # Harmonic mean for interior face permeability\n                kx_e_eff = 2 * kx[j, i] * kx[j, i + 1] / (kx[j, i] + kx[j, i + 1])\n                T_E = kx_e_eff * dy / (mu * dx)\n                A[k, k] += T_E\n                A[k, k_east] -= T_E\n            else:\n                # Dirichlet boundary at x=Lx\n                T_E_bnd = (kx[j, i] * dy) / (mu * (dx / 2.0))\n                A[k, k] += T_E_bnd\n                b[k] += T_E_bnd * p_right\n\n            # South face\n            if j > 0:\n                k_south = i + (j - 1) * Nx\n                # Harmonic mean for interior face permeability\n                ky_s_eff = 2 * ky[j, i] * ky[j - 1, i] / (ky[j, i] + ky[j - 1, i])\n                T_S = ky_s_eff * dx / (mu * dy)\n                A[k, k] += T_S\n                A[k, k_south] -= T_S\n            else:\n                # No-flow boundary at y=0, transmissibility is 0\n                pass\n\n            # North face\n            if j  Ny - 1:\n                k_north = i + (j + 1) * Nx\n                # Harmonic mean for interior face permeability\n                ky_n_eff = 2 * ky[j, i] * ky[j + 1, i] / (ky[j, i] + ky[j + 1, i])\n                T_N = ky_n_eff * dx / (mu * dy)\n                A[k, k] += T_N\n                A[k, k_north] -= T_N\n            else:\n                # No-flow boundary at y=Ly, transmissibility is 0\n                pass\n\n    A_csr = A.tocsr()\n    p_sol = spsolve(A_csr, b)\n\n    residual_vector = A_csr @ p_sol - b\n    max_abs_residual = np.max(np.abs(residual_vector))\n\n    return max_abs_residual\n\ndef solve():\n    # Define common parameters\n    Nx = 10\n    Ny = 10\n    dx = 1.0\n    dy = 1.0\n    mu = 1e-3\n    p_left = 2e5\n    p_right = 1e5\n\n    # Define test cases\n    test_cases = []\n\n    # Case 1: General case (uniform, isotropic)\n    kx1 = np.full((Ny, Nx), 1e-12)\n    ky1 = np.full((Ny, Nx), 1e-12)\n    test_cases.append(\n        {\"Nx\": Nx, \"Ny\": Ny, \"dx\": dx, \"dy\": dy, \"mu\": mu, \"kx\": kx1, \"ky\": ky1, \"p_left\": p_left, \"p_right\": p_right}\n    )\n\n    # Case 2: Strong heterogeneity (step change)\n    kx2 = np.full((Ny, Nx), 1.0) # Placeholder\n    kx2[:, 0:5] = 1e-12  # i = 4 (cols 0, 1, 2, 3, 4)\n    kx2[:, 5:10] = 1e-13 # i >= 5 (cols 5, 6, 7, 8, 9)\n    ky2 = np.copy(kx2)\n    test_cases.append(\n        {\"Nx\": Nx, \"Ny\": Ny, \"dx\": dx, \"dy\": dy, \"mu\": mu, \"kx\": kx2, \"ky\": ky2, \"p_left\": p_left, \"p_right\": p_right}\n    )\n\n    # Case 3: Strong anisotropy\n    kx3 = np.full((Ny, Nx), 1e-11)\n    ky3 = np.full((Ny, Nx), 1e-13)\n    test_cases.append(\n        {\"Nx\": Nx, \"Ny\": Ny, \"dx\": dx, \"dy\": dy, \"mu\": mu, \"kx\": kx3, \"ky\": ky3, \"p_left\": p_left, \"p_right\": p_right}\n    )\n\n    # Case 4: High-contrast barrier\n    kx4 = np.full((Ny, Nx), 1e-12)\n    ky4 = np.full((Ny, Nx), 1e-12)\n    # i in {3,4,5,6} -> cols 3,4,5,6\n    # j in {3,4,5,6} -> rows 3,4,5,6\n    # numpy slice is [3:7] for indices 3, 4, 5, 6\n    kx4[3:7, 3:7] = 1e-16\n    ky4[3:7, 3:7] = 1e-16\n    test_cases.append(\n        {\"Nx\": Nx, \"Ny\": Ny, \"dx\": dx, \"dy\": dy, \"mu\": mu, \"kx\": kx4, \"ky\": ky4, \"p_left\": p_left, \"p_right\": p_right}\n    )\n    \n    results = []\n    for case_params in test_cases:\n        result = solve_darcy_flow(**case_params)\n        results.append(result)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3583087"}]}