{"hands_on_practices": [{"introduction": "A cornerstone of computational modeling is the principle of superposition, where a complex problem is solved by summing the effects of simpler, fundamental components. This practice applies that principle to magnetics by asking you to build a forward model for a large prism by discretizing it into a collection of small magnetic dipoles. By implementing this model from first principles, you will gain a foundational, hands-on understanding of how continuous geological bodies are represented and simulated numerically [@problem_id:3597743].", "problem": "A uniformly magnetized rectangular prism is buried beneath a flat observation surface. The prism has dimensions $200\\,\\mathrm{m}$ along the east ($x$) axis, $300\\,\\mathrm{m}$ along the north ($y$) axis, and $100\\,\\mathrm{m}$ in thickness along the vertical ($z$) axis. The coordinate system is defined such that $x$ points east, $y$ points north, and $z$ points upward, with the ground surface at $z=0$. The prism is centered horizontally at the origin $\\left(x=0,y=0\\right)$, with its top face at $z=-50\\,\\mathrm{m}$ and its bottom face at $z=-150\\,\\mathrm{m}$. The magnetization vector $\\mathbf{M}$ is uniform inside the prism, aligned with the Earth's main field direction $\\mathbf{H}_0$, with inclination $I=65^\\circ$ (positive downward) and declination $D=-20^\\circ$ (clockwise from north toward east). The magnitude of the magnetization is $\\|\\mathbf{M}\\|=3\\,\\mathrm{A/m}$, and the permeability of free space is $\\mu_0=4\\pi\\times 10^{-7}\\,\\mathrm{H/m}$.\n\nThe task is to forward model the total-field magnetic anomaly on horizontal observation grids at a specified altitude above ground. The total-field anomaly is defined using the linearization valid for small anomalies relative to the Earth's main field magnitude, as the projection of the anomalous magnetic induction $\\mathbf{B}_{\\text{anom}}$ onto the unit vector along $\\mathbf{H}_0$. Let the unit vector be $\\hat{\\mathbf{u}}_H$, so the total-field anomaly at an observation point is $b_T=\\hat{\\mathbf{u}}_H\\cdot \\mathbf{B}_{\\text{anom}}$, to be expressed in nanotesla. The unit vector $\\hat{\\mathbf{u}}_H$ must be constructed from the given inclination and declination in degrees, assuming the coordinate axes defined above.\n\nStarting from first principles of magnetostatics and a physically justified numerical approximation, derive an algorithm to compute the anomalous field by representing the uniformly magnetized prism as a superposition of many small magnetic dipoles, each with moment $\\mathrm{d}\\mathbf{m}=\\mathbf{M}\\,\\mathrm{d}V$, and summing their contributions at observation points. The magnetic induction of a point dipole at position $\\mathbf{r}_0$ with moment $\\mathbf{m}$, evaluated at $\\mathbf{r}$, must be used as the physically correct kernel for superposition. You must explicitly convert the angles $I$ and $D$ from degrees to radians before constructing $\\hat{\\mathbf{u}}_H$.\n\nDefine the \"peak amplitude\" as the maximum of the absolute value of the total-field anomaly over the grid, $\\max|\\!b_T\\!|$, and define the \"footprint area\" as the area (in square meters) of grid nodes where $|b_T|\\ge 0.5\\times \\max|\\!b_T\\!|$, approximated by a Riemann sum using the grid spacing squared.\n\nYou must implement the algorithm as a complete, runnable program that produces numerical results for the following test suite. All angles must be treated in degrees as given, but numerical computation must internally use radians. All magnetic anomaly amplitudes must be reported in nanotesla and footprint areas must be reported in square meters.\n\nTest suite:\n1. Baseline case: altitude $z=+100\\,\\mathrm{m}$ (above ground), observation grid covering $x\\in[-500,500]\\,\\mathrm{m}$ and $y\\in[-500,500]\\,\\mathrm{m}$ with uniform spacing $\\Delta=25\\,\\mathrm{m}$.\n2. Far-field case: altitude $z=+500\\,\\mathrm{m}$, observation grid covering $x\\in[-500,500]\\,\\mathrm{m}$ and $y\\in[-500,500]\\,\\mathrm{m}$ with uniform spacing $\\Delta=25\\,\\mathrm{m}$.\n3. Coarse-resolution case: altitude $z=+100\\,\\mathrm{m}$, observation grid covering $x\\in[-300,300]\\,\\mathrm{m}$ and $y\\in[-300,300]\\,\\mathrm{m}$ with uniform spacing $\\Delta=50\\,\\mathrm{m}$.\n\nFor each case, compute:\n- the peak amplitude $\\max|\\!b_T\\!|$ in nanotesla, rounded to one decimal place,\n- the footprint area in square meters, computed as $\\text{count}\\times \\Delta^2$ and reported as an integer.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each test case result is itself a two-element list $[\\text{peak},\\text{area}]$. For example, the output format must be exactly like:\n$[\\,[p_1,a_1],[p_2,a_2],[p_3,a_3]\\,]$\nwith $p_i$ floating-point values in nanotesla and $a_i$ integers in square meters.", "solution": "The problem requires the computation of the total-field magnetic anomaly produced by a uniformly magnetized rectangular prism. The solution will be developed from first principles using a numerical approximation, where the continuous source volume is discretized into a collection of point magnetic dipoles. The total field is then calculated by the principle of superposition.\n\nThe problem is determined to be valid as it is scientifically grounded in magnetostatics, well-posed with all necessary parameters provided, and objective in its formulation. It represents a standard forward modeling task in computational geophysics.\n\nThe derivation and algorithmic design proceed as follows:\n\n**1. Definition of Coordinate System and Field Direction**\nThe problem specifies a right-handed Cartesian coordinate system with the $x$-axis pointing east, the $y$-axis pointing north, and the $z$-axis pointing upward. The ground surface is the plane $z=0$.\n\nThe Earth's main magnetic field direction, which defines both the direction of magnetization $\\mathbf{M}$ and the projection direction for the total-field anomaly, is given by an inclination $I=65^\\circ$ and a declination $D=-20^\\circ$. Inclination is the angle from the horizontal plane, positive downward. Declination is the angle from true north, with the problem stating that a negative angle corresponds to a clockwise rotation from north towards east. Assuming the standard geophysical convention where positive declination is east of north, a declination of $D=-20^\\circ$ corresponds to a direction $20^\\circ$ west of north.\n\nThe unit vector $\\hat{\\mathbf{u}}_H$ along the main field direction is constructed in the $(x, y, z)$ system. First, the angles must be converted to radians: $I_{rad} = I \\cdot \\pi/180$ and $D_{rad} = D \\cdot \\pi/180$. The components of $\\hat{\\mathbf{u}}_H$ are then:\n$$ \\hat{u}_{H,x} = \\cos(I_{rad}) \\sin(D_{rad}) $$\n$$ \\hat{u}_{H,y} = \\cos(I_{rad}) \\cos(D_{rad}) $$\n$$ \\hat{u}_{H,z} = -\\sin(I_{rad}) $$\nThe negative sign in the $z$-component arises because the inclination $I$ is positive downwards, while the $z$-axis is positive upwards. The magnetization vector $\\mathbf{M}$ is given by $\\mathbf{M} = \\|\\mathbf{M}\\| \\hat{\\mathbf{u}}_H$, with a magnitude of $\\|\\mathbf{M}\\| = 3\\,\\mathrm{A/m}$.\n\n**2. Magnetic Field of a Point Dipole**\nThe fundamental building block of our model is the magnetic induction field $\\mathbf{B}$ generated by a point magnetic dipole. For a dipole with moment $\\mathbf{m}$ located at position $\\mathbf{r}'$, the field at an observation point $\\mathbf{r}$ is given by the expression:\n$$ \\mathbf{B}(\\mathbf{r}) = \\frac{\\mu_0}{4\\pi} \\left( \\frac{3(\\mathbf{m} \\cdot \\mathbf{R})\\mathbf{R}}{\\|\\mathbf{R}\\|^5} - \\frac{\\mathbf{m}}{\\|\\mathbf{R}\\|^3} \\right) $$\nwhere $\\mathbf{R} = \\mathbf{r} - \\mathbf{r}'$ is the displacement vector from the source to the observation point, and $\\mu_0 = 4\\pi \\times 10^{-7}\\,\\mathrm{H/m}$ is the permeability of free space.\n\n**3. Discretization of the Source Prism**\nThe source is a rectangular prism with dimensions $200\\,\\mathrm{m}$ ($x$-axis), $300\\,\\mathrm{m}$ ($y$-axis), and $100\\,\\mathrm{m}$ ($z$-axis), centered at $(x=0, y=0)$. Its top face is at $z=-50\\,\\mathrm{m}$ and its bottom at $z=-150\\,\\mathrm{m}$. The prism therefore occupies the volume defined by $x \\in [-100, 100]\\,\\mathrm{m}$, $y \\in [-150, 150]\\,\\mathrm{m}$, and $z \\in [-150, -50]\\,\\mathrm{m}$.\n\nTo compute the field numerically, we discretize this volume into a set of small, contiguous cubic voxels. Let the prism be divided into $N_x \\times N_y \\times N_z$ voxels. Each voxel, indexed by $(i,j,k)$, has a small volume $\\mathrm{d}V$. As the magnetization $\\mathbf{M}$ is uniform, the magnetic moment of each voxel is:\n$$ \\mathbf{m}_{ijk} = \\mathbf{M} \\, \\mathrm{d}V $$\nEach voxel is represented by a point dipole with this moment, located at the voxel's center, $\\mathbf{r}'_{ijk}$.\n\n**4. Superposition for the Total Anomalous Field**\nThe total anomalous magnetic induction $\\mathbf{B}_{\\text{anom}}$ at an observation point $\\mathbf{r}_{obs}$ is the vector sum of the fields produced by all the individual dipoles:\n$$ \\mathbf{B}_{\\text{anom}}(\\mathbf{r}_{obs}) = \\sum_{i,j,k} \\mathbf{B}_{ijk}(\\mathbf{r}_{obs}) = \\sum_{i,j,k} \\frac{\\mu_0}{4\\pi} \\left( \\frac{3(\\mathbf{m}_{ijk} \\cdot \\mathbf{R}_{ijk})\\mathbf{R}_{ijk}}{\\|\\mathbf{R}_{ijk}\\|^5} - \\frac{\\mathbf{m}_{ijk}}{\\|\\mathbf{R}_{ijk}\\|^3} \\right) $$\nwhere $\\mathbf{R}_{ijk} = \\mathbf{r}_{obs} - \\mathbf{r}'_{ijk}$. Since $\\mathbf{m}_{ijk} = \\mathbf{M} \\, \\mathrm{d}V$ is identical for all voxels, this can be written as:\n$$ \\mathbf{B}_{\\text{anom}}(\\mathbf{r}_{obs}) = \\frac{\\mu_0 \\, \\mathrm{d}V}{4\\pi} \\sum_{i,j,k} \\left( \\frac{3(\\mathbf{M} \\cdot \\mathbf{R}_{ijk})\\mathbf{R}_{ijk}}{\\|\\mathbf{R}_{ijk}\\|^5} - \\frac{\\mathbf{M}}{\\|\\mathbf{R}_{ijk}\\|^3} \\right) $$\n\n**5. Derivation of the Total-Field Anomaly**\nThe total-field anomaly, $b_T$, is the projection of the anomalous field vector $\\mathbf{B}_{\\text{anom}}$ onto the direction of the Earth's main field, $\\hat{\\mathbf{u}}_H$.\n$$ b_T(\\mathbf{r}_{obs}) = \\hat{\\mathbf{u}}_H \\cdot \\mathbf{B}_{\\text{anom}}(\\mathbf{r}_{obs}) $$\nSubstituting the expression for $\\mathbf{B}_{\\text{anom}}$ and distributing the dot product gives:\n$$ b_T(\\mathbf{r}_{obs}) = \\frac{\\mu_0 \\, \\mathrm{d}V}{4\\pi} \\sum_{i,j,k} \\left( \\frac{3(\\mathbf{M} \\cdot \\mathbf{R}_{ijk})(\\hat{\\mathbf{u}}_H \\cdot \\mathbf{R}_{ijk})}{\\|\\mathbf{R}_{ijk}\\|^5} - \\frac{\\hat{\\mathbf{u}}_H \\cdot \\mathbf{M}}{\\|\\mathbf{R}_{ijk}\\|^3} \\right) $$\nA crucial simplification arises because the magnetization is induced and thus aligned with the Earth's field: $\\mathbf{M} = \\|\\mathbf{M}\\| \\hat{\\mathbf{u}}_H$. Substituting this into the equation yields:\n$$ \\hat{\\mathbf{u}}_H \\cdot \\mathbf{M} = \\hat{\\mathbf{u}}_H \\cdot (\\|\\mathbf{M}\\| \\hat{\\mathbf{u}}_H) = \\|\\mathbf{M}\\| (\\hat{\\mathbf{u}}_H \\cdot \\hat{\\mathbf{u}}_H) = \\|\\mathbf{M}\\| $$\n$$ \\mathbf{M} \\cdot \\mathbf{R}_{ijk} = (\\|\\mathbf{M}\\| \\hat{\\mathbf{u}}_H) \\cdot \\mathbf{R}_{ijk} = \\|\\mathbf{M}\\| (\\hat{\\mathbf{u}}_H \\cdot \\mathbf{R}_{ijk}) $$\nThe expression for $b_T$ simplifies to:\n$$ b_T(\\mathbf{r}_{obs}) = \\frac{\\mu_0 \\|\\mathbf{M}\\| \\mathrm{d}V}{4\\pi} \\sum_{i,j,k} \\left( \\frac{3(\\hat{\\mathbf{u}}_H \\cdot \\mathbf{R}_{ijk})^2}{\\|\\mathbf{R}_{ijk}\\|^5} - \\frac{1}{\\|\\mathbf{R}_{ijk}\\|^3} \\right) $$\nThis final form is computationally efficient as it involves scalar operations with pre-calculated vectors. The result must be multiplied by $10^9$ to convert from Tesla ($T$) to nanotesla ($nT$).\n\n**6. Algorithm and Metrics**\nThe algorithm proceeds as follows:\n1.  Define physical constants and problem parameters.\n2.  Calculate the components of the unit vector $\\hat{\\mathbf{u}}_H$.\n3.  Discretize the source prism into a grid of voxels and determine their central coordinates $\\mathbf{r}'_{ijk}$ and volume $\\mathrm{d}V$. A voxel size of $10\\,\\mathrm{m} \\times 10\\,\\mathrm{m} \\times 10\\,\\mathrm{m}$ is chosen for a reasonable balance of accuracy and computational cost.\n4.  For each test case, define the observation grid of points $\\mathbf{r}_{obs}$.\n5.  For each observation point, compute the sum in the final expression for $b_T$. This is best performed using vectorized computations for efficiency.\n6.  Multiply the sum by the pre-factor $\\frac{\\mu_0 \\|\\mathbf{M}\\| \\mathrm{d}V}{4\\pi}$ (which simplifies to $10^{-7} \\|\\mathbf{M}\\| \\mathrm{d}V$) and convert to nanotesla.\n7.  After calculating the anomaly $b_T$ over the entire grid, compute the required metrics:\n    -   Peak amplitude: $\\max|\\!b_T\\!|$.\n    -   Footprint area: The area where $|b_T| \\geq 0.5 \\times \\max|\\!b_T\\!|$. This is approximated by counting the number of grid nodes satisfying this condition and multiplying by the area per node, $\\Delta^2$.\nThe results are then formatted as specified.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the total-field magnetic anomaly from a uniformly magnetized prism\n    using a dipole summation method for specified observation grids.\n    \"\"\"\n    \n    # 1. Define constants and source parameters\n    MU0 = 4 * np.pi * 1e-7  # Permeability of free space (H/m)\n    M_mag = 3.0  # Magnitude of magnetization (A/m)\n    I_deg = 65.0  # Inclination (degrees, positive down)\n    D_deg = -20.0  # Declination (degrees, clockwise from north towards east)\n\n    # Prism geometry\n    prism_bounds = {\n        'x': np.array([-100.0, 100.0]),\n        'y': np.array([-150.0, 150.0]),\n        'z': np.array([-150.0, -50.0])\n    }\n\n    # 2. Vector definitions\n    # Convert angles to radians\n    I_rad = np.deg2rad(I_deg)\n    D_rad = np.deg2rad(D_deg)\n\n    # Unit vector for Earth's main field (and magnetization)\n    # x: East, y: North, z: Up\n    uH = np.array([\n        np.cos(I_rad) * np.sin(D_rad),\n        np.cos(I_rad) * np.cos(D_rad),\n        -np.sin(I_rad)\n    ])\n\n    # 3. Discretize the source prism into dipole sources\n    cell_dim = 10.0  # Voxel edge length in meters\n    dV = cell_dim**3  # Voxel volume\n\n    nx = int((prism_bounds['x'][1] - prism_bounds['x'][0]) / cell_dim)\n    ny = int((prism_bounds['y'][1] - prism_bounds['y'][0]) / cell_dim)\n    nz = int((prism_bounds['z'][1] - prism_bounds['z'][0]) / cell_dim)\n\n    # Voxel center coordinates\n    x_src = np.linspace(prism_bounds['x'][0] + cell_dim / 2, prism_bounds['x'][1] - cell_dim / 2, nx)\n    y_src = np.linspace(prism_bounds['y'][0] + cell_dim / 2, prism_bounds['y'][1] - cell_dim / 2, ny)\n    z_src = np.linspace(prism_bounds['z'][0] + cell_dim / 2, prism_bounds['z'][1] - cell_dim / 2, nz)\n\n    xx_src, yy_src, zz_src = np.meshgrid(x_src, y_src, z_src, indexing='ij')\n    r_prime = np.vstack([xx_src.ravel(), yy_src.ravel(), zz_src.ravel()]).T\n\n    # 4. Define Test Cases\n    test_cases = [\n        # (altitude, x_lims, y_lims, grid_spacing)\n        (100.0, [-500.0, 500.0], [-500.0, 500.0], 25.0),  # Baseline\n        (500.0, [-500.0, 500.0], [-500.0, 500.0], 25.0),  # Far-field\n        (100.0, [-300.0, 300.0], [-300.0, 300.0], 50.0),  # Coarse-resolution\n    ]\n\n    all_results = []\n    \n    # Pre-factor for bT calculation in Tesla\n    # (MU0 / (4 * pi)) * M_mag * dV = 1e-7 * M_mag * dV\n    pre_factor_T = 1e-7 * M_mag * dV\n\n    # 5. Loop through test cases and compute anomalies\n    for alt, x_lim, y_lim, delta in test_cases:\n        # Create observation grid\n        x_obs = np.arange(x_lim[0], x_lim[1] + delta, delta)\n        y_obs = np.arange(y_lim[0], y_lim[1] + delta, delta)\n\n        xx_obs, yy_obs = np.meshgrid(x_obs, y_obs, indexing='ij')\n        zz_obs = np.full_like(xx_obs, alt)\n\n        r_obs = np.vstack([xx_obs.ravel(), yy_obs.ravel(), zz_obs.ravel()]).T\n        \n        # Vectorized computation of the anomaly\n        # R = r_obs - r_prime (using broadcasting)\n        # R has shape (N_obs, N_dipoles, 3)\n        R = r_obs[:, np.newaxis, :] - r_prime[np.newaxis, :, :]\n\n        R_sq_norm = np.sum(R**2, axis=2)\n        uH_dot_R = np.dot(R, uH)\n        \n        # Term inside the summation\n        term_matrix = 3 * uH_dot_R**2 / R_sq_norm**2.5 - 1 / R_sq_norm**1.5\n        \n        # Sum over all dipoles for each observation point\n        bT_sum_term = np.sum(term_matrix, axis=1)\n\n        # Calculate final anomaly in nanotesla\n        bT_tesla = pre_factor_T * bT_sum_term\n        bT_nT = bT_tesla * 1e9\n\n        # 6. Calculate and store metrics\n        peak_amplitude = np.max(np.abs(bT_nT))\n        threshold = 0.5 * peak_amplitude\n        \n        footprint_count = np.sum(np.abs(bT_nT) >= threshold)\n        footprint_area = footprint_count * delta**2\n\n        all_results.append([round(peak_amplitude, 1), int(footprint_area)])\n\n    # 7. Print results in the specified format\n    formatted_results = [f\"[{p},{a}]\" for p, a in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\n\nsolve()\n```", "id": "3597743"}, {"introduction": "In many geological settings, the magnetization of a body is not a fixed property but is induced by the Earth's magnetic field, and this relationship can be highly nonlinear for strongly magnetic materials. This practice explores this advanced physical reality by guiding you through the implementation of a fixed-point iterative solver to find the self-consistent magnetization within an ellipsoidal body, accounting for both material saturation and the body's own demagnetizing field. Mastering this iterative technique is crucial for accurately modeling highly magnetic ore bodies and other challenging targets [@problem_id:3597732].", "problem": "You are asked to implement a complete, runnable program that performs forward modeling of magnetic anomalies for a uniformly magnetizable ellipsoidal body with nonlinear, saturating magnetization. The unknown magnetization satisfies a self-consistent, nonlinear equation due to demagnetization. Your program must construct and solve this equation by a fixed-point iteration, assess convergence behavior with varying initial guesses and demagnetization tensors, and then compute the vertical magnetic induction anomaly at a specified observation point using the dipole approximation.\n\nBegin from the following fundamental base:\n- In magnetostatics, the magnetic induction and magnetic field satisfy $\\mathbf{B}=\\mu_0(\\mathbf{H}+\\mathbf{M})$, where $\\mu_0$ is the magnetic permeability of free space, $\\mathbf{H}$ is the magnetic field, and $\\mathbf{M}$ is the magnetization. \n- For a uniformly magnetized ellipsoid, the local field inside the body is $\\mathbf{H}_{\\text{loc}}=\\mathbf{H}_{\\text{ext}}-\\mathbf{N}\\,\\mathbf{M}$, where $\\mathbf{H}_{\\text{ext}}$ is a uniform external field and $\\mathbf{N}$ is the demagnetization tensor, a real, symmetric, positive semidefinite matrix with eigenvalues in $[0,1]$ satisfying $\\mathrm{tr}(\\mathbf{N})=1$ for ellipsoids in free space. \n- Assume an isotropic, nonlinear, saturating constitutive law $\\mathbf{M}=\\mathbf{K}(\\mathbf{H}_{\\text{loc}})\\,\\mathbf{H}_{\\text{loc}}$ consistent with saturation. Use the phenomenological law $\\mathbf{M}=M_s \\tanh\\!\\big(\\alpha\\|\\mathbf{H}_{\\text{loc}}\\|\\big)\\,\\widehat{\\mathbf{H}}_{\\text{loc}}$ with $\\alpha=\\chi_0/M_s$, where $M_s$ is the saturation magnetization, $\\chi_0$ is the low-field susceptibility, $\\|\\cdot\\|$ is the Euclidean norm, and $\\widehat{\\mathbf{H}}_{\\text{loc}}=\\mathbf{H}_{\\text{loc}}/\\|\\mathbf{H}_{\\text{loc}}\\|$ for $\\|\\mathbf{H}_{\\text{loc}}\\|>0$ and $\\mathbf{0}$ otherwise. This implies an isotropic scalar kernel $K(\\mathbf{H})=M_s \\tanh(\\alpha\\|\\mathbf{H}\\|)/\\|\\mathbf{H}\\|$ for $\\|\\mathbf{H}\\|>0$ and $K(\\mathbf{0})=\\chi_0$. \n- In the dipole approximation, a uniformly magnetized compact body with volume $V$ and uniform magnetization $\\mathbf{M}$ has magnetic dipole moment $\\mathbf{m}=V\\,\\mathbf{M}$, and produces a magnetic induction at observation location $\\mathbf{r}\\neq \\mathbf{0}$ given by $\\mathbf{B}_{\\text{dip}}(\\mathbf{r})=\\dfrac{\\mu_0}{4\\pi r^3}\\left[3(\\mathbf{m}\\cdot \\widehat{\\mathbf{r}})\\,\\widehat{\\mathbf{r}}-\\mathbf{m}\\right]$, where $r=\\|\\mathbf{r}\\|$ and $\\widehat{\\mathbf{r}}=\\mathbf{r}/r$.\n\nYour tasks are:\n- Formulate the fixed-point iteration $\\mathbf{M}^{(k+1)}=\\mathcal{F}(\\mathbf{M}^{(k)})$ derived from the constitutive law and the demagnetization relation, and implement it to find the self-consistent magnetization for each test case. Use the stopping criterion $\\|\\mathbf{M}^{(k+1)}-\\mathbf{M}^{(k)}\\|<\\varepsilon$ with tolerance $\\varepsilon$, and an iteration cap $k_{\\max}$ to prevent infinite loops.\n- After convergence, compute the vertical component of the dipole magnetic induction anomaly, $\\Delta B_z$, at an observation point located on the symmetry axis above the body’s center, using the dipole expression. Report $\\Delta B_z$ in nanotesla.\n\nScientific and numerical specifications:\n- Use $\\mu_0=4\\pi\\times 10^{-7}\\,\\mathrm{N/A^2}$.\n- Use a family of ellipsoidal bodies with equal volume $V=\\dfrac{4}{3}\\pi R^3$, where $R$ is an equivalent-radius parameter. Take $R=50\\,\\mathrm{m}$, so that $V=\\dfrac{4}{3}\\pi \\times 50^3\\,\\mathrm{m^3}$ is held fixed across test cases.\n- Let the external field be uniform, aligned with the $z$-axis, with magnitude $\\|\\mathbf{H}_{\\text{ext}}\\|=40\\,\\mathrm{A/m}$, i.e., $\\mathbf{H}_{\\text{ext}}=(0,0,40)\\,\\mathrm{A/m}$.\n- Use saturation magnetization $M_s=480000\\,\\mathrm{A/m}$ and low-field susceptibility $\\chi_0=1.0$ (dimensionless).\n- Use observation point $\\mathbf{r}=(0,0,z_o)$ with $z_o=100\\,\\mathrm{m}$ above the body center.\n- Use fixed-point tolerance $\\varepsilon=10^{-10}\\,\\mathrm{A/m}$ and maximum iterations $k_{\\max}=10000$.\n- Treat the special case $\\|\\mathbf{H}_{\\text{loc}}\\|=0$ by setting $\\mathbf{M}=\\mathbf{0}$ for that iterate.\n\nTest suite:\nImplement your solver for the following four test cases, which explore convergence behavior as a function of the initial guess and the demagnetization tensor $\\mathbf{N}$. In all cases, $\\mathbf{H}_{\\text{ext}}=(0,0,40)\\,\\mathrm{A/m}$, $M_s=480000\\,\\mathrm{A/m}$, $\\chi_0=1.0$, $R=50\\,\\mathrm{m}$, and $z_o=100\\,\\mathrm{m}$.\n\n- Case $1$ (baseline sphere, neutral initial guess):\n  - $\\mathbf{N}=\\mathrm{diag}\\!\\big(\\tfrac{1}{3},\\tfrac{1}{3},\\tfrac{1}{3}\\big)$.\n  - Initial guess $\\mathbf{M}^{(0)}=(0,0,0)\\,\\mathrm{A/m}$.\n\n- Case $2$ (oblate-like demagnetization, neutral initial guess):\n  - $\\mathbf{N}=\\mathrm{diag}(0.495,0.495,0.01)$.\n  - Initial guess $\\mathbf{M}^{(0)}=(0,0,0)\\,\\mathrm{A/m}$.\n\n- Case $3$ (prolate-like demagnetization, neutral initial guess):\n  - $\\mathbf{N}=\\mathrm{diag}(0.499,0.499,0.002)$.\n  - Initial guess $\\mathbf{M}^{(0)}=(0,0,0)\\,\\mathrm{A/m}$.\n\n- Case $4$ (baseline sphere, adverse initial guess near opposite saturation):\n  - $\\mathbf{N}=\\mathrm{diag}\\!\\big(\\tfrac{1}{3},\\tfrac{1}{3},\\tfrac{1}{3}\\big)$.\n  - Initial guess $\\mathbf{M}^{(0)}=(0,0,-480000)\\,\\mathrm{A/m}$.\n\nProgram requirements:\n- Compute the converged magnetization $\\mathbf{M}$ for each case by fixed-point iteration as described.\n- Using $\\mathbf{m}=V\\,\\mathbf{M}$ and the dipole formula, compute the vertical anomaly $\\Delta B_z$ at $\\mathbf{r}=(0,0,100)\\,\\mathrm{m}$. Express $\\Delta B_z$ in nanotesla, rounded to $6$ decimal places.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of Cases $1$ through $4$, for example, \"[x1,x2,x3,x4]\" where each entry is a float in nanotesla rounded to $6$ decimal places and without units in the printout.\n\nAngle units are not used in this problem. All physical quantities in your computation must be consistently in the International System of Units, and the reported anomaly values must be in nanotesla as specified.", "solution": "The problem requires the forward modeling of the magnetic anomaly produced by a uniformly magnetizable ellipsoidal body with a nonlinear, saturating magnetization response. The core of the problem is to determine the self-consistent magnetization vector $\\mathbf{M}$ that simultaneously satisfies the material's constitutive law and the internal demagnetizing field. Once $\\mathbf{M}$ is found, the magnetic anomaly at a specified observation point is computed using the magnetic dipole approximation.\n\n**1. Formulation of the Self-Consistent Magnetization Equation**\n\nThe magnetic state of the body is governed by the interplay of the external field, the material's response, and the geometry-dependent demagnetizing field. The fundamental relations are:\n1.  The local magnetic field $\\mathbf{H}_{\\text{loc}}$ inside the ellipsoid is the sum of the uniform external field $\\mathbf{H}_{\\text{ext}}$ and the demagnetizing field $\\mathbf{H}_{\\text{demag}}$, which is linearly related to the magnetization $\\mathbf{M}$ by the demagnetization tensor $\\mathbf{N}$:\n    $$\n    \\mathbf{H}_{\\text{loc}} = \\mathbf{H}_{\\text{ext}} + \\mathbf{H}_{\\text{demag}} = \\mathbf{H}_{\\text{ext}} - \\mathbf{N}\\mathbf{M}\n    $$\n2.  The magnetization $\\mathbf{M}$ is a nonlinear function of the local field $\\mathbf{H}_{\\text{loc}}$. The problem specifies an isotropic, saturating phenomenological law:\n    $$\n    \\mathbf{M} = M_s \\tanh\\left(\\alpha \\|\\mathbf{H}_{\\text{loc}}\\|\\right) \\frac{\\mathbf{H}_{\\text{loc}}}{\\|\\mathbf{H}_{\\text{loc}}\\|}\n    $$\n    where $M_s$ is the saturation magnetization, $\\alpha = \\chi_0/M_s$, and $\\chi_0$ is the low-field magnetic susceptibility. This relation holds for $\\|\\mathbf{H}_{\\text{loc}}\\| > 0$. If $\\|\\mathbf{H}_{\\text{loc}}\\| = 0$, then $\\mathbf{M} = \\mathbf{0}$. The expression can be written more compactly using the identity $\\tanh(x) \\frac{\\mathbf{v}}{\\|\\mathbf{v}\\|} = \\tanh(\\|\\mathbf{v}\\| \\frac{x}{\\|\\mathbf{v}\\|}) \\frac{\\mathbf{v}}{\\|\\mathbf{v}\\|}$ which is not quite right. A better way is $\\tanh(x) \\hat{v}$. For a vector argument $\\mathbf{u}$, we can define a vector tanh function such that $\\tanh(\\mathbf{u}) = \\tanh(\\|\\mathbf{u}\\|)\\hat{\\mathbf{u}}$. Using this, the constitutive law is $\\mathbf{M} = M_s \\tanh(\\alpha \\mathbf{H}_{\\text{loc}})$.\n\nCombining these two equations yields a single, self-consistent nonlinear vector equation for the unknown magnetization $\\mathbf{M}$:\n$$\n\\mathbf{M} = M_s \\tanh\\left(\\alpha \\|\\mathbf{H}_{\\text{ext}} - \\mathbf{N}\\mathbf{M}\\|\\right) \\frac{\\mathbf{H}_{\\text{ext}} - \\mathbf{N}\\mathbf{M}}{\\|\\mathbf{H}_{\\text{ext}} - \\mathbf{N}\\mathbf{M}\\|}\n$$\nThis equation is of the form $\\mathbf{M} = \\mathcal{F}(\\mathbf{M})$, which is amenable to solution via fixed-point iteration.\n\n**2. Fixed-Point Iteration Scheme**\n\nWe construct an iterative sequence $\\mathbf{M}^{(k)}$ that, upon convergence, yields the solution. Starting with an initial guess $\\mathbf{M}^{(0)}$, the sequence is generated by:\n$$\n\\mathbf{M}^{(k+1)} = \\mathcal{F}(\\mathbf{M}^{(k)})\n$$\nThe procedure for each iteration is:\n1.  Given the current magnetization estimate $\\mathbf{M}^{(k)}$, calculate the corresponding local field:\n    $$\n    \\mathbf{H}_{\\text{loc}}^{(k)} = \\mathbf{H}_{\\text{ext}} - \\mathbf{N}\\mathbf{M}^{(k)}\n    $$\n2.  Compute the norm of the local field, $\\|\\mathbf{H}_{\\text{loc}}^{(k)}\\|$.\n3.  If $\\|\\mathbf{H}_{\\text{loc}}^{(k)}\\|$ is zero (or numerically close), the next magnetization estimate is the zero vector, $\\mathbf{M}^{(k+1)} = \\mathbf{0}$.\n4.  Otherwise, calculate the next magnetization estimate using the constitutive law:\n    $$\n    \\mathbf{M}^{(k+1)} = M_s \\tanh\\left(\\alpha \\|\\mathbf{H}_{\\text{loc}}^{(k)}\\|\\right) \\frac{\\mathbf{H}_{\\text{loc}}^{(k)}}{\\|\\mathbf{H}_{\\text{loc}}^{(k)}\\|}\n    $$\nThe iteration continues until the change between successive iterates is smaller than a specified tolerance $\\varepsilon$, i.e., $\\|\\mathbf{M}^{(k+1)} - \\mathbf{M}^{(k)}\\| < \\varepsilon$. A maximum number of iterations, $k_{\\max}$, is imposed to prevent infinite loops in non-convergent cases.\n\n**3. Simplification Due to Symmetry**\n\nIn all specified test cases, the external field $\\mathbf{H}_{\\text{ext}} = (0, 0, H_{ext,z})$ is aligned with the $z$-axis, and the demagnetization tensor $\\mathbf{N}$ is diagonal. Furthermore, the initial guesses $\\mathbf{M}^{(0)}$ are also aligned with the $z$-axis. Consequently, all subsequent iterates for $\\mathbf{M}$ must also be aligned with the $z$-axis.\nLet $\\mathbf{M}^{(k)} = (0, 0, M_z^{(k)})$. Then:\n$$\n\\mathbf{H}_{\\text{loc}}^{(k)} = (0, 0, H_{ext,z}) - \\begin{pmatrix} N_{xx} & 0 & 0 \\\\ 0 & N_{yy} & 0 \\\\ 0 & 0 & N_{zz} \\end{pmatrix} \\begin{pmatrix} 0 \\\\ 0 \\\\ M_z^{(k)} \\end{pmatrix} = (0, 0, H_{ext,z} - N_{zz}M_z^{(k)})\n$$\nThe problem reduces from a 3D vector iteration to a 1D scalar iteration for the $z$-component of magnetization, $M_z$:\n$$\nM_z^{(k+1)} = M_s \\tanh\\left(\\frac{\\chi_0}{M_s} |H_{ext,z} - N_{zz}M_z^{(k)}|\\right) \\cdot \\mathrm{sgn}(H_{ext,z} - N_{zz}M_z^{(k)})\n$$\nUsing the property $\\tanh(x) = \\mathrm{sgn}(x)\\tanh(|x|)$, this simplifies to:\n$$\nM_z^{(k+1)} = M_s \\tanh\\left(\\frac{\\chi_0}{M_s} (H_{ext,z} - N_{zz}M_z^{(k)})\\right)\n$$\nThis scalar fixed-point iteration is computationally more efficient. The implemented code will solve the full vector equation, which naturally yields the same result.\n\n**4. Calculation of the Magnetic Anomaly**\n\nOnce the converged magnetization $\\mathbf{M} = (0, 0, M_z)$ is found, the magnetic dipole moment of the ellipsoidal body is calculated as $\\mathbf{m} = V\\mathbf{M}$, where $V = \\frac{4}{3}\\pi R^3$ is the volume.\n$$\n\\mathbf{m} = \\left(0, 0, \\frac{4}{3}\\pi R^3 M_z\\right)\n$$\nThe magnetic induction anomaly at an observation point $\\mathbf{r}$ is given by the dipole field formula:\n$$\n\\Delta\\mathbf{B}(\\mathbf{r}) = \\mathbf{B}_{\\text{dip}}(\\mathbf{r}) = \\frac{\\mu_0}{4\\pi \\|\\mathbf{r}\\|^3} \\left[ 3(\\mathbf{m} \\cdot \\hat{\\mathbf{r}})\\hat{\\mathbf{r}} - \\mathbf{m} \\right]\n$$\nFor the specified observation point on the $z$-axis, $\\mathbf{r} = (0, 0, z_o)$, we have $\\|\\mathbf{r}\\| = z_o$ and $\\hat{\\mathbf{r}} = (0, 0, 1)$. The dot product is $\\mathbf{m} \\cdot \\hat{\\mathbf{r}} = m_z = \\frac{4}{3}\\pi R^3 M_z$. Substituting into the formula:\n$$\n\\Delta\\mathbf{B}(0,0,z_o) = \\frac{\\mu_0}{4\\pi z_o^3} \\left[ 3\\left(\\frac{4}{3}\\pi R^3 M_z\\right)(0, 0, 1) - \\left(0, 0, \\frac{4}{3}\\pi R^3 M_z\\right) \\right]\n$$\n$$\n\\Delta\\mathbf{B}(0,0,z_o) = \\frac{\\mu_0}{4\\pi z_o^3} \\left[ 2 \\left(\\frac{4}{3}\\pi R^3 M_z\\right) (0, 0, 1) \\right]\n$$\nThe vertical component of the anomaly, $\\Delta B_z$, is therefore:\n$$\n\\Delta B_z = \\frac{2 \\mu_0 (\\frac{4}{3}\\pi R^3 M_z)}{4\\pi z_o^3} = \\frac{2 \\mu_0 R^3 M_z}{3 z_o^3}\n$$\n\n**5. Algorithm Implementation**\n\nThe algorithm proceeds as follows for each test case:\n1.  Initialize constants: $\\mu_0 = 4\\pi \\times 10^{-7}\\,\\mathrm{N/A^2}$, $R=50\\,\\mathrm{m}$, $V=\\frac{4}{3}\\pi R^3$, $z_o=100\\,\\mathrm{m}$, $\\mathbf{H}_{\\text{ext}}=(0,0,40)\\,\\mathrm{A/m}$, $M_s=480000\\,\\mathrm{A/m}$, $\\chi_0=1.0$, $\\alpha = \\chi_0/M_s$, $\\varepsilon=10^{-10}\\,\\mathrm{A/m}$, $k_{\\max}=10000$.\n2.  Set the demagnetization tensor $\\mathbf{N}$ and initial guess $\\mathbf{M}^{(0)}$ for the specific case.\n3.  Perform the fixed-point iteration for $k = 0, 1, \\dots, k_{\\max}-1$:\n    a.  Compute $\\mathbf{H}_{\\text{loc}}^{(k)} = \\mathbf{H}_{\\text{ext}} - \\mathbf{N}\\mathbf{M}^{(k)}$.\n    b.  Compute $\\mathbf{M}^{(k+1)}$ using the nonlinear law.\n    c.  Check for convergence: if $\\|\\mathbf{M}^{(k+1)} - \\mathbf{M}^{(k)}\\| < \\varepsilon$, exit the loop.\n    d.  Update $\\mathbf{M}^{(k)} \\leftarrow \\mathbf{M}^{(k+1)}$.\n4.  Using the converged magnetization, $M_z$, calculate the vertical magnetic anomaly $\\Delta B_z = \\frac{2 \\mu_0 R^3 M_z}{3 z_o^3}$.\n5.  Convert the result from Tesla to nanotesla ($\\mathrm{nT}$) by multiplying by $10^9$.\n6.  Round the final value to 6 decimal places and store it.\n7.  Repeat for all test cases and format the output as a comma-separated list.\n\nThe four cases test the influence of body shape (through $\\mathbf{N}$) and the robustness of the iteration with respect to the initial guess. For the given physical parameters and diagonal $\\mathbf{N}$ tensor with eigenvalues in $[0,1]$, the fixed-point iteration is a contraction mapping, guaranteeing convergence to a unique fixed point regardless of the initial guess. Thus, Case 1 and Case 4 are expected to yield identical results.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the magnetic anomaly for a nonlinear, magnetizable ellipsoidal body.\n\n    This function performs forward modeling by:\n    1. Solving for the self-consistent magnetization using a fixed-point iteration.\n    2. Calculating the magnetic anomaly at a specified point using the dipole approximation.\n    \"\"\"\n\n    # --- Scientific and numerical specifications ---\n    MU0 = 4 * np.pi * 1e-7  # Magnetic permeability of free space (N/A^2)\n    R = 50.0  # Equivalent-radius of the ellipsoidal body (m)\n    V = (4.0 / 3.0) * np.pi * R**3  # Volume of the body (m^3)\n    H_EXT = np.array([0.0, 0.0, 40.0])  # External magnetic field (A/m)\n    MS = 480000.0  # Saturation magnetization (A/m)\n    CHI0 = 1.0  # Low-field susceptibility (dimensionless)\n    ALPHA = CHI0 / MS  # Parameter in the constitutive law\n    Z_O = 100.0  # Observation height on the z-axis (m)\n    \n    # --- Iteration parameters ---\n    EPSILON = 1e-10  # Convergence tolerance (A/m)\n    K_MAX = 10000  # Maximum number of iterations\n\n    # --- Test case definitions ---\n    test_cases = [\n        {\n            \"name\": \"Case 1: Sphere, neutral guess\",\n            \"N\": np.diag([1.0/3.0, 1.0/3.0, 1.0/3.0]),\n            \"M0\": np.array([0.0, 0.0, 0.0])\n        },\n        {\n            \"name\": \"Case 2: Oblate-like, neutral guess\",\n            \"N\": np.diag([0.495, 0.495, 0.01]),\n            \"M0\": np.array([0.0, 0.0, 0.0])\n        },\n        {\n            \"name\": \"Case 3: Prolate-like, neutral guess\",\n            \"N\": np.diag([0.499, 0.499, 0.002]),\n            \"M0\": np.array([0.0, 0.0, 0.0])\n        },\n        {\n            \"name\": \"Case 4: Sphere, adverse guess\",\n            \"N\": np.diag([1.0/3.0, 1.0/3.0, 1.0/3.0]),\n            \"M0\": np.array([0.0, 0.0, -480000.0])\n        }\n    ]\n\n    results = []\n\n    for case in test_cases:\n        N = case[\"N\"]\n        M = case[\"M0\"].copy()\n\n        for _ in range(K_MAX):\n            H_loc = H_EXT - N @ M\n            norm_H_loc = np.linalg.norm(H_loc)\n\n            if norm_H_loc == 0.0:\n                M_next = np.zeros_like(M)\n            else:\n                H_loc_hat = H_loc / norm_H_loc\n                M_next = MS * np.tanh(ALPHA * norm_H_loc) * H_loc_hat\n\n            if np.linalg.norm(M_next - M)  EPSILON:\n                M = M_next\n                break\n            \n            M = M_next\n        \n        # After convergence, M holds the self-consistent magnetization\n        Mz = M[2]\n\n        # Compute the vertical component of the dipole magnetic induction anomaly\n        # Formula: delta_Bz = (2 * MU0 * R^3 * Mz) / (3 * Z_O^3)\n        delta_Bz = (2.0 * MU0 * R**3 * Mz) / (3.0 * Z_O**3)\n        \n        # Convert from Tesla to nanotesla and round\n        delta_Bz_nT = delta_Bz * 1e9\n        \n        results.append(round(delta_Bz_nT, 6))\n\n    # Print the results in the specified format\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == '__main__':\n    solve()\n```", "id": "3597732"}, {"introduction": "While spatial-domain summation is intuitive, frequency-domain methods using the Fast Fourier Transform (FFT) provide a powerful and computationally efficient alternative for modeling on regular grids. This exercise delves into the spectral method by having you implement the upward continuation operator to predict the magnetic anomaly at altitude. This task will also force you to confront and quantify a critical numerical artifact—aliasing—and derive a physically-motivated sampling criterion to ensure the accuracy of your simulations [@problem_id:3597756].", "problem": "A two-dimensional forward modeling experiment is set up to quantify aliasing in spectral simulations of magnetic anomalies after upward continuation. Consider a square domain of side length $L$ in meters with periodic boundary conditions. A synthetic magnetization field $M(x,y)$ is specified as a superposition of plane waves with frequencies given in cycles per meter. The observation height is $z$ in meters above the magnetized sheet at $z=0$. You will implement spectral forward modeling to compute the vertical magnetic anomaly field $B_z(x,y;z)$ from $M(x,y)$ using the Discrete Fourier Transform (DFT) and the physically derived upward continuation operator. Then, by comparing two computational pipelines, you will measure the leakage induced by aliasing when $M(x,y)$ is sampled on coarse grids before upward continuation. Finally, you will propose and evaluate an oversampling criterion that limits aliasing to a prescribed tolerance.\n\nFundamental base to use:\n- Magnetostatics: In a source-free region above a planar layer, the magnetic scalar potential $\\Phi$ satisfies Laplace’s equation $\\nabla^2 \\Phi = 0$ and thus has exponentially decaying Fourier modes with height. The vertical magnetic anomaly $B_z$ relates to $\\Phi$ via $B_z = -\\mu_0 \\partial \\Phi/\\partial z$, where $\\mu_0$ is the permeability of free space.\n- Sampling and aliasing: Sampling a continuous field on a spatial grid of spacing $\\Delta x$ and $\\Delta y$ induces periodic replication of its spectrum with period equal to the sampling frequency, causing high-frequency components to fold into the baseband when their spectral support exceeds the Nyquist limit. Upward continuation acts as a low-pass filter for harmonic fields.\n- Discrete Fourier Transform (DFT) implementation: Use the Fast Fourier Transform (FFT) to approximate continuous spectral operations on uniform grids.\n\nYou must not assume shortcut formulas. Instead, derive the spectral upward continuation operator $T(\\mathbf{f},z)$ from Laplace’s equation and use it in your algorithm. Use the Fourier frequencies in cycles per meter. All variables, symbols, and numbers must be written in LaTeX. All length quantities must be treated in meters. Angles are not used in this problem.\n\nAlgorithmic tasks to implement:\n- Construct $M(x,y)$ on a fine grid that resolves all prescribed frequencies without aliasing, and on specified coarse grids that do not. Use periodic boundary conditions and the DFT. Define the domain as $[0,L)$ in both $x$ and $y$.\n- Derive and implement the spectral upward continuation operator $T(\\mathbf{f},z)$ appropriate for the vertical magnetic anomaly $B_z$ in terms of the Fourier magnitude $|\\mathbf{f}|$ in cycles per meter and height $z$ in meters. Apply $T(\\mathbf{f},z)$ to the DFT of $M(x,y)$ to compute $B_z(x,y;z)$.\n- Compute a reference “truth” by applying upward continuation on the fine grid, then decimate to the coarse grid. Compute a “coarse-first” result by sampling $M(x,y)$ on the coarse grid, then applying upward continuation on that coarse grid. Quantify leakage as the ratio of the $\\ell_2$ norm of the difference between the coarse-first result and the decimated truth to the $\\ell_2$ norm of the decimated truth. This leakage is dimensionless and must be reported as a float.\n- Propose an oversampling criterion, derived from the exponential attenuation of upward continuation, that ensures the residual spectral content beyond the coarse Nyquist is bounded by a tolerance $\\varepsilon$. Express the resulting recommended maximum coarse grid spacing $\\Delta x_{\\max}$ in meters as a float, based on your derivation. Evaluate whether the test coarse grid spacing $\\Delta x$ satisfies the criterion, reported as a boolean.\n\nSynthetic magnetization:\n- Use $M(x,y) = \\cos(2\\pi f_1 x) + 0.5\\,\\cos(2\\pi f_2 y) + 0.8\\,\\cos(2\\pi (u x + v y))$ with $f_1$, $f_2$, $u$, $v$ in cycles per meter.\n\nSpectral forward modeling details:\n- Use two-dimensional DFT on uniform grids. Use the Fourier frequency arrays returned by the DFT frequency function with units of cycles per meter, and treat the domain as periodic.\n- Observation height $z$ is in meters.\n- The final leakage metric is computed in the spatial domain on the coarse grid after upward continuation is applied in the spectral domain.\n\nUnits:\n- Lengths (including $L$, $z$, $\\Delta x$, and $\\Delta y$) must be in meters.\n- Frequencies must be in cycles per meter.\n- Report $\\Delta x_{\\max}$ in meters.\n\nTest suite:\n- Domain size: $L = 1000$ meters for all tests.\n- Fine grid: $N_{\\text{fine}} = 512$ samples per axis for all tests; this resolves the synthetic $M(x,y)$ without aliasing.\n- Magnetization frequencies: $f_1 = 0.030$ cycles/meter, $f_2 = 0.045$ cycles/meter, $u = 0.040$ cycles/meter, $v = 0.015$ cycles/meter for all tests.\n- Tolerance: $\\varepsilon = 0.01$ for all tests.\n- Test cases:\n  $1.$ Coarse grid $N_{\\text{coarse}} = 64$ per axis, observation height $z = 50$ meters.\n  $2.$ Coarse grid $N_{\\text{coarse}} = 64$ per axis, observation height $z = 200$ meters.\n  $3.$ Coarse grid $N_{\\text{coarse}} = 32$ per axis, observation height $z = 50$ meters.\n\nOutput specification:\n- For each test case, produce a list with three entries: $[\\ell, \\Delta x_{\\max}, \\text{criterion\\_satisfied}]$, where $\\ell$ is the leakage ratio (float), $\\Delta x_{\\max}$ is the recommended maximum coarse grid spacing (float, in meters), and $\\text{criterion\\_satisfied}$ is a boolean indicating whether the test coarse grid spacing meets the criterion.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, for example, $[[\\ell_1,\\Delta x_{\\max,1},b_1],[\\ell_2,\\Delta x_{\\max,2},b_2],[\\ell_3,\\Delta x_{\\max,3},b_3]]$.", "solution": "The problem statement is deemed valid. It is scientifically grounded in the principles of magnetostatics and Fourier analysis, well-posed with a complete set of parameters, and presented objectively. A rigorous solution can be constructed based on the provided information.\n\n### Part 1: Derivation of the Spectral Upward Continuation Operator\n\nThe objective is to find the operator `$T(\\mathbf{f}, z)$` that maps the Fourier transform of the surface magnetization `$M(x,y)$` to the Fourier transform of the vertical magnetic anomaly `$B_z(x,y,z)$` at height `$z$`. The derivation proceeds from the fundamental principles provided.\n\n$1$. The magnetic scalar potential `$\\Phi$` in the source-free region `$z0$` satisfies Laplace's equation:\n$$ \\nabla^2 \\Phi(x,y,z) = \\left( \\frac{\\partial^2}{\\partial x^2} + \\frac{\\partial^2}{\\partial y^2} + \\frac{\\partial^2}{\\partial z^2} \\right) \\Phi = 0 $$\nLet `$\\hat{\\Phi}(\\mathbf{f},z)$` be the two-dimensional Fourier transform of `$\\Phi(x,y,z)$` with respect to `$x$` and `$y$`, where `$\\mathbf{f}=(f_x, f_y)$` is the frequency vector in cycles per meter. The Fourier transform of the partial derivatives with respect to `$x$` and `$y$` are `$(i 2\\pi f_x)^2$` and `$(i 2\\pi f_y)^2$`, respectively. Applying the transform to Laplace's equation yields an ordinary differential equation in `$z$`:\n$$ \\left( -(2\\pi f_x)^2 - (2\\pi f_y)^2 + \\frac{d^2}{dz^2} \\right) \\hat{\\Phi}(\\mathbf{f},z) = 0 $$\n$$ \\frac{d^2 \\hat{\\Phi}}{dz^2} - (2\\pi)^2 (f_x^2 + f_y^2) \\hat{\\Phi} = 0 $$\n$$ \\frac{d^2 \\hat{\\Phi}}{dz^2} - (2\\pi |\\mathbf{f}|)^2 \\hat{\\Phi} = 0 $$\nwhere `$|\\mathbf{f}| = \\sqrt{f_x^2 + f_y^2}$` is the magnitude of the frequency vector.\n\n$2$. The general solution to this second-order ODE is:\n$$ \\hat{\\Phi}(\\mathbf{f},z) = A(\\mathbf{f}) e^{2\\pi |\\mathbf{f}| z} + B(\\mathbf{f}) e^{-2\\pi |\\mathbf{f}| z} $$\nFor the potential to remain physically bounded as `$z \\to \\infty$`, the coefficient `$A(\\mathbf{f})$` of the exponentially growing term must be zero. This leaves:\n$$ \\hat{\\Phi}(\\mathbf{f},z) = B(\\mathbf{f}) e^{-2\\pi |\\mathbf{f}| z} $$\nAt `$z=0$`, we have `$\\hat{\\Phi}(\\mathbf{f},0) = B(\\mathbf{f})$`. Therefore, the solution is:\n$$ \\hat{\\Phi}(\\mathbf{f},z) = \\hat{\\Phi}(\\mathbf{f},0) e^{-2\\pi |\\mathbf{f}| z} $$\nThis equation describes the upward continuation of the magnetic potential. The term `$e^{-2\\pi |\\mathbf{f}| z}$` is a low-pass filter, attenuating higher frequencies more strongly with increasing height `$z$`.\n\n$3$. The vertical magnetic anomaly `$B_z$` is related to the potential by `$B_z = -\\mu_0 \\frac{\\partial \\Phi}{\\partial z}$`. Taking the Fourier transform:\n$$ \\hat{B}_z(\\mathbf{f},z) = -\\mu_0 \\frac{\\partial}{\\partial z} \\hat{\\Phi}(\\mathbf{f},z) $$\nSubstituting the expression for `$\\hat{\\Phi}(\\mathbf{f},z)`:\n$$ \\hat{B}_z(\\mathbf{f},z) = -\\mu_0 \\frac{\\partial}{\\partial z} \\left( \\hat{\\Phi}(\\mathbf{f},0) e^{-2\\pi |\\mathbf{f}| z} \\right) = -\\mu_0 \\hat{\\Phi}(\\mathbf{f},0) \\left( -2\\pi |\\mathbf{f}| \\right) e^{-2\\pi |\\mathbf{f}| z} $$\n$$ \\hat{B}_z(\\mathbf{f},z) = 2\\pi \\mu_0 |\\mathbf{f}| \\hat{\\Phi}(\\mathbf{f},0) e^{-2\\pi |\\mathbf{f}| z} $$\n\n$4$. The final step is to relate `$\\hat{\\Phi}(\\mathbf{f},0)$` to the Fourier transform of the magnetization, `$\\hat{M}(\\mathbf{f})$`. The problem does not specify this relationship, which depends on the precise physics of the source layer (e.g., vertical dipoles, induced magnetization). A common and simple assumption in this context is direct proportionality, `$\\hat{\\Phi}(\\mathbf{f},0) \\propto \\hat{M}(\\mathbf{f})$`. This implies that the magnetization field `$M(x,y)$` acts as a direct source for the potential `$\\Phi(x,y,0)$` on the plane. Under this assumption, we can write:\n$$ \\hat{B}_z(\\mathbf{f},z) = C \\cdot \\left( 2\\pi |\\mathbf{f}| e^{-2\\pi |\\mathbf{f}| z} \\right) \\hat{M}(\\mathbf{f}) $$\nwhere `$C$` is a constant incorporating `$\\mu_0$` and the proportionality factor. Since the final leakage metric is a ratio, this constant will cancel. We can therefore define the spectral forward operator as:\n$$ T(\\mathbf{f}, z) = 2\\pi |\\mathbf{f}| e^{-2\\pi |\\mathbf{f}| z} $$\nFor the DC component (`$|\\mathbf{f}|=0$`), `$T(0,z)=0$`, which correctly states that a uniform sheet of magnetization produces no external magnetic anomaly.\n\n### Part 2: Derivation of the Oversampling Criterion\n\nThe goal is to propose a criterion on the coarse grid spacing `$\\Delta x$` that keeps aliasing effects below a tolerance `$\\varepsilon$`. Aliasing occurs when sampling a signal at a rate below twice its highest frequency. The upward continuation operator naturally attenuates high frequencies, which can mitigate aliasing. We can formalize this into a criterion.\n\n$1$. The spectral support of a signal sampled on a grid with spacing `$\\Delta x$` is limited to the Nyquist frequency, `$f_{Ny} = 1/(2\\Delta x)$`. Any signal content at frequencies `$|f|  f_{Ny}$` will be aliased (folded) into the baseband `$[-f_{Ny}, f_{Ny}]$`.\n\n$2$. The upward continuation operator provides attenuation via the term `$e^{-2\\pi |\\mathbf{f}| z}`. A reasonable criterion is to require that the filter's attenuation at the Nyquist boundary `$f_{Ny}$` is at least as strong as the tolerance `$\\varepsilon$`. This ensures that any spectral content at or beyond the Nyquist frequency is suppressed to a level below `$\\varepsilon$`.\n\n$3$. We formalize this condition as:\n$$ e^{-2\\pi f_{Ny} z} \\le \\varepsilon $$\nThis focuses on the primary attenuation factor derived from Laplace's equation.\n\n$4$. We solve for `$f_{Ny}$` to find the minimum required Nyquist frequency:\n$$ -2\\pi f_{Ny} z \\le \\ln(\\varepsilon) $$\n$$ 2\\pi f_{Ny} z \\ge -\\ln(\\varepsilon) = \\ln(1/\\varepsilon) $$\n$$ f_{Ny} \\ge \\frac{\\ln(1/\\varepsilon)}{2\\pi z} $$\n\n$5$. Substituting `$f_{Ny} = 1/(2\\Delta x)$`, where `$\\Delta x$` is the coarse grid spacing, we can solve for the maximum allowable spacing, `$\\Delta x_{\\max}$`:\n$$ \\frac{1}{2\\Delta x} \\ge \\frac{\\ln(1/\\varepsilon)}{2\\pi z} $$\n$$ \\Delta x \\le \\frac{2\\pi z}{2\\ln(1/\\varepsilon)} = \\frac{\\pi z}{\\ln(1/\\varepsilon)} $$\nThus, the recommended maximum coarse grid spacing is:\n$$ \\Delta x_{\\max} = \\frac{\\pi z}{\\ln(1/\\varepsilon)} $$\nThe test `$\\Delta x_{\\text{coarse}}$` satisfies this criterion if `$\\Delta x_{\\text{coarse}} \\le \\Delta x_{\\max}`. This criterion correctly shows that a larger observation height `$z$` permits a larger (coarser) grid spacing `$\\Delta x$`, as the field is naturally smoother at greater distances from the source.\n\n### Part 3: Algorithmic Implementation\n\nThe algorithm proceeds by implementing two computational paths for each test case and comparing the results.\n\n1.  **Reference (\"Truth\") Path:**\n    a.  Define a fine grid `$N_{\\text{fine}} \\times N_{\\text{fine}}$` with spacing `$\\Delta x_{\\text{fine}} = L/N_{\\text{fine}}$`.\n    b.  Construct the magnetization field `$M_{\\text{fine}}(x,y)$` on this grid.\n    c.  Compute its 2D DFT, `$\\hat{M}_{\\text{fine}}(\\mathbf{f})$`.\n    d.  Apply the derived spectral operator `$T(\\mathbf{f}_{\\text{fine}}, z)$` to get `$\\hat{B}_{z,\\text{fine}} = \\hat{M}_{\\text{fine}} \\cdot T(\\mathbf{f}_{\\text{fine}}, z)$`.\n    e.  Compute the inverse 2D DFT to obtain the spatial field `$B_{z,\\text{fine}}(x,y)$`.\n    f.  Decimate `$B_{z,\\text{fine}}(x,y)$` to the coarse grid size by taking every `$R = N_{\\text{fine}}/N_{\\text{coarse}}$` sample. This result is `$B_{z,\\text{truth}}$`. This simulates perfect low-pass filtering before sampling.\n\n2.  **Coarse-First Path:**\n    a.  Define a coarse grid `$N_{\\text{coarse}} \\times N_{\\text{coarse}}$` with spacing `$\\Delta x_{\\text{coarse}} = L/N_{\\text{coarse}}$`.\n    b.  Construct the magnetization field `$M_{\\text{coarse}}(x,y)$` on this coarse grid (sampling the continuous function). This step introduces aliasing if `$\\Delta x_{\\text{coarse}}$` is too large.\n    c.  Compute its 2D DFT, `$\\hat{M}_{\\text{coarse}}(\\mathbf{f})$`.\n    d.  Apply the spectral operator `$T(\\mathbf{f}_{\\text{coarse}}, z)$` to get `$\\hat{B}_{z,\\text{coarse}} = \\hat{M}_{\\text{coarse}} \\cdot T(\\mathbf{f}_{\\text{coarse}}, z)$`.\n    e.  Compute the inverse 2D DFT to obtain the spatial field `$B_{z,\\text{coarse}}(x,y)$`.\n\n3.  **Analysis:**\n    a.  Calculate the leakage ratio `$\\ell = \\frac{\\|B_{z,\\text{coarse}} - B_{z,\\text{truth}}\\|_2}{\\|B_{z,\\text{truth}}\\|_2}$`, where `$\\|\\cdot\\|_2$` is the Euclidean (`$\\ell_2$`) norm.\n    b.  Calculate `$\\Delta x_{\\max}$` using the derived formula.\n    c.  Determine if the criterion is satisfied: `$\\Delta x_{\\text{coarse}} \\le \\Delta x_{\\max}`.\n    d.  Report the tuple `$[\\ell, \\Delta x_{\\max}, \\text{criterion\\_satisfied}]$`.\nThis procedure is repeated for each test case.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the computational geophysics problem on aliasing in magnetic forward modeling.\n    \"\"\"\n    \n    # Global parameters from the problem statement\n    L = 1000.0  # Domain size in meters\n    N_fine = 512  # Fine grid samples per axis\n    \n    # Magnetization frequencies in cycles/meter\n    f1 = 0.030\n    f2 = 0.045\n    u = 0.040\n    v = 0.015\n    \n    # Tolerance for oversampling criterion\n    epsilon = 0.01\n\n    test_cases = [\n        # (N_coarse, z_height)\n        (64, 50.0),\n        (64, 200.0),\n        (32, 50.0),\n    ]\n\n    results = []\n\n    for N_coarse, z in test_cases:\n        # --- 1. Grid and Frequency Setup ---\n        \n        # Fine Grid\n        dx_fine = L / N_fine\n        x_fine_1d = np.arange(N_fine) * dx_fine\n        y_fine_1d = np.arange(N_fine) * dx_fine\n        x_fine, y_fine = np.meshgrid(x_fine_1d, y_fine_1d, indexing='xy')\n        \n        fx_fine_1d = np.fft.fftfreq(N_fine, d=dx_fine)\n        fy_fine_1d = np.fft.fftfreq(N_fine, d=dx_fine)\n        fx_fine, fy_fine = np.meshgrid(fx_fine_1d, fy_fine_1d, indexing='xy')\n        f_mag_fine = np.sqrt(fx_fine**2 + fy_fine**2)\n\n        # Coarse Grid\n        dx_coarse = L / N_coarse\n        x_coarse_1d = np.arange(N_coarse) * dx_coarse\n        y_coarse_1d = np.arange(N_coarse) * dx_coarse\n        x_coarse, y_coarse = np.meshgrid(x_coarse_1d, y_coarse_1d, indexing='xy')\n\n        fx_coarse_1d = np.fft.fftfreq(N_coarse, d=dx_coarse)\n        fy_coarse_1d = np.fft.fftfreq(N_coarse, d=dx_coarse)\n        fx_coarse, fy_coarse = np.meshgrid(fx_coarse_1d, fy_coarse_1d, indexing='xy')\n        f_mag_coarse = np.sqrt(fx_coarse**2 + fy_coarse**2)\n\n        # --- 2. Synthetic Magnetization ---\n        def magnetization(x, y):\n            term1 = np.cos(2 * np.pi * f1 * x)\n            term2 = 0.5 * np.cos(2 * np.pi * f2 * y)\n            term3 = 0.8 * np.cos(2 * np.pi * (u * x + v * y))\n            return term1 + term2 + term3\n\n        # --- 3. Spectral Upward Continuation Operator ---\n        def get_operator(f_mag, z_height):\n            # T(f, z) = 2 * pi * |f| * exp(-2 * pi * |f| * z)\n            # Handle f=0 case to avoid 0 * inf -> nan\n            op = np.zeros_like(f_mag)\n            non_zero_f = f_mag > 0\n            op[non_zero_f] = (2 * np.pi * f_mag[non_zero_f] * \n                              np.exp(-2 * np.pi * f_mag[non_zero_f] * z_height))\n            return op\n\n        # --- 4. Compute \"Truth\" Result ---\n        # a. Create magnetization on fine grid\n        M_fine = magnetization(x_fine, y_fine)\n        \n        # b. FFT\n        M_hat_fine = np.fft.fft2(M_fine)\n        \n        # c. Apply upward continuation operator in spectral domain\n        T_fine = get_operator(f_mag_fine, z)\n        Bz_hat_fine = M_hat_fine * T_fine\n        \n        # d. IFFT to get spatial domain result\n        Bz_fine = np.fft.ifft2(Bz_hat_fine).real\n        \n        # e. Decimate to coarse grid size to get the 'truth'\n        R = N_fine // N_coarse\n        Bz_truth = Bz_fine[::R, ::R]\n\n        # --- 5. Compute \"Coarse-First\" Result ---\n        # a. Create magnetization on coarse grid (introduces aliasing)\n        M_coarse = magnetization(x_coarse, y_coarse)\n\n        # b. FFT\n        M_hat_coarse = np.fft.fft2(M_coarse)\n\n        # c. Apply upward continuation operator on coarse grid\n        T_coarse = get_operator(f_mag_coarse, z)\n        Bz_hat_coarse = M_hat_coarse * T_coarse\n\n        # d. IFFT\n        Bz_coarse = np.fft.ifft2(Bz_hat_coarse).real\n\n        # --- 6. Quantify Leakage ---\n        diff_norm = np.linalg.norm(Bz_coarse - Bz_truth)\n        truth_norm = np.linalg.norm(Bz_truth)\n        \n        leakage = diff_norm / truth_norm if truth_norm > 0 else 0.0\n\n        # --- 7. Evaluate Oversampling Criterion ---\n        # dx_max = (pi * z) / ln(1/epsilon)\n        dx_max = (np.pi * z) / np.log(1.0 / epsilon)\n        \n        # Check if the actual coarse grid spacing satisfies the criterion\n        criterion_satisfied = dx_coarse = dx_max\n\n        # --- 8. Store Results ---\n        results.append([leakage, dx_max, criterion_satisfied])\n\n    # Format output as specified in the problem statement\n    # Example: [[l_1,dx_max_1,b_1],[l_2,dx_max_2,b_2],[l_3,dx_max_3,b_3]]\n    output_str = \"[\" + \",\".join([f\"[{l},{dxm},{b}]\".lower() for l, dxm, b in results]) + \"]\"\n    print(output_str)\n\nsolve()\n```", "id": "3597756"}]}