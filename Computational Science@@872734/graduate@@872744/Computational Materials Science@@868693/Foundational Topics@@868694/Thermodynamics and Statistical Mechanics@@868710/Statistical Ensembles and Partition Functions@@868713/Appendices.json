{"hands_on_practices": [{"introduction": "The partition function $Z = \\sum_{i} g_{i} \\exp(-\\beta E_{i})$ is the cornerstone of statistical mechanics, but its direct computation is fraught with numerical peril. The exponential terms can easily exceed the limits of floating-point numbers, leading to overflow, or vanish into numerical zero, causing underflow. This practice [@problem_id:3260986] guides you through a fundamental stabilization technique: factoring out the ground-state energy to keep all terms in the sum well-behaved. This skill is not merely a theoretical curiosity; it is a critical first step in robustly implementing any computational model based on statistical ensembles.", "problem": "In the canonical ensemble of statistical mechanics, the partition function is defined by $Z = \\sum_{i} g_{i} \\exp\\!\\big(-E_{i}/(k_{\\mathrm{B}} T)\\big)$, where $g_{i}$ is the degeneracy of level $i$, $E_{i}$ is its energy, $T$ is the absolute temperature, and $k_{\\mathrm{B}}$ is the Boltzmann constant ($k_{\\mathrm{B}}$). In finite-precision floating-point arithmetic, direct evaluation of the sum can suffer from overflow or underflow when some $\\exp\\!\\big(-E_{i}/(k_{\\mathrm{B}} T)\\big)$ are extremely large or small in magnitude.\n\nStarting from the definition of $Z$ and basic properties of the exponential function, derive a reformulation of $Z$ obtained by factoring out the ground-state energy $E_{0}$ so that the remaining sum is composed of terms that are at most of order unity in magnitude. Explain why this reformulation alleviates overflow and underflow when computing $\\ln Z$.\n\nThen apply your reformulation to a three-level system at temperature $T$ with degeneracies and energies specified in the following dimensionless form, using $\\beta \\equiv 1/(k_{\\mathrm{B}} T)$:\n- $\\beta E_{0} = -1000$, $g_{0} = 1$,\n- $\\beta E_{1} = \\beta E_{0} + 500 \\ln 10$, $g_{1} = 10^{500}$,\n- $\\beta E_{2} = \\beta E_{0} + 1200 \\ln 10$, $g_{2} = 10^{900}$.\n\nCompute $\\ln Z$ for this system using your stabilized expression. Round your final numerical result for $\\ln Z$ to $6$ significant figures. The answer is dimensionless; report only the number.", "solution": "The problem statement is scientifically grounded, well-posed, and requires the application of a standard numerical stabilization technique. Thus, a solution will be provided.\n\nThe canonical partition function $Z$ is given by\n$$\nZ = \\sum_{i} g_{i} \\exp\\left(-\\frac{E_{i}}{k_{\\mathrm{B}} T}\\right)\n$$\nUsing the definition $\\beta \\equiv 1/(k_{\\mathrm{B}} T)$, this becomes\n$$\nZ = \\sum_{i} g_{i} \\exp(-\\beta E_{i})\n$$\n\n**Part 1: Reformulation of Z**\n\nTo stabilize the calculation, we identify the ground-state energy $E_{0}$, which is the minimum energy in the system ($E_{0} \\le E_{i}$ for all $i$). We can factor out the term corresponding to this energy from the sum. We rewrite the exponent by adding and subtracting $E_0$:\n$$\n-\\beta E_{i} = -\\beta (E_{i} - E_{0} + E_{0}) = -\\beta(E_{i} - E_{0}) - \\beta E_{0}\n$$\nSubstituting this into the expression for $Z$:\n$$\nZ = \\sum_{i} g_{i} \\exp\\big(-\\beta(E_{i} - E_{0}) - \\beta E_{0}\\big)\n$$\nUsing the property of the exponential function, $\\exp(a+b) = \\exp(a)\\exp(b)$, we can separate the terms:\n$$\nZ = \\sum_{i} g_{i} \\exp\\big(-\\beta(E_{i} - E_{0})\\big) \\exp(-\\beta E_{0})\n$$\nSince the term $\\exp(-\\beta E_{0})$ is a common factor for every term in the summation over the index $i$, it can be factored out of the sum:\n$$\nZ = \\exp(-\\beta E_{0}) \\sum_{i} g_{i} \\exp\\big(-\\beta(E_{i} - E_{0})\\big)\n$$\nThis is the desired reformulation of the partition function. Let $\\Delta E_{i} = E_{i} - E_{0}$ be the energy of state $i$ relative to the ground state. Then the expression is:\n$$\nZ = \\exp(-\\beta E_{0}) \\sum_{i} g_{i} \\exp(-\\beta \\Delta E_{i})\n$$\n\n**Part 2: Alleviation of Overflow and Underflow in computing $\\ln Z$**\n\nTo compute $\\ln Z$, we take the natural logarithm of the reformulated expression:\n$$\n\\ln Z = \\ln \\left( \\exp(-\\beta E_{0}) \\sum_{i} g_{i} \\exp\\big(-\\beta(E_{i} - E_{0})\\big) \\right)\n$$\nUsing the property $\\ln(ab) = \\ln(a) + \\ln(b)$:\n$$\n\\ln Z = \\ln\\big(\\exp(-\\beta E_{0})\\big) + \\ln\\left( \\sum_{i} g_{i} \\exp\\big(-\\beta(E_{i} - E_{0})\\big) \\right)\n$$\n$$\n\\ln Z = -\\beta E_{0} + \\ln\\left( \\sum_{i} g_{i} \\exp\\big(-\\beta(E_{i} - E_{0})\\big) \\right)\n$$\nThis form avoids numerical overflow and underflow for the following reasons:\n1.  **Overflow Prevention**: The original expression for $Z$ involves terms like $\\exp(-\\beta E_i)$. If an energy level $E_i$ is highly negative, the argument $-\\beta E_i$ becomes a large positive number, causing $\\exp(-\\beta E_i)$ to overflow the limits of standard floating-point representations. In the reformulated expression, the arguments of the exponentials inside the sum are $-\\beta (E_{i} - E_{0})$. Since $E_{0}$ is the ground-state energy, we have $E_{i} \\ge E_{0}$ for all $i$, which implies $(E_{i} - E_{0}) \\ge 0$. Given that $\\beta = 1/(k_{\\mathrm{B}} T) > 0$, the argument is always non-positive: $-\\beta(E_{i} - E_{0}) \\le 0$. Consequently, the value of the exponential term $\\exp(-\\beta(E_i-E_0))$ is always in the range $(0, 1]$. This prevents any individual exponential term from overflowing.\n2.  **Underflow Prevention**: In the original expression, if all energies $E_i$ are large and positive, all terms $\\exp(-\\beta E_i)$ could be extremely small and underflow to $0$ in finite precision. This could lead to an incorrect calculation of $Z=0$ and $\\ln Z = -\\infty$. In the reformulated sum, the term for the ground state ($i=0$) is $g_{0} \\exp(-\\beta(E_{0} - E_{0})) = g_{0}\\exp(0) = g_{0}$. Since the degeneracy $g_0$ is typically a positive integer (in this problem, $g_0=1$), the sum is guaranteed to be at least $g_0$. This prevents the entire sum from underflowing to zero, ensuring a valid argument for the logarithm.\n\nThe technique transforms the numerically unstable task of computing the logarithm of a sum of exponentials (a \"log-sum-exp\" operation) into the sum of a large term ($-\\beta E_0$) and the logarithm of a well-behaved sum, thus ensuring numerical stability.\n\n**Part 3: Application to the Three-Level System**\n\nWe apply the stabilized formula for $\\ln Z$ to the given system:\n$$\n\\ln Z = -\\beta E_{0} + \\ln\\Big(g_{0} \\exp\\big(-\\beta(E_{0}-E_{0})\\big) + g_{1} \\exp\\big(-\\beta(E_{1}-E_{0})\\big) + g_{2} \\exp\\big(-\\beta(E_{2}-E_{0})\\big)\\Big)\n$$\nThe given values are:\n- $-\\beta E_{0} = 1000$\n- $g_{0} = 1$\n- $g_{1} = 10^{500}$ and $\\beta(E_{1} - E_{0}) = 500 \\ln 10$\n- $g_{2} = 10^{900}$ and $\\beta(E_{2} - E_{0}) = 1200 \\ln 10$\n\nLet's evaluate the terms inside the logarithm:\n- Term 0: $g_{0} \\exp(0) = 1 \\cdot 1 = 1$.\n- Term 1: $g_{1} \\exp(-\\beta(E_{1}-E_{0})) = 10^{500} \\exp(-500 \\ln 10)$. Using the identity $a \\exp(b \\ln c) = a \\exp(\\ln(c^b)) = a c^b$, we have:\n  $$\n  10^{500} \\exp(-500 \\ln 10) = 10^{500} \\exp\\big(\\ln(10^{-500})\\big) = 10^{500} \\cdot 10^{-500} = 10^{0} = 1\n  $$\n- Term 2: $g_{2} \\exp(-\\beta(E_{2}-E_{0})) = 10^{900} \\exp(-1200 \\ln 10)$. Similarly:\n  $$\n  10^{900} \\exp(-1200 \\ln 10) = 10^{900} \\exp\\big(\\ln(10^{-1200})\\big) = 10^{900} \\cdot 10^{-1200} = 10^{-300}\n  $$\n\nThe sum inside the logarithm is therefore:\n$$\n\\text{Sum} = 1 + 1 + 10^{-300} = 2 + 10^{-300}\n$$\nNow, we compute $\\ln Z$:\n$$\n\\ln Z = 1000 + \\ln(2 + 10^{-300})\n$$\nThe term $10^{-300}$ is an extremely small positive number. For any small $x$, the Taylor expansion of $\\ln(a+x)$ around $a$ is $\\ln(a) + x/a + O(x^2)$. Here, $a=2$ and $x=10^{-300}$.\n$$\n\\ln(2 + 10^{-300}) \\approx \\ln(2) + \\frac{10^{-300}}{2}\n$$\nThe value of $\\ln(2)$ is approximately $0.69314718$. The correction term $0.5 \\times 10^{-300}$ is far smaller than the precision required for the final answer. Therefore, for the purpose of rounding to $6$ significant figures, we can approximate $\\ln(2 + 10^{-300})$ as $\\ln(2)$.\n$$\n\\ln Z \\approx 1000 + \\ln(2) \\approx 1000 + 0.6931471805... = 1000.6931471805...\n$$\nThe problem requires rounding the final result to $6$ significant figures. The first six significant digits of $1000.693147...$ are $1, 0, 0, 0, 6, 9$. The seventh significant digit is $3$, which is less than $5$, so we round down (i.e., we truncate).\n$$\n\\ln Z \\approx 1000.69\n$$", "answer": "$$\n\\boxed{1000.69}\n$$", "id": "3260986"}, {"introduction": "A cornerstone of thermodynamics is that for non-interacting subsystems, extensive properties like free energy are additive. In the language of statistical mechanics, this property of size consistency arises from the multiplicative nature of their partition functions: $Z_{A \\cdot B} = Z_A Z_B$. This hands-on practice [@problem_id:2805747] challenges you to numerically verify this principle by computing the free energy of a composite system in two ways: directly from its enumerated joint energy spectrum, and by summing the free energies of its individual fragments. Successfully demonstrating their equality within numerical precision provides a powerful validation of both the underlying theory and your computational toolkit.", "problem": "You are asked to construct a numerical validation of size consistency and size extensivity at finite temperature for noninteracting fragments within the canonical ensemble. Work entirely with the dimensionless Helmholtz free energy, defined as $\\phi \\equiv \\beta F = -\\ln Z$, where $F$ is the Helmholtz free energy, $Z$ is the canonical partition function, $\\beta \\equiv 1/(k_{\\mathrm{B}} T)$, $k_{\\mathrm{B}}$ is the Boltzmann constant, and $T$ is the absolute temperature. For a system with discrete energy levels $\\{E_i\\}$ and degeneracies $\\{g_i\\}$, the partition function is $Z = \\sum_i g_i \\exp(-\\beta E_i)$. For two noninteracting fragments $A$ and $B$ with Hamiltonians that commute and add, the composite system $A \\cdot B$ has product-form partition function $Z_{A \\cdot B} = Z_A Z_B$, implying size consistency via $\\phi_{A \\cdot B} = \\phi_A + \\phi_B$.\n\nYour task is to implement a program that, for each provided test case, does the following:\n- Given energies $\\{E_i^A\\}$ and degeneracies $\\{g_i^A\\}$ for fragment $A$, energies $\\{E_j^B\\}$ and degeneracies $\\{g_j^B\\}$ for fragment $B$, and an inverse temperature $\\beta$, compute:\n  1. $\\ln Z_A$ and $\\ln Z_B$ by numerically stabilizing the sum $\\sum_i g_i^A \\exp(-\\beta E_i^A)$ and $\\sum_j g_j^B \\exp(-\\beta E_j^B)$, respectively.\n  2. $\\ln Z_{A \\cdot B}$ by explicitly enumerating the composite spectrum with energies $\\{E_i^A + E_j^B\\}$ and degeneracies $\\{g_i^A g_j^B\\}$ and stabilizing the corresponding sum.\n  3. The dimensionless free energies $\\phi_A = -\\ln Z_A$, $\\phi_B = -\\ln Z_B$, and $\\phi_{A \\cdot B} = -\\ln Z_{A \\cdot B}$.\n  4. A boolean indicating whether the size-consistency condition holds within a numerical tolerance: $\\lvert \\phi_{A \\cdot B} - (\\phi_A + \\phi_B) \\rvert \\le \\epsilon$, with $\\epsilon = 10^{-12}$.\n- All energies are to be treated in arbitrary consistent units, and the outputs are the dimensionless free energies. Angles do not appear. No physical units are required in the output because $\\phi$ is dimensionless.\n\nUse the following test suite. Each test case is a tuple $(\\beta, \\{E_i^A\\}, \\{g_i^A\\}, \\{E_j^B\\}, \\{g_j^B\\})$:\n- Case $1$: $\\beta = 0.7$, $\\{E_i^A\\} = [0.0, 1.0, 2.0]$, $\\{g_i^A\\} = [1, 2, 1]$, $\\{E_j^B\\} = [0.0, 0.5]$, $\\{g_j^B\\} = [1, 3]$.\n- Case $2$ (high temperature limit): $\\beta = 10^{-6}$, $\\{E_i^A\\} = [0.0, 10.0, 20.0]$, $\\{g_i^A\\} = [1, 1, 1]$, $\\{E_j^B\\} = [0.0, 30.0]$, $\\{g_j^B\\} = [2, 1]$.\n- Case $3$ (low temperature limit with ground-state degeneracy): $\\beta = 100.0$, $\\{E_i^A\\} = [0.0, 0.01]$, $\\{g_i^A\\} = [2, 1]$, $\\{E_j^B\\} = [0.0, 0.02]$, $\\{g_j^B\\} = [3, 5]$.\n- Case $4$ (negative and positive levels, single-level partner): $\\beta = 2.3$, $\\{E_i^A\\} = [-0.5, 0.0, 0.5]$, $\\{g_i^A\\} = [1, 3, 2]$, $\\{E_j^B\\} = [1.23456]$, $\\{g_j^B\\} = [7]$.\n- Case $5$ (large energy offsets to test numerical stability): $\\beta = 0.4$, $\\{E_i^A\\} = [50.2, 51.9]$, $\\{g_i^A\\} = [4, 1]$, $\\{E_j^B\\} = [0.3, 0.9, 2.1]$, $\\{g_j^B\\} = [1, 2, 1]$.\n\nAlgorithmic requirements:\n- Implement a numerically stable computation of $\\ln Z$ using a log-sum-exp transformation: if $a_k = \\ln g_k - \\beta E_k$, then $\\ln Z = m + \\ln \\sum_k \\exp(a_k - m)$ with $m = \\max_k a_k$.\n- Use the composite energy-degeneracy enumeration for $A \\cdot B$ explicitly, i.e., enumerate all pairs $(i,j)$ to form energies $E_i^A + E_j^B$ and degeneracies $g_i^A g_j^B$. Do not compute $\\ln Z_{A \\cdot B}$ by simply adding $\\ln Z_A$ and $\\ln Z_B$, because the purpose is to validate this equality numerically.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, for example, $[ \\text{result1}, \\text{result2}, \\text{result3}, \\ldots ]$.\n- Each result is a boolean indicating whether $\\lvert \\phi_{A \\cdot B} - (\\phi_A + \\phi_B) \\rvert \\le 10^{-12}$ for the corresponding test case.", "solution": "We begin from the canonical ensemble definition for a discrete spectrum with degeneracies. For a system with energy levels $\\{E_i\\}$ and degeneracies $\\{g_i\\}$ at inverse temperature $\\beta \\equiv 1/(k_{\\mathrm{B}} T)$, the canonical partition function is\n$$\nZ = \\sum_{i} g_i \\exp(-\\beta E_i).\n$$\nThe Helmholtz free energy is $F = -k_{\\mathrm{B}} T \\ln Z$. The dimensionless Helmholtz free energy is defined by $\\phi \\equiv \\beta F = - \\ln Z$. Therefore, if we can compute $\\ln Z$ in a numerically stable way, then $\\phi = -\\ln Z$ follows directly.\n\nFor two noninteracting fragments $A$ and $B$, with Hamiltonian operators $\\hat{H}_A$ and $\\hat{H}_B$ that commute and add for the composite system, the energy levels of the composite system $A \\cdot B$ are all pairwise sums $E_{ij}^{A \\cdot B} = E_i^A + E_j^B$, and the corresponding degeneracies are products $g_{ij}^{A \\cdot B} = g_i^A g_j^B$. The partition function of the composite is then\n$$\nZ_{A \\cdot B} = \\sum_{i,j} g_i^A g_j^B \\exp\\!\\left(-\\beta (E_i^A + E_j^B)\\right) \n= \\left(\\sum_i g_i^A \\exp(-\\beta E_i^A)\\right)\\left(\\sum_j g_j^B \\exp(-\\beta E_j^B)\\right) = Z_A Z_B.\n$$\nTaking logarithms and using the definition of $\\phi$, we have\n$$\n\\phi_{A \\cdot B} = -\\ln Z_{A \\cdot B} = -\\ln(Z_A Z_B) = -\\ln Z_A - \\ln Z_B = \\phi_A + \\phi_B.\n$$\nThis additivity embodies size consistency and size extensivity in the thermodynamic, finite-temperature context: for noninteracting fragments, the free energy of the total system is the sum of the free energies of the fragments.\n\nAlgorithmic design:\n- Directly summing $\\sum_i g_i \\exp(-\\beta E_i)$ can suffer from underflow or overflow, especially for large $\\beta$ or large energy offsets. To ensure numerical stability, we use a log-sum-exp transformation. Define $a_i \\equiv \\ln g_i - \\beta E_i$. Then\n$$\n\\ln Z = \\ln \\sum_i \\exp(a_i) = m + \\ln \\sum_i \\exp(a_i - m),\n$$\nwhere $m \\equiv \\max_i a_i$. This shifts the exponentials so that the largest exponent is zero, keeping the sum within a numerically safe range.\n- For the composite system $A \\cdot B$, we explicitly enumerate all pairs $(i,j)$ to form the composite energies $E_{ij} = E_i^A + E_j^B$ and degeneracies $g_{ij} = g_i^A g_j^B$, then apply the same log-sum-exp method to compute $\\ln Z_{A \\cdot B}$. This avoids trivially enforcing the equality via $\\ln Z_{A \\cdot B} = \\ln Z_A + \\ln Z_B$ and instead validates it numerically.\n- Having computed $\\ln Z_A$, $\\ln Z_B$, and $\\ln Z_{A \\cdot B}$, we compute $\\phi_A = -\\ln Z_A$, $\\phi_B = -\\ln Z_B$, and $\\phi_{A \\cdot B} = -\\ln Z_{A \\cdot B}$, and test whether $\\lvert \\phi_{A \\cdot B} - (\\phi_A + \\phi_B) \\rvert \\le \\epsilon$ with $\\epsilon = 10^{-12}$.\n\nTest coverage rationale:\n- Case $1$ provides a general mixture of energies and degeneracies at a moderate $\\beta$ to test the general case.\n- Case $2$ uses a very small $\\beta$ (high temperature) so that many states contribute almost equally; this tests stability when exponentials are near unity.\n- Case $3$ uses a very large $\\beta$ (low temperature) to ensure ground states dominate and to test the role of degeneracies in the low-temperature limit.\n- Case $4$ includes negative energies and a single-level partner to test behavior with energy shifts and asymmetry in spectrum sizes.\n- Case $5$ includes large positive energy offsets to stress-test the log-sum-exp stabilization and avoid underflow in naive summation.\n\nThe program implements a function to compute $\\ln Z$ robustly and then applies it to the fragments $A$ and $B$ and to the composite system constructed by explicit enumeration. For each case, it outputs a boolean indicating whether the size-consistency condition holds within the prescribed numerical tolerance. The final output is a single line containing the list of booleans in the specified format.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef log_partition(energies, degeneracies, beta):\n    \"\"\"\n    Compute ln Z for a discrete spectrum using a numerically stable log-sum-exp.\n    energies: 1D array-like of energy levels E_i\n    degeneracies: 1D array-like of positive degeneracies g_i (integers)\n    beta: float inverse temperature\n    \"\"\"\n    E = np.array(energies, dtype=float).ravel()\n    g = np.array(degeneracies, dtype=float).ravel()\n    if E.size != g.size:\n        raise ValueError(\"Energies and degeneracies must have the same length.\")\n    if np.any(g <= 0):\n        raise ValueError(\"Degeneracies must be positive.\")\n    a = np.log(g) - beta * E\n    m = np.max(a)\n    # log-sum-exp\n    logZ = m + np.log(np.sum(np.exp(a - m)))\n    return logZ\n\ndef composite_spectrum(energies_A, degeneracies_A, energies_B, degeneracies_B):\n    \"\"\"\n    Enumerate composite spectrum energies and degeneracies for noninteracting A and B.\n    Returns flattened arrays of composite energies and degeneracies.\n    \"\"\"\n    E_A = np.array(energies_A, dtype=float).ravel()\n    g_A = np.array(degeneracies_A, dtype=float).ravel()\n    E_B = np.array(energies_B, dtype=float).ravel()\n    g_B = np.array(degeneracies_B, dtype=float).ravel()\n    # Pairwise sums via broadcasting\n    E_AB = (E_A[:, None] + E_B[None, :]).reshape(-1)\n    # Pairwise degeneracy products via outer product\n    g_AB = (g_A[:, None] * g_B[None, :]).reshape(-1)\n    return E_AB, g_AB\n\ndef dimensionless_free_energy_logZ(logZ):\n    \"\"\"\n    Convert ln Z to the dimensionless Helmholtz free energy phi = - ln Z.\n    \"\"\"\n    return -logZ\n\ndef validate_case(beta, E_A, g_A, E_B, g_B, tol=1e-12):\n    \"\"\"\n    For a single test case, compute phi_A, phi_B, phi_AB and check size consistency:\n    |phi_AB - (phi_A + phi_B)| <= tol\n    \"\"\"\n    # ln Z for A and B\n    lnZ_A = log_partition(E_A, g_A, beta)\n    lnZ_B = log_partition(E_B, g_B, beta)\n\n    # Composite by explicit enumeration\n    E_AB, g_AB = composite_spectrum(E_A, g_A, E_B, g_B)\n    lnZ_AB = log_partition(E_AB, g_AB, beta)\n\n    # Dimensionless Helmholtz free energies\n    phi_A = dimensionless_free_energy_logZ(lnZ_A)\n    phi_B = dimensionless_free_energy_logZ(lnZ_B)\n    phi_AB = dimensionless_free_energy_logZ(lnZ_AB)\n\n    diff = abs(phi_AB - (phi_A + phi_B))\n    return diff <= tol\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each case: (beta, energies_A, degeneracies_A, energies_B, degeneracies_B)\n    test_cases = [\n        (0.7, [0.0, 1.0, 2.0], [1, 2, 1], [0.0, 0.5], [1, 3]),\n        (1e-6, [0.0, 10.0, 20.0], [1, 1, 1], [0.0, 30.0], [2, 1]),\n        (100.0, [0.0, 0.01], [2, 1], [0.0, 0.02], [3, 5]),\n        (2.3, [-0.5, 0.0, 0.5], [1, 3, 2], [1.23456], [7]),\n        (0.4, [50.2, 51.9], [4, 1], [0.3, 0.9, 2.1], [1, 2, 1]),\n    ]\n\n    results = []\n    for case in test_cases:\n        beta, E_A, g_A, E_B, g_B = case\n        result = validate_case(beta, E_A, g_A, E_B, g_B, tol=1e-12)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "2805747"}, {"introduction": "In the thermodynamic limit, different statistical ensembles are expected to yield the same macroscopic properties, a powerful concept known as ensemble equivalence. This allows us to choose the most convenient ensemble—canonical (fixed $N$), grand canonical (fixed $\\mu$), or otherwise—for a given problem. This exercise [@problem_id:3489860] guides you to explore this principle numerically by comparing the thermodynamic potential derived from the canonical ensemble with that of the grand canonical ensemble for a finite-sized system of point defects. By quantifying the discrepancy and observing its dependence on system size, you will gain a concrete understanding of how fluctuations govern the validity of ensemble equivalence and how macroscopic behavior emerges from microscopic statistics.", "problem": "Consider a non-interacting point-defect model for a crystalline solid with a fixed number of available lattice sites. Let there be $D$ equivalent and independent sites, each of which can host at most one point defect (for example, a vacancy). Creating a defect costs an energy of $ \\epsilon_f $ (formation energy), measured in electronvolts (eV). The system is in contact with a large reservoir that fixes the effective chemical potential $ \\mu $ (in eV) conjugate to the number of defects, at absolute temperature $ T $ (in Kelvin). Assume that the sites do not interact and that the host degrees of freedom do not contribute to the defect statistics beyond providing the $D$ available sites.\n\nYour tasks are as follows, starting only from first-principles definitions of statistical ensembles:\n\n1) Starting from the definition of the grand partition function for the Grand Canonical (GC) ensemble, $ \\Xi = \\sum_{\\text{microstates}} \\exp\\left[-\\beta \\left(E - \\mu N\\right)\\right] $ with $ \\beta = 1/(k_{\\mathrm{B}} T) $ and $ k_{\\mathrm{B}} $ the Boltzmann constant, derive an explicit, closed-form expression for the grand potential $ \\Omega(T,V,\\mu) = - k_{\\mathrm{B}} T \\ln \\Xi $ for this defect system, where $ V $ is the volume of the system. Clearly state any factorization steps and assumptions used to reach the final form, and express the grand potential per site, $ \\omega = \\Omega/D $, in terms of $ T $ and the dimensionless activity $ z \\equiv \\exp\\left(\\beta(\\mu - \\epsilon_f)\\right) $.\n\n2) In the Canonical (C) ensemble with a fixed defect number $ n $ ($ 0 \\le n \\le D $), start from the definition of the canonical partition function $ Z_n = \\sum_{\\text{microstates at fixed }n} \\exp(-\\beta E) $. Derive the exact expression for $ Z_n $ for this model by counting microstates combinatorially. Then write the Helmholtz free energy per site, $ f(n,D,T) = F/D = - (k_{\\mathrm{B}} T/D) \\ln Z_n $, and express it in a form suitable for numerical evaluation at finite $ D $.\n\n3) Using the Legendre structure between ensembles, define the Canonical-to-Grand-Canonical comparison quantity at fixed $ \\mu $ as $ \\phi_D(n; T, \\mu) = f(n,D,T) - \\mu \\, (n/D) $, and compare this to the GC grand potential per site $ \\omega(T,\\mu) $ by evaluating $ \\phi_D $ at the integer $ n^\\star $ closest to the GC mean defect number $ \\langle n \\rangle = D \\, \\frac{z}{1+z} $. Discuss, from first principles, why $ \\phi_D(n^\\star; T,\\mu) \\to \\omega(T,\\mu) $ as $ D \\to \\infty $ (the thermodynamic limit), and quantify the scaling of the GC number fluctuations with $ D $.\n\n4) Write a program that, for a given set of parameters $ (D, T, \\epsilon_f, \\mu) $, computes the following four quantities:\n   - The grand potential per site $ \\omega(T,\\mu) $ in eV.\n   - The canonical Legendre quantity per site evaluated at $ n^\\star $, $ \\phi_D(n^\\star; T,\\mu) $ in eV, using the exact finite-$ D $ combinatorial expression for $ Z_n $ with numerically stable logarithms.\n   - The absolute discrepancy per site $ \\delta = \\left| \\omega(T,\\mu) - \\phi_D(n^\\star; T,\\mu) \\right| $ in eV.\n   - The standard deviation of the defect fraction (defect number per site) in the GC ensemble, $ \\delta x = \\sqrt{\\mathrm{Var}(n)}/D = \\sqrt{ \\frac{z}{1+z} \\left(1 - \\frac{z}{1+z}\\right) \\frac{1}{D} } $, which is dimensionless.\n\nUse $ k_{\\mathrm{B}} = 8.617333262145 \\times 10^{-5} $ eV/K, and express all energies in eV and all temperatures in K. The program must not read any input and must compute the outputs for the following five test cases (the test suite):\n\n- Case $1$: $ D = 1000 $, $ T = 1000 $ K, $ \\epsilon_f = 1.0 $ eV, $ \\mu = 0.2 $ eV.\n- Case $2$: $ D = 1000 $, $ T = 600 $ K, $ \\epsilon_f = 0.5 $ eV, $ \\mu = 0.3 $ eV.\n- Case $3$: $ D = 1000 $, $ T = 800 $ K, $ \\epsilon_f = 0.6 $ eV, $ \\mu = 0.6 $ eV.\n- Case $4$: $ D = 100000 $, $ T = 800 $ K, $ \\epsilon_f = 0.8 $ eV, $ \\mu = 0.3 $ eV.\n- Case $5$: $ D = 50 $, $ T = 400 $ K, $ \\epsilon_f = 0.2 $ eV, $ \\mu = 0.35 $ eV.\n\nNumerical requirements:\n- Use stable logarithms for combinatorial factors, for example via the logarithm of the Gamma function to evaluate $ \\ln \\binom{D}{n} $.\n- When selecting $ n^\\star $, use $ n^\\star = \\mathrm{round}\\!\\left(D \\, \\frac{z}{1+z}\\right) $ and clamp to the interval $ [0, D] $.\n\nFinal output format:\n- Your program should produce a single line of output containing a list of five elements, one per test case, where each element is itself a list of four floating-point numbers in the order $ [\\omega, \\phi_D(n^\\star), \\delta, \\delta x] $. The list must be printed as a comma-separated list enclosed in square brackets, for example, $ [[a_1,b_1,c_1,d_1],[a_2,b_2,c_2,d_2],\\dots] $.", "solution": "The problem is first validated against the specified criteria.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n\n-   System: A non-interacting point-defect model for a crystalline solid.\n-   Number of equivalent and independent sites: $D$.\n-   Site occupancy: Each site can host at most one defect.\n-   Defect formation energy: $\\epsilon_f$ (in eV).\n-   Thermodynamic ensemble for task 1: Grand Canonical (GC) ensemble, in contact with a reservoir fixing absolute temperature $T$ (in Kelvin) and effective chemical potential $\\mu$ (in eV).\n-   Grand partition function definition: $\\Xi = \\sum_{\\text{microstates}} \\exp\\left[-\\beta \\left(E - \\mu N\\right)\\right]$.\n-   Inverse temperature: $\\beta = 1/(k_{\\mathrm{B}} T)$.\n-   Boltzmann constant: $k_{\\mathrm{B}} = 8.617333262145 \\times 10^{-5}$ eV/K.\n-   Grand potential definition: $\\Omega(T,V,\\mu) = -k_{\\mathrm{B}} T \\ln \\Xi$.\n-   Grand potential per site: $\\omega = \\Omega/D$.\n-   Activity definition: $z \\equiv \\exp\\left(\\beta(\\mu - \\epsilon_f)\\right)$.\n-   Thermodynamic ensemble for task 2: Canonical (C) ensemble with a fixed number of defects $n$, where $0 \\le n \\le D$.\n-   Canonical partition function definition: $Z_n = \\sum_{\\text{microstates at fixed }n} \\exp(-\\beta E)$.\n-   Helmholtz free energy per site: $f(n,D,T) = F/D = - (k_{\\mathrm{B}} T/D) \\ln Z_n$.\n-   Comparison quantity: $\\phi_D(n; T, \\mu) = f(n,D,T) - \\mu \\, (n/D)$.\n-   Evaluation point for comparison: $n^\\star$, the integer closest to the GC mean defect number $\\langle n \\rangle = D \\, \\frac{z}{1+z}$. Specifically, $n^\\star = \\mathrm{round}\\!\\left(D \\, \\frac{z}{1+z}\\right)$, clamped to $[0, D]$.\n-   Fluctuation of defect fraction: $\\delta x = \\sqrt{\\mathrm{Var}(n)}/D = \\sqrt{ \\frac{z}{1+z} \\left(1 - \\frac{z}{1+z}\\right) \\frac{1}{D} }$.\n-   Test Cases:\n    1.  $D = 1000$, $T = 1000$ K, $\\epsilon_f = 1.0$ eV, $\\mu = 0.2$ eV.\n    2.  $D = 1000$, $T = 600$ K, $\\epsilon_f = 0.5$ eV, $\\mu = 0.3$ eV.\n    3.  $D = 1000$, $T = 800$ K, $\\epsilon_f = 0.6$ eV, $\\mu = 0.6$ eV.\n    4.  $D = 100000$, $T = 800$ K, $\\epsilon_f = 0.8$ eV, $\\mu = 0.3$ eV.\n    5.  $D = 50$, $T = 400$ K, $\\epsilon_f = 0.2$ eV, $\\mu = 0.35$ eV.\n-   Numerical requirements: Use stable logarithms for combinatorial factors (e.g., via the log-gamma function).\n\n**Step 2: Validate Using Extracted Givens**\n\n-   **Scientifically Grounded**: The problem describes a standard lattice-gas model, a cornerstone of statistical mechanics in condensed matter physics. All definitions and principles invoked ($\\Xi, Z, \\Omega, F$, ensemble theory) are fundamental and well-established.\n-   **Well-Posed**: The problem is clearly defined, with all necessary parameters and equations provided. It asks for specific derivations and calculations that lead to a unique, meaningful result.\n-   **Objective**: The problem is stated in precise, quantitative terms, free of any subjective or ambiguous language.\n\nThe problem statement is scientifically sound, self-contained, and well-posed. It does not violate any of the invalidity criteria.\n\n**Step 3: Verdict and Action**\n\nThe problem is **valid**. A full solution will be provided.\n\n---\n\n### Solution Derivations and Explanation\n\nThis problem explores the relationship between the Grand Canonical (GC) and Canonical (C) ensembles using a model of non-interacting point defects. We will derive the thermodynamic potentials for each ensemble and then demonstrate their equivalence in the thermodynamic limit.\n\n**1) Grand Canonical Ensemble and Grand Potential ($\\omega$)**\n\nThe grand partition function is defined as $\\Xi = \\sum_{\\text{all microstates}} \\exp\\left[-\\beta \\left(E - \\mu N\\right)\\right]$. A microstate of the system is specified by the occupation of each of the $D$ available sites. Let the state of site $i$ be represented by a variable $s_i$, where $s_i=1$ if the site is occupied by a defect and $s_i=0$ if it is empty.\n\nFor a given microstate $\\{s_1, s_2, ..., s_D\\}$, the total number of defects is $N = \\sum_{i=1}^D s_i$, and the total energy is $E = \\sum_{i=1}^D s_i \\epsilon_f = N \\epsilon_f$, since the defects do not interact.\n\nThe term in the exponential of the partition function for a single microstate is:\n$$ E - \\mu N = N \\epsilon_f - \\mu N = N (\\epsilon_f - \\mu) = (\\sum_{i=1}^D s_i)(\\epsilon_f - \\mu) = \\sum_{i=1}^D s_i (\\epsilon_f - \\mu) $$\nThe sum over all microstates is a sum over all possible values of $\\{s_1, ..., s_D\\}$, where each $s_i$ can be $0$ or $1$.\n$$ \\Xi = \\sum_{s_1=0}^1 \\sum_{s_2=0}^1 \\dots \\sum_{s_D=0}^1 \\exp\\left[ -\\beta \\sum_{i=1}^D s_i (\\epsilon_f - \\mu) \\right] $$\nUsing the property $\\exp(\\sum x_i) = \\prod \\exp(x_i)$, we can write:\n$$ \\Xi = \\sum_{s_1=0}^1 \\dots \\sum_{s_D=0}^1 \\prod_{i=1}^D \\exp\\left[ -\\beta s_i (\\epsilon_f - \\mu) \\right] $$\nSince the sites are independent, the sum of products can be factored into a product of sums:\n$$ \\Xi = \\prod_{i=1}^D \\left( \\sum_{s_i=0}^1 \\exp\\left[ -\\beta s_i (\\epsilon_f - \\mu) \\right] \\right) $$\nLet's evaluate the sum for a single site $i$:\n$$ \\sum_{s_i=0}^1 \\exp\\left[ -\\beta s_i (\\epsilon_f - \\mu) \\right] = \\exp(0) + \\exp\\left[ -\\beta(\\epsilon_f - \\mu) \\right] = 1 + \\exp\\left[ \\beta(\\mu - \\epsilon_f) \\right] $$\nSince all $D$ sites are equivalent, this single-site partition function, let's call it $\\xi_1$, is the same for all sites.\n$$ \\xi_1 = 1 + \\exp\\left[ \\beta(\\mu - \\epsilon_f) \\right] $$\nThe total grand partition function is then $\\Xi = (\\xi_1)^D$.\n$$ \\Xi = \\left( 1 + \\exp\\left[ \\beta(\\mu - \\epsilon_f) \\right] \\right)^D $$\nThe grand potential $\\Omega$ is given by $\\Omega = -k_{\\mathrm{B}} T \\ln \\Xi$.\n$$ \\Omega(T, \\mu) = -D k_{\\mathrm{B}} T \\ln \\left( 1 + \\exp\\left[ \\beta(\\mu - \\epsilon_f) \\right] \\right) $$\nThe grand potential per site, $\\omega = \\Omega/D$, is:\n$$ \\omega(T, \\mu) = -k_{\\mathrm{B}} T \\ln \\left( 1 + \\exp\\left[ \\beta(\\mu - \\epsilon_f) \\right] \\right) $$\nUsing the given definition for activity, $z = \\exp\\left( \\beta(\\mu - \\epsilon_f) \\right)$, the expression simplifies to:\n$$ \\omega(T, \\mu) = -k_{\\mathrm{B}} T \\ln(1+z) $$\n\n**2) Canonical Ensemble and Helmholtz Free Energy ($f$)**\n\nIn the canonical ensemble, the number of defects $n$ is fixed ($0 \\le n \\le D$). The canonical partition function is $Z_n = \\sum_{\\text{microstates at fixed }n} \\exp(-\\beta E)$.\nFor a fixed number of defects $n$, the energy of any microstate is $E = n \\epsilon_f$, which is constant for all microstates in this sub-ensemble.\nThus, we can factor the energy term out of the sum:\n$$ Z_n = \\exp(-\\beta n \\epsilon_f) \\sum_{\\text{microstates at fixed }n} 1 $$\nThe sum simply counts the number of ways to arrange $n$ indistinguishable defects on $D$ distinguishable sites. This is given by the binomial coefficient $\\binom{D}{n}$.\n$$ Z_n = \\binom{D}{n} \\exp(-\\beta n \\epsilon_f) $$\nThe Helmholtz free energy is $F_n = -k_{\\mathrm{B}} T \\ln Z_n$.\n$$ F_n = -k_{\\mathrm{B}} T \\ln\\left[ \\binom{D}{n} \\exp(-\\beta n \\epsilon_f) \\right] = -k_{\\mathrm{B}} T \\left[ \\ln\\binom{D}{n} - \\beta n \\epsilon_f \\right] = n \\epsilon_f - k_{\\mathrm{B}} T \\ln\\binom{D}{n} $$\nThe Helmholtz free energy per site, $f(n,D,T) = F_n/D$, is:\n$$ f(n,D,T) = \\frac{n \\epsilon_f}{D} - \\frac{k_{\\mathrm{B}} T}{D} \\ln\\binom{D}{n} $$\nFor numerically stable evaluation, especially for large $D$ and $n$, the term $\\ln\\binom{D}{n}$ is computed using logarithms of Gamma functions, as $\\ln(k!) = \\ln(\\Gamma(k+1))$.\n$$ \\ln\\binom{D}{n} = \\ln(D!) - \\ln(n!) - \\ln((D-n)!) = \\ln(\\Gamma(D+1)) - \\ln(\\Gamma(n+1)) - \\ln(\\Gamma(D-n+1)) $$\n\n**3) Ensemble Equivalence and Fluctuations**\n\nThe connection between the canonical and grand canonical ensembles is established through a Legendre transformation. The grand potential $\\Omega$ is the minimum of the Legendre-transformed Helmholtz free energy: $\\Omega(T, \\mu) = \\min_n (F_n - \\mu n)$. For macroscopic systems (large $D$), this minimum is extremely sharp, meaning the thermodynamic properties are dominated by the state with the average number of particles $\\langle n \\rangle$. This is the principle of ensemble equivalence.\n\nWe are asked to compare $\\omega = \\Omega/D$ with the quantity $\\phi_D(n; T, \\mu) = f(n,D,T) - \\mu (n/D)$ evaluated at $n^\\star$, the integer closest to $\\langle n \\rangle$.\n$$ \\phi_D(n; T, \\mu) = \\frac{F_n - \\mu n}{D} $$\nIn the thermodynamic limit ($D \\to \\infty$), we expect $\\phi_D(\\langle n \\rangle; T, \\mu) \\to \\omega(T,\\mu)$. To demonstrate this, we use Stirling's approximation for $\\ln\\binom{D}{n}$ for large $D$ and $n$. Letting $x = n/D$ be the defect fraction:\n$$ \\frac{1}{D}\\ln\\binom{D}{n} \\approx -[x \\ln x + (1-x)\\ln(1-x)] $$\nThis term represents the configurational entropy per site (divided by $k_{\\mathrm{B}}$). Substituting this into the expression for $f$:\n$$ f(x,T) \\approx x \\epsilon_f + k_{\\mathrm{B}} T [x \\ln x + (1-x)\\ln(1-x)] $$\nThe function to be minimized is $\\phi(x; T, \\mu) = f(x,T) - \\mu x$. The equilibrium concentration $x_{eq}$ is found by setting the derivative with respect to $x$ to zero:\n$$ \\frac{\\partial \\phi}{\\partial x} = \\epsilon_f + k_{\\mathrm{B}} T[\\ln x + 1 - \\ln(1-x) - 1] - \\mu = 0 $$\n$$ \\epsilon_f - \\mu + k_{\\mathrm{B}} T \\ln\\left(\\frac{x}{1-x}\\right) = 0 \\implies \\frac{x}{1-x} = \\exp\\left(-\\beta(\\epsilon_f - \\mu)\\right) = \\exp\\left(\\beta(\\mu - \\epsilon_f)\\right) = z $$\nSolving for $x$ gives $x_{eq} = \\frac{z}{1+z}$, which is precisely the average defect fraction $\\langle n \\rangle / D$ in the GC ensemble.\n\nSubstituting $x_{eq}$ back into $\\phi(x; T, \\mu)$ yields:\n$$ \\phi_{min} = x_{eq}(\\epsilon_f - \\mu) + k_{\\mathrm{B}} T [x_{eq} \\ln x_{eq} + (1-x_{eq})\\ln(1-x_{eq})] $$\nUsing $\\ln(\\frac{x_{eq}}{1-x_{eq}}) = \\beta(\\mu - \\epsilon_f)$, substitution and algebraic simplification show that this expression reduces to:\n$$ \\phi_{min} = -k_{\\mathrm{B}} T \\ln(1+z) = \\omega(T,\\mu) $$\nThis confirms the equivalence of ensembles in the thermodynamic limit. The quantity $\\phi_D(n^\\star; T,\\mu)$ for finite $D$ is an approximation to this minimum and converges to $\\omega$ as $D \\to \\infty$.\n\nThe fluctuations in the particle number $n$ in the GC ensemble quantify the \"width\" of the distribution around $\\langle n \\rangle$. The variance is $\\mathrm{Var}(n) = k_{\\mathrm{B}} T (\\partial \\langle n \\rangle / \\partial \\mu)_T$. As derived in the thought process, this gives:\n$$ \\mathrm{Var}(n) = D \\frac{z}{(1+z)^2} = D \\left(\\frac{z}{1+z}\\right) \\left(1 - \\frac{z}{1+z}\\right) $$\nThe fluctuation of the *defect fraction* $x=n/D$ is given by its standard deviation:\n$$ \\delta x = \\frac{\\sqrt{\\mathrm{Var}(n)}}{D} = \\frac{\\sqrt{D z/(1+z)^2}}{D} = \\frac{1}{\\sqrt{D}} \\frac{\\sqrt{z}}{1+z} $$\nThis shows that the fluctuations of the intensive quantity $x$ scale as $1/\\sqrt{D}$ and vanish in the thermodynamic limit ($D \\to \\infty$), which is a key reason why the ensembles become equivalent.\n\n**4) Programmatic Implementation**\n\nThe provided program implements these derived formulas to compute the four requested quantities for each test case. It uses `numpy` for numerical operations and `scipy.special.gammaln` for the numerically stable computation of the combinatorial term in the canonical free energy. The logic follows the steps detailed above: calculation of GC quantities, determination of $n^\\star$, calculation of the corresponding canonical quantity $\\phi_D$, and finally the discrepancy $\\delta$ and fluctuation $\\delta x$.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import gammaln\n\ndef solve():\n    \"\"\"\n    Solves the statistical mechanics problem for point defects in a crystal\n    for a given set of test cases.\n    \"\"\"\n    \n    # Constants\n    k_B = 8.617333262145e-5  # Boltzmann constant in eV/K\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: D=1000, T=1000 K, eps_f=1.0 eV, mu=0.2 eV\n        (1000, 1000.0, 1.0, 0.2),\n        # Case 2: D=1000, T=600 K, eps_f=0.5 eV, mu=0.3 eV\n        (1000, 600.0, 0.5, 0.3),\n        # Case 3: D=1000, T=800 K, eps_f=0.6 eV, mu=0.6 eV\n        (1000, 800.0, 0.6, 0.6),\n        # Case 4: D=100000, T=800 K, eps_f=0.8 eV, mu=0.3 eV\n        (100000, 800.0, 0.8, 0.3),\n        # Case 5: D=50, T=400 K, eps_f=0.2 eV, mu=0.35 eV\n        (50, 400.0, 0.2, 0.35),\n    ]\n\n    results = []\n    for D, T, eps_f, mu in test_cases:\n        # Part 1: Grand Canonical (GC) calculations\n        beta = 1.0 / (k_B * T)\n        z = np.exp(beta * (mu - eps_f))\n        \n        # omega: grand potential per site\n        omega = -k_B * T * np.log(1 + z)\n\n        # Part 3/4: Determine n_star for canonical calculation\n        n_mean = D * z / (1.0 + z)\n        # n_star: integer closest to the mean defect number, clamped to [0, D]\n        n_star = int(np.round(n_mean))\n        n_star = max(0, min(D, n_star))\n\n        # Part 2: Canonical (C) calculations at n_star\n        # f_per_site: Helmholtz free energy per site\n        if n_star == 0 or n_star == D:\n            ln_comb = 0.0\n        else:\n            # Numerically stable log of binomial coefficient using log-gamma\n            ln_comb = gammaln(D + 1) - gammaln(n_star + 1) - gammaln(D - n_star + 1)\n        \n        f_per_site = (n_star * eps_f / D) - (k_B * T / D) * ln_comb\n        \n        # phi_D_n_star: Legendre-transformed canonical quantity\n        phi_D_n_star = f_per_site - mu * (n_star / D)\n        \n        # Part 4: Final quantities\n        # delta: absolute discrepancy per site\n        delta = np.abs(omega - phi_D_n_star)\n        \n        # delta_x: standard deviation of defect fraction in GC ensemble\n        x_mean = z / (1.0 + z)\n        var_n_over_D_sq = (x_mean * (1.0 - x_mean)) / D\n        delta_x = np.sqrt(var_n_over_D_sq)\n\n        results.append([omega, phi_D_n_star, delta, delta_x])\n\n    # Format the final output string as specified\n    inner_strings = [f\"[{r[0]},{r[1]},{r[2]},{r[3]}]\" for r in results]\n    final_output = f\"[{','.join(inner_strings)}]\"\n    \n    print(final_output)\n\nsolve()\n```", "id": "3489860"}]}