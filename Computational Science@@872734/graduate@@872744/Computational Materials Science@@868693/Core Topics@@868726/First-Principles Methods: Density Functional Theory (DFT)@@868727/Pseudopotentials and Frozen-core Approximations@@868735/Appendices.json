{"hands_on_practices": [{"introduction": "The core idea of a pseudopotential is to replace the complicated, rapidly oscillating all-electron wavefunction near the nucleus with a smooth, computationally tractable pseudo-wavefunction. The key to this replacement is ensuring that the scattering properties for valence electrons outside a certain core radius ($r_c$) remain identical. This practice provides direct experience with the fundamental matching condition by asking you to solve for the potential of a simple model that reproduces a target scattering behavior, demystifying this central concept of pseudopotential construction [@problem_id:3481321].", "problem": "In norm-conserving pseudopotential theory under the frozen-core approximation, the ionic core and tightly bound core electrons are replaced by an effective potential that reproduces valence scattering of the all-electron reference at a chosen energy. Both the Hamann construction and the Troullier–Martins construction enforce equality of the logarithmic derivative of the radial wavefunction at a core cutoff radius, while Troullier–Martins additionally imposes higher-order smoothness constraints. Consider the simplest $s$-channel ($l=0$) scattering of a valence electron described by the radial Kohn–Sham equation in atomic units, where $\\hbar = 1$ and $m_{e} = 1$:\n$$\n- \\frac{1}{2} \\frac{d^{2} u(r)}{d r^{2}} + V(r)\\, u(r) = E\\, u(r),\n$$\nwith the regular boundary condition $u(0) = 0$. Within a Hamann-style minimal local model for the pseudopotential, take\n$$\nV(r) = \\begin{cases}\nV_{0}, & 0 \\le r < r_{c}, \\\\\n0, & r \\ge r_{c},\n\\end{cases}\n$$\nwhere $V_{0}$ is a constant to be determined and $r_{c}$ is the core cutoff radius. The all-electron reference provides the target logarithmic derivative at the cutoff,\n$$\nD_{\\text{AE}}(E_{\\text{ref}}) \\equiv \\left.\\frac{u_{\\text{AE}}^{\\prime}(r)}{u_{\\text{AE}}(r)}\\right|_{r=r_{c}} \\quad \\text{at energy } E_{\\text{ref}}.\n$$\nAssume the following realistic inputs from an all-electron calculation: the reference energy is $E_{\\text{ref}} = 0.5$ in Hartree atomic units and the target logarithmic derivative at the cutoff is $D_{\\text{AE}}(E_{\\text{ref}}) = 0$. Take the core cutoff radius to be $r_{c} = 2$ Bohr. Starting only from the radial equation above, its general solutions in regions of constant potential, and continuity of the logarithmic derivative at $r=r_{c}$, derive the scalar equation that determines $V_{0}$ and solve it to obtain a numerical value for $V_{0}$. Express the final energy in Hartree and round your answer to four significant figures.", "solution": "The user wants me to solve this problem. I have confirmed that the problem is valid. I will now proceed with the solution.\nThe problem requires finding the constant potential depth $V_{0}$ for a simplified local pseudopotential such that the logarithmic derivative of the corresponding radial wavefunction matches a target value at a specific energy and cutoff radius.\n\nThe governing equation is the radial Kohn-Sham equation for the $s$-channel ($l=0$) in atomic units:\n$$\n- \\frac{1}{2} \\frac{d^{2} u(r)}{d r^{2}} + V(r)\\, u(r) = E\\, u(r)\n$$\nThe boundary condition at the origin is $u(0)=0$. The pseudopotential $V(r)$ is a simple square well:\n$$\nV(r) = \\begin{cases}\nV_{0}, & 0 \\le r < r_{c} \\\\\n0, & r \\ge r_{c}\n\\end{cases}\n$$\nWe are given the reference energy $E = E_{\\text{ref}} = 0.5$ Hartree, the core cutoff radius $r_{c} = 2$ Bohr, and the target all-electron logarithmic derivative $D_{\\text{AE}}(E_{\\text{ref}}) = 0$. The fundamental condition of this pseudopotential construction is that the logarithmic derivative of the pseudo-wavefunction $u(r)$ at $r=r_{c}$ must match the all-electron target value:\n$$\n\\left.\\frac{u'(r)}{u(r)}\\right|_{r=r_{c}} = D_{\\text{AE}}(E_{\\text{ref}}) = 0\n$$\nTo find $V_{0}$, we must solve the radial equation for $r < r_{c}$, apply the boundary condition, and then enforce the logarithmic derivative condition at $r=r_{c}$.\n\nIn the region $0 \\le r < r_{c}$, the potential is $V(r) = V_{0}$. The radial equation becomes:\n$$\n- \\frac{1}{2} \\frac{d^{2} u(r)}{d r^{2}} + V_{0}\\, u(r) = E_{\\text{ref}}\\, u(r)\n$$\nRearranging the terms, we get:\n$$\n\\frac{d^{2} u(r)}{d r^{2}} = -2(E_{\\text{ref}} - V_{0}) u(r)\n$$\nThe nature of the solution depends on the sign of the term $(E_{\\text{ref}} - V_{0})$. Let us consider the two cases.\n\nCase 1: $E_{\\text{ref}} < V_{0}$.\nIn this case, $(E_{\\text{ref}} - V_{0})$ is negative. Let us define a real constant $\\kappa$ such that $\\kappa^2 = 2(V_{0} - E_{\\text{ref}})$. The differential equation becomes:\n$$\n\\frac{d^{2} u(r)}{d r^{2}} = \\kappa^2 u(r)\n$$\nThe general solution is a linear combination of hyperbolic functions:\n$$\nu(r) = A \\sinh(\\kappa r) + B \\cosh(\\kappa r)\n$$\nApplying the boundary condition $u(0)=0$:\n$$\nu(0) = A \\sinh(0) + B \\cosh(0) = A(0) + B(1) = B = 0\n$$\nSo the solution in this region must be of the form $u(r) = A \\sinh(\\kappa r)$. The derivative is $u'(r) = A \\kappa \\cosh(\\kappa r)$. The logarithmic derivative is:\n$$\n\\frac{u'(r)}{u(r)} = \\frac{A \\kappa \\cosh(\\kappa r)}{A \\sinh(\\kappa r)} = \\kappa \\coth(\\kappa r)\n$$\nEvaluating this at $r=r_{c}$ and setting it to the target value of $0$:\n$$\n\\kappa \\coth(\\kappa r_{c}) = 0\n$$\nFor a non-trivial solution, we need $\\kappa \\neq 0$, which implies $V_{0} \\neq E_{\\text{ref}}$. The hyperbolic cotangent function, $\\coth(x)$, is never zero for any finite, non-zero real argument $x$. Thus, this equation has no solution for $\\kappa \\neq 0$. This means that the assumption $E_{\\text{ref}} < V_{0}$ is inconsistent with the required condition.\n\nCase 2: $E_{\\text{ref}} > V_{0}$.\nIn this case, $(E_{\\text{ref}} - V_{0})$ is positive. Let us define a real constant $k$ such that $k^2 = 2(E_{\\text{ref}} - V_{0})$. The differential equation becomes:\n$$\n\\frac{d^{2} u(r)}{d r^{2}} = -k^2 u(r)\n$$\nThe general solution is a linear combination of trigonometric functions:\n$$\nu(r) = C \\sin(k r) + D \\cos(k r)\n$$\nApplying the boundary condition $u(0)=0$:\n$$\nu(0) = C \\sin(0) + D \\cos(0) = C(0) + D(1) = D = 0\n$$\nThe solution in this region is therefore $u(r) = C \\sin(k r)$. Its derivative is $u'(r) = C k \\cos(k r)$. The logarithmic derivative is:\n$$\n\\frac{u'(r)}{u(r)} = \\frac{C k \\cos(k r)}{C \\sin(k r)} = k \\cot(k r)\n$$\nNow, we enforce the matching condition at $r=r_{c}$:\n$$\n\\left.\\frac{u'(r)}{u(r)}\\right|_{r=r_{c}} = k \\cot(k r_{c}) = 0\n$$\nSince $E_{\\text{ref}} > V_{0}$, $k$ cannot be zero (unless $V_0 = E_{\\text{ref}}$ which leads to $u(r)=Cr$ and a logarithmic derivative of $1/r_c \\neq 0$). Thus, we must have $\\cot(k r_{c}) = 0$. This condition is satisfied when the argument of the cotangent is an odd integer multiple of $\\frac{\\pi}{2}$:\n$$\nk r_{c} = n \\frac{\\pi}{2}, \\quad \\text{for odd integer } n = \\pm 1, \\pm 3, \\dots\n$$\nA crucial requirement for a pseudopotential is that the pseudo-wavefunction should have no nodes inside the core radius $r_{c}$ to avoid creating spurious, deeply bound core-like states. The wavefunction is $u(r) = C \\sin(k r)$. For it to be nodeless in the interval $(0, r_{c})$, the argument $kr$ must be in the range $(0, \\pi)$ for all $r \\in (0, r_{c})$. This implies $k r_{c} \\le \\pi$. The only solution that satisfies this nodeless condition is for $n=1$:\n$$\nk r_{c} = \\frac{\\pi}{2}\n$$\nNow we can solve for $V_{0}$. Substitute the definition of $k$:\n$$\n\\sqrt{2(E_{\\text{ref}} - V_{0})} \\cdot r_{c} = \\frac{\\pi}{2}\n$$\nSquaring both sides gives:\n$$\n2(E_{\\text{ref}} - V_{0}) r_{c}^{2} = \\frac{\\pi^2}{4}\n$$\nSolving for $V_{0}$:\n$$\nE_{\\text{ref}} - V_{0} = \\frac{\\pi^2}{8 r_{c}^{2}}\n$$\n$$\nV_{0} = E_{\\text{ref}} - \\frac{\\pi^2}{8 r_{c}^{2}}\n$$\nThis is the derived scalar equation for $V_{0}$. Now, we substitute the given numerical values: $E_{\\text{ref}} = 0.5$ and $r_{c} = 2$.\n$$\nV_{0} = 0.5 - \\frac{\\pi^2}{8 (2)^{2}} = 0.5 - \\frac{\\pi^2}{32}\n$$\nUsing the value of $\\pi \\approx 3.14159265$:\n$$\n\\pi^2 \\approx 9.8696044\n$$\n$$\nV_{0} \\approx 0.5 - \\frac{9.8696044}{32} \\approx 0.5 - 0.3084251\n$$\n$$\nV_{0} \\approx 0.1915749\n$$\nThe problem requires the final answer to be rounded to four significant figures.\n$$\nV_{0} \\approx 0.1916\n$$\nThe final potential is given in Hartree, as all inputs were in atomic units.", "answer": "$$\n\\boxed{0.1916}\n$$", "id": "3481321"}, {"introduction": "A crucial quality of a pseudopotential is \"transferability\"—its ability to perform reliably when moved from the isolated atom where it was generated to a different chemical environment like a molecule or solid. This exercise explores the deep connection between the \"norm-conservation\" condition and transferability. You will derive from first principles why ensuring the pseudo-charge inside the core matches the all-electron charge makes the pseudopotential robust against environmental changes, bridging the gap between a mathematical constraint and a desirable physical property [@problem_id:3481296].", "problem": "Consider a single-valence-electron problem in atomic units for a spherically symmetric environment, where all-electron (AE) and pseudopotential (PS) treatments differ only inside a core radius $r_c$ and are identical outside $r_c$. Let the radial Schrödinger equation be the starting point, where the partial-wave channel of angular momentum $l$ obeys the single-particle equation with an effective spherical potential. Assume the frozen-core approximation, meaning the core charge distribution is unresponsive to environmental changes and the AE-to-PS mapping is constructed to reproduce valence scattering outside $r_c$. The norm-conserving condition is defined as\n$$\n\\int_0^{r_c} \\left|\\phi_l^{\\text{PS}}(r)\\right|^2 \\, dr = \\int_0^{r_c} \\left|\\phi_l^{\\text{AE}}(r)\\right|^2 \\, dr,\n$$\nfor each angular momentum channel $l$, where $\\phi_l^{\\text{AE}}(r)$ and $\\phi_l^{\\text{PS}}(r)$ denote the AE and PS radial solutions inside the core region, respectively.\n\nStarting from first-order, time-independent perturbation theory applied to scattering in a spherically symmetric potential, and using the representation of scattering properties through partial-wave phase shifts, derive from first principles why the norm conservation condition ensures first-order transferability of scattering properties with respect to an environment-induced potential shift $\\Delta V(r)$ if $\\Delta V(r)$ is slowly varying within the core region or is constant in $0 \\le r \\le r_c$. Explicitly show that for $\\Delta V(r) = \\Delta V_0$ (a constant inside the core), the first-order difference in AE versus PS scattering response cancels exactly due to norm conservation. Then quantify the leading correction when $\\Delta V(r)$ varies smoothly within the core by expanding $\\Delta V(r)$ around $r=0$ and relating the transferability error to differences in radial moments of the AE and PS probabilities.\n\nTo make this derivation testable algorithmically, define a dimensionless transferability error proxy for a given channel $l$:\n$$\nT_l \\equiv \\int_0^{r_c} w(r)\\left(\\rho_l^{\\text{PS}}(r) - \\rho_l^{\\text{AE}}(r)\\right)\\, dr,\n$$\nwhere $\\rho_l^{X}(r) \\equiv \\left|\\phi_l^{X}(r)\\right|^2$ for $X \\in \\{\\text{AE}, \\text{PS}\\}$, and $w(r) \\equiv \\Delta V(r)/\\overline{\\Delta V}$ with\n$$\n\\overline{\\Delta V} \\equiv \\frac{1}{r_c}\\int_0^{r_c} \\Delta V(r)\\, dr.\n$$\nBy construction, $T_l = 0$ for $\\Delta V(r)=\\text{constant}$ due to norm conservation, while $T_l \\ne 0$ quantifies deviations when $\\Delta V(r)$ varies spatially. For numerical tractability, model the AE and PS core-region radial probability densities in channel $l$ as\n$$\n\\rho_l^{\\text{AE}}(r) = r^{2l} e^{-\\lambda r}, \\quad \\rho_l^{\\text{PS,raw}}(r) = r^{2l} e^{-\\mu r},\n$$\nwith positive decay parameters $\\lambda$ and $\\mu$, and enforce norm conservation by scaling the raw PS model with a factor $s$ so that\n$$\ns \\int_0^{r_c} r^{2l} e^{-\\mu r} \\, dr = \\int_0^{r_c} r^{2l} e^{-\\lambda r} \\, dr,\n$$\nand set $\\rho_l^{\\text{PS}}(r) = s\\, r^{2l} e^{-\\mu r}$ for $0 \\le r \\le r_c$. The environment-induced potential shift $\\Delta V(r)$ is spherically symmetric and defined only for $0 \\le r \\le r_c$. All lengths are in atomic units of Bohr radii, and energies are in Hartree, but the output quantity $T_l$ is dimensionless by construction.\n\nYour program must compute $T_l$ for each of the following test cases using numerical quadrature and produce a single line of output containing the results as a comma-separated list enclosed in square brackets. For all test cases, use $6$ decimal places rounding in the printed output. The test suite is:\n\n- Case $1$ (constant shift, cancellation check): $l=0$, $r_c=1.0$, $\\lambda=4.0$, $\\mu=2.0$, and $\\Delta V(r) = \\Delta V_0$ with $\\Delta V_0 = 0.5$.\n- Case $2$ (smooth quadratic variation, happy path): $l=1$, $r_c=1.0$, $\\lambda=3.0$, $\\mu=2.5$, and $\\Delta V(r) = \\Delta V_0 + \\alpha r^2$ with $\\Delta V_0=0.2$, $\\alpha=0.1$.\n- Case $3$ (highly ionic environment, strong core-localized peak): $l=0$, $r_c=0.6$, $\\lambda=6.0$, $\\mu=2.0$, and $\\Delta V(r) = \\Delta V_0 + A e^{-r/\\xi}$ with $\\Delta V_0=1.0$, $A=5.0$, $\\xi=0.2$.\n- Case $4$ (higher angular momentum suppresses core sensitivity): $l=3$, $r_c=1.2$, $\\lambda=3.0$, $\\mu=2.0$, and $\\Delta V(r) = \\Delta V_0 + \\alpha r^2$ with $\\Delta V_0=0.3$, $\\alpha=0.2$.\n\nThe program should:\n- Implement $\\rho_l^{\\text{AE}}(r)$ and $\\rho_l^{\\text{PS}}(r)$ with the norm-conserving scaling factor $s$ defined above.\n- Implement the specified $\\Delta V(r)$ functions and compute $\\overline{\\Delta V}$.\n- Compute $T_l$ for each case using numerical integration over $r \\in [0, r_c]$.\n- Output a single line containing the results as a comma-separated Python list with each value rounded to $6$ decimal places, for example, $\"[x_1,x_2,x_3,x_4]\"$.\n\nYour solution must derive the norm-conservation guarantee for the constant $\\Delta V(r)$ case and explain the leading-order deviation when $\\Delta V(r)$ varies within the core. The final answer must be a complete, runnable program in Python that, when executed, prints exactly the required output in the specified format.", "solution": "The problem as stated is scientifically sound, self-contained, and well-posed. It presents a standard, albeit simplified, model for analyzing a key property of pseudopotentials in computational materials science: transferability. All definitions, parameters, and objectives are clearly laid out, allowing for a rigorous derivation and a direct numerical implementation. Therefore, we proceed with the solution.\n\nThe core of this problem lies in understanding how a pseudopotential (PS), which is designed to reproduce the scattering properties of an all-electron (AE) potential for a reference atomic configuration, behaves when the chemical environment changes. This \"transferability\" is crucial for the predictive power of pseudopotential-based calculations. We analyze this using first-order time-independent perturbation theory.\n\nLet's consider a single valence electron scattering off a spherically symmetric atomic core. The scattering properties for each angular momentum channel $l$ are encoded in the phase shifts $\\delta_l(E)$. A small, environment-induced change in the potential, $\\Delta V(r)$, will cause a first-order change in the phase shift. According to first-order perturbation theory for scattering states, this change is given by:\n$$\n\\Delta \\delta_l \\approx -\\frac{1}{v} \\int \\Delta V(\\mathbf{r}) |\\Psi_{l,E}(\\mathbf{r})|^2 \\, d^3\\mathbf{r}\n$$\nwhere $v$ is the speed of the incident electron and $\\Psi_{l,E}$ is the unperturbed scattering wavefunction at energy $E$ for channel $l$. In atomic units where the electron mass $m_e=1$ and $\\hbar=1$, the kinetic energy is related to the wavenumber $k$ by $E = k^2/2$, and the velocity is $v=k$. The wavefunction can be separated into radial and angular parts, $\\Psi_{l,E}(\\mathbf{r}) = R_l(r) Y_{lm}(\\theta, \\phi)$. The radial part $R_l(r)$ is often written as $\\phi_l(r)/r$, where $\\phi_l(r)$ is the solution to the radial Schrödinger equation. The radial probability density integrated over the solid angle is $|\\phi_l(r)|^2$. The problem uses the notation $\\rho_l(r) = |\\phi_l(r)|^2$. Integrating over the angular coordinates, the change in phase shift is proportional to the radial integral:\n$$\n\\Delta \\delta_l \\propto \\int_0^\\infty \\rho_l(r) \\Delta V(r) \\, dr\n$$\nThe transferability of the pseudopotential is assessed by comparing the response to $\\Delta V(r)$ in the PS formalism versus the AE formalism. The first-order transferability error is the difference in the calculated response:\n$$\n\\text{Error} \\propto \\Delta \\delta_l^{\\text{PS}} - \\Delta \\delta_l^{\\text{AE}} \\propto \\int_0^\\infty \\rho_l^{\\text{PS}}(r) \\Delta V(r) \\, dr - \\int_0^\\infty \\rho_l^{\\text{AE}}(r) \\Delta V(r) \\, dr\n$$\nThis can be written as a single integral:\n$$\n\\text{Error} \\propto \\int_0^\\infty \\left( \\rho_l^{\\text{PS}}(r) - \\rho_l^{\\text{AE}}(r) \\right) \\Delta V(r) \\, dr\n$$\nBy construction, a pseudopotential is identical to the all-electron potential for radii greater than a cutoff radius $r_c$. Consequently, the corresponding wavefunctions and charge densities are also identical, i.e., $\\rho_l^{\\text{PS}}(r) = \\rho_l^{\\text{AE}}(r)$ for $r \\ge r_c$. The integral for the error is therefore non-zero only within the core region:\n$$\n\\text{Error} \\propto \\int_0^{r_c} \\left( \\rho_l^{\\text{PS}}(r) - \\rho_l^{\\text{AE}}(r) \\right) \\Delta V(r) \\, dr\n$$\n\nNow, we analyze this error integral under different conditions for $\\Delta V(r)$.\n\n**Case 1: Constant Potential Shift**\nIf the potential shift is constant within the core region, $\\Delta V(r) = \\Delta V_0$ for $r \\in [0, r_c]$, we can factor it out of the integral:\n$$\n\\text{Error} \\propto \\Delta V_0 \\int_0^{r_c} \\left( \\rho_l^{\\text{PS}}(r) - \\rho_l^{\\text{AE}}(r) \\right) \\, dr = \\Delta V_0 \\left( \\int_0^{r_c} \\rho_l^{\\text{PS}}(r) \\, dr - \\int_0^{r_c} \\rho_l^{\\text{AE}}(r) \\, dr \\right)\n$$\nThe problem states the norm-conserving condition:\n$$\n\\int_0^{r_c} \\left|\\phi_l^{\\text{PS}}(r)\\right|^2 \\, dr = \\int_0^{r_c} \\left|\\phi_l^{\\text{AE}}(r)\\right|^2 \\, dr \\implies \\int_0^{r_c} \\rho_l^{\\text{PS}}(r) \\, dr = \\int_0^{r_c} \\rho_l^{\\text{AE}}(r) \\, dr\n$$\nThis condition ensures that the total electronic charge contained within the core radius is identical for both the AE and PS models. Substituting this into the error expression, we find that the term in the parenthesis is exactly zero.\n$$\n\\text{Error} \\propto \\Delta V_0 \\times 0 = 0\n$$\nThus, a norm-conserving pseudopotential is perfectly transferable to first order with respect to a constant potential shift inside the core.\n\n**Case 2: Smoothly Varying Potential Shift**\nIf $\\Delta V(r)$ is not constant but varies smoothly within the core, we can approximate it with a Taylor series expansion around $r=0$:\n$$\n\\Delta V(r) = \\Delta V(0) + r \\Delta V'(0) + \\frac{r^2}{2!} \\Delta V''(0) + \\mathcal{O}(r^3)\n$$\nSubstituting this into the error integral:\n$$\n\\text{Error} \\propto \\int_0^{r_c} \\left(\\rho_l^{\\text{PS}} - \\rho_l^{\\text{AE}}\\right) \\left(\\Delta V(0) + r \\Delta V'(0) + \\frac{r^2}{2} \\Delta V''(0) + \\dots\\right) dr\n$$\nWe can examine this term by term:\n\\begin{align*}\n\\text{Error} & \\propto \\Delta V(0) \\int_0^{r_c} \\left(\\rho_l^{\\text{PS}} - \\rho_l^{\\text{AE}}\\right) dr && \\text{(Term 1)} \\\\\n& + \\Delta V'(0) \\int_0^{r_c} r \\left(\\rho_l^{\\text{PS}} - \\rho_l^{\\text{AE}}\\right) dr && \\text{(Term 2)} \\\\\n& + \\frac{\\Delta V''(0)}{2} \\int_0^{r_c} r^2 \\left(\\rho_l^{\\text{PS}} - \\rho_l^{\\text{AE}}\\right) dr && \\text{(Term 3)} \\\\\n& + \\dots\n\\end{align*}\nTerm 1 vanishes due to the norm-conservation condition, just as in the constant potential case. The leading-order error is therefore determined by Term 2, which depends on the difference between the first radial moments of the AE and PS charge densities inside the core. The next correction (Term 3) depends on the difference in the second moments, and so on.\n$$\n\\text{Error} \\propto \\Delta V'(0) \\left( \\langle r \\rangle_{\\text{PS}} - \\langle r \\rangle_{\\text{AE}} \\right)_{\\text{core}} + \\frac{\\Delta V''(0)}{2} \\left( \\langle r^2 \\rangle_{\\text{PS}} - \\langle r^2 \\rangle_{\\text{AE}} \\right)_{\\text{core}} + \\dots\n$$\nwhere $\\langle r^n \\rangle_{X, \\text{core}} = \\int_0^{r_c} r^n \\rho_l^X(r) dr$. This demonstrates that for a pseudopotential to be highly transferable, its pseudo-charge density $\\rho_l^{\\text{PS}}$ must not only match the total AE charge inside $r_c$, but it should also reproduce the low-order radial moments of the AE charge density as closely as possible.\n\nThe dimensionless transferability error proxy $T_l$ given in the problem statement,\n$$\nT_l \\equiv \\int_0^{r_c} w(r)\\left(\\rho_l^{\\text{PS}}(r) - \\rho_l^{\\text{AE}}(r)\\right)\\, dr \\quad \\text{with} \\quad w(r) = \\frac{\\Delta V(r)}{\\overline{\\Delta V}}\n$$\nis precisely the error integral we have analyzed, normalized by the average value of the perturbation $\\overline{\\Delta V} = \\frac{1}{r_c}\\int_0^{r_c} \\Delta V(r)\\, dr$. This normalization makes $T_l$ a dimensionless quantity that captures the error arising from the *shape* of the potential shift $\\Delta V(r)$, independent of its overall magnitude. For a constant $\\Delta V(r)$, $w(r)=1$, and $T_l=0$ due to norm conservation. For a varying $\\Delta V(r)$, $T_l$ quantifies the deviation from perfect transferability.\n\nThe following program implements the calculation of $T_l$ for the specified test cases using the given models for $\\rho_l^{\\text{AE}}$ and $\\rho_l^{\\text{PS}}$ and numerical quadrature.", "answer": "```python\nimport numpy as np\nfrom scipy.integrate import quad\n\ndef solve():\n    \"\"\"\n    Solves the problem for all test cases and prints the final result.\n    \"\"\"\n\n    def calculate_transferability_error(l, rc, lam, mu, delta_v_func):\n        \"\"\"\n        Calculates the transferability error proxy T_l for a single case.\n\n        Args:\n            l (int): Angular momentum channel.\n            rc (float): Core radius.\n            lam (float): Decay parameter for the AE model.\n            mu (float): Decay parameter for the PS model.\n            delta_v_func (callable): Function for the potential shift Delta V(r).\n\n        Returns:\n            float: The calculated value of T_l.\n        \"\"\"\n        \n        # Define the functional form of the unscaled probability densities.\n        # integrand_ae_norm corresponds to rho_l^AE(r).\n        # integrand_ps_raw_norm corresponds to the unscaled rho_l^PS,raw(r).\n        integrand_ae_norm = lambda r: r**(2 * l) * np.exp(-lam * r)\n        integrand_ps_raw_norm = lambda r: r**(2 * l) * np.exp(-mu * r)\n\n        # 1. Calculate the norm-conserving scaling factor 's'.\n        # The norm is the integral of the probability density from 0 to rc.\n        norm_ae, _ = quad(integrand_ae_norm, 0, rc)\n        norm_ps_raw, _ = quad(integrand_ps_raw_norm, 0, rc)\n\n        # s scales the raw PS density to match the AE norm inside the core.\n        if np.isclose(norm_ps_raw, 0):\n            # This case implies the PS density is zero, making 's' ill-defined.\n            # Based on the problem's models, this should not occur for positive parameters.\n            # If it did, and AE norm is also zero, s=1 would be fine. If not, error is infinite.\n            # For robustness, we check, but don't expect it to be triggered.\n            s = 1.0 if np.isclose(norm_ae, 0) else np.inf\n        else:\n            s = norm_ae / norm_ps_raw\n\n        # 2. Define the final, scaled probability densities.\n        rho_ae = integrand_ae_norm\n        rho_ps = lambda r: s * integrand_ps_raw_norm(r)\n        \n        # 3. Calculate the average of the potential shift, Delta V_bar.\n        dv_integral, _ = quad(delta_v_func, 0, rc)\n        if np.isclose(rc, 0):\n            dv_bar = 0.0\n        else:\n            dv_bar = dv_integral / rc\n\n        # 4. Calculate the transferability error proxy T_l.\n        # The weight function w(r) = Delta V(r) / Delta V_bar.\n        # The integrand for T_l is w(r) * (rho_ps(r) - rho_ae(r)).\n        if np.isclose(dv_bar, 0):\n            # This can happen if Delta V(r) averages to zero.\n            # If Delta V(r) is constant and zero, the error is zero.\n            # The problem defines T_l via a ratio, so if dv_bar is zero,\n            # T_l is only well-defined if the numerator integral is also zero.\n            # We explicitly check for this, although not expected for the given test cases.\n            numerator_integrand = lambda r: delta_v_func(r) * (rho_ps(r) - rho_ae(r))\n            numerator, _ = quad(numerator_integrand, 0, rc)\n            return 0.0 if np.isclose(numerator, 0) else np.nan\n\n        # Regular case where dv_bar is non-zero.\n        integrand_tl = lambda r: (delta_v_func(r) / dv_bar) * (rho_ps(r) - rho_ae(r))\n        Tl, _ = quad(integrand_tl, 0, rc)\n        \n        return Tl\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {'l': 0, 'rc': 1.0, 'lam': 4.0, 'mu': 2.0, 'dv_func': lambda r: 0.5},\n        {'l': 1, 'rc': 1.0, 'lam': 3.0, 'mu': 2.5, 'dv_func': lambda r: 0.2 + 0.1 * r**2},\n        {'l': 0, 'rc': 0.6, 'lam': 6.0, 'mu': 2.0, 'dv_func': lambda r: 1.0 + 5.0 * np.exp(-r / 0.2)},\n        {'l': 3, 'rc': 1.2, 'lam': 3.0, 'mu': 2.0, 'dv_func': lambda r: 0.3 + 0.2 * r**2},\n    ]\n\n    results = []\n    for case in test_cases:\n        Tl = calculate_transferability_error(\n            case['l'], case['rc'], case['lam'], case['mu'], case['dv_func']\n        )\n        results.append(Tl)\n\n    # Format the final output string as required.\n    # Each value is formatted to 6 decimal places.\n    output_str = f\"[{','.join([f'{r:.6f}' for r in results])}]\"\n    print(output_str)\n\nsolve()\n```", "id": "3481296"}, {"introduction": "While robust, norm-conserving (NC) pseudopotentials often require a large basis set, making them computationally expensive. Ultrasoft pseudopotentials (USPPs) were developed to be more efficient by relaxing the norm-conservation constraint, which introduces a generalized eigenvalue problem of the form $H \\phi = \\varepsilon S \\phi$. This advanced coding exercise contrasts the USPP and NC formalisms, guiding you through the implementation of the generalized eigenproblem and the calculation of atomic forces, which differ significantly from the NC case due to the overlap operator $S$ [@problem_id:3481350].", "problem": "In a simplified one-dimensional periodic solid with one atom per unit cell, model Ultrasoft Pseudopotentials (USPP) and Norm-Conserving (NC) pseudopotentials using a single nonlocal projector centered at the atomic position. Work in atomic units, where energy is expressed in Hartree (Ha), length in Bohr, and forces in Hartree per Bohr (Ha/$a_0$). Consider a single-electron Kohn–Sham state and represent the system on a uniform real-space grid of $N$ points over a cell of length $L$ with periodic boundary conditions.\n\nStarting point and base definitions to use:\n- The Kohn–Sham Hamiltonian for a nonlocal pseudopotential contains a kinetic operator and a local potential term, together with a nonlocal projector contribution. In USPP, wave functions satisfy a generalized eigenvalue problem with an overlap operator.\n- The kinetic energy operator is derived from the second derivative with respect to position, and the Hellmann–Feynman force for an eigenstate of a generalized eigenproblem depends on derivatives of the Hamiltonian and the overlap operator with respect to atomic position.\n- The augmentation in USPP alters the overlap operator and the charge normalization through a rank-one nonlocal operator constructed from projectors.\n- Use a single real scalar nonlocal projector function and a single local potential, both centered at the atomic coordinate $R$ and both dependent on $R$ only through translation.\n\nDiscretization and model specifications:\n- Use a uniform grid $x_i$ with spacing $\\Delta x = L/N$ and periodic boundary conditions. The kinetic operator is approximated by a standard second-order central difference Laplacian with periodic wrap.\n- Use a local potential modeled by a Gaussian well centered at $R$, $V_{\\mathrm{loc}}(x) = v_0 \\exp\\left(-\\frac{d(x,R)^2}{2 \\sigma_v^2}\\right)$, where $d(x,R)$ is the nearest-image periodic distance.\n- Use a single nonlocal projector $\\beta(x) = \\beta_0 \\exp\\left(-\\frac{d(x,R)^2}{2 \\sigma_\\beta^2}\\right)$.\n- Define the USPP generalized overlap operator as $S = I + q \\, |\\beta\\rangle \\langle \\beta|$ and the Hamiltonian as $H = T + V_{\\mathrm{loc}} + D \\, |\\beta\\rangle \\langle \\beta|$, where $T$ is the kinetic operator, $D$ is the nonlocal strength, and $q$ controls the augmentation overlap. For numerical consistency on a uniform grid, treat $|\\beta\\rangle \\langle \\beta|$ as a rank-one operator constructed from the discretized projector vector with proper grid-weight factors.\n- Define an augmentation energy contribution as $E_{\\mathrm{aug}} = c_{\\mathrm{aug}} \\left(\\langle \\beta | \\psi \\rangle\\right)^2$, with a scalar $c_{\\mathrm{aug}}$ that modulates augmentation energy. This term is not part of the generalized overlap but contributes explicitly to the total energy and its force through the explicit $R$-dependence of $\\beta$.\n\nTasks:\n1. Construct the discrete matrices for $H$ and $S$ on the grid as real symmetric matrices, treating the rank-one projector consistently in the discrete setting.\n2. Solve the generalized eigenvalue problem $H \\phi = \\varepsilon S \\phi$ for the lowest-energy state under USPP and normalize the eigenvector such that $\\phi^T S \\phi = 1$.\n3. Compute the total energy as the sum of local, nonlocal, and augmentation contributions evaluated on the USPP eigenstate. The local contribution is the expectation value of $T + V_{\\mathrm{loc}}$, the nonlocal contribution is the projector energy, and the augmentation contribution is the model $E_{\\mathrm{aug}}$.\n4. Compute the Hellmann–Feynman force on the atom in the USPP case by explicitly evaluating the derivative contributions from the local potential and nonlocal projector, and include the overlap operator contribution dependent on $\\varepsilon$ as required in a generalized eigenproblem. Also include the explicit force from the augmentation energy via its dependence on the projector.\n5. Repeat steps $2$–$4$ for the NC case, where $q = 0$ and $c_{\\mathrm{aug}} = 0$, i.e., $S = I$ and no augmentation energy is included. Use the same $H$ without the overlap modification, solve the standard eigenproblem, and compute the total energy and force contributions accordingly.\n\nGrid-integral convention:\n- Transform the discrete wave function to ensure that the Euclidean dot product corresponds to the physical integral, and construct $H$ and $S$ so that the generalized eigenproblem relates directly to integrals. All projector-based rank-one operators must include the appropriate grid-weight scaling so that $\\langle \\beta | \\psi \\rangle$ approximates the continuous integral.\n\nForce evaluation guidance:\n- Use the Hellmann–Feynman force appropriate for a generalized eigenproblem, which contains the overlap operator term, and compute spatial derivatives of $V_{\\mathrm{loc}}$ and $\\beta$ with respect to $R$ via the identity $\\partial_R f(x-R) = - \\partial_x f(x-R)$ and periodic boundary conditions.\n- The derivative of the projector operator yields symmetric rank-one combinations of $\\partial_R \\beta$ with $\\beta$. Evaluate all terms consistently on the discrete grid with proper weights.\n\nUnits and output:\n- Express energies in Hartree (Ha) and forces in Hartree per Bohr (Ha/$a_0$). Produce each numerical result as a floating-point number.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order $[E_{\\mathrm{USPP}}^{(1)},F_{\\mathrm{USPP}}^{(1)},E_{\\mathrm{NC}}^{(1)},F_{\\mathrm{NC}}^{(1)},E_{\\mathrm{USPP}}^{(2)},F_{\\mathrm{USPP}}^{(2)},E_{\\mathrm{NC}}^{(2)},F_{\\mathrm{NC}}^{(2)},\\dots]$ for all test cases.\n\nTest suite:\nUse the following parameter sets, all in atomic units, with $L = 10.0$, $N = 256$, $v_0 = -5.0$, $\\sigma_v = 0.5$, $\\beta_0 = 1.0$, $\\sigma_\\beta = 0.4$:\n- Case $1$: $R = 3.0$, $D = 0.5$, $q = 0.2$, $c_{\\mathrm{aug}} = 0.1$.\n- Case $2$ (NC boundary): $R = 3.0$, $D = 0.5$, $q = 0.0$, $c_{\\mathrm{aug}} = 0.0$.\n- Case $3$ (no nonlocal, augmentation-only overlap): $R = 5.0$, $D = 0.0$, $q = 0.6$, $c_{\\mathrm{aug}} = 0.2$.\n- Case $4$ (strong augmentation): $R = 7.5$, $D = 0.5$, $q = 1.0$, $c_{\\mathrm{aug}} = 0.5$.\n\nYour implementation must be fully self-contained, make no assumptions beyond the information above, and produce the final output in the exact format specified.", "solution": "The problem requires the calculation of ground-state energies and atomic forces for a one-dimensional periodic system described by both Ultrasoft (USPP) and Norm-Conserving (NC) pseudopotentials. The solution involves discretizing the Kohn-Sham equations on a real-space grid and solving the resulting matrix eigenvalue problem. All calculations are performed in atomic units ($\\hbar=1$, $m_e=1$, $e=1$).\n\nThe core of the problem lies in the generalized eigenvalue equation $H\\phi = \\varepsilon S\\phi$. In the USPP formalism, both the Hamiltonian $H$ and the overlap operator $S$ are modified by a nonlocal projector $|\\beta\\rangle$. The total energy is a sum of expectation values and an explicit augmentation term. The force is derived using the Hellmann-Feynman theorem, generalized for a non-unitary overlap operator.\n\nFirst, we establish the continuous formulation. The system is described by a single electron in a periodic cell of length $L$. The Hamiltonian operator is given as $H = T + V_{\\mathrm{loc}} + D |\\beta\\rangle \\langle \\beta|$, where $T = -\\frac{1}{2} \\frac{d^2}{dx^2}$ is the kinetic energy operator, $V_{\\mathrm{loc}}(x, R)$ is a local potential centered at the atomic position $R$, and $D |\\beta\\rangle \\langle \\beta|$ is a nonlocal projector operator with strength $D$. The projector function is $\\beta(x, R)$. For USPP, the overlap operator is $S = I + q |\\beta\\rangle \\langle \\beta|$, where $I$ is the identity operator and $q$ is the augmentation charge parameter. The total energy is defined as the sum of the expectation value of the kinetic and local potential operators, the nonlocal projector energy, and a separate augmentation energy term:\n$$\nE_{\\text{USPP}} = \\frac{\\langle \\phi | T + V_{\\mathrm{loc}} | \\phi \\rangle}{\\langle \\phi | S | \\phi \\rangle} + D \\frac{(\\langle \\phi | \\beta \\rangle)^2}{\\langle \\phi | S | \\phi \\rangle} + c_{\\mathrm{aug}} \\frac{(\\langle \\phi | \\beta \\rangle)^2}{\\langle \\phi | S | \\phi \\rangle}\n$$\nwhere all inner products $\\langle f | g \\rangle$ imply the integral $\\int f^*(x) g(x) dx$. The eigenfunction $\\phi$ is normalized such that $\\langle \\phi | S | \\phi \\rangle = 1$. With this normalization, the eigenvalue $\\varepsilon$ of the generalized eigenproblem corresponds to the sum of the first two terms, $\\varepsilon = \\langle \\phi | H | \\phi \\rangle = \\langle \\phi | T + V_{\\mathrm{loc}} | \\phi \\rangle + D (\\langle \\phi | \\beta \\rangle)^2$. Therefore, the total energy is simplified to $E_{\\text{USPP}} = \\varepsilon + E_{\\text{aug}}$, where $E_{\\text{aug}} = c_{\\mathrm{aug}}(\\langle \\phi | \\beta \\rangle)^2$.\n\nTo solve this numerically, we discretize the system on a uniform grid of $N$ points $\\{x_i\\}$ over the cell length $L$, with grid spacing $\\Delta x = L/N$. Functions become vectors, e.g., $\\vec{\\psi}$ with components $\\psi_i = \\psi(x_i)$. Integrals are approximated by summations: $\\int f(x) dx \\approx \\sum_i f(x_i) \\Delta x$. An inner product is thus $\\langle f|g \\rangle \\approx (\\vec{f}^T \\vec{g}) \\Delta x$.\n\nThe operators become $N \\times N$ matrices.\nThe kinetic energy operator $T$ is represented by a matrix $\\mathbf{T}$. Using a second-order central difference approximation for the second derivative, $\\frac{d^2\\psi}{dx^2}\\Big|_{x_i} \\approx \\frac{\\psi_{i+1} - 2\\psi_i + \\psi_{i-1}}{\\Delta x^2}$, the matrix elements of $\\mathbf{T}$ are:\n$$\n\\mathbf{T}_{ij} = \\begin{cases} 1/\\Delta x^2 & i=j \\\\ -1/(2\\Delta x^2) & |i-j|=1 \\text{ or } (N-1) \\text{ (periodic)} \\\\ 0 & \\text{otherwise} \\end{cases}\n$$\nThe local potential $V_{\\mathrm{loc}}(x) = v_0 \\exp\\left(-\\frac{d(x,R)^2}{2 \\sigma_v^2}\\right)$, where $d(x,R)$ is the periodic distance, becomes a diagonal matrix $\\mathbf{V}_{\\mathrm{loc}}$ with elements $(\\mathbf{V}_{\\mathrm{loc}})_{ii} = V_{\\mathrm{loc}}(x_i)$.\n\nThe nonlocal projector operator $|\\beta\\rangle\\langle\\beta|$ acts on a wavefunction $\\psi$ as $\\beta(x) \\int \\beta(x')\\psi(x')dx'$. In discrete form, its action on a vector $\\vec{\\psi}$ is a vector whose $i$-th component is $\\beta_i \\sum_j \\beta_j \\psi_j \\Delta x$. This corresponds to the matrix operation $(\\Delta x \\cdot \\vec{\\beta}\\vec{\\beta}^T)\\vec{\\psi}$. The matrix representations are thus:\n$$\n\\mathbf{H} = \\mathbf{T} + \\mathbf{V}_{\\mathrm{loc}} + D \\Delta x (\\vec{\\beta}\\vec{\\beta}^T)\n$$\n$$\n\\mathbf{S} = \\mathbf{I} + q \\Delta x (\\vec{\\beta}\\vec{\\beta}^T)\n$$\nwhere $\\mathbf{I}$ is the identity matrix and $\\vec{\\beta}$ is the vector of projector values $\\beta(x_i)$. The generalized eigenvalue problem becomes the matrix equation $\\mathbf{H}\\vec{\\phi}_{\\text{raw}} = \\varepsilon \\mathbf{S}\\vec{\\phi}_{\\text{raw}}$. Standard numerical solvers yield eigenvectors $\\vec{\\phi}_{\\text{raw}}$ normalized such that $\\vec{\\phi}_{\\text{raw}}^T \\mathbf{S} \\vec{\\phi}_{\\text{raw}} = 1$. The physical wavefunction vector $\\vec{\\phi}$ which satisfies the continuous normalization condition $\\langle \\phi | S | \\phi \\rangle = \\vec{\\phi}^T \\mathbf{S} \\vec{\\phi} \\Delta x = 1$ is related to the solver's output by $\\vec{\\phi} = \\vec{\\phi}_{\\text{raw}} / \\sqrt{\\Delta x}$.\n\nThe total energy is computed from the lowest eigenvalue $\\varepsilon$ and the corresponding eigenvector $\\vec{\\phi}$.\n$$\nE_{\\text{USPP}} = \\varepsilon + c_{\\mathrm{aug}} (\\vec{\\phi}^T \\vec{\\beta} \\Delta x)^2\n$$\nThe force on the atom is $F = -dE_{\\text{tot}}/dR$. Applying the Hellmann-Feynman theorem to the generalized eigenproblem part ($\\varepsilon$) and adding the explicit derivative of the augmentation term gives:\n$$\nF = - \\left( \\frac{d\\varepsilon}{dR} + \\frac{\\partial E_{\\text{aug}}}{\\partial R} \\right) = - \\left( \\langle \\phi | \\frac{\\partial H}{\\partial R} - \\varepsilon \\frac{\\partial S}{\\partial R} | \\phi \\rangle_{\\text{cont}} + \\frac{\\partial E_{\\text{aug}}}{\\partial R} \\right)\n$$\nThe operator derivatives depend on the derivatives of $V_{\\mathrm{loc}}(x,R)$ and $\\beta(x,R)$ with respect to $R$. Using the property $\\partial_R f(x-R) = -\\partial_x f(x-R)$, we compute these derivatives via central differences on the grid. Let $\\vec{V}' = \\partial_R \\vec{V}_{\\text{loc}}$ and $\\vec{\\beta}' = \\partial_R \\vec{\\beta}$. The force contributions are:\n$\\langle \\phi | \\partial_R V_{\\mathrm{loc}} | \\phi \\rangle = (\\vec{\\phi}^T \\text{diag}(\\vec{V}') \\vec{\\phi}) \\Delta x = ((\\vec{\\phi} \\circ \\vec{\\phi})^T \\vec{V}') \\Delta x$.\n$\\langle \\phi | \\partial_R (|\\beta\\rangle\\langle\\beta|) | \\phi \\rangle = 2 \\langle \\phi|\\beta \\rangle \\langle \\phi|\\beta' \\rangle = 2 C C'$, where $C = \\vec{\\phi}^T \\vec{\\beta} \\Delta x$ and $C' = \\vec{\\phi}^T \\vec{\\beta}' \\Delta x$.\nCombining terms, the total force is:\n$$\nF_{\\text{USPP}} = - \\left[ ((\\vec{\\phi} \\circ \\vec{\\phi})^T \\vec{V}') \\Delta x + 2(D - \\varepsilon q)CC' + 2c_{\\mathrm{aug}}CC' \\right]\n$$\n$$\nF_{\\text{USPP}} = - \\left[ ((\\vec{\\phi} \\circ \\vec{\\phi})^T \\vec{V}') \\Delta x + 2(D + c_{\\mathrm{aug}} - \\varepsilon q)CC' \\right]\n$$\nwhere $\\circ$ denotes the element-wise product.\n\nThe Norm-Conserving (NC) case is handled by setting $q=0$ and $c_{\\mathrm{aug}}=0$. This simplifies the overlap to $S=I$, making the problem a standard eigenvalue problem. The total energy becomes $E_{\\text{NC}} = \\varepsilon_{\\text{NC}}$, and the force expression simplifies to:\n$$\nF_{\\text{NC}} = - \\left[ ((\\vec{\\phi}_{\\text{NC}} \\circ \\vec{\\phi}_{\\text{NC}})^T \\vec{V}') \\Delta x + 2D C_{\\text{NC}}C'_{\\text{NC}} \\right]\n$$\nNote that the NC wavefunction $\\vec{\\phi}_{\\text{NC}}$ is found by solving the standard eigenproblem with $S=I$ and will differ from the USPP wavefunction. For each test case, we first perform the full USPP calculation, then repeat with $q=0$ and $c_{\\mathrm{aug}}=0$ to obtain the corresponding NC results.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import eigh\n\ndef solve():\n    \"\"\"\n    Solves the 1D pseudopotential problem for a given set of test cases.\n    \"\"\"\n    # --- Global System Parameters (atomic units) ---\n    L = 10.0\n    N = 256\n    v0 = -5.0\n    sigma_v = 0.5\n    beta0 = 1.0\n    sigma_beta = 0.4\n\n    # --- Test Suite ---\n    test_cases = [\n        # (R, D, q, c_aug)\n        (3.0, 0.5, 0.2, 0.1),\n        (3.0, 0.5, 0.0, 0.0),\n        (5.0, 0.0, 0.6, 0.2),\n        (7.5, 0.5, 1.0, 0.5),\n    ]\n\n    # --- Grid Setup ---\n    dx = L / N\n    x_grid = np.linspace(0, L, N, endpoint=False)\n\n    # --- Helper Functions ---\n    def periodic_distance(x, R):\n        \"\"\"Calculates the nearest-image periodic distance.\"\"\"\n        d = np.abs(x - R)\n        return np.minimum(d, L - d)\n\n    def get_kinetic_matrix(n_points, grid_spacing):\n        \"\"\"Constructs the kinetic energy operator matrix T.\"\"\"\n        T = np.zeros((n_points, n_points), dtype=float)\n        factor = -0.5 / (grid_spacing**2)\n        diag_val = -2.0 * factor\n        offdiag_val = 1.0 * factor\n        for i in range(n_points):\n            T[i, i] = diag_val\n            T[i, (i - 1 + n_points) % n_points] = offdiag_val\n            T[i, (i + 1) % n_points] = offdiag_val\n        return T\n\n    def get_gradient(f, grid_spacing):\n        \"\"\"Calculates the spatial gradient of f using periodic central differences.\"\"\"\n        return (np.roll(f, -1) - np.roll(f, 1)) / (2 * grid_spacing)\n\n    T_mat = get_kinetic_matrix(N, dx)\n\n    # --- Main Calculation Function ---\n    def solve_case(R, D, q, c_aug):\n        \"\"\"\n        Calculates energy and force for a single parameter set.\n        \"\"\"\n        # A. Build operators on the grid\n        V_loc_vec = v0 * np.exp(-periodic_distance(x_grid, R)**2 / (2 * sigma_v**2))\n        beta_vec = beta0 * np.exp(-periodic_distance(x_grid, R)**2 / (2 * sigma_beta**2))\n        \n        V_loc_mat = np.diag(V_loc_vec)\n        beta_proj = np.outer(beta_vec, beta_vec)\n        \n        # Construct Hamiltonian H and Overlap S matrices\n        H_mat = T_mat + V_loc_mat + D * dx * beta_proj\n        S_mat = np.identity(N) + q * dx * beta_proj\n        \n        # B. Solve the generalized eigenvalue problem H*phi = eps*S*phi\n        # eigh returns eigenvalues in ascending order. We need the lowest one.\n        eps_all, phi_raw_mat = eigh(H_mat, S_mat)\n        eps = eps_all[0]\n        # The eigenvector corresponding to the lowest eigenvalue\n        phi_raw = phi_raw_mat[:, 0]\n        \n        # C. Calculate Total Energy\n        # The solver provides phi_raw normalized as phi_raw^T * S * phi_raw = 1.\n        # The physical wavefunction phi, normalized as integral(phi*S*phi) = 1,\n        # is phi = phi_raw / sqrt(dx).\n        # The total energy is E = eps + E_aug.\n        \n        # We need the physical wavefunction to calculate C and C'.\n        phi = phi_raw / np.sqrt(dx)\n        \n        C = np.dot(phi, beta_vec) * dx\n        E_aug = c_aug * C**2\n        E_total = eps + E_aug\n        \n        # D. Calculate Hellmann-Feynman Force\n        # Force contributions from the local potential and nonlocal projectors.\n        # d/dR = -d/dx for functions of (x-R).\n        V_loc_grad_vec = -get_gradient(V_loc_vec, dx)\n        beta_grad_vec = -get_gradient(beta_vec, dx)\n        \n        # Term from local potential: <phi|dV_loc/dR|phi>\n        force_V_loc_term = np.dot(phi**2, V_loc_grad_vec) * dx\n        \n        # Term from projectors: 2*(D+c_aug-eps*q)*<phi|beta><phi|d(beta)/dR>\n        C_prime = np.dot(phi, beta_grad_vec) * dx\n        force_proj_term = 2 * (D + c_aug - eps * q) * C_prime * C\n        \n        F_total = -(force_V_loc_term + force_proj_term)\n        \n        return E_total, F_total\n\n    results = []\n    # Loop over all test cases provided in the problem statement\n    for case in test_cases:\n        R, D, q_uspp, c_aug_uspp = case\n\n        # Perform the USPP calculation with the given parameters\n        E_uspp, F_uspp = solve_case(R, D, q_uspp, c_aug_uspp)\n        \n        # Perform the NC calculation by setting q=0 and c_aug=0\n        E_nc, F_nc = solve_case(R, D, q=0.0, c_aug=0.0)\n\n        results.extend([E_uspp, F_uspp, E_nc, F_nc])\n\n    # Format the final output string exactly as specified\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3481350"}]}