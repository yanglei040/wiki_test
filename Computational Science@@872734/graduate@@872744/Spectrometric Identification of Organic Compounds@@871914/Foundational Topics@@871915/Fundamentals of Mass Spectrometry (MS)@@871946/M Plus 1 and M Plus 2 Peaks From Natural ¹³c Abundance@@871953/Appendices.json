{"hands_on_practices": [{"introduction": "This first practice exercise grounds our theoretical discussion in a fundamental application: estimating the number of carbon atoms in a molecule. By deriving and applying the relationship between the $M+1$ peak intensity and elemental composition, you will develop a core skill for interpreting low-resolution mass spectra. This hands-on calculation [@problem_id:3711270] solidifies the statistical origin of the $M+1$ peak and provides a quick method for proposing a molecular formula.", "problem": "An unknown, straight-chain hydrocarbon is analyzed by Gas Chromatography–Mass Spectrometry (GC–MS) using Electron Ionization (EI) at $70~\\text{eV}$, and a high-resolution analyzer such that isotope peak clusters are fully resolved. The molecular ion shows a measured isotopologue intensity ratio $I_{M+1}/I_{M} = 0.132$. Assume the molecule is a saturated acyclic alkane, so that its stoichiometry is $ \\mathrm{C}_{n_{\\mathrm{C}}}\\mathrm{H}_{n_{\\mathrm{H}}} $ with $ n_{\\mathrm{H}} = 2 n_{\\mathrm{C}} + 2 $. Use the following well-established facts:\n\n- Natural isotopic mole fractions: $^{\\text{13}}\\mathrm{C}$ has $p_{\\mathrm{C}} = 0.0107$, and $^{\\text{2}}\\mathrm{H}$ (deuterium) has $p_{\\mathrm{H}} = 1.55 \\times 10^{-4}$.\n- Isotopic substitutions at distinct atomic sites occur independently.\n- The measured $I_{M+k}$ reflects the relative abundance of isotopologues whose total heavy-isotope mass increment is $k$, and the molecular ion formation and detection efficiencies are assumed identical across isotopologues of the same molecule.\n\nStarting from the binomial statistics of independent isotopic substitutions and the definition of the monoisotopic molecular ion as the isotopologue containing only $^{\\text{12}}\\mathrm{C}$ and $^{\\text{1}}\\mathrm{H}$, derive a leading-order expression for the ratio $I_{M+1}/I_{M}$ for a hydrocarbon $ \\mathrm{C}_{n_{\\mathrm{C}}}\\mathrm{H}_{n_{\\mathrm{H}}} $ that retains only single-substitution contributions. Then, using the alkane stoichiometry stated above and the measured ratio $0.132$, determine $n_{\\mathrm{C}}$. Justify neglect of higher-order substitutions in your expression, and in your reasoning, identify physical or chemical factors that could cause deviations from the ideal estimate. Express your final $n_{\\mathrm{C}}$ as an integer.", "solution": "The problem requires the determination of the number of carbon atoms, $n_{\\mathrm{C}}$, in a saturated acyclic alkane with stoichiometry $\\mathrm{C}_{n_{\\mathrm{C}}}\\mathrm{H}_{n_{\\mathrm{H}}}$, where $n_{\\mathrm{H}} = 2 n_{\\mathrm{C}} + 2$. This is to be achieved by analyzing the measured intensity ratio of the $(M+1)$ isotopologue peak to the monoisotopic peak, $I_{M+1}/I_{M}$, from a mass spectrum.\n\nFirst, we derive the leading-order expression for the ratio $I_{M+1}/I_{M}$. The intensity of a given isotopologue peak in a mass spectrum is proportional to its natural abundance, assuming uniform ionization and detection efficiencies. Let the natural isotopic mole fraction (abundance) of $^{\\text{13}}\\mathrm{C}$ be $p_{\\mathrm{C}} = 0.0107$ and that of $^{\\text{2}}\\mathrm{H}$ (deuterium) be $p_{\\mathrm{H}} = 1.55 \\times 10^{-4}$. Consequently, the abundances of the most common light isotopes, $^{\\text{12}}\\mathrm{C}$ and $^{\\text{1}}\\mathrm{H}$, are $(1-p_{\\mathrm{C}})$ and $(1-p_{\\mathrm{H}})$, respectively.\n\nThe monoisotopic molecular ion, designated $M$, is composed exclusively of the most abundant, lightest isotopes. For a hydrocarbon $\\mathrm{C}_{n_{\\mathrm{C}}}\\mathrm{H}_{n_{\\mathrm{H}}}$, this corresponds to the species containing $n_{\\mathrm{C}}$ atoms of $^{\\text{12}}\\mathrm{C}$ and $n_{\\mathrm{H}}$ atoms of $^{\\text{1}}\\mathrm{H}$. Assuming isotopic substitutions are independent events, the probability of this specific isotopic combination, $P(M)$, is the product of the probabilities for each atom. The intensity $I_{M}$ is proportional to this probability:\n$$ I_{M} \\propto P(M) = (1-p_{\\mathrm{C}})^{n_{\\mathrm{C}}} (1-p_{\\mathrm{H}})^{n_{\\mathrm{H}}} $$\n\nThe $(M+1)$ peak represents all isotopologues that have a nominal mass one unit greater than the monoisotopic mass. For a hydrocarbon, this arises from two primary, mutually exclusive events:\n1.  The presence of exactly one $^{\\text{13}}\\mathrm{C}$ atom and $(n_{\\mathrm{C}}-1)$ $^{\\text{12}}\\mathrm{C}$ atoms, with all $n_{\\mathrm{H}}$ hydrogen atoms being $^{\\text{1}}\\mathrm{H}$.\n2.  The presence of exactly one $^{\\text{2}}\\mathrm{H}$ atom and $(n_{\\mathrm{H}}-1)$ $^{\\text{1}}\\mathrm{H}$ atoms, with all $n_{\\mathrm{C}}$ carbon atoms being $^{\\text{12}}\\mathrm{C}$.\n\nThe probability of the first event is given by the binomial distribution for selecting one atom out of $n_{\\mathrm{C}}$ to be $^{\\text{13}}\\mathrm{C}$, multiplied by the probability that all hydrogens are $^{\\text{1}}\\mathrm{H}$:\n$$ P(\\text{one } ^{13}\\mathrm{C}) = \\binom{n_{\\mathrm{C}}}{1} p_{\\mathrm{C}}^{1} (1-p_{\\mathrm{C}})^{n_{\\mathrm{C}}-1} \\times (1-p_{\\mathrm{H}})^{n_{\\mathrm{H}}} $$\nSimilarly, the probability of the second event is:\n$$ P(\\text{one } ^{2}\\mathrm{H}) = \\binom{n_{\\mathrm{H}}}{1} p_{\\mathrm{H}}^{1} (1-p_{\\mathrm{H}})^{n_{\\mathrm{H}}-1} \\times (1-p_{\\mathrm{C}})^{n_{\\mathrm{C}}} $$\nThe total probability for the $(M+1)$ species, $P(M+1)$, is the sum of these probabilities. The intensity $I_{M+1}$ is proportional to this sum:\n$$ I_{M+1} \\propto P(M+1) = n_{\\mathrm{C}} p_{\\mathrm{C}} (1-p_{\\mathrm{C}})^{n_{\\mathrm{C}}-1} (1-p_{\\mathrm{H}})^{n_{\\mathrm{H}}} + n_{\\mathrm{H}} p_{\\mathrm{H}} (1-p_{\\mathrm{H}})^{n_{\\mathrm{H}}-1} (1-p_{\\mathrm{C}})^{n_{\\mathrm{C}}} $$\nThe intensity ratio $I_{M+1}/I_{M}$ is the ratio of their respective probabilities:\n$$ \\frac{I_{M+1}}{I_{M}} = \\frac{n_{\\mathrm{C}} p_{\\mathrm{C}} (1-p_{\\mathrm{C}})^{n_{\\mathrm{C}}-1} (1-p_{\\mathrm{H}})^{n_{\\mathrm{H}}} + n_{\\mathrm{H}} p_{\\mathrm{H}} (1-p_{\\mathrm{H}})^{n_{\\mathrm{H}}-1} (1-p_{\\mathrm{C}})^{n_{\\mathrm{C}}}}{(1-p_{\\mathrm{C}})^{n_{\\mathrm{C}}} (1-p_{\\mathrm{H}})^{n_{\\mathrm{H}}}} $$\nSimplifying this expression by dividing each term in the numerator by the denominator yields:\n$$ \\frac{I_{M+1}}{I_{M}} = \\frac{n_{\\mathrm{C}} p_{\\mathrm{C}}}{1-p_{\\mathrm{C}}} + \\frac{n_{\\mathrm{H}} p_{\\mathrm{H}}}{1-p_{\\mathrm{H}}} $$\nThe problem asks for a leading-order expression. Since the isotopic abundances $p_{\\mathrm{C}}$ and $p_{\\mathrm{H}}$ are very small compared to $1$ ($p_{\\mathrm{C}} \\approx 10^{-2}$, $p_{\\mathrm{H}} \\approx 10^{-4}$), we can use the first-order Taylor approximation $1/(1-x) \\approx 1+x$ for small $x$, or more simply, approximate the denominators as $1-p_{\\mathrm{C}} \\approx 1$ and $1-p_{\\mathrm{H}} \\approx 1$. This simplification gives the leading-order expression:\n$$ \\frac{I_{M+1}}{I_{M}} \\approx n_{\\mathrm{C}} p_{\\mathrm{C}} + n_{\\mathrm{H}} p_{\\mathrm{H}} $$\nThis approximation is justified because it neglects terms of order $p^2$ and higher. For instance, the next term in the expansion for carbon is $n_{\\mathrm{C}} p_{\\mathrm{C}}^2$, which is significantly smaller than $n_{\\mathrm{C}} p_{\\mathrm{C}}$.\n\nThe neglect of higher-order substitutions (e.g., two $^{\\text{13}}\\mathrm{C}$ atoms, or one $^{\\text{13}}\\mathrm{C}$ and one $^{\\text{2}}\\mathrm{H}$) is justified on the same grounds. These events contribute to the $M+2$ peak. Their probabilities are proportional to products of small abundance values, such as $p_{\\mathrm{C}}^2$, $p_{\\mathrm{H}}^2$, or $p_{\\mathrm{C}}p_{\\mathrm{H}}$. For example, the probability of having two $^{\\text{13}}\\mathrm{C}$ atoms is approximately $\\binom{n_{\\mathrm{C}}}{2} p_{\\mathrm{C}}^2$. Since $p_{\\mathrm{C}} \\approx 0.01$, $p_{\\mathrm{C}}^2 \\approx 10^{-4}$, which is two orders of magnitude smaller. Thus, the probability of a double substitution is negligible compared to that of a single substitution, validating the use of the leading-order expression for the $I_{M+1}/I_{M}$ ratio.\n\nNow, we use this derived expression to find $n_{\\mathrm{C}}$. We are given that the molecule is a saturated acyclic alkane, so $n_{\\mathrm{H}} = 2 n_{\\mathrm{C}} + 2$. Substituting this into the approximate formula:\n$$ \\frac{I_{M+1}}{I_{M}} \\approx n_{\\mathrm{C}} p_{\\mathrm{C}} + (2 n_{\\mathrm{C}} + 2) p_{\\mathrm{H}} $$\nWe can rearrange this to solve for $n_{\\mathrm{C}}$:\n$$ \\frac{I_{M+1}}{I_{M}} \\approx n_{\\mathrm{C}}(p_{\\mathrm{C}} + 2p_{\\mathrm{H}}) + 2p_{\\mathrm{H}} $$\n$$ n_{\\mathrm{C}} \\approx \\frac{\\frac{I_{M+1}}{I_{M}} - 2p_{\\mathrm{H}}}{p_{\\mathrm{C}} + 2p_{\\mathrm{H}}} $$\nUsing the provided numerical values: $I_{M+1}/I_{M} = 0.132$, $p_{\\mathrm{C}} = 0.0107$, and $p_{\\mathrm{H}} = 1.55 \\times 10^{-4}$.\n$$ n_{\\mathrm{C}} \\approx \\frac{0.132 - 2(1.55 \\times 10^{-4})}{0.0107 + 2(1.55 \\times 10^{-4})} $$\n$$ n_{\\mathrm{C}} \\approx \\frac{0.132 - 0.00031}{0.0107 + 0.00031} $$\n$$ n_{\\mathrm{C}} \\approx \\frac{0.13169}{0.01101} $$\n$$ n_{\\mathrm{C}} \\approx 11.961 $$\nSince the number of atoms $n_{\\mathrm{C}}$ must be an integer, we round the result to the nearest integer, which is $12$. Thus, the hydrocarbon is inferred to be $\\mathrm{C}_{12}\\mathrm{H}_{26}$.\n\nFinally, several factors could cause the experimental ratio to deviate from the ideal estimate:\n1.  **Kinetic Isotope Effects (KIEs)**: The assumption of identical ionization and fragmentation efficiency for all isotopologues may not hold perfectly. Heavier isotopes form slightly stronger bonds, which can lead to small differences in fragmentation rates upon electron ionization. This could alter the relative abundance of the observed molecular ions.\n2.  **Co-eluting Impurities**: In GC-MS, another substance eluting from the gas chromatograph at the same retention time could contribute interfering ions at the $m/z$ values of $M$ or $M+1$.\n3.  **Ion-Molecule Reactions**: At non-ideal vacuum conditions in the ion source, reactions between ions and neutral molecules (e.g., protonation to form $[M+H]^+$) can occur, which would artificially increase the intensity of the $M+1$ signal.\n4.  **Natural Variation in Isotopic Abundance**: The values of $p_{\\mathrm{C}}$ and $p_{\\mathrm{H}}$ are global averages. The specific isotopic composition of the sample can vary slightly based on its biological or geological origin.\n\nDespite these potential sources of error, the calculation provides a robust estimate for the number of carbon atoms.", "answer": "$$\\boxed{12}$$", "id": "3711270"}, {"introduction": "Moving from peak intensity to peak position, this problem explores the power of high-resolution mass spectrometry. You will calculate the precise $m/z$ values for isotopologues of a multiply charged ion, highlighting the crucial difference between nominal mass and exact mass. This practice [@problem_id:3711250] is essential for understanding how mass defect allows for unambiguous identification of ions and the interpretation of data from modern instruments like Orbitraps or FT-ICRs.", "problem": "An organic ion in a high-resolution mass spectrometer exhibits a monoisotopic mass $m = 900$ unified atomic mass units and carries a charge $z = 3$. In isotope-resolved mass spectrometry, the presence of carbon-13 ($^{13}\\mathrm{C}$) nuclei in place of carbon-12 ($^{12}\\mathrm{C}$) increases the ion’s mass by the exact difference between the isotopic masses of $^{13}\\mathrm{C}$ and $^{12}\\mathrm{C}$ for each substituted carbon atom. The mass-to-charge ratio $m/z$ is defined as the total ion mass divided by the integer charge state. Use the following well-tested facts: the atomic mass of $^{12}\\mathrm{C}$ is exactly $12.000000000$ unified atomic mass units by definition, and the atomic mass of $^{13}\\mathrm{C}$ is $13.00335483507$ unified atomic mass units. Assuming the charge state remains $z=3$ upon isotopic substitution and neglecting any contributions to mass from changes in electron count, compute the $m/z$ positions for the monoisotopic peak $\\mathrm{M}$, the one-$^{13}\\mathrm{C}$ substituted isotopologue $\\mathrm{M+1}$, and the two-$^{13}\\mathrm{C}$ substituted isotopologue $\\mathrm{M+2}$, using the exact mass shifts divided by $z$. Express the final $m/z$ values in Thomson (Th) and round your answer to six significant figures.", "solution": "The core of the problem is to calculate the mass-to-charge ratio $(m/z)$ for three related ionic species (isotopologues) that differ by the number of $^{13}\\mathrm{C}$ atoms they contain. The mass-to-charge ratio is defined as the ion's mass $m$ divided by its integer charge state $z$.\n\nThe given parameters are:\n- Monoisotopic mass of the ion, $m_0 = 900$ unified atomic mass units (u).\n- Charge state of the ion, $z = 3$.\n- Exact atomic mass of $^{12}\\mathrm{C}$, $m_{^{12}\\mathrm{C}} = 12.000000000 \\text{ u}$.\n- Exact atomic mass of $^{13}\\mathrm{C}$, $m_{^{13}\\mathrm{C}} = 13.00335483507 \\text{ u}$.\n\nFirst, we must determine the exact mass difference, $\\Delta m$, resulting from the substitution of one $^{12}\\mathrm{C}$ atom with one $^{13}\\mathrm{C}$ atom.\n$$ \\Delta m = m_{^{13}\\mathrm{C}} - m_{^{12}\\mathrm{C}} $$\n$$ \\Delta m = 13.00335483507 \\text{ u} - 12.000000000 \\text{ u} = 1.00335483507 \\text{ u} $$\nThis mass difference, often referred to as the \"neutron mass\" in a simplified context, is more accurately the mass of one neutron minus the difference in nuclear binding energy between the two isotopes.\n\nThe problem asks for the $m/z$ positions of three peaks:\n1. The monoisotopic peak ($\\mathrm{M}$): This corresponds to the ion containing only the most abundant, lightest stable isotopes, having the mass $m_0$.\n2. The $\\mathrm{M+1}$ peak: This corresponds to the isotopologue containing one $^{13}\\mathrm{C}$ atom. Its mass, $m_{\\mathrm{M+1}}$, is $m_0 + \\Delta m$.\n3. The $\\mathrm{M+2}$ peak: This corresponds to the isotopologue containing two $^{13}\\mathrm{C}$ atoms. Its mass, $m_{\\mathrm{M+2}}$, is $m_0 + 2\\Delta m$.\n\nWe now calculate the $m/z$ value for each species, using the constant charge state $z=3$. The unit for $m/z$ is the Thomson (Th), where $1 \\text{ Th} = 1 \\text{ u}/e$.\n\nFor the monoisotopic peak, $\\mathrm{M}$:\nThe mass is $m_{\\mathrm{M}} = m_0 = 900 \\text{ u}$.\nThe mass-to-charge ratio is:\n$$ \\left(\\frac{m}{z}\\right)_{\\mathrm{M}} = \\frac{m_0}{z} = \\frac{900}{3} = 300.000000... \\text{ Th} $$\n\nFor the one-$^{13}\\mathrm{C}$ isotopologue, $\\mathrm{M+1}$:\nThe mass is $m_{\\mathrm{M+1}} = m_0 + \\Delta m = 900 + 1.00335483507 = 901.00335483507 \\text{ u}$.\nThe mass-to-charge ratio is:\n$$ \\left(\\frac{m}{z}\\right)_{\\mathrm{M+1}} = \\frac{m_0 + \\Delta m}{z} = \\frac{901.00335483507}{3} = 300.33445161169... \\text{ Th} $$\n\nFor the two-$^{13}\\mathrm{C}$ isotopologue, $\\mathrm{M+2}$:\nThe mass is $m_{\\mathrm{M+2}} = m_0 + 2\\Delta m = 900 + 2 \\times 1.00335483507 = 900 + 2.00670967014 = 902.00670967014 \\text{ u}$.\nThe mass-to-charge ratio is:\n$$ \\left(\\frac{m}{z}\\right)_{\\mathrm{M+2}} = \\frac{m_0 + 2\\Delta m}{z} = \\frac{902.00670967014}{3} = 300.66890322338... \\text{ Th} $$\n\nFinally, we round these results to six significant figures as requested.\n- For $(m/z)_{\\mathrm{M}} = 300.000000...$, the first six significant figures are $3, 0, 0, 0, 0, 0$. The value is $300.000$.\n- For $(m/z)_{\\mathrm{M+1}} = 300.334451...$, the first six significant figures are $3, 0, 0, 3, 3, 4$. The seventh digit is $4$, so we round down. The value is $300.334$.\n- For $(m/z)_{\\mathrm{M+2}} = 300.668903...$, the first six significant figures are $3, 0, 0, 6, 6, 8$. The seventh digit is $9$, so we round up. The value is $300.669$.\n\nThe computed $m/z$ positions for the $\\mathrm{M}$, $\\mathrm{M+1}$, and $\\mathrm{M+2}$ peaks are therefore $300.000 \\text{ Th}$, $300.334 \\text{ Th}$, and $300.669 \\text{ Th}$, respectively.", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n300.000 & 300.334 & 300.669\n\\end{pmatrix}\n}\n$$", "id": "3711250"}, {"introduction": "This final practice challenges you to synthesize your knowledge into a computational model, mimicking the algorithms used in modern spectrometry software. You will develop a program that uses generating functions to predict isotopic patterns for any given elemental formula and then searches for the best fit to experimental data. This advanced exercise [@problem_id:3711248] demonstrates how the first principles of isotopic abundance can be scaled up to solve complex structural elucidation problems, moving from simple estimation to robust formula determination.", "problem": "You must write a complete, runnable program that, given measured, normalized mass spectral peak intensities at $M$, $M+1$, and $M+2$, fits a degree-$2$ multinomial isotope distribution model based on natural isotopic abundances and returns the best-fit nonnegative integer elemental counts for carbon $\\mathrm{C}$, hydrogen $\\mathrm{H}$, nitrogen $\\mathrm{N}$, oxygen $\\mathrm{O}$, sulfur $\\mathrm{S}$, and chlorine $\\mathrm{Cl}$. The program must rely only on the following foundational facts and definitions, and it must not assume any shortcut formulas beyond what can be derived from them.\n\nFoundational base:\n- Natural isotopic abundances (fractional) relevant to $M+1$ and $M+2$ peaks:\n    - Carbon: $\\,^{13}\\mathrm{C}$ abundance $p^{(\\mathrm{C})}_1 = 0.0107$, $p^{(\\mathrm{C})}_2 = 0$.\n    - Hydrogen: $\\,^{2}\\mathrm{H}$ abundance $p^{(\\mathrm{H})}_1 = 0.000115$, $p^{(\\mathrm{H})}_2 = 0$.\n    - Nitrogen: $\\,^{15}\\mathrm{N}$ abundance $p^{(\\mathrm{N})}_1 = 0.00364$, $p^{(\\mathrm{N})}_2 = 0$.\n    - Oxygen: $\\,^{17}\\mathrm{O}$ abundance $p^{(\\mathrm{O})}_1 = 0.00038$, $\\,^{18}\\mathrm{O}$ abundance $p^{(\\mathrm{O})}_2 = 0.00205$.\n    - Sulfur: $\\,^{33}\\mathrm{S}$ abundance $p^{(\\mathrm{S})}_1 = 0.0075$, $\\,^{34}\\mathrm{S}$ abundance $p^{(\\mathrm{S})}_2 = 0.0425$.\n    - Chlorine: $\\,^{37}\\mathrm{Cl}$ abundance $p^{(\\mathrm{Cl})}_2 = 0.2422$, $p^{(\\mathrm{Cl})}_1 = 0$.\n- For each element $e \\in \\{\\mathrm{C},\\mathrm{H},\\mathrm{N},\\mathrm{O},\\mathrm{S},\\mathrm{Cl}\\}$, the probability of the most abundant (monoisotopic) atom within the element is $p^{(e)}_0 = 1 - p^{(e)}_1 - p^{(e)}_2$.\n- The overall $M$, $M+1$, and $M+2$ peak fractions arise from the convolution of independent per-atom isotopic events up to mass-shift order $2$, modeled by the product of per-element degree-$2$ generating polynomials.\n\nYour program must:\n- Take the measured intensities as decimals (fractions, not percentages) for $M$, $M+1$, $M+2$ that are already normalized to sum to $1$ across these three peaks.\n- Search nonnegative integer counts $(n_{\\mathrm{C}}, n_{\\mathrm{H}}, n_{\\mathrm{N}}, n_{\\mathrm{O}}, n_{\\mathrm{S}}, n_{\\mathrm{Cl}})$ within provided bounds for each test case, evaluate the model-predicted $M$, $M+1$, $M+2$ fractions, and minimize the sum of squared residuals between measured and predicted triplets.\n- Break ties by choosing the solution with the smallest total atom count $\\sum_e n_e$, and then by lexicographic order on $(n_{\\mathrm{C}}, n_{\\mathrm{H}}, n_{\\mathrm{N}}, n_{\\mathrm{O}}, n_{\\mathrm{S}}, n_{\\mathrm{Cl}})$.\n- Produce the final output as a single line showing a list of solutions, one per test case, where each solution is the list $[n_{\\mathrm{C}},n_{\\mathrm{H}},n_{\\mathrm{N}},n_{\\mathrm{O}},n_{\\mathrm{S}},n_{\\mathrm{Cl}}]$.\n\nTest suite:\nUse the following measured intensity triplets and search bounds. All intensities are decimals and must be treated as unitless fractions that sum to $1$ over the three peaks.\n\n- Case $1$ (happy path, binomial with two identical atoms): Measured $[M,M+1,M+2] = [0.97871449, 0.02117102, 0.00011449]$. Bounds: $n_{\\mathrm{C}}\\in[0,3]$, $n_{\\mathrm{H}}\\in[0,3]$, $n_{\\mathrm{N}}\\in[0,3]$, $n_{\\mathrm{O}}\\in[0,2]$, $n_{\\mathrm{S}}\\in[0,2]$, $n_{\\mathrm{Cl}}\\in[0,2]$.\n- Case $2$ (edge with dominant $M+2$ element): Measured $[M,M+1,M+2] = [0.7578, 0.0, 0.2422]$. Bounds: $n_{\\mathrm{C}}\\in[0,3]$, $n_{\\mathrm{H}}\\in[0,3]$, $n_{\\mathrm{N}}\\in[0,3]$, $n_{\\mathrm{O}}\\in[0,2]$, $n_{\\mathrm{S}}\\in[0,2]$, $n_{\\mathrm{Cl}}\\in[0,2]$.\n- Case $3$ (single element with both $+1$ and $+2$ isotopes): Measured $[M,M+1,M+2] = [0.99757, 0.00038, 0.00205]$. Bounds: $n_{\\mathrm{C}}\\in[0,3]$, $n_{\\mathrm{H}}\\in[0,3]$, $n_{\\mathrm{N}}\\in[0,3]$, $n_{\\mathrm{O}}\\in[0,2]$, $n_{\\mathrmS}}\\in[0,2]$, $n_{\\mathrm{Cl}}\\in[0,2]$.\n- Case $4$ (two-element mixture with only $+1$ isotopes): Measured $[M,M+1,M+2] = [0.985698948, 0.014262104, 0.000038948]$. Bounds: $n_{\\mathrm{C}}\\in[0,3]$, $n_{\\mathrm{H}}\\in[0,3]$, $n_{\\mathrm{N}}\\in[0,3]$, $n_{\\mathrm{O}}\\in[0,2]$, $n_{\\mathrm{S}}\\in[0,2]$, $n_{\\mathrm{Cl}}\\in[0,2]$.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each result is the list of six integers in the order $[\\mathrm{C},\\mathrm{H},\\mathrm{N},\\mathrm{O},\\mathrm{S},\\mathrm{Cl}]$, for the four test cases, for example, $[[n_{\\mathrm{C}},n_{\\mathrm{H}},n_{\\mathrm{N}},n_{\\mathrm{O}},n_{\\mathrm{S}},n_{\\mathrm{Cl}}],\\ldots]$. No units are required because the intensities are dimensionless fractions.", "solution": "The user wants to find the best-fit elemental formula $(n_{\\mathrm{C}}, n_{\\mathrm{H}}, n_{\\mathrm{N}}, n_{\\mathrm{O}}, n_{\\mathrm{S}}, n_{\\mathrm{Cl}})$ for a molecule, given the measured relative intensities of its mass spectral peaks at masses $M$, $M+1$, and $M+2$. The solution must be derived from first principles using a generating function model for isotopic distributions.\n\n### Principle-Based Design\n\nThe solution is based on modeling the isotopic distribution of a molecule as a convolution of the isotopic distributions of its constituent atoms. This is elegantly handled using probability generating functions, which are polynomials where the coefficient of $x^k$ represents the probability of a mass shift of $+k$ relative to the monoisotopic mass.\n\n1.  **Single-Atom Isotope Distribution and Generating Functions:**\n    For each element $e \\in \\{\\mathrm{C}, \\mathrm{H}, \\mathrm{N}, \\mathrm{O}, \\mathrm{S}, \\mathrm{Cl}\\}$, the natural abundances of its isotopes lead to a probability distribution for an atom's mass. We are interested in the mass shifts of $0$, $+1$, and $+2$ Daltons relative to the most abundant (monoisotopic) isotope. Let these probabilities be $p_0^{(e)}$, $p_1^{(e)}$, and $p_2^{(e)}$, respectively. The problem provides the values for $p_1^{(e)}$ and $p_2^{(e)}$, and defines $p_0^{(e)} = 1 - p_1^{(e)} - p_2^{(e)}$.\n\n    The probability distribution for a single atom of element $e$ can be captured by a degree-$2$ polynomial, its generating function $P^{(e)}(x)$:\n    $$P^{(e)}(x) = p_0^{(e)} + p_1^{(e)}x + p_2^{(e)}x^2$$\n    Here, the term $p_k^{(e)}x^k$ signifies a probability $p_k^{(e)}$ of observing a mass shift of $+k$.\n\n2.  **Multi-Atom Isotope Distribution via Convolution:**\n    For a molecule containing $n_e$ atoms of element $e$, assuming isotopic incorporation is a set of independent events, the overall probability distribution for these $n_e$ atoms is the $n_e$-fold convolution of the single-atom distribution with itself. In terms of generating functions, this corresponds to raising the single-atom polynomial to the power of $n_e$:\n    $$(P^{(e)}(x))^{n_e}$$\n    For a molecule with a complete elemental formula given by the integer vector $\\mathbf{n} = (n_{\\mathrm{C}}, n_{\\mathrm{H}}, n_{\\mathrm{N}}, n_{\\mathrm{O}}, n_{\\mathrm{S}}, n_{\\mathrm{Cl}})$, the total generating function $P_{\\mathbf{n}}(x)$ is the product of the generating functions for each elemental group:\n    $$P_{\\mathbf{n}}(x) = \\prod_{e \\in \\{\\mathrm{C},\\mathrm{H},\\dots\\}} \\left( P^{(e)}(x) \\right)^{n_e}$$\n\n3.  **Extracting Predicted Intensities:**\n    Expanding the product $P_{\\mathbf{n}}(x)$ yields a new polynomial, $P_{\\mathbf{n}}(x) = C_0 + C_1 x + C_2 x^2 + C_3 x^3 + \\dots$. The coefficient $C_k$ represents the total probability of an aggregate mass shift of $+k$. Thus, the raw theoretical intensities for the $M$, $M+1$, and $M+2$ peaks are $I_M=C_0$, $I_{M+1}=C_1$, and $I_{M+2}=C_2$.\n\n    Since the problem specifies that the measured intensities are normalized to sum to $1$ over these three peaks, we must apply the same normalization to our predicted intensities for a valid comparison. The normalization constant is $N = C_0 + C_1 + C_2$. The normalized predicted intensity triplet is:\n    $$ \\left[ \\frac{C_0}{N}, \\frac{C_1}{N}, \\frac{C_2}{N} \\right] $$\n    We only need to compute the coefficients up to degree $2$. Given two polynomials $A(x) = a_0 + a_1 x + a_2 x^2$ and $B(x) = b_0 + b_1 x + b_2 x^2$, the coefficients of their product $C(x)=A(x)B(x)$ up to degree $2$ are:\n    - $c_0 = a_0 b_0$\n    - $c_1 = a_0 b_1 + a_1 b_0$\n    - $c_2 = a_0 b_2 + a_1 b_1 + a_2 b_0$\n    This allows for an efficient, truncated polynomial multiplication.\n\n4.  **Optimization and Search Algorithm:**\n    The problem is to find the integer vector $\\mathbf{n}$ that minimizes the discrepancy between the predicted and measured intensities. The objective function is the sum of squared residuals (SSR):\n    $$ \\text{SSR}(\\mathbf{n}) = \\sum_{k=0}^{2} \\left( (\\text{predicted intensity})_k - (\\text{measured intensity})_k \\right)^2 $$\n    The search is performed over a grid of non-negative integer values for each $n_e$, with bounds specified for each test case. Given the small size of the search space, an exhaustive grid search is feasible.\n\n    The algorithm proceeds as follows for each test case:\n    a. Initialize a `min_ssr` to infinity and a `best_solution` to `None`.\n    b. Iterate through every possible formula $\\mathbf{n}$ within the given search bounds.\n    c. For each formula $\\mathbf{n}$:\n        i. Start with an identity polynomial $[1, 0, 0]$, representing $P(x)=1$.\n        ii. For each element $e$, compute $(P^{(e)}(x))^{n_e}$ by repeated truncated multiplication and multiply the result into the total polynomial.\n        iii. Extract the coefficients $[C_0, C_1, C_2]$ of the final polynomial.\n        iv. Normalize these coefficients to get the predicted intensity triplet.\n        v. Compute the SSR against the measured triplet.\n        vi. Compare the computed SSR with `min_ssr`. If it is lower, the current formula $\\mathbf{n}$ becomes the new best solution. If the SSR is identical to `min_ssr` (within a small floating-point tolerance), apply the specified tie-breaking rules: first, select the formula with the smaller total atom count ($\\sum n_e$); if still tied, select the formula that is lexicographically smaller.\n    d. The final `best_solution` for the test case is stored.\n\nThis structured approach guarantees finding the unique optimal solution according to the problem's criteria by systematically deriving theoretical isotope patterns from foundational principles and comparing them against measured data.", "answer": "```python\nimport numpy as np\nimport itertools\n\ndef solve():\n    \"\"\"\n    Fits a multinomial isotope distribution model to find the best-fit elemental counts\n    for C, H, N, O, S, and Cl given measured M, M+1, and M+2 mass spectral intensities.\n    \"\"\"\n\n    # Foundational base: Natural isotopic abundances (fractional)\n    # p_1 is for M+1 isotopes, p_2 is for M+2 isotopes.\n    abundances = {\n        'C': {'p1': 0.0107, 'p2': 0.0},\n        'H': {'p1': 0.000115, 'p2': 0.0},\n        'N': {'p1': 0.00364, 'p2': 0.0},\n        'O': {'p1': 0.00038, 'p2': 0.00205},\n        'S': {'p1': 0.0075, 'p2': 0.0425},\n        'Cl': {'p1': 0.0, 'p2': 0.2422},\n    }\n\n    # Element order for search and output\n    ELEMENT_ORDER = ['C', 'H', 'N', 'O', 'S', 'Cl']\n\n    # Pre-calculate degree-2 generating polynomials for each element\n    # P(x) = p0 + p1*x + p2*x^2, represented as [p0, p1, p2]\n    element_polys = {}\n    for elem, ab in abundances.items():\n        p1, p2 = ab['p1'], ab['p2']\n        p0 = 1.0 - p1 - p2\n        element_polys[elem] = np.array([p0, p1, p2])\n\n    test_cases = [\n        {\n            \"measured\": [0.97871449, 0.02117102, 0.00011449],\n            \"bounds\": {'C': [0, 3], 'H': [0, 3], 'N': [0, 3], 'O': [0, 2], 'S': [0, 2], 'Cl': [0, 2]},\n        },\n        {\n            \"measured\": [0.7578, 0.0, 0.2422],\n            \"bounds\": {'C': [0, 3], 'H': [0, 3], 'N': [0, 3], 'O': [0, 2], 'S': [0, 2], 'Cl': [0, 2]},\n        },\n        {\n            \"measured\": [0.99757, 0.00038, 0.00205],\n            \"bounds\": {'C': [0, 3], 'H': [0, 3], 'N': [0, 3], 'O': [0, 2], 'S': [0, 2], 'Cl': [0, 2]},\n        },\n        {\n            \"measured\": [0.985698948, 0.014262104, 0.000038948],\n            \"bounds\": {'C': [0, 3], 'H': [0, 3], 'N': [0, 3], 'O': [0, 2], 'S': [0, 2], 'Cl': [0, 2]},\n        },\n    ]\n\n    def poly_mul_trunc(p1, p2):\n        \"\"\"Multiplies two degree-2 polynomials and truncates to degree 2.\"\"\"\n        c = np.convolve(p1, p2)\n        return c[:3]\n\n    def poly_pow_trunc(p, n):\n        \"\"\"Computes p^n for a degree-2 polynomial, truncated to degree 2.\"\"\"\n        res = np.array([1.0, 0.0, 0.0]) # Identity polynomial for multiplication\n        if n == 0:\n            return res\n        # Exponentiation by squaring for efficiency\n        base = p\n        while n > 0:\n            if n % 2 == 1:\n                res = poly_mul_trunc(res, base)\n            base = poly_mul_trunc(base, base)\n            n //= 2\n        return res\n\n    final_results = []\n    \n    for case in test_cases:\n        measured_triplet = np.array(case[\"measured\"])\n        bounds = case[\"bounds\"]\n        \n        # Prepare ranges for itertools.product\n        search_ranges = [range(bounds[elem][0], bounds[elem][1] + 1) for elem in ELEMENT_ORDER]\n\n        min_ssr = float('inf')\n        best_formula = None\n        min_total_atoms = float('inf')\n        \n        # Exhaustive grid search over the specified bounds\n        for formula_tuple in itertools.product(*search_ranges):\n            \n            # Skip formula with no atoms\n            if sum(formula_tuple) == 0:\n                continue\n\n            # Calculate total generating polynomial for the formula\n            total_poly = np.array([1.0, 0.0, 0.0])\n            for i, elem in enumerate(ELEMENT_ORDER):\n                n_e = formula_tuple[i]\n                if n_e > 0:\n                    p_e = element_polys[elem]\n                    p_e_pow = poly_pow_trunc(p_e, n_e)\n                    total_poly = poly_mul_trunc(total_poly, p_e_pow)\n\n            # Normalize predicted coefficients to sum to 1\n            norm = np.sum(total_poly)\n            if norm < 1e-12:  # Avoid division by zero\n                continue\n            \n            predicted_triplet = total_poly / norm\n\n            # Calculate sum of squared residuals\n            ssr = np.sum((predicted_triplet - measured_triplet) ** 2)\n\n            # Compare with best-so-far solution\n            # Using a small epsilon for robust float comparison\n            epsilon = 1e-12\n            if ssr < min_ssr - epsilon:\n                min_ssr = ssr\n                best_formula = formula_tuple\n                min_total_atoms = sum(formula_tuple)\n            elif abs(ssr - min_ssr) < epsilon:\n                # Apply tie-breaking rules\n                current_total_atoms = sum(formula_tuple)\n                if current_total_atoms < min_total_atoms:\n                    min_ssr = ssr\n                    best_formula = formula_tuple\n                    min_total_atoms = current_total_atoms\n                elif current_total_atoms == min_total_atoms:\n                    # Lexicographical comparison for the final tie-breaker\n                    if best_formula is None or formula_tuple < best_formula:\n                         best_formula = formula_tuple\n        \n        final_results.append(list(best_formula))\n\n    # Format the final output string without spaces inside each list\n    result_str = '[' + ','.join(f'[{\",\".join(map(str, r))}]' for r in final_results) + ']'\n    print(result_str)\n\nsolve()\n```", "id": "3711248"}]}