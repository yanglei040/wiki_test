{"hands_on_practices": [{"introduction": "The journey into CMB lensing reconstruction begins with building a complete, end-to-end analysis pipeline in a controlled environment. This foundational exercise guides you through developing a Monte Carlo simulation on a flat sky, starting from generating a lensed CMB map and culminating in the recovery of the input lensing power spectrum [@problem_id:3467573]. By implementing the core components—including the quadratic estimator, mean-field bias subtraction, and noise-bias removal—you will gain invaluable hands-on experience with the fundamental mechanics of a lensing analysis and develop a robust intuition for how the estimator performs under various signal and noise conditions.", "problem": "You are tasked with designing a self-contained Monte Carlo pipeline for flat-sky Cosmic Microwave Background (CMB) lensing reconstruction using quadratic estimators. The goal is to generate lensed CMB temperature maps with a known input deflection potential power spectrum $C_L^{\\phi\\phi}$, reconstruct the lensing potential, and demonstrate recovery of an unbiased estimate $\\hat C_L^{\\phi\\phi}$ after subtracting the mean-field and reconstruction noise bias. Your program must implement the following, expressed in purely mathematical terms and using angles in radians.\n\nStarting from fundamental principles and well-tested formulas:\n\n1. Lensing remapping on the flat sky is defined by the scalar deflection potential $\\phi(\\boldsymbol{x})$, where the deflection field is $\\boldsymbol{d}(\\boldsymbol{x}) = \\nabla \\phi(\\boldsymbol{x})$. The observed lensed temperature field satisfies $T_{\\mathrm{obs}}(\\boldsymbol{x}) = T_{\\mathrm{unl}}\\!\\left(\\boldsymbol{x} + \\boldsymbol{d}(\\boldsymbol{x})\\right) + n(\\boldsymbol{x})$, with $n(\\boldsymbol{x})$ denoting instrumental noise. Work in the small-deflection regime using the first-order Taylor expansion $T_{\\mathrm{obs}}(\\boldsymbol{x}) \\approx T_{\\mathrm{unl}}(\\boldsymbol{x}) + \\nabla T_{\\mathrm{unl}}(\\boldsymbol{x}) \\cdot \\nabla \\phi(\\boldsymbol{x}) + n(\\boldsymbol{x})$. This expansion underlies the quadratic estimator by inducing a lensing-driven coupling between otherwise independent Fourier modes of the unlensed CMB.\n\n2. The unlensed CMB temperature $T_{\\mathrm{unl}}(\\boldsymbol{x})$ and the potential $\\phi(\\boldsymbol{x})$ are modeled as statistically isotropic Gaussian random fields on a square, periodic patch of side length $L_{\\mathrm{box}}$ (in radians), represented on an $N \\times N$ grid. The isotropic power spectra $C_\\ell^{TT}$ and $C_L^{\\phi\\phi}$ define the second-moment statistics of the corresponding Fourier modes. Instrumental noise is modeled as uncorrelated Gaussian noise in real space with variance $\\sigma_n^2$ per pixel, corresponding to a white noise power spectrum in Fourier space.\n\n3. Lensing reconstruction is performed from the observed temperature $T_{\\mathrm{obs}}(\\boldsymbol{x})$ using a quadratic estimator built from two filtered temperature fields and a spatial gradient, motivated by the mode coupling derived from the Taylor expansion. The estimator produces a reconstructed potential map $\\hat\\phi(\\boldsymbol{x})$ (or its Fourier representation $\\hat\\phi(\\boldsymbol{L})$). The estimator suffers from two biases that must be removed:\n   - The mean-field bias arises from any anisotropy such as masking or anisotropic noise and appears as a nonzero average $\\langle \\hat\\phi(\\boldsymbol{L}) \\rangle$. It must be estimated and subtracted using a Monte Carlo average over many unlensed simulations with the same anisotropies.\n   - The $N^{(0)}$ (disconnected) reconstruction noise bias appears in the auto-spectrum $\\langle |\\hat\\phi(\\boldsymbol{L})|^2 \\rangle$ even when $C_L^{\\phi\\phi} = 0$. It must be estimated from unlensed Monte Carlo simulations and subtracted in band powers.\n\n4. Since analytic normalization of the quadratic estimator can be complex on a finite, masked patch, you must calibrate the response of the estimator using the cross-spectrum with the known simulated input potential, computing a response factor $R_L$ in bins of $L = |\\boldsymbol{L}|$. This allows unbiased recovery via $\\hat C_L^{\\phi\\phi} \\approx \\left(C_L^{\\mathrm{auto}} - N^{(0)}_L\\right)/R_L^2$, where $C_L^{\\mathrm{auto}}$ is the band power of the mean-field-subtracted reconstruction auto-spectrum and $N^{(0)}_L$ is the estimated noise bias band power.\n\nNumerical setup and constraints:\n\n- Work on a square, periodic flat-sky patch of side length $L_{\\mathrm{box}}$ in radians, with $N \\times N$ pixels. All angles must be treated in radians.\n- Use discrete Fourier transforms with wavevectors $\\boldsymbol{k} = (k_x, k_y)$ whose components are $k_i = 2\\pi n_i / L_{\\mathrm{box}}$ with integer indices $n_i$ defined by the Fourier transform conventions for an $N \\times N$ grid.\n- Generate Gaussian random fields $T_{\\mathrm{unl}}$ and $\\phi$ consistent with their power spectra by filtering white Gaussian fields in Fourier space.\n- Implement a circular apodized mask $M(\\boldsymbol{x})$ with cosine tapering near the patch boundary to induce a mean-field. The mask is characterized by an apodization fraction $f_{\\mathrm{apod}}$ of the half-size (the taper width equals $f_{\\mathrm{apod}} \\times L_{\\mathrm{box}}/2$).\n- Use the first-order Taylor approximation to lens the temperature: $T_{\\mathrm{lens}}(\\boldsymbol{x}) \\approx T_{\\mathrm{unl}}(\\boldsymbol{x}) + \\nabla T_{\\mathrm{unl}}(\\boldsymbol{x}) \\cdot \\nabla \\phi(\\boldsymbol{x})$.\n- Construct the quadratic estimator from two oppositely filtered temperature fields and their gradients, using isotropic filters built from $C_\\ell^{TT}$ and the total temperature power including white noise. Compute the reconstruction in Fourier space and form band powers in bins of $L$.\n\nTest suite and acceptance criteria:\n\nImplement three test cases, each specified by a tuple $(A_\\phi, \\sigma_n, f_{\\mathrm{apod}})$:\n- Case 1 (happy path): $(3\\times 10^{-7}, 5\\times 10^{-6}, 0.10)$.\n- Case 2 (no lensing boundary): $(0, 5\\times 10^{-6}, 0.10)$.\n- Case 3 (high-noise edge): $(3\\times 10^{-7}, 2\\times 10^{-5}, 0.20)$.\n\nUse a fixed $N$ and $L_{\\mathrm{box}}$ across cases, and a fixed $C_\\ell^{TT}$ shape that is physically reasonable and decays at high $\\ell$. Bin the reconstructed spectra into a modest number of $L$ bins spanning low-to-intermediate $L$ where the lensing signal is non-negligible.\n\nFor each case:\n- Estimate and subtract the mean-field and $N^{(0)}$ from unlensed Monte Carlo simulations with the same mask and noise. Use enough Monte Carlo realizations to make the subtraction stable.\n- Calibrate the estimator response $R_L$ by the cross-spectrum of the reconstructed field with the input $\\phi$ for lensed simulations. For $A_\\phi=0$, skip response calibration and set $R_L=1$ by definition.\n- Form the unbiased estimate $\\hat C_L^{\\phi\\phi}$ using $\\hat C_L^{\\phi\\phi} = \\left(C_L^{\\mathrm{auto}} - N^{(0)}_L\\right)/R_L^2$ in each bin.\n\nAcceptance criteria:\n- Case 1 and Case 3: Let $C_{L,\\,\\mathrm{model}}^{\\phi\\phi}$ be the input model band powers computed by bin-averaging the theoretical $C_L^{\\phi\\phi}$. Compute the fractional deviation per bin as $\\Delta = \\left|\\hat C_L^{\\phi\\phi} - C_{L,\\,\\mathrm{model}}^{\\phi\\phi}\\right| / \\left(C_{L,\\,\\mathrm{model}}^{\\phi\\phi} + \\epsilon\\right)$ with $\\epsilon$ a small regularization to avoid division by zero. Accept if the median of $\\Delta$ over bins with non-negligible input signal is below a tolerance. Use $0.6$ for Case 1 and $0.8$ for Case 3.\n- Case 2: With $A_\\phi = 0$, accept if the mean-field-subtracted and $N^{(0)}$-subtracted reconstruction band powers have a maximum absolute value across bins less than $0.2$ times the maximum $N^{(0)}$ band power.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,result3]\"), where each result is a boolean indicating whether the acceptance criteria were met for the corresponding test case.", "solution": "The user-provided problem is assessed as **valid**. It describes a scientifically sound and well-posed task within the field of numerical cosmology, specifically focusing on Cosmic Microwave Background (CMB) lensing reconstruction. The problem is self-contained, with all necessary physical models, numerical procedures, and test criteria clearly defined. No contradictions, factual errors, or infeasible requirements were identified. The task involves implementing a standard, albeit simplified, Monte Carlo pipeline, which is a non-trivial but feasible problem.\n\nI will therefore proceed with a complete solution. The solution is structured to follow the logical flow of a CMB lensing analysis pipeline, from theoretical principles to numerical implementation and verification.\n\n### 1. Theoretical Framework and Model\n\nThe analysis is performed on a square, periodic, flat-sky patch of side length $L_{\\mathrm{box}}$, discretized onto an $N \\times N$ grid. All angular units are in radians.\n\nThe fundamental fields, the unlensed CMB temperature $T_{\\mathrm{unl}}(\\boldsymbol{x})$ and the lensing potential $\\phi(\\boldsymbol{x})$, are modeled as statistically isotropic and homogeneous Gaussian random fields. Their statistical properties are entirely defined by their angular power spectra, $C_\\ell^{TT}$ and $C_L^{\\phi\\phi}$, respectively. The relation between a field $F(\\boldsymbol{x})$ and its power spectrum $C_L^F$ is given by the two-point correlation function of its Fourier modes $\\tilde{F}(\\boldsymbol{L})$:\n$$\n\\langle \\tilde{F}(\\boldsymbol{L}) \\tilde{F}^*(\\boldsymbol{L}') \\rangle = (2\\pi)^2 \\delta^{(2)}(\\boldsymbol{L} - \\boldsymbol{L}') C_L^F\n$$\nwhere $\\boldsymbol{L}$ is the two-dimensional wavevector (or multipole vector) and $L = |\\boldsymbol{L}|$.\n\nThe observed CMB temperature, $T_{\\mathrm{obs}}(\\boldsymbol{x})$, is the unlensed temperature field remapped by the gradient of the lensing potential, $\\boldsymbol{d}(\\boldsymbol{x}) = \\nabla\\phi(\\boldsymbol{x})$, plus instrumental noise $n(\\boldsymbol{x})$:\n$$\nT_{\\mathrm{obs}}(\\boldsymbol{x}) = T_{\\mathrm{unl}}(\\boldsymbol{x} + \\nabla\\phi(\\boldsymbol{x})) + n(\\boldsymbol{x})\n$$\nFor this analysis, we use the first-order Taylor expansion of this relation, valid for small deflection angles:\n$$\nT_{\\mathrm{obs}}(\\boldsymbol{x}) \\approx T_{\\mathrm{unl}}(\\boldsymbol{x}) + \\nabla T_{\\mathrm{unl}}(\\boldsymbol{x}) \\cdot \\nabla \\phi(\\boldsymbol{x}) + n(\\boldsymbol{x})\n$$\nThis expansion reveals a coupling between modes of the CMB and the lensing potential, which is the basis for the quadratic estimator. The instrumental noise $n(\\boldsymbol{x})$ is modeled as a Gaussian random field with a white noise power spectrum, originating from uncorrelated pixel noise with variance $\\sigma_n^2$.\n\n### 2. Numerical Simulation Pipeline\n\n**a. Discretization and Field Generation:**\nWe define a grid of wavevectors $\\boldsymbol{L} = (L_x, L_y)$ where $L_i = 2\\pi n_i/L_{\\mathrm{box}}$ for integer indices $n_i$. A Gaussian random field is generated in Fourier space by creating a grid of complex Gaussian random numbers and scaling them according to the desired power spectrum. For a discrete Fourier transform (DFT) on an $N \\times N$ grid, the variance of the Fourier coefficients $\\tilde{F}_{\\boldsymbol{L}}$ is related to the continuous power spectrum $C_L^F$ by:\n$$\n\\langle |\\tilde{F}_{\\boldsymbol{L}}|^2 \\rangle = \\frac{N^4}{L_{\\mathrm{box}}^2} C_L^F\n$$\nThe generated Fourier field must satisfy the reality condition $\\tilde{F}(\\boldsymbol{L}) = \\tilde{F}^*(-\\boldsymbol{L})$, which is naturally handled when generating complex numbers with independent real and imaginary parts and performing an inverse FFT.\n\n**b. Lensing and Observation:**\nThe Taylor-approximated lensing is implemented by first generating $T_{\\mathrm{unl}}$ and $\\phi$ maps independently. Their gradients, $\\nabla T_{\\mathrm{unl}}$ and $\\nabla \\phi$, are computed efficiently in Fourier space using the property $\\mathcal{F}[\\nabla F(\\boldsymbol{x})] = i\\boldsymbol{L} \\tilde{F}(\\boldsymbol{L})$. The real-space fields are then combined as per the Taylor expansion. Gaussian white noise is added, and finally, a circular apodization mask $M(\\boldsymbol{x})$ with a cosine-tapered edge is applied to the final map to produce the observed data $T_{\\mathrm{obs}}(\\boldsymbol{x})$. The mask is essential for inducing a non-trivial mean-field bias, as is common in realistic observations.\n\n### 3. Lensing Reconstruction with a Quadratic Estimator\n\n**a. Estimator Formulation:**\nThe quadratic estimator reconstructs the lensing potential by correlating pairs of temperature modes. A practical and robust implementation uses a symmetric combination of filtered temperature fields. We define two filtered maps in Fourier space:\n$$\n\\tilde{M}_1(\\boldsymbol{\\ell}) = \\frac{\\tilde{T}_{\\mathrm{obs}}(\\boldsymbol{\\ell})}{C_\\ell^{\\mathrm{tot}}} \\quad \\text{and} \\quad \\tilde{M}_2(\\boldsymbol{\\ell}) = \\frac{\\tilde{T}_{\\mathrm{obs}}(\\boldsymbol{\\ell}) C_\\ell^{TT}}{C_\\ell^{\\mathrm{tot}}}\n$$\nwhere $C_\\ell^{\\mathrm{tot}} = C_\\ell^{TT} + N_\\ell$ is the total power spectrum of the observed data, including signal and noise. An estimator for the deflection field $\\boldsymbol{d}(\\boldsymbol{x})$ is constructed in real space as:\n$$\n\\hat{\\boldsymbol{d}}_{\\mathrm{est}}(\\boldsymbol{x}) = M_1(\\boldsymbol{x}) \\nabla M_2(\\boldsymbol{x}) + M_2(\\boldsymbol{x}) \\nabla M_1(\\boldsymbol{x})\n$$\nThe lensing potential $\\phi$ is related to its deflection field $\\boldsymbol{d}$ by $\\nabla^2\\phi = \\nabla \\cdot \\boldsymbol{d}$. In Fourier space, this becomes $-L^2 \\tilde{\\phi}(\\boldsymbol{L}) = i\\boldsymbol{L} \\cdot \\tilde{\\boldsymbol{d}}(\\boldsymbol{L})$. The unnormalized reconstructed potential in Fourier space is therefore:\n$$\n\\hat{\\phi}_{\\mathrm{unnorm}}(\\boldsymbol{L}) = \\frac{i\\boldsymbol{L} \\cdot \\tilde{\\boldsymbol{d}}_{\\mathrm{est}}(\\boldsymbol{L})}{L^2}\n$$\n\n**b. Bias Subtraction and Calibration:**\nThe raw reconstruction $\\hat{\\phi}_{\\mathrm{unnorm}}$ is biased. We must correct for two primary additive biases and one multiplicative bias.\n\n1.  **Mean-Field Bias ($\\hat{\\phi}_{MF}$):** Anisotropies from the mask cause the estimator to have a non-zero expectation value even for an unlensed sky, $\\langle \\hat{\\phi}_{\\mathrm{unnorm}} \\rangle \\neq 0$. This is the mean-field, which is estimated by averaging reconstructions from a large number ($N_{\\mathrm{MC}}$) of unlensed, noisy simulations that use the same mask. This average, $\\hat{\\phi}_{\\mathrm{MF}}(\\boldsymbol{L})$, is then subtracted from all subsequent reconstructions.\n\n2.  **Reconstruction Noise Bias ($N^{(0)}$):** The auto-power spectrum of the reconstruction, $\\langle |\\hat{\\phi}|^2 \\rangle$, contains a large additive bias from the chance correlations of unlensed CMB modes. This is the $N^{(0)}$ bias. Its power spectrum, $N_L^{(0)}$, is estimated by computing the average power spectrum of the mean-field-subtracted reconstructions from the same set of $N_{\\mathrm{MC}}$ unlensed simulations.\n\n3.  **Response Calibration ($R_L$):** The estimator's response to the true potential is not unity due to filtering, masking, and approximations. The response factor $R_L$ is determined by cross-correlating a reconstruction from a lensed simulation (with known input potential $\\phi_{\\mathrm{in}}$) with the input potential itself. The response is the ratio of the cross-spectrum to the input model power spectrum:\n    $$\n    R_L = \\frac{\\langle \\mathrm{Re}[\\hat{\\phi}_{\\mathrm{sub}}(\\boldsymbol{L}) \\phi_{\\mathrm{in}}^*(\\boldsymbol{L})] \\rangle_L}{C_{L, \\mathrm{model}}^{\\phi\\phi}}\n    $$\n    where $\\hat{\\phi}_{\\mathrm{sub}}$ is the mean-field-subtracted reconstruction.\n\n### 4. Final Unbiased Power Spectrum\n\nThe final unbiased estimate of the lensing potential power spectrum, $\\hat{C}_L^{\\phi\\phi}$, is constructed by combining these corrections. For a lensed \"data\" simulation, we compute the auto-power spectrum of its mean-field-subtracted reconstruction, $C_L^{\\mathrm{auto}}$. The final spectrum is then:\n$$\n\\hat{C}_L^{\\phi\\phi} = \\frac{C_L^{\\mathrm{auto}} - N_L^{(0)}}{R_L^2}\n$$\nThe power spectra are calculated in discrete bins of multipole magnitude $L$. The results are then evaluated against the acceptance criteria defined in the problem statement for each test case.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main solver function to run the CMB lensing reconstruction pipeline for all test cases.\n    \"\"\"\n\n    # --- Numerical and Physical Setup ---\n    N = 256  # Grid size\n    L_BOX_DEG = 5.0  # Box side length in degrees\n    L_BOX_RAD = np.deg2rad(L_BOX_DEG)  # Box side length in radians\n    PIX_SIZE_RAD = L_BOX_RAD / N\n    N_MC = 100  # Number of Monte Carlo simulations for bias/noise estimation\n    L_BINS = 10  # Number of bins for power spectra\n    EPSILON = 1e-30  # Small regularization constant\n\n    # Fourier space grids for multipole vectors L = (Lx, Ly)\n    _kx = np.fft.fftfreq(N, d=PIX_SIZE_RAD) * 2 * np.pi\n    _ky = np.fft.fftfreq(N, d=PIX_SIZE_RAD) * 2 * np.pi\n    ELL_X, ELL_Y = np.meshgrid(_kx, _ky, indexing='ij')\n    ELL_MAG = np.sqrt(ELL_X**2 + ELL_Y**2)\n    ELL_MAG[0, 0] = 1.0  # Avoid division by zero at DC mode (L=0)\n\n    # Binning setup for power spectra\n    l_max_ana = np.pi / PIX_SIZE_RAD # Theoretical Nyquist limit\n    bin_edges = np.linspace(2, min(l_max_ana, 800), L_BINS + 1)\n        \n    def get_fiducial_spectra(ell_mag, noise_var):\n        \"\"\"Defines the fiducial power spectra C_TT and C_tot.\"\"\"\n        c_ell_tt = np.zeros_like(ell_mag)\n        valid_ells = ell_mag > 1\n        c_ell_tt[valid_ells] = 1.0 / (ell_mag[valid_ells]**2 + 50**2)\n        n_ell_tt = noise_var * PIX_SIZE_RAD**2\n        return c_ell_tt, c_ell_tt + n_ell_tt\n\n    def get_phi_power_spectrum(ell_mag, A_phi):\n        \"\"\"Defines the input lensing potential power spectrum C_phiphi.\"\"\"\n        c_ell_pp = np.zeros_like(ell_mag)\n        valid_ells = ell_mag > 1\n        c_ell_pp[valid_ells] = A_phi / (ell_mag[valid_ells] * (ell_mag[valid_ells] + 1.0))\n        return c_ell_pp\n\n    def generate_gaussian_field(c_ell_2d):\n        \"\"\"Generates a 2D Gaussian random field from a given power spectrum.\"\"\"\n        noise = (np.random.normal(size=(N, N)) + 1j * np.random.normal(size=(N, N))) / np.sqrt(2)\n        fourier_map = noise * np.sqrt(c_ell_2d * (N**4 / L_BOX_RAD**2))\n        fourier_map[0, 0] = 0.0 # Fluctuation field has zero mean\n        return np.fft.ifft2(fourier_map).real\n\n    def get_mask(f_apod):\n        \"\"\"Creates a circular mask with cosine apodization.\"\"\"\n        y, x = np.indices((N, N))\n        center_x, center_y = N // 2, N // 2\n        r = np.sqrt((x - center_x)**2 + (y - center_y)**2)\n        \n        r_max = N / 2.0\n        taper_width = f_apod * r_max\n        inner_radius = r_max - taper_width\n        \n        mask = np.zeros((N, N))\n        mask[r <= inner_radius] = 1.0\n        taper_region = (r > inner_radius) & (r <= r_max)\n        mask[taper_region] = 0.5 * (1 + np.cos(np.pi * (r[taper_region] - inner_radius) / taper_width))\n        return mask\n\n    def apply_lensing(t_unl, phi):\n        \"\"\"Lenses a temperature map using the first-order Taylor expansion.\"\"\"\n        t_unl_k = np.fft.fft2(t_unl)\n        phi_k = np.fft.fft2(phi)\n\n        grad_t_x = np.fft.ifft2(1j * ELL_X * t_unl_k).real\n        grad_t_y = np.fft.ifft2(1j * ELL_Y * t_unl_k).real\n        d_x = np.fft.ifft2(1j * ELL_X * phi_k).real\n        d_y = np.fft.ifft2(1j * ELL_Y * phi_k).real\n        \n        return t_unl + grad_t_x * d_x + grad_t_y * d_y\n\n    def get_binned_power(field_k, ell_map):\n        \"\"\"Computes the binned 1D power spectrum from a 2D Fourier field.\"\"\"\n        power_2d = np.abs(field_k)**2 * (L_BOX_RAD**2 / N**4)\n        \n        bin_indices = np.digitize(ell_map.flatten(), bin_edges)\n        # Bincount needs non-negative integer indices. Digitize provides 1-based, 0 for < min.\n        # Max index is len(bin_edges). We need to handle this.\n        valid_indices = (bin_indices > 0) & (bin_indices <= L_BINS)\n        weights_flat = power_2d.flatten()[valid_indices]\n        indices_flat = bin_indices[valid_indices] - 1 # to 0-based\n        \n        binned_power = np.bincount(indices_flat, weights=weights_flat, minlength=L_BINS)\n        bin_counts = np.bincount(indices_flat, minlength=L_BINS)\n        \n        return np.divide(binned_power, bin_counts, out=np.zeros_like(binned_power), where=bin_counts!=0)\n\n    def quadratic_estimator(t_obs, c_ell_tt, c_ell_tot):\n        \"\"\"Implements the symmetric quadratic estimator for phi.\"\"\"\n        t_obs_k = np.fft.fft2(t_obs)\n        \n        M1_k = t_obs_k / (c_ell_tot + EPSILON)\n        M2_k = t_obs_k * c_ell_tt / (c_ell_tot + EPSILON)\n        \n        M1 = np.fft.ifft2(M1_k).real\n        M2 = np.fft.ifft2(M2_k).real\n\n        grad_M1_x = np.fft.ifft2(1j * ELL_X * M1_k).real\n        grad_M1_y = np.fft.ifft2(1j * ELL_Y * M1_k).real\n        grad_M2_x = np.fft.ifft2(1j * ELL_X * M2_k).real\n        grad_M2_y = np.fft.ifft2(1j * ELL_Y * M2_k).real\n\n        d_est_x = M1 * grad_M2_x + M2 * grad_M1_x\n        d_est_y = M1 * grad_M2_y + M2 * grad_M1_y\n        \n        d_est_x_k = np.fft.fft2(d_est_x)\n        d_est_y_k = np.fft.fft2(d_est_y)\n\n        phi_k_unnorm = (1j * ELL_X * d_est_x_k + 1j * ELL_Y * d_est_y_k) / (ELL_MAG**2 + EPSILON)\n        phi_k_unnorm[0, 0] = 0.0\n        return phi_k_unnorm\n\n    def run_case(A_phi, sigma_n, f_apod):\n        \"\"\"Executes one full test case.\"\"\"\n        c_ell_tt, c_ell_tot = get_fiducial_spectra(ELL_MAG, sigma_n**2)\n        mask = get_mask(f_apod)\n        \n        # --- Monte Carlo for Mean-Field and N0 Bias ---\n        phi_mf_k_sum = np.zeros((N, N), dtype=complex)\n        for _ in range(N_MC):\n            t_unl = generate_gaussian_field(c_ell_tt)\n            noise = np.random.normal(0, sigma_n, (N, N))\n            t_obs_unlensed = (t_unl + noise) * mask\n            phi_mf_k_sum += quadratic_estimator(t_obs_unlensed, c_ell_tt, c_ell_tot)\n        phi_mf_k = phi_mf_k_sum / N_MC\n\n        n0_power_sum = np.zeros(L_BINS)\n        for _ in range(N_MC):\n            t_unl = generate_gaussian_field(c_ell_tt)\n            noise = np.random.normal(0, sigma_n, (N, N))\n            t_obs_unlensed = (t_unl + noise) * mask\n            phi_rec_k = quadratic_estimator(t_obs_unlensed, c_ell_tt, c_ell_tot)\n            phi_rec_k_mf_sub = phi_rec_k - phi_mf_k\n            n0_power_sum += get_binned_power(phi_rec_k_mf_sub, ELL_MAG)\n        n0_binned = n0_power_sum / N_MC\n        \n        # --- Main \"Data\" Simulation and Reconstruction ---\n        c_ell_pp_in = get_phi_power_spectrum(ELL_MAG, A_phi)\n        t_unl_main = generate_gaussian_field(c_ell_tt)\n        phi_in = generate_gaussian_field(c_ell_pp_in)\n        \n        t_lensed = apply_lensing(t_unl_main, phi_in) if A_phi > 0 else t_unl_main\n        noise_main = np.random.normal(0, sigma_n, (N, N))\n        t_obs_lensed = (t_lensed + noise_main) * mask\n        \n        phi_rec_lensed_k = quadratic_estimator(t_obs_lensed, c_ell_tt, c_ell_tot)\n        phi_rec_lensed_mf_sub_k = phi_rec_lensed_k - phi_mf_k\n        c_auto_binned = get_binned_power(phi_rec_lensed_mf_sub_k, ELL_MAG)\n        \n        # --- Calibration and Final Spectrum ---\n        c_model_binned = get_binned_power(np.sqrt(c_ell_pp_in * (N**4 / L_BOX_RAD**2) + EPSILON), ELL_MAG)\n\n        if A_phi > 0:\n            phi_in_k = np.fft.fft2(phi_in)\n            cross_power_2d = np.real(phi_rec_lensed_mf_sub_k * np.conj(phi_in_k)) * (L_BOX_RAD**2 / N**4)\n            c_cross_binned = get_binned_power(np.sqrt(cross_power_2d.clip(min=0)), ELL_MAG) # Hack to use binner\n            \n            # Recalculate cross-power without the hack\n            bin_indices = np.digitize(ELL_MAG.flatten(), bin_edges)\n            valid_indices = (bin_indices > 0) & (bin_indices <= L_BINS)\n            weights_flat = cross_power_2d.flatten()[valid_indices]\n            indices_flat = bin_indices[valid_indices] - 1\n            binned_cross = np.bincount(indices_flat, weights=weights_flat, minlength=L_BINS)\n            bin_counts = np.bincount(indices_flat, minlength=L_BINS)\n            c_cross_binned = np.divide(binned_cross, bin_counts, out=np.zeros_like(binned_cross), where=bin_counts!=0)\n            \n            r_binned = np.divide(c_cross_binned, c_model_binned, out=np.ones_like(c_model_binned), where=c_model_binned > EPSILON)\n            c_reco_binned = (c_auto_binned - n0_binned) / (r_binned**2 + EPSILON)\n        else:\n            c_reco_binned = c_auto_binned - n0_binned\n\n        # --- Acceptance Criteria ---\n        if A_phi > 0:\n            significant_bins = c_model_binned > 0.1 * np.max(c_model_binned[np.isfinite(c_model_binned)])\n            if not np.any(significant_bins): return False\n            dev = np.abs(c_reco_binned - c_model_binned) / (c_model_binned + EPSILON)\n            median_dev = np.median(dev[significant_bins])\n            tolerance = 0.6 if sigma_n < 1.1e-5 else 0.8\n            return median_dev < tolerance\n        else:\n            max_abs_residual = np.max(np.abs(c_reco_binned))\n            max_n0 = np.max(n0_binned[np.isfinite(n0_binned)])\n            if max_n0 == 0: return True # If N0 is zero, any residual is ok\n            return max_abs_residual < 0.2 * max_n0\n\n    # Define test cases\n    test_cases = [\n        (3e-7, 5e-6, 0.10),\n        (0, 5e-6, 0.10),\n        (3e-7, 2e-5, 0.20),\n    ]\n\n    results = []\n    for case in test_cases:\n        A_phi, sigma_n, f_apod = case\n        results.append(run_case(A_phi, sigma_n, f_apod))\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3467573"}, {"introduction": "A robust cosmological measurement is incomplete without a corresponding quantification of its uncertainty. This practice moves from estimating the lensing power spectrum to rigorously characterizing its statistical errors [@problem_id:3467597]. You will derive the analytical covariance matrix for the reconstructed bandpowers, accounting for sample variance and the intrinsic noise of the quadratic estimator. To solidify this theoretical understanding, you will then validate your analytical model against the sample covariance from a suite of Monte Carlo simulations, a crucial skill for verifying the statistical properties of any data analysis pipeline.", "problem": "You are tasked with deriving, implementing, and validating the covariance of bandpower estimates of the Cosmic Microwave Background (CMB) lensing potential power spectrum, denoted by $\\hat{C}_b^{\\phi\\phi}$, using the quadratic estimator framework under standard approximations used in numerical cosmology. The bandpowers are constructed from multipole moments $L$ of the lensing potential $\\phi$, and the reconstructed spectrum contains contributions from the true signal $C_L^{\\phi\\phi}$, the Gaussian disconnected noise bias $N_L^{(0)}$, and the connected non-Gaussian bias $N_L^{(1)}$. Your program must compute the analytic covariance of the bandpowers including sample variance and noise, and numerically validate this covariance against Monte Carlo ensembles.\n\nStart from the following fundamental base:\n- The reconstructed lensing potential harmonic coefficients define a reconstructed spectrum whose mean is the sum of signal and biases.\n- Under the isotropic Gaussian approximation and a partial sky fraction $f_{\\mathrm{sky}}$, multipole modes $L$ are approximately independent with an effective number of modes scaling like $(2L+1) f_{\\mathrm{sky}}$.\n- Bandpowers are formed by averaging estimators over disjoint bins in $L$.\n\nYou must:\n1. Define a scientifically plausible signal and noise model on a discrete multipole grid:\n   - The lensing potential power spectrum $C_L^{\\phi\\phi}$ is modeled as a decaying function of $L$: $C_L^{\\phi\\phi} = A_{\\phi} \\exp(-L/L_d) / [L(L+1)]$ for $L \\ge 2$ with $A_{\\phi} > 0$ and $L_d > 0$, and $C_L^{\\phi\\phi} = 0$ for $L < 2$.\n   - The Gaussian disconnected noise bias $N_L^{(0)}$ is modeled as $N_L^{(0)} = N_0 \\left[1 + (L/L_0)^2\\right]$ with $N_0 > 0$ and $L_0 > 0$.\n   - The connected non-Gaussian bias $N_L^{(1)}$ is modeled as $N_L^{(1)} = \\alpha_1 C_L^{\\phi\\phi}$ with $\\alpha_1 \\ge 0$.\n   - The total reconstructed spectrum per multipole is $C_L^{\\mathrm{tot}} = C_L^{\\phi\\phi} + N_L^{(0)} + N_L^{(1)}$.\n\n2. Define bandpowers $\\hat{C}_b^{\\phi\\phi}$ by averaging $\\hat{C}_L$ uniformly over multipoles $L$ in each bin $b$. Bins are specified as inclusive integer ranges in $L$.\n\n3. Derive from first principles the analytic covariance of the bandpowers under the isotropic Gaussian approximation and partial sky fraction $f_{\\mathrm{sky}}$, explicitly accounting for the contributions of $C_L^{\\phi\\phi}$, $N_L^{(0)}$, and $N_L^{(1)}$ and the finite sampling of modes.\n\n4. Implement a Monte Carlo validation by drawing ensembles of $\\hat{C}_L$ from an appropriate distribution consistent with the Gaussian approximation and the partial sky fraction $f_{\\mathrm{sky}}$, constructing bandpowers for each realization, and estimating the sample covariance across the ensemble. The ensemble should be sufficiently large to ensure stable estimates, and the draws must be independent across $L$ and realizations.\n\n5. Compare the analytic covariance against the Monte Carlo covariance for both diagonal elements (variances) and off-diagonal elements (covariances). Your program must return booleans indicating whether the maximum relative deviation of the diagonal elements is within a specified tolerance and whether the largest absolute off-diagonal element is sufficiently small compared to a representative diagonal scale.\n\nYour implementation must be self-contained and operate on the following test suite of parameter values. For each test case, construct the $L$ grid and bins exactly as specified:\n\n- Test Case 1 (general case):\n  - $f_{\\mathrm{sky}} = 0.4$\n  - $A_{\\phi} = 1.0 \\times 10^{-7}$\n  - $L_d = 200$\n  - $N_0 = 5.0 \\times 10^{-8}$\n  - $L_0 = 150$\n  - $\\alpha_1 = 0.1$\n  - Multipole range: $L \\in \\{10, 11, \\dots, 300\\}$\n  - Bins: $8$ equal-width bins partitioning the full range $[10,300]$ into disjoint contiguous integer intervals.\n  - Monte Carlo realizations: $6000$\n\n- Test Case 2 (boundary: small sky fraction):\n  - $f_{\\mathrm{sky}} = 0.05$\n  - $A_{\\phi} = 1.2 \\times 10^{-7}$\n  - $L_d = 300$\n  - $N_0 = 1.0 \\times 10^{-7}$\n  - $L_0 = 100$\n  - $\\alpha_1 = 0.2$\n  - Multipole range: $L \\in \\{20, 21, \\dots, 400\\}$\n  - Bins: $10$ equal-width bins partitioning the full range $[20,400]$ into disjoint contiguous integer intervals.\n  - Monte Carlo realizations: $8000$\n\n- Test Case 3 (edge case: single-$L$ bins, noise dominated, no $N^{(1)}$):\n  - $f_{\\mathrm{sky}} = 0.7$\n  - $A_{\\phi} = 8.0 \\times 10^{-8}$\n  - $L_d = 80$\n  - $N_0 = 3.0 \\times 10^{-7}$\n  - $L_0 = 120$\n  - $\\alpha_1 = 0.0$\n  - Multipole set: $L \\in \\{20, 60, 100\\}$\n  - Bins: three bins, each containing exactly one of the specified multipoles: $[20,20]$, $[60,60]$, $[100,100]$.\n  - Monte Carlo realizations: $20000$\n\nValidation criteria per test case:\n- Compute the analytic bandpower covariance matrix under the specified approximations and models.\n- Compute the sample covariance matrix from the Monte Carlo ensembles of bandpowers.\n- Let $\\Delta_{\\mathrm{diag}}$ be the maximum relative deviation across bins between the analytic variance and the Monte Carlo variance, defined as the maximum over bins of $\\left| \\mathrm{Var}_{\\mathrm{MC}}(b) - \\mathrm{Var}_{\\mathrm{ana}}(b) \\right| / \\mathrm{Var}_{\\mathrm{ana}}(b)$.\n- Let $\\Delta_{\\mathrm{off}}$ be the largest absolute off-diagonal element of the Monte Carlo covariance divided by the mean of the analytic diagonal variances.\n- A test case passes if $\\Delta_{\\mathrm{diag}} \\le 0.12$ and $\\Delta_{\\mathrm{off}} \\le 0.10$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,result3]\"), where each result is a boolean indicating whether the corresponding test case passes under the specified criteria. No physical units are involved; all quantities are dimensionless. Angles are not used.", "solution": "The problem requires the derivation and validation of the covariance of bandpower estimates for the Cosmic Microwave Background (CMB) lensing potential power spectrum, $\\hat{C}_b^{\\phi\\phi}$. This will be performed within the standard quadratic estimator framework, employing several common approximations used in numerical cosmology.\n\nFirst, we define the theoretical models for the signal and noise components that constitute the total reconstructed power spectrum at each multipole $L$. The true lensing potential power spectrum is given by\n$$C_L^{\\phi\\phi} = \\frac{A_{\\phi} \\exp(-L/L_d)}{L(L+1)} \\quad \\text{for } L \\ge 2,$$\nwith $C_L^{\\phi\\phi} = 0$ for $L < 2$. The reconstruction process introduces noise, which is modeled by two primary components: the Gaussian disconnected noise bias, $N_L^{(0)}$, and the connected non-Gaussian bias, $N_L^{(1)}$. Their functional forms are:\n$$N_L^{(0)} = N_0 \\left[1 + \\left(\\frac{L}{L_0}\\right)^2\\right]$$\n$$N_L^{(1)} = \\alpha_1 C_L^{\\phi\\phi}$$\nThe estimator for the power spectrum at a single multipole $L$, denoted $\\hat{C}_L$, is a random variable whose expectation value is the sum of the true signal and all bias terms. This is the total reconstructed power, $C_L^{\\mathrm{tot}}$:\n$$\\langle \\hat{C}_L \\rangle = C_L^{\\mathrm{tot}} = C_L^{\\phi\\phi} + N_L^{(0)} + N_L^{(1)} = (1 + \\alpha_1)C_L^{\\phi\\phi} + N_L^{(0)}$$\n\nUnder the assumption that the underlying CMB fields are Gaussian, the estimator $\\hat{C}_L$ approximately follows a Gaussian distribution for a large number of modes. The variance of $\\hat{C}_L$ is determined by the total power, $C_L^{\\mathrm{tot}}$, and the number of independent modes available for that multipole. For a full sky observation, there are $2L+1$ modes. For an observation covering a fraction of the sky $f_{\\mathrm{sky}}$, the effective number of modes is reduced to $(2L+1)f_{\\mathrm{sky}}$. The variance of the estimator is thus given by the standard formula for power spectrum variance, adjusted for the sky fraction:\n$$\\mathrm{Var}(\\hat{C}_L) = \\frac{2}{(2L+1)f_{\\mathrm{sky}}} (C_L^{\\mathrm{tot}})^2$$\nA crucial assumption in this framework is that estimators at different multipoles, $L$ and $L'$, are uncorrelated. This is a good approximation when mask-induced mode-coupling is ignored. We can therefore write the covariance of the multipole estimators as:\n$$\\mathrm{Cov}(\\hat{C}_L, \\hat{C}_{L'}) = \\delta_{LL'} \\mathrm{Var}(\\hat{C}_L)$$\nwhere $\\delta_{LL'}$ is the Kronecker delta.\n\nBandpowers are constructed by averaging the multipole estimators over disjoint bins in $L$-space to reduce the variance. For a given bin $b$, which contains a set of multipoles $\\mathcal{L}_b$ with $N_b = |\\mathcal{L}_b|$ members, the bandpower estimator $\\hat{C}_b$ is defined as the simple average:\n$$\\hat{C}_b = \\frac{1}{N_b} \\sum_{L \\in \\mathcal{L}_b} \\hat{C}_L$$\nThe covariance between two bandpower estimators, $\\hat{C}_b$ and $\\hat{C}_{b'}$, can be derived using the linearity of the covariance operator:\n$$\\mathrm{Cov}(\\hat{C}_b, \\hat{C}_{b'}) = \\mathrm{Cov}\\left( \\frac{1}{N_b} \\sum_{L \\in \\mathcal{L}_b} \\hat{C}_L, \\frac{1}{N_{b'}} \\sum_{L' \\in \\mathcal{L}_{b'}} \\hat{C}_{L'} \\right)$$\n$$= \\frac{1}{N_b N_{b'}} \\sum_{L \\in \\mathcal{L}_b} \\sum_{L' \\in \\mathcal{L}_{b'}} \\mathrm{Cov}(\\hat{C}_L, \\hat{C}_{L'})$$\nSubstituting the expression for $\\mathrm{Cov}(\\hat{C}_L, \\hat{C}_{L'})$:\n$$\\mathrm{Cov}(\\hat{C}_b, \\hat{C}_{b'}) = \\frac{1}{N_b N_{b'}} \\sum_{L \\in \\mathcal{L}_b} \\sum_{L' \\in \\mathcal{L}_{b'}} \\delta_{LL'} \\mathrm{Var}(\\hat{C}_L)$$\nThe analysis of this expression splits into two cases based on whether the bins are the same or different.\n\nCase 1: Off-diagonal elements ($b \\neq b'$).\nThe problem specifies that the bins are disjoint, meaning $\\mathcal{L}_b \\cap \\mathcal{L}_{b'} = \\emptyset$. In the double summation, the condition $L = L'$ imposed by the Kronecker delta can never be satisfied, as $L$ comes from $\\mathcal{L}_b$ and $L'$ comes from $\\mathcal{L}_{b'}$ and they have no elements in common. Therefore, every term in the sum is zero.\n$$\\mathrm{Cov}(\\hat{C}_b, \\hat{C}_{b'}) = 0 \\quad \\text{for } b \\neq b'$$\nThe analytic bandpower covariance matrix is diagonal under these assumptions.\n\nCase 2: Diagonal elements ($b = b'$).\nThis gives the variance of the bandpower estimator $\\hat{C}_b$. Here, $b' = b$, so $\\mathcal{L}_{b'} = \\mathcal{L}_b$ and $N_{b'} = N_b$. The double summation collapses into a single sum:\n$$\\mathrm{Var}(\\hat{C}_b) = \\mathrm{Cov}(\\hat{C}_b, \\hat{C}_b) = \\frac{1}{N_b^2} \\sum_{L \\in \\mathcal{L}_b} \\sum_{L' \\in \\mathcal{L}_b} \\delta_{LL'} \\mathrm{Var}(\\hat{C}_L) = \\frac{1}{N_b^2} \\sum_{L \\in \\mathcal{L}_b} \\mathrm{Var}(\\hat{C}_L)$$\nSubstituting the formula for $\\mathrm{Var}(\\hat{C}_L)$, we arrive at the final expression for the analytical bandpower variance:\n$$\\mathrm{Var}_{\\mathrm{ana}}(b) = \\mathrm{Var}(\\hat{C}_b) = \\frac{1}{N_b^2} \\sum_{L \\in \\mathcal{L}_b} \\frac{2}{(2L+1)f_{\\mathrm{sky}}} \\left((1 + \\alpha_1)C_L^{\\phi\\phi} + N_L^{(0)}\\right)^2$$\n\nTo validate this analytic result, a Monte Carlo simulation is performed. This involves the following steps:\n1. For each multipole $L$ on the specified grid, calculate the mean $C_L^{\\mathrm{tot}}$ and variance $\\mathrm{Var}(\\hat{C}_L)$ of the estimator.\n2. Generate a large ensemble of $N_{\\mathrm{MC}}$ realizations of the full set of multipole estimators $\\{\\hat{C}_L\\}$. For each realization $i$ and each multipole $L$, a value $\\hat{C}_{L,i}$ is drawn from an independent normal distribution $\\mathcal{N}(\\mu=C_L^{\\mathrm{tot}}, \\sigma^2=\\mathrm{Var}(\\hat{C}_L))$.\n3. For each of the $N_{\\mathrm{MC}}$ realizations, compute the vector of bandpowers $\\{\\hat{C}_{b,i}\\}$ by averaging the simulated $\\hat{C}_{L,i}$ values within their respective bins.\n4. From the ensemble of $N_{\\mathrm{MC}}$ bandpower vectors, compute the sample covariance matrix, $\\mathrm{Cov}_{\\mathrm{MC}}(b, b')$. For a collection of bandpower vectors $\\{\\mathbf{v}_i\\}_{i=1}^{N_{\\mathrm{MC}}}$ where $\\mathbf{v}_i = (\\hat{C}_{1,i}, \\dots, \\hat{C}_{N_{\\text{bins}},i})$, the sample covariance is calculated by standard statistical methods, typically using an unbiased estimator.\n\nThe validation consists of comparing the analytically derived diagonal covariance matrix with the sample covariance matrix from the Monte Carlo simulation.\n- The diagonal elements (variances) are compared via the maximum relative deviation, $\\Delta_{\\mathrm{diag}} = \\max_{b} |\\mathrm{Var}_{\\mathrm{MC}}(b) - \\mathrm{Var}_{\\mathrm{ana}}(b)| / \\mathrm{Var}_{\\mathrm{ana}}(b)$. This tests the accuracy of the variance formula.\n- The off-diagonal elements of the analytic covariance are zero. The Monte Carlo simulation, due to its finite size, will produce small but non-zero off-diagonal elements. Their magnitude is assessed by $\\Delta_{\\mathrm{off}}$, the largest absolute off-diagonal element of $\\mathrm{Cov}_{\\mathrm{MC}}$ normalized by the mean analytic variance. This tests the validity of the multipole independence assumption.\n\nIf both $\\Delta_{\\mathrm{diag}}$ and $\\Delta_{\\mathrm{off}}$ are below their respective thresholds, the analytic model and the assumptions upon which it is built are considered validated for the given parameters.", "answer": "```python\nimport numpy as np\nfrom scipy.special import xlogy # Not strictly needed, but can avoid warnings for L(L+1)\n\ndef solve():\n    \"\"\"\n    Main function to run the test cases for CMB lensing bandpower covariance validation.\n    \"\"\"\n\n    test_cases = [\n        # Test Case 1 (general case)\n        {\n            \"f_sky\": 0.4, \"A_phi\": 1.0e-7, \"L_d\": 200, \"N_0\": 5.0e-8,\n            \"L_0\": 150, \"alpha_1\": 0.1, \"L_min\": 10, \"L_max\": 300,\n            \"n_bins\": 8, \"n_mc\": 6000\n        },\n        # Test Case 2 (boundary: small sky fraction)\n        {\n            \"f_sky\": 0.05, \"A_phi\": 1.2e-7, \"L_d\": 300, \"N_0\": 1.0e-7,\n            \"L_0\": 100, \"alpha_1\": 0.2, \"L_min\": 20, \"L_max\": 400,\n            \"n_bins\": 10, \"n_mc\": 8000\n        },\n        # Test Case 3 (edge case: single-L bins, noise dominated, no N(1))\n        {\n            \"f_sky\": 0.7, \"A_phi\": 8.0e-8, \"L_d\": 80, \"N_0\": 3.0e-7,\n            \"L_0\": 120, \"alpha_1\": 0.0, \"Ls\": np.array([20, 60, 100]),\n            \"n_bins\": 3, \"n_mc\": 20000\n        }\n    ]\n\n    results = []\n    \n    # Custom seed for reproducibility\n    # Using np.random.RandomState for compatibility with older numpy versions\n    # although default_rng is preferred in modern numpy. `np.random` functions are also fine.\n    rng = np.random.RandomState(seed=12345)\n\n    for case in test_cases:\n        # 1. Setup Models and Multipole Grid\n        f_sky = case[\"f_sky\"]\n        \n        # Define power spectrum and noise models\n        def c_l_phi_phi(L, A_phi, L_d):\n            # The model is for L >= 2. The provided L ranges satisfy this.\n            return A_phi * np.exp(-L / L_d) / (L * (L + 1))\n\n        def n_l_0(L, N_0, L_0):\n            return N_0 * (1 + (L / L_0)**2)\n\n        if \"Ls\" in case: # Case 3 with an explicit list of Ls\n            L_grid = case[\"Ls\"]\n            bins = [[L] for L in L_grid]\n        else: # Cases 1 and 2 with L ranges and binning\n            L_min, L_max, n_bins = case[\"L_min\"], case[\"L_max\"], case[\"n_bins\"]\n            L_grid = np.arange(L_min, L_max + 1)\n            \n            # Partition L_grid into n_bins\n            n_L = len(L_grid)\n            base_width = n_L // n_bins\n            remainder = n_L % n_bins\n            \n            bin_sizes = [base_width + 1] * remainder + [base_width] * (n_bins - remainder)\n            \n            bins = []\n            current_idx = 0\n            for size in bin_sizes:\n                bins.append(L_grid[current_idx : current_idx + size])\n                current_idx += size\n        \n        A_phi, L_d = case[\"A_phi\"], case[\"L_d\"]\n        N_0, L_0 = case[\"N_0\"], case[\"L_0\"]\n        alpha_1 = case[\"alpha_1\"]\n\n        cl_phi_phi_vals = c_l_phi_phi(L_grid, A_phi, L_d)\n        nl0_vals = n_l_0(L_grid, N_0, L_0)\n        \n        cl_tot = (1 + alpha_1) * cl_phi_phi_vals + nl0_vals\n        var_cl = 2 * cl_tot**2 / ((2 * L_grid + 1) * f_sky)\n\n        # 2. Analytic Bandpower Covariance\n        analytic_variances = np.zeros(len(bins))\n        for i, bin_L_values in enumerate(bins):\n            N_b = len(bin_L_values)\n            # Find indices of L_values in the full L_grid\n            indices = np.where(np.isin(L_grid, bin_L_values))[0]\n            \n            # Sum variances of C_L within the bin\n            sum_var_cl = np.sum(var_cl[indices])\n            analytic_variances[i] = sum_var_cl / (N_b**2)\n\n        # 3. Monte Carlo Validation\n        n_mc = case[\"n_mc\"]\n        \n        # Generate all MC realizations for all L's at once\n        mc_cl_realizations = rng.normal(loc=cl_tot, scale=np.sqrt(var_cl), size=(n_mc, len(L_grid)))\n        \n        # Calculate bandpowers for each realization\n        mc_bandpowers = np.zeros((n_mc, len(bins)))\n        for i, bin_L_values in enumerate(bins):\n            indices = np.where(np.isin(L_grid, bin_L_values))[0]\n            # Average over the C_L realizations in the bin\n            mc_bandpowers[:, i] = np.mean(mc_cl_realizations[:, indices], axis=1)\n            \n        # Calculate the sample covariance matrix\n        # rowvar=False because each column is a variable (a bin), and each row is an observation\n        mc_cov = np.cov(mc_bandpowers, rowvar=False)\n\n        # 4. Comparison and Validation\n        mc_variances = np.diag(mc_cov)\n        \n        # Delta_diag: Max relative deviation of variances\n        delta_diag = np.max(np.abs(mc_variances - analytic_variances) / analytic_variances)\n        \n        # Delta_off: Max absolute off-diagonal element of MC cov, normalized\n        # Set diagonal to zero to easily find max off-diagonal element\n        off_diag_mc_cov = mc_cov.copy()\n        np.fill_diagonal(off_diag_mc_cov, 0)\n        max_abs_off_diag = np.max(np.abs(off_diag_mc_cov))\n        mean_analytic_var = np.mean(analytic_variances)\n        \n        # Handle case where mean_analytic_var could be zero (unlikely but safe)\n        delta_off = max_abs_off_diag / mean_analytic_var if mean_analytic_var > 0 else 0\n\n        # Check against validation criteria\n        diag_passed = delta_diag <= 0.12\n        off_diag_passed = delta_off <= 0.10\n        \n        results.append(diag_passed and off_diag_passed)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, [r for r in results]))}]\")\n\nsolve()\n```", "id": "3467597"}, {"introduction": "Real-world cosmological surveys are inevitably constrained by galactic foregrounds and survey boundaries, resulting in incomplete sky coverage. This practice transitions from idealized periodic skies to the more realistic challenge of a masked sky, a critical step towards analyzing actual observational data [@problem_id:3467517]. You will derive the mathematical formalism, known as the pseudo-$C_L$ or MASTER method, that describes how a mask couples different spherical harmonic modes. This analytical exercise is essential for understanding how to de-bias a measured power spectrum and recover the true underlying cosmological signal from partial-sky observations.", "problem": "Consider the reconstruction of the scalar lensing potential $\\phi(\\hat{\\boldsymbol{n}})$ of the Cosmic Microwave Background (CMB) on the sphere using a quadratic estimator $\\hat{\\phi}(\\hat{\\boldsymbol{n}})$ built from filtered CMB fields. Assume the full-sky estimator is normalized such that, in the absence of masking and anisotropies, its harmonic-space response is isotropic and given by a known scalar response function $R_{L}$, so that $\\langle \\hat{\\phi}_{LM} \\rangle = R_{L}\\,\\phi_{LM}$ to leading order in lensing.\n\nLet the observed sky be multiplied by a scalar, apodized window function $W(\\hat{\\boldsymbol{n}})$ that vanishes in the masked regions and is unity in the unmasked regions. Define the masked reconstructed field $\\widetilde{\\phi}(\\hat{\\boldsymbol{n}}) \\equiv W(\\hat{\\boldsymbol{n}})\\,\\hat{\\phi}(\\hat{\\boldsymbol{n}})$, with spherical harmonic coefficients $\\widetilde{\\phi}_{LM}$. The pseudo-power spectrum of the masked reconstruction is defined by $\\widetilde{C}_{L}^{\\hat{\\phi}\\hat{\\phi}} \\equiv \\frac{1}{2L+1}\\sum_{M} |\\widetilde{\\phi}_{LM}|^{2}$. The mask has harmonic coefficients $W_{LM}$ and an associated power spectrum $C_{L}^{WW} \\equiv \\frac{1}{2L+1}\\sum_{M} |W_{LM}|^{2}$.\n\nStarting from first principles of spherical harmonic analysis on the sphere and the Gaunt integral for products of spherical harmonics, and treating $\\hat{\\phi}$ as a scalar field, perform the following:\n\n1. Derive the coupling relation between the ensemble-averaged pseudo-spectrum $\\langle \\widetilde{C}_{L}^{\\hat{\\phi}\\hat{\\phi}} \\rangle$ and the true spectrum of the reconstruction $\\langle C_{L'}^{\\hat{\\phi}\\hat{\\phi}} \\rangle$ induced by the mask $W(\\hat{\\boldsymbol{n}})$. Express the pseudo-$C_{\\ell}$ coupling matrix $M_{LL'}$ in terms of the mask power spectrum $C_{L''}^{WW}$ and Wigner $3j$ symbols.\n\n2. Consider bandpowers defined by top-hat bins $b$ over multipole ranges $\\{L \\in b\\}$ with bin widths $\\Delta_{b} \\equiv \\sum_{L \\in b} 1$. Define the binned pseudo spectrum $\\widetilde{C}_{b}^{\\hat{\\phi}\\hat{\\phi}} \\equiv \\frac{1}{\\Delta_{b}}\\sum_{L \\in b} \\widetilde{C}_{L}^{\\hat{\\phi}\\hat{\\phi}}$ and similarly $C_{b}^{\\phi\\phi} \\equiv \\frac{1}{\\Delta_{b}}\\sum_{L \\in b} C_{L}^{\\phi\\phi}$, as well as the binned response factor $R_{b}^{2} \\equiv \\frac{1}{\\Delta_{b}}\\sum_{L \\in b} R_{L}^{2}$. Using the scalar-field coupling derived in part 1 and the leading-order reconstruction relation $\\langle C_{L}^{\\hat{\\phi}\\hat{\\phi}} \\rangle = R_{L}^{2}\\,C_{L}^{\\phi\\phi} + N_{L}^{(0)} + N_{L}^{(1)}$ (where $N_{L}^{(0)}$ and $N_{L}^{(1)}$ are the disconnected and secondary biases of the quadratic estimator, respectively), obtain the bandpower coupling matrix $K_{bb'}$ that connects $\\langle \\widetilde{C}_{b}^{\\hat{\\phi}\\hat{\\phi}} \\rangle$ to $C_{b'}^{\\phi\\phi}$ at leading order.\n\n3. Accounting for the mask-induced mean-field and the standard quadratic-estimator biases $N_{L}^{(0)}$ and $N_{L}^{(1)}$, and assuming their bandpower-averaged masked versions $\\widetilde{N}_{b}^{(0)}$, $\\widetilde{N}_{b}^{(1)}$, and residual mean-field bandpowers $\\widetilde{B}_{b}^{\\mathrm{MF}}$ are known from simulations, derive a closed-form analytic expression for an unbiased estimator of the bandpower lensing potential spectrum $C_{b}^{\\phi\\phi}$ in terms of the inverse of the bandpower coupling matrix $K_{bb'}$ and the measured masked pseudo bandpowers $\\widetilde{C}_{b}^{\\hat{\\phi}\\hat{\\phi}}$.\n\nYour final answer must be a single closed-form analytic expression for the unbiased estimator $\\hat{C}_{b}^{\\phi\\phi}$ written in terms of explicit sums over multipoles, Wigner $3j$ symbols, and the mask spectrum $C_{L}^{WW}$. No numerical evaluation is required and no rounding should be performed.", "solution": "The problem asks for a three-part derivation concerning the estimation of the CMB lensing potential power spectrum from a masked sky. We will proceed by first validating the problem statement and then providing a step-by-step derivation for each part.\n\n### Problem Validation\nThe problem statement is a standard exercise in CMB data analysis, specifically on the topic of power spectrum estimation in the presence of a sky mask. All givens are standard definitions in the field of numerical cosmology.\n- **Givens**: Scalar lensing potential $\\phi(\\hat{\\boldsymbol{n}})$, quadratic estimator $\\hat{\\phi}(\\hat{\\boldsymbol{n}})$, full-sky response function $R_L$, window function $W(\\hat{\\boldsymbol{n}})$, masked field $\\widetilde{\\phi}(\\hat{\\boldsymbol{n}})$, pseudo-power spectrum $\\widetilde{C}_{L}^{\\hat{\\phi}\\hat{\\phi}}$, mask power spectrum $C_{L}^{WW}$, relation for the true reconstruction spectrum $\\langle C_{L}^{\\hat{\\phi}\\hat{\\phi}} \\rangle = R_{L}^{2}\\,C_{L}^{\\phi\\phi} + N_{L}^{(0)} + N_{L}^{(1)}$, and definitions for binned quantities ($\\Delta_b$, $\\widetilde{C}_{b}^{\\hat{\\phi}\\hat{\\phi}}$, $C_{b}^{\\phi\\phi}$, $R_{b}^{2}$) and bias terms ($\\widetilde{N}_{b}^{(0)}$, $\\widetilde{N}_{b}^{(1)}$, $\\widetilde{B}_{b}^{\\mathrm{MF}}$).\n- **Validation Verdict**: The problem is **valid**. It is scientifically grounded in established cosmological data analysis techniques (the \"MASTER\" algorithm formalism), well-posed with a clear path to a unique solution, and expressed in objective, formal language. It is a non-trivial but standard derivation in the field.\n\n### Part 1: Derivation of the Pseudo-$C_{\\ell}$ Coupling Matrix $M_{LL'}$\nWe start from the definition of the masked field, $\\widetilde{\\phi}(\\hat{\\boldsymbol{n}}) = W(\\hat{\\boldsymbol{n}})\\hat{\\phi}(\\hat{\\boldsymbol{n}})$. The spherical harmonic coefficients $\\widetilde{\\phi}_{LM}$ of this product field are given by the convolution of the coefficients of $W(\\hat{\\boldsymbol{n}})$ and $\\hat{\\phi}(\\hat{\\boldsymbol{n}})$.\nThe coefficients of a product of two scalar fields $A(\\hat{\\boldsymbol{n}})$ and $B(\\hat{\\boldsymbol{n}})$ are given by:\n$$ (AB)_{LM} = \\sum_{l_1 m_1 l_2 m_2} A_{l_1 m_1} B_{l_2 m_2} \\int Y_{LM}^{*}(\\hat{\\boldsymbol{n}}) Y_{l_1 m_1}(\\hat{\\boldsymbol{n}}) Y_{l_2 m_2}(\\hat{\\boldsymbol{n}}) d\\Omega $$\nThe integral is a Gaunt integral, which can be expressed using Wigner $3j$ symbols:\n$$ \\int Y_{l_1 m_1} Y_{l_2 m_2} Y_{l_3 m_3} d\\Omega = \\sqrt{\\frac{(2l_1+1)(2l_2+1)(2l_3+1)}{4\\pi}} \\begin{pmatrix} l_1 & l_2 & l_3 \\\\ 0 & 0 & 0 \\end{pmatrix} \\begin{pmatrix} l_1 & l_2 & l_3 \\\\ m_1 & m_2 & m_3 \\end{pmatrix} $$\nUsing $Y_{LM}^* = (-1)^M Y_{L,-M}$, the coefficients of the masked field are:\n$$ \\widetilde{\\phi}_{LM} = \\sum_{l_1 m_1 l_2 m_2} W_{l_1 m_1} \\hat{\\phi}_{l_2 m_2} (-1)^M \\sqrt{\\frac{(2l_1+1)(2l_2+1)(2L+1)}{4\\pi}} \\begin{pmatrix} l_1 & l_2 & L \\\\ 0 & 0 & 0 \\end{pmatrix} \\begin{pmatrix} l_1 & l_2 & L \\\\ m_1 & m_2 & -M \\end{pmatrix} $$\nThe pseudo-power spectrum is defined as $\\widetilde{C}_{L}^{\\hat{\\phi}\\hat{\\phi}} \\equiv \\frac{1}{2L+1}\\sum_{M} |\\widetilde{\\phi}_{LM}|^{2}$. We are interested in its ensemble average, $\\langle \\widetilde{C}_{L}^{\\hat{\\phi}\\hat{\\phi}} \\rangle$. We thus compute $\\langle \\widetilde{\\phi}_{LM}\\widetilde{\\phi}_{LM}^{*} \\rangle$. The field $\\hat{\\phi}$ is a statistically isotropic random field, so its harmonic coefficients have the property $\\langle \\hat{\\phi}_{l_2 m_2} \\hat{\\phi}_{l_4 m_4}^{*} \\rangle = \\delta_{l_2 l_4} \\delta_{m_2 m_4} C_{l_2}^{\\hat{\\phi}\\hat{\\phi}}$, where $C_{l_2}^{\\hat{\\phi}\\hat{\\phi}}$ is the power spectrum of the reconstruction. The window function $W$ is a fixed, deterministic function.\nUsing this property, we have:\n$$ \\langle |\\widetilde{\\phi}_{LM}|^2 \\rangle = \\sum_{\\substack{l_1 m_1, l_2 m_2 \\\\ l_3 m_3}} W_{l_1 m_1} W_{l_3 m_3}^* C_{l_2}^{\\hat{\\phi}\\hat{\\phi}} \\left( (-1)^M \\mathcal{G}_{l_1 m_1, l_2 m_2}^{L,-M} \\right) \\left( (-1)^M \\mathcal{G}_{l_3 m_3, l_2 m_2}^{L,-M} \\right)^* $$\nwhere $\\mathcal{G}$ is the Gaunt integral factor. We sum over $M$ and use the orthogonality of the $3j$ symbols:\n$$ \\sum_{m_2, M} \\begin{pmatrix} l_1 & l_2 & L \\\\ m_1 & m_2 & -M \\end{pmatrix} \\begin{pmatrix} l_3 & l_2 & L \\\\ m_3 & m_2 & -M \\end{pmatrix} = \\frac{\\delta_{l_1 l_3} \\delta_{m_1 m_3}}{2l_1+1} $$\nThis simplifies the sum over $M, m_2$ to:\n$$ \\frac{(2l_1+1)(2l_2+1)(2L+1)}{4\\pi} \\begin{pmatrix} l_1 & l_2 & L \\\\ 0 & 0 & 0 \\end{pmatrix} \\begin{pmatrix} l_3 & l_2 & L \\\\ 0 & 0 & 0 \\end{pmatrix} \\frac{\\delta_{l_1 l_3} \\delta_{m_1 m_3}}{2l_1+1} $$\nPlugging this back into the expression for $\\langle |\\widetilde{\\phi}_{LM}|^2 \\rangle$, summing over $M$, and then averaging over $M$ gives:\n$$ \\langle \\widetilde{C}_{L}^{\\hat{\\phi}\\hat{\\phi}} \\rangle = \\sum_{l_2} C_{l_2}^{\\hat{\\phi}\\hat{\\phi}} \\sum_{l_1 m_1} |W_{l_1 m_1}|^2 \\frac{(2l_2+1)}{4\\pi} \\begin{pmatrix} l_1 & l_2 & L \\\\ 0 & 0 & 0 \\end{pmatrix}^2 $$\nUsing the definition of the mask power spectrum, $C_{l_1}^{WW} = \\frac{1}{2l_1+1}\\sum_{m_1} |W_{l_1 m_1}|^2$, we get:\n$$ \\langle \\widetilde{C}_{L}^{\\hat{\\phi}\\hat{\\phi}} \\rangle = \\sum_{l_2} C_{l_2}^{\\hat{\\phi}\\hat{\\phi}} \\sum_{l_1} (2l_1+1)C_{l_1}^{WW} \\frac{(2l_2+1)}{4\\pi} \\begin{pmatrix} l_1 & l_2 & L \\\\ 0 & 0 & 0 \\end{pmatrix}^2 $$\nThis is of the form $\\langle \\widetilde{C}_{L}^{\\hat{\\phi}\\hat{\\phi}} \\rangle = \\sum_{L'} M_{LL'} \\langle C_{L'}^{\\hat{\\phi}\\hat{\\phi}} \\rangle$. By identifying terms ($L' \\leftrightarrow l_2$, $L'' \\leftrightarrow l_1$), we find the coupling matrix:\n$$ M_{LL'} = \\sum_{L''} \\frac{(2L'+1)(2L''+1)}{4\\pi} C_{L''}^{WW} \\begin{pmatrix} L & L' & L'' \\\\ 0 & 0 & 0 \\end{pmatrix}^2 $$\n\n### Part 2: Derivation of the Bandpower Coupling Matrix $K_{bb'}$\nThe binned pseudo-spectrum is defined as $\\widetilde{C}_{b}^{\\hat{\\phi}\\hat{\\phi}} = \\frac{1}{\\Delta_{b}} \\sum_{L \\in b} \\widetilde{C}_{L}^{\\hat{\\phi}\\hat{\\phi}}$. Its ensemble average is:\n$$ \\langle \\widetilde{C}_{b}^{\\hat{\\phi}\\hat{\\phi}} \\rangle = \\frac{1}{\\Delta_{b}} \\sum_{L \\in b} \\langle \\widetilde{C}_{L}^{\\hat{\\phi}\\hat{\\phi}} \\rangle = \\frac{1}{\\Delta_{b}} \\sum_{L \\in b} \\sum_{L'} M_{LL'} \\langle C_{L'}^{\\hat{\\phi}\\hat{\\phi}} \\rangle $$\nThe problem states that at leading order, we should connect this to the true signal $C_{L'}^{\\phi\\phi}$ via the response $R_{L'}$, so $\\langle C_{L'}^{\\hat{\\phi}\\hat{\\phi}} \\rangle \\approx R_{L'}^2 C_{L'}^{\\phi\\phi}$.\n$$ \\langle \\widetilde{C}_{b}^{\\hat{\\phi}\\hat{\\phi}} \\rangle = \\frac{1}{\\Delta_{b}} \\sum_{L \\in b} \\sum_{L'} M_{LL'} R_{L'}^2 C_{L'}^{\\phi\\phi} $$\nTo express this in terms of bandpowers $C_{b'}^{\\phi\\phi}$, we partition the sum over $L'$ into bins $b'$:\n$$ \\langle \\widetilde{C}_{b}^{\\hat{\\phi}\\hat{\\phi}} \\rangle = \\frac{1}{\\Delta_{b}} \\sum_{L \\in b} \\sum_{b'} \\sum_{L' \\in b'} M_{LL'} R_{L'}^2 C_{L'}^{\\phi\\phi} $$\nWe now make the standard approximation that the underlying spectrum $C_{L'}^{\\phi\\phi}$ is slowly varying across the multipoles within a bin $b'$, such that $C_{L'}^{\\phi\\phi} \\approx C_{b'}^{\\phi\\phi}$ for all $L' \\in b'$. This allows us to factor $C_{b'}^{\\phi\\phi}$ out of the inner sum:\n$$ \\langle \\widetilde{C}_{b}^{\\hat{\\phi}\\hat{\\phi}} \\rangle \\approx \\sum_{b'} \\left( \\frac{1}{\\Delta_{b}} \\sum_{L \\in b} \\sum_{L' \\in b'} M_{LL'} R_{L'}^2 \\right) C_{b'}^{\\phi\\phi} $$\nThis gives the relation $\\langle \\widetilde{C}_{b}^{\\hat{\\phi}\\hat{\\phi}} \\rangle = \\sum_{b'} K_{bb'} C_{b'}^{\\phi\\phi}$, where the bandpower coupling matrix $K_{bb'}$ is:\n$$ K_{bb'} = \\frac{1}{\\Delta_{b}} \\sum_{L \\in b} \\sum_{L' \\in b'} M_{LL'} R_{L'}^2 $$\nSubstituting the expression for $M_{LL'}$ from Part 1 gives the final form for the bandpower coupling matrix:\n$$ K_{bb'} = \\frac{1}{\\Delta_{b}} \\sum_{L \\in b} \\sum_{L' \\in b'} R_{L'}^2 \\left( \\sum_{L''} \\frac{(2L'+1)(2L''+1)}{4\\pi} C_{L''}^{WW} \\begin{pmatrix} L & L' & L'' \\\\ 0 & 0 & 0 \\end{pmatrix}^2 \\right) $$\n\n### Part 3: Derivation of the Unbiased Estimator $\\hat{C}_{b}^{\\phi\\phi}$\nWe now construct the full forward model for the observed binned pseudo-spectrum, including all specified bias terms. The total true reconstruction spectrum is $\\langle C_{L'}^{\\hat{\\phi}\\hat{\\phi}} \\rangle = R_{L'}^2 C_{L'}^{\\phi\\phi} + N_{L'}^{(0)} + N_{L'}^{(1)}$.\nThe mode-coupling action on this full spectrum is:\n$$ \\langle \\widetilde{C}_{b}^{\\hat{\\phi}\\hat{\\phi}} \\rangle_{\\text{no MF}} = \\frac{1}{\\Delta_{b}} \\sum_{L \\in b} \\sum_{L'} M_{LL'} (R_{L'}^2 C_{L'}^{\\phi\\phi} + N_{L'}^{(0)} + N_{L'}^{(1)}) $$\n$$ \\langle \\widetilde{C}_{b}^{\\hat{\\phi}\\hat{\\phi}} \\rangle_{\\text{no MF}} = \\left( \\frac{1}{\\Delta_{b}} \\sum_{L \\in b} \\sum_{L'} M_{LL'} R_{L'}^2 C_{L'}^{\\phi\\phi} \\right) + \\left( \\frac{1}{\\Delta_{b}} \\sum_{L \\in b} \\sum_{L'} M_{LL'} (N_{L'}^{(0)} + N_{L'}^{(1)}) \\right) $$\nThe first term is the binned, coupled signal, which we found to be $\\sum_{b'} K_{bb'} C_{b'}^{\\phi\\phi}$. The second term represents the mask-coupled quadratic estimator biases. As per the problem statement, the binned, masked versions of these biases, denoted $\\widetilde{N}_{b}^{(0)}$ and $\\widetilde{N}_{b}^{(1)}$, are known. This term is therefore equal to $\\widetilde{N}_{b}^{(0)} + \\widetilde{N}_{b}^{(1)}$.\nAdditionally, we must account for the mask-induced mean-field. Its contribution to the pseudo-spectrum, $\\widetilde{B}_{b}^{\\mathrm{MF}}$, adds linearly to the total pseudo-spectrum.\nThe full model for the expectation of the measured binned pseudo-spectrum is thus:\n$$ \\langle \\widetilde{C}_{b}^{\\hat{\\phi}\\hat{\\phi}} \\rangle = \\sum_{b'} K_{bb'} C_{b'}^{\\phi\\phi} + \\widetilde{N}_{b}^{(0)} + \\widetilde{N}_{b}^{(1)} + \\widetilde{B}_{b}^{\\mathrm{MF}} $$\nTo form an unbiased estimator for $C_{b}^{\\phi\\phi}$, we first solve this system of linear equations for the vector of true bandpowers $\\mathbf{C}^{\\phi\\phi}$ (with elements $C_b^{\\phi\\phi}$). In matrix notation, where $\\mathbf{K}$ is the matrix with elements $K_{bb'}$, $\\widetilde{\\mathbf{C}}$ has elements $\\widetilde{C}_{b}^{\\hat{\\phi}\\hat{\\phi}}$, and $\\mathbf{B}$ is the total bias vector with elements $B_b = \\widetilde{N}_{b}^{(0)} + \\widetilde{N}_{b}^{(1)} + \\widetilde{B}_{b}^{\\mathrm{MF}}$:\n$$ \\langle \\widetilde{\\mathbf{C}} \\rangle = \\mathbf{K} \\mathbf{C}^{\\phi\\phi} + \\mathbf{B} $$\nSolving for $\\mathbf{C}^{\\phi\\phi}$:\n$$ \\mathbf{C}^{\\phi\\phi} = \\mathbf{K}^{-1} (\\langle \\widetilde{\\mathbf{C}} \\rangle - \\mathbf{B}) $$\nAn unbiased estimator $\\hat{\\mathbf{C}}^{\\phi\\phi}$ is obtained by replacing the ensemble average $\\langle \\widetilde{\\mathbf{C}} \\rangle$ with the single measurement $\\widetilde{\\mathbf{C}}$:\n$$ \\hat{\\mathbf{C}}^{\\phi\\phi} = \\mathbf{K}^{-1} (\\widetilde{\\mathbf{C}} - \\mathbf{B}) $$\nThe expectation of this estimator is $\\langle \\hat{\\mathbf{C}}^{\\phi\\phi} \\rangle = \\mathbf{K}^{-1} (\\langle \\widetilde{\\mathbf{C}} \\rangle - \\mathbf{B}) = \\mathbf{K}^{-1} (\\mathbf{K} \\mathbf{C}^{\\phi\\phi} + \\mathbf{B} - \\mathbf{B}) = \\mathbf{C}^{\\phi\\phi}$, confirming it is unbiased.\nWriting this out for a single bin $b$:\n$$ \\hat{C}_{b}^{\\phi\\phi} = \\sum_{b'} (K^{-1})_{bb'} \\left( \\widetilde{C}_{b'}^{\\hat{\\phi}\\hat{\\phi}} - \\widetilde{N}_{b'}^{(0)} - \\widetilde{N}_{b'}^{(1)} - \\widetilde{B}_{b'}^{\\mathrm{MF}} \\right) $$\nThis expression provides the unbiased estimate of the lensing power spectrum bandpowers by correcting the measured pseudo-spectrum bandpowers for mode-coupling and all relevant biases. The final answer requires substituting the full definition of the matrix $K$ into this expression.", "answer": "$$ \\boxed{ \\hat{C}_{b}^{\\phi\\phi} = \\sum_{b'} \\left( \\left[ \\frac{1}{\\Delta_{b_1}} \\sum_{L_1 \\in b_1} \\sum_{L_2 \\in b_2} R_{L_2}^2 \\left( \\sum_{L_3} \\frac{(2L_2+1)(2L_3+1)}{4\\pi} C_{L_3}^{WW} \\begin{pmatrix}L_1 & L_2 & L_3 \\\\ 0 & 0 & 0\\end{pmatrix}^2 \\right) \\right]_{b_1, b_2}^{-1} \\right)_{b,b'} \\left( \\widetilde{C}_{b'}^{\\hat{\\phi}\\hat{\\phi}} - \\widetilde{N}_{b'}^{(0)} - \\widetilde{N}_{b'}^{(1)} - \\widetilde{B}_{b'}^{\\mathrm{MF}} \\right) } $$", "id": "3467517"}]}