{"hands_on_practices": [{"introduction": "The collisionless Boltzmann equation describes the evolution of a distribution of particles in phase space. Its characteristics are simply the trajectories of individual particles governed by the underlying potential. This exercise reinforces this fundamental concept by having you numerically integrate particle paths in various time-independent potentials and verify the conservation of physical invariants like energy and angular momentum. Mastering this practice is crucial for building intuition about phase-space dynamics and understanding the properties of numerical schemes, such as symplectic integrators, designed to preserve these essential structures.", "problem": "Consider the collisionless Boltzmann (Vlasov) equation in Newtonian gravity for a collisionless system with phase-space distribution function $f(\\mathbf{x},\\mathbf{v},t)$ and a time-independent gravitational potential $\\Phi(\\mathbf{x})$. The evolution of $f$ satisfies\n$$\n\\frac{\\partial f}{\\partial t} + \\mathbf{v}\\cdot\\nabla_{\\mathbf{x}} f - \\nabla_{\\mathbf{x}}\\Phi(\\mathbf{x})\\cdot\\nabla_{\\mathbf{v}} f = 0,\n$$\nand the method of characteristics reduces the problem to integrating the characteristic ordinary differential equations\n$$\n\\frac{d\\mathbf{x}}{dt} = \\mathbf{v},\\qquad \\frac{d\\mathbf{v}}{dt} = -\\nabla_{\\mathbf{x}} \\Phi(\\mathbf{x}).\n$$\nFrom first principles, any scalar quantity $Q(\\mathbf{x},\\mathbf{v},t)$ that is constant along characteristics must satisfy $\\frac{dQ}{dt}=0$ when evaluated along solutions of the characteristic equations. In a time-independent potential, the total energy and, when appropriate symmetries are present, components of the angular momentum are candidates for such invariants.\n\nYour task is to:\n- Derive from the method of characteristics and Newton’s second law the analytic invariants that are preserved along particle trajectories for time-independent $\\Phi(\\mathbf{x})$, and the symmetry conditions under which angular momentum components are preserved.\n- Implement a symplectic leapfrog (kick-drift-kick) integrator to compute particle trajectories in $2$-dimensional space $\\mathbf{x}=(x,y)$ with $\\mathbf{v}=(v_x,v_y)$ for specified time-independent potentials. Use this numerical integrator to estimate the preservation quality of the invariants along the numerically approximated characteristics.\n\nAll calculations are to be performed in dimensionless code units (no physical units). Angles are not directly used. For any percentage-like comparison, report it as a decimal (e.g., $0.01$ instead of $1$ with a percent sign).\n\nUse the following potentials $\\Phi(\\mathbf{x})$ (all time-independent), their corresponding gradients $\\nabla_{\\mathbf{x}}\\Phi(\\mathbf{x})$, and initial conditions as a test suite:\n- Test case $1$ (free particle): $\\Phi(\\mathbf{x})=0$. Initial condition $\\mathbf{x}_0=(1,0)$, $\\mathbf{v}_0=(0,0.5)$.\n- Test case $2$ (central harmonic): $\\Phi(\\mathbf{x})=\\tfrac{1}{2}\\,\\omega^2 r^2$ with $r=\\sqrt{x^2+y^2}$ and $\\omega=0.5$. Initial condition $\\mathbf{x}_0=(1,0)$, $\\mathbf{v}_0=(0,0.8)$.\n- Test case $3$ (Kepler potential): $\\Phi(\\mathbf{x})=-GM/r$ with $GM=1$ and $r=\\sqrt{x^2+y^2}$. Initial condition $\\mathbf{x}_0=(1,0)$, $\\mathbf{v}_0=(0,1)$.\n- Test case $4$ (anisotropic harmonic, axisymmetric symmetry broken): $\\Phi(\\mathbf{x})=\\tfrac{1}{2}(\\omega_x^2 x^2+\\omega_y^2 y^2)$ with $\\omega_x=1$ and $\\omega_y=1.3$. Initial condition $\\mathbf{x}_0=(1,0)$, $\\mathbf{v}_0=(0,1)$.\n- Test case $5$ (central harmonic, radial motion): $\\Phi(\\mathbf{x})=\\tfrac{1}{2}\\,\\omega^2 r^2$ with $\\omega=0.5$. Initial condition $\\mathbf{x}_0=(1,0)$, $\\mathbf{v}_0=(-0.5,0)$.\n\nFor each test case, integrate the characteristic equations using the kick-drift-kick leapfrog method over a total time $T=30$ with a fixed time step $\\Delta t=0.005$ (so $N=T/\\Delta t=6000$ steps). Along each numerically computed trajectory, evaluate at every step:\n- The total specific energy $E$ (per unit mass).\n- The $z$-component of the specific angular momentum $L_z$ (per unit mass), appropriate to motion in the $x$–$y$ plane.\n\nQuantify conservation using the following measures:\n- For a quantity $Q\\in\\{E,L_z\\}$ with initial value $Q_0$, compute the maximum drift $\\max_t |Q(t)-Q_0|$. If $|Q_0|\\ge Q_{\\min}$ with $Q_{\\min}=10^{-12}$, compute the relative drift $\\max_t |Q(t)-Q_0|/|Q_0|$. If $|Q_0|<Q_{\\min}$, use the absolute drift $\\max_t |Q(t)-Q_0|$ instead.\n- Declare that energy is preserved if its drift is less than or equal to $\\varepsilon_E=10^{-4}$ (relative if $|E_0|\\ge Q_{\\min}$, absolute otherwise).\n- Declare that angular momentum is preserved if its drift is less than or equal to $\\varepsilon_L=10^{-4}$ (relative if $|L_{z,0}|\\ge Q_{\\min}$, absolute otherwise), but only when the symmetry conditions hold. Specifically, for the free particle, central harmonic, Kepler, and radial central harmonic cases, the $z$-component $L_z$ is expected to be invariant; for the anisotropic harmonic case, $L_z$ is not expected to be invariant and should fail this check.\n\nYour program must:\n- Implement the leapfrog method to integrate the characteristics for each test case.\n- Compute the boolean results of the conservation checks in the order: for each test case $i$ from $1$ to $5$, first the energy-preservation boolean, then the angular-momentum-preservation boolean, resulting in $10$ booleans.\n- Produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[b_1,b_2,\\dots,b_{10}]$) where each $b_j$ is either True or False.\n\nThe final output is a single Python program that performs these computations and prints the result in the exact required format. No user input is required, and no external files are to be used.", "solution": "The problem posed is a well-defined exercise in computational physics, specifically in the context of numerical cosmology and astrophysics. It asks for a two-part response: first, a theoretical derivation of conserved quantities for particle motion in a time-independent potential, and second, a numerical verification of these conservation laws for several test cases using a symplectic integrator.\n\n### Problem Validation\n\n1.  **Extract Givens**:\n    -   **Governing Equation**: The collisionless Boltzmann (Vlasov) equation for a phase-space distribution function $f(\\mathbf{x},\\mathbf{v},t)$ in a time-independent potential $\\Phi(\\mathbf{x})$: $\\frac{\\partial f}{\\partial t} + \\mathbf{v}\\cdot\\nabla_{\\mathbf{x}} f - \\nabla_{\\mathbf{x}}\\Phi(\\mathbf{x})\\cdot\\nabla_{\\mathbf{v}} f = 0$.\n    -   **Characteristic Equations**: $\\frac{d\\mathbf{x}}{dt} = \\mathbf{v}$, $\\frac{d\\mathbf{v}}{dt} = -\\nabla_{\\mathbf{x}} \\Phi(\\mathbf{x})$.\n    -   **Definition of Invariant**: A quantity $Q$ is an invariant if its total time derivative $\\frac{dQ}{dt}$ is zero along the characteristics.\n    -   **Numerical Method**: Symplectic leapfrog (kick-drift-kick) integrator.\n    -   **Simulation Parameters**: Total time $T=30$, time step $\\Delta t=0.005$, number of steps $N=6000$.\n    -   **Test Cases (Potentials $\\Phi(\\mathbf{x})$ and Initial Conditions $(\\mathbf{x}_0, \\mathbf{v}_0)$)**:\n        1.  **Free Particle**: $\\Phi(\\mathbf{x})=0$; $\\mathbf{x}_0=(1,0)$, $\\mathbf{v}_0=(0,0.5)$.\n        2.  **Central Harmonic**: $\\Phi(\\mathbf{x})=\\tfrac{1}{2}\\,\\omega^2 r^2$, $\\omega=0.5$; $\\mathbf{x}_0=(1,0)$, $\\mathbf{v}_0=(0,0.8)$.\n        3.  **Kepler Potential**: $\\Phi(\\mathbf{x})=-GM/r$, $GM=1$; $\\mathbf{x}_0=(1,0)$, $\\mathbf{v}_0=(0,1)$.\n        4.  **Anisotropic Harmonic**: $\\Phi(\\mathbf{x})=\\tfrac{1}{2}(\\omega_x^2 x^2+\\omega_y^2 y^2)$, $\\omega_x=1, \\omega_y=1.3$; $\\mathbf{x}_0=(1,0)$, $\\mathbf{v}_0=(0,1)$.\n        5.  **Radial Central Harmonic**: $\\Phi(\\mathbf{x})=\\tfrac{1}{2}\\,\\omega^2 r^2$, $\\omega=0.5$; $\\mathbf{x}_0=(1,0)$, $\\mathbf{v}_0=(-0.5,0)$.\n    -   **Quantities to Monitor**: Specific energy $E$, specific angular momentum $z$-component $L_z$.\n    -   **Conservation Metric**: Maximum drift $\\max_t |Q(t)-Q_0|$. The drift is relative to $|Q_0|$ if $|Q_0|\\ge Q_{\\min}=10^{-12}$, otherwise it is absolute.\n    -   **Conservation Thresholds**: $\\varepsilon_E=10^{-4}$ for energy, $\\varepsilon_L=10^{-4}$ for angular momentum.\n    -   **Required Output**: A list of $10$ boolean values (True/False) indicating preservation for $E$ and $L_z$ for each of the $5$ test cases.\n\n2.  **Validate Using Extracted Givens**:\n    -   **Scientifically Grounded**: The problem is based on fundamental principles of classical mechanics (Newtonian gravity, energy conservation, angular momentum conservation) and standard numerical methods (symplectic integration) used in astrophysics. All concepts are standard and factually sound.\n    -   **Well-Posed**: The problem provides all necessary information: differential equations (via the potentials), initial conditions, integration algorithm, and precise criteria for evaluation. A unique and meaningful numerical solution exists for each test case.\n    -   **Objective**: The problem is stated using precise, unambiguous mathematical and computational language. All evaluation criteria are quantitative.\n\n3.  **Verdict and Action**: The problem is valid. It is a standard, well-posed problem in computational physics that combines theoretical derivation with numerical implementation and verification. I will proceed with the detailed solution.\n\n### Part 1: Derivation of Analytic Invariants\n\nAn invariant of motion (or a constant of motion) is a function of the phase-space coordinates $Q(\\mathbf{x}, \\mathbf{v})$ that remains constant along a particle's trajectory. Its total time derivative must be zero:\n$$\n\\frac{dQ}{dt} = 0\n$$\nUsing the multivariable chain rule, this can be expanded as:\n$$\n\\frac{dQ}{dt} = \\sum_i \\frac{\\partial Q}{\\partial x_i}\\frac{dx_i}{dt} + \\sum_i \\frac{\\partial Q}{\\partial v_i}\\frac{dv_i}{dt} = \\nabla_{\\mathbf{x}}Q \\cdot \\frac{d\\mathbf{x}}{dt} + \\nabla_{\\mathbf{v}}Q \\cdot \\frac{d\\mathbf{v}}{dt}\n$$\nSubstituting the characteristic equations, $\\frac{d\\mathbf{x}}{dt} = \\mathbf{v}$ and $\\frac{d\\mathbf{v}}{dt} = -\\nabla_{\\mathbf{x}}\\Phi$, we get the condition for an invariant:\n$$\n\\nabla_{\\mathbf{x}}Q \\cdot \\mathbf{v} + \\nabla_{\\mathbf{v}}Q \\cdot (-\\nabla_{\\mathbf{x}}\\Phi) = 0\n$$\n\n**1. Specific Energy Conservation**\n\nThe specific energy (energy per unit mass) of a particle is the sum of its specific kinetic and potential energies:\n$$\nE(\\mathbf{x}, \\mathbf{v}) = \\frac{1}{2}|\\mathbf{v}|^2 + \\Phi(\\mathbf{x}) = \\frac{1}{2}\\sum_i v_i^2 + \\Phi(x_1, x_2, \\dots)\n$$\nTo check if $E$ is an invariant, we compute its total time derivative:\n$$\n\\frac{dE}{dt} = \\nabla_{\\mathbf{x}}E \\cdot \\mathbf{v} + \\nabla_{\\mathbf{v}}E \\cdot (-\\nabla_{\\mathbf{x}}\\Phi)\n$$\nThe necessary gradients are:\n$$\n\\nabla_{\\mathbf{x}}E = \\nabla_{\\mathbf{x}}\\left(\\frac{1}{2}|\\mathbf{v}|^2 + \\Phi(\\mathbf{x})\\right) = \\nabla_{\\mathbf{x}}\\Phi(\\mathbf{x})\n$$\n$$\n\\nabla_{\\mathbf{v}}E = \\nabla_{\\mathbf{v}}\\left(\\frac{1}{2}\\sum_i v_i^2 + \\Phi(\\mathbf{x})\\right) = \\mathbf{v}\n$$\nSubstituting these gradients into the expression for $\\frac{dE}{dt}$:\n$$\n\\frac{dE}{dt} = (\\nabla_{\\mathbf{x}}\\Phi) \\cdot \\mathbf{v} + \\mathbf{v} \\cdot (-\\nabla_{\\mathbf{x}}\\Phi) = (\\nabla_{\\mathbf{x}}\\Phi) \\cdot \\mathbf{v} - \\mathbf{v} \\cdot (\\nabla_{\\mathbf{x}}\\Phi) = 0\n$$\nThus, the specific energy $E$ is conserved for any time-independent potential $\\Phi(\\mathbf{x})$. This applies to all five test cases provided.\n\n**2. Specific Angular Momentum Conservation**\n\nThe specific angular momentum vector is defined as $\\mathbf{L} = \\mathbf{x} \\times \\mathbf{v}$. Its total time derivative is:\n$$\n\\frac{d\\mathbf{L}}{dt} = \\frac{d}{dt}(\\mathbf{x} \\times \\mathbf{v}) = \\frac{d\\mathbf{x}}{dt} \\times \\mathbf{v} + \\mathbf{x} \\times \\frac{d\\mathbf{v}}{dt}\n$$\nSubstituting the characteristic equations:\n$$\n\\frac{d\\mathbf{L}}{dt} = \\mathbf{v} \\times \\mathbf{v} + \\mathbf{x} \\times (-\\nabla_{\\mathbf{x}}\\Phi)\n$$\nSince the cross product of any vector with itself is zero ($\\mathbf{v} \\times \\mathbf{v} = \\mathbf{0}$), this simplifies to:\n$$\n\\frac{d\\mathbf{L}}{dt} = -\\mathbf{x} \\times \\nabla_{\\mathbf{x}}\\Phi\n$$\nThe vector $\\mathbf{\\tau} = \\mathbf{x} \\times \\mathbf{F}$, where the force is $\\mathbf{F} = -\\nabla_{\\mathbf{x}}\\Phi$, represents the specific torque. For $\\mathbf{L}$ to be a constant of motion, its derivative must be zero, which requires the specific torque to be zero: $\\mathbf{x} \\times \\nabla_{\\mathbf{x}}\\Phi = \\mathbf{0}$. This condition is met if and only if the gradient of the potential $\\nabla_{\\mathbf{x}}\\Phi$ is parallel to the position vector $\\mathbf{x}$. This is the definition of a central force, which arises from a spherically symmetric potential, i.e., a potential that depends only on the radial distance $r=|\\mathbf{x}|$, such that $\\Phi(\\mathbf{x}) = \\Phi(r)$.\n\nFor the 2D motion in the $x$-$y$ plane, we are interested in the $z$-component of angular momentum, $L_z = x v_y - y v_x$.\n$$\n\\frac{dL_z}{dt} = \\frac{d}{dt}(x v_y - y v_x) = (\\dot{x}v_y + x\\dot{v}_y) - (\\dot{y}v_x + y\\dot{v}_x)\n$$\nSubstituting $\\dot{x}=v_x$, $\\dot{y}=v_y$, $\\dot{v}_x = -\\partial_x\\Phi$, and $\\dot{v}_y=-\\partial_y\\Phi$:\n$$\n\\frac{dL_z}{dt} = (v_x v_y - x \\partial_y\\Phi) - (v_y v_x - y \\partial_x\\Phi) = y \\partial_x\\Phi - x \\partial_y\\Phi\n$$\nThis term is zero if the potential is spherically symmetric. Let's analyze the test cases:\n- Cases 1, 2, 3, 5 involve potentials that are functions of $r$ only ($\\Phi=0$, $\\Phi=\\tfrac{1}{2}\\omega^2 r^2$, $\\Phi=-GM/r$). These are spherically symmetric, so $L_z$ is an analytic invariant.\n- Case 4 involves the potential $\\Phi(\\mathbf{x})=\\tfrac{1}{2}(\\omega_x^2 x^2+\\omega_y^2 y^2)$. Here, $\\partial_x\\Phi = \\omega_x^2 x$ and $\\partial_y\\Phi = \\omega_y^2 y$. The rate of change of $L_z$ is:\n  $$ \\frac{dL_z}{dt} = y(\\omega_x^2 x) - x(\\omega_y^2 y) = xy(\\omega_x^2 - \\omega_y^2) $$\n  Since $\\omega_x \\neq \\omega_y$, $L_z$ is not conserved unless the particle moves along one of the axes ($x=0$ or $y=0$). For the given initial conditions, the orbit is general, and $L_z$ will not be conserved.\n\n### Part 2: Numerical Integration and Verification\n\nWe use the kick-drift-kick (KDK) leapfrog algorithm, a second-order symplectic integrator. Given the state $(\\mathbf{x}_n, \\mathbf{v}_n)$ at time $t_n$, the state at $t_{n+1} = t_n + \\Delta t$ is computed as:\n1.  **Kick (half step)**: $\\mathbf{v}_{n+1/2} = \\mathbf{v}_n + \\mathbf{a}(\\mathbf{x}_n) \\frac{\\Delta t}{2}$\n2.  **Drift (full step)**: $\\mathbf{x}_{n+1} = \\mathbf{x}_n + \\mathbf{v}_{n+1/2} \\Delta t$\n3.  **Kick (half step)**: $\\mathbf{v}_{n+1} = \\mathbf{v}_{n+1/2} + \\mathbf{a}(\\mathbf{x}_{n+1}) \\frac{\\Delta t}{2}$\nwhere $\\mathbf{a}(\\mathbf{x}) = -\\nabla_{\\mathbf{x}}\\Phi(\\mathbf{x})$ is the acceleration. This method is well-suited for Hamiltonian systems as it approximately conserves energy over long times (with bounded error) and exactly conserves other invariants like angular momentum in central potentials.\n\nWe will implement this algorithm for each test case, track the values of $E$ and $L_z$ over the trajectory, and compute their maximum drift relative to their initial values. The final booleans will indicate whether these drifts are within the specified tolerance. For the anisotropic case, we expect the $L_z$ conservation check to fail, as derived analytically. For the radial motion case, the initial angular momentum $L_{z,0}=0$. The symmetry of the problem will keep the trajectory on the x-axis, so $L_z$ should remain zero up to machine precision. For this case, the absolute drift is used for the conservation check.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the final results.\n    \"\"\"\n    T = 30.0\n    dt = 0.005\n    eps_E = 1e-4\n    eps_L = 1e-4\n    Q_min = 1e-12\n\n    def run_simulation(x0, v0, phi_func, a_func, T, dt, eps_E, eps_L, Q_min):\n        \"\"\"\n        Integrates a particle's trajectory using the leapfrog method\n        and checks for conservation of energy and angular momentum.\n        \"\"\"\n        n_steps = int(T / dt)\n        x = np.copy(x0)\n        v = np.copy(v0)\n\n        # Initial values of invariants\n        E0 = 0.5 * np.dot(v, v) + phi_func(x)\n        Lz0 = x[0] * v[1] - x[1] * v[0]\n        \n        E_hist = [E0]\n        Lz_hist = [Lz0]\n\n        for _ in range(n_steps):\n            # Kick-Drift-Kick Leapfrog\n            v_half = v + a_func(x) * dt / 2.0\n            x = x + v_half * dt\n            v = v_half + a_func(x) * dt / 2.0\n            \n            # Calculate invariants at the end of the step\n            E = 0.5 * np.dot(v, v) + phi_func(x)\n            Lz = x[0] * v[1] - x[1] * v[0]\n            \n            E_hist.append(E)\n            Lz_hist.append(Lz)\n\n        # Convert to numpy arrays for vectorized operations\n        E_hist = np.array(E_hist)\n        Lz_hist = np.array(Lz_hist)\n\n        # --- Energy Conservation Check ---\n        max_abs_drift_E = np.max(np.abs(E_hist - E0))\n        if np.abs(E0) >= Q_min:\n            drift_E = max_abs_drift_E / np.abs(E0)\n        else:\n            drift_E = max_abs_drift_E\n        E_preserved = drift_E <= eps_E\n\n        # --- Angular Momentum Conservation Check ---\n        max_abs_drift_Lz = np.max(np.abs(Lz_hist - Lz0))\n        if np.abs(Lz0) >= Q_min:\n            drift_Lz = max_abs_drift_Lz / np.abs(Lz0)\n        else:\n            drift_Lz = max_abs_drift_Lz\n        Lz_preserved = drift_Lz <= eps_L\n\n        return E_preserved, Lz_preserved\n\n    # --- Test Case Definitions ---\n    \n    # Case 1: Free particle\n    phi_free = lambda x: 0.0\n    a_free = lambda x: np.array([0.0, 0.0])\n    \n    # Case 2: Central harmonic\n    omega_ch = 0.5\n    phi_central_harmonic = lambda x: 0.5 * omega_ch**2 * np.dot(x, x)\n    a_central_harmonic = lambda x: -omega_ch**2 * x\n\n    # Case 3: Kepler potential\n    GM = 1.0\n    def phi_kepler(x):\n        r = np.linalg.norm(x)\n        return -GM / r if r > 0 else -np.inf\n    def a_kepler(x):\n        r = np.linalg.norm(x)\n        return -GM * x / r**3 if r > 0 else np.array([0.0, 0.0])\n\n    # Case 4: Anisotropic harmonic\n    omega_x, omega_y = 1.0, 1.3\n    phi_anisotropic = lambda x: 0.5 * (omega_x**2 * x[0]**2 + omega_y**2 * x[1]**2)\n    a_anisotropic = lambda x: np.array([-omega_x**2 * x[0], -omega_y**2 * x[1]])\n\n    # Case 5: Radial central harmonic (same physics as case 2)\n    \n    test_cases = [\n        # (x0, v0, phi_func, a_func)\n        (np.array([1.0, 0.0]), np.array([0.0, 0.5]), phi_free, a_free),\n        (np.array([1.0, 0.0]), np.array([0.0, 0.8]), phi_central_harmonic, a_central_harmonic),\n        (np.array([1.0, 0.0]), np.array([0.0, 1.0]), phi_kepler, a_kepler),\n        (np.array([1.0, 0.0]), np.array([0.0, 1.0]), phi_anisotropic, a_anisotropic),\n        (np.array([1.0, 0.0]), np.array([-0.5, 0.0]), phi_central_harmonic, a_central_harmonic),\n    ]\n\n    results = []\n    for x0, v0, phi, a in test_cases:\n        E_pres, Lz_pres = run_simulation(x0, v0, phi, a, T, dt, eps_E, eps_L, Q_min)\n        results.append(E_pres)\n        results.append(Lz_pres)\n    \n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3494458"}, {"introduction": "While understanding individual particle trajectories is essential, the power of the collisionless Boltzmann equation lies in describing collective phenomena. In this practice, you will move beyond single-particle dynamics to explore how the Vlasov-Poisson system captures the growth of cosmological structure. By deriving the dispersion relation for the gravitational two-stream instability from first principles, you will see how self-gravity can amplify small initial perturbations, a key mechanism for structure formation in the universe.", "problem": "Consider a one-dimensional, collisionless self-gravitating system described by the Vlasov–Poisson equations. The Vlasov equation for the phase-space distribution function $f(x,v,t)$ is $\\,\\partial_t f + v\\,\\partial_x f - \\partial_x \\phi\\,\\partial_v f = 0\\,$, and the Poisson equation for the gravitational potential $\\phi(x,t)$ is $\\,\\partial_{xx} \\phi = 4\\pi G\\left(\\rho(x,t) - \\rho_0\\right)\\,$, where $\\rho(x,t)=\\int_{-\\infty}^{\\infty} f(x,v,t)\\,dv$ and $\\rho_0$ is the uniform background density. Initialize two cold streams in a uniform background with the distribution function $\\,f(x,v,0)=\\frac{\\rho_0}{2}\\,\\delta(v-v_0)+\\frac{\\rho_0}{2}\\,\\delta(v+v_0)\\,$, where $\\delta$ denotes the Dirac delta. Assume small-amplitude perturbations are sinusoidal in space and time of the form $\\,\\propto e^{i(kx-\\omega t)}\\,$, with wavenumber $k$ and complex frequency $\\omega$.\n\nStarting from the fundamental laws and core definitions above, derive from first principles an appropriate linearized description that captures the gravitational analog of the two-stream growth for this cold-beam configuration. Express the growth rate as the positive imaginary part of the complex frequency $\\,\\omega\\,$ associated with the fastest-growing linear mode at a given $k$. You must ensure that your derivation is logically consistent, begins with the Vlasov–Poisson system, and does not assume or quote the target dispersion relation.\n\nNumerically evaluate the maximum linear growth rate for each parameter set in the following test suite using dimensionless code units with $\\,G=1\\,$ (so all quantities are dimensionless). The final growth rate for each test case must be returned as a real-valued float representing inverse time in these code units. The test suite covers representative cases:\n\n- Case $\\,1\\,$ (single-stream limit as a degenerate two-stream): $\\,\\rho_0=1.0\\,$, $\\,v_0=0.0\\,$, $\\,k=0.1\\,$.\n- Case $\\,2\\,$ (moderate streaming, long wavelength): $\\,\\rho_0=1.0\\,$, $\\,v_0=0.5\\,$, $\\,k=0.2\\,$.\n- Case $\\,3\\,$ (strong streaming, short wavelength): $\\,\\rho_0=1.0\\,$, $\\,v_0=2.0\\,$, $\\,k=1.5\\,$.\n- Case $\\,4\\,$ (discriminant boundary condition): choose $\\,\\rho_0=1.0\\,$, $\\,v_0=1.0\\,$, and set $\\,k=\\sqrt{(A/4)/v_0^2}\\,$ where $\\,A=2\\pi G\\rho_0\\,$, i.e., $\\,k=\\sqrt{\\pi/2}\\approx 1.253314\\,$.\n- Case $\\,5\\,$ (no gravity baseline): $\\,\\rho_0=0.0\\,$, $\\,v_0=1.0\\,$, $\\,k=2.0\\,$.\n\nYour program must compute, for each case, the maximum linear growth rate $\\,\\gamma_{\\max}=\\max\\{\\mathrm{Im}(\\omega)\\}\\,$ among all linear modes implied by your derivation. If no unstable mode exists, return $\\,0.0\\,$ for that case. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $\\,[$result1,result2,result3$]\\,$), ordered exactly as the cases above. No external input is allowed, and all calculations must be performed using the specified code units without any external data. Angles do not appear in this problem; do not introduce any angle units. All final outputs must be floats in inverse time units in the specified dimensionless system.", "solution": "The user has provided a valid, well-posed problem grounded in the standard principles of kinetic theory and gravitational dynamics. The task is to derive the dispersion relation for a self-gravitating two-stream system from first principles and then use it to calculate the maximum linear growth rate for several specific cases.\n\n### Derivation from First Principles\n\nThe system is described by the one-dimensional Vlasov-Poisson equations. The Vlasov equation governs the evolution of the phase-space distribution function $f(x,v,t)$:\n$$\n\\frac{\\partial f}{\\partial t} + v \\frac{\\partial f}{\\partial x} - \\frac{\\partial \\phi}{\\partial x} \\frac{\\partial f}{\\partial v} = 0\n$$\nThe Poisson equation relates the gravitational potential $\\phi(x,t)$ to the mass density $\\rho(x,t)$:\n$$\n\\frac{\\partial^2 \\phi}{\\partial x^2} = 4\\pi G \\left( \\rho(x,t) - \\rho_0 \\right)\n$$\nwhere the mass density is the velocity integral of the distribution function, $\\rho(x,t) = \\int_{-\\infty}^{\\infty} f(x,v,t) \\, dv$.\n\nWe linearize the system by decomposing each quantity into a homogeneous background component (subscript $0$) and a small, first-order perturbation (subscript $1$):\n$f(x,v,t) = f_0(v) + f_1(x,v,t)$\n$\\phi(x,t) = \\phi_0 + \\phi_1(x,t)$\n\nThe background distribution is given as two cold streams symmetric about $v=0$:\n$$\nf_0(v) = \\frac{\\rho_0}{2} \\left[ \\delta(v-v_0) + \\delta(v+v_0) \\right]\n$$\nThe background density is $\\int f_0(v) dv = \\rho_0/2 + \\rho_0/2 = \\rho_0$. The background potential $\\phi_0$ must satisfy the unperturbed Poisson equation, $\\partial_{xx}\\phi_0 = 4\\pi G(\\rho_0 - \\rho_0) = 0$. This implies $\\phi_0$ is constant, so the background gravitational force $-\\partial_x \\phi_0$ is zero. The distribution $f_0(v)$ is independent of $x$ and $t$, so it is a valid equilibrium solution to the Vlasov equation.\n\nSubstituting the perturbed quantities into the Vlasov equation and retaining only first-order terms gives the linearized Vlasov equation:\n$$\n\\frac{\\partial f_1}{\\partial t} + v \\frac{\\partial f_1}{\\partial x} - \\frac{\\partial \\phi_1}{\\partial x} \\frac{\\partial f_0}{\\partial v} = 0\n$$\nSimilarly, the linearized Poisson equation is:\n$$\n\\frac{\\partial^2 \\phi_1}{\\partial x^2} = 4\\pi G \\rho_1\n$$\nwhere $\\rho_1(x,t) = \\int f_1(x,v,t) \\, dv$.\n\nWe assume the perturbations are sinusoidal with wavenumber $k$ and complex frequency $\\omega$, having the form $e^{i(kx-\\omega t)}$. This allows us to replace the partial derivatives with algebraic operators: $\\partial_t \\to -i\\omega$ and $\\partial_x \\to ik$. Applying this to the linearized Vlasov equation for the Fourier amplitudes $\\hat{f}_1(v)$ and $\\hat{\\phi}_1$:\n$$\n-i\\omega \\hat{f}_1 + ikv \\hat{f}_1 - ik\\hat{\\phi}_1 \\frac{\\partial f_0}{\\partial v} = 0\n$$\nSolving for $\\hat{f}_1$:\n$$\n-i(\\omega-kv)\\hat{f}_1 = ik\\hat{\\phi}_1 \\frac{\\partial f_0}{\\partial v} \\implies \\hat{f}_1(v) = -\\frac{k}{\\omega-kv}\\hat{\\phi}_1 \\frac{\\partial f_0}{\\partial v}\n$$\nThe perturbed density amplitude $\\hat{\\rho}_1$ is obtained by integrating $\\hat{f}_1(v)$ over velocity:\n$$\n\\hat{\\rho}_1 = \\int_{-\\infty}^{\\infty} \\hat{f}_1(v) \\, dv = -k\\hat{\\phi}_1 \\int_{-\\infty}^{\\infty} \\frac{1}{\\omega-kv} \\frac{\\partial f_0}{\\partial v} \\, dv\n$$\nWe simplify the integral using integration by parts: $\\int u \\, dv' = [uv] - \\int v \\, du'$. Let $u = \\frac{1}{\\omega-kv}$ and $dv' = \\frac{\\partial f_0}{\\partial v}dv$. Then $du = \\frac{k}{(\\omega-kv)^2}dv$ and $v' = f_0$. The boundary term $[uv]$ vanishes as $f_0 \\to 0$ for $|v| \\to \\infty$.\n$$\n\\int_{-\\infty}^{\\infty} \\frac{1}{\\omega-kv} \\frac{\\partial f_0}{\\partial v} \\, dv = - \\int_{-\\infty}^{\\infty} f_0(v) \\frac{k}{(\\omega-kv)^2} \\, dv\n$$\nSubstituting this back into the expression for $\\hat{\\rho}_1$:\n$$\n\\hat{\\rho}_1 = -k\\hat{\\phi}_1 \\left( -k \\int_{-\\infty}^{\\infty} \\frac{f_0(v)}{(\\omega-kv)^2} \\, dv \\right) = k^2\\hat{\\phi}_1 \\int_{-\\infty}^{\\infty} \\frac{f_0(v)}{(\\omega-kv)^2} \\, dv\n$$\nThe Fourier-transformed Poisson equation is $(ik)^2\\hat{\\phi}_1 = 4\\pi G \\hat{\\rho}_1$, or $-k^2\\hat{\\phi}_1 = 4\\pi G \\hat{\\rho}_1$.\nSubstituting the expression for $\\hat{\\rho}_1$:\n$$\n-k^2\\hat{\\phi}_1 = 4\\pi G \\left( k^2\\hat{\\phi}_1 \\int_{-\\infty}^{\\infty} \\frac{f_0(v)}{(\\omega-kv)^2} \\, dv \\right)\n$$\nFor a non-trivial solution ($\\hat{\\phi}_1 \\neq 0$) and for $k \\neq 0$, we can cancel $k^2\\hat{\\phi}_1$ to obtain the general dispersion relation for a self-gravitating system:\n$$\n-1 = 4\\pi G \\int_{-\\infty}^{\\infty} \\frac{f_0(v)}{(\\omega-kv)^2} \\, dv\n$$\nNow, we evaluate this for the given two-stream distribution $f_0(v) = \\frac{\\rho_0}{2} [ \\delta(v-v_0) + \\delta(v+v_0) ]$. The integral becomes:\n$$\n\\int \\frac{f_0(v)}{(\\omega-kv)^2} dv = \\frac{\\rho_0}{2} \\int \\frac{\\delta(v-v_0) + \\delta(v+v_0)}{(\\omega-kv)^2} dv = \\frac{\\rho_0}{2} \\left[ \\frac{1}{(\\omega-kv_0)^2} + \\frac{1}{(\\omega+kv_0)^2} \\right]\n$$\nThe dispersion relation simplifies to an algebraic equation for $\\omega$:\n$$\n-1 = 4\\pi G \\cdot \\frac{\\rho_0}{2} \\left[ \\frac{1}{(\\omega-kv_0)^2} + \\frac{1}{(\\omega+kv_0)^2} \\right]\n$$\nLet $\\omega_J^2 = 2\\pi G \\rho_0$.\n$$\n-1 = \\omega_J^2 \\left[ \\frac{(\\omega+kv_0)^2 + (\\omega-kv_0)^2}{((\\omega-kv_0)(\\omega+kv_0))^2} \\right] = \\omega_J^2 \\frac{2\\omega^2 + 2(kv_0)^2}{(\\omega^2-(kv_0)^2)^2}\n$$\nRearranging gives a quartic equation in $\\omega$, which is quadratic in $X = \\omega^2$:\n$$\n-(\\omega^2 - (kv_0)^2)^2 = 2\\omega_J^2 (\\omega^2 + (kv_0)^2) \\\\\n-\\left(X^2 - 2X(kv_0)^2 + (kv_0)^4\\right) = 2\\omega_J^2 X + 2\\omega_J^2(kv_0)^2 \\\\\nX^2 + 2(\\omega_J^2 - (kv_0)^2)X + ( (kv_0)^4 + 2\\omega_J^2(kv_0)^2 ) = 0\n$$\nSolving this quadratic equation for $X = \\omega^2$:\n$$\n\\omega^2 = -(\\omega_J^2 - (kv_0)^2) \\pm \\sqrt{(\\omega_J^2 - (kv_0)^2)^2 - ((kv_0)^4 + 2\\omega_J^2(kv_0)^2)} \\\\\n\\omega^2 = (kv_0)^2 - \\omega_J^2 \\pm \\sqrt{\\omega_J^4 - 2\\omega_J^2(kv_0)^2 + (kv_0)^4 - (kv_0)^4 - 2\\omega_J^2(kv_0)^2} \\\\\n\\omega^2 = (kv_0)^2 - \\omega_J^2 \\pm \\sqrt{\\omega_J^4 - 4\\omega_J^2(kv_0)^2} \\\\\n\\omega^2 = (kv_0)^2 - \\omega_J^2 \\pm \\omega_J \\sqrt{\\omega_J^2 - 4(kv_0)^2}\n$$\nAn instability exists if $\\omega$ has a positive imaginary part, $\\gamma = \\mathrm{Im}(\\omega) > 0$. This occurs if $\\omega^2$ is negative or complex. Let $D = \\omega_J^2 - 4(kv_0)^2$ be the discriminant of the radical.\n\nCase I: $D \\geq 0$ (i.e., $k^2v_0^2 \\leq \\omega_J^2/4$).\nThe two solutions for $\\omega^2$ are real. It can be shown that both are negative, corresponding to two purely growing/decaying modes. The growth rates $\\gamma$ are given by $\\gamma^2 = -\\omega^2$. We seek the maximum growth rate, which corresponds to the most negative $\\omega^2$:\n$$\n\\gamma_{\\max}^2 = - \\left( (kv_0)^2 - \\omega_J^2 - \\omega_J \\sqrt{\\omega_J^2 - 4(kv_0)^2} \\right) = \\omega_J^2 - (kv_0)^2 + \\omega_J \\sqrt{\\omega_J^2 - 4(kv_0)^2}\n$$\n\nCase II: $D < 0$ (i.e., $k^2v_0^2 > \\omega_J^2/4$).\nThe solutions for $\\omega^2$ are a complex conjugate pair. Let $\\omega = \\omega_r + i\\gamma$. Then $\\omega^2 = (\\omega_r^2 - \\gamma^2) + i(2\\omega_r\\gamma)$. An analysis of the real and imaginary parts of $\\omega^2$ reveals that unstable modes always exist in this regime. The squared growth rate is given by:\n$$\n\\gamma^2 = \\frac{1}{2} \\left( \\omega_J^2 - (kv_0)^2 + \\sqrt{((kv_0)^2)^2 + 2(kv_0)^2\\omega_J^2} \\right)\n$$\nThere is only one positive growth rate in this case, which is the maximum.\n\nSpecial Cases:\n- If $\\rho_0 = 0$, then $\\omega_J^2 = 0$. The dispersion relation $-1=0$ has no solution, implying no collective modes and $\\gamma=0$.\n- If $v_0 = 0$, the system is a single cold stream. This falls into Case I. The formula gives $\\gamma_{\\max}^2 = \\omega_J^2 + \\omega_J^2 = 2\\omega_J^2 = 2(2\\pi G \\rho_0) = 4\\pi G \\rho_0$. The growth rate is $\\gamma = \\sqrt{4\\pi G \\rho_0}$, the classic Jeans instability rate, which is independent of $k$.\n\nWe now use these formulas to evaluate the growth rate for the given test cases with $G=1$.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves for the maximum linear growth rate of the gravitational two-stream instability\n    for a series of test cases.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1 (single-stream limit as a degenerate two-stream):\n        {'rho0': 1.0, 'v0': 0.0, 'k': 0.1},\n        # Case 2 (moderate streaming, long wavelength):\n        {'rho0': 1.0, 'v0': 0.5, 'k': 0.2},\n        # Case 3 (strong streaming, short wavelength):\n        {'rho0': 1.0, 'v0': 2.0, 'k': 1.5},\n        # Case 4 (discriminant boundary condition):\n        {'rho0': 1.0, 'v0': 1.0, 'k': np.sqrt(np.pi / 2.0)},\n        # Case 5 (no gravity baseline):\n        {'rho0': 0.0, 'v0': 1.0, 'k': 2.0},\n    ]\n\n    results = []\n    G = 1.0\n\n    for case in test_cases:\n        rho0 = case['rho0']\n        v0 = case['v0']\n        k = case['k']\n\n        # If there is no mass, there is no gravity, and thus no instability.\n        if rho0 == 0.0:\n            results.append(0.0)\n            continue\n        \n        # Calculate key parameters from the derived dispersion relation.\n        # omega_J^2 = 2 * pi * G * rho_0\n        omega_J_sq = 2.0 * np.pi * G * rho0\n        kv0_sq = (k * v0)**2\n\n        # The behavior of the instability is determined by the sign of the discriminant D.\n        # D = omega_J^2 - 4 * (k*v_0)^2\n        discriminant = omega_J_sq - 4.0 * kv0_sq\n\n        if discriminant >= 0:\n            # Regime 1: Two purely growing modes exist.\n            # The maximum growth rate corresponds to the most negative omega^2 solution.\n            # gamma_max^2 = omega_J^2 - (kv_0)^2 + omega_J * sqrt(omega_J^2 - 4*(kv_0)^2)\n            gamma_sq = (\n                omega_J_sq - kv0_sq +\n                np.sqrt(omega_J_sq) * np.sqrt(discriminant)\n            )\n        else: # discriminant < 0\n            # Regime 2: A pair of complex conjugate modes exists.\n            # gamma^2 = 0.5 * [omega_J^2 - (kv_0)^2 + sqrt(((kv_0)^2)^2 + 2*(kv_0)^2*omega_J^2)]\n            term_under_sqrt = kv0_sq**2 + 2.0 * kv0_sq * omega_J_sq\n            gamma_sq = 0.5 * (omega_J_sq - kv0_sq + np.sqrt(term_under_sqrt))\n\n        # The growth rate gamma is the square root of gamma_sq.\n        # gamma_sq should always be non-negative from the derivation.\n        # We take max(0, ...) as a safeguard against small negative numbers from floating point errors.\n        gamma_max = np.sqrt(max(0.0, gamma_sq))\n        results.append(gamma_max)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3494537"}, {"introduction": "After linear instabilities begin to grow, the evolution enters a non-linear phase. A key feature of this process for cold, collisionless matter is \"shell crossing,\" where the phase-space sheet folds over itself, creating regions where multiple streams of matter co-exist at the same physical location. This exercise offers a concrete model of this phenomenon using the Zel'dovich approximation, allowing you to numerically count the number of streams and connect the formation of caustics to the emergence of high-density peaks, which are the precursors to virialized dark matter halos.", "problem": "You will work in one spatial dimension within the framework of collisionless cold dark matter governed by the collisionless Boltzmann equation (also called the Vlasov equation) and Newtonian gravity in an expanding background. Consider cold initial conditions represented by a single-valued phase-space sheet in Lagrangian coordinates $q$, evolved into Eulerian coordinates $x$ using first-order Lagrangian perturbation theory in the linear regime and continuing the mapping through shell crossing by summation over Lagrangian roots. Assume the initial peculiar gravitational potential per unit mass is a single-mode cosine,\n$$\\phi_0(q) = -\\frac{A}{k^2}\\cos(k q),$$\nwith amplitude parameter $A>0$ and wavenumber $k>0$. Let $D$ denote a linear growth factor that multiplies the displacement field. Work in comoving, dimensionless units with distances and angles measured in radians and set the background uniform density to $\\rho_0=1$ in arbitrary consistent units.\n\nStarting from the collisionless Boltzmann (Vlasov) equation and Newtonian dynamics in one dimension,\n$$\\frac{\\partial f}{\\partial t} + v \\frac{\\partial f}{\\partial x} - \\frac{\\partial \\Phi}{\\partial x}\\frac{\\partial f}{\\partial v} = 0,$$\ntogether with Poisson’s equation and the assumption of cold initial conditions, derive the first-order Lagrangian mapping $x(q;D)$ in one dimension for this initial potential and its Jacobian $J(q;D)=\\partial x/\\partial q$. Explain how shell crossing occurs when the mapping ceases to be monotone, and argue how the number of streams at an Eulerian position $x$ equals the number of distinct Lagrangian roots $q_i$ that satisfy $x(q_i;D)=x$. Argue that the mass density in one dimension after shell crossing is given by\n$$\\rho(x;D) = \\sum_{i} \\frac{\\rho_0}{\\left|J(q_i;D)\\right|},$$\nwhere the sum is over all roots $q_i$ such that $x(q_i;D)=x$. Explain qualitatively how multi-stream regions correlate with peaks in $\\rho(x;D)$ because of the sum over inverse Jacobians and the vanishing of $J$ at fold caustics.\n\nThen, design and implement a robust numerical algorithm to:\n- Partition the Lagrangian domain into monotonic segments delimited by the zeros of $J(q;D)$.\n- For a given Eulerian position $x_\\star$, count the number of Lagrangian roots by performing bracketing and bisection on each monotonic segment to find solutions of $x(q;D)=x_\\star$.\n- Return the integer number of streams $N_{\\mathrm{streams}}(x_\\star;A,D,k)$.\n\nNumerical requirements:\n- Use the fundamental period $q \\in [-\\pi/k,\\pi/k]$ for the Lagrangian domain and assume periodic boundary conditions.\n- Use angles in radians and dimensionless comoving units throughout.\n- Implement bracketing and bisection in each monotonic Lagrangian segment. Treat function values with magnitude less than $10^{-12}$ as zero for root-detection purposes, and avoid double-counting roots at segment boundaries.\n- Your solver should be deterministic and not require any random numbers.\n\nTest suite and required outputs:\n- You must evaluate the integer number of streams $N_{\\mathrm{streams}}$ for the following six parameter sets $(A,D,k,x_\\star)$:\n  1. $(0.8, 0.9, 1.0, 0.3)$\n  2. $(1.0, 1.2, 1.0, 0.0)$\n  3. $(1.0, 1.2, 1.0, 1.0)$\n  4. $(1.5, 1.2, 1.0, 0.4)$\n  5. $(0.0, 2.0, 1.0, -0.7)$\n  6. $(1.0, 1.0, 1.0, 0.1)$\n\nFinal output format:\n- Your program should produce a single line of output containing the integer results as a comma-separated list enclosed in square brackets, for example, \"[r1,r2,r3,r4,r5,r6]\".\n- The only printed output must be this single line.\n\nYour program must be a complete, runnable implementation in a modern programming language. All computations are dimensionless; no physical unit conversion is necessary, and all angles are in radians. The answers for all test cases must be integers as specified above.", "solution": "The problem requires an analysis of structure formation in one dimension for cold dark matter, starting from fundamental principles and culminating in a numerical algorithm to count the number of streams at a given position.\n\nThe evolution of a collisionless fluid, such as cold dark matter (CDM), is governed by the collisionless Boltzmann equation, also known as the Vlasov equation:\n$$\n\\frac{\\partial f}{\\partial t} + v \\frac{\\partial f}{\\partial x} - \\frac{\\partial \\Phi}{\\partial x}\\frac{\\partial f}{\\partial v} = 0\n$$\nHere, $f(x, v, t)$ is the phase-space distribution function, $x$ is the comoving position, $v$ is the peculiar velocity, and $\\Phi(x, t)$ is the peculiar gravitational potential. The potential is coupled to the mass density $\\rho(x, t)$ through Poisson's equation. For CDM, the initial conditions are \"cold,\" meaning the velocity dispersion is zero. The initial phase-space distribution is a sheet described by $f(x, v, t=0) = \\rho_0 \\delta(v - v_0(x))$, where $\\delta$ is the Dirac delta function.\n\nThis cold-sheet structure is preserved over time in Lagrangian coordinates. The dynamics can be described by mapping initial (Lagrangian) positions $q$ to their final (Eulerian) positions $x$ at a later time. In first-order Lagrangian Perturbation Theory (LPT), also known as the Zel'dovich approximation, this mapping is given by:\n$$\nx(q; D) = q + D(t) s(q)\n$$\nwhere $D(t)$ is the linear growth factor encapsulating the time evolution, and $s(q)$ is the initial displacement field. In one dimension, the displacement field is proportional to the gradient of the initial gravitational potential. A potential minimum must attract particles, so particles at $q>q_{min}$ should have a negative displacement and particles at $q<q_{min}$ should have a positive displacement. The given initial potential is $\\phi_0(q) = -\\frac{A}{k^2}\\cos(k q)$. Its gradient is $\\frac{d\\phi_0}{dq} = \\frac{A}{k}\\sin(k q)$. To ensure matter flows towards potential minima (e.g., towards $q=0$), the displacement must be proportional to $-\\frac{d\\phi_0}{dq}$. Absorbing constants into the definition of the amplitude parameter $A$ and growth factor $D$, we can write the displacement as $s(q) = -\\frac{A}{k}\\sin(kq)$. This leads to the mapping:\n$$\nx(q; A, D, k) = q - \\frac{AD}{k} \\sin(k q)\n$$\n\nThe mapping from Lagrangian to Eulerian space is unique as long as it is monotonic. The transition to a multi-valued mapping is called shell crossing. This occurs when distinct particles from different Lagrangian positions arrive at the same Eulerian position. Mathematically, this corresponds to the point where the Jacobian of the transformation, $J = \\frac{\\partial x}{\\partial q}$, becomes zero.\nThe Jacobian for this mapping is:\n$$\nJ(q; A, D, k) = \\frac{\\partial}{\\partial q} \\left( q - \\frac{AD}{k} \\sin(k q) \\right) = 1 - AD \\cos(k q)\n$$\nShell crossing first occurs when the minimum value of the Jacobian reaches zero. Since the minimum of $\\cos(kq)$ over the domain is $-1$ and its maximum is $1$, the minimum of $J$ is $1 - AD$. This occurs at $q$ where $\\cos(kq)=1$ (e.g., at $q=0$). Therefore, the first shell crossing happens precisely when $AD = 1$.\n- If $AD \\le 1$, then $J(q) \\ge 0$ for all $q$. The mapping $x(q)$ is monotonic, so for any $x$, there is only one corresponding $q$. In this regime, there is always exactly one stream.\n- If $AD > 1$, then $J(q)$ can be negative for certain ranges of $q$. This means the mapping $x(q)$ is non-monotonic, leading to multiple Lagrangian coordinates mapping to the same Eulerian position. These regions are called multi-stream regions.\n\nThe number of streams, $N_{\\mathrm{streams}}$, at an Eulerian position $x_\\star$ is the number of distinct Lagrangian roots $q_i$ that satisfy the equation $x(q_i; D) = x_\\star$.\nThe mass density in Eulerian space is related to the initial uniform density $\\rho_0$ by the conservation of mass. A mass element $dm = \\rho_0 dq$ in Lagrangian space is mapped to an element $dx$ in Eulerian space such that $dm = \\rho(x) |dx|$. This gives $\\rho(x) = \\rho_0 \\left|\\frac{dq}{dx}\\right| = \\frac{\\rho_0}{|J(q)|}$. When multiple streams contribute to the density at $x$, the total density is the sum over all contributing streams (i.e., over all roots $q_i$):\n$$\n\\rho(x;D) = \\sum_{i} \\frac{\\rho_0}{\\left|J(q_i;D)\\right|}\n$$\nThe points where $J(q)=0$ are called fold caustics. At these locations, the model predicts an infinite density, which is an artifact of the cold-sheet approximation. These caustics demark the edges of multi-stream regions and correspond to high-density peaks.\n\nThe numerical task is to find the number of roots $N_{\\mathrm{streams}}(x_\\star; A, D, k)$ of the equation $f(q) = x(q; A, D, k) - x_\\star = 0$ within the Lagrangian domain $q \\in [-\\pi/k, \\pi/k]$. The key is to leverage the monotonicity of $x(q)$ in specific sub-intervals.\nThe algorithm is as follows:\n1.  **Identify Monotonic Segments**: The function $x(q)$ has local extrema where its derivative, the Jacobian $J(q)$, is zero. These extrema partition the domain into monotonic segments.\n    - If $AD \\le 1$, $J(q) \\ge 0$ everywhere, so $x(q)$ is monotonic over the entire domain $[-\\pi/k, \\pi/k]$. There is only one segment.\n    - If $AD > 1$, the equation $J(q) = 1 - AD \\cos(kq) = 0$ has solutions where $\\cos(kq) = 1/(AD)$. Let $\\alpha = \\arccos(1/(AD))$. Within the fundamental period $kq \\in [-\\pi, \\pi]$, the solutions are $q_c = \\pm\\alpha/k$. These two critical points partition the domain $[-\\pi/k, \\pi/k]$ into three monotonic segments: $[-\\pi/k, -\\alpha/k]$, $[-\\alpha/k, \\alpha/k]$, and $[\\alpha/k, \\pi/k]$.\n\n2.  **Count Roots in Each Segment**: For each monotonic segment $[q_a, q_b]$, we can determine the number of roots of $f(q) = 0$. Since the function is monotonic on the segment, it can cross zero at most once.\n    - An interior root exists if and only if $f(q_a)$ and $f(q_b)$ have opposite signs, i.e., $f(q_a)f(q_b) < 0$.\n    - A root can also exist precisely at a boundary point, i.e., $f(q_a) = 0$ or $f(q_b) = 0$.\n\n3.  **Implement Robust Counting**: To count the total number of roots without double-counting roots that fall on segment boundaries, we can adopt the following procedure:\n    a. Define the list of segment boundary points $P = \\{p_0, p_1, \\dots, p_n\\}$, which includes the domain endpoints and any critical points.\n    b. Calculate $y_i = f(p_i)$ for each point in $P$. A tolerance $\\tau = 10^{-12}$ is used, so $|y_i|<\\tau$ implies $y_i=0$.\n    c. Count interior roots: Initialize a counter $N_{internal} = 0$. For each segment $[p_i, p_{i+1}]$, if $y_i \\cdot y_{i+1} < 0$, increment $N_{internal}$.\n    d. Count boundary roots: Initialize a counter $N_{boundary} = 0$. Create a set to store the indices of boundary points that are roots. For each $i \\in \\{0, \\dots, n\\}$, if $|y_i| < \\tau$, add $i$ to the set. The number of boundary roots is the size of this set.\n    e. The total number of streams is $N_{\\mathrm{streams}} = N_{internal} + N_{boundary}$. This method correctly counts roots at extrema and avoids double-counting.\n\nThis structured approach allows us to deterministically find the integer number of streams for any given set of parameters.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test cases.\n    It counts the number of streams for a 1D cold dark matter model.\n    \"\"\"\n    \n    # Test cases defined in the problem statement as (A, D, k, x_star)\n    test_cases = [\n        (0.8, 0.9, 1.0, 0.3),\n        (1.0, 1.2, 1.0, 0.0),\n        (1.0, 1.2, 1.0, 1.0),\n        (1.5, 1.2, 1.0, 0.4),\n        (0.0, 2.0, 1.0, -0.7),\n        (1.0, 1.0, 1.0, 0.1),\n    ]\n\n    results = []\n    for params in test_cases:\n        result = count_streams(*params)\n        results.append(result)\n\n    # Print the final output in the required format\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef count_streams(A: float, D: float, k: float, x_star: float) -> int:\n    \"\"\"\n    Calculates the number of streams N_streams for a given set of parameters.\n\n    The number of streams is the number of roots of the equation x(q) = x_star,\n    where x(q) = q - (A*D/k) * sin(k*q) is the Lagrangian-to-Eulerian mapping.\n\n    Args:\n        A: Amplitude parameter of the initial potential.\n        D: Linear growth factor.\n        k: Wavenumber of the initial potential.\n        x_star: The Eulerian position to evaluate.\n\n    Returns:\n        The integer number of streams at x_star.\n    \"\"\"\n    \n    # Numerical tolerance for checking if a value is zero.\n    tol = 1.0e-12\n\n    # The mapping function x(q)\n    # x(q) = q - (A*D/k) * sin(k*q)\n    # We need to find the number of roots for f(q) = x(q) - x_star = 0\n    C = A * D\n    \n    def f(q: float) -> float:\n        \"\"\"The function whose roots we need to count: f(q) = x(q) - x_star.\"\"\"\n        # Handle the k=0 case to avoid division by zero, though k>0 is assumed.\n        if abs(k) < tol:\n            return q - x_star\n        return q - (C / k) * np.sin(k * q) - x_star\n\n    # The Lagrangian domain is q in [-pi/k, pi/k].\n    q_min = -np.pi / k\n    q_max = np.pi / k\n\n    # Determine monotonic segments based on the value of AD.\n    # Shell crossing occurs if AD > 1.\n    if C <= 1.0:\n        # If AD <= 1, x(q) is monotonic over the entire domain.\n        # The domain consists of a single segment.\n        segment_boundaries = [q_min, q_max]\n    else:\n        # If AD > 1, shell crossing occurred. x(q) has local extrema.\n        # The extrema are at J(q) = 1 - AD*cos(k*q) = 0.\n        # This gives cos(k*q) = 1/AD.\n        alpha = np.arccos(1.0 / C)\n        q_crit1 = -alpha / k\n        q_crit2 = alpha / k\n        # The domain is split into three monotonic segments.\n        segment_boundaries = [q_min, q_crit1, q_crit2, q_max]\n\n    # Evaluate the function f(q) at the segment boundaries.\n    y_vals = [f(p) for p in segment_boundaries]\n\n    # Count roots within the open intervals (p_i, p_{i+1}).\n    # A root exists if f(p_i) and f(p_{i+1}) have opposite signs.\n    num_internal_roots = 0\n    for i in range(len(segment_boundaries) - 1):\n        if y_vals[i] * y_vals[i+1] < 0:\n            num_internal_roots += 1\n\n    # Count roots that fall exactly on the segment boundaries.\n    # Use a set to avoid double-counting if extrema values are identical.\n    boundary_root_indices = set()\n    for i, y_val in enumerate(y_vals):\n        if abs(y_val) < tol:\n            boundary_root_indices.add(i)\n    \n    num_boundary_roots = len(boundary_root_indices)\n\n    # The total number of streams is the sum of internal and boundary roots.\n    total_streams = num_internal_roots + num_boundary_roots\n    \n    return total_streams\n\n# Execute the solver\nsolve()\n```", "id": "3494498"}]}