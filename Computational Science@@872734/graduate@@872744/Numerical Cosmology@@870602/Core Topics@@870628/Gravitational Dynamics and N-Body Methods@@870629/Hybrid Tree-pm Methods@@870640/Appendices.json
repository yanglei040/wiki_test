{"hands_on_practices": [{"introduction": "The core principle of any hybrid Tree-PM method is the division of the gravitational force into short-range and long-range components. This exercise provides foundational practice by guiding you through the derivation of the real-space short-range force that results from a standard Gaussian split in Fourier space [@problem_id:3475892]. Mastering this calculation is a crucial first step toward understanding and implementing the force-splitting kernel at the heart of the algorithm.", "problem": "Consider a hybrid Tree-Particle Mesh (Tree-PM) method in numerical cosmology, where the Newtonian potential of a point mass is split into a short-range (Tree) part and a long-range (Particle Mesh) part using a Gaussian filter of comoving smoothing scale $r_{s}$. The Newtonian potential of a point mass $m$ at the origin is given by $\\phi_{\\mathrm{N}}(r)=-G m/r$, where $G$ is the gravitational constant and $r$ is the comoving separation. In Fourier space, using the convention $\\phi(\\boldsymbol{k})=\\int \\mathrm{d}^{3}\\boldsymbol{r}\\,\\phi(\\boldsymbol{r})\\exp(-\\mathrm{i}\\,\\boldsymbol{k}\\cdot\\boldsymbol{r})$ and $\\phi(\\boldsymbol{r})=\\int \\mathrm{d}^{3}\\boldsymbol{k}\\,\\phi(\\boldsymbol{k})\\exp(\\mathrm{i}\\,\\boldsymbol{k}\\cdot\\boldsymbol{r})/(2\\pi)^{3}$, the Green’s function for the Newtonian potential of a point mass is $\\Phi(\\boldsymbol{k})=-4\\pi G m/k^2$. A Gaussian split is effected by multiplying $\\Phi(\\boldsymbol{k})$ by a Gaussian $W(k)=\\exp(-k^{2} r_{s}^{2})$, thereby defining the long-range part as $\\Phi_{\\mathrm{LR}}(\\boldsymbol{k})=\\Phi(\\boldsymbol{k})W(k)$ and the short-range part as $\\Phi_{\\mathrm{SR}}(\\boldsymbol{k})=\\Phi(\\boldsymbol{k})\\left[1-W(k)\\right]$. The complementary error function is defined by $\\mathrm{erfc}(x)=1-\\mathrm{erf}(x)$, where $\\mathrm{erf}(x)=\\frac{2}{\\sqrt{\\pi}}\\int_{0}^{x}\\exp(-t^{2})\\,\\mathrm{d}t$.\n\nStarting from these definitions and conventions, and without introducing any shortcut formulas beyond the stated fundamental base, derive the real-space short-range potential $\\phi_{\\mathrm{SR}}(r)$ of the point mass by inverse Fourier transformation, and then compute the spherically symmetric radial short-range force magnitude $F_{\\mathrm{SR}}(r)$ from $F_{\\mathrm{SR}}(r)=\\mathrm{d}\\phi_{\\mathrm{SR}}/\\mathrm{d}r$. Express the final $F_{\\mathrm{SR}}(r)$ as a single closed-form analytic expression in terms of $G$, $m$, $r$, $r_{s}$, $\\mathrm{erfc}$, and $\\exp$. Use International System of Units (SI) for any physical quantities; if you were to evaluate numerically, the force would be in Newtons. No numerical evaluation is required; provide an exact expression. Do not round. The final answer must be the explicit analytic expression for $F_{\\mathrm{SR}}(r)$ only.", "solution": "The problem is validated as scientifically grounded, well-posed, and objective. It represents a standard calculation in the context of numerical cosmology simulations. All definitions, conventions, and physical premises are consistent with established principles. The problem is therefore deemed valid and a full solution will be derived.\n\nThe objective is to compute the short-range force magnitude $F_{\\mathrm{SR}}(r)$, which is defined by the problem as the radial derivative of the short-range potential, $F_{\\mathrm{SR}}(r) = \\mathrm{d}\\phi_{\\mathrm{SR}}/\\mathrm{d}r$. To accomplish this, we must first derive the expression for the real-space short-range potential, $\\phi_{\\mathrm{SR}}(r)$.\n\nThe problem states that the short-range potential in Fourier space, $\\Phi_{\\mathrm{SR}}(\\boldsymbol{k})$, is given by the difference between the full Newtonian potential and the long-range potential:\n$$\n\\Phi_{\\mathrm{SR}}(\\boldsymbol{k}) = \\Phi(\\boldsymbol{k}) \\left[1-W(k)\\right] = \\Phi(\\boldsymbol{k}) - \\Phi_{\\mathrm{LR}}(\\boldsymbol{k})\n$$\nwhere $\\Phi(\\boldsymbol{k})$ is the Fourier transform of the full Newtonian potential $\\phi_{\\mathrm{N}}(r)$, and $\\Phi_{\\mathrm{LR}}(\\boldsymbol{k})$ is the Fourier transform of the long-range potential $\\phi_{\\mathrm{LR}}(r)$.\n\nThe inverse Fourier transform is a linear operation. Applying it to the equation above yields the relationship in real space:\n$$\n\\phi_{\\mathrm{SR}}(\\boldsymbol{r}) = \\mathcal{F}^{-1}[\\Phi_{\\mathrm{SR}}(\\boldsymbol{k})] = \\mathcal{F}^{-1}[\\Phi(\\boldsymbol{k})] - \\mathcal{F}^{-1}[\\Phi_{\\mathrm{LR}}(\\boldsymbol{k})]\n$$\nGiven that $\\phi_{\\mathrm{N}}(r)=-G m/r$ is the inverse Fourier transform of $\\Phi(\\boldsymbol{k})$, and since the potential is spherically symmetric, we can write $\\phi_{\\mathrm{SR}}(r)$ as:\n$$\n\\phi_{\\mathrm{SR}}(r) = \\phi_{\\mathrm{N}}(r) - \\phi_{\\mathrm{LR}}(r) = -\\frac{G m}{r} - \\phi_{\\mathrm{LR}}(r)\n$$\nOur first task is to calculate $\\phi_{\\mathrm{LR}}(r)$ by taking the inverse Fourier transform of $\\Phi_{\\mathrm{LR}}(\\boldsymbol{k})$. The problem provides the Fourier convention:\n$$\n\\phi_{\\mathrm{LR}}(\\boldsymbol{r}) = \\int \\frac{\\mathrm{d}^3\\boldsymbol{k}}{(2\\pi)^3} \\Phi_{\\mathrm{LR}}(\\boldsymbol{k}) \\exp(\\mathrm{i}\\,\\boldsymbol{k}\\cdot\\boldsymbol{r})\n$$\nWe are given $\\Phi_{\\mathrm{LR}}(\\boldsymbol{k}) = \\Phi(\\boldsymbol{k})W(k) = \\left(-\\frac{4\\pi G m}{k^2}\\right) \\exp(-k^2 r_s^2)$. Substituting this into the integral:\n$$\n\\phi_{\\mathrm{LR}}(r) = \\int \\frac{\\mathrm{d}^3\\boldsymbol{k}}{(2\\pi)^3} \\left(-\\frac{4\\pi G m}{k^2}\\right) \\exp(-k^2 r_s^2) \\exp(\\mathrm{i}\\,\\boldsymbol{k}\\cdot\\boldsymbol{r})\n$$\nTo evaluate this $3$-dimensional integral, we switch to spherical coordinates in $\\boldsymbol{k}$-space. Let the z-axis be aligned with the vector $\\boldsymbol{r}$, so that $\\boldsymbol{r}$ has magnitude $r=|\\boldsymbol{r}|$ and $\\boldsymbol{k}\\cdot\\boldsymbol{r} = kr\\cos\\theta_k$, where $\\theta_k$ is the polar angle of $\\boldsymbol{k}$. The volume element is $\\mathrm{d}^3\\boldsymbol{k} = k^2 \\sin\\theta_k \\, \\mathrm{d}k \\, \\mathrm{d}\\theta_k \\, \\mathrm{d}\\phi_k$.\n$$\n\\phi_{\\mathrm{LR}}(r) = -\\frac{4\\pi G m}{(2\\pi)^3} \\int_0^\\infty \\mathrm{d}k \\int_0^\\pi \\mathrm{d}\\theta_k \\int_0^{2\\pi} \\mathrm{d}\\phi_k \\, k^2 \\sin\\theta_k \\left(\\frac{1}{k^2}\\right) \\exp(-k^2 r_s^2) \\exp(\\mathrm{i}kr\\cos\\theta_k)\n$$\nThe integral over the azimuthal angle $\\phi_k$ yields $2\\pi$. The $k^2$ terms cancel out.\n$$\n\\phi_{\\mathrm{LR}}(r) = -\\frac{8\\pi^2 G m}{8\\pi^3} \\int_0^\\infty \\mathrm{d}k \\, \\exp(-k^2 r_s^2) \\int_0^\\pi \\mathrm{d}\\theta_k \\, \\sin\\theta_k \\exp(\\mathrm{i}kr\\cos\\theta_k)\n$$\n$$\n\\phi_{\\mathrm{LR}}(r) = -\\frac{G m}{\\pi} \\int_0^\\infty \\mathrm{d}k \\, \\exp(-k^2 r_s^2) \\left[ \\int_0^\\pi \\sin\\theta_k \\exp(\\mathrm{i}kr\\cos\\theta_k) \\, \\mathrm{d}\\theta_k \\right]\n$$\nThe integral in the square brackets can be solved by substituting $u=\\cos\\theta_k$, $\\mathrm{d}u=-\\sin\\theta_k \\mathrm{d}\\theta_k$:\n$$\n\\int_1^{-1} e^{\\mathrm{i}kru} (-\\mathrm{d}u) = \\int_{-1}^1 e^{\\mathrm{i}kru} \\mathrm{d}u = \\left[\\frac{e^{\\mathrm{i}kru}}{\\mathrm{i}kr}\\right]_{-1}^1 = \\frac{e^{\\mathrm{i}kr} - e^{-\\mathrm{i}kr}}{\\mathrm{i}kr} = \\frac{2\\sin(kr)}{kr}\n$$\nSubstituting this result back into the expression for $\\phi_{\\mathrm{LR}}(r)$:\n$$\n\\phi_{\\mathrm{LR}}(r) = -\\frac{G m}{\\pi} \\int_0^\\infty \\exp(-k^2 r_s^2) \\frac{2\\sin(kr)}{kr} \\, \\mathrm{d}k = -\\frac{2 G m}{\\pi r} \\int_0^\\infty \\frac{\\sin(kr)}{k} \\exp(-k^2 r_s^2) \\, \\mathrm{d}k\n$$\nThis integral is a standard form related to the error function, $\\mathrm{erf}(x)$. The identity is $\\int_0^\\infty \\frac{\\sin(ax)}{x} \\exp(-b^2 x^2) \\mathrm{d}x = \\frac{\\pi}{2} \\mathrm{erf}\\left(\\frac{a}{2b}\\right)$. Here, we have $x=k$, $a=r$, and $b=r_s$.\n$$\n\\int_0^\\infty \\frac{\\sin(kr)}{k} \\exp(-k^2 r_s^2) \\, \\mathrm{d}k = \\frac{\\pi}{2} \\mathrm{erf}\\left(\\frac{r}{2r_s}\\right)\n$$\nPlugging this into the expression for $\\phi_{\\mathrm{LR}}(r)$:\n$$\n\\phi_{\\mathrm{LR}}(r) = -\\frac{2 G m}{\\pi r} \\left(\\frac{\\pi}{2} \\mathrm{erf}\\left(\\frac{r}{2r_s}\\right)\\right) = -\\frac{G m}{r} \\mathrm{erf}\\left(\\frac{r}{2r_s}\\right)\n$$\nNow we can write the short-range potential $\\phi_{\\mathrm{SR}}(r)$:\n$$\n\\phi_{\\mathrm{SR}}(r) = -\\frac{G m}{r} - \\left(-\\frac{G m}{r} \\mathrm{erf}\\left(\\frac{r}{2r_s}\\right)\\right) = -\\frac{G m}{r} \\left(1 - \\mathrm{erf}\\left(\\frac{r}{2r_s}\\right)\\right)\n$$\nUsing the given definition of the complementary error function, $\\mathrm{erfc}(x) = 1 - \\mathrm{erf}(x)$, we obtain the final expression for the short-range potential:\n$$\n\\phi_{\\mathrm{SR}}(r) = -\\frac{G m}{r} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right)\n$$\nThe final step is to compute the force magnitude $F_{\\mathrm{SR}}(r)$ by differentiating $\\phi_{\\mathrm{SR}}(r)$ with respect to $r$.\n$$\nF_{\\mathrm{SR}}(r) = \\frac{\\mathrm{d}}{\\mathrm{d}r}\\phi_{\\mathrm{SR}}(r) = \\frac{\\mathrm{d}}{\\mathrm{d}r}\\left[ -\\frac{G m}{r} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) \\right]\n$$\nUsing the product rule for differentiation, $(uv)' = u'v + uv'$:\n$$\nF_{\\mathrm{SR}}(r) = -G m \\left[ \\left(\\frac{\\mathrm{d}}{\\mathrm{d}r}\\frac{1}{r}\\right) \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) + \\frac{1}{r} \\left(\\frac{\\mathrm{d}}{\\mathrm{d}r}\\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right)\\right) \\right]\n$$\n$$\nF_{\\mathrm{SR}}(r) = -G m \\left[ -\\frac{1}{r^2} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) + \\frac{1}{r} \\left(\\frac{\\mathrm{d}}{\\mathrm{d}r}\\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right)\\right) \\right]\n$$\nTo find the derivative of $\\mathrm{erfc}$, we use its definition in terms of the error function integral: $\\frac{\\mathrm{d}}{\\mathrm{d}x}\\mathrm{erf}(x) = \\frac{2}{\\sqrt{\\pi}}\\exp(-x^2)$. Thus, $\\frac{\\mathrm{d}}{\\mathrm{d}x}\\mathrm{erfc}(x) = -\\frac{2}{\\sqrt{\\pi}}\\exp(-x^2)$. Using the chain rule with argument $u = r/(2r_s)$, for which $\\mathrm{d}u/\\mathrm{d}r = 1/(2r_s)$:\n$$\n\\frac{\\mathrm{d}}{\\mathrm{d}r}\\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) = \\left( -\\frac{2}{\\sqrt{\\pi}}\\exp\\left(-\\left(\\frac{r}{2r_s}\\right)^2\\right) \\right) \\cdot \\frac{1}{2r_s} = -\\frac{1}{r_s\\sqrt{\\pi}}\\exp\\left(-\\frac{r^2}{4r_s^2}\\right)\n$$\nSubstituting this derivative back into the expression for $F_{\\mathrm{SR}}(r)$:\n$$\nF_{\\mathrm{SR}}(r) = -G m \\left[ -\\frac{1}{r^2} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) + \\frac{1}{r} \\left(-\\frac{1}{r_s\\sqrt{\\pi}}\\exp\\left(-\\frac{r^2}{4r_s^2}\\right)\\right) \\right]\n$$\n$$\nF_{\\mathrm{SR}}(r) = -G m \\left[ -\\frac{1}{r^2} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) - \\frac{1}{r r_s\\sqrt{\\pi}}\\exp\\left(-\\frac{r^2}{4r_s^2}\\right) \\right]\n$$\nDistributing the leading factor $-G m$ gives the final expression for the short-range force magnitude as defined in the problem:\n$$\nF_{\\mathrm{SR}}(r) = \\frac{G m}{r^2} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) + \\frac{G m}{r r_s\\sqrt{\\pi}} \\exp\\left(-\\frac{r^2}{4r_s^2}\\right)\n$$\nThis is a single closed-form analytic expression in terms of the specified quantities.", "answer": "$$\\boxed{\\frac{G m}{r^2} \\mathrm{erfc}\\left(\\frac{r}{2r_s}\\right) + \\frac{G m}{r r_s\\sqrt{\\pi}} \\exp\\left(-\\frac{r^2}{4r_s^2}\\right)}$$", "id": "3475892"}, {"introduction": "An efficient and accurate simulation requires that the errors from the Tree and PM components are well-balanced. This practice delves into the practical optimization of the tree algorithm's opening parameter, $\\theta$, by matching its multipole truncation error to the residual PM error at the force-splitting scale $r_s$ [@problem_id:3475856]. This principle of error balancing allows for a computationally optimal choice of simulation parameters, ensuring consistent accuracy across all spatial scales.", "problem": "Consider a hybrid Tree–Particle-Mesh (Tree–PM) method in numerical cosmology that splits the Newtonian gravitational potential into a long-range component solved on a Particle-Mesh (PM) grid and a short-range component computed by a tree algorithm. The long-range/short-range split is implemented via a Gaussian filter in Fourier space with characteristic splitting scale $r_{s}$, such that the short-range real-space potential for a point mass $m$ is the Newtonian potential weighted by the complementary error function $\\operatorname{erfc}$, i.e., the short-range potential fraction at separation $r$ is $\\operatorname{erfc}\\!\\left(r/(2 r_{s})\\right)$. The tree employs the standard opening criterion $s/d \\le \\theta$, where $s$ is the size of a source cell, $d$ is the distance from the target point to the cell’s center of mass, and $\\theta$ is a dimensionless opening parameter.\n\nAssume the tree potential is constructed by truncating the multipole expansion at the monopole, so the leading neglected term is the quadrupole. Let the quadrupole contribution to the potential error scale as $E_{M_{2}}(d) \\sim G |M_{2}|/d^{3}$, where $G$ is the gravitational constant and $M_{2}$ is a scalar measure of the quadrupole moment amplitude of the cell (for example, a spectral norm applied to the traceless quadrupole tensor). For a conservative, geometry-independent bound, adopt $|M_{2}| \\le M s^{2}$, where $M$ is the total mass of the cell. Use the Newtonian monopole potential magnitude $|\\Phi_{M}(d)| \\sim G M/d$ as the normalization for a fractional potential error.\n\nDefine the target fractional error $\\epsilon_{\\rm target}$ by matching the tree’s quadrupole truncation error at the splitting scale to the PM residual amplitude at $r=r_{s}$ in the potential, i.e., set $\\epsilon_{\\rm target} = \\operatorname{erfc}\\!\\left(\\frac{1}{2}\\right)$. Impose the requirement that the fractional tree truncation error at the opening threshold be no larger than $\\epsilon_{\\rm target}$.\n\nUnder these assumptions and definitions, derive an analytic expression for the optimal opening parameter $\\theta_{\\rm opt}$ in terms of $\\epsilon_{\\rm target}$ and evaluate it numerically using the above Gaussian split. Express your final answer for $\\theta_{\\rm opt}$ as a dimensionless number. Round your answer to $4$ significant figures.", "solution": "The problem is first validated to ensure it is scientifically sound, well-posed, and objective.\n\n**Step 1: Extract Givens**\n- **Method**: Hybrid Tree–Particle-Mesh (Tree–PM).\n- **Potential Split**: Long-range (PM) and short-range (Tree).\n- **Splitting Scale**: $r_{s}$.\n- **Short-Range Potential Fraction**: $\\operatorname{erfc}(r/(2 r_{s}))$ at separation $r$.\n- **Tree Opening Criterion**: $s/d \\le \\theta$, where $s$ is cell size, $d$ is distance to cell, and $\\theta$ is the opening parameter.\n- **Tree Approximation**: Monopole only, leading error is from the quadrupole.\n- **Quadrupole Error Scaling**: $E_{M_{2}}(d) \\sim G |M_{2}|/d^{3}$, with $M_2$ a measure of the quadrupole moment.\n- **Quadrupole Moment Bound**: $|M_{2}| \\le M s^{2}$, with $M$ being the cell mass.\n- **Error Normalization**: $|\\Phi_{M}(d)| \\sim G M/d$.\n- **Target Fractional Error**: $\\epsilon_{\\rm target} = \\operatorname{erfc}(\\frac{1}{2})$.\n- **Constraint**: The fractional tree truncation error at the opening threshold must be no larger than $\\epsilon_{\\rm target}$.\n- **Objective**: Derive an expression for the optimal opening parameter $\\theta_{\\rm opt}$ and evaluate it numerically, rounded to $4$ significant figures.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is scientifically grounded. The hybrid Tree-PM method, the use of a Gaussian split characterized by the complementary error function $\\operatorname{erfc}$, the Barnes-Hut opening criterion ($s/d \\le \\theta$), and the multipole expansion for gravitational potentials are all standard, well-established concepts in computational cosmology and astrophysics. The error scalings and bounds provided ($E_{M_2} \\propto d^{-3}$, $|M_2| \\le Ms^2$) are standard approximations used for performance and error analysis of such algorithms.\n\nThe problem is well-posed. It provides all necessary definitions, scalings, and constraints to derive a unique expression for the opening parameter $\\theta_{\\rm opt}$. The language is objective and precise, with no ambiguities.\n\n**Step 3: Verdict and Action**\nThe problem is deemed **valid**. A solution will be derived.\n\nThe derivation proceeds as follows. First, we formulate the fractional tree truncation error. The error is dominated by the leading neglected term in the multipole expansion, which is the quadrupole term. The magnitude of this potential error is given to scale as:\n$$E_{M_{2}}(d) \\sim \\frac{G |M_{2}|}{d^{3}}$$\nwhere $G$ is the gravitational constant, $|M_{2}|$ is the magnitude of the quadrupole moment of the source cell, and $d$ is the distance to the target point.\n\nThis error is to be normalized by the magnitude of the monopole potential, which is given as:\n$$|\\Phi_{M}(d)| \\sim \\frac{G M}{d}$$\nwhere $M$ is the total mass of the cell.\n\nThe fractional tree truncation error, $\\epsilon_{\\rm tree}$, is the ratio of these two quantities:\n$$\\epsilon_{\\rm tree}(d) = \\frac{E_{M_{2}}(d)}{|\\Phi_{M}(d)|} \\sim \\frac{G |M_{2}|/d^{3}}{G M/d} = \\frac{|M_{2}|}{M d^{2}}$$\n\nTo obtain a conservative bound, we use the provided geometry-independent upper limit for the quadrupole moment: $|M_{2}| \\le M s^{2}$, where $s$ is the size of the source cell. Substituting this into the expression for the fractional error gives:\n$$\\epsilon_{\\rm tree}(d) \\le \\frac{M s^{2}}{M d^{2}} = \\left(\\frac{s}{d}\\right)^{2}$$\nThis expression bounds the fractional error in terms of the ratio $s/d$.\n\nThe tree algorithm employs the opening criterion $s/d \\le \\theta$. The algorithm treats a cell as a point mass (monopole) as long as this condition is met. The most permissive case, which represents the condition at the threshold of opening the cell, is when the ratio reaches its maximum allowed value, $s/d = \\theta$. At this opening threshold, the upper bound on the fractional truncation error is:\n$$\\epsilon_{\\rm tree, threshold} \\le \\theta^{2}$$\n\nThe problem requires that this a priori estimate of the truncation error be matched to the scale-dependent error introduced by the long-range/short-range force split. The target fractional error, $\\epsilon_{\\rm target}$, is defined by evaluating the PM residual (i.e., the short-range potential fraction) at the characteristic splitting scale $r=r_s$. The short-range potential fraction is given as $\\operatorname{erfc}(r/(2r_s))$. Thus,\n$$\\epsilon_{\\rm target} = \\operatorname{erfc}\\left(\\frac{r_s}{2 r_s}\\right) = \\operatorname{erfc}\\left(\\frac{1}{2}\\right)$$\n\nThe final constraint is that the fractional tree truncation error at the opening threshold should be no larger than this target error: $\\epsilon_{\\rm tree, threshold} \\le \\epsilon_{\\rm target}$. To find the optimal opening parameter, $\\theta_{\\rm opt}$, we balance the errors by setting the maximum possible tree error at the opening threshold equal to the target error. A smaller $\\theta$ would be computationally more expensive (more nodes opened) but more accurate than needed, while a larger $\\theta$ would violate the error-balancing principle. Therefore, the optimal choice is to set:\n$$\\theta_{\\rm opt}^2 = \\epsilon_{\\rm target}$$\n\nSolving for $\\theta_{\\rm opt}$, we get:\n$$\\theta_{\\rm opt} = \\sqrt{\\epsilon_{\\rm target}}$$\n\nSubstituting the expression for $\\epsilon_{\\rm target}$:\n$$\\theta_{\\rm opt} = \\sqrt{\\operatorname{erfc}\\left(\\frac{1}{2}\\right)}$$\n\nNow, we evaluate this expression numerically. The complementary error function is defined as $\\operatorname{erfc}(x) = 1 - \\operatorname{erf}(x)$, where $\\operatorname{erf}(x)$ is the error function.\nThe value of $\\operatorname{erfc}(1/2)$ is required.\n$$\\operatorname{erfc}(0.5) \\approx 0.479500122187$$\nTaking the square root gives the value for the optimal opening parameter:\n$$\\theta_{\\rm opt} = \\sqrt{0.479500122187} \\approx 0.69245947203$$\n\nThe problem asks for the answer to be rounded to $4$ significant figures.\nThe first four significant figures are $6$, $9$, $2$, $4$. The fifth digit is $5$, so we round up the fourth digit.\n$$\\theta_{\\rm opt} \\approx 0.6925$$\nThis is the final numerical value for the optimal opening parameter under the given assumptions.", "answer": "$$\\boxed{0.6925}$$", "id": "3475856"}, {"introduction": "While the PM method is highly efficient for long-range forces, its reliance on a discrete grid can introduce numerical artifacts like force anisotropy. This exercise explores the origin of this effect, where the computed force magnitude depends on its orientation relative to the grid axes [@problem_id:3475881]. By analyzing the discrete Green's function and CIC windowing, you will learn how to construct a more accurate, isotropic force solver, a vital refinement for high-precision cosmological simulations.", "problem": "Consider a hybrid Tree–Particle-Mesh (Tree–PM) gravity solver used in numerical cosmology. The long-range field is handled by the Particle-Mesh (PM) component on a uniform cubic mesh of spacing $\\Delta x$ using a Fast Fourier Transform (FFT) Poisson solver, and the short-range field is handled by the tree. In the PM step, a density field $\\delta(\\boldsymbol{x})$ is assigned to the mesh by the Cloud-In-Cell (CIC) scheme, the potential is computed in Fourier space by applying a Green’s function $G(\\boldsymbol{k})$, and forces are obtained by taking the spectral gradient $- \\mathrm{i} \\boldsymbol{k} \\Phi(\\boldsymbol{k})$ and interpolating back to particle positions with the same CIC scheme. Assume a periodic domain and that the density is a single plane-wave mode $\\delta(\\boldsymbol{x}) = \\delta_{0} \\exp\\left(\\mathrm{i} \\boldsymbol{k} \\cdot \\boldsymbol{x}\\right)$ with $|\\boldsymbol{k}| \\equiv k$ well below the Nyquist wavenumber, so that aliasing can be neglected.\n\nThe standard FFT PM solver uses the discrete Laplacian Green’s function\n$$\nG_{\\mathrm{std}}(\\boldsymbol{k}) = - \\frac{1}{\\hat{k}^{2}},\n\\quad\n\\hat{k}^{2} \\equiv \\frac{4}{\\Delta x^{2}} \\sum_{i=1}^{3} \\sin^{2}\\!\\left(\\frac{k_{i} \\Delta x}{2}\\right),\n$$\nand computes forces using the spectral gradient $-\\mathrm{i} \\boldsymbol{k} \\Phi(\\boldsymbol{k})$. Ignore the CIC window and any deconvolution for the first part of this exercise, so that only $G_{\\mathrm{std}}(\\boldsymbol{k})$ controls the directional response. Define the dimensionless wavenumber $q \\equiv k \\Delta x$. For two modes of equal magnitude $k$, one aligned with a coordinate axis, $\\boldsymbol{k}_{\\mathrm{ax}} = (k, 0, 0)$, and one aligned with the space diagonal, $\\boldsymbol{k}_{\\mathrm{dg}} = \\left(k/\\sqrt{3}, k/\\sqrt{3}, k/\\sqrt{3}\\right)$, derive the analytic expression for the ratio of PM force magnitudes $R(q) \\equiv \\left|\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}_{\\mathrm{ax}})\\right| / \\left|\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}_{\\mathrm{dg}})\\right|$ when using $G_{\\mathrm{std}}(\\boldsymbol{k})$. Treat all proportionality constants (such as $4 \\pi G$, the scale factor, and the mean density) symbolically and note that they cancel in the ratio.\n\nNext, to reduce anisotropy in the PM force in a Tree–PM method, propose an improved Fourier-space Green’s function $G_{\\mathrm{imp}}(\\boldsymbol{k})$ that uses the continuous isotropic kernel $-1/k^2$ and explicitly deconvolves the Cloud-In-Cell window incurred by both the mass assignment and the force interpolation. The Cloud-In-Cell window in one dimension is $W_{\\mathrm{CIC}}(k_{i}) = \\left[\\mathrm{sinc}\\!\\left(\\frac{k_{i} \\Delta x}{2}\\right)\\right]^{2}$ with $\\mathrm{sinc}(x) \\equiv \\sin(x)/x$, and the three-dimensional window factorizes over coordinates. Write $G_{\\mathrm{imp}}(\\boldsymbol{k})$ as a closed-form analytic expression in terms of $\\boldsymbol{k}$ and $\\Delta x$.\n\nProvide your final answer as the two-entry row matrix $\\left(R(q), G_{\\mathrm{imp}}(\\boldsymbol{k})\\right)$ expressed purely in analytic form, with no numerical substitution. If you choose to define any special functions, do so in the body of your derivation; the final answer must contain only the expressions themselves. You do not need to supply units, and no rounding is required.", "solution": "The problem requires the derivation of two quantities related to a hybrid Tree-PM gravity solver: first, the ratio of force magnitudes for two different wavevectors using a standard Particle-Mesh (PM) solver, and second, an improved Green's function that corrects for numerical artifacts.\n\nPart 1: Derivation of the force ratio $R(q)$.\n\nThe gravitational force field $\\boldsymbol{F}(\\boldsymbol{x})$ is related to the gravitational potential $\\Phi(\\boldsymbol{x})$ by $\\boldsymbol{F}(\\boldsymbol{x}) = - \\nabla \\Phi(\\boldsymbol{x})$. In Fourier space, this relationship becomes $\\boldsymbol{F}(\\boldsymbol{k}) = - \\mathrm{i} \\boldsymbol{k} \\Phi(\\boldsymbol{k})$. The potential is related to the density contrast field $\\delta(\\boldsymbol{x})$ by the Poisson equation, $\\nabla^2 \\Phi(\\boldsymbol{x}) = C \\delta(\\boldsymbol{x})$, where $C$ is a constant incorporating $4 \\pi G$ and other cosmological parameters. In Fourier space, this is $-k^2 \\Phi(\\boldsymbol{k}) = C \\delta(\\boldsymbol{k})$, where $k = |\\boldsymbol{k}|$. The true continuous-space Green's function is thus $G_{\\mathrm{true}}(\\boldsymbol{k}) = -1/k^2$, and $\\Phi(\\boldsymbol{k}) = C G_{\\mathrm{true}}(\\boldsymbol{k}) \\delta(\\boldsymbol{k})$.\n\nThe problem describes a PM solver where the potential for a given density mode $\\delta(\\boldsymbol{k})$ is computed as $\\Phi(\\boldsymbol{k}) = C G_{\\mathrm{std}}(\\boldsymbol{k}) \\delta(\\boldsymbol{k})$, using the discrete Green's function\n$$\nG_{\\mathrm{std}}(\\boldsymbol{k}) = - \\frac{1}{\\hat{k}^{2}}, \\quad \\text{where} \\quad \\hat{k}^{2} \\equiv \\frac{4}{\\Delta x^{2}} \\sum_{i=1}^{3} \\sin^{2}\\!\\left(\\frac{k_{i} \\Delta x}{2}\\right).\n$$\nFor this part, we are instructed to ignore the effects of the Cloud-In-Cell (CIC) window function. The force in Fourier space is given as $\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}) = - \\mathrm{i} \\boldsymbol{k} \\Phi(\\boldsymbol{k})$. Substituting the expression for $\\Phi(\\boldsymbol{k})$:\n$$\n\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}) = - \\mathrm{i} \\boldsymbol{k} \\left( C G_{\\mathrm{std}}(\\boldsymbol{k}) \\delta(\\boldsymbol{k}) \\right).\n$$\nThe magnitude of this force vector is:\n$$\n|\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k})| = |-\\mathrm{i} \\boldsymbol{k}| |C G_{\\mathrm{std}}(\\boldsymbol{k}) \\delta(\\boldsymbol{k})|.\n$$\nSince $\\delta(\\boldsymbol{k})$ is a scalar amplitude for the mode $\\boldsymbol{k}$, and $C$ is a constant, we can write the magnitude as being proportional to:\n$$\n|\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k})| \\propto |\\boldsymbol{k}| |G_{\\mathrm{std}}(\\boldsymbol{k})| = k \\left| - \\frac{1}{\\hat{k}^{2}} \\right| = \\frac{k}{\\hat{k}^{2}}.\n$$\nThe constants of proportionality will cancel when we take the ratio $R(q)$.\n\nWe now evaluate this expression for the two specified wavevectors.\n\n1.  For the axis-aligned mode, $\\boldsymbol{k}_{\\mathrm{ax}} = (k, 0, 0)$:\nThe components are $k_1 = k$, $k_2 = 0$, and $k_3 = 0$. The discrete wavenumber-squared becomes:\n$$\n\\hat{k}_{\\mathrm{ax}}^{2} = \\frac{4}{\\Delta x^{2}} \\left[ \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2}\\right) + \\sin^{2}\\!\\left(\\frac{0 \\cdot \\Delta x}{2}\\right) + \\sin^{2}\\!\\left(\\frac{0 \\cdot \\Delta x}{2}\\right) \\right] = \\frac{4}{\\Delta x^{2}} \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2}\\right).\n$$\nThe magnitude of the force for this mode is then proportional to:\n$$\n|\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}_{\\mathrm{ax}})| \\propto \\frac{k}{\\hat{k}_{\\mathrm{ax}}^{2}} = \\frac{k}{\\frac{4}{\\Delta x^{2}} \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2}\\right)} = \\frac{k \\Delta x^{2}}{4 \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2}\\right)}.\n$$\n\n2.  For the space-diagonal mode, $\\boldsymbol{k}_{\\mathrm{dg}} = \\left(k/\\sqrt{3}, k/\\sqrt{3}, k/\\sqrt{3}\\right)$:\nThe components are $k_1 = k_2 = k_3 = k/\\sqrt{3}$. The discrete wavenumber-squared is:\n$$\n\\hat{k}_{\\mathrm{dg}}^{2} = \\frac{4}{\\Delta x^{2}} \\sum_{i=1}^{3} \\sin^{2}\\!\\left(\\frac{(k/\\sqrt{3}) \\Delta x}{2}\\right) = \\frac{4}{\\Delta x^{2}} \\cdot 3 \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2\\sqrt{3}}\\right) = \\frac{12}{\\Delta x^{2}} \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2\\sqrt{3}}\\right).\n$$\nThe magnitude of the force for this mode is proportional to:\n$$\n|\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}_{\\mathrm{dg}})| \\propto \\frac{k}{\\hat{k}_{\\mathrm{dg}}^{2}} = \\frac{k}{\\frac{12}{\\Delta x^{2}} \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2\\sqrt{3}}\\right)} = \\frac{k \\Delta x^{2}}{12 \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2\\sqrt{3}}\\right)}.\n$$\nThe ratio $R(q)$ is defined as the ratio of these two force magnitudes:\n$$\nR(q) = \\frac{|\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}_{\\mathrm{ax}})|}{|\\boldsymbol{F}_{\\mathrm{PM}}(\\boldsymbol{k}_{\\mathrm{dg}})|} = \\frac{\\frac{k \\Delta x^{2}}{4 \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2}\\right)}}{\\frac{k \\Delta x^{2}}{12 \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2\\sqrt{3}}\\right)}} = \\frac{12 \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2\\sqrt{3}}\\right)}{4 \\sin^{2}\\!\\left(\\frac{k \\Delta x}{2}\\right)}.\n$$\nIntroducing the dimensionless wavenumber $q \\equiv k \\Delta x$, we get the final expression for the ratio:\n$$\nR(q) = 3 \\frac{\\sin^{2}\\!\\left(\\frac{q}{2\\sqrt{3}}\\right)}{\\sin^{2}\\!\\left(\\frac{q}{2}\\right)}.\n$$\n\nPart 2: Derivation of the improved Green's function $G_{\\mathrm{imp}}(\\boldsymbol{k})$.\n\nThe goal is to construct a Green's function $G_{\\mathrm{imp}}(\\boldsymbol{k})$ such that the numerically computed force closely matches the true physical force. The numerical procedure involves several steps, each introducing a modification in Fourier space.\nThe true force is $\\boldsymbol{F}_{\\mathrm{true}}(\\boldsymbol{k}) = -\\mathrm{i}\\boldsymbol{k} \\Phi_{\\mathrm{true}}(\\boldsymbol{k}) = -\\mathrm{i}\\boldsymbol{k} (C G_{\\mathrm{true}}(\\boldsymbol{k}) \\delta_{\\mathrm{true}}(\\boldsymbol{k}))$. With $G_{\\mathrm{true}}(\\boldsymbol{k}) = -1/k^2$ and absorbing the constant $C$, we have $\\boldsymbol{F}_{\\mathrm{true}}(\\boldsymbol{k}) \\propto \\frac{\\mathrm{i}\\boldsymbol{k}}{k^2}\\delta_{\\mathrm{true}}(\\boldsymbol{k})$.\n\nThe numerical computation proceeds as follows:\n1.  **Mass Assignment**: The continuous density field is assigned to the grid. For the CIC scheme, this convolution in real space is equivalent to multiplication by a window function $W(\\boldsymbol{k})$ in Fourier space. The grid density is $\\delta_{g}(\\boldsymbol{k}) = W(\\boldsymbol{k}) \\delta_{\\mathrm{true}}(\\boldsymbol{k})$.\n2.  **Poisson Solve**: The potential on the grid is computed using the Green's function: $\\Phi_{g}(\\boldsymbol{k}) = G_{\\mathrm{imp}}(\\boldsymbol{k}) \\delta_{g}(\\boldsymbol{k})$.\n3.  **Force Calculation**: The force field on the grid is computed by taking the gradient. Assuming a spectral gradient as in Part 1, $\\boldsymbol{F}_{g}(\\boldsymbol{k}) = -\\mathrm{i}\\boldsymbol{k} \\Phi_{g}(\\boldsymbol{k})$.\n4.  **Force Interpolation**: The forces are interpolated from the grid back to the particle positions. This step is equivalent to another convolution with the CIC kernel, or multiplication by $W(\\boldsymbol{k})$ in Fourier space. The final numerical force is $\\boldsymbol{F}_{\\mathrm{num}}(\\boldsymbol{k}) = W(\\boldsymbol{k}) \\boldsymbol{F}_{g}(\\boldsymbol{k})$.\n\nCombining these steps, we find the expression for the numerical force:\n$$\n\\boldsymbol{F}_{\\mathrm{num}}(\\boldsymbol{k}) = W(\\boldsymbol{k}) \\left( -\\mathrm{i}\\boldsymbol{k} \\Phi_{g}(\\boldsymbol{k}) \\right) = W(\\boldsymbol{k}) \\left( -\\mathrm{i}\\boldsymbol{k} \\left( G_{\\mathrm{imp}}(\\boldsymbol{k}) \\delta_{g}(\\boldsymbol{k}) \\right) \\right) = W(\\boldsymbol{k}) \\left( -\\mathrm{i}\\boldsymbol{k} G_{\\mathrm{imp}}(\\boldsymbol{k}) W(\\boldsymbol{k}) \\delta_{\\mathrm{true}}(\\boldsymbol{k}) \\right)\n$$\n$$\n\\boldsymbol{F}_{\\mathrm{num}}(\\boldsymbol{k}) = -\\mathrm{i}\\boldsymbol{k} W(\\boldsymbol{k})^2 G_{\\mathrm{imp}}(\\boldsymbol{k}) \\delta_{\\mathrm{true}}(\\boldsymbol{k}).\n$$\nTo make the numerical force equal to the true force, we set $\\boldsymbol{F}_{\\mathrm{num}}(\\boldsymbol{k}) \\propto \\boldsymbol{F}_{\\mathrm{true}}(\\boldsymbol{k})$:\n$$\n-\\mathrm{i}\\boldsymbol{k} W(\\boldsymbol{k})^2 G_{\\mathrm{imp}}(\\boldsymbol{k}) \\delta_{\\mathrm{true}}(\\boldsymbol{k}) \\propto \\frac{\\mathrm{i}\\boldsymbol{k}}{k^2} \\delta_{\\mathrm{true}}(\\boldsymbol{k}).\n$$\nThis requires that $- W(\\boldsymbol{k})^2 G_{\\mathrm{imp}}(\\boldsymbol{k}) = 1/k^2$. Solving for the improved Green's function, we get:\n$$\nG_{\\mathrm{imp}}(\\boldsymbol{k}) = - \\frac{1}{k^2 W(\\boldsymbol{k})^2}.\n$$\nThis expression demonstrates the dual requirement: it \"uses the continuous isotropic kernel $-1/k^2$\" and \"deconvolves\" the window function effect by dividing by $W(\\boldsymbol{k})^2$.\n\nThe problem specifies the 1D CIC window function as $W_{\\mathrm{CIC}}(k_i) = \\left[\\mathrm{sinc}\\left(\\frac{k_i \\Delta x}{2}\\right)\\right]^2$. The 3D window function for a cubic mesh is the product of the 1D windows:\n$$\nW(\\boldsymbol{k}) = W_{\\mathrm{CIC}}(k_x) W_{\\mathrm{CIC}}(k_y) W_{\\mathrm{CIC}}(k_z) = \\prod_{i=1}^{3} \\left[\\mathrm{sinc}\\left(\\frac{k_i \\Delta x}{2}\\right)\\right]^2.\n$$\nThe total windowing effect to be deconvolved is $W(\\boldsymbol{k})^2$:\n$$\nW(\\boldsymbol{k})^2 = \\left( \\prod_{i=1}^{3} \\left[\\mathrm{sinc}\\left(\\frac{k_i \\Delta x}{2}\\right)\\right]^2 \\right)^2 = \\prod_{i=1}^{3} \\left[\\mathrm{sinc}\\left(\\frac{k_i \\Delta x}{2}\\right)\\right]^4.\n$$\nSubstituting this into the expression for $G_{\\mathrm{imp}}(\\boldsymbol{k})$ yields the final result:\n$$\nG_{\\mathrm{imp}}(\\boldsymbol{k}) = - \\frac{1}{k^2 \\prod_{i=1}^{3} \\left[\\mathrm{sinc}\\left(\\frac{k_{i} \\Delta x}{2}\\right)\\right]^4}.\n$$\nHere, $k^2 = k_x^2 + k_y^2 + k_z^2$, and the function $\\mathrm{sinc}(x)$ is defined as $\\sin(x)/x$.\n\nThe final answer is the row matrix containing the expressions for $R(q)$ and $G_{\\mathrm{imp}}(\\boldsymbol{k})$.", "answer": "$$\n\\boxed{\\begin{pmatrix} 3 \\frac{\\sin^2\\left(\\frac{q}{2\\sqrt{3}}\\right)}{\\sin^2\\left(\\frac{q}{2}\\right)}  - \\frac{1}{k^2 \\prod_{i=1}^{3} \\left[\\mathrm{sinc}\\left(\\frac{k_{i} \\Delta x}{2}\\right)\\right]^4} \\end{pmatrix}}\n$$", "id": "3475881"}]}