{"hands_on_practices": [{"introduction": "The one-dimensional harmonic oscillator serves as an essential testbed for numerical integrators. While seemingly simple, its analysis reveals fundamental properties of a scheme, demonstrating that the leapfrog integrator conserves a nearby \"shadow\" Hamiltonian, which results in a bounded phase error rather than a secular energy drift. By deriving the modified frequency of the numerical orbit, you will gain a precise, quantitative understanding of the leapfrog scheme's excellent long-term stability. [@problem_id:3501415]", "problem": "In cosmological $N$-body computations, symplectic splitting integrators such as the Kick–Drift–Kick (KDK) leapfrog are used to advance trajectories under time-independent forces. As a linear testbed relevant to small oscillations near gravitational potential minima, consider a one-dimensional harmonic oscillator with Hamiltonian $H(x,p)=\\frac{1}{2}\\left(p^{2}+\\omega^{2}x^{2}\\right)$, where the mass has been normalized to $m=1$, $x$ is the comoving coordinate, $p$ is the canonical momentum, and $\\omega>0$ is the exact angular frequency. The equation of motion is $\\ddot{x}+\\omega^{2}x=0$ and the continuous-time flow generated by $H$ is a phase-space rotation of angle $\\omega t$.\n\nLet the timestep be $h>0$. The KDK leapfrog consists of a momentum \"kick\" over a half-step driven by the gradient of the potential, a position \"drift\" over a full step driven by the kinetic term, and a final momentum \"kick\" over a half-step. Starting from the fundamental laws defining $H$, the canonical equations, and the KDK composition, derive the single-step linear update mapping $(x_{n},p_{n})\\mapsto(x_{n+1},p_{n+1})$ and analyze its eigenvalues to infer the angle of the corresponding phase-space rotation. The discrete map exactly preserves a modified (shadow) Hamiltonian that is quadratic and generates a harmonic rotation at a modified angular frequency $\\tilde{\\omega}$ that depends on $h$ and $\\omega$.\n\nCompute the closed-form analytic expression for the modified angular frequency $\\tilde{\\omega}$ implied by the KDK leapfrog’s modified Hamiltonian, expressed purely in terms of $h$ and $\\omega$. Briefly compare $\\tilde{\\omega}$ to the exact $\\omega$ in the small-$h$ limit in your derivation, but for the final answer provide only the analytic expression for $\\tilde{\\omega}$. No numerical rounding is required, and you should not include any units in the final answer.", "solution": "The problem statement is rigorously validated and found to be valid. It is scientifically grounded in Hamiltonian mechanics and numerical integration theory, well-posed, objective, and internally consistent. We may therefore proceed with the derivation.\n\nThe system is a one-dimensional harmonic oscillator with mass $m=1$, described by the Hamiltonian $H(x,p) = T(p) + V(x)$, where the kinetic energy is $T(p) = \\frac{1}{2}p^2$ and the potential energy is $V(x) = \\frac{1}{2}\\omega^2 x^2$. Hamilton's canonical equations of motion are:\n$$\n\\dot{x} = \\frac{\\partial H}{\\partial p} = p\n$$\n$$\n\\dot{p} = -\\frac{\\partial H}{\\partial x} = -\\omega^2 x\n$$\n\nThe Kick-Drift-Kick (KDK) leapfrog integrator is a second-order symplectic splitting method that approximates the exact time evolution operator $\\exp(h\\mathcal{L}_H)$ by a composition of operators for the kinetic and potential parts, where $\\mathcal{L}_H = \\{ \\cdot, H \\}$ is the Poisson bracket operator. The KDK scheme for a timestep $h$ is given by the composition:\n$$\n\\Phi_h = \\Phi_V^{h/2} \\circ \\Phi_T^{h} \\circ \\Phi_V^{h/2}\n$$\nHere, $\\Phi_V^{\\Delta t}$ represents evolving the system under only the potential part $V(x)$ for a time $\\Delta t$, and $\\Phi_T^{\\Delta t}$ represents evolving it under only the kinetic part $T(p)$ for a time $\\Delta t$.\n\nLet us derive the map for each component.\n1.  **Kick step ($\\Phi_V^{\\Delta t}$)**: Evolution under $V(x)$ follows the equations $\\dot{x}=0$ and $\\dot{p}=-\\frac{\\partial V}{\\partial x} = -\\omega^2 x$. Since $x$ is constant during this step, the update from $(x, p)$ to $(x', p')$ over a time interval $\\Delta t$ is:\n    $$\n    x' = x\n    $$\n    $$\n    p' = p - (\\omega^2 x) \\Delta t\n    $$\n\n2.  **Drift step ($\\Phi_T^{\\Delta t}$)**: Evolution under $T(p)$ follows the equations $\\dot{x}=\\frac{\\partial T}{\\partial p} = p$ and $\\dot{p}=0$. Since $p$ is constant during this step, the update from $(x, p)$ to $(x', p')$ over a time interval $\\Delta t$ is:\n    $$\n    x' = x + p \\Delta t\n    $$\n    $$\n    p' = p\n    $$\n\nNow, we compose these steps to build the full KDK integrator map from $(x_n, p_n)$ to $(x_{n+1}, p_{n+1})$ over a timestep $h$.\n\n**First Kick (half-step, $\\Delta t = h/2$)**:\nLet the intermediate state be $(x_\\text{mid1}, p_\\text{mid1})$.\n$$\nx_\\text{mid1} = x_n\n$$\n$$\np_\\text{mid1} = p_n - \\frac{h}{2}\\omega^2 x_n\n$$\n\n**Drift (full step, $\\Delta t = h$)**:\nLet the next intermediate state be $(x_\\text{mid2}, p_\\text{mid2})$. We apply the drift to $(x_\\text{mid1}, p_\\text{mid1})$.\n$$\nx_\\text{mid2} = x_\\text{mid1} + h \\cdot p_\\text{mid1} = x_n + h\\left(p_n - \\frac{h}{2}\\omega^2 x_n\\right) = \\left(1 - \\frac{h^2\\omega^2}{2}\\right)x_n + h p_n\n$$\n$$\np_\\text{mid2} = p_\\text{mid1} = p_n - \\frac{h}{2}\\omega^2 x_n\n$$\n\n**Second Kick (half-step, $\\Delta t = h/2$)**:\nThe final state $(x_{n+1}, p_{n+1})$ is found by applying the kick to $(x_\\text{mid2}, p_\\text{mid2})$.\n$$\nx_{n+1} = x_\\text{mid2} = \\left(1 - \\frac{h^2\\omega^2}{2}\\right)x_n + h p_n\n$$\n$$\np_{n+1} = p_\\text{mid2} - \\frac{h}{2}\\omega^2 x_\\text{mid2} = \\left(p_n - \\frac{h}{2}\\omega^2 x_n\\right) - \\frac{h}{2}\\omega^2 \\left[ \\left(1 - \\frac{h^2\\omega^2}{2}\\right)x_n + h p_n \\right]\n$$\nExpanding the expression for $p_{n+1}$:\n$$\np_{n+1} = p_n - \\frac{h\\omega^2}{2}x_n - \\frac{h\\omega^2}{2}\\left(1 - \\frac{h^2\\omega^2}{2}\\right)x_n - \\frac{h^2\\omega^2}{2}p_n\n$$\n$$\np_{n+1} = \\left(1 - \\frac{h^2\\omega^2}{2}\\right)p_n - \\left[\\frac{h\\omega^2}{2} + \\frac{h\\omega^2}{2} - \\frac{h^3\\omega^4}{4}\\right]x_n\n$$\n$$\np_{n+1} = \\left(1 - \\frac{h^2\\omega^2}{2}\\right)p_n - \\left(h\\omega^2 - \\frac{h^3\\omega^4}{4}\\right)x_n\n$$\n$$\np_{n+1} = -\\omega^2 h\\left(1 - \\frac{h^2\\omega^2}{4}\\right)x_n + \\left(1 - \\frac{h^2\\omega^2}{2}\\right)p_n\n$$\n\nThe single-step linear update can be written in matrix form as $\\begin{pmatrix} x_{n+1} \\\\ p_{n+1} \\end{pmatrix} = M \\begin{pmatrix} x_n \\\\ p_n \\end{pmatrix}$, where the transfer matrix $M$ is:\n$$\nM = \\begin{pmatrix}\n1 - \\frac{h^2\\omega^2}{2} & h \\\\\n-\\omega^2 h\\left(1 - \\frac{h^2\\omega^2}{4}\\right) & 1 - \\frac{h^2\\omega^2}{2}\n\\end{pmatrix}\n$$\nThis discrete map corresponds to a rotation in phase space by some angle $\\theta = \\tilde{\\omega}h$, where $\\tilde{\\omega}$ is the modified angular frequency we seek. The eigenvalues of a $2 \\times 2$ rotation matrix are $e^{\\pm i\\theta}$. The trace of such a matrix is $e^{i\\theta} + e^{-i\\theta} = 2\\cos(\\theta)$. Thus, we can find the angle by calculating the trace of the transfer matrix $M$.\n$$\n\\text{Tr}(M) = \\left(1 - \\frac{h^2\\omega^2}{2}\\right) + \\left(1 - \\frac{h^2\\omega^2}{2}\\right) = 2 - h^2\\omega^2\n$$\nEquating this to the trace of a rotation matrix yields:\n$$\n2\\cos(\\tilde{\\omega}h) = 2 - h^2\\omega^2\n$$\n$$\n\\cos(\\tilde{\\omega}h) = 1 - \\frac{h^2\\omega^2}{2}\n$$\nThe problem is now to solve for $\\tilde{\\omega}$.\n$$\n\\tilde{\\omega}h = \\arccos\\left(1 - \\frac{h^2\\omega^2}{2}\\right)\n$$\nThis expression can be simplified using the trigonometric identity $\\cos(2\\alpha) = 1 - 2\\sin^2(\\alpha)$. Let $\\tilde{\\omega}h = 2\\alpha$. Then $\\cos(2\\alpha) = 1 - \\frac{h^2\\omega^2}{2}$. Comparing this with the identity gives:\n$$\n2\\sin^2(\\alpha) = \\frac{h^2\\omega^2}{2} \\implies \\sin^2(\\alpha) = \\frac{h^2\\omega^2}{4}\n$$\nFor a stable integration ($h\\omega < 2$), we can take the principal root:\n$$\n\\sin(\\alpha) = \\frac{h\\omega}{2} \\implies \\alpha = \\arcsin\\left(\\frac{h\\omega}{2}\\right)\n$$\nSubstituting back $\\alpha = \\frac{\\tilde{\\omega}h}{2}$:\n$$\n\\frac{\\tilde{\\omega}h}{2} = \\arcsin\\left(\\frac{h\\omega}{2}\\right)\n$$\nSolving for $\\tilde{\\omega}$:\n$$\n\\tilde{\\omega} = \\frac{2}{h}\\arcsin\\left(\\frac{h\\omega}{2}\\right)\n$$\nThis is the closed-form analytic expression for the modified angular frequency.\n\nTo compare $\\tilde{\\omega}$ with $\\omega$ in the small-$h$ limit, we use the Taylor series expansion for $\\arcsin(z) = z + \\frac{z^3}{6} + O(z^5)$ with $z = \\frac{h\\omega}{2}$:\n$$\n\\tilde{\\omega} = \\frac{2}{h}\\left[ \\left(\\frac{h\\omega}{2}\\right) + \\frac{1}{6}\\left(\\frac{h\\omega}{2}\\right)^3 + O(h^5) \\right]\n$$\n$$\n\\tilde{\\omega} = \\frac{2}{h}\\left[ \\frac{h\\omega}{2} + \\frac{h^3\\omega^3}{48} + O(h^5) \\right]\n$$\n$$\n\\tilde{\\omega} = \\omega + \\frac{h^2\\omega^3}{24} + O(h^4) = \\omega\\left(1 + \\frac{h^2\\omega^2}{24} + O(h^4)\\right)\n$$\nAs $h \\to 0$, the modified frequency $\\tilde{\\omega}$ converges to the true frequency $\\omega$. The leading-order error term $\\frac{h^2\\omega^3}{24}$ is positive, indicating that the numerical oscillator has a slightly higher frequency (period shortening), which is a known characteristic of the leapfrog integrator. The error scales as $h^2$, consistent with the method being second-order accurate.", "answer": "$$\\boxed{\\frac{2}{h}\\arcsin\\left(\\frac{h\\omega}{2}\\right)}$$", "id": "3501415"}, {"introduction": "Moving from theory to practice, we encounter the challenge of initialization. The leapfrog scheme's defining feature is its use of a staggered time grid, where positions and momenta are not known at the same time. This exercise tackles the common problem of starting an integration from initial conditions $(\\boldsymbol{x}_0, \\boldsymbol{v}_0)$ provided at a single instant, demonstrating how to construct a consistent \"initial kick\" that generates the half-step momentum needed to begin the integration loop without degrading the method's second-order accuracy. [@problem_id:3501379]", "problem": "Consider a collisionless nonrelativistic particle evolving in a spatially flat Friedmann–Lemaître–Robertson–Walker (FLRW) universe with scale factor $a(t)$. Work in comoving coordinates $\\boldsymbol{x}(t)$ and assume the gravitational potential $\\phi(\\boldsymbol{x}, t)$ is the peculiar potential that solves the comoving Poisson equation and varies smoothly in time. Use the per-unit-mass Lagrangian $L = a(t)^{2} |\\dot{\\boldsymbol{x}}|^{2} / 2 - \\phi(\\boldsymbol{x}, t)$ so that the canonical momentum is $\\boldsymbol{p} = a(t)^{2} \\dot{\\boldsymbol{x}}$. The associated Hamiltonian is $H(\\boldsymbol{x}, \\boldsymbol{p}, t) = |\\boldsymbol{p}|^{2} / \\left(2 a(t)^{2}\\right) + \\phi(\\boldsymbol{x}, t)$, and Hamilton’s equations give $\\dot{\\boldsymbol{x}} = \\boldsymbol{p}/a(t)^{2}$ and $\\dot{\\boldsymbol{p}} = - \\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}, t)$.\n\nYou plan to integrate the equations of motion using a time-symmetric leapfrog integrator in the kick–drift–kick form with a uniform cosmic time step $\\Delta t$. At the initial time $t_{0}$ you are given the comoving position $\\boldsymbol{x}(t_{0})$ and comoving velocity $\\boldsymbol{v}(t_{0}) = \\dot{\\boldsymbol{x}}(t_{0})$, but the leapfrog scheme requires a momentum at a half time step, $\\boldsymbol{p}^{1/2}$ located at $t_{0} + \\Delta t/2$, to start. Construct an initial half-kick that produces $\\boldsymbol{p}^{1/2}$ from the given data without degrading the second-order accuracy of the leapfrog scheme. Your construction must start from the fundamental definitions and equations given above and must justify why the resulting initialization is second-order accurate.\n\nExpress your final answer as a single closed-form analytic expression for $\\boldsymbol{p}^{1/2}$ in terms of $a(t_{0})$, $\\boldsymbol{v}(t_{0})$, $\\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}(t_{0}), t_{0})$, and $\\Delta t$.", "solution": "The problem requires the construction of an initial condition for the canonical momentum, $\\boldsymbol{p}^{1/2}$, evaluated at a half time step $t_{1/2} = t_{0} + \\Delta t/2$, given the comoving position $\\boldsymbol{x}_{0} = \\boldsymbol{x}(t_0)$ and comoving velocity $\\boldsymbol{v}_{0} = \\dot{\\boldsymbol{x}}(t_0)$ at the initial time $t_{0}$. This initialization is for a time-symmetric leapfrog integrator and must not degrade its inherent second-order accuracy.\n\nFirst, we establish the relationship between the given initial velocity $\\boldsymbol{v}(t_0)$ and the initial canonical momentum $\\boldsymbol{p}(t_0)$. The problem defines the canonical momentum as $\\boldsymbol{p} = a(t)^{2} \\dot{\\boldsymbol{x}}$, where $\\dot{\\boldsymbol{x}} = \\boldsymbol{v}$ is the comoving velocity. Therefore, at the initial time $t_0$, the canonical momentum is:\n$$\n\\boldsymbol{p}(t_0) = a(t_0)^{2} \\boldsymbol{v}(t_0)\n$$\nThe leapfrog integrator in its standard, memory-efficient form, requires phase space variables to be known on a staggered time grid: positions $\\boldsymbol{x}_{n}$ at integer time steps $t_n = t_0 + n \\Delta t$, and momenta $\\boldsymbol{p}_{n+1/2}$ at half-integer time steps $t_{n+1/2} = t_0 + (n+1/2) \\Delta t$. The initial conditions $(\\boldsymbol{x}(t_0), \\boldsymbol{v}(t_0))$ are synchronized at the same time $t_0$. To start the leapfrog integration loop, we must generate a momentum at a half-step, $\\boldsymbol{p}^{1/2} = \\boldsymbol{p}(t_0 + \\Delta t/2)$, from the state at $t_0$.\n\nThe evolution of the canonical momentum is governed by Hamilton's equation, as provided in the problem statement:\n$$\n\\dot{\\boldsymbol{p}} = \\frac{d\\boldsymbol{p}}{dt} = - \\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}, t)\n$$\nTo find the momentum at time $t_0 + \\Delta t/2$, we can formally integrate this equation of motion from $t_0$ to $t_0 + \\Delta t/2$:\n$$\n\\boldsymbol{p}(t_0 + \\Delta t/2) = \\boldsymbol{p}(t_0) + \\int_{t_0}^{t_0 + \\Delta t/2} \\dot{\\boldsymbol{p}}(t) dt = \\boldsymbol{p}(t_0) - \\int_{t_0}^{t_0 + \\Delta t/2} \\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}(t), t) dt\n$$\nThis relation is exact. However, the integral cannot be evaluated exactly because the trajectory $\\boldsymbol{x}(t)$ for $t \\in (t_0, t_0 + \\Delta t/2]$ is not known a priori. We must therefore approximate the integral. This step is what the problem refers to as the \"initial half-kick\".\n\nThe leapfrog method achieves second-order accuracy, meaning its global error over a fixed integration interval scales as $\\mathcal{O}((\\Delta t)^2)$. To ensure that the initialization does not degrade this accuracy, the error introduced in this first step must be of an order that is consistent with the overall scheme. Specifically, the error introduced in $\\boldsymbol{p}^{1/2}$ must not be of order $\\mathcal{O}(\\Delta t)$, as this would dominate the global error and reduce the method to first order. The initialization error must be $\\mathcal{O}((\\Delta t)^2)$ or higher.\n\nLet us analyze the error of a simple approximation for the integral. We can approximate the integrand $\\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}(t), t)$ by its value at the beginning of the integration interval, $t_0$. This corresponds to a first-order Euler step (or the left-endpoint rectangle rule for numerical integration) over the interval of length $\\Delta t / 2$:\n$$\n\\int_{t_0}^{t_0 + \\Delta t/2} \\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}(t), t) dt \\approx \\left(\\frac{\\Delta t}{2}\\right) \\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}(t_0), t_0)\n$$\nThe local truncation error of this approximation for the integral is of order $\\mathcal{O}((\\Delta t)^2)$. Substituting this approximation into the exact relation yields our expression for $\\boldsymbol{p}^{1/2}$:\n$$\n\\boldsymbol{p}^{1/2} \\approx \\boldsymbol{p}(t_0) - \\frac{\\Delta t}{2} \\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}(t_0), t_0)\n$$\nThe error in this computed $\\boldsymbol{p}^{1/2}$ relative to the true value $\\boldsymbol{p}(t_0 + \\Delta t/2)$ is of order $\\mathcal{O}((\\Delta t)^2)$. This initial error in a canonical variable leads to an initial error in the Hamiltonian (or any shadow Hamiltonian) of order $\\mathcal{O}((\\Delta t)^2)$. This is consistent with the global error of a second-order integrator, which accumulates to $\\mathcal{O}((\\Delta t)^2)$ over a fixed time. Thus, an initialization step with a local error of $\\mathcal{O}((\\Delta t)^2)$ does not degrade the overall second-order accuracy of the leapfrog scheme. This procedure is standard for starting staggered-time-step integrators.\n\nFinally, we express the result in terms of the quantities specified in the problem statement: $a(t_{0})$, $\\boldsymbol{v}(t_{0})$, $\\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}(t_{0}), t_{0})$, and $\\Delta t$. Substituting $\\boldsymbol{p}(t_0) = a(t_0)^{2} \\boldsymbol{v}(t_0)$ into our expression for $\\boldsymbol{p}^{1/2}$ gives the final answer.\n$$\n\\boldsymbol{p}^{1/2} = a(t_0)^{2} \\boldsymbol{v}(t_0) - \\frac{\\Delta t}{2} \\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}(t_0), t_0)\n$$\nThis is the desired closed-form analytic expression for the initial half-step momentum.", "answer": "$$\n\\boxed{a(t_{0})^{2} \\boldsymbol{v}(t_{0}) - \\frac{\\Delta t}{2} \\nabla_{\\boldsymbol{x}} \\phi(\\boldsymbol{x}(t_{0}), t_{0})}\n$$", "id": "3501379"}, {"introduction": "The second-order accuracy of the Kick-Drift-Kick (KDK) leapfrog integrator is not automatic; it relies critically on the time-symmetric evaluation of the force, or \"kick.\" This coding exercise presents a compelling counterexample within a cosmological context, where a naive, asymmetric force evaluation leads to systematic, unphysical biases in the calculated growth of structure. By implementing and comparing a properly centered scheme with a naive one, you will see firsthand why careful, symmetric implementation is paramount for achieving accurate physical results. [@problem_id:3501452]", "problem": "Consider an Einstein–de Sitter Universe (matter-only, zero cosmological constant) in comoving coordinates, and use the scale factor $a$ as the independent variable. The Hubble parameter scales as $H(a) = H_0 a^{-3/2}$ with $H_0$ a constant. Consider the linear regime of a single plane-wave density perturbation with density contrast $\\delta(\\boldsymbol{x},a) = \\delta_0 D(a) \\cos(k x)$, where $D(a)$ is the linear growth factor and $k$ is the wavenumber. In such a Universe, the linear theory growth factor is $D(a) = a$, and the comoving gravitational potential $\\Phi$ satisfies the Poisson equation $\\nabla^2 \\Phi = 4 \\pi G a^2 \\bar{\\rho}(a) \\delta(\\boldsymbol{x},a)$. At a fixed spatial phase where the gradient magnitude is maximal, the comoving gravitational acceleration magnitude scales as $|\\nabla \\Phi|(a) \\propto a^2 D(a) = a^3$. \n\nIn standard cosmological $N$-body formulations, one can adopt canonical momentum $p$ and comoving position $x$ governed by the first-order system in the scale factor $a$:\n$$\\frac{dx}{da} = \\frac{p}{a^3 H(a)}, \\qquad \\frac{dp}{da} = -\\frac{|\\nabla \\Phi|(a)}{a H(a)}.$$\nWith the Einstein–de Sitter scaling $H(a) = H_0 a^{-3/2}$ and $|\\nabla \\Phi|(a) \\propto a^3$, the magnitude of the kick weight function is\n$$W(a) \\equiv \\frac{|\\nabla \\Phi|(a)}{a H(a)} \\propto \\frac{a^3}{a \\cdot a^{-3/2}} = a^{7/2}.$$\nWe normalize all constants ($H_0$, amplitudes, and proportionality factors) to unity so that $W(a) = a^{7/2}$ and $H(a) = a^{-3/2}$ for the purposes of this problem. This normalization renders all quantities dimensionless; your program should report dimensionless floats.\n\nWe study the leapfrog scheme in its kick–drift–kick (KDK) form over a finite interval $[a_0,a_f]$, partitioned into $N$ uniform steps of size $\\Delta a = (a_f - a_0)/N$. Denote the step endpoints by $a_n = a_0 + n \\Delta a$ and midpoints $a_{n+1/2} = (a_n + a_{n+1})/2$. For each step, the canonical momentum is updated by two kicks, and the position by one drift:\n- Kick–1: advance $p$ by $\\frac{\\Delta a}{2} W(a_{\\mathrm{eval},1})$,\n- Drift: advance $x$ by $\\mathcal{F}_{\\mathrm{drift}}(a_n,a_{n+1}) \\, p_{\\text{half}}$, where\n$$\\mathcal{F}_{\\mathrm{drift}}(a_n,a_{n+1}) = \\int_{a_n}^{a_{n+1}} \\frac{da}{a^3 H(a)} = \\int_{a_n}^{a_{n+1}} a^{-3/2} \\, da = 2\\left(a_n^{-1/2} - a_{n+1}^{-1/2}\\right),$$\n- Kick–2: advance $p$ by $\\frac{\\Delta a}{2} W(a_{\\mathrm{eval},2})$.\n\nWe compare two KDK variants:\n1. Naive force-at-start: both kicks evaluate the force at the start of the step, i.e., $a_{\\mathrm{eval},1} = a_n$ and $a_{\\mathrm{eval},2} = a_n$.\n2. Time-centered (symmetric): the kicks evaluate the force at the start and end of the step, i.e., $a_{\\mathrm{eval},1} = a_n$ and $a_{\\mathrm{eval},2} = a_{n+1}$.\n\nWe construct a counterexample initial condition in which the naive force-at-start KDK underestimates the linear growth by a predictable factor. Initialize a single particle at a spatial location where the potential gradient magnitude is maximal, with\n$$x(a_0) = 0, \\quad p\\left(a_0 - \\frac{\\Delta a}{2}\\right) = 0.$$\nUnder these conditions, the entire growth in $x$ over $[a_0,a_f]$ arises from the accumulated kicks and subsequent drifts. Because $W(a) = a^{7/2}$ increases monotonically with $a$, the naive force-at-start KDK underestimates the average kick per step compared to the time-centered scheme. The per-step momentum increment ratio is\n$$R_n = \\frac{\\Delta a \\, W(a_n)}{\\frac{\\Delta a}{2}\\left[W(a_n) + W(a_{n+1})\\right]} = \\frac{2}{1 + \\left(\\frac{a_{n+1}}{a_n}\\right)^{7/2}},$$\nand the total underestimation factor in the accumulated momentum is $\\prod_{n=0}^{N-1} R_n$. Because the drift uses the same exact drift integral in both schemes and $x$ is linear in the half-step momentum, the final position $x(a_f)$ inherits essentially the same multiplicative bias, making the ratio\n$$\\mathcal{B}(a_0,a_f,N) \\equiv \\frac{x_{\\text{naive}}(a_f)}{x_{\\text{centered}}(a_f)} \\approx \\prod_{n=0}^{N-1} \\frac{2}{1 + \\left(\\frac{a_{n+1}}{a_n}\\right)^{7/2}}.$$\nYour task:\n- Implement both KDK variants described above for the normalized model with $W(a) = a^{7/2}$ and $H(a) = a^{-3/2}$, using the exact drift integral $\\mathcal{F}_{\\mathrm{drift}}(a_n,a_{n+1})$ and the two-kick rule per step with $\\frac{\\Delta a}{2}$ factors.\n- Use the specified initial condition $x(a_0) = 0$ and $p\\left(a_0 - \\frac{\\Delta a}{2}\\right) = 0$.\n- For each test case, compute and return the dimensionless float $\\mathcal{B}(a_0,a_f,N) = x_{\\text{naive}}(a_f) / x_{\\text{centered}}(a_f)$.\n\nTest suite:\n- Case 1 (happy path): $a_0 = 0.1$, $a_f = 1.0$, $N = 10$.\n- Case 2 (single large step boundary): $a_0 = 0.1$, $a_f = 1.0$, $N = 1$.\n- Case 3 (many small steps edge): $a_0 = 0.1$, $a_f = 1.0$, $N = 1000$.\n- Case 4 (short final interval): $a_0 = 0.9$, $a_f = 1.0$, $N = 10$.\n- Case 5 (small interval): $a_0 = 0.1$, $a_f = 0.2$, $N = 10$.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of the test cases: $[\\mathcal{B}_1,\\mathcal{B}_2,\\mathcal{B}_3,\\mathcal{B}_4,\\mathcal{B}_5]$. Each entry must be a dimensionless float.", "solution": "The problem is valid. It presents a well-defined numerical task based on a simplified but standard model in physical cosmology. The governing equations, numerical schemes, and initial conditions are specified completely and consistently, allowing for a unique solution. The subtle ambiguity regarding the sign in the differential equation for momentum, $\\frac{dp}{da} = -\\frac{|\\nabla \\Phi|(a)}{a H(a)}$, is resolved by the explicit and unambiguous algorithmic rule to \"advance $p$ by\" a positive quantity, which defines the dynamics for this problem as $\\frac{dp}{da} = W(a)$.\n\nThe problem requires the implementation and comparison of two variants of the kick-drift-kick (KDK) leapfrog integration scheme for a particle in an expanding universe. The particle's dynamics are described by a system of first-order ordinary differential equations in the scale factor $a$:\n$$\n\\frac{dx}{da} = \\frac{p}{a^3 H(a)}\n$$\n$$\n\\frac{dp}{da} = W(a)\n$$\nWith the specified normalizations for the Hubble parameter $H(a)$ and kick weight function $W(a)$, these become:\n$$\n\\frac{dx}{da} = \\frac{p}{a^3 a^{-3/2}} = \\frac{p}{a^{3/2}}\n$$\n$$\n\\frac{dp}{da} = a^{7/2}\n$$\nThe KDK leapfrog algorithm is a second-order accurate, symplectic integrator suitable for Hamiltonian systems. It operates on a staggered time grid, where positions $x$ are known at integer steps $a_n$ and canonical momenta $p$ are known at half-integer steps $a_{n \\pm 1/2}$. The interval $[a_0, a_f]$ is divided into $N$ steps of size $\\Delta a = (a_f - a_0) / N$. A single integration step from $a_n$ to $a_{n+1}$ updates the state $(x_n, p_{n-1/2})$ to $(x_{n+1}, p_{n+1/2})$ as follows:\n\n$1$. **First Kick (half-step):** The momentum is advanced from time $a_{n-1/2} = a_n - \\Delta a / 2$ to the integer step time $a_n$. This corresponds to integrating $\\frac{dp}{da}$ over half a step. The update rule is:\n$$p_n = p_{n-1/2} + \\frac{\\Delta a}{2} W(a_{\\text{eval},1})$$\nwhere $p_n$ is the momentum at time $a_n$.\n\n$2$. **Drift (full-step):** The position is advanced from $a_n$ to $a_{n+1}$. This involves integrating $\\frac{dx}{da}$ over the full step, using the momentum $p_n$ at the interval's midpoint in time. The problem provides the exact integral for the time-dependent portion of the drift equation:\n$$\n\\mathcal{F}_{\\text{drift}}(a_n, a_{n+1}) = \\int_{a_n}^{a_{n+1}} \\frac{da}{a^3 H(a)} = \\int_{a_n}^{a_{n+1}} a^{-3/2} \\, da = 2\\left(a_n^{-1/2} - a_{n+1}^{-1/2}\\right)\n$$\nThe position update is then:\n$$x_{n+1} = x_n + p_n \\mathcal{F}_{\\text{drift}}(a_n, a_{n+1})$$\n\n$3$. **Second Kick (half-step):** The momentum is advanced from $a_n$ to the next half-step $a_{n+1/2}$. This completes the momentum update for the full step from $a_{n-1/2}$ to $a_{n+1/2}$:\n$$p_{n+1/2} = p_n + \\frac{\\Delta a}{2} W(a_{\\text{eval},2})$$\n\nThe two variants of the KDK scheme are distinguished by their choice of evaluation points for the kick function $W(a)$:\n- **Naive force-at-start:** This scheme evaluates the kick weight function $W(a)$ at the beginning of the step for both kicks: $a_{\\text{eval},1} = a_n$ and $a_{\\text{eval},2} = a_n$. This makes the total momentum update over the step $\\Delta p_n = p_{n+1/2} - p_{n-1/2} = \\Delta a \\cdot W(a_n)$.\n- **Time-centered (symmetric):** This scheme evaluates the kick weight function at the start and end of the step interval, respectively: $a_{\\text{eval},1} = a_n$ and $a_{\\text{eval},2} = a_{n+1}$. The total momentum update is $\\Delta p_n = \\frac{\\Delta a}{2} [W(a_n) + W(a_{n+1})]$. This is a trapezoidal rule integration for the kick and maintains second-order accuracy.\n\nThe initial conditions are given as $x(a_0) = 0$ and $p(a_0 - \\Delta a / 2) = 0$. In our discrete formalism, these correspond to $x_0 = 0$ and $p_{-1/2} = 0$.\n\nThe algorithm to compute the ratio $\\mathcal{B}(a_0, a_f, N) = x_{\\text{naive}}(a_f) / x_{\\text{centered}}(a_f)$ is as follows:\nFor each test case $(a_0, a_f, N)$:\n1. Implement a function that performs the KDK integration. This function takes $a_0, a_f, N$ and the scheme type ('naive' or 'centered') as input.\n2. Inside the function, initialize $x = 0$ and the half-step momentum $p_{\\text{half}} = 0$.\n3. Loop $n$ from $0$ to $N-1$:\n    a. Calculate the current and next scale factors, $a_n = a_0 + n \\Delta a$ and $a_{n+1} = a_n + \\Delta a$.\n    b. Based on the scheme, set the evaluation points $a_{\\text{eval},1}$ and $a_{\\text{eval},2}$.\n    c. Perform the first kick to get $p_n$.\n    d. Perform the full-step drift to update $x$ to $x_{n+1}$.\n    e. Perform the second kick to update $p_{\\text{half}}$ to $p_{n+1/2}$.\n4. After the loop, the final value of $x$ is the result for that scheme, $x(a_f)$.\n5. Call this function once for the 'naive' scheme to get $x_{\\text{naive}}(a_f)$ and once for the 'centered' scheme to get $x_{\\text{centered}}(a_f)$.\n6. Compute and store the ratio $\\mathcal{B} = x_{\\text{naive}}(a_f) / x_{\\text{centered}}(a_f)$.\n7. Collect the ratios for all test cases and format the output as specified.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem by implementing two variants of the KDK leapfrog scheme\n    and computing the ratio of their final positions for a set of test cases.\n    \"\"\"\n\n    def W(a):\n        \"\"\"\n        The normalized kick weight function W(a) = a^(7/2).\n        \"\"\"\n        return a**3.5\n\n    def F_drift(a_n, a_np1):\n        \"\"\"\n        The exact drift factor integral from a_n to a_{n+1}.\n        \"\"\"\n        return 2.0 * (a_n**-0.5 - a_np1**-0.5)\n\n    def kdk_integrator(a0, af, N, scheme):\n        \"\"\"\n        Performs the KDK integration for a given scheme.\n\n        Args:\n            a0 (float): The initial scale factor.\n            af (float): The final scale factor.\n            N (int): The number of integration steps.\n            scheme (str): The integration scheme, either 'naive' or 'centered'.\n\n        Returns:\n            float: The final position x(af).\n        \"\"\"\n        delta_a = (af - a0) / N\n\n        # Initial conditions: x(a0) = 0, p(a0 - delta_a/2) = 0\n        x = 0.0\n        p_half_step = 0.0\n\n        for n in range(N):\n            a_n = a0 + n * delta_a\n            a_np1 = a_n + delta_a\n\n            # Determine evaluation points for the kick function W(a)\n            if scheme == 'naive':\n                a_eval1 = a_n\n                a_eval2 = a_n\n            elif scheme == 'centered':\n                a_eval1 = a_n\n                a_eval2 = a_np1\n            else:\n                raise ValueError(\"Unknown scheme specified.\")\n\n            # 1. First Kick (advances p from a_{n-1/2} to a_n)\n            p_full_step = p_half_step + (delta_a / 2.0) * W(a_eval1)\n\n            # 2. Drift (advances x from a_n to a_{n+1} using p at a_n)\n            x = x + F_drift(a_n, a_np1) * p_full_step\n\n            # 3. Second Kick (advances p from a_n to a_{n+1/2})\n            p_half_step = p_full_step + (delta_a / 2.0) * W(a_eval2)\n\n        return x\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (a0, af, N)\n        (0.1, 1.0, 10),     # Case 1\n        (0.1, 1.0, 1),      # Case 2\n        (0.1, 1.0, 1000),   # Case 3\n        (0.9, 1.0, 10),     # Case 4\n        (0.1, 0.2, 10),     # Case 5\n    ]\n\n    results = []\n    for a0, af, N in test_cases:\n        x_naive = kdk_integrator(a0, af, N, 'naive')\n        x_centered = kdk_integrator(a0, af, N, 'centered')\n\n        # The problem setup ensures x_centered is non-zero.\n        ratio = x_naive / x_centered\n        results.append(ratio)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3501452"}]}