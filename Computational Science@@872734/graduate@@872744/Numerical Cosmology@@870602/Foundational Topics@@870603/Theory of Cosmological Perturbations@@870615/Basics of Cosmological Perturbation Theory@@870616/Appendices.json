{"hands_on_practices": [{"introduction": "Understanding the growth of cosmic structure begins with the simplest non-trivial case: a universe filled with a single component of pressureless matter. This exercise takes you back to first principles, guiding you to derive the fundamental second-order differential equation governing the evolution of the matter density contrast, $\\delta$, in an Einstein-de Sitter background. By solving this equation and constructing the associated Green's function, you will implement an exact analytical propagator that evolves perturbations forward in time, providing deep insight into the nature of the iconic growing and decaying modes of structure formation [@problem_id:3466045].", "problem": "You are asked to derive and implement a numerical method based on Green’s functions to evolve linear density perturbations in a spatially flat, pressureless matter-only Universe, assuming the Einstein–de Sitter (EdS) background. Work entirely in conformal time and Fourier space, and consider sub-horizon linear perturbations, where the density contrast mode $\\,\\delta(k,\\eta)\\,$ of comoving wavenumber $\\,k\\,$ obeys a second-order linear ordinary differential equation in conformal time $\\,\\eta\\,$. Your derivation must start from first principles of non-relativistic fluid dynamics under Newtonian gravity, applied to an expanding Friedmann–Lemaître–Robertson–Walker background in conformal time, using the linearized continuity equation, Euler equation, and Poisson equation. Use these laws to obtain a closed, homogeneous second-order ordinary differential equation for $\\,\\delta(k,\\eta)\\,$. Then, construct the retarded Green’s function appropriate to this equation, and use it to describe the propagation of arbitrary initial conditions $\\,\\delta(k,\\eta_i)\\,$ and $\\,\\delta'(k,\\eta_i)\\,$ specified at a finite initial conformal time $\\,\\eta_i\\,$, where the prime denotes derivative with respect to $\\,\\eta\\,$. Show how the solution at a later time $\\,\\eta_f > \\eta_i\\,$ can be expressed using a Green’s function based convolution in time.\n\nImplementation requirements:\n- Represent the evolution using a Green’s function-based reconstruction that respects causality and is valid for arbitrary initial conditions. Your implementation must map $\\,(\\delta(k,\\eta_i),\\delta'(k,\\eta_i))\\,$ to $\\,\\delta(k,\\eta_f)\\,$ for each test case by evaluating the appropriate kernels implied by the retarded Green’s function solution in a matter-only Einstein–de Sitter Universe.\n- You must treat $\\,\\delta'(k,\\eta)\\,$ and the velocity divergence $\\,\\theta(k,\\eta)\\,$ consistently; in linear theory and conformal time, they satisfy $\\,\\delta'(k,\\eta) + \\theta(k,\\eta) = 0\\,$, so $\\,\\delta'(k,\\eta_i) = -\\theta(k,\\eta_i)\\,$. In each test case, you will be given $\\,\\theta(k,\\eta_i)\\,$ and must use this relation to form the correct derivative initial condition.\n- The program must accept no input and must compute results for the following test suite. Each test case is a tuple $\\,\\big(k,\\eta_i,\\eta_f,\\delta(k,\\eta_i),\\theta(k,\\eta_i)\\big)\\,$:\n    1. $\\,k=0.1\\,$, $\\,\\eta_i=1.0\\,$, $\\,\\eta_f=5.0\\,$, $\\,\\delta(k,\\eta_i)=0.8\\,$, $\\,\\theta(k,\\eta_i)=-0.2\\,$.\n    2. Boundary check: $\\,k=1.0\\,$, $\\,\\eta_i=2.0\\,$, $\\,\\eta_f=2.0\\,$, $\\,\\delta(k,\\eta_i)=1.234\\,$, $\\,\\theta(k,\\eta_i)=0.0\\,$, which must yield $\\,\\delta(k,\\eta_f)=\\delta(k,\\eta_i)\\,$.\n    3. Pure derivative-driven evolution: $\\,k=0.5\\,$, $\\,\\eta_i=1.5\\,$, $\\,\\eta_f=6.0\\,$, $\\,\\delta(k,\\eta_i)=0.0\\,$, $\\,\\theta(k,\\eta_i)=-0.5\\,$.\n    4. Decaying-mode initial condition: choose $\\,k=2.0\\,$, $\\,\\eta_i=3.0\\,$, $\\,\\eta_f=9.0\\,$, $\\,\\delta(k,\\eta_i)=1.0\\,$, $\\,\\theta(k,\\eta_i)=1.0\\,$, which sets $\\,\\delta'(k,\\eta_i)=-1.0\\,$ and yields evolution dominated by the decaying mode.\n- All quantities are dimensionless. No physical units are required in the output.\n- Your program should produce a single line of output containing the results for the test suite as a comma-separated list enclosed in square brackets, in the order given above, i.e., $\\,\\big[\\delta(k_1,\\eta_f),\\delta(k_2,\\eta_f),\\delta(k_3,\\eta_f),\\delta(k_4,\\eta_f)\\big]\\,$. Each element must be a floating-point number.\n\nScientific realism and constraints:\n- Your derivation must be consistent with a pressureless matter-only background where the scale factor evolves as $\\,a(\\eta)\\propto \\eta^2\\,$ and the conformal Hubble rate satisfies $\\,\\mathcal{H}(\\eta) = a'(\\eta)/a(\\eta) = 2/\\eta\\,$.\n- You must not use pre-supplied shortcut formulas in the problem statement; instead, build the solution from the stated fundamental equations and concepts in the solution section.", "solution": "The user has requested the derivation and implementation of a numerical method to evolve linear cosmological density perturbations in a matter-only Einstein–de Sitter (EdS) Universe. The method must be based on the Green's function formalism for the governing second-order ordinary differential equation (ODE).\n\nThe analysis proceeds in three stages:\n1.  Derivation of the governing ODE for the density contrast $\\delta(k,\\eta)$ from fundamental fluid equations.\n2.  Solution of this ODE in an EdS background and construction of the propagation kernels from the fundamental solutions.\n3.  Implementation of the resulting analytical solution to evolve arbitrary initial conditions.\n\n**1. Derivation of the Governing Differential Equation**\n\nWe begin with the linearized fluid equations for a pressureless, self-gravitating fluid in an expanding Friedmann–Lemaître–Robertson–Walker (FLRW) background, expressed in comoving coordinates and conformal time $\\eta$. We work in Fourier space, where perturbations are decomposed into modes with comoving wavenumber $k$. The relevant quantities are the density contrast $\\delta = (\\rho - \\bar{\\rho})/\\bar{\\rho}$, the peculiar velocity divergence $\\theta = i\\vec{k} \\cdot \\vec{v}$, and the Newtonian gravitational potential perturbation $\\Phi$.\n\nThe three fundamental equations are:\n1.  The linearized continuity equation, which describes mass conservation:\n    $$ \\delta'(k, \\eta) + \\theta(k, \\eta) = 0 $$\n    Here, the prime denotes differentiation with respect to conformal time, $\\eta$.\n\n2.  The linearized Euler equation, which describes momentum conservation:\n    $$ \\theta'(k, \\eta) + \\mathcal{H}(\\eta)\\theta(k, \\eta) = -k^2 \\Phi(k, \\eta) $$\n    where $\\mathcal{H}(\\eta) = a'(\\eta)/a(\\eta)$ is the conformal Hubble parameter and $a(\\eta)$ is the scale factor.\n\n3.  The linearized Poisson equation, which relates the gravitational potential to the density perturbation:\n    $$ -k^2 \\Phi(k, \\eta) = 4\\pi G a(\\eta)^2 \\bar{\\rho}_m(\\eta) \\delta(k, \\eta) $$\n    where $\\bar{\\rho}_m$ is the mean background matter density and $G$ is the gravitational constant.\n\nTo close this system, we use the background Friedmann equation for a spatially flat Universe, which relates the Hubble parameter to the background density:\n$$ \\mathcal{H}^2 = \\frac{8\\pi G}{3} a^2 \\bar{\\rho}_m $$\nFrom the Friedmann equation, we can express the term on the right-hand side of the Poisson equation as:\n$$ 4\\pi G a^2 \\bar{\\rho}_m = \\frac{3}{2} \\mathcal{H}^2 $$\nSubstituting this into the Poisson equation ($3$) gives:\n$$ -k^2 \\Phi(k, \\eta) = \\frac{3}{2} \\mathcal{H}(\\eta)^2 \\delta(k, \\eta) $$\nNow, we can combine these equations to obtain a single ODE for $\\delta(k, \\eta)$.\nFirst, substitute the expression for $-k^2 \\Phi$ into the Euler equation ($2$):\n$$ \\theta'(k, \\eta) + \\mathcal{H}(\\eta)\\theta(k, \\eta) = \\frac{3}{2} \\mathcal{H}(\\eta)^2 \\delta(k, \\eta) $$\nNext, we eliminate $\\theta$ using the continuity equation ($1$). From equation ($1$), we have $\\theta = -\\delta'$ and, by differentiation, $\\theta' = -\\delta''$. Substituting these into the modified Euler equation yields:\n$$ -\\delta''(k, \\eta) + \\mathcal{H}(\\eta)(-\\delta'(k, \\eta)) = \\frac{3}{2} \\mathcal{H}(\\eta)^2 \\delta(k, \\eta) $$\nRearranging this gives the second-order linear homogeneous ODE for the density contrast:\n$$ \\delta'' + \\mathcal{H} \\delta' - \\frac{3}{2} \\mathcal{H}^2 \\delta = 0 $$\nFor a matter-only Einstein–de Sitter (EdS) universe, the scale factor evolves as $a(\\eta) \\propto \\eta^2$. The conformal Hubble parameter is therefore $\\mathcal{H}(\\eta) = a'/a = (2\\eta)/\\eta^2 = 2/\\eta$. Substituting this into the general ODE gives the specific equation for the EdS model:\n$$ \\delta'' + \\frac{2}{\\eta} \\delta' - \\frac{3}{2} \\left(\\frac{2}{\\eta}\\right)^2 \\delta = 0 $$\n$$ \\delta'' + \\frac{2}{\\eta} \\delta' - \\frac{6}{\\eta^2} \\delta = 0 $$\nNote that this equation is independent of the wavenumber $k$, a characteristic result for pressureless matter perturbations on sub-horizon scales.\n\n**2. Solution and Construction of Propagation Kernels**\n\nThe derived ODE is an Euler-Cauchy equation. We seek power-law solutions of the form $\\delta(\\eta) \\propto \\eta^p$. Substituting this ansatz into the equation gives the characteristic equation for the exponent $p$:\n$$ p(p-1) + 2p - 6 = 0 $$\n$$ p^2 + p - 6 = 0 $$\n$$ (p+3)(p-2) = 0 $$\nThe roots are $p=2$ and $p=-3$. This yields two linearly independent fundamental solutions:\n- Growing mode: $u_1(\\eta) = \\eta^2$\n- Decaying mode: $u_2(\\eta) = \\eta^{-3}$\n\nThe general solution is a linear combination of these two modes:\n$$ \\delta(\\eta) = C_1 u_1(\\eta) + C_2 u_2(\\eta) = C_1 \\eta^2 + C_2 \\eta^{-3} $$\nThe coefficients $C_1$ and $C_2$ are determined by the initial conditions at some initial time $\\eta_i$. Specifically, we need values for the function and its first derivative: $\\delta(\\eta_i)$ and $\\delta'(\\eta_i)$.\n$$ \\delta(\\eta_i) = C_1 \\eta_i^2 + C_2 \\eta_i^{-3} $$\n$$ \\delta'(\\eta_i) = C_1 (2\\eta_i) + C_2 (-3\\eta_i^{-4}) $$\nSolving this linear system for $C_1$ and $C_2$ in terms of $\\delta(\\eta_i)$ and $\\delta'(\\eta_i)$ gives:\n$$ C_1 = \\frac{1}{5} \\left( 3\\eta_i^{-2} \\delta(\\eta_i) + \\eta_i^{-1} \\delta'(\\eta_i) \\right) $$\n$$ C_2 = \\frac{1}{5} \\left( 2\\eta_i^{3} \\delta(\\eta_i) - \\eta_i^{4} \\delta'(\\eta_i) \\right) $$\nSubstituting these coefficients back into the general solution and evaluating at a final time $\\eta_f > \\eta_i$ gives $\\delta(\\eta_f)$:\n$$ \\delta(\\eta_f) = C_1 \\eta_f^2 + C_2 \\eta_f^{-3} $$\n$$ \\delta(\\eta_f) = \\frac{1}{5} \\left( 3\\eta_i^{-2} \\delta(\\eta_i) + \\eta_i^{-1} \\delta'(\\eta_i) \\right) \\eta_f^2 + \\frac{1}{5} \\left( 2\\eta_i^{3} \\delta(\\eta_i) - \\eta_i^{4} \\delta'(\\eta_i) \\right) \\eta_f^{-3} $$\nWe can group the terms by the initial conditions $\\delta(\\eta_i)$ and $\\delta'(\\eta_i)$ to find the propagation kernels.\n$$ \\delta(\\eta_f) = \\left( \\frac{3}{5}\\eta_f^2\\eta_i^{-2} + \\frac{2}{5}\\eta_f^{-3}\\eta_i^3 \\right) \\delta(\\eta_i) + \\left( \\frac{1}{5}\\eta_f^2\\eta_i^{-1} - \\frac{1}{5}\\eta_f^{-3}\\eta_i^4 \\right) \\delta'(\\eta_i) $$\nThis expression has the form $\\delta(\\eta_f) = K_\\delta(\\eta_f, \\eta_i) \\delta(\\eta_i) + K_{\\delta'}(\\eta_f, \\eta_i) \\delta'(\\eta_i)$, where $K_\\delta$ and $K_{\\delta'}$ are the kernels that propagate the initial function and its derivative, respectively. These kernels constitute the Green's function solution for the initial value problem.\n\n**3. Implementation Formula**\n\nFor numerical implementation, we use the derived propagation formula. The problem provides initial conditions for $\\delta(k, \\eta_i)$ and the velocity divergence $\\theta(k, \\eta_i)$. From the continuity equation, we use the relation $\\delta'(k, \\eta_i) = -\\theta(k, \\eta_i)$.\n\nThe final formula to be implemented is:\n$$ \\delta(k, \\eta_f) = K_\\delta(\\eta_f, \\eta_i) \\delta(k, \\eta_i) - K_{\\delta'}(\\eta_f, \\eta_i) \\theta(k, \\eta_i) $$\nwhere the kernels are:\n$$ K_\\delta(\\eta_f, \\eta_i) = \\frac{3}{5}\\left(\\frac{\\eta_f}{\\eta_i}\\right)^2 + \\frac{2}{5}\\left(\\frac{\\eta_i}{\\eta_f}\\right)^3 $$\n$$ K_{\\delta'}(\\eta_f, \\eta_i) = \\frac{\\eta_i}{5}\\left[ \\left(\\frac{\\eta_f}{\\eta_i}\\right)^2 - \\left(\\frac{\\eta_i}{\\eta_f}\\right)^3 \\right] = \\frac{1}{5}\\eta_f^2\\eta_i^{-1} - \\frac{1}{5}\\eta_f^{-3}\\eta_i^4 $$\nThese expressions are independent of $k$, so the value of $k$ in each test case is formally part of the state vector but does not affect the calculation for the evolution of $\\delta$. This formula will be applied to each test case.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the evolution of linear density perturbations in an Einstein-de Sitter\n    universe using an analytical propagator derived from first principles.\n    \"\"\"\n\n    # Test cases are tuples of (k, eta_i, eta_f, delta_i, theta_i)\n    # k is the comoving wavenumber (not used in the calculation for EdS matter-only model)\n    # eta_i is the initial conformal time\n    # eta_f is the final conformal time\n    # delta_i is the initial density contrast delta(k, eta_i)\n    # theta_i is the initial velocity divergence theta(k, eta_i)\n    test_cases = [\n        (0.1, 1.0, 5.0, 0.8, -0.2),\n        (1.0, 2.0, 2.0, 1.234, 0.0),\n        (0.5, 1.5, 6.0, 0.0, -0.5),\n        (2.0, 3.0, 9.0, 1.0, 1.0),\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        k, eta_i, eta_f, delta_i, theta_i = case\n\n        # From the continuity equation in conformal time, delta' = -theta.\n        delta_prime_i = -theta_i\n\n        # To avoid division by zero if eta_i is zero, although test cases prevent this.\n        if eta_i == 0.0:\n            if delta_i == 0.0:\n                result = 0.0 # Perturbations don't grow from zero\n            else:\n                # This case is singular and not well-defined by the problem.\n                # Defaulting to NaN to indicate an issue.\n                result = float('nan')\n            results.append(result)\n            continue\n            \n        # Ratios of final to initial time\n        ratio_f_over_i = eta_f / eta_i\n        ratio_i_over_f = eta_i / eta_f\n\n        # Calculate the propagation kernels K_delta and K_delta_prime, which evolve\n        # the initial state (delta(eta_i), delta'(eta_i)) to delta(eta_f).\n        # Kernel for the initial value delta(eta_i):\n        # K_delta = (3/5)*(eta_f/eta_i)^2 + (2/5)*(eta_i/eta_f)^3\n        K_delta = 0.6 * (ratio_f_over_i**2) + 0.4 * (ratio_i_over_f**3)\n\n        # Kernel for the initial derivative delta'(eta_i):\n        # K_delta_prime = (eta_i/5) * [ (eta_f/eta_i)^2 - (eta_i/eta_f)^3 ]\n        K_delta_prime = (eta_i / 5.0) * (ratio_f_over_i**2 - ratio_i_over_f**3)\n\n        # Apply the propagator to the initial conditions to get the final density contrast.\n        # delta(eta_f) = K_delta * delta(eta_i) + K_delta_prime * delta'(eta_i)\n        delta_f = K_delta * delta_i + K_delta_prime * delta_prime_i\n        \n        results.append(delta_f)\n\n    # Format the output as a comma-separated list in square brackets.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3466045"}, {"introduction": "While the physical evolution of perturbations is unique, our mathematical description of it depends on the coordinate system, or 'gauge', we choose. This practice explores the crucial concept of gauge freedom by connecting two of the most widely used gauges in cosmology: the synchronous and the Newtonian (or longitudinal) gauges. You will begin with a known perturbation mode in synchronous gauge, explicitly compute the coordinate transformation required to describe it in Newtonian gauge, and verify that the resulting gauge-invariant Bardeen potentials, $\\Phi_B$ and $\\Psi_B$, are indeed independent of this procedure and behave as expected for the underlying physical mode [@problem_id:3466020]. This exercise is fundamental to correctly interpreting and comparing results across the theoretical and numerical literature.", "problem": "Consider a spatially flat Friedmann–Lemaître–Robertson–Walker (FLRW) universe filled by a single pressureless perfect fluid (cold dark matter) with equation of state parameter $w=0$ and vanishing anisotropic stress, in conformal time $\\eta$. Work in units where the speed of light $c=1$ and the gravitational coupling is normalized such that $4\\pi G a^2 \\rho = \\tfrac{3}{2}\\,\\mathcal{H}^2$ in matter domination, where $a(\\eta)$ is the scale factor, $\\rho(\\eta)$ is the background density, and $\\mathcal{H}(\\eta) \\equiv a'(\\eta)/a(\\eta)$ is the conformal Hubble rate. For an Einstein–de Sitter background, assume $a(\\eta)\\propto \\eta^2$, so $\\mathcal{H}(\\eta) = 2/\\eta$.\n\nFocus on linear scalar perturbations and a single Fourier mode with comoving wavenumber $k$. In synchronous gauge comoving with the cold dark matter, let the growing-mode density contrast be specified by $\\delta_s(\\eta)$ and the synchronous metric perturbations be $(h(\\eta),\\eta_s(\\eta))$ in the standard trace/traceless decomposition. Use the fundamental linearized Einstein equations and cold dark matter energy-momentum conservation laws as the starting point, namely:\n- The matter-dominated background relation $4\\pi G a^2 \\rho = \\tfrac{3}{2}\\,\\mathcal{H}^2$.\n- The synchronous-gauge cold dark matter continuity equation $\\delta_s'(\\eta) = -\\tfrac{1}{2}\\,h'(\\eta)$.\n- The synchronous-gauge Hamiltonian constraint for scalar perturbations $k^2 \\eta_s(\\eta) - \\tfrac{1}{2}\\,\\mathcal{H}(\\eta)\\,h'(\\eta) = \\tfrac{3}{2}\\,\\mathcal{H}(\\eta)^2 \\delta_s(\\eta)$.\n- The synchronous-to-Newtonian (longitudinal) gauge transformation determined by the scalar time-shift generator $\\alpha(\\eta)$, with $\\alpha(\\eta) \\equiv \\tfrac{h'(\\eta) + 6\\,\\eta_s'(\\eta)}{2 k^2}$.\n- The Bardeen potentials defined in terms of the gauge transformation by $\\Psi_B(\\eta) \\equiv -\\alpha'(\\eta) - \\mathcal{H}(\\eta)\\,\\alpha(\\eta)$ and $\\Phi_B(\\eta) \\equiv \\eta_s(\\eta) - \\mathcal{H}(\\eta)\\,\\alpha(\\eta)$, which coincide with the Newtonian-gauge lapse and curvature potentials, respectively, in the absence of anisotropic stress.\n\nYour task is to write a program that:\n- Constructs the synchronous-gauge growing mode for a chosen amplitude parameter $A$ by taking $\\delta_s(\\eta) = A\\,\\eta^2$ (which is consistent with matter domination, $\\delta_s \\propto a$), and uses the above fundamental relations to determine $h'(\\eta)$ and $\\eta_s(\\eta)$.\n- Computes the generator $\\alpha(\\eta)$ and the corresponding gauge-invariant Bardeen potentials $\\Phi_B(\\eta)$ and $\\Psi_B(\\eta)$ across the specified conformal time interval.\n- Verifies two properties that must hold for a single pressureless fluid without anisotropic stress: (i) equality of the Bardeen potentials $\\Phi_B(\\eta)$ and $\\Psi_B(\\eta)$ at all times, and (ii) time-independence of these potentials for the growing mode in matter domination.\n- Quantifies the verification by computing, for each test case, a single scalar diagnostic equal to the maximum over the sampled time interval of the three absolute differences: $|\\Phi_B(\\eta) - \\Psi_B(\\eta)|$, $|\\Phi_B(\\eta) - \\Phi_{\\mathrm{const}}|$, and $|\\Psi_B(\\eta) - \\Phi_{\\mathrm{const}}|$, where $\\Phi_{\\mathrm{const}} \\equiv \\tfrac{6A}{k^2}$ is the constant expected value of the Bardeen potentials for the growing mode.\n\nAll quantities are dimensionless in these units. Angles do not appear; therefore, no angle units are required. The final outputs should be floating-point numbers.\n\nImplement the program to evaluate the diagnostic for the following test suite of parameter values, each specified as a tuple $(k,A,\\eta_{\\min},\\eta_{\\max},N)$:\n- Test case $1$: $(k=\\;0.01,\\;A=\\;10^{-6},\\;\\eta_{\\min}=\\;0.1,\\;\\eta_{\\max}=\\;10,\\;N=\\;100)$.\n- Test case $2$: $(k=\\;2.0,\\;A=\\;10^{-6},\\;\\eta_{\\min}=\\;0.1,\\;\\eta_{\\max}=\\;10,\\;N=\\;100)$.\n- Test case $3$: $(k=\\;50.0,\\;A=\\;10^{-6},\\;\\eta_{\\min}=\\;0.1,\\;\\eta_{\\max}=\\;10,\\;N=\\;100)$.\n- Test case $4$: $(k=\\;1.0,\\;A=\\;5\\times 10^{-7},\\;\\eta_{\\min}=\\;10^{-3},\\;\\eta_{\\max}=\\;10^{-2},\\;N=\\;50)$.\n\nYour program should produce a single line of output containing the four diagnostics, as a comma-separated list enclosed in square brackets and ordered as listed above (for example, $[\\mathrm{d}_1,\\mathrm{d}_2,\\mathrm{d}_3,\\mathrm{d}_4]$). Each diagnostic must be a floating-point number computed from the corresponding test case.", "solution": "The problem statement is critically validated before proceeding to a solution.\n\n### Step 1: Extract Givens\n- **Cosmological Model**: Spatially flat FLRW universe with a single pressureless perfect fluid (cold dark matter, $w=0$, vanishing anisotropic stress).\n- **Time Coordinate**: Conformal time $\\eta$.\n- **Background Evolution**: Einstein–de Sitter, with scale factor $a(\\eta) \\propto \\eta^2$ and conformal Hubble rate $\\mathcal{H}(\\eta) \\equiv a'(\\eta)/a(\\eta) = 2/\\eta$.\n- **Normalization**: Units are chosen such that $c=1$ and $4\\pi G a^2 \\rho = \\tfrac{3}{2}\\,\\mathcal{H}^2$.\n- **Perturbations**: Linear scalar perturbations in synchronous gauge comoving with CDM, for a single Fourier mode with wavenumber $k$.\n- **Perturbation Variables**: Synchronous density contrast $\\delta_s(\\eta)$, metric perturbations $(h(\\eta), \\eta_s(\\eta))$.\n- **Governing Equations**:\n    1.  Continuity equation: $\\delta_s'(\\eta) = -\\tfrac{1}{2}\\,h'(\\eta)$.\n    2.  Hamiltonian constraint: $k^2 \\eta_s(\\eta) - \\tfrac{1}{2}\\,\\mathcal{H}(\\eta)\\,h'(\\eta) = \\tfrac{3}{2}\\,\\mathcal{H}(\\eta)^2 \\delta_s(\\eta)$.\n- **Gauge Transformation and Invariants**:\n    1.  Gauge generator to Newtonian gauge: $\\alpha(\\eta) \\equiv \\tfrac{h'(\\eta) + 6\\,\\eta_s'(\\eta)}{2 k^2}$.\n    2.  Bardeen potentials: $\\Psi_B(\\eta) \\equiv -\\alpha'(\\eta) - \\mathcal{H}(\\eta)\\,\\alpha(\\eta)$ and $\\Phi_B(\\eta) \\equiv \\eta_s(\\eta) - \\mathcal{H}(\\eta)\\,\\alpha(\\eta)$.\n- **Growing Mode Ansatz**: $\\delta_s(\\eta) = A\\,\\eta^2$.\n- **Expected Constant Potential**: $\\Phi_{\\mathrm{const}} \\equiv \\tfrac{6A}{k^2}$.\n- **Task**: For given parameters, calculate synchronous perturbations, the gauge generator $\\alpha(\\eta)$, the Bardeen potentials $\\Phi_B(\\eta)$ and $\\Psi_B(\\eta)$, and compute a diagnostic.\n- **Diagnostic Definition**: $D = \\max_{\\eta \\in [\\eta_{\\min}, \\eta_{\\max}]} \\left( |\\Phi_B(\\eta) - \\Psi_B(\\eta)|, |\\Phi_B(\\eta) - \\Phi_{\\mathrm{const}}|, |\\Psi_B(\\eta) - \\Phi_{\\mathrm{const}}| \\right)$.\n- **Test Cases**:\n    - Case 1: $(k=0.01, A=10^{-6}, \\eta_{\\min}=0.1, \\eta_{\\max}=10, N=100)$\n    - Case 2: $(k=2.0, A=10^{-6}, \\eta_{\\min}=0.1, \\eta_{\\max}=10, N=100)$\n    - Case 3: $(k=50.0, A=10^{-6}, \\eta_{\\min}=0.1, \\eta_{\\max}=10, N=100)$\n    - Case 4: $(k=1.0, A=5\\times 10^{-7}, \\eta_{\\min}=10^{-3}, \\eta_{\\max}=10^{-2}, N=50)$\n\n### Step 2: Validate Using Extracted Givens\n- **Scientifically Grounded**: The problem is based on the standard, well-established theory of cosmological perturbations in a simplified FLRW universe. All equations and definitions are standard textbook material.\n- **Well-Posed**: The problem is clearly stated, with all necessary equations, initial conditions (the growing-mode ansatz), and parameters provided to derive a unique solution and compute the required diagnostic.\n- **Objective**: The problem uses precise, objective scientific language and is free of subjective claims.\n- **Flaw Check**:\n    1.  **Scientific/Factual Unsoundness**: None. The physics and mathematics are correct for the specified model.\n    2.  **Non-Formalizable/Irrelevant**: None. The problem is a formal exercise in numerical cosmology.\n    3.  **Incomplete/Contradictory Setup**: None. The system of equations is complete and consistent for the task.\n    4.  **Unrealistic/Infeasible**: None. The model is a standard simplification, and the parameters are physically reasonable for such an analysis.\n    5.  **Ill-Posed/Poorly Structured**: None. A unique, stable solution is derivable.\n    6.  **Pseudo-Profound/Trivial**: None. The problem is a non-trivial but standard exercise that tests fundamental concepts.\n    7.  **Outside Scientific Verifiability**: None. The results are verifiable through direct calculation.\n\n### Step 3: Verdict and Action\nThe problem is valid. A complete solution will be provided.\n\n### Solution Derivation and Algorithmic Design\nThe objective is to compute a diagnostic that numerically verifies fundamental properties of cosmological perturbations in a matter-dominated universe. This requires first deriving analytical expressions for the quantities involved and then implementing them numerically.\n\n**1. Analytical Derivation**\n\nGiven the growing-mode density contrast in matter domination, $\\delta_s(\\eta) = A\\,\\eta^2$, and the conformal Hubble rate $\\mathcal{H}(\\eta) = 2/\\eta$, we derive the other perturbation variables.\n\n- **Synchronous Metric Perturbation $h'(\\eta)$**:\nFrom the continuity equation, $\\delta_s'(\\eta) = -\\tfrac{1}{2}\\,h'(\\eta)$. The derivative of the density contrast is $\\delta_s'(\\eta) = \\frac{d}{d\\eta}(A\\,\\eta^2) = 2A\\eta$.\nThus, $h'(\\eta) = -2\\,\\delta_s'(\\eta) = -4A\\eta$.\n\n- **Synchronous Metric Perturbation $\\eta_s(\\eta)$**:\nThe Hamiltonian constraint is $k^2 \\eta_s(\\eta) - \\tfrac{1}{2}\\,\\mathcal{H}(\\eta)\\,h'(\\eta) = \\tfrac{3}{2}\\,\\mathcal{H}(\\eta)^2 \\delta_s(\\eta)$.\nSubstituting the known expressions:\n$k^2 \\eta_s(\\eta) - \\tfrac{1}{2}\\,(2/\\eta)\\,(-4A\\eta) = \\tfrac{3}{2}\\,(2/\\eta)^2 (A\\,\\eta^2)$\n$k^2 \\eta_s(\\eta) + 4A = \\tfrac{3}{2}\\,(4/\\eta^2) (A\\eta^2) = 6A$\nSolving for $\\eta_s(\\eta)$ yields $k^2 \\eta_s(\\eta) = 2A$, so $\\eta_s(\\eta) = \\frac{2A}{k^2}$. This is a constant.\n\n- **Gauge Transformation Generator $\\alpha(\\eta)$**:\nThe generator is defined as $\\alpha(\\eta) = \\tfrac{h'(\\eta) + 6\\,\\eta_s'(\\eta)}{2 k^2}$.\nSince $\\eta_s(\\eta)$ is constant, its derivative $\\eta_s'(\\eta) = 0$.\nSubstituting this and the expression for $h'(\\eta)$:\n$\\alpha(\\eta) = \\frac{-4A\\eta + 6(0)}{2k^2} = -\\frac{2A\\eta}{k^2}$.\n\n- **Bardeen Potentials $\\Phi_B(\\eta)$ and $\\Psi_B(\\eta)$**:\nTo find $\\Psi_B(\\eta)$, we first need the derivative of $\\alpha(\\eta)$: $\\alpha'(\\eta) = \\frac{d}{d\\eta}\\left(-\\frac{2A\\eta}{k^2}\\right) = -\\frac{2A}{k^2}$.\nNow we compute the potentials using their definitions:\n$\\Phi_B(\\eta) = \\eta_s(\\eta) - \\mathcal{H}(\\eta)\\,\\alpha(\\eta) = \\frac{2A}{k^2} - (\\frac{2}{\\eta})\\left(-\\frac{2A\\eta}{k^2}\\right) = \\frac{2A}{k^2} + \\frac{4A}{k^2} = \\frac{6A}{k^2}$.\n$\\Psi_B(\\eta) = -\\alpha'(\\eta) - \\mathcal{H}(\\eta)\\,\\alpha(\\eta) = -\\left(-\\frac{2A}{k^2}\\right) - (\\frac{2}{\\eta})\\left(-\\frac{2A\\eta}{k^2}\\right) = \\frac{2A}{k^2} + \\frac{4A}{k^2} = \\frac{6A}{k^2}$.\n\n**2. Verification and Numerical Strategy**\n\nThe analytical derivation confirms that for the growing mode in matter domination without anisotropic stress:\n(i) The Bardeen potentials are equal: $\\Phi_B(\\eta) = \\Psi_B(\\eta)$.\n(ii) The potentials are constant in time: $\\Phi_B(\\eta) = \\Psi_B(\\eta) = \\frac{6A}{k^2}$, which matches the provided $\\Phi_{\\mathrm{const}}$.\n\nAnalytically, all three differences in the diagnostic computation are identically zero. The purpose of the numerical task is to implement the sequence of calculations as defined and measure the degree to which these identities hold under finite-precision arithmetic. The computed diagnostic will be a small, non-zero number quantifying the accumulated floating-point error.\n\nThe algorithm will be:\n1.  For each test case, create a grid of $N$ points in $\\eta$ from $\\eta_{\\min}$ to $\\eta_{\\max}$.\n2.  Calculate the arrays for $h'(\\eta)$ and $\\eta_s(\\eta)$ using their analytical forms.\n3.  Numerically differentiate the $\\eta_s(\\eta)$ array to get $\\eta_s'(\\eta)$.\n4.  Calculate the array for the generator $\\alpha(\\eta)$ using the given formula.\n5.  Numerically differentiate the $\\alpha(\\eta)$ array to get $\\alpha'(\\eta)$.\n6.  Calculate the arrays for the Bardeen potentials $\\Phi_B(\\eta)$ and $\\Psi_B(\\eta)$ using their definitions.\n7.  Compute the three absolute difference arrays: $|\\Phi_B - \\Psi_B|$, $|\\Phi_B - \\Phi_{\\mathrm{const}}|$, and $|\\Psi_B - \\Phi_{\\mathrm{const}}|$.\n8.  The final diagnostic is the maximum value across all elements of these three arrays. The use of `numpy.gradient` is appropriate for numerical differentiation. Since the functions being differentiated are constant or linear, this method is numerically exact up to machine precision.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_diagnostic(k, A, eta_min, eta_max, N):\n    \"\"\"\n    Calculates the diagnostic for a given set of cosmological parameters.\n\n    The function follows the derivation steps outlined in the problem:\n    1. Define the time grid and constant potential.\n    2. Compute the synchronous gauge perturbations h' and eta_s.\n    3. Compute the gauge generator alpha, requiring a numerical derivative of eta_s.\n    4. Compute the Bardeen potentials, requiring a numerical derivative of alpha.\n    5. Calculate the maximum absolute difference between the computed potentials\n       and the expected constant value.\n\n    Args:\n        k (float): Comoving wavenumber.\n        A (float): Amplitude of the density contrast.\n        eta_min (float): Minimum conformal time.\n        eta_max (float): Maximum conformal time.\n        N (int): Number of time steps.\n\n    Returns:\n        float: The computed diagnostic value.\n    \"\"\"\n    # 1. Create a linearly spaced array for conformal time eta.\n    eta = np.linspace(eta_min, eta_max, N)\n\n    # The expected constant value for the Bardeen potentials.\n    Phi_const = 6.0 * A / k**2\n\n    # 2. Analytically determine the synchronous gauge perturbation quantities.\n    # h'(eta) = -4 * A * eta\n    h_prime = -4.0 * A * eta\n\n    # eta_s is constant for the growing mode: eta_s = 2 * A / k^2\n    eta_s_val = 2.0 * A / k**2\n    eta_s = np.full_like(eta, eta_s_val)\n\n    # 3. Compute the gauge generator alpha(eta). This requires eta_s'(eta).\n    # We compute eta_s' by numerically differentiating the eta_s array.\n    # For a constant array, the result should be numerically zero.\n    eta_s_prime = np.gradient(eta_s, eta)\n    alpha = (h_prime + 6.0 * eta_s_prime) / (2.0 * k**2)\n\n    # 4. Compute the Bardeen potentials. This requires alpha'(eta) and H(eta).\n    # Conformal Hubble rate: H(eta) = 2 / eta\n    H_conformal = 2.0 / eta\n\n    # Compute alpha' by numerically differentiating the alpha array.\n    # a(eta) is linear, so the derivative should be a numerically constant array.\n    alpha_prime = np.gradient(alpha, eta)\n\n    # Gauge-invariant Bardeen potentials from their definitions.\n    Phi_B = eta_s - H_conformal * alpha\n    Psi_B = -alpha_prime - H_conformal * alpha\n\n    # 5. Compute the differences to be checked for the diagnostic.\n    diff_Phi_Psi = np.abs(Phi_B - Psi_B)\n    diff_Phi_const = np.abs(Phi_B - Phi_const)\n    diff_Psi_const = np.abs(Psi_B - Phi_const)\n\n    # 6. The diagnostic is the maximum of all computed differences over the time interval.\n    max_diff = np.max([np.max(diff_Phi_Psi), np.max(diff_Phi_const), np.max(diff_Psi_const)])\n    \n    return max_diff\n\ndef solve():\n    \"\"\"\n    Main function to run the test cases and print the results.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (0.01, 1e-6, 0.1, 10.0, 100),\n        (2.0, 1e-6, 0.1, 10.0, 100),\n        (50.0, 1e-6, 0.1, 10.0, 100),\n        (1.0, 5e-7, 1e-3, 1e-2, 50),\n    ]\n\n    results = []\n    for case in test_cases:\n        k, A, eta_min, eta_max, N = case\n        diagnostic = calculate_diagnostic(k, A, eta_min, eta_max, N)\n        results.append(diagnostic)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3466020"}, {"introduction": "Moving towards a more realistic description of the early universe requires us to consider the coupled fluid of photons and baryons before the epoch of recombination. Solving the full Boltzmann hierarchy that describes their interaction is computationally intensive, necessitating the use of carefully justified approximations. This exercise introduces one of the most important of these: the tight-coupling approximation (TCA), which is valid when Thomson scattering is highly efficient [@problem_id:3466029]. By implementing and comparing the evolution of the full, approximate, and hybrid systems, you will gain practical experience with a core technique used in modern Boltzmann solvers and develop an intuition for its domain of validity and the errors it introduces.", "problem": "You are asked to implement and compare two numerical schemes for the coupled photon–baryon fluid in linear cosmological perturbation theory, and to quantify the error introduced by a practical switch from the tight-coupling approximation to a truncated Boltzmann hierarchy at photon decoupling. Work in conformal Newtonian gauge for a single Fourier mode of wavenumber $k$, with conformal time $\\eta$ as the independent variable. All variables in this problem are dimensionless, and no physical unit conversion is required.\n\nStart from the following well-tested and widely accepted foundations of linear cosmological perturbation theory in Fourier space:\n- The photon fluid is described by the monopole density perturbation $\\delta_\\gamma$, the dipole velocity divergence $\\theta_\\gamma$, and the quadrupole anisotropic stress $\\sigma_\\gamma$.\n- The baryon fluid is described by the monopole density perturbation $\\delta_b$ and the dipole velocity divergence $\\theta_b$.\n- Thomson scattering couples photons and baryons through a conformal-time scattering rate $\\tau'(\\eta)$, which in the early Universe scales approximately as $\\tau'(\\eta) \\propto a(\\eta) n_e(\\eta) \\sim \\eta^{-2}$ during radiation domination, where $a(\\eta)$ is the scale factor and $n_e(\\eta)$ is the free electron number density. Model this with $\\tau'(\\eta) = \\tau_0 \\left(\\eta_0 / \\eta\\right)^2$ for some positive constant $\\tau_0$ and reference time $\\eta_0$. For numerical convenience, you will set $\\eta_0 = 1$ and vary $\\tau_0$; thus $\\tau'(\\eta) = \\tau_0 \\eta^{-2}$.\n- The baryon-to-photon momentum density ratio is $R \\equiv 3\\rho_b/(4\\rho_\\gamma)$ and may be treated as a constant parameter over the short time intervals used in the test suite.\n- Neglect cosmic expansion drag terms (the Hubble friction) and gravitational potentials to isolate acoustic dynamics and coupling effects. Treat baryon pressure as negligible, i.e., $c_b^2 = 0$.\n\nUnder these assumptions, the Fourier-space continuity and Euler equations for photons and baryons, along with the lowest non-trivial multipole for photons, read as a closed system when truncated at the photon quadrupole:\n1. Photon continuity: $\\delta_\\gamma' = -\\tfrac{4}{3}\\,\\theta_\\gamma$.\n2. Photon Euler (pressure and coupling, no gravity): $\\theta_\\gamma' = k^2\\left(\\tfrac{1}{4}\\delta_\\gamma - \\sigma_\\gamma\\right) - \\tau'(\\eta)\\left(\\theta_\\gamma - \\theta_b\\right)$.\n3. Photon quadrupole (closure at $\\ell=2$ with collisional damping): $\\sigma_\\gamma' = \\tfrac{4}{15}\\,\\theta_\\gamma - \\tau'(\\eta)\\,\\sigma_\\gamma$.\n4. Baryon continuity: $\\delta_b' = -\\,\\theta_b$.\n5. Baryon Euler (drag only): $\\theta_b' = \\tfrac{\\tau'(\\eta)}{R}\\left(\\theta_\\gamma - \\theta_b\\right)$.\n\nHere, a prime denotes derivative with respect to conformal time $\\eta$. This system defines the \"full truncated Boltzmann hierarchy\" you will integrate numerically.\n\nIn the tight-coupling approximation (TCA), valid when $\\tau'(\\eta)$ is very large, Thomson scattering enforces $\\theta_\\gamma \\approx \\theta_b$ and suppresses the photon anisotropic stress $\\sigma_\\gamma \\approx 0$ to leading order. The tightly coupled photon–baryon fluid then behaves as a single fluid with a common velocity divergence $\\theta$, obeying acoustic dynamics driven by photon pressure. Starting from conservation of energy and momentum for the combined fluid, and using the definition of $R$, show that to leading order in $1/\\tau'$, the closed TCA system reads\n- $\\delta_\\gamma' = -\\tfrac{4}{3}\\,\\theta$,\n- $\\delta_b' = -\\,\\theta$,\n- $\\theta' = \\dfrac{k^2}{4(1+R)}\\,\\delta_\\gamma$.\n\nIn practice, the TCA will be used only while $\\tau'(\\eta)$ exceeds a decoupling threshold.\n\nYour tasks:\n1. Implement a numerical integrator for the full truncated Boltzmann hierarchy (equations 1–5) for a single mode $k$, with parameters $R$ and $\\tau_0$, using $\\tau'(\\eta) = \\tau_0 \\eta^{-2}$. Use adiabatic initial conditions at the start time $\\eta_{\\mathrm{ini}}$: $\\delta_\\gamma(\\eta_{\\mathrm{ini}}) = A$, $\\delta_b(\\eta_{\\mathrm{ini}}) = \\tfrac{3}{4}A$, $\\theta_\\gamma(\\eta_{\\mathrm{ini}}) = 0$, $\\theta_b(\\eta_{\\mathrm{ini}}) = 0$, $\\sigma_\\gamma(\\eta_{\\mathrm{ini}}) = 0$, with $A$ a small amplitude. For all test cases, set $A = 10^{-5}$.\n2. Implement a numerical integrator for the leading-order tight-coupling system specified above, evolving $(\\delta_\\gamma,\\delta_b,\\theta)$.\n3. Implement a \"switched\" scheme that evolves the TCA system from $\\eta_{\\mathrm{ini}}$ up to the decoupling time $\\eta_{\\mathrm{dec}}$ defined implicitly by $\\tau'(\\eta_{\\mathrm{dec}}) = \\tau_{\\mathrm{dec}}$, where $\\tau_{\\mathrm{dec}}$ is a provided positive threshold. At $\\eta_{\\mathrm{dec}}$, construct initial conditions for the full truncated Boltzmann hierarchy as follows: set $\\delta_\\gamma,\\delta_b$ to their TCA values at $\\eta_{\\mathrm{dec}}$; set $\\theta_\\gamma=\\theta_b=\\theta$ from TCA at $\\eta_{\\mathrm{dec}}$; set $\\sigma_\\gamma(\\eta_{\\mathrm{dec}})=0$. Then integrate the full hierarchy from $\\eta_{\\mathrm{dec}}$ to $\\eta_{\\mathrm{end}}$.\n4. For each test case, quantify the absolute errors at $\\eta_{\\mathrm{end}}$ in $\\theta_\\gamma$ and $\\delta_b$ for:\n   - the switched scheme relative to the full truncated Boltzmann hierarchy integrated from $\\eta_{\\mathrm{ini}}$ to $\\eta_{\\mathrm{end}}$ without any TCA, and\n   - the pure TCA solution relative to the same full integration baseline, by comparing $\\theta_\\gamma \\approx \\theta$ and $\\delta_b$ from TCA to the full solution at $\\eta_{\\mathrm{end}}$.\n   Use absolute differences, not normalized ratios.\n\nImplement the above for the following test suite of parameter sets, each given as $(k, R, \\tau_0, \\eta_{\\mathrm{ini}}, \\eta_{\\mathrm{end}}, \\tau_{\\mathrm{dec}})$:\n- Case 1 (general acoustic, typical baryon loading): $(0.1,\\,0.6,\\,10^6,\\,1.0,\\,1000.0,\\,10.0)$.\n- Case 2 (boundary condition $k=0$): $(0.0,\\,0.6,\\,10^6,\\,1.0,\\,1000.0,\\,10.0)$.\n- Case 3 (heavy baryon loading): $(0.05,\\,3.0,\\,5\\times 10^5,\\,1.0,\\,800.0,\\,5.0)$.\n- Case 4 (early decoupling due to lower $\\tau_0$): $(0.2,\\,0.3,\\,10^4,\\,1.0,\\,500.0,\\,5.0)$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each test case contributes a list of four floating-point numbers in the order $[\\lvert\\theta_{\\gamma,\\mathrm{sw}}-\\theta_{\\gamma,\\mathrm{full}}\\rvert,\\lvert\\delta_{b,\\mathrm{sw}}-\\delta_{b,\\mathrm{full}}\\rvert,\\lvert\\theta_{\\gamma,\\mathrm{tca}}-\\theta_{\\gamma,\\mathrm{full}}\\rvert,\\lvert\\delta_{b,\\mathrm{tca}}-\\delta_{b,\\mathrm{full}}\\rvert]$ evaluated at $\\eta_{\\mathrm{end}}$. Aggregate the four test-case lists into a single outer list and print it. For example, an output with two hypothetical cases would look like \"[[e11,e12,e13,e14],[e21,e22,e23,e24]]\".", "solution": "The problem is valid. It presents a well-posed, scientifically grounded task in computational cosmology, requiring the implementation and comparison of numerical schemes for evolving photon-baryon perturbations. All necessary equations, parameters, and conditions are provided, and the setup is internally consistent and objective. The derivation of the tight-coupling approximation (TCA) system from the full truncated Boltzmann hierarchy is a standard procedure and is correctly stated.\n\nThe objective is to quantify the error introduced by using the tight-coupling approximation for the early phase of evolution of the coupled photon-baryon fluid. We will compare three distinct numerical integration schemes for a single Fourier mode with wavenumber $k$. All calculations are performed in conformal Newtonian gauge, using conformal time $\\eta$.\n\nThe state of the system is described by five variables: the photon density perturbation $\\delta_\\gamma$, photon velocity divergence $\\theta_\\gamma$, photon anisotropic stress quadrupole $\\sigma_\\gamma$, baryon density perturbation $\\delta_b$, and baryon velocity divergence $\\theta_b$. The coupling between photons and baryons is mediated by Thomson scattering, with a rate $\\tau'(\\eta) = \\tau_0 \\eta^{-2}$. The baryon inertia is parameterized by the constant ratio $R = 3\\rho_b/(4\\rho_\\gamma)$.\n\nThe three numerical schemes to be implemented are:\n1.  **Full Truncated Boltzmann Hierarchy**: A direct numerical integration of the complete system of five coupled ordinary differential equations (ODEs), which serves as our baseline or \"ground truth\".\n2.  **Pure Tight-Coupling Approximation (TCA)**: A numerical integration of a simplified $3$-variable system, valid in the limit of very high scattering rate ($\\tau' \\to \\infty$), over the entire time interval.\n3.  **Switched Scheme**: A hybrid approach where the computationally cheaper TCA is used during the early, tightly-coupled epoch, followed by a switch to the full hierarchy integration after a specific decoupling time $\\eta_{\\mathrm{dec}}$.\n\nThe governing equations for the two systems are as follows.\n\n**1. Full Truncated Boltzmann Hierarchy**\nThis system consists of five first-order ODEs for the state vector $y(\\eta) = [\\delta_\\gamma, \\theta_\\gamma, \\sigma_\\gamma, \\delta_b, \\theta_b]^T$:\n$$\n\\begin{align*}\n\\frac{d\\delta_\\gamma}{d\\eta} &= -\\frac{4}{3}\\theta_\\gamma \\\\\n\\frac{d\\theta_\\gamma}{d\\eta} &= k^2\\left(\\frac{1}{4}\\delta_\\gamma - \\sigma_\\gamma\\right) - \\tau'(\\eta)\\left(\\theta_\\gamma - \\theta_b\\right) \\\\\n\\frac{d\\sigma_\\gamma}{d\\eta} &= \\frac{4}{15}\\theta_\\gamma - \\tau'(\\eta)\\sigma_\\gamma \\\\\n\\frac{d\\delta_b}{d\\eta} &= -\\theta_b \\\\\n\\frac{d\\theta_b}{d\\eta} &= \\frac{\\tau'(\\eta)}{R}\\left(\\theta_\\gamma - \\theta_b\\right)\n\\end{align*}\n$$\n\n**2. Tight-Coupling Approximation (TCA) System**\nIn the limit $\\tau' \\gg k$, scattering is very efficient, forcing $\\theta_\\gamma \\approx \\theta_b \\equiv \\theta$ and suppressing anisotropic stress, $\\sigma_\\gamma \\approx 0$. The dynamics reduces to a system of three ODEs for the state vector $y_{\\mathrm{TCA}}(\\eta) = [\\delta_\\gamma, \\delta_b, \\theta]^T$:\n$$\n\\begin{align*}\n\\frac{d\\delta_\\gamma}{d\\eta} &= -\\frac{4}{3}\\theta \\\\\n\\frac{d\\delta_b}{d\\eta} &= -\\theta \\\\\n\\frac{d\\theta}{d\\eta} &= \\frac{k^2}{4(1+R)}\\delta_\\gamma\n\\end{align*}\n$$\nThis system describes a single fluid with a common velocity $\\theta$, with its dynamics driven by photon pressure acting on the combined inertia of photons and baryons, $(1+R)$.\n\n**Numerical Integration and Comparison Strategy**\nWe will use a high-precision adaptive step-size ODE solver (`scipy.integrate.solve_ivp` with `RK45` method and tight tolerances `rtol=1e-8, atol=1e-12`) to solve these systems for each test case. Adiabatic initial conditions are imposed at $\\eta = \\eta_{\\mathrm{ini}}$: $\\delta_\\gamma = A$, $\\delta_b = \\frac{3}{4}A$, and all other variables are zero, with amplitude $A = 10^{-5}$.\n\n-   **Full Integration (Baseline)**: We integrate the $5$-variable system from $\\eta_{\\mathrm{ini}}$ to $\\eta_{\\mathrm{end}}$ to obtain the reference solution $[\\delta_{\\gamma,\\mathrm{full}}, \\theta_{\\gamma,\\mathrm{full}}, \\dots]$ at $\\eta_{\\mathrm{end}}$.\n\n-   **Pure TCA Integration**: We integrate the $3$-variable TCA system from $\\eta_{\\mathrm{ini}}$ to $\\eta_{\\mathrm{end}}$ to obtain $[\\delta_{\\gamma,\\mathrm{tca}}, \\delta_{b,\\mathrm{tca}}, \\theta_{\\mathrm{tca}}]$ at $\\eta_{\\mathrm{end}}$.\n\n-   **Switched Scheme Integration**: This is a two-step process:\n    1.  The decoupling time $\\eta_{\\mathrm{dec}}$ is calculated from the condition $\\tau'(\\eta_{\\mathrm{dec}}) = \\tau_{\\mathrm{dec}}$, giving $\\eta_{\\mathrm{dec}} = \\sqrt{\\tau_0 / \\tau_{\\mathrm{dec}}}$.\n    2.  The TCA system is integrated from $\\eta_{\\mathrm{ini}}$ to $\\eta_{\\mathrm{dec}}$, yielding the state $[\\delta_\\gamma(\\eta_{\\mathrm{dec}}), \\delta_b(\\eta_{\\mathrm{dec}}), \\theta(\\eta_{\\mathrm{dec}})]$.\n    3.  These values are used to construct initial conditions for the full system at $\\eta_{\\mathrm{dec}}$: $\\delta_\\gamma$ and $\\delta_b$ are carried over, $\\theta_\\gamma = \\theta_b = \\theta$, and $\\sigma_\\gamma$ is set to $0$.\n    4.  The full $5$-variable system is then integrated from $\\eta_{\\mathrm{dec}}$ to $\\eta_{\\mathrm{end}}$ to obtain the switched solution $[\\delta_{\\gamma,\\mathrm{sw}}, \\theta_{\\gamma,\\mathrm{sw}}, \\dots]$ at $\\eta_{\\mathrm{end}}$.\n\n**Error Quantification**\nFor each test case, we compute four absolute error metrics at the final time $\\eta_{\\mathrm{end}}$:\n1.  Error in $\\theta_\\gamma$ for the switched scheme: $|\\theta_{\\gamma,\\mathrm{sw}}(\\eta_{\\mathrm{end}}) - \\theta_{\\gamma,\\mathrm{full}}(\\eta_{\\mathrm{end}})|$.\n2.  Error in $\\delta_b$ for the switched scheme: $|\\delta_{b,\\mathrm{sw}}(\\eta_{\\mathrm{end}}) - \\delta_{b,\\mathrm{full}}(\\eta_{\\mathrm{end}})|$.\n3.  Error in $\\theta_\\gamma$ for the pure TCA scheme: $|\\theta_{\\mathrm{tca}}(\\eta_{\\mathrm{end}}) - \\theta_{\\gamma,\\mathrm{full}}(\\eta_{\\mathrm{end}})|$.\n4.  Error in $\\delta_b$ for the pure TCA scheme: $|\\delta_{b,\\mathrm{tca}}(\\eta_{\\mathrm{end}}) - \\delta_{b,\\mathrm{full}}(\\eta_{\\mathrm{end}})|$.\n\nThe implementation will loop through the provided test cases, perform these three integrations for each, compute the four error metrics, and format the results as specified.", "answer": "```python\nimport numpy as np\nfrom scipy.integrate import solve_ivp\n\ndef solve():\n    \"\"\"\n    Implements and compares numerical schemes for coupled photon-baryon fluid\n    dynamics in linear cosmological perturbation theory.\n    \"\"\"\n    A = 1e-5  # Initial amplitude\n\n    # Test cases: (k, R, tau_0, eta_ini, eta_end, tau_dec)\n    test_cases = [\n        (0.1, 0.6, 1e6, 1.0, 1000.0, 10.0),\n        (0.0, 0.6, 1e6, 1.0, 1000.0, 10.0),\n        (0.05, 3.0, 5e5, 1.0, 800.0, 5.0),\n        (0.2, 0.3, 1e4, 1.0, 500.0, 5.0),\n    ]\n\n    all_results = []\n\n    # Set stringent tolerances for the ODE solver to minimize its own error\n    rtol = 1e-8\n    atol = 1e-12\n\n    for k, R, tau_0, eta_ini, eta_end, tau_dec in test_cases:\n\n        # --- Define ODE systems ---\n\n        def tau_prime(eta):\n            # Scattering rate as a function of conformal time eta\n            return tau_0 / (eta**2)\n\n        def full_system(eta, y):\n            \"\"\"Full truncated Boltzmann hierarchy (5 variables).\"\"\"\n            delta_gamma, theta_gamma, sigma_gamma, delta_b, theta_b = y\n            tau_p = tau_prime(eta)\n            \n            d_delta_gamma = -4.0/3.0 * theta_gamma\n            d_theta_gamma = k**2 * (0.25 * delta_gamma - sigma_gamma) - tau_p * (theta_gamma - theta_b)\n            d_sigma_gamma = 4.0/15.0 * theta_gamma - tau_p * sigma_gamma\n            d_delta_b = -theta_b\n            d_theta_b = (tau_p / R) * (theta_gamma - theta_b)\n            \n            return [d_delta_gamma, d_theta_gamma, d_sigma_gamma, d_delta_b, d_theta_b]\n\n        def tca_system(eta, y):\n            \"\"\"Tight-Coupling Approximation (TCA) system (3 variables).\"\"\"\n            delta_gamma, delta_b, theta = y\n\n            d_delta_gamma = -4.0/3.0 * theta\n            d_delta_b = -theta\n            d_theta = (k**2 / (4.0 * (1.0 + R))) * delta_gamma\n            \n            return [d_delta_gamma, d_delta_b, d_theta]\n\n        # --- Initial Conditions ---\n        # State vector: [delta_gamma, theta_gamma, sigma_gamma, delta_b, theta_b]\n        y_ini_full = np.array([A, 0.0, 0.0, 0.75 * A, 0.0])\n        # State vector: [delta_gamma, delta_b, theta]\n        y_ini_tca = np.array([A, 0.75 * A, 0.0])\n\n        # --- Scheme 1: Full Boltzmann Hierarchy Integration (Baseline) ---\n        sol_full = solve_ivp(\n            full_system, (eta_ini, eta_end), y_ini_full,\n            rtol=rtol, atol=atol, dense_output=True\n        )\n        y_full_end = sol_full.y[:, -1]\n\n        # --- Scheme 2: Pure TCA Integration ---\n        sol_tca = solve_ivp(\n            tca_system, (eta_ini, eta_end), y_ini_tca,\n            rtol=rtol, atol=atol, dense_output=True\n        )\n        y_tca_end = sol_tca.y[:, -1]\n\n        # --- Scheme 3: Switched Scheme (TCA -> Full) ---\n        eta_dec = np.sqrt(tau_0 / tau_dec) if tau_dec > 0 else eta_end\n        \n        # Part 1: Integrate TCA until eta_dec\n        sol_tca_part1 = solve_ivp(\n            tca_system, (eta_ini, eta_dec), y_ini_tca,\n            rtol=rtol, atol=atol, dense_output=True\n        )\n        y_tca_at_dec = sol_tca_part1.y[:, -1]\n\n        # Construct initial conditions for the full system at eta_dec\n        delta_gamma_dec, delta_b_dec, theta_dec = y_tca_at_dec\n        y_ini_switched = np.array([\n            delta_gamma_dec,  # delta_gamma\n            theta_dec,        # theta_gamma\n            0.0,              # sigma_gamma\n            delta_b_dec,      # delta_b\n            theta_dec         # theta_b\n        ])\n        \n        # Part 2: Integrate full system from eta_dec to eta_end\n        sol_switched_part2 = solve_ivp(\n            full_system, (eta_dec, eta_end), y_ini_switched,\n            rtol=rtol, atol=atol, dense_output=True\n        )\n        y_sw_end = sol_switched_part2.y[:, -1]\n\n        # --- Error Quantification at eta_end ---\n        theta_gamma_full = y_full_end[1]\n        delta_b_full = y_full_end[3]\n\n        theta_gamma_sw = y_sw_end[1]\n        delta_b_sw = y_sw_end[3]\n        \n        delta_b_tca = y_tca_end[1]\n        theta_tca = y_tca_end[2]\n\n        err_theta_sw = abs(theta_gamma_sw - theta_gamma_full)\n        err_delta_b_sw = abs(delta_b_sw - delta_b_full)\n        \n        err_theta_tca = abs(theta_tca - theta_gamma_full)\n        err_delta_b_tca = abs(delta_b_tca - delta_b_full)\n        \n        case_results = [err_theta_sw, err_delta_b_sw, err_theta_tca, err_delta_b_tca]\n        all_results.append(case_results)\n\n    # --- Format and Print Final Output ---\n    # Convert each inner list of floats to a string representation\n    result_strings = [f\"[{','.join(map(str, res))}]\" for res in all_results]\n    \n    # Join the string representations of inner lists with commas and enclose in brackets\n    final_output = f\"[{','.join(result_strings)}]\"\n    print(final_output)\n\nsolve()\n```", "id": "3466029"}]}