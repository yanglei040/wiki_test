{"hands_on_practices": [{"introduction": "The foundation of homogenization lies in replacing a complex microscopic structure with a simplified, uniform effective medium. This practice guides you through the cornerstone of this process: computing the static effective permittivity tensor, $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$, for a periodic metamaterial. By numerically solving the electrostatic \"cell problem\" for a simple checkerboard unit cell, you will gain direct, hands-on experience with the core mathematical framework that underpins effective medium theory in the long-wavelength limit [@problem_id:3314289].", "problem": "Consider a two-dimensional periodic metamaterial with a square unit cell of side length $a$ populated by a checkerboard arrangement of two scalar, positive permittivities $\\epsilon_1$ and $\\epsilon_2$ in alternating quadrants. The macroscopic, effective permittivity tensor $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$ is defined in the long-wavelength limit by the homogenized relation $\\langle \\mathbf{D} \\rangle = \\bar{\\bar{\\epsilon}}_{\\text{eff}} \\langle \\mathbf{E} \\rangle$, where $\\mathbf{D} = \\epsilon(\\mathbf{x}) \\mathbf{E}$ and $\\mathbf{E} = -\\nabla u$ with scalar electric potential $u$. In the homogenization setting, the corrector problems for the canonical macroscopic unit vectors $\\mathbf{e}_x = (1,0)$ and $\\mathbf{e}_y = (0,1)$ are posed on the unit cell with periodic boundary conditions and zero-mean correctors.\n\nStarting from Maxwell's equations and their electrostatic limit, the cell problem can be derived from the constitutive relation and charge-free condition as follows. Let $u_j(\\mathbf{x}) = -\\mathbf{e}_j \\cdot \\mathbf{x} + w_j(\\mathbf{x})$ for $j \\in \\{x,y\\}$, where $w_j$ is a periodic function on the unit cell with zero mean. The local electric field is $\\mathbf{E}_j(\\mathbf{x}) = \\mathbf{e}_j - \\nabla w_j(\\mathbf{x})$, and the displacement field is $\\mathbf{D}_j(\\mathbf{x}) = \\epsilon(\\mathbf{x}) \\mathbf{E}_j(\\mathbf{x})$. The corrector $w_j$ satisfies the cell problem\n$$\n\\nabla \\cdot \\left( \\epsilon(\\mathbf{x}) \\left( \\mathbf{e}_j - \\nabla w_j(\\mathbf{x}) \\right) \\right) = 0\n$$\non the periodic unit cell with zero-mean constraint on $w_j$. The effective permittivity tensor is computed column-wise as\n$$\n\\bar{\\bar{\\epsilon}}_{\\text{eff}} \\, \\mathbf{e}_j = \\langle \\mathbf{D}_j \\rangle = \\frac{1}{a^2} \\int_{\\text{cell}} \\epsilon(\\mathbf{x}) \\left( \\mathbf{e}_j - \\nabla w_j(\\mathbf{x}) \\right) \\, d\\mathbf{x}.\n$$\n\nYou must implement a finite-volume or finite-difference scheme on a uniform grid to approximate the solution of the cell problems for $j \\in \\{x,y\\}$ and then compute $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$. Use harmonic averaging of $\\epsilon$ at cell faces to ensure consistent fluxes across material interfaces. Impose periodic boundary conditions and fix the gauge by enforcing a single node value of $w_j$ to be $0$ to satisfy the zero-mean (up to a constant) constraint.\n\nDefine the unit cell with $a = 1$ and the checkerboard pattern as four quadrants:\n- Lower-left and upper-right quadrants have permittivity $\\epsilon_1$.\n- Upper-left and lower-right quadrants have permittivity $\\epsilon_2$.\nThat is, for coordinates $x \\in [0,1)$ and $y \\in [0,1)$, assign $\\epsilon_1$ or $\\epsilon_2$ according to the quadrant with equal area fractions.\n\nDiscretize the unit cell with a uniform $N \\times N$ grid, where the number of grid points $N$ is chosen as a function of the scale-separation parameter $\\eta = a/\\lambda$ by $N(\\eta) = \\lceil N_0 / \\eta \\rceil$ for a fixed base resolution $N_0 = 12$. Here $\\lambda$ is a notional free-space wavelength used only to parameterize $\\eta$; the corrector problems are static and do not directly depend on $\\lambda$, but $N(\\eta)$ serves to study numerical convergence as the scale separation increases (smaller $\\eta$). Use grid spacing $h = a/N$.\n\nCompute the discrete correctors $w_x$ and $w_y$ by solving\n$$\n\\nabla \\cdot \\left( \\epsilon(\\mathbf{x}) \\nabla w_j(\\mathbf{x}) \\right) = \\nabla \\cdot \\left( \\epsilon(\\mathbf{x}) \\mathbf{e}_j \\right)\n$$\nwith periodic boundary conditions and gauge fixing. The right-hand side should be discretized as the discrete divergence of the face fluxes corresponding to $\\epsilon(\\mathbf{x}) \\mathbf{e}_j$ (i.e., $\\partial_x \\epsilon$ for $j=x$ or $\\partial_y \\epsilon$ for $j=y$), using the same harmonic face averaging employed for the left-hand side. After solving for $w_j$, compute the local fields and average the displacement to obtain the effective tensor entries.\n\nExpress all permittivities and effective tensor entries in Farads per meter (F/m). The numerical output must be floats.\n\nTest Suite:\nUse the following parameter sets, each specified by $(\\epsilon_1, \\epsilon_2, \\eta)$, with $\\epsilon_1$ and $\\epsilon_2$ in F/m and $\\eta$ dimensionless:\n1. $(2.0, 8.0, 0.5)$\n2. $(2.0, 8.0, 0.25)$\n3. $(2.0, 8.0, 0.125)$\n4. $(5.0, 5.0, 0.25)$\nAdditionally, for $(2.0, 8.0, 0.25)$, compute two scalar diagnostics:\n- The anisotropy measure defined as $|\\bar{\\bar{\\epsilon}}_{\\text{eff}}(1,1) - \\bar{\\bar{\\epsilon}}_{\\text{eff}}(2,2)|$ normalized by the average diagonal $\\frac{1}{2}(\\bar{\\bar{\\epsilon}}_{\\text{eff}}(1,1) + \\bar{\\bar{\\epsilon}}_{\\text{eff}}(2,2))$.\n- The off-diagonal magnitude defined as $\\max\\{|\\bar{\\bar{\\epsilon}}_{\\text{eff}}(1,2)|, |\\bar{\\bar{\\epsilon}}_{\\text{eff}}(2,1)|\\}$ normalized by the same average diagonal.\n\nFor the first three cases, return the scalar isotropic estimate defined as the average of the diagonal entries $\\frac{1}{2}(\\bar{\\bar{\\epsilon}}_{\\text{eff}}(1,1) + \\bar{\\bar{\\epsilon}}_{\\text{eff}}(2,2))$ in F/m. For the fourth case, return the absolute deviation of the isotropic estimate from $\\epsilon_1$ (which equals $\\epsilon_2$) in F/m.\n\nFinal Output Format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets in the following order:\n- The isotropic estimates (in F/m) for cases $1$, $2$, and $3$.\n- The convergence ratio defined as $\\frac{|I_1 - I_2|}{|I_2 - I_3|}$, where $I_k$ is the isotropic estimate for case $k$, dimensionless.\n- The absolute deviation (in F/m) for case $4$.\n- The anisotropy measure (dimensionless) for case $(2.0, 8.0, 0.25)$.\n- The normalized off-diagonal magnitude (dimensionless) for case $(2.0, 8.0, 0.25)$.\n\nFor example, the output should look like:\n$[I_1,I_2,I_3,R,\\Delta,I_{\\text{aniso}},I_{\\text{off}}]$\nwith all entries printed as standard Python floats.", "solution": "The problem requires the computation of the effective permittivity tensor $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$ for a two-dimensional periodic metamaterial with a checkerboard structure. This is a classic problem in homogenization theory, which we will solve numerically using a cell-centered finite-volume method (FVM).\n\n### 1. Theoretical Formulation\n\nThe relationship between the averaged electric displacement field $\\langle \\mathbf{D} \\rangle$ and the averaged electric field $\\langle \\mathbf{E} \\rangle$ in the long-wavelength limit is given by $\\langle \\mathbf{D} \\rangle = \\bar{\\bar{\\epsilon}}_{\\text{eff}} \\langle \\mathbf{E} \\rangle$. The effective permittivity tensor $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$ can be determined by solving a set of so-called \"cell problems\" on the material's unit cell.\n\nFor a macroscopic constant electric field $\\mathbf{E}_0$, the local field is $\\mathbf{E}(\\mathbf{x}) = \\mathbf{E}_0 - \\nabla w(\\mathbf{x})$, where $w(\\mathbf{x})$ is a periodic \"corrector\" potential. The governing equation for the corrector, derived from the charge-free condition $\\nabla \\cdot \\mathbf{D} = 0$, is\n$$\n\\nabla \\cdot \\left( \\epsilon(\\mathbf{x}) (\\mathbf{E}_0 - \\nabla w(\\mathbf{x})) \\right) = 0\n$$\nTo find the components of $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$, we solve this equation for two specific cases: $\\mathbf{E}_0 = \\mathbf{e}_x = (1,0)$ and $\\mathbf{E}_0 = \\mathbf{e}_y = (0,1)$. This gives two corrector potentials, $w_x$ and $w_y$. The corresponding cell problems are:\n$$\n\\nabla \\cdot \\left( \\epsilon(\\mathbf{x}) \\nabla w_j(\\mathbf{x}) \\right) = \\nabla \\cdot \\left( \\epsilon(\\mathbf{x}) \\mathbf{e}_j \\right) \\quad \\text{for } j \\in \\{x, y\\}\n$$\nThese are Poisson-like equations to be solved on the unit cell with periodic boundary conditions. The corrector $w_j$ is unique up to an additive constant, which is fixed by a gauge condition.\n\nOnce $w_j$ is found, the $j$-th column of the effective permittivity tensor is given by the average of the local displacement field $\\mathbf{D}_j(\\mathbf{x}) = \\epsilon(\\mathbf{x})(\\mathbf{e}_j - \\nabla w_j(\\mathbf{x}))$:\n$$\n\\bar{\\bar{\\epsilon}}_{\\text{eff}} \\mathbf{e}_j = \\langle \\mathbf{D}_j \\rangle = \\frac{1}{|\\Omega|} \\int_{\\Omega} \\epsilon(\\mathbf{x}) (\\mathbf{e}_j - \\nabla w_j(\\mathbf{x})) \\, d\\mathbf{x}\n$$\nwhere $\\Omega$ is the unit cell domain, and $|\\Omega|$ is its area.\n\n### 2. Numerical Discretization using Finite-Volume Method\n\nWe discretize the unit cell (of side length $a=1$) into a uniform $N \\times N$ grid of cells, with grid spacing $h=1/N$. The corrector potential $w$ is defined at the center of each cell $(i,j)$, denoted $w_{i,j}$. The permittivity $\\epsilon$ is treated as piecewise constant within each cell, with value $\\epsilon_{i,j}$ determined by the cell's central coordinate.\n\nThe cell problem is integrated over each control volume (cell) $V_{i,j}$ and the divergence theorem is applied, leading to a flux balance equation:\n$$\n\\int_{\\partial V_{i,j}} \\epsilon(\\mathbf{x}) \\nabla w_j \\cdot \\hat{\\mathbf{n}} \\, dS = \\int_{\\partial V_{i,j}} \\epsilon(\\mathbf{x}) \\mathbf{e}_j \\cdot \\hat{\\mathbf{n}} \\, dS\n$$\nThe fluxes are evaluated at the four faces of each cell (East, West, North, South). For the left-hand side (LHS), the flux across the face between cell $(i,j)$ and its eastern neighbor $(i+1, j)$ is approximated as:\n$$\nF_{\\text{LHS, E}} = h \\cdot \\epsilon_{i+1/2, j} \\frac{w_{i+1,j} - w_{i,j}}{h} = \\epsilon_{i+1/2, j} (w_{i+1,j} - w_{i,j})\n$$\nwhere $\\epsilon_{i+1/2, j}$ is the permittivity at the face. To ensure flux continuity across material interfaces, we use the harmonic average as specified:\n$$\n\\epsilon_{i+1/2, j} = \\frac{2 \\epsilon_{i,j} \\epsilon_{i+1,j}}{\\epsilon_{i,j} + \\epsilon_{i+1,j}}\n$$\nSumming the outgoing fluxes for all four faces gives the discrete equation for cell $(i,j)$:\n$$\n\\epsilon_{i+1/2,j}(w_{i,j}-w_{i+1,j}) + \\epsilon_{i-1/2,j}(w_{i,j}-w_{i-1,j}) + \\epsilon_{i,j+1/2}(w_{i,j}-w_{i,j+1}) + \\epsilon_{i,j-1/2}(w_{i,j}-w_{i,j-1}) = \\text{RHS}_{i,j}\n$$\nThe right-hand side (RHS) is the net flux of $\\epsilon \\mathbf{e}_j$. For $j=x$, this involves fluxes only across the East and West faces:\n$$\n\\text{RHS}_{i,j}^{(x)} = (h \\cdot \\epsilon_{i+1/2,j} \\cdot 1) - (h \\cdot \\epsilon_{i-1/2,j} \\cdot 1) = h(\\epsilon_{i+1/2, j} - \\epsilon_{i-1/2, j})\n$$\nSimilarly, for $j=y$, the RHS involves fluxes across the North and South faces:\n$$\n\\text{RHS}_{i,j}^{(y)} = h(\\epsilon_{i, j+1/2} - \\epsilon_{i, j-1/2})\n$$\nPeriodic boundary conditions are imposed by wrapping indices around, e.g., $w_{N,j} = w_{0,j}$, $w_{i,-1} = w_{i,N-1}$.\nThis formulation results in a sparse linear system of equations $A \\mathbf{w} = \\mathbf{b}$ for the $N^2$ unknown corrector values, where $\\mathbf{w}$ is the flattened vector of $w_{i,j}$. Due to the periodic boundary conditions, the matrix $A$ is singular (its null space contains the constant vector). To obtain a unique solution, we fix the gauge by setting the potential at one node to zero, e.g., $w_{0,0}=0$. This is implemented by modifying the first row and right-hand side of the linear system to enforce this constraint, rendering the system non-singular.\n\n### 3. Computation of Effective Permittivity\n\nAfter solving the linear systems for the corrector potentials $w_x$ and $w_y$, we compute\nthe components of $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$. This requires averaging the local displacement field $\\mathbf{D}_j = \\epsilon(\\mathbf{e}_j-\\nabla w_j)$ over all cells. The gradient $\\nabla w_j$ at the center of cell $(i,j)$ is approximated using central differences with periodic indexing:\n$$\n(\\nabla w_j)_{i,j} \\approx \\left( \\frac{w_j(i+1,j) - w_j(i-1,j)}{2h}, \\frac{w_j(i,j+1) - w_j(i,j-1)}{2h} \\right)\n$$\nThe components of the effective tensor are then computed by averaging over all $N^2$ cells:\n$$\n\\epsilon_{xx} = \\langle D_{x,x} \\rangle = \\frac{1}{N^2} \\sum_{i,j} \\epsilon_{i,j} \\left(1 - (\\partial_x w_x)_{i,j}\\right)\n$$\n$$\n\\epsilon_{yx} = \\langle D_{x,y} \\rangle = \\frac{1}{N^2} \\sum_{i,j} \\epsilon_{i,j} \\left(- (\\partial_y w_x)_{i,j}\\right)\n$$\n$$\n\\epsilon_{xy} = \\langle D_{y,x} \\rangle = \\frac{1}{N^2} \\sum_{i,j} \\epsilon_{i,j} \\left(- (\\partial_x w_y)_{i,j}\\right)\n$$\n$$\n\\epsilon_{yy} = \\langle D_{y,y} \\rangle = \\frac{1}{N^2} \\sum_{i,j} \\epsilon_{i,j} \\left(1 - (\\partial_y w_y)_{i,j}\\right)\n$$\n\n### 4. Implementation Steps\n\nThe provided test cases are solved by a single script that:\n1.  For each test case $(\\epsilon_1, \\epsilon_2, \\eta)$, calculates the required grid size $N = \\lceil N_0 / \\eta \\rceil$ with $N_0 = 12$.\n2.  Constructs the permittivity grid $\\epsilon_{i,j}$ corresponding to the checkerboard pattern.\n3.  For each corrector ($w_x, w_y$), assembles the sparse matrix $A$ and right-hand side vector $\\mathbf{b}$.\n4.  Modifies the system to enforce the gauge condition $w_{0,0}=0$ and solves for the corrector potential using a sparse linear solver.\n5.  Calculates the components of $\\bar{\\bar{\\epsilon}}_{\\text{eff}}$ by numerically differentiating the correctors and averaging the resulting displacement fields.\n6.  Computes the final required output quantities (isotropic estimates, convergence ratio, deviation, and diagnostic measures) from the effective permittivity tensors of the four test cases.\nThis procedure is systematically applied to generate the final output vector. For the homogeneous case ($\\epsilon_1=\\epsilon_2$), the corrector should be zero and the effective permittivity tensor should be diagonal with entries equal to the constant permittivity, providing a valuable validation of the numerical method. The numerical result will show a small deviation from this analytical solution, representing the discretization and floating-point error of the simulation.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.sparse import lil_matrix\nfrom scipy.sparse.linalg import spsolve\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test cases and print the results.\n    \"\"\"\n    \n    def compute_eff_eps(eps1, eps2, N):\n        \"\"\"\n        Computes the effective permittivity tensor for a checkerboard metamaterial.\n\n        Args:\n            eps1 (float): Permittivity of first material.\n            eps2 (float): Permittivity of second material.\n            N (int): Number of grid points along one dimension.\n\n        Returns:\n            numpy.ndarray: The 2x2 effective permittivity tensor.\n        \"\"\"\n        a = 1.0\n        h = a / N\n\n        # 1. Setup Grid and Permittivity\n        eps_grid = np.zeros((N, N))\n        for i in range(N):\n            for j in range(N):\n                is_ll = (i  N / 2) and (j  N / 2)  # Lower-left\n                is_ur = (i = N / 2) and (j = N / 2) # Upper-right\n                if is_ll or is_ur:\n                    eps_grid[i, j] = eps1\n                else:\n                    eps_grid[i, j] = eps2\n\n        # 2. Solve for correctors w_x and w_y\n        correctors = {}\n        for dim_idx, j_dim in enumerate(['x', 'y']):\n            # 3. Build linear system A*w = b\n            A = lil_matrix((N * N, N * N), dtype=np.float64)\n            b = np.zeros(N * N, dtype=np.float64)\n\n            for i in range(N):\n                for j in range(N):\n                    k = i * N + j\n\n                    # Get periodic neighbor indices\n                    ip1, im1 = (i + 1) % N, (i - 1 + N) % N\n                    jp1, jm1 = (j + 1) % N, (j - 1 + N) % N\n\n                    # Harmonic mean for face permittivities\n                    eps_E = 2 * eps_grid[i, j] * eps_grid[ip1, j] / (eps_grid[i, j] + eps_grid[ip1, j])\n                    eps_W = 2 * eps_grid[i, j] * eps_grid[im1, j] / (eps_grid[i, j] + eps_grid[im1, j])\n                    eps_N = 2 * eps_grid[i, j] * eps_grid[i, jp1] / (eps_grid[i, j] + eps_grid[i, jp1])\n                    eps_S = 2 * eps_grid[i, j] * eps_grid[i, jm1] / (eps_grid[i, j] + eps_grid[i, jm1])\n\n                    # Assemble stiffness matrix A (5-point stencil)\n                    # The equation for node k is sum_faces(eps_face * (w_k - w_neighbor)) = RHS\n                    A[k, k] = eps_E + eps_W + eps_N + eps_S\n                    A[k, ip1 * N + j] -= eps_E\n                    A[k, im1 * N + j] -= eps_W\n                    A[k, i * N + jp1] -= eps_N\n                    A[k, i * N + jm1] -= eps_S\n                    \n                    # Assemble RHS vector b = h * div(eps * e_j)\n                    if j_dim == 'x':\n                        b[k] = h * (eps_E - eps_W)\n                    else:  # j_dim == 'y'\n                        b[k] = h * (eps_N - eps_S)\n\n            # 4. Apply gauge condition (fix w[0,0] = 0)\n            k_fix = 0\n            A_csr = A.tocsr() # Convert for efficient row slicing\n            A_csr[k_fix, :] = 0.0\n            A_csr[k_fix, k_fix] = 1.0\n            b[k_fix] = 0.0\n            \n            # 5. Solve for w\n            w_flat = spsolve(A_csr.tocsc(), b) # CSC is good for spsolve\n            correctors[j_dim] = w_flat.reshape((N, N))\n\n        w_x, w_y = correctors['x'], correctors['y']\n\n        # 6. Compute effective permittivity tensor\n        grad_wx_x, grad_wx_y = np.zeros_like(w_x), np.zeros_like(w_x)\n        grad_wy_x, grad_wy_y = np.zeros_like(w_y), np.zeros_like(w_y)\n\n        # Central difference for gradients with periodic BCs\n        for i in range(N):\n            for j in range(N):\n                ip1, im1 = (i + 1) % N, (i - 1 + N) % N\n                jp1, jm1 = (j + 1) % N, (j - 1 + N) % N\n                grad_wx_x[i, j] = (w_x[ip1, j] - w_x[im1, j]) / (2 * h)\n                grad_wx_y[i, j] = (w_x[i, jp1] - w_x[i, jm1]) / (2 * h)\n                grad_wy_x[i, j] = (w_y[ip1, j] - w_y[im1, j]) / (2 * h)\n                grad_wy_y[i, j] = (w_y[i, jp1] - w_y[i, jm1]) / (2 * h)\n\n        # Local E fields\n        Ex_x, Ex_y = 1 - grad_wx_x, -grad_wx_y\n        Ey_x, Ey_y = -grad_wy_x, 1 - grad_wy_y\n\n        # Average D fields\n        eps_xx = np.mean(eps_grid * Ex_x)\n        eps_yx = np.mean(eps_grid * Ex_y)\n        eps_xy = np.mean(eps_grid * Ey_x)\n        eps_yy = np.mean(eps_grid * Ey_y)\n        \n        return np.array([[eps_xx, eps_xy], [eps_yx, eps_yy]])\n\n    N0 = 12.0\n    test_cases_params = [\n        (2.0, 8.0, 0.5),\n        (2.0, 8.0, 0.25),\n        (2.0, 8.0, 0.125),\n        (5.0, 5.0, 0.25)\n    ]\n    \n    # Calculate grid sizes\n    Ns = [int(np.ceil(N0 / eta)) for _, _, eta in test_cases_params]\n\n    # Run simulations\n    eps_eff_1 = compute_eff_eps(test_cases_params[0][0], test_cases_params[0][1], Ns[0])\n    eps_eff_2 = compute_eff_eps(test_cases_params[1][0], test_cases_params[1][1], Ns[1])\n    eps_eff_3 = compute_eff_eps(test_cases_params[2][0], test_cases_params[2][1], Ns[2])\n    eps_eff_4 = compute_eff_eps(test_cases_params[3][0], test_cases_params[3][1], Ns[3])\n\n    # Compute required outputs\n    I1 = 0.5 * (eps_eff_1[0, 0] + eps_eff_1[1, 1])\n    I2 = 0.5 * (eps_eff_2[0, 0] + eps_eff_2[1, 1])\n    I3 = 0.5 * (eps_eff_3[0, 0] + eps_eff_3[1, 1])\n    \n    # Convergence ratio\n    # Add a small epsilon to denominator to avoid division by zero if convergence is perfect\n    R = abs(I1 - I2) / (abs(I2 - I3) + 1e-18)\n    \n    # Absolute deviation for homogeneous case\n    I4_iso = 0.5 * (eps_eff_4[0, 0] + eps_eff_4[1, 1])\n    Delta = abs(I4_iso - test_cases_params[3][0])\n    \n    # Diagnostics for case 2\n    avg_diag_2 = I2\n    Aniso = abs(eps_eff_2[0, 0] - eps_eff_2[1, 1]) / avg_diag_2\n    OffDiag = max(abs(eps_eff_2[0, 1]), abs(eps_eff_2[1, 0])) / avg_diag_2\n    \n    results = [I1, I2, I3, R, Delta, Aniso, OffDiag]\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3314289"}, {"introduction": "While static calculations provide fundamental insight, we often characterize metamaterials through their dynamic response to electromagnetic waves. This exercise bridges the gap between abstract theory and practical application by tasking you with retrieving an effective refractive index, $n_{\\mathrm{eff}}$, from simulated scattering parameters ($S$-parameters) of a metamaterial slab. This process, analogous to an experimental characterization, demonstrates how macroscopic observables can not only determine effective properties but also reveal deeper phenomena like anisotropy or spatial dispersion through their dependence on incidence angle [@problem_id:3314219].", "problem": "You are given a metamaterial slab of thickness $d=5a$ under plane-wave oblique incidence in vacuum, with the lattice constant $a$ and thickness $d$ specified as physical lengths. The objective is to retrieve the scalar effective refractive index $n_{\\mathrm{eff}}(\\theta)$ as a function of incidence angle $\\theta$ from complex scattering parameters (Scattering parameters (S-parameters)) $S_{11}(\\theta)$ and $S_{21}(\\theta)$, and to use the variation of the real part of $n_{\\mathrm{eff}}(\\theta)$ across angles to assess isotropy and spatial dispersion. Your derivation and algorithm must start from the macroscopic Maxwell equations, the definition of plane-wave propagation in homogeneous media, and the continuity of tangential electromagnetic fields at interfaces, and use these principles to establish a retrieval method for the longitudinal wave number inside the slab. No shortcut formulas are to be assumed; the retrieval must follow from first principles and well-tested definitions.\n\nFundamental base:\n- Start from the source-free macroscopic Maxwell equations in the frequency domain with time-harmonic fields $e^{-i\\omega t}$: $\\nabla \\times \\mathbf{E} = i\\omega \\mathbf{B}$ and $\\nabla \\times \\mathbf{H} = - i\\omega \\mathbf{D}$, with constitutive relations $\\mathbf{D} = \\underline{\\underline{\\varepsilon}} \\mathbf{E}$ and $\\mathbf{B} = \\mu \\mathbf{H}$.\n- For vacuum, use $\\varepsilon_0$ and $\\mu_0$ and the speed of light $c$, with $k_0 = \\omega/c$.\n- Define a plane wave in vacuum incident at angle $\\theta$ to the slab normal (taken as $\\hat{z}$): the conserved tangential wave number is $k_x = k_0 \\sin\\theta$, the vacuum longitudinal component is $k_{z0} = k_0 \\cos\\theta$.\n- For a homogeneous slab, define the longitudinal wave number inside the material as $k_z$, and the appropriate polarization-dependent wave impedance $Z$ or admittance based on the ratio of tangential fields. Consider transverse-magnetic (TM) polarization, where the tangential electric and magnetic fields satisfy $Z = E_t/H_t$.\n- Use the transfer (ABCD) matrix of a homogeneous slab of thickness $d$ and wave impedance $Z$ to relate the fields at the input and output interfaces. Combine it with equal port impedances $Z_0$ for vacuum to express $S_{11}$ and $S_{21}$ in terms of the slab parameters. From those relations, retrieve $k_z d$ via a principled inversion and then map to $n_{\\mathrm{eff}}(\\theta)$ by enforcing the isotropic dispersion ansatz $k_z^2 + k_x^2 = n_{\\mathrm{eff}}^2 k_0^2$.\n\nAssessment of anisotropy and spatial dispersion:\n- For an isotropic, local medium with scalar $\\varepsilon$ and $\\mu$, the retrieved $n_{\\mathrm{eff}}(\\theta)$ should be independent of $\\theta$. A variation with $\\theta$ indicates breakdown of a scalar, local description and can arise from anisotropy (tensorial $\\underline{\\underline{\\varepsilon}}$) or nonlocality (spatial dispersion where $\\varepsilon$ depends on wave vector).\n- Quantify this by computing the standard deviation of $\\Re\\{n_{\\mathrm{eff}}(\\theta)\\}$ over several angles; small values indicate angle invariance consistent with an isotropic local medium, while larger values indicate anisotropy or nonlocality.\n\nPhysical and numerical units and conventions:\n- Use $a$ and $d$ in meters. The frequency $f$ must be in Hertz. Angles $\\theta$ must be provided in degrees and interpreted in radians internally. All retrieved $n_{\\mathrm{eff}}(\\theta)$ are dimensionless.\n- The final metric must be computed using the real part of the retrieved $n_{\\mathrm{eff}}(\\theta)$.\n\nTest suite and parameters:\n- Use $a = 1\\times 10^{-3}$ meters, $d = 5 a$ meters, and $f = 1\\times 10^{10}$ Hertz. Use vacuum surrounding the slab.\n- Evaluate at the set of incidence angles $\\{\\theta\\} = \\{0, 30, 60\\}$ in degrees.\n- Consider three metamaterial models under TM polarization:\n  1. Isotropic local model: scalar relative permittivity $\\varepsilon_r = 2.25$ and scalar relative permeability $\\mu_r = 1.0$.\n  2. Uniaxial anisotropic local model with optic axis normal to the slab ($\\hat{z}$): transverse relative permittivity $\\varepsilon_t = 2.25$, normal relative permittivity $\\varepsilon_z = 4.0$, and scalar relative permeability $\\mu_r = 1.0$.\n  3. Isotropic spatially dispersive model: scalar relative permeability $\\mu_r = 1.0$ and scalar relative permittivity $\\varepsilon_r(k_x) = \\varepsilon_{r0} + \\alpha (k_x/k_0)^2$ with $\\varepsilon_{r0} = 2.25$ and $\\alpha = 0.3$.\n\nYour program must:\n- Generate the complex $S_{11}(\\theta)$ and $S_{21}(\\theta)$ for each model and angle using the transfer-matrix formulation based on boundary conditions and mode impedances appropriate to TM polarization.\n- Retrieve $k_z d$ from the generated $S$-parameters by inverting the transfer relations without shortcut assumptions and select the physically continuous branch across angles.\n- Compute $n_{\\mathrm{eff}}(\\theta)$ for each model from $k_z$ using $n_{\\mathrm{eff}}(\\theta) = \\sqrt{(k_z/k_0)^2 + \\sin^2\\theta}$, and take its real part.\n- For each model, compute the standard deviation of $\\Re\\{n_{\\mathrm{eff}}(\\theta)\\}$ over the three angles as a single dimensionless float.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of the models listed above, for example $[\\text{iso},\\text{uniaxial},\\text{nonlocal}]$, where each entry is the standard deviation computed as specified. The floats must be dimensionless.\n\nNo user input is required; the program must run as is and use the specified parameters and test suite internally.", "solution": "The user has provided a well-posed problem in computational electromagnetics concerning the retrieval of an effective refractive index for a metamaterial slab from its scattering parameters ($S$-parameters). The problem is scientifically grounded, free of contradictions, and contains all necessary information to proceed with a unique solution. The validation is passed.\n\nThe core of the problem is to first establish a forward model relating the material properties of a slab to its $S$-parameters ($S_{11}, S_{21}$) under transverse-magnetic (TM) plane-wave incidence, and then to derive and implement a robust inversion of this model to retrieve an effective refractive index $n_{\\mathrm{eff}}(\\theta)$ from the $S$-parameters.\n\nThe derivation and solution will proceed in three main steps:\n1.  **Forward Model**: Derivation of $S_{11}(\\theta)$ and $S_{21}(\\theta)$ from the slab's properties using the transfer matrix method, which is based on Maxwell's equations and boundary conditions.\n2.  **Inverse Model**: Derivation of a method to retrieve the longitudinal wavenumber $k_z$ and, subseqently, the effective refractive index $n_{\\mathrm{eff}}$ from the computed $S$-parameters. This must be done from first principles as requested.\n3.  **Numerical Implementation**: Application of the derived forward and inverse models to the three specified metamaterial cases to compute the standard deviation of $\\Re\\{n_{\\mathrm{eff}}(\\theta)\\}$, which serves as a metric for anisotropy and spatial dispersion.\n\nThroughout this derivation, all mathematical entities are rendered in LaTeX as required. The time-harmonic convention is $e^{-i\\omega t}$. The slab is positioned in the region $0 \\le z \\le d$.\n\n**1. Forward Model: From Material Properties to S-Parameters**\n\nFor a TM (p-polarized) plane wave, the magnetic field is oriented along the $y$-axis, $\\mathbf{H} = H_y(x,z) \\hat{y}$, and the electric field lies in the $x-z$ plane. The fields have a spatial dependence of $e^{i k_x x}$, where the tangential wavenumber $k_x = k_0 \\sin\\theta$ is conserved across all interfaces. Here, $k_0 = \\omega/c = 2\\pi f/c$ is the free-space wavenumber and $\\theta$ is the angle of incidence with respect to the normal ($\\hat{z}$-axis).\n\nThe relationship between the tangential electric field $E_x$ and tangential magnetic field $H_y$ for a forward-propagating TM wave defines the characteristic wave impedance, $Z_{\\text{TM}} = E_x / H_y$.\n\n**A. Wave Propagation and Impedance in Each Medium**\n\n*   **Vacuum (Regions $z0$ and $zd$)**: The dispersion relation is $k_x^2 + k_{z0}^2 = k_0^2$. The longitudinal wavenumber is $k_{z0} = \\sqrt{k_0^2 - k_x^2} = k_0 \\cos\\theta$. The TM wave impedance in vacuum is $Z_{c0}^{\\text{TM}} = \\frac{k_{z0}}{\\omega\\varepsilon_0} = \\frac{k_0 \\cos\\theta}{\\omega\\varepsilon_0} = Z_0 \\cos\\theta$, where $Z_0 = \\sqrt{\\mu_0/\\varepsilon_0}$ is the impedance of free space.\n\n*   **Slab Material (Region $0 \\le z \\le d$)**: The properties depend on the model.\n    1.  **Isotropic Local Model**: With scalar $\\varepsilon = \\varepsilon_r \\varepsilon_0$ and $\\mu = \\mu_r \\mu_0$, the dispersion relation is $k_x^2 + k_z^2 = k_0^2 \\varepsilon_r \\mu_r$. The longitudinal wavenumber is $k_z = \\sqrt{k_0^2 \\varepsilon_r \\mu_r - k_x^2} = k_0\\sqrt{\\varepsilon_r \\mu_r - \\sin^2\\theta}$. The TM impedance is $Z_c^{\\text{TM}} = \\frac{k_z}{\\omega\\varepsilon} = \\frac{k_z}{\\omega\\varepsilon_r\\varepsilon_0}$.\n    2.  **Uniaxial Anisotropic Model**: With $\\underline{\\underline{\\varepsilon}} = \\varepsilon_0 \\mathrm{diag}(\\varepsilon_t, \\varepsilon_t, \\varepsilon_z)$ and scalar $\\mu=\\mu_r\\mu_0$, the dispersion relation for TM modes is $\\frac{k_x^2}{\\varepsilon_z} + \\frac{k_z^2}{\\varepsilon_t} = k_0^2 \\mu_r$. The longitudinal wavenumber is $k_z = k_0\\sqrt{\\varepsilon_t(\\mu_r - \\sin^2\\theta/\\varepsilon_z)}$. The TM impedance is $Z_c^{\\text{TM}} = \\frac{k_z}{\\omega\\varepsilon_t\\varepsilon_0}$.\n    3.  **Isotropic Spatially Dispersive Model**: With $\\varepsilon(k_x) = \\varepsilon_0(\\varepsilon_{r0} + \\alpha(k_x/k_0)^2)$ and $\\mu=\\mu_r\\mu_0$, the dispersion relation is $k_x^2 + k_z^2 = k_0^2 \\mu_r \\varepsilon_r(k_x)$. For $\\mu_r=1$, this gives $k_z = k_0\\sqrt{\\varepsilon_{r0} + (\\alpha-1)\\sin^2\\theta}$. The TM impedance is $Z_c^{\\text{TM}} = \\frac{k_z}{\\omega\\varepsilon(k_x)} = \\frac{k_z}{\\omega\\varepsilon_0\\varepsilon_r(k_x)}$.\n\n**B. Transfer Matrix and S-Parameters**\n\nThe fields at the input ($z=0$) and output ($z=d$) of the slab are related by a transfer (ABCD) matrix. For a uniform slab of thickness $d$, propagation constant $k_z$, and characteristic impedance $Z_c^{\\text{TM}}$, this matrix is:\n$$\n\\begin{pmatrix} A  B \\\\ C  D \\end{pmatrix} = \\begin{pmatrix} \\cos(k_z d)  i Z_c^{\\text{TM}} \\sin(k_z d) \\\\ i (Z_c^{\\text{TM}})^{-1} \\sin(k_z d)  \\cos(k_z d) \\end{pmatrix}\n$$\nThe S-parameters for this two-port network, with identical port impedances $Z_{c0}^{\\text{TM}}$, are derived from the ABCD matrix:\n$$\nS_{11} = \\frac{A + B/Z_{c0}^{\\text{TM}} - C Z_{c0}^{\\text{TM}} - D}{A + B/Z_{c0}^{\\text{TM}} + C Z_{c0}^{\\text{TM}} + D} \\quad , \\quad S_{21} = \\frac{2}{A + B/Z_{c0}^{\\text{TM}} + C Z_{c0}^{\\text{TM}} + D}\n$$\nSubstituting the matrix elements and defining the normalized impedance $z = Z_c^{\\text{TM}} / Z_{c0}^{\\text{TM}}$, we arrive at:\n$$\nS_{11} = \\frac{i(z^2 - 1) \\sin(k_z d)}{2z\\cos(k_z d) + i(z^2+1)\\sin(k_z d)} = \\frac{\\frac{i}{2}(z - 1/z) \\sin(k_z d)}{\\cos(k_z d) + \\frac{i}{2}(z+1/z)\\sin(k_z d)}\n$$\n$$\nS_{21} = \\frac{2z}{2z\\cos(k_z d) + i(z^2+1)\\sin(k_z d)} = \\frac{1}{\\cos(k_z d) + \\frac{i}{2}(z+1/z)\\sin(k_z d)}\n$$\nThese equations form the forward model used to generate synthetic $S$-parameter data for the given material models.\n\n**2. Inverse Model: From S-Parameters to Material Properties**\n\nThe problem requires a principled inversion of the above system to find $k_z$ and $z$ from $S_{11}$ and $S_{21}$. Let us manipulate the expressions for the S-parameters. From the forward model equations, we can isolate two key relationships:\n$$\n\\frac{1}{S_{21}} = \\cos(k_z d) + \\frac{i}{2}(z+1/z)\\sin(k_z d)\n$$\n$$\n\\frac{S_{11}}{S_{21}} = \\frac{i}{2}(z-1/z)\\sin(k_z d)\n$$\nBy adding and subtracting these two equations, we can express $e^{ik_z d}$ and $e^{-ik_z d}$ in terms of $S_{11}$, $S_{21}$, and $z$.\nLet $r = (z-1)/(z+1)$ be the reflection coefficient at the first interface. Then $z=(1+r)/(1-r)$, $z-1/z = 2(r+1/r)/( (1-r)^2/((1+r)(1-r)) ) ...$ the algebra is not clean.\nA more robust algebraic path is to find relationships for $r$ and $e^{-ik_z d}$ separately. By multiplying the expressions for $e^{ik_z d}$ and $e^{-ik_z d}$ derived from the S-parameters, one can show:\n$$\n(1 - S_{11} r)(1 - S_{11}/r) = S_{21}^2\n$$\nwhere $r = (z-1)/(z+1)$ is the interface reflection coefficient. Expanding this gives a quadratic equation for $r + 1/r$:\n$$\n1 - S_{11}(r+1/r) + S_{11}^2 = S_{21}^2 \\implies r + 1/r = \\frac{1 + S_{11}^2 - S_{21}^2}{S_{11}}\n$$\nLet $K = \\frac{1 + S_{11}^2 - S_{21}^2}{2S_{11}}$. The equation becomes $r^2 - 2Kr + 1 = 0$, with solutions $r = K \\pm \\sqrt{K^2-1}$. For a passive material, the reflection coefficient must satisfy $|r| \\le 1$. This condition is used to select the correct physical root.\n\nOnce $r$ is determined, the normalized impedance is found via $z = (1+r)/(1-r)$. A passive medium requires $\\Re\\{z\\} \\ge 0$.\n\nNext, we establish a relation for the propagation factor $e^{-ik_z d}$. This can be shown to be:\n$$\ne^{-ik_z d} = \\frac{1 - S_{11} r}{S_{21}}\n$$\nFrom this, the complex product $k_z d$ is retrieved using the complex logarithm:\n$$\nk_z d = i \\log\\left(\\frac{1 - S_{11} r}{S_{21}}\\right)\n$$\nThe complex logarithm is multi-valued: $\\log(w) = \\ln|w| + i(\\arg(w) + 2\\pi m)$, where $m$ is an integer. This leads to an ambiguity in the real part of $k_z d$.\n$$\nk_z d = -(\\arg(w) + 2\\pi m) + i \\ln|w|\n$$\nwhere $w = (1-S_{11}r)/S_{21}$. For a passive medium, waves must decay, implying $\\Im\\{k_z\\} \\ge 0$ (with $e^{i k_z z}$ convention). This requires $\\Im\\{k_z d\\} = \\ln|w| \\ge 0$, or $|w| \\ge 1$. This provides another constraint on the choice of $r$. The ambiguity in the real part is resolved by starting with $m=0$ for the first incidence angle ($\\theta=0^{\\circ}$) and then choosing $m$ for subsequent angles to ensure that $\\Re\\{k_z(\\theta)\\}$ is a continuous function.\n\n**3. Retrieval of Effective Refractive Index**\n\nThe retrieved $k_z$ is related to the effective refractive index $n_{\\mathrm{eff}}$ through the isotropic dispersion relation ansatz, which defines $n_{\\mathrm{eff}}$:\n$$\nk_x^2 + k_z^2 = (n_{\\mathrm{eff}} k_0)^2\n$$\nSubstituting $k_x = k_0 \\sin\\theta$ and solving for $n_{\\mathrm{eff}}$ gives:\n$$\nn_{\\mathrm{eff}}(\\theta) = \\sqrt{\\left(\\frac{k_z}{k_0}\\right)^2 + \\sin^2\\theta}\n$$\nThe principal root ($\\Re\\{n_{\\mathrm{eff}}\\} \\ge 0$) is chosen.\n\nFor a truly isotropic and local medium, the retrieved $n_{\\mathrm{eff}}(\\theta)$ will be a constant, equal to the material's true refractive index. For the anisotropic and spatially dispersive models, $n_{\\mathrm{eff}}(\\theta)$ will vary with the angle of incidence $\\theta$. The standard deviation of $\\Re\\{n_{\\mathrm{eff}}(\\theta)\\}$ over the specified angles serves as a quantitative measure of this angular dependence.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.constants import c as C0, mu_0, epsilon_0\n\ndef solve():\n    \"\"\"\n    Main function to perform the metamaterial analysis.\n    It calculates S-parameters for three different slab models, retrieves\n    the effective refractive index n_eff(theta), and computes the standard\n    deviation of Re(n_eff) across incidence angles as a measure of\n    anisotropy or spatial dispersion.\n    \"\"\"\n\n    # --- Problem Parameters ---\n    a = 1e-3  # meters\n    d = 5 * a  # meters\n    f = 1e10  # Hertz\n    angles_deg = [0, 30, 60]\n\n    # --- Physical Constants and Derived Parameters ---\n    Z0 = np.sqrt(mu_0 / epsilon_0)  # Impedance of free space\n    omega = 2 * np.pi * f\n    k0 = omega / C0\n\n    # --- Test Case Models ---\n    models = [\n        {\n            \"name\": \"Isotropic\",\n            \"type\": \"isotropic\",\n            \"params\": {\"eps_r\": 2.25, \"mu_r\": 1.0}\n        },\n        {\n            \"name\": \"Uniaxial\",\n            \"type\": \"uniaxial\",\n            \"params\": {\"eps_t\": 2.25, \"eps_z\": 4.0, \"mu_r\": 1.0}\n        },\n        {\n            \"name\": \"Spatially Dispersive\",\n            \"type\": \"spatially_dispersive\",\n            \"params\": {\"eps_r0\": 2.25, \"alpha\": 0.3, \"mu_r\": 1.0}\n        }\n    ]\n\n    final_results = []\n\n    for model in models:\n        n_eff_real_parts = []\n        prev_k_z_d_real = None\n\n        for theta_deg in angles_deg:\n            theta_rad = np.deg2rad(theta_deg)\n            kx = k0 * np.sin(theta_rad)\n\n            # --- 1. Forward Model: Calculate S-parameters ---\n            \n            # Impedance of vacuum for TM waves at angle theta\n            k_z0 = k0 * np.cos(theta_rad)\n            Zc0_tm = Z0 * np.cos(theta_rad) if np.cos(theta_rad)  1e-9 else Z0\n\n            # Calculate slab properties based on model\n            if model[\"type\"] == \"isotropic\":\n                eps_r = model[\"params\"][\"eps_r\"]\n                mu_r = model[\"params\"][\"mu_r\"]\n                n_sq = eps_r * mu_r\n                k_z_sq = k0**2 * n_sq - kx**2\n                k_z = np.sqrt(k_z_sq)\n                Zc_tm = k_z / (omega * eps_r * epsilon_0)\n                \n            elif model[\"type\"] == \"uniaxial\":\n                eps_t = model[\"params\"][\"eps_t\"]\n                eps_z = model[\"params\"][\"eps_z\"]\n                mu_r = model[\"params\"][\"mu_r\"]\n                k_z_sq = eps_t * (k0**2 * mu_r - kx**2 / eps_z)\n                k_z = np.sqrt(k_z_sq)\n                Zc_tm = k_z / (omega * eps_t * epsilon_0)\n\n            elif model[\"type\"] == \"spatially_dispersive\":\n                eps_r0 = model[\"params\"][\"eps_r0\"]\n                alpha = model[\"params\"][\"alpha\"]\n                mu_r = model[\"params\"][\"mu_r\"]\n                eps_r_kx = eps_r0 + alpha * (kx / k0)**2\n                k_z_sq = k0**2 * mu_r * eps_r_kx - kx**2\n                k_z = np.sqrt(k_z_sq)\n                Zc_tm = k_z / (omega * eps_r_kx * epsilon_0)\n\n            # Normalized impedance\n            z_norm = Zc_tm / Zc0_tm\n\n            # Calculate S-parameters from ABCD matrix relations\n            cos_kzd = np.cos(k_z * d)\n            sin_kzd = np.sin(k_z * d)\n            denominator = 2 * cos_kzd + 1j * (z_norm + 1/z_norm) * sin_kzd\n            S11 = 1j * (z_norm - 1/z_norm) * sin_kzd / denominator\n            S21 = 2 / denominator\n            \n            # --- 2. Inverse Model: Retrieve k_z and n_eff ---\n\n            # Suppress division by zero warnings for S11=0 at normal incidence\n            with np.errstate(divide='ignore', invalid='ignore'):\n                 K = (1 + S11**2 - S21**2) / (2 * S11)\n            \n            if np.abs(S11)  1e-9: # Handle normal incidence case where S11 might be 0\n                # When S11=0, r=0, z=1. k_z d from S21\n                # 1/S21 = cos(kzd), so kzd = arccos(1/S21)\n                k_z_d_retrieved = np.arccos(1/S21)\n            else:\n                # Solve r^2 - 2Kr + 1 = 0\n                sqrt_discriminant = np.sqrt(K**2 - 1, dtype=np.complex128)\n                r1 = K + sqrt_discriminant\n                r2 = K - sqrt_discriminant\n                \n                # Select physical root |r| = 1\n                r = r1 if abs(r1) = abs(r2) else r2\n                \n                # Retrieve propagation factor T = exp(-ik_z d)\n                T_exp = (1 - S11 * r) / S21\n                \n                # Retrieve k_z * d from complex log, resolving 2*pi ambiguity\n                k_z_d_retrieved = 1j * np.log(T_exp)\n                \n            # Phase unwrapping for continuity across angles\n            if prev_k_z_d_real is not None:\n                diff = k_z_d_retrieved.real - prev_k_z_d_real\n                m = np.round(diff / (2 * np.pi))\n                k_z_d_retrieved -= 2 * np.pi * m\n            prev_k_z_d_real = k_z_d_retrieved.real\n            \n            k_z_retrieved = k_z_d_retrieved / d\n            \n            # --- 3. Calculate Effective Refractive Index ---\n            n_eff_sq = (k_z_retrieved / k0)**2 + np.sin(theta_rad)**2\n            n_eff = np.sqrt(n_eff_sq)\n            \n            # Ensure Re(n_eff) = 0\n            if n_eff.real  0:\n                n_eff = -n_eff\n            \n            n_eff_real_parts.append(n_eff.real)\n\n        # Compute standard deviation for the model\n        std_dev = np.std(n_eff_real_parts)\n        final_results.append(std_dev)\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, final_results))}]\")\n\nsolve()\n```", "id": "3314219"}, {"introduction": "Simple effective medium theories break down when the wavelength of light becomes comparable to the metamaterial's structural features, necessitating models that account for spatial dispersion—the dependence of material parameters on the wavevector $\\mathbf{k}$. This advanced practice introduces a powerful first-principles technique to build such a model by computing the material's full band structure using the plane-wave expansion method. By fitting the resulting dispersion curve, $\\omega(\\mathbf{k})$, to a nonlocal effective permittivity model, $\\epsilon_{\\mathrm{eff}}(\\omega, \\mathbf{k})$, you will learn how to construct accurate, predictive models for metamaterials operating beyond the quasi-static regime [@problem_id:3314241].", "problem": "You are to design a Bloch–Floquet eigenproblem for a three-dimensional periodic metamaterial and use it to extract nonlocal constitutive relations from computed band structures. Start from the following fundamental bases: Maxwell’s equations in the frequency domain, the constitutive relation between the electric displacement field and the electric field in a spatially dispersive medium, and Bloch’s theorem for fields in periodic media. You must derive and implement a plane-wave-expansion eigenproblem that computes the band structure for a set of wavevectors, and then fit a wavevector-dependent effective permittivity model to those bands to represent spatial dispersion.\n\nFundamental bases to use:\n- Maxwell’s equations in the frequency domain,\n$$\n\\nabla \\times \\mathbf{E} = i \\omega \\mu \\mathbf{H}, \\quad \\nabla \\times \\mathbf{H} = -i \\omega \\mathbf{D},\n$$\nwith the constitutive relation for a nonlocal medium,\n$$\n\\mathbf{D}(\\mathbf{r}) = \\int \\overline{\\overline{\\epsilon}}(\\mathbf{r} - \\mathbf{r}', \\omega) \\mathbf{E}(\\mathbf{r}') \\, d\\mathbf{r}',\n$$\nand Bloch’s theorem,\n$$\n\\mathbf{H}(\\mathbf{r}) = e^{i \\mathbf{k} \\cdot \\mathbf{r}} \\sum_{\\mathbf{G}} \\mathbf{H}_{\\mathbf{G}} e^{i \\mathbf{G} \\cdot \\mathbf{r}},\n$$\nwhere $\\mathbf{k}$ is the Bloch wavevector and $\\mathbf{G}$ are reciprocal lattice vectors.\n- Work in nondimensionalized units by setting $c=1$, $\\mu=1$, and the lattice constant $a=1$; all quantities are dimensionless.\n\nTask:\n1. Formulate the Bloch–Floquet plane-wave-expansion eigenproblem for the magnetic field using a truncated set of reciprocal lattice vectors. Consider an isotropic metamaterial whose inverse permittivity is periodic and given by\n$$\n\\epsilon^{-1}(\\mathbf{r}) = \\frac{1}{\\epsilon_{\\text{avg}}} + \\delta_x \\cos(2\\pi x) + \\delta_y \\cos(2\\pi y) + \\delta_z \\cos(2\\pi z).\n$$\nUse the truncated set of reciprocal lattice vectors\n$$\n\\mathcal{G} = \\{(0,0,0), (\\pm 2\\pi,0,0), (0,\\pm 2\\pi,0), (0,0,\\pm 2\\pi)\\}.\n$$\n2. Derive the plane-wave eigenproblem in Fourier space using the identity for the curl operator acting on plane waves. In the magnetic-field formulation, assemble the operator\n$$\n\\mathsf{M}_{\\mathbf{G},\\mathbf{G}'}(\\mathbf{k}) = - \\epsilon^{-1}_{\\mathbf{G}-\\mathbf{G}'} \\, \\mathsf{C}(\\mathbf{k}+\\mathbf{G}) \\, \\mathsf{C}(\\mathbf{k}+\\mathbf{G}'),\n$$\nwhere $\\mathsf{C}(\\mathbf{q})$ is the $3 \\times 3$ matrix representation of the cross-product with $\\mathbf{q}$, defined by $\\mathsf{C}(\\mathbf{q}) \\mathbf{v} = \\mathbf{q} \\times \\mathbf{v}$. Solve the eigenproblem\n$$\n\\sum_{\\mathbf{G}'} \\mathsf{M}_{\\mathbf{G},\\mathbf{G}'}(\\mathbf{k}) \\, \\mathbf{H}_{\\mathbf{G}'} = \\omega^2(\\mathbf{k}) \\, \\mathbf{H}_{\\mathbf{G}},\n$$\nfor the smallest positive eigenvalue $\\omega^2(\\mathbf{k})$ at each $\\mathbf{k}$.\n3. For each computed band point, define an effective isotropic nonlocal permittivity via the scalar dispersion relation of a homogeneous medium,\n$$\n|\\mathbf{k}|^2 = \\omega^2(\\mathbf{k}) \\, \\epsilon_{\\mathrm{eff}}(\\omega,\\mathbf{k}),\n$$\nwhich yields\n$$\n\\epsilon_{\\mathrm{eff}}(\\omega,\\mathbf{k}) = \\frac{|\\mathbf{k}|^2}{\\omega^2(\\mathbf{k})}.\n$$\nOn a small neighborhood of $\\mathbf{k}=\\mathbf{0}$, assume the dependence on $\\omega$ is weak over the sampled points and fit the nonlocal model\n$$\n\\epsilon_{\\mathrm{eff}}(\\omega,\\mathbf{k}) \\approx \\epsilon_0(\\omega) + \\alpha(\\omega) |\\mathbf{k}|^2 + \\beta(\\omega) |\\mathbf{k}|^4,\n$$\nby least squares over the sampled wavevectors.\n\nImplementation details:\n- Use the reciprocal lattice set $\\mathcal{G}$ given above and construct $\\epsilon^{-1}_{\\mathbf{G}}$ coefficients from $\\epsilon^{-1}(\\mathbf{r})$. Specifically, the nonzero Fourier coefficients are at $\\mathbf{G}=\\mathbf{0}$ with value $\\frac{1}{\\epsilon_{\\text{avg}}}$, at $\\mathbf{G}=(\\pm 2\\pi,0,0)$ with value $\\frac{\\delta_x}{2}$, at $\\mathbf{G}=(0,\\pm 2\\pi,0)$ with value $\\frac{\\delta_y}{2}$, and at $\\mathbf{G}=(0,0,\\pm 2\\pi)$ with value $\\frac{\\delta_z}{2}$.\n- For numerical stability, symmetrize the assembled operator by taking $\\frac{1}{2}(\\mathsf{M} + \\mathsf{M}^\\top)$ and then compute its eigenvalues. From the set of eigenvalues, select the smallest strictly positive eigenvalue as $\\omega^2(\\mathbf{k})$.\n- Use a set of wavevectors along the $\\Gamma \\rightarrow X$ line, i.e., $\\mathbf{k}=(\\kappa,0,0)$ with $\\kappa$ in a small range. Use the values $\\kappa \\in \\{0.1\\pi, 0.12\\pi, 0.14\\pi, 0.16\\pi, 0.18\\pi, 0.2\\pi\\}$.\n\nTest suite:\nCompute the fitted coefficients $\\epsilon_0$, $\\alpha$, and $\\beta$ for each of the following three material parameter sets:\n- Case $1$ (homogeneous limit, boundary case): $\\epsilon_{\\text{avg}}=4.0$, $\\delta_x=0.0$, $\\delta_y=0.0$, $\\delta_z=0.0$.\n- Case $2$ (moderate isotropic modulation): $\\epsilon_{\\text{avg}}=5.0$, $\\delta_x=0.03$, $\\delta_y=0.03$, $\\delta_z=0.03$.\n- Case $3$ (anisotropic modulation): $\\epsilon_{\\text{avg}}=4.0$, $\\delta_x=0.05$, $\\delta_y=0.01$, $\\delta_z=0.03$.\n\nRequired output:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each test case result must be a list of three floats in the order $[\\epsilon_0, \\alpha, \\beta]$. For example, print $[[e0_1,\\alpha_1,\\beta_1],[e0_2,\\alpha_2,\\beta_2],[e0_3,\\alpha_3,\\beta_3]]$. All quantities are dimensionless.", "solution": "The objective is to determine the coefficients of a nonlocal effective permittivity model for a three-dimensional periodic metamaterial. This is achieved by first computing the electromagnetic band structure using a plane-wave expansion (PWE) method and then fitting the computed dispersion relation to a spatially dispersive model. The entire process is grounded in Maxwell's equations and Bloch's theorem.\n\n### 1. Derivation of the Bloch-Floquet Eigenproblem\n\nWe begin with Maxwell's equations in the frequency domain, assuming a time-harmonic dependence of $e^{-i\\omega t}$:\n$$\n\\nabla \\times \\mathbf{E} = i \\omega \\mu \\mathbf{H} \\\\\n\\nabla \\times \\mathbf{H} = -i \\omega \\mathbf{D}\n$$\nThe problem specifies a periodic, local relationship between the electric field $\\mathbf{E}$ and the electric displacement field $\\mathbf{D}$ at the microscopic level: $\\mathbf{E}(\\mathbf{r}) = \\epsilon^{-1}(\\mathbf{r}) \\mathbf{D}(\\mathbf{r})$, where the inverse permittivity tensor is a scalar function $\\epsilon^{-1}(\\mathbf{r})$. In the non-dimensional units specified ($c=1$), we have $\\mu=1$.\n\nTo derive a wave equation solely in terms of the magnetic field $\\mathbf{H}$, we manipulate the equations. From the second curl equation, we express $\\mathbf{D}$ as $\\mathbf{D} = \\frac{i}{\\omega} \\nabla \\times \\mathbf{H}$. Substituting this into the constitutive relation gives $\\mathbf{E} = \\epsilon^{-1}(\\mathbf{r}) \\frac{i}{\\omega} \\nabla \\times \\mathbf{H}$. We then substitute this expression for $\\mathbf{E}$ into the first curl equation:\n$$\n\\nabla \\times \\left( \\epsilon^{-1}(\\mathbf{r}) \\frac{i}{\\omega} \\nabla \\times \\mathbf{H} \\right) = i \\omega \\mathbf{H}\n$$\nMultiplying by $\\omega/i$ and rearranging yields the master eigenproblem for the magnetic field:\n$$\n\\nabla \\times \\left( \\epsilon^{-1}(\\mathbf{r}) \\nabla \\times \\mathbf{H} \\right) = \\omega^2 \\mathbf{H}\n$$\nThis is a generalized Hermitian eigenvalue problem of the form $\\mathcal{L}\\mathbf{H} = \\omega^2 \\mathbf{H}$, where $\\mathcal{L}$ is the operator $\\nabla \\times \\epsilon^{-1}(\\mathbf{r}) \\nabla \\times$.\n\nDue to the periodicity of the medium, $\\epsilon^{-1}(\\mathbf{r}) = \\epsilon^{-1}(\\mathbf{r}+\\mathbf{R})$ for any lattice vector $\\mathbf{R}$, the solutions for $\\mathbf{H}$ must obey Bloch's theorem. A Bloch wave with wavevector $\\mathbf{k}$ can be represented as a plane-wave expansion:\n$$\n\\mathbf{H}(\\mathbf{r}) = e^{i \\mathbf{k} \\cdot \\mathbf{r}} \\mathbf{u}(\\mathbf{r}) = e^{i \\mathbf{k} \\cdot \\mathbf{r}} \\sum_{\\mathbf{G}'} \\mathbf{H}_{\\mathbf{G}'} e^{i \\mathbf{G}' \\cdot \\mathbf{r}} = \\sum_{\\mathbf{G}'} \\mathbf{H}_{\\mathbf{G}'} e^{i (\\mathbf{k} + \\mathbf{G}') \\cdot \\mathbf{r}}\n$$\nwhere $\\mathbf{G}'$ are reciprocal lattice vectors and $\\mathbf{H}_{\\mathbf{G}'}$ are the vector Fourier coefficients. The periodic inverse permittivity function $\\epsilon^{-1}(\\mathbf{r})$ also has a Fourier series representation:\n$$\n\\epsilon^{-1}(\\mathbf{r}) = \\sum_{\\mathbf{G}''} \\epsilon^{-1}_{\\mathbf{G}''} e^{i \\mathbf{G}'' \\cdot \\mathbf{r}}\n$$\nSubstituting these expansions into the wave equation transforms the differential operator problem into an algebraic one. The curl operator $\\nabla \\times$ acting on a plane wave $e^{i\\mathbf{q}\\cdot\\mathbf{r}}$ becomes multiplication by $i\\mathbf{q} \\times$. The action of the operator $\\mathcal{L}$ on a single plane-wave component $e^{i(\\mathbf{k}+\\mathbf{G}')\\cdot\\mathbf{r}}$ is:\n$$\n\\nabla \\times \\left( \\left(\\sum_{\\mathbf{G}''} \\epsilon^{-1}_{\\mathbf{G}''} e^{i \\mathbf{G}'' \\cdot \\mathbf{r}}\\right) \\nabla \\times \\left( \\mathbf{H}_{\\mathbf{G}'} e^{i (\\mathbf{k} + \\mathbf{G}') \\cdot \\mathbf{r}} \\right) \\right) \\\\\n= \\nabla \\times \\left( \\left(\\sum_{\\mathbf{G}''} \\epsilon^{-1}_{\\mathbf{G}''} e^{i \\mathbf{G}'' \\cdot \\mathbf{r}}\\right) i(\\mathbf{k}+\\mathbf{G}') \\times \\mathbf{H}_{\\mathbf{G}'} e^{i (\\mathbf{k} + \\mathbf{G}') \\cdot \\mathbf{r}} \\right) \\\\\n= \\nabla \\times \\left( \\sum_{\\mathbf{G}''} \\epsilon^{-1}_{\\mathbf{G}''} [i(\\mathbf{k}+\\mathbf{G}') \\times \\mathbf{H}_{\\mathbf{G}'}] e^{i (\\mathbf{k} + \\mathbf{G}' + \\mathbf{G}'') \\cdot \\mathbf{r}} \\right)\n$$\nProjecting this onto a plane wave basis $e^{-i(\\mathbf{k}+\\mathbf{G})\\cdot\\mathbf{r}}$ and integrating over a unit cell allows us to isolate the coefficients. This is equivalent to equating coefficients of $e^{i(\\mathbf{k}+\\mathbf{G})\\cdot\\mathbf{r}}$. The coefficient of $e^{i\\mathbf{q}\\cdot\\mathbf{r}}$ in the product of two series is the convolution of their coefficients. This procedure yields the algebraic eigenproblem for the Fourier coefficients $\\mathbf{H}_{\\mathbf{G}}$:\n$$\n\\sum_{\\mathbf{G}'} \\left[ -(\\mathbf{k}+\\mathbf{G}) \\times \\left( (\\mathbf{k}+\\mathbf{G}') \\times \\mathbf{H}_{\\mathbf{G}'} \\right) \\right] \\epsilon^{-1}_{\\mathbf{G}-\\mathbf{G}'} = \\omega^2(\\mathbf{k}) \\mathbf{H}_{\\mathbf{G}}\n$$\nUsing the matrix representation $\\mathsf{C}(\\mathbf{q})$ for the cross product operator ($\\mathsf{C}(\\mathbf{q})\\mathbf{v} = \\mathbf{q} \\times \\mathbf{v}$), we can write the term in the brackets as $\\mathsf{C}(\\mathbf{k}+\\mathbf{G})\\mathsf{C}(\\mathbf{k}+\\mathbf{G}')\\mathbf{H}_{\\mathbf{G}'}$. This leads to the final matrix form given in the problem statement:\n$$\n\\sum_{\\mathbf{G}'} \\mathsf{M}_{\\mathbf{G},\\mathbf{G}'}(\\mathbf{k}) \\, \\mathbf{H}_{\\mathbf{G}'} = \\omega^2(\\mathbf{k}) \\, \\mathbf{H}_{\\mathbf{G}}\n$$\nwhere the matrix blocks are $\\mathsf{M}_{\\mathbf{G},\\mathbf{G}'}(\\mathbf{k}) = - \\epsilon^{-1}_{\\mathbf{G}-\\mathbf{G}'} \\, \\mathsf{C}(\\mathbf{k}+\\mathbf{G}) \\, \\mathsf{C}(\\mathbf{k}+\\mathbf{G}')$.\n\n### 2. Numerical Solution and Parameter Extraction\n\nThe procedure involves three main computational steps:\n\n**Step 1: Construct the Eigenproblem Matrix**\nThe problem uses a truncated set of $N=7$ reciprocal lattice vectors $\\mathcal{G}$. Since each Fourier coefficient $\\mathbf{H}_{\\mathbf{G}}$ is a $3$-vector, the total matrix $\\mathsf{M}$ has dimensions $3N \\times 3N = 21 \\times 21$. This matrix is constructed block-by-block, where each $(\\mathbf{G}, \\mathbf{G}')$ block is a $3 \\times 3$ matrix.\nThe Fourier coefficients $\\epsilon^{-1}_{\\mathbf{G}}$ are determined from the given form of $\\epsilon^{-1}(\\mathbf{r})$. Using Euler's formula $\\cos(\\theta) = (e^{i\\theta} + e^{-i\\theta})/2$, we identify the coefficients as specified in the problem. The cross-product matrix $\\mathsf{C}(\\mathbf{q})$ for a vector $\\mathbf{q}=(q_x, q_y, q_z)$ is:\n$$\n\\mathsf{C}(\\mathbf{q}) = \\begin{pmatrix} 0  -q_z  q_y \\\\ q_z  0  -q_x \\\\ -q_y  q_x  0 \\end{pmatrix}\n$$\nThe full matrix $\\mathsf{M}$ is assembled by iterating over all pairs $(\\mathbf{G}, \\mathbf{G}')$ from the set $\\mathcal{G}$. For numerical stability, the matrix is symmetrized as $\\frac{1}{2}(\\mathsf{M} + \\mathsf{M}^\\top)$ before solving.\n\n**Step 2: Solve for Eigenfrequencies**\nFor each sampling wavevector $\\mathbf{k}$ along the $\\Gamma \\rightarrow X$ direction, i.e., $\\mathbf{k}=(\\kappa,0,0)$ with $\\kappa \\in \\{0.1\\pi, ..., 0.2\\pi\\}$, the symmetric matrix eigenproblem is solved. Standard numerical libraries (e.g., `scipy.linalg.eigh`) are used for this. The resulting eigenvalues correspond to $\\omega^2(\\mathbf{k})$. The formulation inherently produces zero-frequency solutions (longitudinal modes), which are unphysical for light propagation. We select the smallest strictly positive eigenvalue, which corresponds to the lowest-energy transverse photonic band.\n\n**Step 3: Fit the Effective Permittivity Model**\nThe computed dispersion relation $(\\mathbf{k}, \\omega(\\mathbf{k}))$ is used to find the effective permittivity. For a homogeneous, isotropic medium, the dispersion relation is $|\\mathbf{k}|^2 = \\omega^2 \\epsilon_{\\text{eff}}$. We use this to define a $\\mathbf{k}$-dependent effective permittivity for our metamaterial:\n$$\n\\epsilon_{\\mathrm{eff}}(\\mathbf{k}) = \\frac{|\\mathbf{k}|^2}{\\omega^2(\\mathbf{k})}\n$$\nWe then collect the data points $(|\\mathbf{k}|^2, \\epsilon_{\\mathrm{eff}}(\\mathbf{k}))$ for each sampled $\\kappa$. The final step is to fit these data to the polynomial model representing spatial dispersion:\n$$\n\\epsilon_{\\mathrm{eff}}(|\\mathbf{k}|^2) \\approx \\epsilon_0 + \\alpha |\\mathbf{k}|^2 + \\beta |\\mathbf{k}|^4\n$$\nThis is a linear least-squares problem. We seek coefficients $(\\epsilon_0, \\alpha, \\beta)$ that minimize the squared error. Let $x_i = |\\mathbf{k}_i|^2$ and $y_i = \\epsilon_{\\mathrm{eff}}(\\mathbf{k}_i)$. We form the system $\\mathbf{A}\\mathbf{c}=\\mathbf{y}$, where $\\mathbf{c} = [\\epsilon_0, \\alpha, \\beta]^\\top$, $\\mathbf{y} = [y_1, y_2, ...]^\\top$, and the design matrix $\\mathbf{A}$ has rows $[1, x_i, x_i^2]$. The solution is found using a standard linear least-squares solver, such as `numpy.linalg.lstsq`. This procedure is repeated for each of the three test cases.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import eigh\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test cases.\n    It computes the nonlocal effective permittivity coefficients for three\n    metamaterial configurations.\n    \"\"\"\n\n    test_cases = [\n        # (eps_avg, delta_x, delta_y, delta_z)\n        (4.0, 0.0, 0.0, 0.0),\n        (5.0, 0.03, 0.03, 0.03),\n        (4.0, 0.05, 0.01, 0.03),\n    ]\n\n    results = []\n    for case in test_cases:\n        eps_avg, delta_x, delta_y, delta_z = case\n        coeffs = compute_nonlocal_params(eps_avg, delta_x, delta_y, delta_z)\n        results.append(coeffs)\n\n    # Format the final output string as per requirements\n    inner_strs = [f\"[{r[0]},{r[1]},{r[2]}]\" for r in results]\n    print(f\"[{','.join(inner_strs)}]\")\n\ndef compute_nonlocal_params(eps_avg, delta_x, delta_y, delta_z):\n    \"\"\"\n    Computes the band structure and fits the nonlocal permittivity model\n    for a single set of material parameters.\n    \n    Args:\n        eps_avg (float): Average permittivity.\n        delta_x (float): Modulation strength in x.\n        delta_y (float): Modulation strength in y.\n        delta_z (float): Modulation strength in z.\n        \n    Returns:\n        list: A list of the fitted coefficients [epsilon_0, alpha, beta].\n    \"\"\"\n    pi = np.pi\n    \n    # 1. Define reciprocal lattice vectors G and their Fourier coefficients\n    # The set G = {(0,0,0), (±2π,0,0), (0,±2π,0), (0,0,±2π)}\n    G_vecs_tuples = [\n        (0.0, 0.0, 0.0),\n        (2.0*pi, 0.0, 0.0), (-2.0*pi, 0.0, 0.0),\n        (0.0, 2.0*pi, 0.0), (0.0, -2.0*pi, 0.0),\n        (0.0, 0.0, 2.0*pi), (0.0, 0.0, -2.0*pi)\n    ]\n    G_vecs = np.array(G_vecs_tuples, dtype=np.float64)\n    num_G = len(G_vecs)\n\n    # Fourier coefficients of the inverse permittivity epsilon_inv(r)\n    eps_inv_coeffs = {\n        (0.0, 0.0, 0.0): 1.0 / eps_avg,\n        (2.0*pi, 0.0, 0.0): delta_x / 2.0, (-2.0*pi, 0.0, 0.0): delta_x / 2.0,\n        (0.0, 2.0*pi, 0.0): delta_y / 2.0, (0.0, -2.0*pi, 0.0): delta_y / 2.0,\n        (0.0, 0.0, 2.0*pi): delta_z / 2.0, (0.0, 0.0, -2.0*pi): delta_z / 2.0,\n    }\n\n    def get_eps_inv_coeff(g_diff_vec):\n        g_diff_tuple = tuple(g_diff_vec)\n        return eps_inv_coeffs.get(g_diff_tuple, 0.0)\n\n    # 2. Define sampling wavevectors k\n    kappas = np.array([0.1, 0.12, 0.14, 0.16, 0.18, 0.2], dtype=np.float64) * pi\n    k_vecs = np.array([[k_val, 0.0, 0.0] for k_val in kappas], dtype=np.float64)\n\n    # 3. Helper function for cross-product matrix C(q)\n    def C_matrix(q):\n        return np.array([\n            [0.0,    -q[2],  q[1]],\n            [q[2],   0.0,   -q[0]],\n            [-q[1],  q[0],   0.0]\n        ], dtype=np.float64)\n\n    # 4. Compute omega^2 for each k\n    omega_sq_vals = []\n    \n    mat_size = 3 * num_G\n    M = np.zeros((mat_size, mat_size), dtype=np.float64)\n\n    for k in k_vecs:\n        M.fill(0) # Reset matrix for each k\n        for i in range(num_G):\n            for j in range(num_G):\n                G_i = G_vecs[i]\n                G_j = G_vecs[j]\n                \n                G_diff = G_i - G_j\n                eps_inv_val = get_eps_inv_coeff(G_diff)\n                \n                if abs(eps_inv_val)  1e-15:\n                    continue\n                \n                q_i = k + G_i\n                q_j = k + G_j\n                \n                C_i = C_matrix(q_i)\n                C_j = C_matrix(q_j)\n                \n                block = -eps_inv_val * (C_i @ C_j)\n                M[3*i:3*i+3, 3*j:3*j+3] = block\n        \n        # Symmetrize the matrix for numerical stability\n        M_sym = 0.5 * (M + M.T)\n        \n        # Solve the eigenvalue problem\n        eigenvalues = eigh(M_sym, eigvals_only=True)\n        \n        # Find the smallest strictly positive eigenvalue for omega^2\n        positive_eigs = eigenvalues[eigenvalues  1e-9]\n        min_omega_sq = np.min(positive_eigs)\n        omega_sq_vals.append(min_omega_sq)\n\n    omega_sq_vals = np.array(omega_sq_vals)\n\n    # 5. Perform least-squares fit for nonlocal parameters\n    k_sq_vals = kappas**2\n    eps_eff_vals = k_sq_vals / omega_sq_vals\n\n    # Model: eps_eff = eps0 + alpha * k^2 + beta * (k^2)^2\n    # This is a linear system Ac = y\n    A = np.vstack([np.ones_like(k_sq_vals), k_sq_vals, k_sq_vals**2]).T\n    y = eps_eff_vals\n\n    # Solve the least-squares problem\n    coeffs, _, _, _ = np.linalg.lstsq(A, y, rcond=None)\n    \n    return coeffs.tolist()\n\n\nsolve()\n```", "id": "3314241"}]}