{"hands_on_practices": [{"introduction": "The power of the tau-leaping method lies in its ability to take large time steps, but this efficiency is only useful if accuracy is maintained. The choice of the leap size, $\\tau$, is therefore the most critical decision in any tau-leaping simulation. This exercise challenges you to derive a practical and widely-used step-size selection rule from first principles, ensuring that the population changes remain within a controlled bound relative to the current state. [@problem_id:3350266]", "problem": "Consider a well-mixed stochastic reaction network with $d$ chemical species and $M$ reaction channels. Let the system state at time $t$ be $X(t) \\in \\mathbb{N}^d$. For each reaction channel $j \\in \\{1,\\dots,M\\}$, let $\\nu_j \\in \\mathbb{Z}^d$ denote its stoichiometric change vector and $a_j(X)$ its propensity function evaluated at state $X$. In the $\\tau$-leaping approximation over a time increment $\\tau  0$, conditioned on $X(t)$, the number of firings of reaction $j$ is modeled as a Poisson random variable with mean $a_j(X(t))\\,\\tau$, and different reaction channels fire independently.\n\nYour task is to design a step-size control rule that enforces the following requirement at time $t$: for each species index $i \\in \\{1,\\dots,d\\}$, the absolute change in that species over the leap is bounded in a relative sense by a user-chosen fraction $\\delta \\in (0,1)$ of its current count $X_i(t)$. Use only fundamental properties of Poisson random variables and linearity of expectation and variance to derive a sufficient condition on $\\tau$ that enforces this requirement componentwise. Specifically, starting from the definition of the $\\tau$-leaping approximation and the independence of reaction counts, derive an explicit, closed-form expression for the largest $\\tau$ as a function of $X(t)$, $\\delta$, the propensities $a_j(X(t))$, and the stoichiometric coefficients $\\nu_{ij}$ that ensures, for each $i$, that both the expected absolute change and the variance of the change in species $i$ are bounded by $\\delta\\,X_i(t)$ and $\\delta^2 X_i(t)^2$, respectively.\n\nExpress your final answer as a single closed-form analytic expression for $\\tau$ in terms of $\\{a_j(X(t))\\}_{j=1}^M$ and $\\{\\nu_j\\}_{j=1}^M$ only. Do not assume any special structure of $a_j$ beyond nonnegativity. You may assume that $X_i(t)  0$ for all $i \\in \\{1,\\dots,d\\}$. The final answer must be a single symbolic expression. No numerical evaluation is required.", "solution": "The user has provided a valid, well-posed problem statement from the field of stochastic simulation. The task is to derive a step-size selection formula for the $\\tau$-leaping method based on controlling the relative change in species populations.\n\nLet the state of the system at time $t$ be the vector of species populations $X(t) = (X_1(t), \\dots, X_d(t))$. The system evolves through $M$ reaction channels. For each reaction $j \\in \\{1, \\dots, M\\}$, we are given its propensity function $a_j(X)$ and its stoichiometric change vector $\\nu_j = (\\nu_{1j}, \\dots, \\nu_{dj})^T$.\n\nIn the $\\tau$-leaping approximation, the number of times reaction $j$ fires in the time interval $[t, t+\\tau)$, denoted by the random variable $K_j$, is drawn from a Poisson distribution conditioned on the state $X(t)$.\n$$K_j \\sim \\text{Poisson}(\\lambda_j)$$\nwhere the mean $\\lambda_j = a_j(X(t))\\tau$. The problem states that the random variables $K_1, K_2, \\dots, K_M$ are mutually independent.\n\nThe total change in the population of species $i$, denoted $\\Delta X_i$, over the time interval $[t, t+\\tau)$ is given by the sum of contributions from all reaction channels:\n$$\\Delta X_i = \\sum_{j=1}^{M} \\nu_{ij} K_j$$\nOur goal is to find the largest time step $\\tau  0$ that satisfies two conditions for every species $i \\in \\{1, \\dots, d\\}$, given a control parameter $\\delta \\in (0,1)$ and assuming $X_i(t)  0$.\n\nFirst, we compute the expectation of the change $\\Delta X_i$. Using the linearity of expectation:\n$$E[\\Delta X_i] = E\\left[\\sum_{j=1}^{M} \\nu_{ij} K_j\\right] = \\sum_{j=1}^{M} \\nu_{ij} E[K_j]$$\nThe expectation of a Poisson random variable $K_j$ with parameter $\\lambda_j$ is $E[K_j] = \\lambda_j = a_j(X(t))\\tau$. Substituting this into the previous equation gives:\n$$E[\\Delta X_i] = \\sum_{j=1}^{M} \\nu_{ij} a_j(X(t))\\tau = \\tau \\sum_{j=1}^{M} \\nu_{ij} a_j(X(t))$$\n\nThe first condition bounds the magnitude of this expected change. The problem text \"expected absolute change\" is interpreted, consistent with the standard literature and the supplied toolkit (linearity of expectation and variance), as the absolute value of the expected change:\n$$|E[\\Delta X_i]| \\le \\delta X_i(t)$$\nSubstituting our expression for $E[\\Delta X_i]$:\n$$\\left|\\tau \\sum_{j=1}^{M} \\nu_{ij} a_j(X(t))\\right| \\le \\delta X_i(t)$$\nSince $\\tau  0$, we have:\n$$\\tau \\left|\\sum_{j=1}^{M} \\nu_{ij} a_j(X(t))\\right| \\le \\delta X_i(t)$$\nIf the term $\\left|\\sum_{j=1}^{M} \\nu_{ij} a_j(X(t))\\right|$ is non-zero, we can isolate $\\tau$ to find the first upper bound for each species $i$:\n$$\\tau \\le \\frac{\\delta X_i(t)}{\\left|\\sum_{j=1}^{M} \\nu_{ij} a_j(X(t))\\right|}$$\nIf the summation term is zero, this condition imposes no upper bound on $\\tau$ for that species $i$.\n\nSecond, we compute the variance of the change $\\Delta X_i$. Since the random variables $\\{K_j\\}_{j=1}^M$ are independent, the variance of their weighted sum is the weighted sum of their variances:\n$$\\text{Var}(\\Delta X_i) = \\text{Var}\\left(\\sum_{j=1}^{M} \\nu_{ij} K_j\\right) = \\sum_{j=1}^{M} \\text{Var}(\\nu_{ij} K_j) = \\sum_{j=1}^{M} \\nu_{ij}^2 \\text{Var}(K_j)$$\nThe variance of a Poisson random variable $K_j$ with parameter $\\lambda_j$ is $\\text{Var}(K_j) = \\lambda_j = a_j(X(t))\\tau$. Substituting this gives:\n$$\\text{Var}(\\Delta X_i) = \\sum_{j=1}^{M} \\nu_{ij}^2 a_j(X(t))\\tau = \\tau \\sum_{j=1}^{M} \\nu_{ij}^2 a_j(X(t))$$\n\nThe second condition bounds this variance:\n$$\\text{Var}(\\Delta X_i) \\le \\delta^2 X_i(t)^2$$\nSubstituting our expression for $\\text{Var}(\\Delta X_i)$:\n$$\\tau \\sum_{j=1}^{M} \\nu_{ij}^2 a_j(X(t)) \\le \\delta^2 X_i(t)^2$$\nThe term $\\sum_{j=1}^{M} \\nu_{ij}^2 a_j(X(t))$ is non-negative since $a_j(X(t)) \\ge 0$ and $\\nu_{ij}^2 \\ge 0$. If this sum is positive, we can isolate $\\tau$ to find the second upper bound for each species $i$:\n$$\\tau \\le \\frac{\\delta^2 X_i(t)^2}{\\sum_{j=1}^{M} \\nu_{ij}^2 a_j(X(t))}$$\nIf the summation term is zero, this condition imposes no upper bound on $\\tau$ for that species $i$.\n\nTo ensure the stability and accuracy of the leap for the entire system, the time step $\\tau$ must satisfy both inequalities for all species $i \\in \\{1, \\dots, d\\}$. Therefore, $\\tau$ must be less than or equal to the minimum of all derived upper bounds. The largest permissible value for $\\tau$ is the minimum of these bounds over all species and both conditions.\n$$\\tau = \\min_{i \\in \\{1,\\dots,d\\}} \\left\\{ \\tau_{1,i}, \\tau_{2,i} \\right\\}$$\nwhere $\\tau_{1,i}$ and $\\tau_{2,i}$ represent the bounds from the expectation and variance conditions, respectively, for species $i$. If a denominator is zero, the corresponding term does not constrain the minimum (it can be treated as infinite). Combining these gives the final expression for the largest allowed $\\tau$:\n$$\\tau = \\min_{i \\in \\{1,\\dots,d\\}} \\left\\{ \\frac{\\delta X_i(t)}{\\left| \\sum_{j=1}^M \\nu_{ij} a_j(X(t)) \\right|}, \\frac{\\delta^2 X_i(t)^2}{\\sum_{j=1}^M \\nu_{ij}^2 a_j(X(t))} \\right\\}$$\nThis single expression provides the necessary sufficient condition on $\\tau$.", "answer": "$$\\boxed{\\min_{i \\in \\{1,\\dots,d\\}} \\left\\{ \\frac{\\delta X_i(t)}{\\left| \\sum_{j=1}^{M} \\nu_{ij} a_j(X(t)) \\right|}, \\frac{\\delta^2 X_i(t)^2}{\\sum_{j=1}^{M} \\nu_{ij}^2 a_j(X(t))} \\right\\}}$$", "id": "3350266"}, {"introduction": "Having established a rule for selecting $\\tau$, it is instructive to see what happens when that rule is violated. This practice provides a concrete, computational case study of the failure of the \"leap condition\" when $\\tau$ is chosen to be too large. You will move beyond the abstract condition by deriving the exact distribution for a simple decay process and comparing it to the standard Poisson tau-leap approximation, quantifying the resulting bias and the probability of reaching physically impossible states. [@problem_id:3350297]", "problem": "Construct a mathematically precise and computationally verifiable example showing how taking a leap size $\\tau$ that is too large violates the leap condition in the tau-leaping method and yields inaccurate reaction count distributions, and quantify the resulting bias in expected species changes. Work within a single-reaction stochastic chemical kinetics system defined as follows.\n\nConsider one species $X$ participating in one reaction $\\mathcal{R}_1: X \\to \\varnothing$ with rate constant $c \\in \\mathbb{R}_{0}$. The system is a continuous-time Markov chain described by the Chemical Master Equation (CME; Chemical Master Equation). The system starts at time $t=0$ with an integer count $X(0) = x_0 \\in \\mathbb{Z}_{\\ge 0}$. The propensity function for $\\mathcal{R}_1$ at state $x$ is $a(x) = c x$. Over a time interval $[0,\\tau]$, the leap condition underlying tau-leaping requires that propensities remain approximately constant. When $\\tau$ is too large, this condition fails for this system because $a(x)$ depends strongly on $x$ and $x$ may change substantially over the interval.\n\nTasks:\n1) Starting from the definition of exponential waiting times for reaction channels in the CME and the independence of survival of each molecule $X$, derive the exact finite-time distribution for the number of reaction firings (deaths) over $[0,\\tau]$ when starting from $X(0)=x_0$. From that distribution, derive the exact expected change of $X$ over the interval, namely the expectation of $X(\\tau)-X(0)$.\n\n2) Under the basic Poisson tau-leap approximation, freeze the propensity at its initial value $a(x_0)=c x_0$ over the entire interval $[0,\\tau]$, model the number of reaction firings as a Poisson random variable with that constant rate over $[0,\\tau]$, and derive the corresponding approximate distribution of reaction counts and the approximate expected change in $X$ over the interval.\n\n3) Define the following three quantitative metrics to assess leap-condition violation:\n   - The bias in expected species change, defined as $b(x_0,c,\\tau) = \\mathbb{E}_{\\text{leap}}[X(\\tau)-X(0)] - \\mathbb{E}_{\\text{exact}}[X(\\tau)-X(0)]$.\n   - The total variation distance between the exact and tau-leap distributions of reaction counts over $[0,\\tau]$, defined as $d_{\\mathrm{TV}} = \\frac{1}{2}\\sum_{k=0}^{\\infty}\\lvert p_{\\text{leap}}(k)-p_{\\text{exact}}(k)\\rvert$, where $p_{\\text{exact}}(k)$ and $p_{\\text{leap}}(k)$ are the exact and tau-leap probabilities of $k$ reaction firings. Note that $p_{\\text{exact}}(k)=0$ for $k  x_0$ while $p_{\\text{leap}}(k)$ may assign nonzero probability to $kx_0$.\n   - The tau-leap invalidity probability mass, defined as $q_{\\text{inv}} = \\sum_{k=x_0+1}^{\\infty} p_{\\text{leap}}(k)$, which quantifies the probability that the tau-leap distribution assigns to impossible counts of reaction firings $k  x_0$.\n\n4) Implement a program that:\n   - Uses only the derived, closed-form distributions and expectations from Tasks 1 and 2 (do not use Monte Carlo sampling).\n   - For each parameter triple $(x_0,c,\\tau)$ in the test suite below, computes and returns the triple of floats $(b, d_{\\mathrm{TV}}, q_{\\text{inv}})$ as defined above.\n\nUse the following test suite of parameter values, each treated as an independent test case:\n- Case 1 (happy path, small leap): $(x_0,c,\\tau) = (50, 1.0, 0.01)$.\n- Case 2 (moderate leap): $(x_0,c,\\tau) = (50, 1.0, 0.2)$.\n- Case 3 (large leap, mean equal to initial count): $(x_0,c,\\tau) = (50, 1.0, 1.0)$.\n- Case 4 (very large leap): $(x_0,c,\\tau) = (50, 1.0, 2.0)$.\n- Case 5 (small population, stiff decay): $(x_0,c,\\tau) = (5, 2.0, 1.5)$.\n\nFinal Output Format:\n- Your program should produce a single line of output containing all results across the five cases as a comma-separated list enclosed in square brackets, in the following flattened order:\n  $[b_1, d_{\\mathrm{TV},1}, q_{\\text{inv},1}, b_2, d_{\\mathrm{TV},2}, q_{\\text{inv},2}, \\dots, b_5, d_{\\mathrm{TV},5}, q_{\\text{inv},5}]$.\n- Each numeric entry must be rounded to $10$ decimal places.\n- No physical units are involved.\n- Angles are not applicable.\n- Do not include any additional text.\n\nThe problem must be solved from first principles using the definitions stated; do not introduce heuristic corrections (such as nonnegativity constraints or binomial tau-leaps) and do not use sampling-based estimators. Your program must be self-contained and must not require any input. The answer for each test case must be a list of floats, aggregated as specified above into a single line of output.", "solution": "The problem statement is valid as it is scientifically grounded in the principles of stochastic chemical kinetics, well-posed with a clear objective, and free from any factual or logical inconsistencies. We will proceed by first deriving the exact and approximate models and then using them to compute the specified metrics.\n\nThe system under consideration involves a single chemical species $X$ undergoing a unimolecular decay reaction $\\mathcal{R}_1: X \\to \\varnothing$ with a rate constant $c$. The system starts with $X(0) = x_0$ molecules at time $t=0$. The propensity function, which gives the instantaneous probability of a reaction occurring per unit time, is $a(x) = c x$.\n\n**Task 1: Exact Distribution and Expectation**\n\nThe reaction $X \\to \\varnothing$ describes the decay of individual molecules. In this first-order process, each of the $x_0$ molecules behaves independently of the others. The lifetime of any single molecule of $X$ is an exponentially distributed random variable with rate parameter $c$.\n\nThe probability that a specific molecule survives for a duration of at least $\\tau$ is given by the survival function of the exponential distribution, which is $P(\\text{survival}) = e^{-c\\tau}$. Consequently, the probability that a single molecule decays within the time interval $[0, \\tau]$ is $p = 1 - e^{-c\\tau}$.\n\nSince we begin with $x_0$ independent molecules, the number of molecules that decay, let us denote this random variable by $K$, is the number of \"successes\" (decays) in $x_0$ independent Bernoulli trials, where the probability of success for each trial is $p$. This scenario is exactly described by a Binomial distribution. Therefore, the exact distribution of the number of reaction firings $K$ in $[0, \\tau]$ is:\n$$\nK \\sim \\text{Binomial}(n=x_0, p=1-e^{-c\\tau})\n$$\nThe probability mass function (PMF) of $K$, which we denote as $p_{\\text{exact}}(k)$, is:\n$$\np_{\\text{exact}}(k) = \\binom{x_0}{k} (1-e^{-c\\tau})^k (e^{-c\\tau})^{x_0-k}, \\quad \\text{for } k \\in \\{0, 1, \\dots, x_0\\}\n$$\nFor any $k  x_0$, $p_{\\text{exact}}(k) = 0$, as it is impossible for more molecules to react than are initially present.\n\nThe number of molecules at time $\\tau$ is $X(\\tau) = X(0) - K = x_0 - K$. The expected change in the number of molecules of $X$ is $\\mathbb{E}_{\\text{exact}}[X(\\tau) - X(0)] = \\mathbb{E}[x_0 - K - x_0] = -\\mathbb{E}[K]$. The expectation of a binomial random variable $\\text{Binomial}(n, p)$ is $np$. Thus, the exact expected number of reaction firings is $\\mathbb{E}[K] = x_0 p = x_0(1-e^{-c\\tau})$.\n\nThe exact expected change in species count is therefore:\n$$\n\\mathbb{E}_{\\text{exact}}[X(\\tau)-X(0)] = -x_0(1-e^{-c\\tau})\n$$\n\n**Task 2: Tau-Leap Approximate Distribution and Expectation**\n\nThe basic tau-leaping method approximates the true stochastic process by assuming that the propensity function remains constant over the time interval $[0, \\tau]$ (the \"leap\"). The propensity is \"frozen\" at its initial value, $a(X(0)) = a(x_0) = c x_0$.\n\nUnder this assumption, the reaction process is modeled as a homogeneous Poisson process with a constant rate $\\lambda' = c x_0$. The number of reaction firings over an interval of length $\\tau$, which we denote by $K'$, is a Poisson random variable with parameter $\\lambda = \\lambda'\\tau = c x_0 \\tau$.\n$$\nK' \\sim \\text{Poisson}(\\lambda=c x_0 \\tau)\n$$\nThe approximate PMF for the number of reaction firings, $p_{\\text{leap}}(k)$, is given by:\n$$\np_{\\text{leap}}(k) = \\frac{e^{-\\lambda} \\lambda^k}{k!} = \\frac{e^{-c x_0 \\tau} (c x_0 \\tau)^k}{k!}, \\quad \\text{for } k \\in \\{0, 1, 2, \\dots\\}\n$$\nUnlike the exact distribution, the Poisson distribution has a support over all non-negative integers, meaning $p_{\\text{leap}}(k)  0$ for all $k \\ge 0$.\n\nThe approximate change in species count is calculated as $X'(\\tau) - X(0) = -K'$. The approximate expected change is $\\mathbb{E}_{\\text{leap}}[X(\\tau)-X(0)] = -\\mathbb{E}[K']$. The expectation of a Poisson random variable with parameter $\\lambda$ is $\\lambda$.\n\nThe approximate expected change in species count is therefore:\n$$\n\\mathbb{E}_{\\text{leap}}[X(\\tau)-X(0)] = -\\lambda = -c x_0 \\tau\n$$\n\n**Task 3: Quantitative Metrics**\n\nUsing a Taylor expansion for small $c\\tau$, $\\mathbb{E}_{\\text{exact}}[\\Delta X] = -x_0(1-(1-c\\tau+\\frac{(c\\tau)^2}{2}-\\dots)) = -c x_0 \\tau + \\frac{x_0(c\\tau)^2}{2} - \\dots$. The tau-leap approximation matches the first-order term but neglects higher-order terms, leading to discrepancies when $\\tau$ is not small. We can quantify these discrepancies using the specified metrics.\n\n1.  **Bias in expected species change, $b(x_0,c,\\tau)$**:\n    This is the difference between the approximate and exact expected changes.\n    $$\n    b = \\mathbb{E}_{\\text{leap}}[X(\\tau)-X(0)] - \\mathbb{E}_{\\text{exact}}[X(\\tau)-X(0)] = (-c x_0 \\tau) - (-x_0(1-e^{-c\\tau})) = x_0(1 - e^{-c\\tau} - c\\tau)\n    $$\n    This quantity is always non-positive, indicating that the basic tau-leap method systematically overestimates the number of decay reactions by ignoring the depletion of reactants within the leap interval.\n\n2.  **Tau-leap invalidity probability mass, $q_{\\text{inv}}$**:\n    This metric measures the probability that the tau-leap approximation assigns to physically impossible events, i.e., more reactions than available reactants ($k  x_0$).\n    $$\n    q_{\\text{inv}} = \\sum_{k=x_0+1}^{\\infty} p_{\\text{leap}}(k)\n    $$\n    This is the complement of the cumulative distribution function (CDF) of the Poisson distribution evaluated at $x_0$. It is equivalent to the survival function (SF):\n    $$\n    q_{\\text{inv}} = 1 - \\sum_{k=0}^{x_0} \\frac{e^{-\\lambda} \\lambda^k}{k!} = \\text{SF}_{\\text{Poisson}}(x_0; \\lambda=c x_0 \\tau)\n    $$\n\n3.  **Total variation distance, $d_{\\mathrm{TV}}$**:\n    This measures the total difference between the two probability distributions.\n    $$\n    d_{\\mathrm{TV}} = \\frac{1}{2}\\sum_{k=0}^{\\infty}\\lvert p_{\\text{leap}}(k)-p_{\\text{exact}}(k)\\rvert\n    $$\n    We can split the summation based on the support of $p_{\\text{exact}}$:\n    $$\n    d_{\\mathrm{TV}} = \\frac{1}{2}\\left( \\sum_{k=0}^{x_0}\\lvert p_{\\text{leap}}(k)-p_{\\text{exact}}(k)\\rvert + \\sum_{k=x_0+1}^{\\infty}\\lvert p_{\\text{leap}}(k)-0\\rvert \\right)\n    $$\n    The second term in the parentheses is exactly $q_{\\text{inv}}$. Thus, we arrive at a computationally convenient formula:\n    $$\n    d_{\\mathrm{TV}} = \\frac{1}{2}\\left( \\sum_{k=0}^{x_0}\\lvert p_{\\text{leap}}(k)-p_{\\text{exact}}(k)\\rvert + q_{\\text{inv}} \\right)\n    $$\n\n**Task 4: Computational Implementation**\n\nThe program will implement the closed-form expressions derived above. For each parameter set $(x_0, c, \\tau)$, it will:\n-   Calculate the bias $b$ using its analytical formula.\n-   Calculate the invalidity mass $q_{\\text{inv}}$ using the survival function of the Poisson distribution.\n-   Calculate the total variation distance $d_{\\mathrm{TV}}$ by numerically summing the differences between the binomial and Poisson PMFs up to $k=x_0$ and adding $q_{\\text{inv}}$, as per the derived formula. Python's `scipy.stats` library is well-suited for evaluating these statistical functions.\n\nThe results from each test case will be aggregated and formatted as specified.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import binom, poisson\n\ndef solve():\n    \"\"\"\n    Solves the problem by calculating the bias, total variation distance, and\n    invalid probability mass for several test cases comparing an exact\n    stochastic model with its tau-leap approximation.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (50, 1.0, 0.01),  # Case 1 (happy path, small leap)\n        (50, 1.0, 0.2),   # Case 2 (moderate leap)\n        (50, 1.0, 1.0),   # Case 3 (large leap, mean equal to initial count)\n        (50, 1.0, 2.0),   # Case 4 (very large leap)\n        (5, 2.0, 1.5),    # Case 5 (small population, stiff decay)\n    ]\n\n    all_results = []\n    \n    for x0, c, tau in test_cases:\n        # Task 1  2: Define parameters for exact and leap models\n        # Exact model: Binomial(n=x0, p=1-exp(-c*tau))\n        # The number of reactions K is Binomial.\n        # Change in X is -K.\n        exact_expected_change = -x0 * (1 - np.exp(-c * tau))\n\n        # Leap model: Poisson(lambda=c*x0*tau)\n        # The number of reactions K' is Poisson.\n        # Change in X is -K'.\n        lambda_leap = c * x0 * tau\n        leap_expected_change = -lambda_leap\n        \n        # Task 3: Calculate the metrics\n\n        # 1. Bias in expected species change, b(x0, c, tau)\n        b = leap_expected_change - exact_expected_change\n\n        # 2. Tau-leap invalidity probability mass, q_inv\n        # This is the probability that the Poisson leap model predicts\n        # more reactions than molecules available (k  x0).\n        # It's the survival function of the Poisson distribution at x0.\n        q_inv = poisson.sf(x0, lambda_leap)\n\n        # 3. Total variation distance, d_TV\n        # d_TV = 0.5 * sum(|p_leap(k) - p_exact(k)| for all k)\n        # We can split this sum:\n        # Term 1: for k from 0 to x0\n        # Term 2: for k from x0+1 to infinity. For these k, p_exact(k) = 0.\n        # Term 2 is exactly q_inv.\n        \n        k_values = np.arange(0, x0 + 1)\n        \n        # PMF for the exact distribution (Binomial)\n        p_binom = 1 - np.exp(-c * tau)\n        p_exact_k = binom.pmf(k_values, x0, p_binom)\n        \n        # PMF for the leap approximation (Poisson)\n        p_leap_k = poisson.pmf(k_values, lambda_leap)\n        \n        # Sum of absolute differences over the valid range of k for the exact model\n        sum_abs_diff = np.sum(np.abs(p_leap_k - p_exact_k))\n        \n        d_tv = 0.5 * (sum_abs_diff + q_inv)\n        \n        all_results.extend([b, d_tv, q_inv])\n\n    # Format the final output string as required\n    formatted_results = [f\"{r:.10f}\" for r in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n\n```", "id": "3350297"}, {"introduction": "Some systems, known as \"stiff\" systems, pose a severe challenge to explicit methods like the standard tau-leap, forcing prohibitively small time steps even when populations are large. To overcome this, we can turn to implicit methods, which offer superior stability by incorporating information about the future state into the current step. This exercise guides you through the formulation of an implicit tau-leap scheme, requiring you to derive and solve the linear system that advances the solution for a stiff unimolecular network. [@problem_id:3350319]", "problem": "Consider a well-mixed stochastic reaction network with $d$ chemical species and $m$ unimolecular reactions. Let the state at time $t$ be the population vector $x(t) \\in \\mathbb{Z}_{\\ge 0}^{d}$, and suppose the network is modeled as a continuous-time, discrete-state Markov jump process consistent with the Chemical Master Equation (CME). The state changes due to reactions with stoichiometric matrix $S \\in \\mathbb{Z}^{d \\times m}$ whose $j$-th column is the net change induced by reaction $j$. Assume the propensities are linear in the state, so that $a(x) = C x$ for some matrix $C \\in \\mathbb{R}^{m \\times d}$, where $a(x)$ is the vector of reaction propensities and $x \\in \\mathbb{R}^{d}$ is treated as a real-valued approximation of the integer-valued state. The explicit tau-leaping scheme uses independent Poisson random variables to approximate reaction counts over a short time step $\\tau  0$. An implicit tau-leap can be constructed by using the next-step state inside the mean of the reaction count while retaining an explicit representation of the centered (zero-mean) noise from the current state.\n\nStarting from first principles of Markov jump processes and the Poisson nature of reaction counts over short intervals, derive the linear system that must be solved at each step of an implicit tau-leap method for unimolecular networks with $a(x) = C x$. Clearly show how the implicit use of $a(x^{n+1})$ in the mean of the reaction counts leads to a linear system for $x^{n+1}$, and identify the matrix that must be inverted to advance the solution.\n\nThen, solve this system explicitly for the following two-species, two-reaction network:\n- Reactions: $X_{1} \\rightarrow X_{2}$ with rate constant $k_{1}$, and $X_{2} \\rightarrow X_{1}$ with rate constant $k_{2}$.\n- Stoichiometric matrix and propensity matrix:\n$$\nS = \\begin{pmatrix}\n-1  1 \\\\\n1  -1\n\\end{pmatrix},\n\\qquad\nC = \\begin{pmatrix}\nk_{1}  0 \\\\\n0  k_{2}\n\\end{pmatrix}.\n$$\n- Current state $x^{n} = \\begin{pmatrix} 4 \\\\ 3 \\end{pmatrix}$, time step $\\tau = \\frac{1}{2}$, and rate constants $k_{1} = 1$, $k_{2} = 2$.\n- The implicit tau-leap uses the next-step propensities $a(x^{n+1})$ inside the mean and the centered Poisson noise computed at the current state. Let the independent Poisson random variables based on current means $\\lambda_{1} = a_{1}(x^{n}) \\tau$ and $\\lambda_{2} = a_{2}(x^{n}) \\tau$ realize as $P_{1} = 1$ and $P_{2} = 4$.\n\nCompute the updated state $x^{n+1}$ exactly. Express your final answer as a row matrix using exact rational numbers; do not round.", "solution": "The problem is valid. It presents a well-posed question in the established scientific domain of stochastic chemical kinetics and its numerical simulation, specifically concerning the tau-leaping method. All givens are scientifically sound, consistent, and sufficient to derive a unique solution.\n\nWe begin by addressing the first part of the problem: deriving the linear system for the specified implicit tau-leap method.\n\nLet the state of the system at time $t_n$ be $x^n$. The state at the next time step, $t_{n+1} = t_n + \\tau$, is given by the tau-leaping update equation:\n$$x^{n+1} = x^n + \\sum_{j=1}^{m} S_j K_j = x^n + S K$$\nwhere $K_j$ is the number of times reaction $j$ occurs in the time interval $[\\,t_n, t_{n+1}\\,)$, and $S_j$ is the $j$-th column of the stoichiometric matrix $S$. The vector $K$ is a column vector of these reaction counts.\n\nIn the standard explicit tau-leap method, $K_j$ is approximated by a Poisson random variable $P_j$ with mean $\\lambda_j = a_j(x^n)\\tau$. The problem defines a specific implicit scheme. The number of reactions $K_j$ is to be approximated by using the mean evaluated at the future state, $a_j(x^{n+1})\\tau$, and adding the centered noise from the current state.\n\nThe centered noise for a Poisson process is the random variable itself minus its mean. For a process with mean $\\lambda = a(x^n)\\tau$, the noise is $P - \\lambda$, where $P$ is a Poisson random variable with mean $\\lambda$. The problem states that this noise term is to be computed \"explicitly\", i.e., using the current state $x^n$.\n\nLet $P$ be a vector of independent Poisson random variables, where each component $P_j$ has a mean of $\\lambda_j = a_j(x^n)\\tau$. The explicit centered noise vector is $P - a(x^n)\\tau$.\nThe implicit mean vector is $a(x^{n+1})\\tau$.\n\nFollowing the problem's prescription, the approximation for the reaction count vector $K$ is:\n$$K \\approx a(x^{n+1})\\tau + (P - a(x^n)\\tau)$$\n\nSubstituting this into the state update equation:\n$$x^{n+1} = x^n + S \\left( a(x^{n+1})\\tau + P - a(x^n)\\tau \\right)$$\n\nThe problem specifies that the reaction network is unimolecular, so the propensities are linear in the state: $a(x) = Cx$. Substituting this into the equation:\n$$x^{n+1} = x^n + S \\left( (Cx^{n+1})\\tau + P - (Cx^n)\\tau \\right)$$\n$$x^{n+1} = x^n + \\tau S C x^{n+1} + S P - \\tau S C x^n$$\n\nTo solve for $x^{n+1}$, we rearrange the terms to group all instances of $x^{n+1}$ on the left side. Let $I_d$ be the $d \\times d$ identity matrix.\n$$x^{n+1} - \\tau S C x^{n+1} = x^n - \\tau S C x^n + S P$$\n$$(I_d - \\tau S C) x^{n+1} = (I_d - \\tau S C) x^n + S P$$\n\nThis is the linear system that must be solved for $x^{n+1}$. The matrix that must be inverted to advance the solution is:\n$$A = I_d - \\tau S C$$\nThe solution for $x^{n+1}$ is given by $x^{n+1} = (I_d - \\tau S C)^{-1} \\left( (I_d - \\tau S C)x^n + SP \\right)$, which simplifies to:\n$$x^{n+1} = x^n + (I_d - \\tau S C)^{-1} S P$$\n\nNow we apply this result to the specific two-species, two-reaction network. The given parameters are:\n$$S = \\begin{pmatrix} -1  1 \\\\ 1  -1 \\end{pmatrix}, \\qquad C = \\begin{pmatrix} k_1  0 \\\\ 0  k_2 \\end{pmatrix} = \\begin{pmatrix} 1  0 \\\\ 0  2 \\end{pmatrix}$$\n$$x^n = \\begin{pmatrix} 4 \\\\ 3 \\end{pmatrix}, \\qquad \\tau = \\frac{1}{2}$$\nThe problem provides the realized values of the Poisson random variables $P_1$ and $P_2$:\n$$P = \\begin{pmatrix} P_1 \\\\ P_2 \\end{pmatrix} = \\begin{pmatrix} 1 \\\\ 4 \\end{pmatrix}$$\n\nFirst, we compute the matrix $A = I_2 - \\tau S C$.\nThe product $SC$ is:\n$$SC = \\begin{pmatrix} -1  1 \\\\ 1  -1 \\end{pmatrix} \\begin{pmatrix} 1  0 \\\\ 0  2 \\end{pmatrix} = \\begin{pmatrix} (-1)(1) + (1)(0)  (-1)(0) + (1)(2) \\\\ (1)(1) + (-1)(0)  (1)(0) + (-1)(2) \\end{pmatrix} = \\begin{pmatrix} -1  2 \\\\ 1  -2 \\end{pmatrix}$$\nNext, we compute $\\tau S C$:\n$$\\tau SC = \\frac{1}{2} \\begin{pmatrix} -1  2 \\\\ 1  -2 \\end{pmatrix} = \\begin{pmatrix} -\\frac{1}{2}  1 \\\\ \\frac{1}{2}  -1 \\end{pmatrix}$$\nNow, we find $A$:\n$$A = I_2 - \\tau SC = \\begin{pmatrix} 1  0 \\\\ 0  1 \\end{pmatrix} - \\begin{pmatrix} -\\frac{1}{2}  1 \\\\ \\frac{1}{2}  -1 \\end{pmatrix} = \\begin{pmatrix} 1 - (-\\frac{1}{2})  0-1 \\\\ 0 - \\frac{1}{2}  1 - (-1) \\end{pmatrix} = \\begin{pmatrix} \\frac{3}{2}  -1 \\\\ -\\frac{1}{2}  2 \\end{pmatrix}$$\n\nTo solve the system, we need the inverse of $A$, which is $A^{-1} = \\frac{1}{\\det(A)} \\text{adj}(A)$.\nThe determinant of $A$ is:\n$$\\det(A) = \\left(\\frac{3}{2}\\right)(2) - (-1)\\left(-\\frac{1}{2}\\right) = 3 - \\frac{1}{2} = \\frac{5}{2}$$\nThe inverse $A^{-1}$ is:\n$$A^{-1} = \\frac{1}{5/2} \\begin{pmatrix} 2  1 \\\\ \\frac{1}{2}  \\frac{3}{2} \\end{pmatrix} = \\frac{2}{5} \\begin{pmatrix} 2  1 \\\\ \\frac{1}{2}  \\frac{3}{2} \\end{pmatrix} = \\begin{pmatrix} \\frac{4}{5}  \\frac{2}{5} \\\\ \\frac{1}{5}  \\frac{3}{5} \\end{pmatrix}$$\n\nNext, we compute the vector $SP$:\n$$SP = \\begin{pmatrix} -1  1 \\\\ 1  -1 \\end{pmatrix} \\begin{pmatrix} 1 \\\\ 4 \\end{pmatrix} = \\begin{pmatrix} (-1)(1) + (1)(4) \\\\ (1)(1) + (-1)(4) \\end{pmatrix} = \\begin{pmatrix} 3 \\\\ -3 \\end{pmatrix}$$\n\nFinally, we compute $x^{n+1}$ using the derived formula $x^{n+1} = x^n + A^{-1}SP$:\n$$x^{n+1} = \\begin{pmatrix} 4 \\\\ 3 \\end{pmatrix} + \\begin{pmatrix} \\frac{4}{5}  \\frac{2}{5} \\\\ \\frac{1}{5}  \\frac{3}{5} \\end{pmatrix} \\begin{pmatrix} 3 \\\\ -3 \\end{pmatrix}$$\n$$x^{n+1} = \\begin{pmatrix} 4 \\\\ 3 \\end{pmatrix} + \\begin{pmatrix} (\\frac{4}{5})(3) + (\\frac{2}{5})(-3) \\\\ (\\frac{1}{5})(3) + (\\frac{3}{5})(-3) \\end{pmatrix} = \\begin{pmatrix} 4 \\\\ 3 \\end{pmatrix} + \\begin{pmatrix} \\frac{12}{5} - \\frac{6}{5} \\\\ \\frac{3}{5} - \\frac{9}{5} \\end{pmatrix} = \\begin{pmatrix} 4 \\\\ 3 \\end{pmatrix} + \\begin{pmatrix} \\frac{6}{5} \\\\ -\\frac{6}{5} \\end{pmatrix}$$\n$$x^{n+1} = \\begin{pmatrix} 4 + \\frac{6}{5} \\\\ 3 - \\frac{6}{5} \\end{pmatrix} = \\begin{pmatrix} \\frac{20}{5} + \\frac{6}{5} \\\\ \\frac{15}{5} - \\frac{6}{5} \\end{pmatrix} = \\begin{pmatrix} \\frac{26}{5} \\\\ \\frac{9}{5} \\end{pmatrix}$$\n\nThe updated state is $x^{n+1} = \\begin{pmatrix} 26/5 \\\\ 9/5 \\end{pmatrix}$.", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{26}{5}  \\frac{9}{5}\n\\end{pmatrix}\n}\n$$", "id": "3350319"}]}