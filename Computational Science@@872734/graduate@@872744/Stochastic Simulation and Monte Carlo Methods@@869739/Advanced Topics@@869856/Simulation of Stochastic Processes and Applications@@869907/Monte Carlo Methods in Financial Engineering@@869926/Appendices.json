{"hands_on_practices": [{"introduction": "Before we can effectively simulate a stochastic process, we must first understand its fundamental properties. This exercise lays the theoretical groundwork by focusing on the Geometric Brownian Motion (GBM) model, the cornerstone of modern financial engineering. By deriving the exact solution and its statistical moments under both the physical measure $\\mathbb{P}$ and the risk-neutral measure $\\mathbb{Q}$, you will build a crucial analytical baseline that is essential for validating and interpreting simulation results. [@problem_id:3321531]", "problem": "Consider a single risky asset whose price process $\\{S_{t}\\}_{t \\geq 0}$ is modeled on a filtered probability space $(\\Omega,\\mathcal{F},\\{\\mathcal{F}_{t}\\}_{t \\geq 0},\\mathbb{P})$ by the stochastic differential equation (SDE)\n$$\n\\mathrm{d}S_{t}=\\mu S_{t}\\,\\mathrm{d}t+\\sigma S_{t}\\,\\mathrm{d}W_{t}^{\\mathbb{P}}, \\quad S_{0}>0,\n$$\nwhere $\\mu \\in \\mathbb{R}$ and $\\sigma>0$ are constants and $\\{W_{t}^{\\mathbb{P}}\\}_{t \\geq 0}$ is a standard Brownian motion under the physical measure $\\mathbb{P}$. Assume that there is a money market account with deterministic short rate $r \\in \\mathbb{R}$ and that absence of arbitrage holds so that there exists an equivalent martingale measure (risk-neutral measure) $\\mathbb{Q}$ under which the discounted asset price is a martingale. Under $\\mathbb{Q}$, the asset dynamics satisfy\n$$\n\\mathrm{d}S_{t}=r S_{t}\\,\\mathrm{d}t+\\sigma S_{t}\\,\\mathrm{d}W_{t}^{\\mathbb{Q}},\n$$\nwhere $\\{W_{t}^{\\mathbb{Q}}\\}_{t \\geq 0}$ is a standard Brownian motion under $\\mathbb{Q}$.\n\nUsing only fundamental stochastic calculus tools and measure-change principles appropriate for diffusion processes with constant coefficients, do the following:\n\n- Derive the exact pathwise solution for $S_{T}$ at a fixed time $T>0$ in terms of $S_{0}$, model parameters, and the driving Brownian motion.\n- Compute the expectation $\\mathbb{E}_{\\mathbb{P}}[S_{T}]$ and variance $\\mathrm{Var}_{\\mathbb{P}}(S_{T})$ under the physical measure $\\mathbb{P}$.\n- Compute the expectation $\\mathbb{E}_{\\mathbb{Q}}[S_{T}]$ and variance $\\mathrm{Var}_{\\mathbb{Q}}(S_{T})$ under the risk-neutral measure $\\mathbb{Q}$.\n\nExpress your final answer as a single row matrix containing, in order, $\\mathbb{E}_{\\mathbb{P}}[S_{T}]$, $\\mathrm{Var}_{\\mathbb{P}}(S_{T})$, $\\mathbb{E}_{\\mathbb{Q}}[S_{T}]$, and $\\mathrm{Var}_{\\mathbb{Q}}(S_{T})$. No numerical rounding is required; provide closed-form analytic expressions. No physical units are needed.", "solution": "The user has requested a solution to a problem in quantitative finance, which involves deriving the solution to the geometric Brownian motion stochastic differential equation and calculating its first two moments under both the physical and risk-neutral measures.\n\n### Step 1: Extract Givens\n-   Stochastic differential equation (SDE) for the asset price $S_t$ under the physical measure $\\mathbb{P}$: $\\mathrm{d}S_{t}=\\mu S_{t}\\,\\mathrm{d}t+\\sigma S_{t}\\,\\mathrm{d}W_{t}^{\\mathbb{P}}$.\n-   Initial asset price: $S_{0}0$.\n-   Drift coefficient under $\\mathbb{P}$: $\\mu \\in \\mathbb{R}$ (constant).\n-   Volatility coefficient: $\\sigma0$ (constant).\n-   Driving process under $\\mathbb{P}$: $\\{W_{t}^{\\mathbb{P}}\\}_{t \\geq 0}$ is a standard Brownian motion.\n-   Deterministic short rate: $r \\in \\mathbb{R}$.\n-   SDE for the asset price $S_t$ under the risk-neutral measure $\\mathbb{Q}$: $\\mathrm{d}S_{t}=r S_{t}\\,\\mathrm{d}t+\\sigma S_{t}\\,\\mathrm{d}W_{t}^{\\mathbb{Q}}$.\n-   Driving process under $\\mathbb{Q}$: $\\{W_{t}^{\\mathbb{Q}}\\}_{t \\geq 0}$ is a standard Brownian motion.\n-   Objective: Derive the pathwise solution for $S_T$ and compute the quantities $\\mathbb{E}_{\\mathbb{P}}[S_{T}]$, $\\mathrm{Var}_{\\mathbb{P}}(S_{T})$, $\\mathbb{E}_{\\mathbb{Q}}[S_{T}]$, and $\\mathrm{Var}_{\\mathbb{Q}}(S_{T})$.\n\n### Step 2: Validate Using Extracted Givens\n-   **Scientifically Grounded**: The problem describes the Black-Scholes-Merton model, a fundamental and well-established framework in financial mathematics. The use of Itô calculus, geometric Brownian motion, and change of measure techniques are standard concepts. The problem is scientifically sound.\n-   **Well-Posed**: The problem is fully specified with all necessary parameters ($\\mu, \\sigma, r, S_0$) and initial conditions. The objectives are clearly defined. The SDE has a unique, stable solution. The problem is well-posed.\n-   **Objective**: The problem is stated in precise mathematical terms, free of any subjectivity or ambiguity.\n\n### Step 3: Verdict and Action\nThe problem is valid. A full solution will be provided.\n\n### Derivation of the Pathwise Solution\nThe SDE for the asset price $S_t$ under the physical measure $\\mathbb{P}$ is a geometric Brownian motion:\n$$\n\\mathrm{d}S_{t}=\\mu S_{t}\\,\\mathrm{d}t+\\sigma S_{t}\\,\\mathrm{d}W_{t}^{\\mathbb{P}}\n$$\nTo find the explicit solution for $S_t$, we apply Itô's lemma to the function $f(S_t) = \\ln(S_t)$. The partial derivatives of $f(S_t)$ are:\n$$\n\\frac{\\partial f}{\\partial t} = 0, \\quad \\frac{\\partial f}{\\partial S_t} = \\frac{1}{S_t}, \\quad \\frac{\\partial^2 f}{\\partial S_t^2} = -\\frac{1}{S_t^2}\n$$\nAccording to Itô's lemma, the differential of $X_t = f(S_t) = \\ln(S_t)$ is given by:\n$$\n\\mathrm{d}X_t = \\left( \\frac{\\partial f}{\\partial t} + \\mu S_t \\frac{\\partial f}{\\partial S_t} + \\frac{1}{2} (\\sigma S_t)^2 \\frac{\\partial^2 f}{\\partial S_t^2} \\right) \\mathrm{d}t + \\sigma S_t \\frac{\\partial f}{\\partial S_t} \\mathrm{d}W_t^{\\mathbb{P}}\n$$\nSubstituting the partial derivatives, we obtain:\n$$\n\\mathrm{d}(\\ln S_t) = \\left( 0 + \\mu S_t \\left(\\frac{1}{S_t}\\right) + \\frac{1}{2} \\sigma^2 S_t^2 \\left(-\\frac{1}{S_t^2}\\right) \\right) \\mathrm{d}t + \\sigma S_t \\left(\\frac{1}{S_t}\\right) \\mathrm{d}W_t^{\\mathbb{P}}\n$$\n$$\n\\mathrm{d}(\\ln S_t) = \\left(\\mu - \\frac{1}{2}\\sigma^2\\right) \\mathrm{d}t + \\sigma \\mathrm{d}W_t^{\\mathbb{P}}\n$$\nThis is an arithmetic Brownian motion for $\\ln(S_t)$. We integrate this SDE from $t=0$ to $t=T$:\n$$\n\\int_0^T \\mathrm{d}(\\ln S_t) = \\int_0^T \\left(\\mu - \\frac{1}{2}\\sigma^2\\right) \\mathrm{d}t + \\int_0^T \\sigma \\mathrm{d}W_t^{\\mathbb{P}}\n$$\n$$\n\\ln(S_T) - \\ln(S_0) = \\left(\\mu - \\frac{1}{2}\\sigma^2\\right)T + \\sigma (W_T^{\\mathbb{P}} - W_0^{\\mathbb{P}})\n$$\nSince $W_0^{\\mathbb{P}} = 0$ for a standard Brownian motion, we have:\n$$\n\\ln(S_T) = \\ln(S_0) + \\left(\\mu - \\frac{1}{2}\\sigma^2\\right)T + \\sigma W_T^{\\mathbb{P}}\n$$\nExponentiating both sides yields the pathwise solution for $S_T$:\n$$\nS_T = S_0 \\exp\\left(\\left(\\mu - \\frac{1}{2}\\sigma^2\\right)T + \\sigma W_T^{\\mathbb{P}}\\right)\n$$\n\n### Moments under the Physical Measure $\\mathbb{P}$\nUnder the measure $\\mathbb{P}$, the random variable $W_T^{\\mathbb{P}}$ is normally distributed with mean $0$ and variance $T$, i.e., $W_T^{\\mathbb{P}} \\sim N(0, T)$. Consequently, $\\ln(S_T)$ is a normally distributed random variable:\n$$\n\\ln(S_T) \\sim N\\left(\\ln(S_0) + \\left(\\mu - \\frac{1}{2}\\sigma^2\\right)T, \\sigma^2 T\\right)\n$$\nThis implies that $S_T$ follows a log-normal distribution. For a log-normally distributed random variable $Y = \\exp(Z)$ where $Z \\sim N(m, s^2)$, the first two moments are given by:\n$$\n\\mathbb{E}[Y] = \\exp\\left(m + \\frac{1}{2}s^2\\right)\n$$\n$$\n\\mathrm{Var}(Y) = (\\exp(s^2)-1)\\exp(2m+s^2) = (\\mathbb{E}[Y])^2(\\exp(s^2)-1)\n$$\nFor $S_T$ under $\\mathbb{P}$, we identify $m = \\ln(S_0) + (\\mu - \\frac{1}{2}\\sigma^2)T$ and $s^2 = \\sigma^2 T$.\nThe expectation $\\mathbb{E}_{\\mathbb{P}}[S_T]$ is:\n$$\n\\mathbb{E}_{\\mathbb{P}}[S_T] = \\exp\\left( \\ln(S_0) + \\left(\\mu - \\frac{1}{2}\\sigma^2\\right)T + \\frac{1}{2}\\sigma^2 T \\right) = \\exp(\\ln(S_0) + \\mu T) = S_0 \\exp(\\mu T)\n$$\nThe variance $\\mathrm{Var}_{\\mathbb{P}}(S_T)$ is:\n$$\n\\mathrm{Var}_{\\mathbb{P}}(S_T) = (\\mathbb{E}_{\\mathbb{P}}[S_T])^2 (\\exp(s^2)-1) = (S_0 \\exp(\\mu T))^2 (\\exp(\\sigma^2 T) - 1) = S_0^2 \\exp(2\\mu T) (\\exp(\\sigma^2 T) - 1)\n$$\n\n### Moments under the Risk-Neutral Measure $\\mathbb{Q}$\nThe SDE for $S_t$ under the risk-neutral measure $\\mathbb{Q}$ is given as:\n$$\n\\mathrm{d}S_{t}=r S_{t}\\,\\mathrm{d}t+\\sigma S_{t}\\,\\mathrm{d}W_{t}^{\\mathbb{Q}}\n$$\nThis equation has the same form as the SDE under $\\mathbb{P}$, with the drift parameter $\\mu$ replaced by the risk-free rate $r$. The process $\\{W_{t}^{\\mathbb{Q}}\\}_{t \\geq 0}$ is a standard Brownian motion under $\\mathbb{Q}$, so $W_T^{\\mathbb{Q}} \\sim N(0, T)$ under $\\mathbb{Q}$.\nBy direct analogy, the pathwise solution for $S_T$ expressed in terms of the $\\mathbb{Q}$-Brownian motion is:\n$$\nS_T = S_0 \\exp\\left(\\left(r - \\frac{1}{2}\\sigma^2\\right)T + \\sigma W_T^{\\mathbb{Q}}\\right)\n$$\nAnd the distribution of $\\ln(S_T)$ under $\\mathbb{Q}$ is:\n$$\n\\ln(S_T) \\sim N\\left(\\ln(S_0) + \\left(r - \\frac{1}{2}\\sigma^2\\right)T, \\sigma^2 T\\right)\n$$\nTo compute the moments under $\\mathbb{Q}$, we can use the same formulas as before, simply replacing $\\mu$ with $r$.\nThe expectation $\\mathbb{E}_{\\mathbb{Q}}[S_T]$ is:\n$$\n\\mathbb{E}_{\\mathbb{Q}}[S_T] = S_0 \\exp(r T)\n$$\nThe variance $\\mathrm{Var}_{\\mathbb{Q}}(S_T)$ is:\n$$\n\\mathrm{Var}_{\\mathbb{Q}}(S_T) = (\\mathbb{E}_{\\mathbb{Q}}[S_T])^2 (\\exp(\\sigma^2 T)-1) = (S_0 \\exp(r T))^2 (\\exp(\\sigma^2 T) - 1) = S_0^2 \\exp(2r T) (\\exp(\\sigma^2 T) - 1)\n$$\nThese four quantities constitute the final answer.", "answer": "$$\n\\boxed{\\begin{pmatrix} S_0 \\exp(\\mu T)  S_0^2 \\exp(2\\mu T) (\\exp(\\sigma^2 T) - 1)  S_0 \\exp(r T)  S_0^2 \\exp(2r T) (\\exp(\\sigma^2 T) - 1) \\end{pmatrix}}\n$$", "id": "3321531"}, {"introduction": "A central challenge in Monte Carlo simulation is managing statistical error to obtain reliable estimates efficiently. This practice moves from understanding the model to actively improving the simulation's performance through variance reduction. You will derive the control variate method from first principles, learning how to leverage a correlated instrument with a known analytical price (like a standard European option) to significantly reduce the variance of an estimator for a more complex derivative. [@problem_id:3321573]", "problem": "Consider a financial market under the risk-neutral measure where the underlying asset price process $\\{S_{t}\\}_{t \\in [0,T]}$ follows geometric Brownian motion with dynamics $dS_{t} = r S_{t}\\,dt + \\sigma S_{t}\\,dW_{t}$, where $S_{0} \\gt 0$, the risk-free rate $r \\ge 0$, volatility $\\sigma \\gt 0$, and maturity $T \\gt 0$ are constants, and $\\{W_{t}\\}$ is a standard Brownian motion. Let $K \\gt 0$ be a fixed strike. Define the discounted target payoff $Y := \\exp(-rT)\\,g(S_{T})$ for a given Borel-measurable payoff function $g:\\mathbb{R}_{+}\\to\\mathbb{R}_{+}$ with at most polynomial growth. You are asked to price the derivative with value $V := \\mathbb{E}[Y]$ by Monte Carlo simulation of $\\{S_{T}\\}$.\n\nTo reduce variance using the control variate method, you decide to use as control the discounted European call payoff $X := \\exp(-rT)\\,(S_{T}-K)_{+}$, whose risk-neutral expectation is known in closed form from the Black–Scholes formula. Denote this known quantity by $C_{\\mathrm{BS}}(S_{0},K,r,\\sigma,T)$.\n\nStarting only from the definitions of unbiased Monte Carlo estimation, variance, covariance, and correlation, and from the geometric Brownian motion model and risk-neutral pricing principle stated above (no additional special-purpose variance reduction formulas may be assumed), do the following:\n\n- Construct an unbiased control variate estimator for $V$ that uses $X$ and $C_{\\mathrm{BS}}(S_{0},K,r,\\sigma,T)$.\n- Derive the coefficient that minimizes the variance of the single-sample controlled variable, expressed in terms of covariance and variance of $Y$ and $X$.\n- Express the ratio of the minimized variance of the controlled variable to the variance of $Y$ purely in terms of the correlation between $Y$ and $X$.\n\nYour final answer must be a single closed-form analytic expression or a single row of closed-form analytic expressions. No numerical approximation is required, and no units are needed in the final answer. If you provide multiple expressions, present them as a single row matrix.", "solution": "The problem statement has been validated and is deemed valid. It is scientifically grounded in the established principles of financial mathematics and stochastic calculus (Black-Scholes model, risk-neutral pricing), and is a well-posed, objective problem in the field of Monte Carlo methods. The problem provides a self-contained and consistent setup, allowing for a rigorous mathematical derivation from first principles as requested.\n\nThe task is to perform three derivations related to the control variate variance reduction technique in the context of Monte Carlo pricing. Let $Y := \\exp(-rT)\\,g(S_{T})$ be the discounted target payoff and $X := \\exp(-rT)\\,(S_{T}-K)_{+}$ be the discounted control payoff. We are given their expectations $V = \\mathbb{E}[Y]$ (the quantity to be estimated) and $\\mathbb{E}[X] = C_{\\mathrm{BS}}(S_{0},K,r,\\sigma,T)$ (the known value).\n\nFirst, we construct the control variate estimator. The core idea of the control variate method is to construct a new estimator for $V$ using the known information about $X$. We define a new random variable, the controlled variable, denoted $Y_c(\\beta)$, as a linear combination of $Y$ and the centered control variable $(X - \\mathbb{E}[X])$. For an arbitrary real coefficient $\\beta$, this is:\n$$\nY_c(\\beta) = Y - \\beta (X - \\mathbb{E}[X])\n$$\nUsing the notation provided in the problem, where $\\mathbb{E}[X]$ is known as $C_{\\mathrm{BS}}$, the constructed variable is:\n$$\nY_c(\\beta) = Y - \\beta (X - C_{\\mathrm{BS}})\n$$\nTo be a valid estimator for $V = \\mathbb{E}[Y]$, this new random variable must be unbiased, meaning its expectation must be $V$. We verify this using the linearity of the expectation operator:\n$$\n\\mathbb{E}[Y_c(\\beta)] = \\mathbb{E}[Y - \\beta (X - C_{\\mathrm{BS}})] = \\mathbb{E}[Y] - \\beta \\mathbb{E}[X - C_{\\mathrm{BS}}]\n$$\n$$\n\\mathbb{E}[Y_c(\\beta)] = \\mathbb{E}[Y] - \\beta (\\mathbb{E}[X] - \\mathbb{E}[C_{\\mathrm{BS}}])\n$$\nSince $C_{\\mathrm{BS}}$ is a constant representing the true expectation of $X$, we have $\\mathbb{E}[X] = C_{\\mathrm{BS}}$ and $\\mathbb{E}[C_{\\mathrm{BS}}] = C_{\\mathrm{BS}}$. Substituting these in gives:\n$$\n\\mathbb{E}[Y_c(\\beta)] = V - \\beta (C_{\\mathrm{BS}} - C_{\\mathrm{BS}}) = V - 0 = V\n$$\nThis confirms that $Y_c(\\beta)$ is an unbiased estimator of $V$ for any choice of the constant coefficient $\\beta$. This completes the construction of the estimator. A Monte Carlo estimate of $V$ would then be formed by taking the sample mean of $N$ independent realizations of $Y_c(\\beta)$.\n\nSecond, we derive the coefficient $\\beta^*$ that minimizes the variance of the estimator. The efficiency of a Monte Carlo estimator is determined by its variance. We seek to choose $\\beta$ to minimize $\\mathrm{Var}(Y_c(\\beta))$.\nThe variance of the controlled variable is:\n$$\n\\mathrm{Var}(Y_c(\\beta)) = \\mathrm{Var}(Y - \\beta (X - C_{\\mathrm{BS}}))\n$$\nSince adding or subtracting a constant ($-\\beta C_{\\mathrm{BS}}$) does not affect variance, this simplifies to:\n$$\n\\mathrm{Var(Y_c(\\beta))} = \\mathrm{Var}(Y - \\beta X)\n$$\nUsing the standard formula for the variance of a linear combination of two random variables, $\\mathrm{Var}(A - B) = \\mathrm{Var}(A) + \\mathrm{Var}(B) - 2\\mathrm{Cov}(A,B)$, we get:\n$$\n\\mathrm{Var}(Y_c(\\beta)) = \\mathrm{Var}(Y) + \\mathrm{Var}(\\beta X) - 2\\mathrm{Cov}(Y, \\beta X)\n$$\nUsing the properties $\\mathrm{Var}(cZ) = c^2\\mathrm{Var}(Z)$ and $\\mathrm{Cov}(Z_1, cZ_2) = c\\mathrm{Cov}(Z_1, Z_2)$ for a constant $c$:\n$$\n\\mathrm{Var}(Y_c(\\beta)) = \\mathrm{Var}(Y) + \\beta^2 \\mathrm{Var}(X) - 2\\beta \\mathrm{Cov}(Y, X)\n$$\nThis expression is a quadratic function of $\\beta$. To find the value $\\beta^*$ that minimizes this variance, we take the first derivative with respect to $\\beta$ and set it to zero:\n$$\n\\frac{d}{d\\beta} \\mathrm{Var}(Y_c(\\beta)) = 2\\beta \\mathrm{Var}(X) - 2\\mathrm{Cov}(Y, X)\n$$\nSetting the derivative to zero for the optimal coefficient $\\beta^*$:\n$$\n2\\beta^* \\mathrm{Var}(X) - 2\\mathrm{Cov}(Y, X) = 0\n$$\nSolving for $\\beta^*$, we obtain:\n$$\n\\beta^* = \\frac{\\mathrm{Cov}(Y, X)}{\\mathrm{Var}(X)}\n$$\nThe second derivative, $\\frac{d^2}{d\\beta^2}\\mathrm{Var}(Y_c(\\beta)) = 2\\mathrm{Var}(X)$, is positive because $\\sigma  0$ implies that $S_T$ is a non-degenerate random variable, and thus the payoff $X = \\exp(-rT)(S_T - K)_{+}$ has positive variance. This confirms that $\\beta^*$ corresponds to a minimum.\n\nThird, we express the ratio of the minimized variance to the original variance in terms of the correlation between $Y$ and $X$. The minimized variance is $\\mathrm{Var}(Y_c(\\beta^*))$. We substitute the expression for $\\beta^*$ into the variance formula:\n$$\n\\mathrm{Var}(Y_c(\\beta^*)) = \\mathrm{Var}(Y) + (\\beta^*)^2 \\mathrm{Var}(X) - 2\\beta^* \\mathrm{Cov}(Y, X)\n$$\n$$\n\\mathrm{Var}(Y_c(\\beta^*)) = \\mathrm{Var}(Y) + \\left(\\frac{\\mathrm{Cov}(Y, X)}{\\mathrm{Var}(X)}\\right)^2 \\mathrm{Var}(X) - 2 \\left(\\frac{\\mathrm{Cov}(Y, X)}{\\mathrm{Var}(X)}\\right) \\mathrm{Cov}(Y, X)\n$$\n$$\n\\mathrm{Var}(Y_c(\\beta^*)) = \\mathrm{Var}(Y) + \\frac{\\mathrm{Cov}(Y, X)^2}{\\mathrm{Var}(X)} - 2\\frac{\\mathrm{Cov}(Y, X)^2}{\\mathrm{Var}(X)}\n$$\n$$\n\\mathrm{Var}(Y_c(\\beta^*)) = \\mathrm{Var}(Y) - \\frac{\\mathrm{Cov}(Y, X)^2}{\\mathrm{Var}(X)}\n$$\nNow, we use the definition of the correlation coefficient $\\rho_{Y,X}$ between $Y$ and $X$:\n$$\n\\rho_{Y,X} = \\frac{\\mathrm{Cov}(Y, X)}{\\sqrt{\\mathrm{Var}(Y)\\mathrm{Var}(X)}}\n$$\nFrom this, we can write $\\mathrm{Cov}(Y, X)^2 = \\rho_{Y,X}^2 \\mathrm{Var}(Y) \\mathrm{Var}(X)$. Substituting this into the expression for the minimized variance yields:\n$$\n\\mathrm{Var}(Y_c(\\beta^*)) = \\mathrm{Var}(Y) - \\frac{\\rho_{Y,X}^2 \\mathrm{Var}(Y) \\mathrm{Var}(X)}{\\mathrm{Var}(X)} = \\mathrm{Var}(Y) - \\rho_{Y,X}^2 \\mathrm{Var}(Y)\n$$\n$$\n\\mathrm{Var}(Y_c(\\beta^*)) = \\mathrm{Var}(Y) (1 - \\rho_{Y,X}^2)\n$$\nThe required ratio of the minimized variance of the controlled variable to the variance of the original variable $Y$ is:\n$$\n\\frac{\\mathrm{Var}(Y_c(\\beta^*))}{\\mathrm{Var}(Y)} = \\frac{\\mathrm{Var}(Y) (1 - \\rho_{Y,X}^2)}{\\mathrm{Var}(Y)} = 1 - \\rho_{Y,X}^2\n$$\nThis result shows that the variance reduction is determined by the square of the correlation between the target payoff and the control variate. A higher absolute correlation $|\\rho_{Y,X}|$ leads to a greater reduction in variance.", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\nY - \\beta(X - C_{\\mathrm{BS}})  \\frac{\\mathrm{Cov}(Y, X)}{\\mathrm{Var}(X)}  1 - \\rho_{Y,X}^2\n\\end{pmatrix}\n}\n$$", "id": "3321573"}, {"introduction": "Beyond statistical variance, a critical source of error in financial simulations is the systematic bias introduced by time discretization, especially for path-dependent options. This hands-on coding practice delves into this issue by having you price Asian and barrier options, where the payoff depends on the entire asset path. You will implement the Richardson extrapolation technique to actively diagnose and correct this discretization bias, gaining practical skills in error analysis and advanced simulation design. [@problem_id:3321511]", "problem": "Consider risk-neutral pricing for a single-asset model where the underlying price process is modeled by Geometric Brownian Motion (GBM). Under the risk-neutral measure, the asset price process satisfies the stochastic differential equation (SDE) $dS_t = r S_t \\, dt + \\sigma S_t \\, dW_t$ with initial value $S_0$, where $r$ is the continuously compounded risk-free rate, $\\sigma$ is the volatility, and $W_t$ is a standard Brownian motion. The exact solution satisfies $S_{t+\\Delta} = S_t \\exp\\left(\\left(r - \\tfrac{1}{2}\\sigma^2\\right)\\Delta + \\sigma \\sqrt{\\Delta} Z\\right)$ with $Z \\sim \\mathcal{N}(0,1)$ independent across time steps.\n\nA European-style contingent claim with maturity $T$ and path-dependent payoff functional $\\Phi$ is priced at time $0$ by $V = \\mathrm{e}^{-rT} \\mathbb{E}[\\Phi(S_{[0,T]})]$, where $\\Phi$ may depend on the whole trajectory $S_{[0,T]}$. In time-discretized Monte Carlo (MC) simulation of path-dependent payoffs, the path is observed on a discrete time grid of mesh size $h = T/N$ and a discrete-time approximation $\\Phi_h$ is used. Define the weak error (bias) as $\\mathbb{E}[\\Phi_h] - \\mathbb{E}[\\Phi]$. A well-tested fact for the weak convergence of time-discretized functionals under GBM is that:\n- For an arithmetic-average Asian option computed by a rectangle-rule average over a uniform time grid, the weak error of the price is $O(h)$, i.e., order $\\alpha = 1$.\n- For an up-and-out barrier option with naive discrete monitoring on a uniform grid (i.e., checking barrier crossings only at grid points, without Brownian bridge correction), the weak error of the price is $O(h^{1/2})$, i.e., order $\\alpha = \\tfrac{1}{2}$, due to the scaling of missed barrier crossings between observation times.\n\nRichardson extrapolation cancels the leading-order weak error if the error admits an expansion $\\mathbb{E}[\\Phi_h] = \\mathbb{E}[\\Phi] + c h^{\\alpha} + o(h^{\\alpha})$ for some constant $c$. Given estimates $P_h$ and $P_{h/r}$ computed with a refinement ratio $r > 1$, the extrapolated estimator that cancels the $h^{\\alpha}$ term is\n$$\nP_{\\mathrm{RE}} = \\frac{r^{\\alpha} P_{h/r} - P_h}{r^{\\alpha} - 1}.\n$$\nYour tasks are:\n- Starting from the GBM model and risk-neutral valuation, explain how weak order $\\alpha$ impacts the bias of time-discretized MC prices for two path-dependent payoffs: an arithmetic-average Asian call and an up-and-out barrier call under naive discrete monitoring.\n- Derive the Richardson extrapolation formula appropriate to the weak order $\\alpha$ and specify how to implement it with common random numbers so that the coarse and fine estimators share the same underlying Brownian path increments in a consistent way.\n- Implement a complete, runnable program that:\n  1. Simulates GBM paths exactly at discrete times using the exact transition with standard normal increments.\n  2. Uses common random numbers between coarse and fine grids by first simulating on the fine grid and then sub-sampling the path to create the coarse grid.\n  3. Prices each payoff via MC with two grid sizes $h$ and $h/2$ (i.e., refinement ratio $r = 2$) and computes the Richardson extrapolation tuned to the correct weak order $\\alpha$ for that payoff.\n  4. Uses risk-neutral discounting $\\mathrm{e}^{-rT}$.\n  5. Produces the final output as specified below.\n\nPayoffs to implement:\n- Arithmetic-average Asian call: $\\Phi_{\\text{Asian}} = \\max\\left(\\frac{1}{N} \\sum_{k=1}^{N} S_{t_k} - K,\\; 0\\right)$ with $t_k = k h$.\n- Up-and-out barrier call with naive discrete monitoring: $\\Phi_{\\text{UO}} = \\mathbf{1}\\{\\max_{k=1,\\dots,N} S_{t_k}  B\\} \\max(S_T - K,\\; 0)$, where $B$ is the barrier level and the indicator checks barrier breach only at discrete observation times.\n\nImplementation requirements:\n- Use a refinement ratio $r = 2$ for Richardson extrapolation.\n- Use common random numbers between the coarse and fine grids. This is implemented by simulating paths on the fine grid, and then constructing the corresponding coarse-grid paths by sub-sampling (i.e., selecting every second point). This ensures the underlying Brownian motion is consistent for both simulations.\n- Use the exact GBM transition for $S_{t+\\Delta}$ at each time step to eliminate SDE discretization error, so that only time-discretization of the path-functional contributes to the bias.\n\nTest suite:\nProvide the following three test cases with fixed Monte Carlo sample size and seeds for reproducibility. For each test, compute three numbers: the coarse-grid price $P_h$, the fine-grid price $P_{h/2}$, and the Richardson-extrapolated price $P_{\\mathrm{RE}}$.\n\n- Test A (arithmetic-average Asian call, order $\\alpha = 1$):\n  - Parameters: $S_0 = 100$, $K = 100$, $r = 0.05$, $\\sigma = 0.2$, $T = 1$, $N_{\\text{coarse}} = 64$, refinement ratio $r = 2$.\n  - Monte Carlo: number of paths $M = 120000$, random seed $= 12345$.\n\n- Test B (up-and-out barrier call, discrete monitoring, order $\\alpha = \\tfrac{1}{2}$):\n  - Parameters: $S_0 = 100$, $K = 100$, $B = 130$, $r = 0.03$, $\\sigma = 0.25$, $T = 1$, $N_{\\text{coarse}} = 64$, refinement ratio $r = 2$.\n  - Monte Carlo: number of paths $M = 120000$, random seed $= 54321$.\n\n- Test C (up-and-out barrier call with an effectively inactive barrier, significant edge case; the option behaves nearly like a vanilla call):\n  - Parameters: $S_0 = 100$, $K = 100$, $B = 1000$, $r = 0.03$, $\\sigma = 0.25$, $T = 1$, $N_{\\text{coarse}} = 64$, refinement ratio $r = 2$.\n  - Monte Carlo: number of paths $M = 120000$, random seed $= 67890$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets.\n- The nine outputs appear in the following order: for Test A output $[P_h, P_{h/2}, P_{\\mathrm{RE}}]$, then for Test B output $[P_h, P_{h/2}, P_{\\mathrm{RE}}]$, then for Test C output $[P_h, P_{h/2}, P_{\\mathrm{RE}}]$, concatenated into a single list of length $9$.\n- All outputs must be floating-point numbers (in monetary units with no special unit conversion), using risk-neutral discounting as specified.", "solution": "The problem is assessed as valid. It is scientifically grounded in the established theory of financial engineering, specifically risk-neutral pricing, stochastic differential equations for asset prices, and Monte Carlo simulation methods. The problem is well-posed, with all necessary parameters and definitions provided. It asks for the derivation and implementation of a standard numerical technique, Richardson extrapolation, applied to well-known path-dependent options. The setup is self-contained, consistent, and objective.\n\n### Theoretical Foundation and Algorithmic Design\n\n#### 1. Risk-Neutral Pricing and Geometric Brownian Motion\n\nIn a risk-neutral world, the price of a derivative is the discounted expected value of its future payoffs. The underlying asset price, $S_t$, is modeled by the Geometric Brownian Motion (GBM) process, described by the stochastic differential equation (SDE):\n$$\ndS_t = r S_t \\, dt + \\sigma S_t \\, dW_t\n$$\nHere, $S_t$ is the asset price at time $t$, $r$ is the constant risk-free interest rate, $\\sigma$ is the constant volatility, and $W_t$ is a standard Wiener process (Brownian motion).\n\nFor Monte Carlo simulation, we need to generate paths of $S_t$ over a discrete time grid $0=t_0, t_1, \\dots, t_N=T$, with a uniform time step of $\\Delta t = T/N$. The exact solution to the SDE allows us to simulate the price at the next time step without introducing any SDE discretization error. Given $S_{t_k}$, the price at the next step $S_{t_{k+1}}$ is given by:\n$$\nS_{t_{k+1}} = S_{t_k} \\exp\\left(\\left(r - \\frac{1}{2}\\sigma^2\\right)\\Delta t + \\sigma \\sqrt{\\Delta t} Z_{k+1}\\right)\n$$\nwhere $Z_1, Z_2, \\dots, Z_N$ are independent and identically distributed standard normal random variables, $Z_k \\sim \\mathcal{N}(0,1)$.\n\nThe price of a European-style contingent claim with maturity $T$ and payoff functional $\\Phi$ is given by the risk-neutral valuation formula:\n$$\nV_0 = e^{-rT} \\mathbb{E}[\\Phi(S_{[0,T]})]\n$$\nwhere $\\mathbb{E}[\\cdot]$ denotes the expectation under the risk-neutral measure.\n\n#### 2. Weak Error in Time-Discretized Payoffs\n\nFor path-dependent options, the payoff functional $\\Phi$ may depend on the entire path $S_{[0,T]}$. In a discrete-time simulation, we approximate $\\Phi$ with a functional $\\Phi_h$ that depends only on the prices at the discrete grid points $\\{S_{t_k}\\}_{k=0}^N$, where $h = T/N$ is the mesh size. This approximation introduces a time-discretization error, also known as bias or weak error, defined as $\\mathbb{E}[\\Phi_h] - \\mathbb{E}[\\Phi]$. The order of this error, $\\alpha$, depends on how the discrete functional $\\Phi_h$ converges to the continuous one $\\Phi$.\n\n- **Arithmetic-Average Asian Call:** The payoff is based on the average price over the path. The continuous-time payoff involves an integral: $\\max(\\frac{1}{T}\\int_0^T S_u du - K, 0)$. The discrete-time approximation uses a sum: $\\Phi_{\\text{Asian}} = \\max(\\frac{1}{N}\\sum_{k=1}^N S_{t_k} - K, 0)$. This sum is a rectangle-rule approximation of the integral. The error of this numerical integration scheme is of order $h$. This translates to a weak convergence order of $\\alpha=1$ for the price estimator, meaning the bias is proportional to $h$.\n\n- **Up-and-Out Barrier Call:** The payoff depends on the maximum price over the path: $\\Phi_{\\text{UO}} = \\mathbf{1}\\{\\sup_{u \\in [0,T]} S_u  B\\} \\max(S_T - K, 0)$. The naive discrete monitoring approach checks the barrier condition only at grid points: $\\Phi_{\\text{UO},h} = \\mathbf{1}\\{\\max_{k=1,\\dots,N} S_{t_k}  B\\} \\max(S_T - K, 0)$. A significant source of error is the possibility that the continuous path $S_u$ crosses the barrier $B$ *between* observation points $t_k$ and $t_{k+1}$ without being detected. The probability of such an undetected crossing over a small interval of length $h$ scales with $\\sqrt{h}$. This leads to a systematic underestimation of the true knock-out probability, and thus an overestimation of the option price. The resulting weak convergence order is $\\alpha = 1/2$, meaning the bias is proportional to $\\sqrt{h}$.\n\n#### 3. Richardson Extrapolation\n\nRichardson extrapolation is a technique to improve the accuracy of a numerical approximation by canceling the leading-order error term. Assume the expected value of the discretized-payoff estimator, $P_h = e^{-rT}\\mathbb{E}[\\Phi_h]$, admits an error expansion in powers of the step size $h$:\n$$\nP_h = V_0 + c h^{\\alpha} + O(h^{\\beta}) \\quad \\text{with } \\beta  \\alpha\n$$\nwhere $V_0$ is the true price, $c$ is a constant, and $\\alpha$ is the weak order of convergence.\n\nWe can compute the price using two different step sizes: a coarse step $h$ and a fine step $h/r$ for some refinement ratio $r > 1$. Let $P_h$ and $P_{h/r}$ be the corresponding price estimates from our Monte Carlo simulation. We have the following system of approximate equations:\n\\begin{align*}\nP_h \\approx V_0 + c h^{\\alpha} \\quad (1) \\\\\nP_{h/r} \\approx V_0 + c \\left(\\frac{h}{r}\\right)^{\\alpha} = V_0 + \\frac{c}{r^{\\alpha}} h^{\\alpha} \\quad (2)\n\\end{align*}\nOur goal is to eliminate the unknown error term $c h^{\\alpha}$ to obtain a better estimate for $V_0$. We multiply equation $(2)$ by $r^{\\alpha}$:\n$$\nr^{\\alpha} P_{h/r} \\approx r^{\\alpha} V_0 + c h^{\\alpha} \\quad (3)\n$$\nSubtracting equation $(1)$ from $(3)$ yields:\n$$\nr^{\\alpha} P_{h/r} - P_h \\approx (r^{\\alpha} - 1) V_0\n$$\nSolving for $V_0$ gives the Richardson-extrapolated estimator, $P_{\\mathrm{RE}}$:\n$$\nP_{\\mathrm{RE}} = \\frac{r^{\\alpha} P_{h/r} - P_h}{r^{\\alpha} - 1}\n$$\nThis estimator has a higher order of accuracy, with its leading error term being $O(h^{\\beta})$. The formula critically depends on the correct weak convergence order $\\alpha$. For the Asian call, we use $\\alpha=1$. For the discretely monitored barrier option, we use $\\alpha=1/2$. The refinement ratio specified is $r=2$.\n\n#### 4. Implementation with Common Random Numbers (CRN)\n\nThe effectiveness of Richardson extrapolation depends on having accurate estimates of $P_h$ and $P_{h/r}$. To reduce the variance of the combined estimator $P_{\\mathrm{RE}}$, it is crucial to use Common Random Numbers (CRN). This technique ensures that the difference $P_{h/r} - P_h$ has a small variance by using the same underlying source of randomness to generate paths for both the coarse and fine grids.\n\nWe first generate a set of $N_{\\text{fine}}$ standard normal variates, $\\{Z_k\\}_{k=1}^{N_{\\text{fine}}}$, for each of the $M$ Monte Carlo paths. Here, $N_{\\text{fine}} = r \\times N_{\\text{coarse}}$. In our case, $r=2$, so $N_{\\text{fine}} = 2 N_{\\text{coarse}}$.\n\n1.  **Fine Path Simulation:** A full path with $N_{\\text{fine}}$ steps is simulated using the exact GBM transition formula with step size $h_{\\text{fine}} = T/N_{\\text{fine}}$ and the random variates $Z_k$. Let this path be $\\{S_{t_k}^{\\text{fine}}\\}_{k=0}^{N_{\\text{fine}}}$.\n\n2.  **Coarse Path Construction:** The coarse path is constructed consistently from the fine path. A coarse time step $h_{\\text{coarse}} = T/N_{\\text{coarse}} = r h_{\\text{fine}}$ corresponds to $r$ fine steps. The asset price at a coarse grid point $t'_j = j h_{\\text{coarse}}$ is simply the price at the corresponding fine grid point $t_k$ where $k=j \\times r$. Therefore, we can obtain the coarse path by simply selecting every $r$-th point from the simulated fine path: $\\{S_{t'_j}^{\\text{coarse}}\\} = \\{S_{t_{j \\times r}}^{\\text{fine}}\\}$. For $r=2$, this means `S_coarse = S_fine[::2]`. This correctly implements the CRN scheme where the Brownian increment for a coarse step is the scaled sum of the underlying fine-step increments, ensuring that the terminal price $S_T$ is identical for both paths, a key property of CRN.\n\nAfter simulating $M$ pairs of (coarse, fine) paths, we compute the average payoffs, discount them to get the price estimates $P_h$ and $P_{h/2}$, and finally apply the appropriate Richardson extrapolation formula to compute $P_{\\mathrm{RE}}$.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef price_with_richardson(\n    S0, K, r, sigma, T,\n    N_coarse, B, M, seed,\n    option_type, alpha\n):\n    \"\"\"\n    Prices a path-dependent option using Monte Carlo simulation with two grid sizes\n    and applies Richardson extrapolation to reduce the weak error (bias).\n\n    Args:\n        S0 (float): Initial stock price.\n        K (float): Strike price.\n        r (float): Risk-free interest rate.\n        sigma (float): Volatility.\n        T (float): Time to maturity.\n        N_coarse (int): Number of time steps for the coarse grid.\n        B (float or None): Barrier level for barrier options.\n        M (int): Number of Monte Carlo paths.\n        seed (int): Random seed for reproducibility.\n        option_type (str): Type of option ('asian_call' or 'barrier_call').\n        alpha (float): Weak convergence order.\n\n    Returns:\n        tuple[float, float, float]: A tuple containing the coarse-grid price,\n                                     the fine-grid price, and the Richardson-\n                                     extrapolated price.\n    \"\"\"\n    rng = np.random.default_rng(seed)\n    \n    # Grid parameters\n    refinement_ratio = 2\n    N_fine = refinement_ratio * N_coarse\n    h_fine = T / N_fine\n\n    # Generate all standard normal random numbers for all fine paths at once\n    Z = rng.standard_normal(size=(M, N_fine))\n\n    # --- Simulate all fine paths in a vectorized manner ---\n    # We use the exact log-normal solution for GBM\n    S_fine = np.zeros((M, N_fine + 1))\n    S_fine[:, 0] = S0\n    \n    # Calculate log-returns for each step\n    drift = (r - 0.5 * sigma**2) * h_fine\n    diffusion = sigma * np.sqrt(h_fine)\n    log_returns = drift + diffusion * Z\n    \n    # Cumulatively sum log-returns to get log-path, then exponentiate\n    log_paths = np.cumsum(log_returns, axis=1)\n    S_fine[:, 1:] = S0 * np.exp(log_paths)\n\n    # --- Extract coarse paths using Common Random Numbers (CRN) ---\n    # The coarse path consists of every `refinement_ratio`-th point of the fine path.\n    # This correctly implements CRN as the Brownian increments are nested.\n    S_coarse = S_fine[:, ::refinement_ratio]\n    \n    # --- Calculate payoffs for both grids ---\n    # Per problem definition, path-dependent features (avg, max) are computed\n    # over the discrete observation points t_1, ..., t_N.\n    # This corresponds to array slices [:, 1:].\n    \n    if option_type == 'asian_call':\n        # Fine grid payoff\n        avg_fine = np.mean(S_fine[:, 1:], axis=1)\n        payoff_fine = np.maximum(avg_fine - K, 0)\n        # Coarse grid payoff\n        avg_coarse = np.mean(S_coarse[:, 1:], axis=1)\n        payoff_coarse = np.maximum(avg_coarse - K, 0)\n    \n    elif option_type == 'barrier_call':\n        # Fine grid payoff\n        max_fine = np.max(S_fine[:, 1:], axis=1)\n        indicator_fine = (max_fine  B)\n        # Payoff is based on terminal price S_T = S_fine[:, -1]\n        payoff_fine = np.maximum(S_fine[:, -1] - K, 0) * indicator_fine\n        \n        # Coarse grid payoff\n        max_coarse = np.max(S_coarse[:, 1:], axis=1)\n        indicator_coarse = (max_coarse  B)\n        # Terminal price is identical due to CRN: S_coarse[:, -1] == S_fine[:, -1]\n        payoff_coarse = np.maximum(S_coarse[:, -1] - K, 0) * indicator_coarse\n    else:\n        raise ValueError(\"Unknown option type specified.\")\n\n    # --- Calculate discounted expected payoffs (prices) ---\n    discount_factor = np.exp(-r * T)\n    P_coarse = discount_factor * np.mean(payoff_coarse) # This is P_h\n    P_fine = discount_factor * np.mean(payoff_fine)     # This is P_{h/r}\n    \n    # --- Richardson Extrapolation ---\n    # P_RE = (r^alpha * P_{h/r} - P_h) / (r^alpha - 1)\n    P_RE = (refinement_ratio**alpha * P_fine - P_coarse) / (refinement_ratio**alpha - 1)\n    \n    return P_coarse, P_fine, P_RE\n\ndef solve():\n    \"\"\"\n    Main function to run the test cases and print the final results.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test A: Arithmetic-average Asian call, weak order alpha = 1.0\n        {'S0': 100, 'K': 100, 'r': 0.05, 'sigma': 0.2, 'T': 1, 'N_coarse': 64, \n         'B': None, 'M': 120000, 'seed': 12345, 'option_type': 'asian_call', 'alpha': 1.0},\n        \n        # Test B: Up-and-out barrier call, discrete monitoring, weak order alpha = 0.5\n        {'S0': 100, 'K': 100, 'B': 130, 'r': 0.03, 'sigma': 0.25, 'T': 1, 'N_coarse': 64, \n         'M': 120000, 'seed': 54321, 'option_type': 'barrier_call', 'alpha': 0.5},\n        \n        # Test C: Up-and-out barrier call, effectively inactive barrier, alpha = 0.5\n        {'S0': 100, 'K': 100, 'B': 1000, 'r': 0.03, 'sigma': 0.25, 'T': 1, 'N_coarse': 64, \n         'M': 120000, 'seed': 67890, 'option_type': 'barrier_call', 'alpha': 0.5},\n    ]\n\n    results = []\n    for params in test_cases:\n        p_coarse, p_fine, p_re = price_with_richardson(**params)\n        results.extend([p_coarse, p_fine, p_re])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3321511"}]}