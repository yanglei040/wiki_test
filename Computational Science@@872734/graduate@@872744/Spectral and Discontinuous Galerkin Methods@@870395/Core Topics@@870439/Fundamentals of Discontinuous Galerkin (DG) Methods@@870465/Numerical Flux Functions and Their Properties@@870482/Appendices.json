{"hands_on_practices": [{"introduction": "The theoretical properties of a numerical scheme, such as stability and dissipation, are directly encoded in the eigenvalue spectrum of its semi-discrete operator. This practice offers a hands-on computational approach to understanding these properties by numerically constructing the Discontinuous Galerkin (DG) operator for the linear advection equation. By varying the numerical flux from a non-dissipative central flux to a dissipative upwind flux [@problem_id:3405180], you will directly observe how the choice of flux impacts the location of the operator's eigenvalues, providing a concrete visualization of numerical dissipation.", "problem": "Consider the one-dimensional linear advection equation $u_t + a u_x = 0$ on a periodic domain of length $L = 1$ with constant advection speed $a = 1$. Use a nodal Discontinuous Galerkin Spectral Element Method (DGSEM) with Legendre–Gauss–Lobatto (LGL) points per element, enforcing the Summation-By-Parts (SBP) property. The semi-discrete DGSEM operator is constructed on a uniform mesh of $K$ elements, each of size $h = L/K$, using a reference element mapping and strong-form collocation differentiation. Numerical fluxes at interfaces are taken as a one-parameter family:\n$$\n\\widehat{f}(u^-, u^+) = a \\left( \\tfrac{1}{2} (u^- + u^+) - \\tfrac{\\alpha}{2} (u^+ - u^-) \\right),\n$$\nwhere $u^-$ and $u^+$ are the left and right interface traces, and $\\alpha \\in [0,1]$ is the interface jump penalization strength. Special cases are $\\alpha = 0$ (central), $\\alpha = 1$ (upwind), and intermediate $\\alpha$ corresponding to skew-symmetric split-form fluxes with local Lax–Friedrichs penalization.\n\nYour task is to:\n1. Derive from the DG weak form and the SBP property a semi-discrete matrix operator $\\mathbf{L}(\\alpha, p, K)$ such that the global degrees of freedom vector $\\mathbf{u}$ satisfies $\\frac{d\\mathbf{u}}{dt} = \\mathbf{L}(\\alpha, p, K) \\mathbf{u}$. Here $p$ is the per-element polynomial degree, and the nodal basis consists of $p+1$ LGL nodes on each element.\n2. For each $\\alpha$, compute the eigenvalues of $\\mathbf{L}(\\alpha, p, K)$ and analyze how the real and imaginary parts of the spectrum depend on $p$ and $\\alpha$. In particular, identify “outlier” eigenmodes whose real parts lie significantly below the bulk of the spectrum, and quantify how their magnitude scales with the interface penalization strength $\\alpha$.\n\nUse the following foundational base for your derivation and construction:\n- The DG weak form on each element with interface numerical fluxes replacing physical fluxes at element boundaries.\n- The mapping from the physical coordinate $x$ to the reference coordinate $\\xi \\in [-1,1]$ with $x = x_e + \\frac{h}{2}\\xi$ and $u_x = \\frac{2}{h} u_\\xi$.\n- Nodal collocation at the LGL points, with a diagonal mass matrix based on LGL quadrature weights and a differentiation matrix obtained from the Lagrange basis derivatives at LGL nodes.\n- The Summation-By-Parts (SBP) property for the LGL differentiation and quadrature pair, which ensures energy stability for central fluxes and controls dissipation for penalized fluxes.\n\nNumerical and algorithmic requirements:\n- Use $K = 8$ elements with periodic boundary conditions.\n- For each $p \\in \\{1,2,4\\}$ and each $\\alpha \\in \\{0.0, 0.5, 1.0\\}$, assemble $\\mathbf{L}(\\alpha, p, K)$ and compute all eigenvalues.\n- Define outliers using a threshold\n$$\n\\theta = \\min\\left( \\mu_{\\Re} - 2 \\sigma_{\\Re}, -10^{-8} \\right),\n$$\nwhere $\\mu_{\\Re}$ and $\\sigma_{\\Re}$ are the mean and the standard deviation of the real parts of the eigenvalues. Count outliers as those eigenvalues whose real parts are strictly less than $\\theta$.\n- For each $p$, compute the Pearson correlation coefficient between the list of $\\alpha$ values $[0.0, 0.5, 1.0]$ and the corresponding list of minimum real parts of the eigenvalues $\\left[\\min \\Re(\\lambda(\\alpha))\\right]$. This coefficient quantifies how strengthening interface penalization pushes the most dissipative modes further left in the complex plane.\n- For each $p$, also compute $\\Delta_{\\min} = \\min \\Re(\\lambda(\\alpha{=}1.0)) - \\min \\Re(\\lambda(\\alpha{=}0.0))$, and the outlier count at $\\alpha = 1.0$.\n\nTest suite:\n- Element count $K = 8$, domain length $L = 1$, advection speed $a = 1$.\n- Polynomial degrees $p \\in \\{1, 2, 4\\}$.\n- Penalization strengths $\\alpha \\in \\{0.0, 0.5, 1.0\\}$.\n\nRequired final output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. For each $p$ in ascending order, append the triplet\n  - the correlation coefficient (float) between $\\alpha$ and $\\min \\Re(\\lambda)$,\n  - the value $\\Delta_{\\min}$ (float),\n  - the outlier count at $\\alpha = 1.0$ (integer).\n- Therefore, the final output must contain $3$ triplets in order $p = 1$, $p = 2$, $p = 4$, resulting in a list of $9$ entries overall, for example: \n\"[corr_p1,delta_p1,count_p1,corr_p2,delta_p2,count_p2,corr_p4,delta_p4,count_p4]\".", "solution": "The problem posed is a well-defined and standard task in the numerical analysis of partial differential equations, specifically concerning the spectral properties of a Discontinuous Galerkin Spectral Element Method (DGSEM) for the linear advection equation. All parameters and methodologies, such as the equation, domain, DGSEM formulation, Legendre-Gauss-Lobatto (LGL) nodes, Summation-By-Parts (SBP) property, and the definition of the numerical flux, are standard and correctly specified. The problem is scientifically grounded, self-contained, and algorithmically tractable. We may therefore proceed with the derivation and solution.\n\nOur objective is to construct the semi-discrete matrix operator $\\mathbf{L}(\\alpha, p, K)$ for the one-dimensional linear advection equation $u_t + a u_x = 0$ and analyze its eigenvalues. The domain is periodic of length $L=1$, discretized into $K$ uniform elements of size $h=L/K$. The advection speed is $a=1$. The solution within each element is approximated by a polynomial of degree $p$ in a nodal basis defined by the $p+1$ LGL points.\n\nWe begin with the strong-form DGSEM formulation. On each element $k$, we collocate the PDE at the $p+1$ LGL nodes. Let $\\mathbf{u}_k$ be the vector of solution values at the LGL nodes within element $k$. The time derivative of the solution at these nodes is given by the spatial operator applied to the solution, plus correction terms for the interface fluxes. The spatial derivative $u_x$ is mapped to the reference element $\\xi \\in [-1, 1]$ via $u_x = \\frac{2}{h} u_\\xi$. The derivative $u_\\xi$ at the nodes is approximated by matrix-vector multiplication with the LGL differentiation matrix, $\\mathbf{D}$.\n\nThe semi-discrete equation for the degrees of freedom in element $k$, $\\mathbf{u}_k$, is\n$$\n\\frac{d\\mathbf{u}_k}{dt} = -a \\frac{2}{h} \\mathbf{D} \\mathbf{u}_k + \\mathbf{C}_k\n$$\nwhere $\\mathbf{C}_k$ is a correction vector that enforces the user-defined numerical flux at the element interfaces. This correction only affects the boundary nodes of the element, which for LGL points are the first node ($\\xi_0 = -1$) and the last node ($\\xi_p = 1$). The correction term for a node $i$ is derived from the difference between the numerical flux and the physical flux, scaled by the inverse of the corresponding mass matrix entry. For a diagonal mass matrix $\\mathbf{M} = \\text{diag}(w_0, \\dots, w_p)$ (scaled by the Jacobian $h/2$), the update for node $i$ is:\n$$\n\\frac{du_{i,k}}{dt} = -a \\frac{2}{h} (\\mathbf{D} \\mathbf{u}_k)_i - \\frac{2}{h} \\frac{1}{w_i} \\left[ \\delta_{ip} (\\widehat{f}(u_p^k, u_0^{k+1}) - f(u_p^k)) - \\delta_{i0} (\\widehat{f}(u_p^{k-1}, u_0^k) - f(u_0^k)) \\right]\n$$\nwhere $f(u) = au$ is the physical flux, and $u_j^k$ denotes the solution at node $j$ of element $k$. The Kronecker deltas $\\delta_{ip}$ and $\\delta_{i0}$ ensure the corrections are applied only at nodes $p$ (right boundary, $\\xi=1$) and $0$ (left boundary, $\\xi=-1$), respectively. The indices on neighboring elements, $k-1$ and $k+1$, are handled periodically.\n\nThe numerical flux is given by $\\widehat{f}(u^-, u^+) = a \\left( \\frac{1}{2} (u^- + u^+) - \\frac{\\alpha}{2} (u^+ - u^-) \\right)$, which can be rewritten as $\\widehat{f}(u^-, u^+) = a \\left( \\frac{1+\\alpha}{2} u^- + \\frac{1-\\alpha}{2} u^+ \\right)$.\n\nAt the left boundary of element $k$ (node $0$), we have $u^- = u_p^{k-1}$ and $u^+ = u_0^k$. The flux mismatch is:\n$$\n\\widehat{f}(u_p^{k-1}, u_0^k) - f(u_0^k) = a \\left( \\frac{1+\\alpha}{2} u_p^{k-1} + \\frac{1-\\alpha}{2} u_0^k \\right) - a u_0^k = a \\frac{1+\\alpha}{2} u_p^{k-1} - a \\frac{1+\\alpha}{2} u_0^k = -a \\frac{1+\\alpha}{2} (u_0^k - u_p^{k-1})\n$$\nAt the right boundary of element $k$ (node $p$), we have $u^- = u_p^k$ and $u^+ = u_0^{k+1}$. The flux mismatch is:\n$$\n\\widehat{f}(u_p^k, u_0^{k+1}) - f(u_p^k) = a \\left( \\frac{1+\\alpha}{2} u_p^k + \\frac{1-\\alpha}{2} u_0^{k+1} \\right) - a u_p^k = a \\frac{1-\\alpha}{2} u_0^{k+1} - a \\frac{1-\\alpha}{2} u_p^k = a \\frac{1-\\alpha}{2} (u_0^{k+1} - u_p^k)\n$$\nSubstituting these into the nodal update equation:\nFor node $i=0$:\n$$\n\\frac{du_{0,k}}{dt} = -a \\frac{2}{h} (\\mathbf{D} \\mathbf{u}_k)_0 - \\frac{2}{h} \\frac{1}{w_0} \\left[ - \\left( -a \\frac{1+\\alpha}{2} (u_0^k - u_p^{k-1}) \\right) \\right] = -a \\frac{2}{h} (\\mathbf{D} \\mathbf{u}_k)_0 - \\frac{a(1+\\alpha)}{h w_0} (u_0^k - u_p^{k-1})\n$$\nFor node $i=p$:\n$$\n\\frac{du_{p,k}}{dt} = -a \\frac{2}{h} (\\mathbf{D} \\mathbf{u}_k)_p - \\frac{2}{h} \\frac{1}{w_p} \\left[ a \\frac{1-\\alpha}{2} (u_0^{k+1} - u_p^k) \\right] = -a \\frac{2}{h} (\\mathbf{D} \\mathbf{u}_k)_p - \\frac{a(1-\\alpha)}{h w_p} (u_0^{k+1} - u_p^k)\n$$\nWe can now assemble the global matrix operator $\\mathbf{L}$ of size $N \\times N$, where $N=K(p+1)$. The vector of global degrees of freedom is $\\mathbf{U} = [\\mathbf{u}_0^T, \\dots, \\mathbf{u}_{K-1}^T]^T$. The system is $\\frac{d\\mathbf{U}}{dt} = \\mathbf{L} \\mathbf{U}$. The matrix $\\mathbf{L}$ has a block-circulant structure. The diagonal blocks $\\mathbf{L}_{k,k}$ represent intra-element contributions, while off-diagonal blocks $\\mathbf{L}_{k,k-1}$ and $\\mathbf{L}_{k,k+1}$ represent inter-element coupling.\n\n1.  **Volume term**: The differentiation term $-a \\frac{2}{h} \\mathbf{D}$ contributes to the diagonal blocks $\\mathbf{L}_{k,k}$.\n2.  **Surface terms (diagonal blocks)**:\n    - The term $-\\frac{a(1+\\alpha)}{h w_0} u_0^k$ adds to the $(0,0)$ entry of $\\mathbf{L}_{k,k}$.\n    - The term $+\\frac{a(1-\\alpha)}{h w_p} u_p^k$ adds to the $(p,p)$ entry of $\\mathbf{L}_{k,k}$.\n3.  **Surface terms (off-diagonal blocks)**:\n    - The term $+\\frac{a(1+\\alpha)}{h w_0} u_p^{k-1}$ contributes to the $(0,p)$ entry of the block $\\mathbf{L}_{k,k-1}$.\n    - The term $-\\frac{a(1-\\alpha)}{h w_p} u_0^{k+1}$ contributes to the $(p,0)$ entry of the block $\\mathbf{L}_{k,k+1}$.\n\nThe SBP property of the LGL-point-based differentiation operator $\\mathbf{D}$ and mass matrix $\\mathbf{M}$ is $\\mathbf{M}\\mathbf{D} + (\\mathbf{M}\\mathbf{D})^T = \\text{diag}(-1, 0, \\dots, 0, 1)$. This property guarantees that for a central flux ($\\alpha=0$), the semi-discrete operator is energy-stable, meaning the eigenvalues have zero or non-positive real parts (ideally zero for the advection equation). For $\\alpha > 0$, dissipation is introduced, pushing the real parts of eigenvalues to be strictly negative.\n\nThe numerical implementation will construct this matrix for each given set of parameters $(p, \\alpha)$, compute its eigenvalues, and perform the specified analysis: calculating the Pearson correlation between $\\alpha$ and the minimum real part of the eigenvalues, the difference in minimum real parts between upwind and central fluxes, and counting the number of outlier modes for the upwind case.", "answer": "```python\nimport numpy as np\nfrom scipy.special import roots_jacobi, legendre\n\ndef get_lgl_basis(p):\n    \"\"\"\n    Computes LGL nodes, weights, and the differentiation matrix for a given\n    polynomial degree p.\n    \"\"\"\n    if p == 0:\n      return np.array([-1.0]), np.array([2.0]), np.array([[0.0]])\n      \n    if p == 1:\n        xi = np.array([-1.0, 1.0])\n        w = np.array([1.0, 1.0])\n        D = np.array([[-0.5, 0.5], [-0.5, 0.5]])\n        return xi, w, D\n\n    # Interior nodes are roots of the derivative of the p-th Legendre polynomial,\n    # which are roots of the Jacobi polynomial P_{p-1}^{(1,1)}.\n    xi_interior, _ = roots_jacobi(p - 1, 1, 1)\n    xi = np.concatenate(([-1.0], np.sort(xi_interior), [1.0]))\n\n    # Legendre polynomial object\n    P_p_poly = legendre(p)\n    P_p_vals = P_p_poly(xi)\n\n    # Weights\n    w = 2.0 / (p * (p + 1) * P_p_vals**2)\n\n    # Differentiation matrix\n    D = np.zeros((p + 1, p + 1))\n    for i in range(p + 1):\n        for j in range(p + 1):\n            if i != j:\n                D[i, j] = P_p_vals[i] / (P_p_vals[j] * (xi[i] - xi[j]))\n            else:\n                if i == 0:\n                    D[i, i] = -p * (p + 1) / 4.0\n                elif i == p:\n                    D[i, i] = p * (p + 1) / 4.0\n                else:\n                    D[i, i] = 0.0\n    return xi, w, D\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem.\n    \"\"\"\n    L_domain = 1.0\n    a = 1.0\n    K = 8\n    h = L_domain / K\n\n    p_list = [1, 2, 4]\n    alpha_list = [0.0, 0.5, 1.0]\n\n    all_results = []\n\n    for p in p_list:\n        xi, w, D = get_lgl_basis(p)\n        N_p = p + 1\n        N_global = K * N_p\n\n        min_real_parts = []\n        outlier_count_alpha1 = 0\n\n        for alpha in alpha_list:\n            L_matrix = np.zeros((N_global, N_global), dtype=np.complex128)\n\n            # Volume contribution (same for all elements)\n            D_block = -a * 2.0 / h * D\n\n            # Surface contributions\n            # Self-coupling terms\n            C_self_00 = -a * (1.0 + alpha) / (h * w[0])\n            C_self_pp = a * (1.0 - alpha) / (h * w[p])\n            \n            # Neighbor-coupling terms\n            C_left_0p = a * (1.0 + alpha) / (h * w[0])\n            C_right_p0 = -a * (1.0 - alpha) / (h * w[p])\n\n            for k in range(K):\n                offset = k * N_p\n\n                # Diagonal block (volume + self-coupling surface terms)\n                L_matrix[offset : offset + N_p, offset : offset + N_p] = D_block\n                L_matrix[offset, offset] += C_self_00\n                L_matrix[offset + p, offset + p] += C_self_pp\n\n                # Off-diagonal blocks (neighbor-coupling surface terms)\n                # Periodic boundary conditions\n                km1 = (k - 1 + K) % K\n                kp1 = (k + 1) % K\n                \n                L_matrix[offset, km1 * N_p + p] += C_left_0p\n                L_matrix[offset + p, kp1 * N_p] += C_right_p0\n\n            # Compute eigenvalues\n            eigenvalues = np.linalg.eigvals(L_matrix)\n            real_parts = eigenvalues.real\n            min_real_parts.append(np.min(real_parts))\n\n            # Outlier analysis for alpha = 1.0\n            if alpha == 1.0:\n                mu_re = np.mean(real_parts)\n                sigma_re = np.std(real_parts)\n                threshold = min(mu_re - 2 * sigma_re, -1e-8)\n                outlier_count_alpha1 = int(np.sum(real_parts < threshold))\n\n        # Compute Pearson correlation\n        corr_matrix = np.corrcoef(alpha_list, min_real_parts)\n        # Handle case of zero variance if min_real_parts are constant\n        if np.isnan(corr_matrix[0, 1]):\n            correlation = 0.0\n        else:\n            correlation = corr_matrix[0, 1]\n\n        # Compute Delta_min\n        delta_min = min_real_parts[2] - min_real_parts[0]\n\n        all_results.extend([correlation, delta_min, outlier_count_alpha1])\n\n    # Format and print the final output\n    print(f\"[{','.join(f'{x:.6f}' if isinstance(x, float) else str(x) for x in all_results)}]\")\n\nsolve()\n```", "id": "3405180"}, {"introduction": "While numerical eigenvalue analysis provides invaluable insight, rigorous analytical derivations offer universal guarantees on a scheme's behavior. This practice moves from computational exploration to a \"pen-and-paper\" analysis, challenging you to leverage the specific structure of the DG operator on a uniform periodic mesh. By employing Fourier analysis, you will derive an exact analytical expression for the stability limit of the forward Euler method when combined with a DG scheme using an upwind flux [@problem_id:3405176], connecting abstract mathematical tools to a critical, concrete performance metric.", "problem": "Consider the linear advection equation $u_{t} + a\\,u_{x} = 0$ on the periodic domain $[0,L]$ with constant advection speed $a \\in \\mathbb{R} \\setminus \\{0\\}$. Discretize the domain with a uniform mesh of $K$ cells of size $h=L/K$. On each cell, approximate $u$ using the discontinuous Galerkin (DG) method with a polynomial of degree $p$ in a nodal basis consisting of the $(p+1)$ Gauss–Lobatto–Legendre points mapped from the reference interval $[-1,1]$. Use the upwind numerical flux for $a>0$ (right-moving case) and impose periodic boundary conditions.\n\n1. Starting from the DG weak form on each element, mapped to the reference interval $[-1,1]$, use the properties of the Gauss–Lobatto–Legendre quadrature (diagonal mass matrix and summation-by-parts identity) to show that the resulting semi-discrete DG operator on the global vector of degrees of freedom is a block Toeplitz matrix with $(p+1)\\times(p+1)$ blocks, coupling only nearest neighbors. Precisely, show that the semi-discrete operator is block bi-circulant with a diagonal block $\\mathbf{A}_{0}$ and a single sub-diagonal block $\\mathbf{A}_{-1}$ such that the Fourier symbol (block symbol) for wavenumber $\\theta \\in [0,2\\pi)$ is\n$$\n\\mathbf{A}(\\theta) \\;=\\; \\mathbf{A}_{0} \\;+\\; \\exp(-\\mathrm{i}\\,\\theta)\\,\\mathbf{A}_{-1}.\n$$\nDerive a closed-form expression for $\\mathbf{A}(\\theta)$ in terms of the diagonal mass matrix $\\mathbf{M}$ of Gauss–Lobatto–Legendre quadrature, the first-derivative summation-by-parts matrix $\\mathbf{Q}=\\mathbf{M}\\mathbf{D}$ (with $\\mathbf{D}$ the nodal differentiation matrix on $[-1,1]$), and the left-boundary lifting matrix $\\mathbf{B}^{-}$.\n\n2. Using the closed-form symbol, analyze the exact forward Euler method stability on this semi-discrete system. Show how the Fourier symbol leads to a Courant–Friedrichs–Lewy (CFL) bound of the form $|a|\\,\\Delta t/h \\leq C_{p}$ that is necessary and sufficient for stability of forward Euler. Your derivation must rely only on the summation-by-parts property and exact endpoint Gauss–Lobatto–Legendre weights for degree $p$.\n\nExpress the final answer as a single closed-form analytic expression for the Courant-number constant $C_{p}$ in terms of $p$. No numerical approximation is required.", "solution": "We begin with the linear advection equation $u_{t} + a\\,u_{x} = 0$ and its discontinuous Galerkin (DG) discretization on a uniform periodic mesh. On element $I_{i}=[x_{i-\\frac{1}{2}},x_{i+\\frac{1}{2}}]$ of length $h$, we map $x \\in I_{i}$ to the reference coordinate $\\xi \\in [-1,1]$ by $x = x_{i} + \\frac{h}{2}\\,\\xi$. Denote the $(p+1)$ Gauss–Lobatto–Legendre nodes on $[-1,1]$ by $\\{\\xi_{j}\\}_{j=1}^{p+1}$, the corresponding Lagrange basis functions by $\\{\\ell_{j}(\\xi)\\}_{j=1}^{p+1}$, and the quadrature weights by $\\{w_{j}\\}_{j=1}^{p+1}$, with $w_{1}=w_{p+1}=\\frac{2}{p(p+1)}$. The mass matrix on the reference element is diagonal,\n$$\n\\mathbf{M} \\;=\\; \\mathrm{diag}(w_{1},w_{2},\\dots,w_{p+1}).\n$$\nLet $\\mathbf{D}$ be the $(p+1)\\times(p+1)$ nodal differentiation matrix with entries $D_{jk} = \\ell_{k}'(\\xi_{j})$ and define the summation-by-parts (SBP) matrix $\\mathbf{Q} = \\mathbf{M}\\mathbf{D}$. The Gauss–Lobatto–Legendre SBP identity reads\n$$\n\\mathbf{Q} \\;+\\; \\mathbf{Q}^{\\top} \\;=\\; \\mathbf{B},\n$$\nwhere $\\mathbf{B} = \\mathrm{diag}(-1,0,\\dots,0,+1)$ encodes endpoint contributions at $\\xi=-1$ and $\\xi=+1$. Define the left-boundary lifting matrix $\\mathbf{B}^{-} = \\mathrm{diag}(1,0,\\dots,0)$ and right-boundary lifting matrix $\\mathbf{B}^{+} = \\mathrm{diag}(0,\\dots,0,1)$. For $a>0$ (rightward advection), the upwind numerical flux at the right interface of element $i$ uses the interior trace from element $i$, while the left interface uses the interior trace from element $i-1$.\n\nOn element $i$, the strong-form DG semi-discretization in nodal values $\\mathbf{u}_{i} \\in \\mathbb{R}^{p+1}$ is obtained by testing with nodal basis functions and using exact quadrature:\n$$\n\\frac{\\mathrm{d}\\mathbf{u}_{i}}{\\mathrm{d}t}\n\\;=\\;\n-\\,\\frac{a}{h}\\,\\mathbf{M}^{-1}\\left(\\mathbf{Q}\\,\\mathbf{u}_{i} \\;-\\; \\mathbf{B}^{-}\\,\\mathbf{u}_{i} \\right)\n\\;+\\;\n\\frac{a}{h}\\,\\mathbf{M}^{-1}\\,\\mathbf{B}^{-}\\,\\mathbf{u}_{i-1}.\n$$\nThis expression follows from the weak form with numerical flux inserted at interfaces, then rewritten in strong form by using the SBP property. The term $-\\frac{a}{h}\\mathbf{M}^{-1}\\mathbf{Q}\\mathbf{u}_{i}$ represents the reference-element derivative contribution, while $\\mathbf{M}^{-1}\\mathbf{B}^{-}$ lifts the left-interface flux contribution into the volume degrees of freedom. The upwind choice at the right interface cancels the $\\mathbf{B}^{+}$ contribution in the strong-form for $a>0$ (it is internal to the same element), while the left interface contributes the neighbor $\\mathbf{u}_{i-1}$.\n\nStacking all element vectors into the global vector $\\mathbf{U} = [\\mathbf{u}_{1}^{\\top},\\dots,\\mathbf{u}_{K}^{\\top}]^{\\top}$, the semi-discrete system reads\n$$\n\\frac{\\mathrm{d}\\mathbf{U}}{\\mathrm{d}t} \\;=\\; \\mathbf{L}\\,\\mathbf{U},\n$$\nwith the global operator $\\mathbf{L}$ being block bi-circulant due to periodicity and uniformity. Specifically, $\\mathbf{L}$ is block Toeplitz (indeed, block circulant) with $(p+1)\\times(p+1)$ blocks\n$$\n\\mathbf{A}_{0} \\;=\\; -\\,\\frac{a}{h}\\,\\mathbf{M}^{-1}\\left(\\mathbf{Q} - \\mathbf{B}^{-}\\right),\n\\qquad\n\\mathbf{A}_{-1} \\;=\\; \\frac{a}{h}\\,\\mathbf{M}^{-1}\\,\\mathbf{B}^{-},\n$$\nand all other off-diagonal blocks zero except the periodic wrap-around. Therefore, for Fourier mode $\\exp(\\mathrm{i}\\,\\theta i)$ with wave number $\\theta \\in [0,2\\pi)$, the block symbol (Fourier symbol) is\n$$\n\\mathbf{A}(\\theta) \\;=\\; \\mathbf{A}_{0} \\;+\\; \\exp(-\\mathrm{i}\\,\\theta)\\,\\mathbf{A}_{-1}\n\\;=\\;\n-\\,\\frac{a}{h}\\,\\mathbf{M}^{-1}\\,\\mathbf{Q}\n\\;+\\;\n\\frac{a}{h}\\,\\mathbf{M}^{-1}\\,\\mathbf{B}^{-}\\left(\\exp(-\\mathrm{i}\\,\\theta)-1\\right).\n$$\nThis is the desired closed-form expression that depends only on $p$ through $\\mathbf{M}$, $\\mathbf{Q}$, and $\\mathbf{B}^{-}$ (all determined by the Gauss–Lobatto–Legendre grid of degree $p$).\n\nWe now use the symbol $\\mathbf{A}(\\theta)$ to derive an exact Courant–Friedrichs–Lewy (CFL) bound for the forward Euler method. The forward Euler update is\n$$\n\\mathbf{U}^{n+1} \\;=\\; \\mathbf{U}^{n} \\;+\\; \\Delta t\\,\\mathbf{L}\\,\\mathbf{U}^{n}.\n$$\nStability on the periodic mesh reduces to stability of the $p+1$-dimensional symbol dynamics\n$$\n\\widehat{\\mathbf{u}}^{n+1}(\\theta)\n\\;=\\;\n\\left[\\mathbf{I} \\;+\\; \\Delta t\\,\\mathbf{A}(\\theta)\\right]\\,\\widehat{\\mathbf{u}}^{n}(\\theta),\n$$\nuniformly for all $\\theta\\in[0,2\\pi)$, where $\\widehat{\\mathbf{u}}$ is the discrete Fourier transform over elements. Forward Euler stability requires that all eigenvalues $z$ of $\\Delta t\\,\\mathbf{A}(\\theta)$ lie in the closed disc $\\{z: |1+z|\\leq 1\\}$, equivalently $|1+\\Delta t\\,\\lambda|\\leq 1$ for all eigenvalues $\\lambda$ of $\\mathbf{A}(\\theta)$ and all $\\theta$. For a given eigenvalue $\\lambda = \\rho\\,\\exp(\\mathrm{i}\\,\\varphi)$, the boundary of the forward Euler stability region is given by $|1+\\rho\\,\\exp(\\mathrm{i}\\,\\varphi)|=1$, which yields the exact stability threshold\n$$\n\\rho_{\\max}(\\varphi)\\,\\Delta t \\;=\\; -\\,2\\,\\cos\\varphi,\n\\quad\n\\text{for } \\cos\\varphi < 0,\n$$\nand no admissible $\\Delta t$ when $\\cos\\varphi \\geq 0$. Thus the most restrictive condition occurs when the eigenvalues lie on the negative real axis ($\\varphi=\\pi$), giving $\\Delta t \\leq 2/|\\rho|$.\n\nFor the DG symbol derived above, the term $\\mathbf{M}^{-1}\\mathbf{Q}$ contributes a skew-symmetric component in the energy induced by $\\mathbf{M}$ due to the SBP identity, while the term $\\mathbf{M}^{-1}\\mathbf{B}^{-}(\\exp(-\\mathrm{i}\\,\\theta)-1)$ contributes a rank-one dissipative component whose real part is nonpositive for all $\\theta$. The most dissipative case is at $\\theta=\\pi$, where $\\exp(-\\mathrm{i}\\,\\theta)-1 = -2$, yielding\n$$\n\\mathbf{A}(\\pi) \\;=\\; -\\,\\frac{a}{h}\\,\\mathbf{M}^{-1}\\,\\mathbf{Q} \\;-\\; 2\\,\\frac{a}{h}\\,\\mathbf{M}^{-1}\\,\\mathbf{B}^{-}.\n$$\nBecause $\\mathbf{M}^{-1}\\mathbf{B}^{-}$ is diagonal with its only nonzero eigenvalue equal to $1/w_{1}$, the spectral abscissa (most negative real part) of $\\mathbf{A}(\\pi)$ is exactly\n$$\n\\alpha_{\\min} \\;=\\; -\\,2\\,\\frac{|a|}{h}\\,\\frac{1}{w_{1}}\n\\;=\\;\n-\\,2\\,\\frac{|a|}{h}\\,\\frac{p(p+1)}{2}\n\\;=\\;\n-\\,\\frac{|a|}{h}\\,p(p+1),\n$$\nusing $w_{1}=\\frac{2}{p(p+1)}$. This real eigenvalue dominates the forward Euler stability constraint because the skew-symmetric part does not contribute to the real part. Therefore the necessary and sufficient stability condition is\n$$\n\\Delta t \\;\\leq\\; \\frac{2}{|\\alpha_{\\min}|}\n\\;=\\;\n\\frac{2}{\\frac{|a|}{h}\\,p(p+1)}\n\\;=\\;\n\\frac{2\\,h}{|a|\\,p(p+1)}.\n$$\nEquivalently, the Courant number defined by $|a|\\,\\Delta t/h$ must satisfy\n$$\n\\frac{|a|\\,\\Delta t}{h} \\;\\leq\\; C_{p},\n\\qquad\nC_{p} \\;=\\; \\frac{2}{p(p+1)}.\n$$\nThis $C_{p}$ is exact because it follows from the precise endpoint Gauss–Lobatto–Legendre weight, the rank-one structure of $\\mathbf{M}^{-1}\\mathbf{B}^{-}$, and the fact that the most restrictive Fourier mode is $\\theta=\\pi$ where the symbol’s dissipative term attains its maximal magnitude.\n\nIn summary, we have shown the block Toeplitz structure of the global DG operator on the periodic uniform mesh, derived the closed-form block symbol\n$$\n\\mathbf{A}(\\theta) \\;=\\; -\\,\\frac{a}{h}\\,\\mathbf{M}^{-1}\\,\\mathbf{Q}\n\\;+\\;\n\\frac{a}{h}\\,\\mathbf{M}^{-1}\\,\\mathbf{B}^{-}\\left(\\exp(-\\mathrm{i}\\,\\theta)-1\\right),\n$$\nand obtained the exact forward Euler Courant-number bound $C_{p} = 2/[p(p+1)]$.", "answer": "$$\\boxed{\\frac{2}{p(p+1)}}$$", "id": "3405176"}, {"introduction": "The design of numerical fluxes extends beyond simple advection to complex nonlinear systems with source terms, where new challenges arise. This advanced practice explores the crucial concept of well-balancing, which ensures that a numerical scheme can exactly preserve important physical steady states, such as the geostrophic balance in the shallow water equations. You will implement a carefully designed \"flux-source pairing\" to maintain this discrete balance and investigate how seemingly minor implementation choices, like the quadrature rule for the source term, can disrupt this delicate property and introduce numerical errors [@problem_id:3405150].", "problem": "Consider the two-dimensional shallow water equations with Coriolis acceleration on a flat bottom, written for the fluid depth $h(x,y,t)$ and depth-averaged velocity $(u(x,y,t),v(x,y,t))$:\n$$\n\\partial_t h + \\partial_x (h u) + \\partial_y (h v) = 0,\n$$\n$$\n\\partial_t (h u) + \\partial_x\\left(h u^2 + \\tfrac{1}{2} g h^2\\right) + \\partial_y (h u v) = f_c h v,\n$$\n$$\n\\partial_t (h v) + \\partial_x (h u v) + \\partial_y\\left(h v^2 + \\tfrac{1}{2} g h^2\\right) = - f_c h u,\n$$\nwhere $g$ is gravitational acceleration and $f_c$ is the Coriolis parameter. Assume fields depend only on the coordinate $y$ and time $t$ (no $x$-variation), and consider the geostrophically balanced steady state in which $(\\partial_t h,\\partial_t u,\\partial_t v)=(0,0,0)$, $v(y)=0$, and $u(y)$ is such that the $y$-momentum equation balances the hydrostatic pressure gradient against the Coriolis force.\n\nYou will construct and analyze a Discontinuous Galerkin (DG) discretization for the $y$-momentum equation on a one-dimensional domain in $y$:\n$$\n\\partial_t (h v) + \\partial_y\\left(\\tfrac{1}{2} g h^2\\right) = - f_c h u,\n$$\nunder the geostrophic assumption $v(y)=0$. The computational domain is the interval $[0,1]$ partitioned into two equal elements $[0,\\tfrac{1}{2}]$ and $[\\tfrac{1}{2},1]$. On each element, use a polynomial approximation of degree $p$ with Legendre–Gauss–Lobatto nodes, and let $\\{\\ell_j(y)\\}_{j=0}^{p}$ denote the local Lagrange basis functions. Denote by $F(y) := \\tfrac{1}{2} g h(y)^2$ and by $S(y) := - f_c h(y) u(y)$ the hydrostatic pressure flux and Coriolis source, respectively. The DG weak form for the $y$-momentum equation in steady geostrophic balance reduces to testing against each basis function $\\ell_j$ and enforcing the discrete residual\n$$\n\\mathcal{R}_j = - \\int_{K} \\partial_y \\ell_j(y)\\, F(y)\\, dy + \\left.\\ell_j(y)\\,F^*(y)\\,n(y)\\right|_{\\partial K} - \\int_K \\ell_j(y)\\, S(y)\\, dy,\n$$\nto vanish on each element $K$, where $n(y)$ is the outward unit normal at the element boundary (in one dimension $n=-1$ on the left face and $n=+1$ on the right face), and $F^*(y)$ is a numerical flux function at the element boundary. The task is to:\n1. Starting from the continuous geostrophic balance relation (hydrostatic pressure gradient equals Coriolis force), justify a flux–source pairing in which the interface flux function $F^*$ and a discrete source term are chosen so that the discrete residual $\\mathcal{R}_j$ vanishes exactly for geostrophically balanced states represented at the Legendre–Gauss–Lobatto nodes, provided the element boundary values of $h$ are evaluated consistently at the shared interface.\n2. Quantify how replacing the volume source integral by an alternative quadrature rule that does not match the flux pairing affects the discrete residual, and explain the mechanism of the imbalance.\n\nYou must implement a program that, for given $p$, gravitational acceleration $g$, Coriolis parameter $f_c$, and a choice of depth profile $h(y)$ with the corresponding geostrophic velocity $u(y)$, evaluates the discrete residual vector over all degrees of freedom on both elements and returns the Euclidean norm of the residual. In all computations use dimensionless units with $g=1$ and $f_c=1$ (no physical unit conversion required; report dimensionless residual magnitudes as floating-point numbers).\n\nFor the flux–source pairing, enforce the following design choices:\n- Use interface numerical flux $F^*$ equal to the hydrostatic pressure potential evaluated at the shared boundary value of $h$ (the boundary coordinate is common to both adjacent elements so the boundary value is single-valued under pointwise evaluation of $h$).\n- For exact geostrophic preservation, discretize the Coriolis source by the discrete derivative of the hydrostatic pressure potential computed with the same Legendre–Gauss–Lobatto derivative operator used for the flux volume term.\n- For quadrature mismatch analysis, approximate the Coriolis source volume integral by Legendre–Gauss quadrature with $q$ points per element, evaluating the continuous expression $S(y)=g h(y)\\,\\partial_y h(y)$ at those quadrature points and the basis functions at the same points. Keep the flux volume term and interface flux as in the exact pairing.\n\nYour program must implement the following test suite and output the four residual norms on a single line in the exact format specified at the end of this problem:\n\n- Test Case 1 (matched pairing, polynomial depth): $p=4$, $h(y)=1+0.2\\,y+0.1\\,y^2$, $g=1$, $f_c=1$. Use the exact pairing (discrete source as the discrete derivative of the hydrostatic pressure potential with the same Legendre–Gauss–Lobatto operators). Return the Euclidean norm of the assembled residual vector.\n\n- Test Case 2 (quadrature mismatch, same polynomial depth): $p=4$, $h(y)=1+0.2\\,y+0.1\\,y^2$, $g=1$, $f_c=1$, but compute the source volume integral using Legendre–Gauss quadrature with $q=5$ points per element and the continuous formula $S(y)=g h(y)\\,\\partial_y h(y)$ evaluated at those points. Return the Euclidean norm of the assembled residual vector.\n\n- Test Case 3 (boundary-degree edge case, linear depth with mismatch): $p=1$, $h(y)=1+0.3\\,y$, $g=1$, $f_c=1$, source integral by Legendre–Gauss quadrature with $q=2$ points per element. Return the Euclidean norm of the assembled residual vector.\n\n- Test Case 4 (non-polynomial depth with mismatch): $p=6$, $h(y)=1+0.1\\sin(2\\pi y)$, $g=1$, $f_c=1$, source integral by Legendre–Gauss quadrature with $q=6$ points per element. Return the Euclidean norm of the assembled residual vector.\n\nFinal Output Format:\nYour program should produce a single line of output containing the four residual norms as a comma-separated list enclosed in square brackets. For example, it should print a line of the form\n$$\n[\\text{result1},\\text{result2},\\text{result3},\\text{result4}]\n$$\nwhere each entry is a floating-point number.", "solution": "The problem requires the construction and analysis of a Discontinuous Galerkin (DG) discretization for the one-dimensional $y$-momentum equation of the shallow water equations, specialized to a steady geostrophic balance. The analysis focuses on the concept of well-balancing, where the numerical scheme is designed to exactly preserve this balanced state.\n\nFirst, we establish the continuous geostrophic balance relation. The shallow water equations are given, and under the assumptions of steady state ($\\partial_t = 0$), no variation in the $x$-direction ($\\partial_x = 0$), and zero velocity in the $y$-direction ($v=0$), the $y$-momentum equation simplifies significantly.\nThe full equation is:\n$$\n\\partial_t (h v) + \\partial_x (h u v) + \\partial_y\\left(h v^2 + \\tfrac{1}{2} g h^2\\right) = - f_c h u\n$$\nApplying the assumptions, all terms containing $v$ or $\\partial_t$ vanish, and the $\\partial_x$ term is zero by assumption, leaving:\n$$\n\\partial_y\\left(\\tfrac{1}{2} g h^2\\right) = - f_c h u\n$$\nThis equation represents the geostrophic balance, where the hydrostatic pressure gradient force in the $y$-direction is balanced by the Coriolis force. We define the hydrostatic pressure flux as $F(y) = \\tfrac{1}{2} g h(y)^2$ and the Coriolis source term as $S(y) = -f_c h(y) u(y)$. The continuous balance is thus compactly written as $\\partial_y F(y) = S(y)$. For the specified dimensionless units $g=1$ and $f_c=1$, the geostrophic velocity is $u(y) = - g/f_c \\partial_y h(y) = - \\partial_y h(y)$. The source term becomes $S(y) = - (1) h(y) (-\\partial_y h(y)) = h(y) \\partial_y h(y)$. This is consistent with the flux derivative, since $\\partial_y F(y) = \\partial_y(\\frac{1}{2}h(y)^2) = h(y) \\partial_y h(y)$.\n\nNext, we establish the DG weak formulation. Multiplying the equation $\\partial_y F = S$ by a test function $\\ell_j(y)$ (a Lagrange basis polynomial of degree $p$) and integrating over a computational element $K$ gives:\n$$\n\\int_K \\ell_j(y) (\\partial_y F(y)) dy = \\int_K \\ell_j(y) S(y) dy\n$$\nIntegrating the flux term by parts yields:\n$$\n\\left[ \\ell_j(y) F(y) \\right]_{\\partial K} - \\int_K (\\partial_y \\ell_j(y)) F(y) dy = \\int_K \\ell_j(y) S(y) dy\n$$\nIn a DG context, the single-valued flux $F$ at element boundaries is replaced by a numerical flux $F^*$. The boundary term is written as $\\left. \\ell_j(y) F^*(y) n(y) \\right|_{\\partial K}$, where $n(y)$ is the outward unit normal. The discrete residual for the $i$-th degree of freedom on element $K$ is then defined as:\n$$\n\\mathcal{R}_j = - \\int_{K} \\partial_y \\ell_j(y)\\, F(y)\\, dy + \\left.\\ell_j(y)\\,F^*(y)\\,n(y)\\right|_{\\partial K} - \\int_K \\ell_j(y)\\, S(y)\\, dy\n$$\nThe problem requires this residual to be evaluated for a discrete approximation where the solution is represented by its values at the $p+1$ Legendre-Gauss-Lobatto (LGL) nodes within each element. Let $F_p(y)$ be the polynomial interpolant of the flux function $F(y)$ through these nodes.\n\n**Part 1: Justification of the Flux-Source Pairing**\n\nA well-balanced scheme is one where the discrete residual $\\mathcal{R}_j$ is identically zero when the exact continuous balanced solution is used as input. This is achieved by defining the discrete source term in a way that it exactly cancels the discrete flux derivative.\n\nThe DG discretization is performed on LGL nodes. A key property of these nodal sets is that the associated differentiation matrix $\\mathbf{D}$ and diagonal mass matrix (quadrature weights) $\\mathbf{W}$ satisfy the summation-by-parts (SBP) property: $\\mathbf{D}^T\\mathbf{W} + \\mathbf{W}\\mathbf{D} = \\mathbf{B}$, where $\\mathbf{B}=\\text{diag}([-1, 0, \\dots, 0, 1])$.\n\nThe volume integrals in the residual are approximated using LGL quadrature, which is based on the nodal values.\nThe flux integral term (vector form) is $\\mathbf{I}_1 = -(\\mathbf{D}^T \\mathbf{W}) \\mathbf{F}$, where $\\mathbf{F}$ is the vector of flux values at the nodes.\nThe well-balanced source term, as specified, uses the same LGL derivative operator. In the nodal framework, this means the discrete source vector $\\mathbf{S}_{\\text{node}}$ is defined as the discrete derivative of the flux vector: $\\mathbf{S}_{\\text{node}} = \\mathbf{D} \\mathbf{F}$. The corresponding source integral term is $\\mathbf{I}_3 = -\\mathbf{W} \\mathbf{S}_{\\text{node}} = -\\mathbf{W}\\mathbf{D}\\mathbf{F}$.\n\nThe sum of the volume terms in the residual is thus:\n$$\n\\mathbf{I}_1 + \\mathbf{I}_3 = -(\\mathbf{D}^T\\mathbf{W})\\mathbf{F} - (\\mathbf{W}\\mathbf{D})\\mathbf{F} = -(\\mathbf{D}^T\\mathbf{W} + \\mathbf{W}\\mathbf{D})\\mathbf{F} = -\\mathbf{B}\\mathbf{F}\n$$\nThis results in a vector where the only non-zero entries correspond to the element boundaries: $-(-1)F_0$ for the first node ($j=0$) and $-(+1)F_p$ for the last node ($j=p$). So, the combined volume-term residual is $(F_0, 0, \\dots, 0, -F_p)^T$, where $F_0$ and $F_p$ are flux values at the left and right boundaries of the element.\n\nThe boundary flux term in the residual is $\\mathbf{I}_2$. For basis function $\\ell_j$, it is non-zero only at the endpoints. For $j=0$, the contribution is $\\ell_0(y_{\\text{left}}) F^*(y_{\\text{left}}) n_{\\text{left}} = (1) F^*(y_{\\text{left}}) (-1) = -F^*(y_{\\text{left}})$. For $j=p$, the contribution is $\\ell_p(y_{\\text{right}}) F^*(y_{\\text{right}}) n_{\\text{right}} = (1) F^*(y_{\\text{right}}) (+1) = F^*(y_{\\text{right}})$. The vector $\\mathbf{I}_2$ is $(-F^*(y_{\\text{left}}), 0, \\dots, 0, F^*(y_{\\text{right}}))^T$.\n\nThe total residual vector is $\\mathcal{R} = (\\mathbf{I}_1 + \\mathbf{I}_3) + \\mathbf{I}_2$.\n$$\n\\mathcal{R} = \\begin{pmatrix} F_0 \\\\ 0 \\\\ \\vdots \\\\ 0 \\\\ -F_p \\end{pmatrix} + \\begin{pmatrix} -F^*(y_{\\text{left}}) \\\\ 0 \\\\ \\vdots \\\\ 0 \\\\ F^*(y_{\\text{right}}) \\end{pmatrix} = \\begin{pmatrix} F_0 - F^*(y_{\\text{left}}) \\\\ 0 \\\\ \\vdots \\\\ 0 \\\\ -F_p + F^*(y_{\\text{right}}) \\end{pmatrix}\n$$\nThe problem states that the numerical flux $F^*$ is evaluated at the shared boundary value of $h$. This is a central flux, meaning $F^* = F$ at the boundaries. Consequently, $F_0 - F^*(y_{\\text{left}}) = 0$ and $-F_p + F^*(y_{\\text{right}}) = 0$. The entire discrete residual vector $\\mathcal{R}$ vanishes. This justifies the proposed flux-source pairing: it ensures that the discrete geostrophic balance is maintained to machine precision.\n\n**Part 2: Quadrature Mismatch and Imbalance**\n\nWhen the source volume integral is computed using an alternative method, the exact cancellation demonstrated above is broken. The problem specifies using a $q$-point Legendre-Gauss (LG) quadrature rule to approximate $\\int_K \\ell_j(y) S(y) dy$, where $S(y)$ is the *continuous* source function $S(y) = g h(y) \\partial_y h(y)$.\n\nThe residual is now calculated as $\\mathcal{R} = \\mathbf{I}_1 + \\mathbf{I}_2 + \\mathbf{I}_{3, \\text{mismatch}}$. The flux terms $\\mathbf{I}_1$ and $\\mathbf{I}_2$ are unchanged. The new source term $\\mathbf{I}_{3, \\text{mismatch}}$ no longer satisfies the algebraic identity required for cancellation with the flux gradient term $\\mathbf{I}_1$.\n\nThe mechanism of the imbalance is the loss of consistency between the discrete operators for the flux gradient and the source term. While the continuous geostrophic state satisfies $S = \\partial_y F$, the well-balanced numerical scheme requires that the discrete representations also satisfy this, i.e., $\\text{Discrete}(S) = \\text{Discrete}(\\partial_y F)$. By using a different numerical procedure (LG quadrature on the analytic source function) for the source term than for the flux gradient (which is implicitly defined by the LGL-based weak form), this consistency is violated. The resulting residual $\\mathcal{R}$ will be non-zero, representing a spurious force that would accelerate the fluid away from the steady state in a time-dependent simulation. The magnitude of this residual quantifies the degree of the imbalance.\n\nThe program below implements the calculation of the Euclidean norm of the assembled residual vector for both the well-balanced (matched) and non-well-balanced (mismatched) schemes across four test cases.", "answer": "```python\nimport numpy as np\nfrom scipy.special import legendre, roots_jacobi\nfrom scipy.interpolate import BarycentricInterpolator\n\ndef solve():\n    \"\"\"\n    Solves the Discontinuous Galerkin residual problem for the shallow water equations.\n    \"\"\"\n\n    # Helper functions for spectral/DG methods, nested to be self-contained.\n    def get_lgl_nodes_weights(p):\n        \"\"\"Computes Legendre-Gauss-Lobatto nodes and weights for degree p on [-1, 1].\"\"\"\n        if p == 0:\n            return np.array([0.0]), np.array([2.0])\n        if p == 1:\n            return np.array([-1.0, 1.0]), np.array([1.0, 1.0])\n        \n        # Interior nodes are roots of P_p'(x) == roots of Jacobi polynomial P_{p-1}^{(1,1)}(x)\n        interior_nodes = roots_jacobi(p - 1, 1, 1)[0]\n        nodes = np.concatenate([[-1.0], interior_nodes, [1.0]])\n        \n        # Weights\n        leg_p_at_nodes = legendre(p)(nodes)\n        weights = 2.0 / (p * (p + 1) * leg_p_at_nodes**2)\n        \n        return nodes, weights\n\n    def get_lgl_diff_matrix(p, nodes):\n        \"\"\"Computes the LGL differentiation matrix for degree p on [-1, 1].\"\"\"\n        if p == 0:\n            return np.array([[0.0]])\n        \n        N = p + 1\n        D = np.zeros((N, N))\n        leg_p_at_nodes = legendre(p)(nodes)\n        \n        for i in range(N):\n            for j in range(N):\n                if i != j:\n                    D[i, j] = (leg_p_at_nodes[i] / leg_p_at_nodes[j]) / (nodes[i] - nodes[j])\n                else:\n                    if i == 0:\n                        D[i, j] = -p * (p + 1) / 4.0\n                    elif i == p:\n                        D[i, j] = p * (p + 1) / 4.0\n                    else:\n                        D[i, j] = 0.0\n        return D\n\n    def get_lagrange_basis_eval_matrix(eval_pts, nodes):\n        \"\"\"Computes matrix L where L_ij = l_j(eval_pts_i).\"\"\"\n        n_nodes = len(nodes)\n        n_eval = len(eval_pts)\n        L = np.zeros((n_eval, n_nodes))\n        \n        ident = np.eye(n_nodes)\n        for j in range(n_nodes):\n            # The j-th basis function has value 1 at node j and 0 at others.\n            interp = BarycentricInterpolator(nodes, ident[j, :])\n            if n_eval > 0:\n                L[:, j] = interp(eval_pts)\n        return L\n\n\n    def calculate_residual_norm(p, h_func, h_prime_func, g, f_c, mode, q=None):\n        \"\"\"\n        Calculates the Euclidean norm of the DG residual vector.\n        \"\"\"\n        domain = [0.0, 1.0]\n        elements = [[0.0, 0.5], [0.5, 1.0]]\n        total_dofs = 2 * (p + 1)\n        global_residual = np.zeros(total_dofs)\n\n        lgl_nodes_ref, lgl_weights_ref = get_lgl_nodes_weights(p)\n        diff_matrix_ref = get_lgl_diff_matrix(p, lgl_nodes_ref)\n\n        for e_idx, elem_bounds in enumerate(elements):\n            y_a, y_b = elem_bounds\n            jacobian = (y_b - y_a) / 2.0\n            \n            # Map reference nodes to physical element\n            y_nodes = y_a + jacobian * (lgl_nodes_ref + 1.0)\n            \n            # Evaluate functions at nodes\n            h_vals = h_func(y_nodes)\n            F_vals = 0.5 * g * h_vals**2\n\n            # 1. Flux volume term: I1 = - (D_ref^T @ W_ref) @ F_vals\n            # (D_ref.T @ diag(W_ref)) is the weak derivative matrix\n            I1_vec = - (diff_matrix_ref.T @ np.diag(lgl_weights_ref)) @ F_vals\n\n            # 2. Boundary flux term: I2\n            F_left = 0.5 * g * h_func(y_a)**2\n            F_right = 0.5 * g * h_func(y_b)**2\n            I2_vec = np.zeros(p + 1)\n            I2_vec[0] = -F_left  # n=-1 at left boundary\n            I2_vec[-1] = F_right # n=+1 at right boundary\n\n            # 3. Source term: I3\n            if mode == 'matched':\n                # S_node = D_phys @ F_vals = (1/J) * D_ref @ F_vals\n                S_node_vals = (1.0 / jacobian) * (diff_matrix_ref @ F_vals)\n                # I3 = - M @ S_node = - J * W_ref * S_node\n                I3_vec = - (jacobian * lgl_weights_ref) * S_node_vals\n            \n            elif mode == 'mismatched':\n                lg_nodes_ref, lg_weights_ref = np.polynomial.legendre.leggauss(q)\n                y_lg = y_a + jacobian * (lg_nodes_ref + 1.0)\n                \n                # Evaluate analytical source S(y) = g*h(y)*h'(y) at LG quadrature points\n                S_vals_at_lg = g * h_func(y_lg) * h_prime_func(y_lg)\n                \n                # Evaluate Lagrange basis functions at LG points\n                lagrange_eval_matrix = get_lagrange_basis_eval_matrix(lg_nodes_ref, lgl_nodes_ref)\n                \n                # I3_i = - integral(l_i * S)_K = - J * sum(w_k * l_i(y_k) * S(y_k))\n                I3_vec = -jacobian * (lagrange_eval_matrix.T @ (lg_weights_ref * S_vals_at_lg))\n            \n            else:\n                raise ValueError(\"Invalid mode specified.\")\n\n            elem_residual = I1_vec + I2_vec + I3_vec\n            start_idx = e_idx * (p + 1)\n            end_idx = start_idx + (p + 1)\n            global_residual[start_idx:end_idx] = elem_residual\n\n        return np.linalg.norm(global_residual)\n\n    # Test Case Definitions\n    g_val, fc_val = 1.0, 1.0\n    \n    # Case 1\n    p1 = 4\n    h1 = lambda y: 1.0 + 0.2*y + 0.1*y**2\n    h1_p = lambda y: 0.2 + 0.2*y\n    res1 = calculate_residual_norm(p1, h1, h1_p, g_val, fc_val, 'matched')\n    \n    # Case 2\n    p2, q2 = 4, 5\n    h2 = h1\n    h2_p = h1_p\n    res2 = calculate_residual_norm(p2, h2, h2_p, g_val, fc_val, 'mismatched', q=q2)\n\n    # Case 3\n    p3, q3 = 1, 2\n    h3 = lambda y: 1.0 + 0.3*y\n    h3_p = lambda y: 0.3\n    res3 = calculate_residual_norm(p3, h3, h3_p, g_val, fc_val, 'mismatched', q=q3)\n\n    # Case 4\n    p4, q4 = 6, 6\n    h4 = lambda y: 1.0 + 0.1 * np.sin(2 * np.pi * y)\n    h4_p = lambda y: 0.1 * 2 * np.pi * np.cos(2 * np.pi * y)\n    res4 = calculate_residual_norm(p4, h4, h4_p, g_val, fc_val, 'mismatched', q=q4)\n\n    results = [res1, res2, res3, res4]\n    \n    # Format output as specified\n    print(f\"[{','.join(f'{r:.15e}' for r in results)}]\")\n\nsolve()\n```", "id": "3405150"}]}