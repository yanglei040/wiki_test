{"hands_on_practices": [{"introduction": "Understanding how to represent a field using hierarchical basis functions is the first step toward mastering p-version methods. This exercise provides a concrete, calculation-based introduction to the process of hierarchical interpolation on a reference triangle. By sequentially determining the coefficients for vertex and edge modes, you will gain a practical understanding of how higher-order fields are constructed as enrichments upon lower-order approximations, a cornerstone of p-adaptivity. [@problem_id:3570981]", "problem": "Consider the reference triangle $\\hat{T}=\\{(x,y)\\in\\mathbb{R}^2:\\, x\\ge 0,\\, y\\ge 0,\\, x+y\\le 1\\}$ with barycentric coordinates $\\lambda_1=1-x-y$, $\\lambda_2=x$, and $\\lambda_3=y$. A hierarchical $p$-version triangular basis up to polynomial order $p=2$ is defined by the following modes:\n- Vertex modes: $\\psi_1=\\lambda_1$, $\\psi_2=\\lambda_2$, $\\psi_3=\\lambda_3$.\n- Edge modes of order $2$: $\\psi_4=4\\,\\lambda_1\\lambda_2$ on edge $(1,2)$, $\\psi_5=4\\,\\lambda_2\\lambda_3$ on edge $(2,3)$, and $\\psi_6=4\\,\\lambda_3\\lambda_1$ on edge $(3,1)$.\n\nUse a hierarchical nodal interpolation operator with the following degrees of freedom applied sequentially:\n- Vertex values at $V_1=(0,0)$, $V_2=(1,0)$, and $V_3=(0,1)$.\n- Edge midpoint values at $M_{12}=\\left(\\frac{1}{2},0\\right)$, $M_{23}=\\left(\\frac{1}{2},\\frac{1}{2}\\right)$, and $M_{31}=\\left(0,\\frac{1}{2}\\right)$.\n\nFor the quadratic field $u(x,y)=x^2-xy+y^2$, determine the coefficients $c_1,\\dots,c_6$ in the hierarchical expansion\n$$\nI_2 u(x,y)=\\sum_{i=1}^{6} c_i\\,\\psi_i(x,y),\n$$\nby enforcing interpolation at the above degrees of freedom in hierarchical order. Report your answer as the $1\\times 6$ row vector $\\left(c_1, c_2, c_3, c_4, c_5, c_6\\right)$ with exact values. No rounding is required, and no units are involved.", "solution": "The problem is valid. It is a well-posed problem in computational solid mechanics, specifically concerning the Finite Element Method. All definitions, data, and conditions are scientifically sound, consistent, and complete, allowing for a unique solution.\n\nThe objective is to find the coefficients $c_1, \\dots, c_6$ for the hierarchical $p$-version expansion of the quadratic field $u(x,y)=x^2-xy+y^2$ on a reference triangle. The expansion is given by\n$$\nI_2 u(x,y)=\\sum_{i=1}^{6} c_i\\,\\psi_i(x,y)\n$$\nwhere the coefficients are determined by enforcing interpolation at a set of hierarchical nodes. The method relies on the sequential determination of coefficients, starting from the lowest polynomial order.\n\nFirst, we identify the interpolation nodes and the corresponding values of the function $u(x,y)$ and the barycentric coordinates $(\\lambda_1, \\lambda_2, \\lambda_3)$. The barycentric coordinates are defined as $\\lambda_1=1-x-y$, $\\lambda_2=x$, and $\\lambda_3=y$.\n\nThe interpolation points (degrees of freedom) are:\n- Vertices: $V_1=(0,0)$, $V_2=(1,0)$, $V_3=(0,1)$.\n- Edge midpoints: $M_{12}=\\left(\\frac{1}{2},0\\right)$, $M_{23}=\\left(\\frac{1}{2},\\frac{1}{2}\\right)$, $M_{31}=\\left(0,\\frac{1}{2}\\right)$.\n\nLet's evaluate the function $u(x,y) = x^2-xy+y^2$ at these nodes:\n- $u(V_1) = u(0,0) = 0^2 - (0)(0) + 0^2 = 0$.\n- $u(V_2) = u(1,0) = 1^2 - (1)(0) + 0^2 = 1$.\n- $u(V_3) = u(0,1) = 0^2 - (0)(1) + 1^2 = 1$.\n- $u(M_{12}) = u\\left(\\frac{1}{2},0\\right) = \\left(\\frac{1}{2}\\right)^2 - \\left(\\frac{1}{2}\\right)(0) + 0^2 = \\frac{1}{4}$.\n- $u(M_{23}) = u\\left(\\frac{1}{2},\\frac{1}{2}\\right) = \\left(\\frac{1}{2}\\right)^2 - \\left(\\frac{1}{2}\\right)\\left(\\frac{1}{2}\\right) + \\left(\\frac{1}{2}\\right)^2 = \\frac{1}{4} - \\frac{1}{4} + \\frac{1}{4} = \\frac{1}{4}$.\n- $u(M_{31}) = u\\left(0,\\frac{1}{2}\\right) = 0^2 - (0)\\left(\\frac{1}{2}\\right) + \\left(\\frac{1}{2}\\right)^2 = \\frac{1}{4}$.\n\nNext, we evaluate the barycentric coordinates at these nodes:\n- $V_1=(0,0) \\implies (\\lambda_1, \\lambda_2, \\lambda_3) = (1,0,0)$.\n- $V_2=(1,0) \\implies (\\lambda_1, \\lambda_2, \\lambda_3) = (0,1,0)$.\n- $V_3=(0,1) \\implies (\\lambda_1, \\lambda_2, \\lambda_3) = (0,0,1)$.\n- $M_{12}=\\left(\\frac{1}{2},0\\right) \\implies (\\lambda_1, \\lambda_2, \\lambda_3) = \\left(\\frac{1}{2},\\frac{1}{2},0\\right)$.\n- $M_{23}=\\left(\\frac{1}{2},\\frac{1}{2}\\right) \\implies (\\lambda_1, \\lambda_2, \\lambda_3) = \\left(0,\\frac{1}{2},\\frac{1}{2}\\right)$.\n- $M_{31}=\\left(0,\\frac{1}{2}\\right) \\implies (\\lambda_1, \\lambda_2, \\lambda_3) = \\left(\\frac{1}{2},0,\\frac{1}{2}\\right)$.\n\nThe hierarchical interpolation proceeds in stages.\n\n**Stage 1: Determine vertex coefficients ($c_1, c_2, c_3$)**\nWe first consider the linear interpolant, $I_1 u(x,y) = c_1\\psi_1 + c_2\\psi_2 + c_3\\psi_3$, and enforce interpolation at the vertices.\nThe basis functions are $\\psi_1=\\lambda_1$, $\\psi_2=\\lambda_2$, $\\psi_3=\\lambda_3$. These are the standard linear shape functions, which have the property that $\\psi_i(V_j) = \\delta_{ij}$ (the Kronecker delta).\n- At $V_1$: $I_1 u(V_1) = c_1\\psi_1(V_1) + c_2\\psi_2(V_1) + c_3\\psi_3(V_1) = c_1(1) + c_2(0) + c_3(0) = c_1$.\n  Enforcing $I_1 u(V_1) = u(V_1)$, we get $c_1 = 0$.\n- At $V_2$: $I_1 u(V_2) = c_1\\psi_1(V_2) + c_2\\psi_2(V_2) + c_3\\psi_3(V_2) = c_1(0) + c_2(1) + c_3(0) = c_2$.\n  Enforcing $I_1 u(V_2) = u(V_2)$, we get $c_2 = 1$.\n- At $V_3$: $I_1 u(V_3) = c_1\\psi_1(V_3) + c_2\\psi_2(V_3) + c_3\\psi_3(V_3) = c_1(0) + c_2(0) + c_3(1) = c_3$.\n  Enforcing $I_1 u(V_3) = u(V_3)$, we get $c_3 = 1$.\n\nSo, the vertex coefficients are $c_1=0$, $c_2=1$, and $c_3=1$. The linear portion of the interpolant is $I_1 u = (0)\\lambda_1 + (1)\\lambda_2 + (1)\\lambda_3 = \\lambda_2+\\lambda_3 = x+y$.\n\n**Stage 2: Determine edge coefficients ($c_4, c_5, c_6$)**\nNow we consider the full quadratic interpolant, $I_2 u = I_1 u + c_4\\psi_4 + c_5\\psi_5 + c_6\\psi_6$.\nThe crucial property of hierarchical bases is that the higher-order modes (edge modes $\\psi_4, \\psi_5, \\psi_6$) are zero at the nodes of the lower-order approximation (vertices $V_1, V_2, V_3$). For example, $\\psi_4=4\\lambda_1\\lambda_2$ is zero at $V_1$ (where $\\lambda_2=0$), $V_2$ (where $\\lambda_1=0$), and $V_3$ (where both are zero). This ensures that determining $c_4, c_5, c_6$ does not alter the already enforced interpolation conditions at the vertices.\nWe determine the edge coefficients by enforcing interpolation at the edge midpoints.\n\n- For $c_4$ (edge 1-2): We use the midpoint $M_{12}$. The interpolation condition is $I_2 u(M_{12}) = u(M_{12})$.\n  $I_1 u(M_{12}) + c_4\\psi_4(M_{12}) + c_5\\psi_5(M_{12}) + c_6\\psi_6(M_{12}) = u(M_{12})$.\n  At $M_{12}$, the barycentric coordinates are $(\\lambda_1, \\lambda_2, \\lambda_3) = (\\frac{1}{2},\\frac{1}{2},0)$.\n  The edge modes $\\psi_5=4\\lambda_2\\lambda_3$ and $\\psi_6=4\\lambda_3\\lambda_1$ are zero because $\\lambda_3=0$.\n  The mode $\\psi_4(M_{12}) = 4\\lambda_1\\lambda_2 = 4\\left(\\frac{1}{2}\\right)\\left(\\frac{1}{2}\\right) = 1$.\n  The value of the linear interpolant is $I_1 u(M_{12}) = \\lambda_2(M_{12}) + \\lambda_3(M_{12}) = \\frac{1}{2} + 0 = \\frac{1}{2}$.\n  The equation becomes: $\\frac{1}{2} + c_4(1) = u(M_{12}) = \\frac{1}{4}$.\n  Solving for $c_4$: $c_4 = \\frac{1}{4} - \\frac{1}{2} = -\\frac{1}{4}$.\n\n- For $c_5$ (edge 2-3): We use the midpoint $M_{23}$. The condition is $I_2 u(M_{23}) = u(M_{23})$.\n  $I_1 u(M_{23}) + c_4\\psi_4(M_{23}) + c_5\\psi_5(M_{23}) + c_6\\psi_6(M_{23}) = u(M_{23})$.\n  At $M_{23}$, $(\\lambda_1, \\lambda_2, \\lambda_3) = (0,\\frac{1}{2},\\frac{1}{2})$.\n  The edge modes $\\psi_4$ and $\\psi_6$ are zero because $\\lambda_1=0$.\n  The mode $\\psi_5(M_{23}) = 4\\lambda_2\\lambda_3 = 4\\left(\\frac{1}{2}\\right)\\left(\\frac{1}{2}\\right) = 1$.\n  The value of the linear interpolant is $I_1 u(M_{23}) = \\lambda_2(M_{23}) + \\lambda_3(M_{23}) = \\frac{1}{2} + \\frac{1}{2} = 1$.\n  The equation becomes: $1 + c_5(1) = u(M_{23}) = \\frac{1}{4}$.\n  Solving for $c_5$: $c_5 = \\frac{1}{4} - 1 = -\\frac{3}{4}$.\n\n- For $c_6$ (edge 3-1): We use the midpoint $M_{31}$. The condition is $I_2 u(M_{31}) = u(M_{31})$.\n  $I_1 u(M_{31}) + c_4\\psi_4(M_{31}) + c_5\\psi_5(M_{31}) + c_6\\psi_6(M_{31}) = u(M_{31})$.\n  At $M_{31}$, $(\\lambda_1, \\lambda_2, \\lambda_3) = (\\frac{1}{2},0,\\frac{1}{2})$.\n  The edge modes $\\psi_4$ and $\\psi_5$ are zero because $\\lambda_2=0$.\n  The mode $\\psi_6(M_{31}) = 4\\lambda_3\\lambda_1 = 4\\left(\\frac{1}{2}\\right)\\left(\\frac{1}{2}\\right) = 1$.\n  The value of the linear interpolant is $I_1 u(M_{31}) = \\lambda_2(M_{31}) + \\lambda_3(M_{31}) = 0 + \\frac{1}{2} = \\frac{1}{2}$.\n  The equation becomes: $\\frac{1}{2} + c_6(1) = u(M_{31}) = \\frac{1}{4}$.\n  Solving for $c_6$: $c_6 = \\frac{1}{4} - \\frac{1}{2} = -\\frac{1}{4}$.\n\nThe set of hierarchical coefficients is: $c_1=0$, $c_2=1$, $c_3=1$, $c_4=-\\frac{1}{4}$, $c_5=-\\frac{3}{4}$, $c_6=-\\frac{1}{4}$.\n\nVerification: The space spanned by the six basis functions $\\{\\psi_i\\}_{i=1}^6$ is the space of all quadratic polynomials on the triangle, $P_2(\\hat{T})$. Since the given function $u(x,y)=x^2-xy+y^2$ is a quadratic polynomial, its interpolation in this space must be exact. Let's confirm by reconstructing the polynomial.\n$I_2 u = c_1\\lambda_1 + c_2\\lambda_2 + c_3\\lambda_3 + c_4(4\\lambda_1\\lambda_2) + c_5(4\\lambda_2\\lambda_3) + c_6(4\\lambda_3\\lambda_1)$\n$I_2 u = (1)\\lambda_2 + (1)\\lambda_3 - \\frac{1}{4}(4\\lambda_1\\lambda_2) - \\frac{3}{4}(4\\lambda_2\\lambda_3) - \\frac{1}{4}(4\\lambda_3\\lambda_1)$\n$I_2 u = \\lambda_2 + \\lambda_3 - \\lambda_1\\lambda_2 - 3\\lambda_2\\lambda_3 - \\lambda_3\\lambda_1$\nSubstitute $\\lambda_1=1-x-y$, $\\lambda_2=x$, $\\lambda_3=y$:\n$I_2 u(x,y) = x + y - (1-x-y)x - 3xy - y(1-x-y)$\n$I_2 u(x,y) = x + y - (x-x^2-xy) - 3xy - (y-xy-y^2)$\n$I_2 u(x,y) = x + y - x + x^2 + xy - 3xy - y + xy + y^2$\n$I_2 u(x,y) = x^2 + y^2 + (1-3+1)xy = x^2 - xy + y^2 = u(x,y)$.\nThe reconstruction is exact, which validates the calculated coefficients.\n\nThe final answer is the row vector of coefficients $(c_1, c_2, c_3, c_4, c_5, c_6)$.", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n0  1  1  -\\frac{1}{4}  -\\frac{3}{4}  -\\frac{1}{4}\n\\end{pmatrix}\n}\n$$", "id": "3570981"}, {"introduction": "From individual basis functions, we now move to assembling the full element matrices. This practice explores the profound impact of the hierarchical basis design on the structure of the stiffness and mass matrices for a quadrilateral element. By categorizing basis functions as vertex, edge, or interior modes, you will derive and analyze the resulting block matrix structure, revealing crucial sparsity patterns that are exploited in high-performance solvers through techniques like static condensation. [@problem_id:3570949]", "problem": "Consider a single isoparametric quadrilateral finite element whose reference domain is the square $\\hat{\\Omega} = [-1,1] \\times [-1,1]$ with affine mapping to the physical element, so that the Jacobian is constant and scaling factors separate. Adopt a scalar field $u$ in the first-order Sobolev space (H1) as a proxy for a component of displacement in small-strain linear elasticity, and define the local bilinear forms for stiffness and mass as\n$$\na(u,v) = \\int_{\\hat{\\Omega}} \\kappa \\, \\nabla u \\cdot \\nabla v \\, \\mathrm{d}\\xi \\, \\mathrm{d}\\eta, \n\\qquad \nm(u,v) = \\int_{\\hat{\\Omega}} \\rho \\, u \\, v \\, \\mathrm{d}\\xi \\, \\mathrm{d}\\eta,\n$$\nwhere $\\kappa  0$ is a constant diffusivity-like modulus and $\\rho  0$ is a constant density-like coefficient. Let the hierarchical $p$-version tensor-product basis be constructed from one-dimensional hierarchical modes on $[-1,1]$:\n- Vertex modes $l_{1}(\\xi) = \\frac{1 - \\xi}{2}$ and $l_{2}(\\xi) = \\frac{1 + \\xi}{2}$ produce the four corner functions $L_{i}(\\xi,\\eta) = l_{\\alpha}(\\xi) \\, l_{\\beta}(\\eta)$ for $\\alpha,\\beta \\in \\{1,2\\}$.\n- Edge modes on each one-dimensional edge are $\\psi_{k}(\\xi)$ for $k = 2,3,\\dots,p$, defined to vanish at $\\xi = \\pm 1$ and span polynomials of increasing degree hierarchically; likewise in the $\\eta$-direction. A concrete choice may be taken as differences of Legendre polynomials $\\psi_{k}(\\xi) = c_{k}\\left(P_{k}(\\xi)-P_{k-2}(\\xi)\\right)$ with normalization constants $c_{k}0$ and $P_{n}$ the $n$-th Legendre polynomial, though the derivation below holds for any hierarchical $\\psi_{k}$ that vanishes at the endpoints.\n- Interior modes are tensor products $\\Psi_{r,s}(\\xi,\\eta) = \\psi_{r}(\\xi)\\,\\psi_{s}(\\eta)$ with $r,s \\in \\{2,3,\\dots,p\\}$.\n\nClassify the modes by their geometric support: vertex modes $V$, edge modes $E$ (organized per edge and degree), and interior modes $I$. Using the fundamental weak forms above and the separability of the tensor-product basis, derive the local element stiffness matrix $\\mathbf{K}$ and mass matrix $\\mathbf{M}$ in terms of one-dimensional inner products of the hierarchical basis and their derivatives, exposing the Kronecker-product/sum structure. Then, identify and explain the resulting block structure of $\\mathbf{K}$ and $\\mathbf{M}$ when ordered by the $V$–$E$–$I$ classification, stating which blocks are diagonal, which are zero by construction, and which contain nonzero couplings induced by tensor-product separability and boundary vanishing properties.\n\nFinally, for polynomial order $p \\geq 2$, provide a single closed-form analytic expression for the total number of hierarchical degrees of freedom $N(p)$ of this quadrilateral element under the above classification. Express $N(p)$ as a simplified function of $p$.", "solution": "The problem statement is a valid exercise in the p-version finite element method. It is scientifically grounded in computational solid mechanics, mathematically well-posed, objective, and self-contained. All definitions and conditions are standard and allow for a unique, derivable solution. We will proceed with the derivation and analysis as requested.\n\nThe solution is presented in three parts:\n1. Derivation of the local stiffness and mass matrices in terms of one-dimensional inner products and Kronecker products/sums.\n2. Analysis of the block structure of these matrices under a Vertex-Edge-Interior (V-E-I) ordering of basis functions.\n3. Derivation of the total number of degrees of freedom, $N(p)$.\n\n**Part 1: Derivation of Element Matrices**\n\nLet the complete one-dimensional hierarchical basis on $[-1,1]$ be denoted by $\\{\\phi_i(\\xi)\\}_{i=0}^{p}$, where $\\phi_0(\\xi) = l_1(\\xi)$, $\\phi_1(\\xi) = l_2(\\xi)$, and $\\{\\phi_i(\\xi)\\}_{i=2}^{p} = \\{\\psi_i(\\xi)\\}_{i=2}^{p}$. The total number of 1D basis functions is $p+1$. The two-dimensional basis on $\\hat{\\Omega}$ is a tensor product of these 1D bases: $\\{ N_k(\\xi, \\eta) \\} = \\{ \\phi_i(\\xi) \\phi_j(\\eta) \\}_{i,j=0}^{p}$.\n\nWe define the one-dimensional mass and stiffness matrices on the reference interval $[-1,1]$ with respect to the basis $\\{\\phi_i\\}$. Let the components of these $1$D matrices be:\n$$\nM^1_{ij} = \\int_{-1}^{1} \\phi_i(x) \\phi_j(x) \\, \\mathrm{d}x\n$$\n$$\nK^1_{ij} = \\int_{-1}^{1} \\phi'_i(x) \\phi'_j(x) \\, \\mathrm{d}x\n$$\nwhere a prime denotes differentiation with respect to the argument, e.g., $\\phi'_i(x) = \\frac{\\mathrm{d}\\phi_i}{\\mathrm{d}x}(x)$.\n\nThe scalar field $u$ is approximated as a linear combination of the 2D basis functions:\n$$\nu(\\xi, \\eta) = \\sum_{k} u_k N_k(\\xi, \\eta) = \\sum_{i=0}^{p} \\sum_{j=0}^{p} u_{ij} \\phi_i(\\xi) \\phi_j(\\eta)\n$$\nThe components of the element mass matrix $\\mathbf{M}$ and stiffness matrix $\\mathbf{K}$ are given by $M_{kl} = m(N_k, N_l)$ and $K_{kl} = a(N_k, N_l)$ respectively. Let the $k$-th basis function correspond to the index pair $(i,j)$ and the $l$-th basis function to $(p,q)$. Thus, $N_k(\\xi, \\eta) = \\phi_i(\\xi) \\phi_j(\\eta)$ and $N_l(\\xi, \\eta) = \\phi_p(\\xi) \\phi_q(\\eta)$.\n\nFor the mass matrix entry, we have:\n$$\nM_{(i,j),(p,q)} = m(\\phi_i(\\xi)\\phi_j(\\eta), \\phi_p(\\xi)\\phi_q(\\eta)) = \\int_{-1}^{1}\\int_{-1}^{1} \\rho (\\phi_i(\\xi)\\phi_j(\\eta)) (\\phi_p(\\xi)\\phi_q(\\eta)) \\, \\mathrm{d}\\xi \\, \\mathrm{d}\\eta\n$$\nSince $\\rho$ is a constant and the integral is separable:\n$$\nM_{(i,j),(p,q)} = \\rho \\left( \\int_{-1}^{1} \\phi_i(\\xi)\\phi_p(\\xi) \\, \\mathrm{d}\\xi \\right) \\left( \\int_{-1}^{1} \\phi_j(\\eta)\\phi_q(\\eta) \\, \\mathrm{d}\\eta \\right) = \\rho \\, M^1_{ip} \\, M^1_{jq}\n$$\nThis structure is precisely the definition of the Kronecker product ($\\otimes$). If we arrange the basis functions with the $\\eta$ index varying fastest, the full mass matrix is:\n$$\n\\mathbf{M} = \\rho (\\mathbf{M}^1 \\otimes \\mathbf{M}^1)\n$$\n\nFor the stiffness matrix entry, we first compute the gradients:\n$$\n\\nabla N_k = \\nabla(\\phi_i(\\xi)\\phi_j(\\eta)) = \\begin{pmatrix} \\phi'_i(\\xi)\\phi_j(\\eta) \\\\ \\phi_i(\\xi)\\phi'_j(\\eta) \\end{pmatrix}, \\quad \\nabla N_l = \\begin{pmatrix} \\phi'_p(\\xi)\\phi_q(\\eta) \\\\ \\phi_p(\\xi)\\phi'_q(\\eta) \\end{pmatrix}\n$$\nThe integrand of the stiffness bilinear form is $\\nabla N_k \\cdot \\nabla N_l = \\phi'_i\\phi'_p\\phi_j\\phi_q + \\phi_i\\phi_p\\phi'_j\\phi'_q$.\n$$\nK_{(i,j),(p,q)} = a(N_k, N_l) = \\kappa \\int_{-1}^{1}\\int_{-1}^{1} (\\phi'_i(\\xi)\\phi'_p(\\xi)\\phi_j(\\eta)\\phi_q(\\eta) + \\phi_i(\\xi)\\phi_p(\\xi)\\phi'_j(\\eta)\\phi'_q(\\eta)) \\, \\mathrm{d}\\xi \\, \\mathrm{d}\\eta\n$$\nSeparating the integrals:\n$$\nK_{(i,j),(p,q)} = \\kappa \\left[ \\left(\\int_{-1}^{1} \\phi'_i(\\xi)\\phi'_p(\\xi)\\mathrm{d}\\xi\\right)\\left(\\int_{-1}^{1} \\phi_j(\\eta)\\phi_q(\\eta)\\mathrm{d}\\eta\\right) + \\left(\\int_{-1}^{1} \\phi_i(\\xi)\\phi_p(\\xi)\\mathrm{d}\\xi\\right)\\left(\\int_{-1}^{1} \\phi'_j(\\eta)\\phi'_q(\\eta)\\mathrm{d}\\eta\\right) \\right]\n$$\n$$\nK_{(i,j),(p,q)} = \\kappa ( K^1_{ip} M^1_{jq} + M^1_{ip} K^1_{jq} )\n$$\nThis structure corresponds to the Kronecker sum. The full stiffness matrix is:\n$$\n\\mathbf{K} = \\kappa (\\mathbf{K}^1 \\otimes \\mathbf{M}^1 + \\mathbf{M}^1 \\otimes \\mathbf{K}^1)\n$$\nThis derivation formally expresses the element matrices in terms of one-dimensional integrals and reveals their underlying Kronecker product/sum structure, as required.\n\n**Part 2: Block Structure Analysis**\n\nWe now re-order the basis functions according to the geometric classification: Vertex (V), Edge (E), and Interior (I).\n- **Vertex modes (V)**: $4$ functions $\\{l_\\alpha(\\xi)l_\\beta(\\eta)\\}_{\\alpha,\\beta \\in \\{1,2\\}}$.\n- **Edge modes (E)**: $4(p-1)$ functions. For edges parallel to the $\\xi$-axis, these are $\\{ \\psi_k(\\xi)l_\\beta(\\eta) \\}_{k=2..p, \\beta=1,2}$. For edges parallel to the $\\eta$-axis, $\\{ l_\\alpha(\\xi)\\psi_k(\\eta) \\}_{k=2..p, \\alpha=1,2}$.\n- **Interior modes (I)**: $(p-1)^2$ functions $\\{ \\psi_r(\\xi)\\psi_s(\\eta) \\}_{r,s=2..p}$.\n\nA crucial property of the hierarchical edge modes $\\psi_k(x)$ is that they vanish at the endpoints: $\\psi_k(\\pm 1) = 0$. This implies orthogonality between the derivatives of vertex modes and edge/interior modes. The 1D vertex modes $l_\\alpha(x)$ are linear, so $l''_\\alpha(x) = 0$. For any $k \\ge 2$:\n$$\n\\int_{-1}^{1} l'_\\alpha(x) \\psi'_k(x) \\, \\mathrm{d}x = [l'_\\alpha(x) \\psi_k(x)]_{-1}^{1} - \\int_{-1}^{1} l''_\\alpha(x) \\psi_k(x) \\, \\mathrm{d}x = l'_\\alpha(\\pm 1)\\psi_k(\\pm 1) - 0 = 0\n$$\nThis result, $\\langle l'_\\alpha, \\psi'_k \\rangle = 0$, is the key to the block structure of the stiffness matrix.\n\nThe matrices partitioned by the V-E-I ordering take the form:\n$$\n\\mathbf{M} = \\begin{pmatrix} \\mathbf{M}_{VV}  \\mathbf{M}_{VE}  \\mathbf{M}_{VI} \\\\ \\mathbf{M}_{EV}  \\mathbf{M}_{EE}  \\mathbf{M}_{EI} \\\\ \\mathbf{M}_{IV}  \\mathbf{M}_{IE}  \\mathbf{M}_{II} \\end{pmatrix}, \\quad \\mathbf{K} = \\begin{pmatrix} \\mathbf{K}_{VV}  \\mathbf{K}_{VE}  \\mathbf{K}_{VI} \\\\ \\mathbf{K}_{EV}  \\mathbf{K}_{EE}  \\mathbf{K}_{EI} \\\\ \\mathbf{K}_{IV}  \\mathbf{K}_{IE}  \\mathbf{K}_{II} \\end{pmatrix}\n$$\n\n**Mass Matrix ($\\mathbf{M}$) Block Structure:**\nThe mass form $m(u,v) = \\rho \\int_{\\hat{\\Omega}} u v \\, \\mathrm{d}\\xi\\mathrm{d}\\eta$ involves $L^2$ inner products. The hierarchical basis functions are generally not $L^2$-orthogonal across different types (V, E, I). For example, $\\int_{-1}^{1} l_\\alpha(x) \\psi_k(x) \\, \\mathrm{d}x \\neq 0$. Consequently, all off-diagonal blocks of the mass matrix are generally non-zero and densely populated.\n- $\\mathbf{M}_{VE}, \\mathbf{M}_{VI}, \\mathbf{M}_{EI}$ are all **non-zero**.\nThe mass matrix $\\mathbf{M}$ is a **fully coupled (dense) matrix** in this block partitioning.\n\n**Stiffness Matrix ($\\mathbf{K}$) Block Structure:**\nThe structure of $\\mathbf{K}$ is sparse due to the $\\langle l'_\\alpha, \\psi'_k \\rangle = 0$ property.\n- **$\\mathbf{K}_{VI}$ and $\\mathbf{K}_{IV}$ (Vertex-Interior Coupling):**\nLet $u = l_\\alpha(\\xi)l_\\beta(\\eta) \\in V$ and $v = \\psi_r(\\xi)\\psi_s(\\eta) \\in I$.\n$a(u,v) = \\kappa \\left( \\langle l'_\\alpha, \\psi'_r \\rangle \\langle l_\\beta, \\psi_s \\rangle + \\langle l_\\alpha, \\psi_r \\rangle \\langle l'_\\beta, \\psi'_s \\rangle \\right)$.\nBoth terms are zero because $\\langle l'_\\alpha, \\psi'_r \\rangle = 0$ and $\\langle l'_\\beta, \\psi'_s \\rangle = 0$.\nThus, $\\mathbf{K}_{VI} = \\mathbf{0}$ and by symmetry, $\\mathbf{K}_{IV} = \\mathbf{0}$. This is a fundamental property of hierarchical bases: vertex modes are $H^1$-orthogonal to interior modes.\n\n- **$\\mathbf{K}_{VE}$ and $\\mathbf{K}_{EI}$ (Other Couplings):**\nThese blocks are generally non-zero. For example, consider $u = l_\\alpha(\\xi)l_\\beta(\\eta) \\in V$ and an edge mode $v = \\psi_k(\\xi)l_\\gamma(\\eta) \\in E$.\n$a(u,v) = \\kappa \\left( \\langle l'_\\alpha, \\psi'_k \\rangle \\langle l_\\beta, l_\\gamma \\rangle + \\langle l_\\alpha, \\psi_k \\rangle \\langle l'_\\beta, l'_\\gamma \\rangle \\right) = \\kappa \\langle l_\\alpha, \\psi_k \\rangle \\langle l'_\\beta, l'_\\gamma \\rangle \\neq 0$.\nSo $\\mathbf{K}_{VE}$ and $\\mathbf{K}_{EV}$ are **non-zero**.\nSimilarly, for $u = \\psi_k(\\xi)l_\\beta(\\eta) \\in E$ and $v = \\psi_r(\\xi)\\psi_s(\\eta) \\in I$:\n$a(u,v) = \\kappa \\left( \\langle \\psi'_k, \\psi'_r \\rangle \\langle l_\\beta, \\psi_s \\rangle + \\langle \\psi_k, \\psi_r \\rangle \\langle l'_\\beta, \\psi'_s \\rangle \\right) = \\kappa \\langle \\psi'_k, \\psi'_r \\rangle \\langle l_\\beta, \\psi_s \\rangle \\neq 0$.\nSo $\\mathbf{K}_{EI}$ and $\\mathbf{K}_{IE}$ are also **non-zero**.\n\n- **$\\mathbf{K}_{EE}$ (Edge-Edge Block):**\nThis block has a specific structure. Edge modes on perpendicular edges are $H^1$-orthogonal. For $u = \\psi_k(\\xi)l_\\alpha(\\eta)$ and $v = l_\\beta(\\xi)\\psi_r(\\eta)$:\n$a(u,v) = \\kappa \\left( \\langle \\psi'_k, l'_\\beta \\rangle \\langle l_\\alpha, \\psi_r \\rangle + \\langle \\psi_k, l_\\beta \\rangle \\langle l'_\\alpha, \\psi'_r \\rangle \\right) = 0 + 0 = 0$.\nTherefore, $\\mathbf{K}_{EE}$ is **block-diagonal**, with non-zero couplings only between modes on the same edge or on parallel edges.\n\nIn summary, the stiffness matrix has the following block structure:\n$$\n\\mathbf{K} = \\begin{pmatrix} \\mathbf{K}_{VV}  \\mathbf{K}_{VE}  \\mathbf{0} \\\\ \\mathbf{K}_{EV}  \\mathbf{K}_{EE}  \\mathbf{K}_{EI} \\\\ \\mathbf{0}  \\mathbf{K}_{IE}  \\mathbf{K}_{II} \\end{pmatrix}\n$$\nwhere $\\mathbf{K}_{EE}$ is itself block-diagonal, separating modes associated with $\\xi$-edges from those associated with $\\eta$-edges. The diagonal blocks $\\mathbf{K}_{VV}$, $\\mathbf{K}_{EE}$, and $\\mathbf{K}_{II}$ are generally non-diagonal and contain non-zero entries.\n\n**Part 3: Total Number of Degrees of Freedom**\n\nThe total number of degrees of freedom (DoFs), $N(p)$, is the total number of basis functions for a polynomial order $p$. We can sum the number of modes in each category for $p \\ge 2$:\n1.  **Vertex Modes ($N_V$):** There are $4$ corners, each associated with one vertex mode (the tensor products of 1D linear hat functions).\n    $$N_V = 4$$\n2.  **Edge Modes ($N_E$):** There are $4$ edges. For each edge, there are hierarchical modes of degree $k=2, 3, \\dots, p$. The number of such modes per edge is $p-1$.\n    $$N_E = 4 \\times (p-1)$$\n3.  **Interior Modes ($N_I$):** These are tensor products of the 1D edge modes, $\\psi_r(\\xi)\\psi_s(\\eta)$. The indices $r$ and $s$ both range from $2$ to $p$. The number of choices for each index is $p-1$.\n    $$N_I = (p-1) \\times (p-1) = (p-1)^2$$\n\nThe total number of degrees of freedom $N(p)$ is the sum:\n$$\nN(p) = N_V + N_E + N_I = 4 + 4(p-1) + (p-1)^2\n$$\nExpanding and simplifying this expression:\n$$\nN(p) = 4 + 4p - 4 + (p^2 - 2p + 1)\n$$\n$$\nN(p) = p^2 + 2p + 1\n$$\nThis can be factored into a simple form:\n$$\nN(p) = (p+1)^2\n$$\nThis result is consistent with the tensor product construction, where we have $p+1$ basis functions in one dimension ($\\{l_1, l_2, \\psi_2, \\dots, \\psi_p\\}$), leading to $(p+1) \\times (p+1)$ functions in two dimensions.", "answer": "$$\n\\boxed{(p+1)^2}\n$$", "id": "3570949"}, {"introduction": "Theory meets practice in this final exercise, which explores the consequences of applying hierarchical bases to geometrically complex elements. While previous examples focused on ideal affine mappings, real-world problems often involve curved geometries handled via isoparametric mappings. This computational problem directs you to implement a set of hierarchical functions and quantify how a non-affine mapping distorts the element, breaking the convenient orthogonality of the basis and leading to a denser stiffness matrix. [@problem_id:3570964]", "problem": "Consider the one-dimensional reference element $[-1,1]$ and a hierarchical $p$-version basis constructed from integrated Legendre polynomials. Let $P_n(\\xi)$ denote the Legendre polynomial of degree $n$ on $[-1,1]$, defined by the recurrence relation and orthogonality property $\\int_{-1}^{1} P_m(\\xi) P_n(\\xi) \\, d\\xi = \\frac{2}{2n+1} \\delta_{mn}$, where $\\delta_{mn}$ is the Kronecker delta. Define the bubble functions $\\{b_k(\\xi)\\}_{k=2}^{p}$ by $b_k'(\\xi) = c_k P_{k-1}(\\xi)$ with $c_k = \\sqrt{\\frac{2k-1}{2}}$, and $b_k(\\xi) = c_k \\int_{-1}^{\\xi} P_{k-1}(t) \\, dt$ chosen to vanish at $\\xi=-1$. This choice of $c_k$ makes the derivative inner products orthonormal on the reference element, namely $\\int_{-1}^{1} b_k'(\\xi) b_m'(\\xi) \\, d\\xi = \\delta_{km}$ for all $k,m \\in \\{2,\\dots,p\\}$.\n\nConsider an isoparametric quadratic mapping from the reference coordinate $\\xi \\in [-1,1]$ to a physical coordinate $x(\\xi)$ defined by three physical nodes at $\\xi=-1$, $\\xi=0$, and $\\xi=1$ with coordinates $X_{-1} = 0$, $X_0 = c$, and $X_{1} = L$, where $L$ is the element length and $c$ controls the curvature of the mapping along the physical line. Using the standard quadratic Lagrange shape functions $N_{-1}(\\xi) = \\frac{\\xi(\\xi-1)}{2}$, $N_0(\\xi) = (1-\\xi)(1+\\xi)$, and $N_1(\\xi) = \\frac{\\xi(\\xi+1)}{2}$, the mapping is $x(\\xi) = X_{-1} N_{-1}(\\xi) + X_0 N_0(\\xi) + X_1 N_1(\\xi)$, with Jacobian $J(\\xi) = \\frac{dx}{d\\xi}$. For $X_{-1}=0$, $X_1=L$, and $X_0=c$, one obtains $J(\\xi) = \\frac{1}{2}(2\\xi+1) - 2\\xi c$ when $L=1$. Assume $L=1$ and choose $c$ such that $J(\\xi)  0$ for all $\\xi \\in [-1,1]$, ensuring a valid mapping.\n\nDefine the Gram matrix $G \\in \\mathbb{R}^{(p-1)\\times(p-1)}$ on the physical element for the bubble subspace by\n$$\nG_{ij} = \\int_{-1}^{1} \\frac{db_i}{dx}(\\xi)\\, \\frac{db_j}{dx}(\\xi) \\, dx,\n$$\nwhere the chain rule $ \\frac{d}{dx} = \\frac{1}{J(\\xi)} \\frac{d}{d\\xi} $ yields the computable form\n$$\nG_{ij} = \\int_{-1}^{1} \\frac{b_i'(\\xi)\\, b_j'(\\xi)}{J(\\xi)} \\, d\\xi.\n$$\nWhen $J(\\xi)$ is constant (affine mapping), $G$ is diagonal due to the orthonormality of $\\{b_k'(\\xi)\\}$ with unit weight on $[-1,1]$. When $J(\\xi)$ varies (non-affine curved mapping), the weight $1/J(\\xi)$ breaks orthogonality and off-diagonal entries generally arise.\n\nYour task is to:\n- Implement the hierarchical bubble basis $\\{b_k\\}_{k=2}^{p}$ using the definition above.\n- Assemble the Gram matrix $G$ on the physical element using the integral with weight $1/J(\\xi)$.\n- Quantify orthogonality degradation by the scalar metric\n$$\nr = \\frac{\\max_{i\\neq j} |G_{ij}|}{\\frac{1}{n}\\sum_{i=1}^{n} G_{ii}},\n$$\nwhere $n = p-1$ is the number of bubble functions. The numerator is the maximum absolute off-diagonal entry and the denominator is the mean of the diagonal entries. This $r$ is dimensionless.\n\nUse Gaussian quadrature on $[-1,1]$ with a sufficiently high number of points to obtain numerically converged integrals for all specified $p$ and $c$. The integrated Legendre construction ensures that for an affine mapping with constant $J(\\xi)$, the off-diagonal terms vanish to numerical quadrature tolerance.\n\nTest suite:\n- Case $1$: $p=4$, $c=\\frac{1}{2}$.\n- Case $2$: $p=4$, $c=0.6$.\n- Case $3$: $p=10$, $c=0.6$.\n- Case $4$: $p=10$, $c=\\frac{1}{2}$.\n- Case $5$: $p=16$, $c=0.7$.\n- Case $6$: $p=16$, $c=0.26$.\n\nAll cases use $L=1$. For all reported results, use the scalar metric $r$ defined above and round to $10$ significant digits.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the same order as the test suite, for example $[r_1,r_2,\\dots,r_6]$.", "solution": "The user wants to solve a computational solid mechanics problem involving hierarchical p-version shape functions.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n\n-   **Domain**: One-dimensional reference element $\\xi \\in [-1,1]$.\n-   **Basis Polynomials**: Legendre polynomials $P_n(\\xi)$ with orthogonality $\\int_{-1}^{1} P_m(\\xi) P_n(\\xi) \\, d\\xi = \\frac{2}{2n+1} \\delta_{mn}$.\n-   **Hierarchical Bubble Functions**: A set $\\{b_k(\\xi)\\}_{k=2}^{p}$ is defined via their derivatives.\n-   **Bubble Function Derivatives**: $b_k'(\\xi) = c_k P_{k-1}(\\xi)$, with the normalization constant $c_k = \\sqrt{\\frac{2k-1}{2}}$. This definition ensures the derivatives are orthonormal on the reference element, i.e., $\\int_{-1}^{1} b_k'(\\xi) b_m'(\\xi) \\, d\\xi = \\delta_{km}$ for $k,m \\in \\{2,\\dots,p\\}$.\n-   **Geometric Mapping**: An isoparametric quadratic mapping from the reference coordinate $\\xi$ to a physical coordinate $x(\\xi)$. The mapping is defined by nodal coordinates $X_{-1} = 0$, $X_0 = c$, and $X_{1} = L$ at $\\xi=-1, 0, 1$ respectively.\n-   **Mapping Shape Functions**: Standard quadratic Lagrange polynomials $N_{-1}(\\xi) = \\frac{\\xi(\\xi-1)}{2}$, $N_0(\\xi) = (1-\\xi)(1+\\xi)$, and $N_1(\\xi) = \\frac{\\xi(\\xi+1)}{2}$.\n-   **Mapping Formula**: $x(\\xi) = X_{-1} N_{-1}(\\xi) + X_0 N_0(\\xi) + X_1 N_1(\\xi)$.\n-   **Jacobian**: The Jacobian of the mapping is $J(\\xi) = \\frac{dx}{d\\xi}$. For the specific case $L=1$, it is given as $J(\\xi) = \\frac{1}{2}(2\\xi+1) - 2\\xi c$.\n-   **Mapping Validity**: The problem assumes $L=1$ and a choice of $c$ such that $J(\\xi)  0$ for all $\\xi \\in [-1,1]$.\n-   **Gram Matrix**: A matrix $G \\in \\mathbb{R}^{(p-1)\\times(p-1)}$ for the bubble subspace is defined by $G_{ij} = \\int_{-1}^{1} \\frac{db_i}{dx}(\\xi)\\, \\frac{db_j}{dx}(\\xi) \\, dx$.\n-   **Computable Form of Gram Matrix**: Using the chain rule $\\frac{d}{dx} = \\frac{1}{J(\\xi)}\\frac{d}{d\\xi}$ and change of variables $dx = J(\\xi)d\\xi$, the integral becomes $G_{ij} = \\int_{-1}^{1} \\frac{b_i'(\\xi)\\, b_j'(\\xi)}{J(\\xi)} \\, d\\xi$.\n-   **Orthogonality Degradation Metric**: A scalar metric $r$ is defined as $r = \\frac{\\max_{i\\neq j} |G_{ij}|}{\\frac{1}{n}\\sum_{i=1}^{n} G_{ii}}$, where $n = p-1$ is the number of bubble functions.\n-   **Numerical Method**: Gaussian quadrature is specified for numerical integration.\n-   **Test Suite**: Six cases with specified parameters $(p, c)$: $(4, 1/2)$, $(4, 0.6)$, $(10, 0.6)$, $(10, 1/2)$, $(16, 0.7)$, $(16, 0.26)$.\n-   **Output requirement**: A single line of comma-separated results for $r$, rounded to $10$ significant digits.\n\n**Step 2: Validate Using Extracted Givens**\n\n-   **Scientific Grounding**: The problem is well-grounded in the theory of the p-version Finite Element Method (FEM), a standard topic in computational solid mechanics. All definitions and formulas, including those for Legendre polynomials, isoparametric mapping, and hierarchical bases, are standard and correct.\n-   **Well-Posedness**: The problem provides all necessary information to compute the metric $r$. The Jacobian $J(\\xi) = (1-2c)\\xi + 1/2$ is a linear function of $\\xi$. The condition $J(\\xi)0$ on $[-1,1]$ requires $J(-1)0$ and $J(1)0$, which implies $2c-1/20$ and $3/2-2c0$. This restricts $c$ to the open interval $(1/4, 3/4)$. All provided test cases for $c$ ($0.5, 0.6, 0.7, 0.26$) lie within this valid range, ensuring a non-degenerate mapping. The metric $r$ is unambiguously defined.\n-   **Objectivity**: The problem is stated in precise, objective mathematical language, free of ambiguity or subjective claims.\n\nThere is a minor ambiguity in the problem statement regarding the indexing of the Gram matrix $G_{ij}$. The bubble functions are indexed by $k$ from $2$ to $p$, while the metric $r$ uses indices $i, j$ from $1$ to $n=p-1$. A logical and standard interpretation is to create an ordered basis from the set of bubble functions. Let the $i$-th basis function (for $i=1, \\dots, p-1$) be $b_{i+1}$. This establishes a clear mapping and resolves the ambiguity, making the problem fully specified.\n\n**Step 3: Verdict and Action**\n\nThe problem is deemed **valid**. It is a well-defined computational exercise in FEM theory.\n\n### Principle-Based Design\n\nThe solution is designed by following these steps:\n\n1.  **Basis Function Representation**: The core of the problem lies in the hierarchical bubble basis. The Gram matrix calculation requires the derivatives of these basis functions, $b_k'(\\xi)$. As established during validation, we define an ordered basis of $n=p-1$ functions, where the $i$-th function derivative (for $i=1, \\dots, n$) corresponds to $b'_{i+1}(\\xi)$. From the problem definition, this gives:\n    $$\n    \\text{i-th basis derivative: } \\phi_i(\\xi) = b'_{i+1}(\\xi) = c_{i+1} P_{(i+1)-1}(\\xi) = \\sqrt{\\frac{2(i+1)-1}{2}} P_i(\\xi) = \\sqrt{\\frac{2i+1}{2}} P_i(\\xi)\n    $$\n    where $P_i(\\xi)$ is the Legendre polynomial of degree $i$.\n\n2.  **Jacobian of the Mapping**: The Jacobian for $L=1$ is given and verified as $J(\\xi) = (1-2c)\\xi + 1/2$. This function defines the geometric distortion from the reference to the physical element.\n\n3.  **Gram Matrix Assembly**: The Gram matrix elements $G_{ij}$ (for $i,j = 1, \\dots, n$) are computed by integrating the basis functions over the reference domain with the weighting factor $1/J(\\xi)$:\n    $$\n    G_{ij} = \\int_{-1}^{1} \\frac{\\phi_i(\\xi) \\phi_j(\\xi)}{J(\\xi)} \\, d\\xi = \\int_{-1}^{1} \\frac{\\left(\\sqrt{\\frac{2i+1}{2}} P_i(\\xi)\\right) \\left(\\sqrt{\\frac{2j+1}{2}} P_j(\\xi)\\right)}{(1-2c)\\xi + 1/2} \\, d\\xi\n    $$\n    $$\n    G_{ij} = \\frac{\\sqrt{(2i+1)(2j+1)}}{2} \\int_{-1}^{1} \\frac{P_i(\\xi) P_j(\\xi)}{(1-2c)\\xi + 1/2} \\, d\\xi\n    $$\n    For the affine case where $c=1/2$, $J(\\xi)=1/2$ is constant. The integral simplifies, and due to the orthonormality of the chosen basis derivatives, $G_{ij}$ is expected to be a diagonal matrix, $G=2I$. For $c \\neq 1/2$, the term $1/J(\\xi)$ is not constant, breaking the orthogonality and leading to non-zero off-diagonal terms.\n\n4.  **Numerical Integration**: The integral for $G_{ij}$ is computed numerically using Gaussian quadrature, as specified. The integrand is a product of two Legendre polynomials (total degree $i+j$) divided by a linear function. A sufficiently high number of quadrature points is used to ensure accuracy across all test cases, particularly for large $p$ and for values of $c$ where $J(\\xi)$ varies steeply. A fixed number of $200$ points provides high precision for the maximum polynomial degree and rational function behavior encountered.\n\n5.  **Metric Calculation**: Once the Gram matrix $G$ is assembled, the metric $r$ is calculated directly from its definition:\n    -   Compute the mean of the diagonal entries: $\\bar{G}_{diag} = \\frac{1}{n} \\sum_{i=1}^{n} G_{ii}$.\n    -   Find the maximum absolute value of the off-diagonal entries: $G_{off-diag, max} = \\max_{i \\neq j} |G_{ij}|$.\n    -   The metric is the ratio: $r = G_{off-diag, max} / \\bar{G}_{diag}$.\n\n6.  **Implementation**: The algorithm is implemented in Python using the `numpy` library for efficient array operations and `scipy.special` for evaluating Legendre polynomials (`eval_legendre`) and generating Gaussian quadrature rules (`roots_legendre`). The code iterates through the test suite, calculates $r$ for each case, and formats the final output as requested.", "answer": "```python\nimport numpy as np\nfrom scipy.special import eval_legendre, roots_legendre\n\ndef solve_for_case(p: int, c: float) - float:\n    \"\"\"\n    Calculates the orthogonality degradation metric 'r' for a given polynomial\n    degree 'p' and curvature parameter 'c'.\n\n    Args:\n        p: The maximum polynomial degree for the hierarchical basis.\n        c: The curvature parameter for the isoparametric mapping.\n\n    Returns:\n        The scalar metric 'r'.\n    \"\"\"\n    n = p - 1  # Number of bubble functions, and size of the Gram matrix.\n    \n    if n = 1:\n        return 0.0\n\n    # Use a fixed, high number of quadrature points for all cases to ensure convergence.\n    # The integrand involves polynomials up to degree 2*(n-1), divided by a linear function.\n    # Nq=200 is sufficient for p=16 and provides high accuracy.\n    Nq = 200\n    xi_q, w_q = roots_legendre(Nq)\n\n    # Define the Jacobian of the isoparametric mapping for L=1.\n    J_vals = (1.0 - 2.0 * c) * xi_q + 0.5\n\n    # The problem constraints on 'c' ensure J > 0, so no check is strictly needed.\n\n    # Initialize the Gram matrix. We use 0-based indexing for the array.\n    # The matrix indices i, j in the problem statement run from 1 to n.\n    # In the code, these correspond to i_idx, j_idx from 0 to n-1.\n    G = np.zeros((n, n), dtype=np.float64)\n    \n    # Pre-compute Legendre polynomial values P_i(xi_q) for degrees i = 0 to n-1.\n    # P_vals[i_idx] will store the values of P_i_idx at all quadrature points.\n    P_vals = np.zeros((n, Nq), dtype=np.float64) \n    for i_idx in range(n):\n        P_vals[i_idx, :] = eval_legendre(i_idx + 1, xi_q) # P_k for k=1..n\n\n    # Assemble the Gram matrix G.\n    for i_idx in range(n):\n        for j_idx in range(i_idx, n):  # Exploit symmetry G_ij = G_ji.\n            i = i_idx + 1  # 1-based index k for b'_k\n            j = j_idx + 1  # 1-based index m for b'_m\n\n            # The derivative of the (k)-th basis function is b'_{k}(xi) = sqrt((2k-1)/2) * P_{k-1}(xi).\n            # The indices for P_vals are 0-based from 1 to n. So P_{k-1} is at index k-2.\n            # i = k-1 from problem. Here my P_vals[i_idx] is P_{i_idx+1}.\n            # Let's adjust to match problem definition.\n            # Basis b'_k corresponds to P_{k-1}. For k=2..p, the poly degree is 1..p-1.\n            # i_idx from 0..n-1. Poly degree is i_idx+1.\n            # Basis k is i_idx+2. P_{i_idx+1}.\n            # No, let's stick to the problem def: i,j in G are 1..n. So b_{i+1}, b_{j+1}.\n            # Derivatives are b'_{i+1} ~ P_i and b'_{j+1} ~ P_j.\n            # Let's rebuild P_vals from 0..n-1 as poly degree.\n            P_vals_reindexed = np.zeros((n, Nq))\n            for deg in range(n): # deg = 0..n-1\n                 P_vals_reindexed[deg,:] = eval_legendre(deg, xi_q)\n\n            # Let G_ij map to G[i-1, j-1]\n            i = i_idx + 1\n            j = j_idx + 1\n            \n            # Derivative of b_{i+1} involves P_i. Index of P_i is i.\n            # Derivative of b_{j+1} involves P_j. Index of P_j is j.\n            \n            P_i_vals = eval_legendre(i, xi_q)\n            P_j_vals = eval_legendre(j, xi_q)\n\n            # This part seems overly complex. The original problem defines bubble functions\n            # k=2..p. This gives n=p-1 functions. Let's index them from 1 to n.\n            # The i-th function in this set is b_{i+1}. Its derivative is c_{i+1} P_i.\n            # So the integrand for G_ij uses P_{i-1} and P_{j-1}.\n            \n            p_deg_i = i_idx\n            p_deg_j = j_idx\n            \n            const = np.sqrt((2.0 * (p_deg_i+2) - 1.0) / 2.0) * np.sqrt((2.0 * (p_deg_j+2) - 1.0) / 2.0)\n            \n            p_i_vals = eval_legendre(p_deg_i+1, xi_q)\n            p_j_vals = eval_legendre(p_deg_j+1, xi_q)\n\n            integrand_vals = (const * p_i_vals * p_j_vals) / J_vals\n            \n            integral = np.sum(integrand_vals * w_q)\n            \n            G[i_idx, j_idx] = integral\n            if i_idx != j_idx:\n                G[j_idx, i_idx] = integral\n\n    # Compute the orthogonality degradation metric 'r'.\n    diag_mean = np.mean(np.diag(G))\n\n    if n > 1:\n        # Create a boolean mask to select only the off-diagonal elements.\n        off_diag_mask = ~np.eye(n, dtype=bool)\n        if np.any(off_diag_mask):\n            off_diag_max = np.max(np.abs(G[off_diag_mask]))\n        else: # n=1 case, no off-diagonal\n            off_diag_max = 0.0\n    else:\n        off_diag_max = 0.0\n\n    # Avoid division by zero, although diag_mean should always be positive.\n    if diag_mean == 0:\n        r = np.inf if off_diag_max > 0 else 0.0\n    else:\n        r = off_diag_max / diag_mean\n\n    return r\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print results.\n    \"\"\"\n    test_cases = [\n        (4, 0.5),      # Case 1\n        (4, 0.6),      # Case 2\n        (10, 0.6),     # Case 3\n        (10, 0.5),     # Case 4\n        (16, 0.7),     # Case 5\n        (16, 0.26),    # Case 6\n    ]\n\n    results = []\n    for p, c in test_cases:\n        r = solve_for_case(p, c)\n        results.append(r)\n\n    # Format the final output as a comma-separated list of values rounded to 10 significant digits.\n    formatted_results = [f\"{r:.10g}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n\n```", "id": "3570964"}]}