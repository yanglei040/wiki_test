{"hands_on_practices": [{"introduction": "To build a solid foundation in finite element analysis, we begin with the simplest three-dimensional element: the 4-node linear tetrahedron (T4). Its behavior is governed by its linear shape functions, which lead to a constant strain field throughout the element. This practice challenges you to formalize this key concept by determining the minimum integration rule required to compute the T4 element stiffness matrix exactly, a direct consequence of its constant strain nature [@problem_id:3605708].", "problem": "In small-strain linear elasticity with a homogeneous, isotropic constitutive tensor, consider a linear tetrahedral element with four nodes (T4). The element-level stiffness matrix follows from the principle of virtual work as the volume integral of the product of kinematic and constitutive operators over the element domain. The T4 interpolation is isoparametric and linear, so the mapping from the reference tetrahedron to the physical element is affine. Assume no body-force contribution to the stiffness, no geometric nonlinearity, and a constant constitutive tensor on the element.\n\nFrom first principles, the element stiffness integrand is obtained by substituting the finite element displacement approximation into the small-strain definition and then into the internal virtual work statement. Recognize the implications of linear shape functions on the strain-displacement matrix and the Jacobian of the isoparametric map.\n\nWhich of the following statements correctly identifies the minimal-order tetrahedral quadrature required to integrate the T4 element stiffness exactly and provides a correct justification for why a single centroid evaluation suffices?\n\nA. Degree-of-exactness $0$ is sufficient. A one-point rule at the centroid with weight $w_1 = V_e$ is exact because the strain-displacement matrix $B$ is constant for an affine T4 map and the constitutive tensor $C$ is constant, so $B^{\\top} C B$ and the Jacobian determinant are constant, making the integrand constant over the element.\n\nB. Degree-of-exactness $1$ is required. Although the T4 shape functions are linear, their gradients vary linearly, so the product $B^{\\top} C B$ is linear and demands at least a one-point centroid rule to be exact.\n\nC. Degree-of-exactness $2$ is required. The integrand $B^{\\top} C B$ is quadratic in the spatial coordinates because $B$ is linear for T4, hence at least a four-point rule is needed to integrate the stiffness exactly.\n\nD. A one-point rule is insufficient because reduced integration introduces spurious zero-energy modes in tetrahedra; therefore a higher-order rule with at least degree-of-exactness $1$ must be used to avoid shear locking and hourglassing.", "solution": "The problem asks for the minimal-order numerical quadrature required to exactly integrate the stiffness matrix of a 4-node linear tetrahedral element (T4) in the context of small-strain linear elasticity, and the justification for this requirement.\n\n**1. Derivation from First Principles**\n\nThe element stiffness matrix, $K^e$, is derived from the principle of virtual work. For a linear elastic, homogeneous material, it is expressed as a volume integral over the element's domain, $V_e$:\n$$ K^e = \\int_{V_e} B^{\\top} C B \\, dV $$\nwhere:\n-   $C$ is the constitutive matrix, representing the material's stress-strain relationship. The problem states it is constant.\n-   $B$ is the strain-displacement matrix, which relates the nodal displacements to the strain field within the element.\n\nThe displacement field, $\\mathbf{u}$, at any point within the element is interpolated from the nodal displacements, $\\mathbf{u}_e$, using shape functions, $N_i$:\n$$ \\mathbf{u} = N \\mathbf{u}_e = \\sum_{i=1}^{4} N_i \\mathbf{u}_i $$\nFor a T4 element, the four shape functions $N_i(x,y,z)$ for $i \\in \\{1, 2, 3, 4\\}$ are linear polynomials of the spatial coordinates $(x,y,z)$. A general linear function in 3D is of the form $f(x,y,z) = a + bx + cy + dz$.\n\nThe strain vector, $\\varepsilon$, is obtained by applying the linear differential strain operator, $L$, to the displacement field $\\mathbf{u}$:\n$$ \\varepsilon = L \\mathbf{u} $$\nSubstituting the finite element approximation for $\\mathbf{u}$ yields:\n$$ \\varepsilon = L (N \\mathbf{u}_e) = (L N) \\mathbf{u}_e $$\nThe strain-displacement matrix $B$ is thus defined as $B = LN$. The entries of the $B$ matrix consist of spatial derivatives of the shape functions. For example, for node $i$, the corresponding columns of the $B$ matrix, denoted $B_i$, are:\n$$\nB_i =\n\\begin{bmatrix}\n\\frac{\\partial N_i}{\\partial x} & 0 & 0 \\\\\n0 & \\frac{\\partial N_i}{\\partial y} & 0 \\\\\n0 & 0 & \\frac{\\partial N_i}{\\partial z} \\\\\n\\frac{\\partial N_i}{\\partial y} & \\frac{\\partial N_i}{\\partial x} & 0 \\\\\n0 & \\frac{\\partial N_i}{\\partial z} & \\frac{\\partial N_i}{\\partial y} \\\\\n\\frac{\\partial N_i}{\\partial z} & 0 & \\frac{\\partial N_i}{\\partial x}\n\\end{bmatrix}\n$$\nSince the shape functions $N_i$ for a T4 element are linear functions of the coordinates $(x,y,z)$, their partial derivatives (e.g., $\\frac{\\partial N_i}{\\partial x}$, $\\frac{\\partial N_i}{\\partial y}$, etc.) are **constants**. Consequently, every entry in the strain-displacement matrix $B$ is a constant. The entire matrix $B$ is therefore constant for a T4 element.\n\nThe integrand of the stiffness matrix is the product $B^{\\top} C B$. Given that $B$ is a constant matrix and the problem specifies that the constitutive matrix $C$ is also constant, the product $B^{\\top} C B$ is a **constant matrix** over the entire element domain.\n\nThe stiffness integral is thus the integral of a constant matrix over the element volume $V_e$:\n$$ K^e = \\int_{V_e} (\\text{constant matrix}) \\, dV = (B^{\\top} C B) \\int_{V_e} dV = (B^{\\top} C B) V_e $$\nTo evaluate this integral numerically, we seek a quadrature rule that is exact. A quadrature rule is said to have a degree-of-exactness $p$ if it can integrate any polynomial of degree up to $p$ exactly. Our integrand, being constant, is a polynomial of degree $0$. Therefore, a quadrature rule with a minimum degree-of-exactness of $p=0$ is sufficient for exact integration.\n\nA one-point quadrature rule evaluates the integral as:\n$$ \\int_{V_e} f(x,y,z) \\, dV \\approx w_1 f(x_1, y_1, z_1) $$\nwhere $(x_1, y_1, z_1)$ is the integration point and $w_1$ is the weight. For our constant integrand $f(x,y,z) = B^{\\top} C B$, this gives:\n$$ K^e_{quad} = w_1 (B^{\\top} C B) $$\nFor the quadrature to be exact, we must have $K^e_{quad} = K^e$. Comparing this with the exact result $K^e = (B^{\\top} C B) V_e$, it is clear that the rule is exact if the weight is chosen as $w_1 = V_e$, the volume of the element.\nSince the integrand is constant, the location of the single integration point is irrelevant; any point within the element, including the centroid, will yield the same result. The combination of a single point evaluation with a weight equal to the element volume exactly integrates a constant function.\n\nIt is also worth noting that in an isoparametric formulation, the integral is transformed to a reference element. The mapping from reference to physical coordinates for a T4 element is affine, meaning its Jacobian matrix $J$ and its determinant $\\det(J)$ are constant. The integrand in the reference space, $B(\\xi, \\eta, \\zeta)^{\\top} C B(\\xi, \\eta, \\zeta) \\det(J)$, is also constant. A one-point rule on the reference element with weight equal to the reference element's volume will also be exact.\n\n**2. Evaluation of Options**\n\n**A. Degree-of-exactness $0$ is sufficient. A one-point rule at the centroid with weight $w_1 = V_e$ is exact because the strain-displacement matrix $B$ is constant for an affine T4 map and the constitutive tensor $C$ is constant, so $B^{\\top} C B$ and the Jacobian determinant are constant, making the integrand constant over the element.**\nThis statement is fully consistent with the derivation above.\n-   The required degree-of-exactness is correctly identified as $0$, since the integrand is a polynomial of degree $0$ (a constant).\n-   The efficacy of a one-point rule with weight $V_e$ is correctly stated.\n-   The justification is sound: $B$ is constant because the shape functions are linear; $C$ is constant by problem definition; the affine map leads to a constant Jacobian determinant. All these factors result in a constant integrand.\n**Verdict: Correct**\n\n**B. Degree-of-exactness $1$ is required. Although the T4 shape functions are linear, their gradients vary linearly, so the product $B^{\\top} C B$ is linear and demands at least a one-point centroid rule to be exact.**\nThis statement contains a fundamental error.\n-   The premise that the \"gradients vary linearly\" is false. The gradients of linear shape functions are constant.\n-   Consequently, the conclusion that the product $B^{\\top} C B$ is linear is also false. The product is constant.\n-   While a one-point centroid rule for a tetrahedron is exact for linear polynomials (degree-of-exactness $1$), rendering it sufficient, it is not minimally required. The reasoning provided for why it is needed is incorrect.\n**Verdict: Incorrect**\n\n**C. Degree-of-exactness $2$ is required. The integrand $B^{\\top} C B$ is quadratic in the spatial coordinates because $B$ is linear for T4, hence at least a four-point rule is needed to integrate the stiffness exactly.**\nThis statement incorrectly describes the T4 element, confusing it with a quadratic element (like a T10).\n-   The premise that \"$B$ is linear for T4\" is false. The $B$ matrix for a T4 element is constant. A linear $B$ matrix arises from quadratic shape functions.\n-   Consequently, the integrand $B^{\\top} C B$ is not quadratic; it is constant.\n-   A degree-of-exactness of $2$ and a four-point rule would be required for a T10 element, but they are unnecessary for a T4.\n**Verdict: Incorrect**\n\n**D. A one-point rule is insufficient because reduced integration introduces spurious zero-energy modes in tetrahedra; therefore a higher-order rule with at least degree-of-exactness $1$ must be used to avoid shear locking and hourglassing.**\nThis statement introduces several unrelated and incorrect concepts.\n-   For a T4 element, a one-point rule is not \"reduced integration.\" It provides the **exact** integral. The concept of reduced integration implies intentionally using a lower-order rule than required for exactness, which is not the case here.\n-   Because the integration is exact, it does not introduce any spurious zero-energy modes (hourglass modes). Hourglassing is a problem associated with reduced integration on certain other element types (e.g., 4-node quadrilaterals), but not with the exact integration of a T4 element.\n-   Shear locking is an intrinsic problem of the T4 element formulation due to its overly stiff behavior in bending, which stems from the linear displacement field, not the integration scheme. Using a higher-order rule (which would still give the same exact result) does nothing to alleviate locking.\n**Verdict: Incorrect**", "answer": "$$\\boxed{A}$$", "id": "3605708"}, {"introduction": "Building on the principles of element integration, we now turn to the derivation of element matrices, a core skill in computational mechanics. This exercise focuses on the consistent mass matrix, which is essential for dynamic analyses. You will derive the mass matrix for both the T4 and the more complex 10-node quadratic tetrahedron (T10) by leveraging the powerful Dirichlet integral for barycentric coordinates [@problem_id:3605661]. This practice sharpens your analytical skills and deepens your understanding of how polynomial degrees in the integrand dictate the required order for numerical quadrature.", "problem": "Consider the semi-discrete form obtained from the weak statement of linear momentum conservation for a scalar field in the Finite Element Method (FEM), where the element-level consistent mass matrix is defined by\n$$\nM_{e} \\;=\\; \\int_{\\Omega_{e}} \\rho\\, N^{\\top} N \\, d\\Omega,\n$$\nwith $N$ the column vector of shape functions, $\\rho$ the mass density, and $\\Omega_{e}$ the physical tetrahedral element domain. Assume $\\rho$ is constant over $\\Omega_{e}$ and that the element is straight-sided whenever the isoparametric mapping is linear. Use barycentric coordinates $\\{\\lambda_{i}\\}_{i=1}^{4}$ on the tetrahedron, and the Dirichlet integral identities for monomials in barycentric coordinates, to derive the consistent mass matrix expressions for the four-node linear tetrahedron (T4) and the ten-node quadratic tetrahedron (T10). Treat $N$ as the scalar Lagrange shape-function column for the respective element, and state any geometric-mapping assumptions you invoke.\n\nStarting from fundamental definitions and well-tested formulas, complete the following:\n\n1. Derive the closed-form entries of $M_{e}$ for the T4 element in terms of the element volume $V_{e}$ and $\\rho$, by evaluating $\\int_{\\Omega_{e}} \\lambda_{i}\\lambda_{j}\\, d\\Omega$ using the Dirichlet integral for barycentric monomials.\n\n2. For the T10 element, write down the quadratic Lagrange shape functions at the four vertices and the six edge midpoints in terms of barycentric coordinates, and establish the polynomial degree of the integrand $\\rho\\,N^{\\top}N$ on the reference tetrahedron. Then, under isoparametric quadratic geometry, determine the degree of the Jacobian determinant $\\det J$ and the resulting polynomial degree of the full integrand $\\rho\\,N^{\\top}N\\,\\det J$ on the reference domain.\n\n3. Based on your findings, state the minimal polynomial exactness degrees required of a tetrahedral quadrature rule to integrate the consistent mass-matrix integrand exactly for T4 (with linear geometry) and T10 (with quadratic geometry). Report your final answer as a row matrix $\\big(k_{\\mathrm{T4}} \\;\\; k_{\\mathrm{T10}}\\big)$ containing these two exactness degrees. No rounding is needed, and no units should be included in your final answer.", "solution": "The problem is well-posed, scientifically grounded, and provides all necessary information to derive the requested quantities. It is a standard problem in the field of computational solid mechanics, specifically in the context of the Finite Element Method (FEM). We proceed with the solution.\n\nThe analysis is divided into three parts as requested by the problem statement.\n\n### Part 1: Consistent Mass Matrix for the T4 Element\n\nThe four-node linear tetrahedron (T4) element has nodes at its four vertices. In an isoparametric formulation, the geometry and the unknown field are represented using the same set of shape functions. For a linear element, the shape functions are linear. The most convenient way to express these for a tetrahedron is using barycentric coordinates, $\\{\\lambda_i\\}_{i=1}^{4}$. For a T4 element, the shape function for node $i$, denoted $N_i$, is simply the $i$-th barycentric coordinate, $N_i = \\lambda_i$.\n\nThe element-level consistent mass matrix $M_e$ is given by\n$$\nM_{e} \\;=\\; \\int_{\\Omega_{e}} \\rho\\, N^{\\top} N \\, d\\Omega\n$$\nwhere $\\rho$ is the mass density, assumed constant over the element domain $\\Omega_e$, and $N$ is the column vector of shape functions, $N = \\begin{pmatrix} \\lambda_1 & \\lambda_2 & \\lambda_3 & \\lambda_4 \\end{pmatrix}^{\\top}$. The entries of the $4 \\times 4$ mass matrix, $M_{ij}$, are given by:\n$$\nM_{ij} \\;=\\; \\rho \\int_{\\Omega_{e}} N_i N_j \\, d\\Omega \\;=\\; \\rho \\int_{\\Omega_{e}} \\lambda_i \\lambda_j \\, d\\Omega\n$$\nTo evaluate this integral, we use the Dirichlet integral identity for monomials of barycentric coordinates over a $3$-dimensional tetrahedron domain $\\Omega_e$:\n$$\n\\int_{\\Omega_{e}} \\lambda_1^{a_1} \\lambda_2^{a_2} \\lambda_3^{a_3} \\lambda_4^{a_4} \\, d\\Omega \\;=\\; V_e \\frac{3! \\, a_1! \\, a_2! \\, a_3! \\, a_4!}{(3 + a_1 + a_2 + a_3 + a_4)!}\n$$\nwhere $V_e$ is the volume of the tetrahedron.\n\nWe distinguish between the diagonal ($i=j$) and off-diagonal ($i \\neq j$) entries of the mass matrix.\n\n**Diagonal entries ($i=j$):**\nThe integrand is $\\lambda_i \\lambda_j = \\lambda_i^2$. The exponents in the Dirichlet integral formula are $a_i=2$ and $a_k=0$ for $k \\neq i$.\n$$\n\\int_{\\Omega_{e}} \\lambda_i^2 \\, d\\Omega \\;=\\; V_e \\frac{3! \\, 2! \\, 0! \\, 0! \\, 0!}{(3 + 2)!} \\;=\\; V_e \\frac{6 \\cdot 2}{5!} \\;=\\; V_e \\frac{12}{120} \\;=\\; \\frac{1}{10} V_e\n$$\nThus, the diagonal entries are $M_{ii} = \\rho \\frac{V_e}{10}$.\n\n**Off-diagonal entries ($i \\neq j$):**\nThe integrand is $\\lambda_i \\lambda_j$. The exponents are $a_i=1$, $a_j=1$, and $a_k=0$ for $k \\notin \\{i, j\\}$.\n$$\n\\int_{\\Omega_{e}} \\lambda_i \\lambda_j \\, d\\Omega \\;=\\; V_e \\frac{3! \\, 1! \\, 1! \\, 0! \\, 0!}{(3 + 1 + 1)!} \\;=\\; V_e \\frac{6 \\cdot 1 \\cdot 1}{5!} \\;=\\; V_e \\frac{6}{120} \\;=\\; \\frac{1}{20} V_e\n$$\nThus, the off-diagonal entries are $M_{ij} = \\rho \\frac{V_e}{20}$ for $i \\neq j$.\n\nThe complete consistent mass matrix for the T4 element is:\n$$\nM_e \\;=\\; \\frac{\\rho V_e}{20}\n\\begin{pmatrix}\n2 & 1 & 1 & 1 \\\\\n1 & 2 & 1 & 1 \\\\\n1 & 1 & 2 & 1 \\\\\n1 & 1 & 1 & 2\n\\end{pmatrix}\n$$\n\n### Part 2: Polynomial Degrees for the T10 Element\n\nThe ten-node quadratic tetrahedron (T10) element has four nodes at the vertices and six nodes at the midpoints of the edges. The shape functions are quadratic polynomials in the barycentric coordinates. Let the vertices be nodes $1, 2, 3, 4$ and the edge midpoints be nodes $5, ..., 10$. The shape functions $N_i$ are:\n- For a vertex node $i \\in \\{1,2,3,4\\}$: $N_i = \\lambda_i (2\\lambda_i - 1)$.\n- For a midpoint node $k$ on the edge connecting vertices $i$ and $j$: $N_k = 4\\lambda_i \\lambda_j$.\n\nThe integrand for the mass matrix on the physical domain is $\\rho N^{\\top}N$. The entries are of the form $\\rho N_i N_j$. Since $\\rho$ is constant, we consider the polynomial degree of the product $N_i N_j$. The shape functions $N_i$ are quadratic polynomials in the barycentric coordinates $\\lambda_k$ (degree $2$). Therefore, the product $N_i N_j$ is a polynomial of degree $2+2=4$ in the barycentric coordinates.\n\nThe problem asks for the polynomial degree of the full integrand on the reference domain under an isoparametric quadratic geometry mapping. The integral transformation from the physical domain $\\Omega_e$ to a reference domain $\\hat{\\Omega}$ is:\n$$\n\\int_{\\Omega_e} f(x) \\,d\\Omega = \\int_{\\hat{\\Omega}} f(x(\\xi)) \\det(J) \\,d\\hat{\\Omega}\n$$\nwhere $\\xi$ are the coordinates on the reference element and $J$ is the Jacobian matrix of the geometric mapping $x(\\xi)$.\n\nFor a T10 element with a quadratic isoparametric mapping, the physical coordinates $x$ are interpolated using the quadratic shape functions:\n$$\nx(\\xi) = \\sum_{k=1}^{10} N_k(\\xi) x_k\n$$\nwhere $x_k$ are the nodal coordinates. The shape functions $N_k(\\xi)$ are quadratic polynomials of the reference coordinates $\\xi = (\\xi_1, \\xi_2, \\xi_3)$.\n\nThe Jacobian matrix entries are $J_{ab} = \\frac{\\partial x_a}{\\partial \\xi_b}$.\n$$\nJ_{ab} = \\frac{\\partial}{\\partial \\xi_b} \\left( \\sum_{k=1}^{10} N_k(\\xi) (x_k)_a \\right) = \\sum_{k=1}^{10} \\frac{\\partial N_k(\\xi)}{\\partial \\xi_b} (x_k)_a\n$$\nSince each $N_k(\\xi)$ is a quadratic polynomial of $\\xi$, its partial derivatives $\\frac{\\partial N_k(\\xi)}{\\partial \\xi_b}$ are linear polynomials of $\\xi$. Consequently, each entry $J_{ab}$ of the Jacobian matrix is a linear polynomial of the reference coordinates $\\xi$.\n\nThe determinant of the $3 \\times 3$ Jacobian matrix, $\\det(J)$, is computed from its linear polynomial entries. The determinant is a sum of products of three entries, so its polynomial degree will be, in general, $1+1+1=3$. For a general curved T10 element, this cubic term does not vanish. Thus, the degree of $\\det(J)$ is $3$.\n\nThe full integrand on the reference domain is $\\rho N_i(\\xi) N_j(\\xi) \\det(J(\\xi))$.\n- The polynomial degree of $N_i(\\xi) N_j(\\xi)$ is $4$.\n- The polynomial degree of $\\det(J(\\xi))$ is $3$.\n\nThe polynomial degree of the full integrand is the sum of these degrees: $4 + 3 = 7$.\n\n### Part 3: Minimal Quadrature Exactness Degrees\n\nA numerical quadrature rule has a polynomial exactness degree of $k$ if it can integrate any polynomial of degree up to and including $k$ exactly. To compute the consistent mass matrix without error, the quadrature rule must be exact for the highest polynomial degree encountered in the integrand.\n\n**For T4 element with linear geometry:**\nThe problem specifies a straight-sided element, which corresponds to a linear isoparametric mapping. The coordinate transformation is $x(\\xi) = \\sum_{i=1}^{4} N_i(\\xi) x_i$, where $N_i$ are linear shape functions. The Jacobian matrix $J$ is constant, so its determinant $\\det(J)$ is also a constant (a polynomial of degree $0$). The integrand on the reference domain is $N_i(\\xi) N_j(\\xi) \\det(J)$.\n- The shape functions $N_i$ are linear (degree $1$).\n- The product $N_i N_j$ is quadratic (degree $2$).\n- The determinant $\\det(J)$ is constant (degree $0$).\nThe total degree of the integrand is $2+0=2$.\nTherefore, the minimal polynomial exactness degree required for the T4 element is $k_{\\mathrm{T4}} = 2$.\n\n**For T10 element with quadratic geometry:**\nAs derived in Part 2, the integrand on the reference domain is $N_i(\\xi) N_j(\\xi) \\det(J(\\xi))$.\n- The product of shape functions $N_i N_j$ is a polynomial of degree $4$.\n- The Jacobian determinant $\\det(J)$ is a polynomial of degree $3$.\nThe total degree of the integrand is $4+3=7$.\nTherefore, the minimal polynomial exactness degree required for the T10 element is $k_{\\mathrm{T10}} = 7$.\n\nThe final answer is a row matrix containing these two degrees.", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n2 & 7\n\\end{pmatrix}\n}\n$$", "id": "3605661"}, {"introduction": "The final and most crucial step in mastering element formulations is translating theory into functional code. This practice guides you through the implementation of one of the most fundamental procedures in a finite element program: the calculation of shape function gradients in physical space for the T10 element. You will implement the complete isoparametric mapping workflow, including the evaluation of the Jacobian matrix and application of the chain rule at quadrature points [@problem_id:3605665]. By verifying your code against an analytical solution, you will not only solidify your understanding of the theory but also engage in the vital practice of verification and validation in scientific computing.", "problem": "Design and implement a complete program that, for a ten-node quadratic tetrahedral element (commonly denoted T10), computes the physical-space gradients of the shape functions at specified quadrature points using an isoparametric formulation. The computation must follow a first-principles path starting from the isoparametric mapping and the chain rule. The program must also verify the gradient accuracy against analytical values derived from barycentric-coordinate calculus for the special case of affine geometry.\n\nYou must proceed from the following fundamental base:\n- The isoparametric mapping for an element maps reference coordinates to physical coordinates via the element shape functions. If $\\{\\boldsymbol{X}_a\\}_{a=1}^{10}$ are the physical node positions and $\\{N_a\\}_{a=1}^{10}$ are the shape functions, the mapping is given by\n$$\n\\boldsymbol{x}(\\boldsymbol{\\xi}) \\;=\\; \\sum_{a=1}^{10} N_a(\\boldsymbol{\\xi})\\,\\boldsymbol{X}_a,\n$$\nwhere $\\boldsymbol{\\xi} = (r,s,t)$ are the reference coordinates on the unit tetrahedron with $r \\ge 0$, $s \\ge 0$, $t \\ge 0$, and $r+s+t \\le 1$.\n- The Jacobian matrix is defined by\n$$\n\\boldsymbol{J}(\\boldsymbol{\\xi}) \\;=\\; \\frac{\\partial \\boldsymbol{x}}{\\partial \\boldsymbol{\\xi}} \\;=\\; \\sum_{a=1}^{10} \\boldsymbol{X}_a \\otimes \\nabla_{\\boldsymbol{\\xi}} N_a(\\boldsymbol{\\xi}),\n$$\nand the chain rule gives the physical-space gradient of the shape functions as\n$$\n\\nabla_{\\boldsymbol{x}} N_a(\\boldsymbol{\\xi}) \\;=\\; \\boldsymbol{J}(\\boldsymbol{\\xi})^{-\\mathsf{T}} \\, \\nabla_{\\boldsymbol{\\xi}} N_a(\\boldsymbol{\\xi}).\n$$\n- For T10 on the reference tetrahedron, the shape functions can be expressed using barycentric coordinates $\\{L_i\\}_{i=1}^4$ defined by $L_1=r$, $L_2=s$, $L_3=t$, $L_4 = 1 - r - s - t$, with $L_1+L_2+L_3+L_4=1$. The ten quadratic shape functions are\n$$\n\\begin{aligned}\n&N_1 = L_1\\,(2L_1-1),\\;\\; N_2 = L_2\\,(2L_2-1),\\;\\; N_3 = L_3\\,(2L_3-1),\\;\\; N_4 = L_4\\,(2L_4-1),\\\\\n&N_5 = 4\\,L_1 L_2,\\;\\; N_6 = 4\\,L_2 L_3,\\;\\; N_7 = 4\\,L_1 L_3,\\;\\; N_8 = 4\\,L_1 L_4,\\;\\; N_9 = 4\\,L_2 L_4,\\;\\; N_{10} = 4\\,L_3 L_4.\n\\end{aligned}\n$$\n- The derivatives $\\nabla_{\\boldsymbol{\\xi}} N_a$ follow from the product rule and the linear relationships $\\partial L_1/\\partial r = 1$, $\\partial L_2/\\partial s = 1$, $\\partial L_3/\\partial t = 1$, $\\partial L_4/\\partial r = \\partial L_4/\\partial s = \\partial L_4/\\partial t = -1$, with all other partial derivatives of the $L_i$ equal to $0$.\n\nAnalytical verification base for affine geometry:\n- If the geometry is affine, meaning the mid-edge node positions are at the midpoints of the straight edges between the four vertex nodes, the physical mapping reduces to an affine map. In this case, the physical barycentric coordinates are linear in $\\boldsymbol{x}$ and satisfy\n$$\n\\boldsymbol{x} \\;=\\; \\sum_{i=1}^{4} L_i(\\boldsymbol{x})\\,\\boldsymbol{X}_i,\\;\\;\\; \\sum_{i=1}^{4} L_i(\\boldsymbol{x}) = 1,\n$$\nand the gradients $\\{\\nabla_{\\boldsymbol{x}} L_i\\}_{i=1}^{4}$ are constant vectors determined by the vertex positions. Define the $3\\times 3$ matrix\n$$\n\\boldsymbol{B} \\;=\\; \\begin{bmatrix} \\boldsymbol{X}_1 - \\boldsymbol{X}_4 & \\boldsymbol{X}_2 - \\boldsymbol{X}_4 & \\boldsymbol{X}_3 - \\boldsymbol{X}_4 \\end{bmatrix},\n$$\nthen\n$$\n\\nabla_{\\boldsymbol{x}} L_1 \\;=\\; \\boldsymbol{B}^{-\\mathsf{T}} \\boldsymbol{e}_1,\\;\\;\n\\nabla_{\\boldsymbol{x}} L_2 \\;=\\; \\boldsymbol{B}^{-\\mathsf{T}} \\boldsymbol{e}_2,\\;\\;\n\\nabla_{\\boldsymbol{x}} L_3 \\;=\\; \\boldsymbol{B}^{-\\mathsf{T}} \\boldsymbol{e}_3,\\;\\;\n\\nabla_{\\boldsymbol{x}} L_4 \\;=\\; -\\sum_{i=1}^{3} \\nabla_{\\boldsymbol{x}} L_i,\n$$\nwhere $\\{\\boldsymbol{e}_i\\}$ are the Cartesian basis vectors. For any point with barycentric coordinates $\\{L_i\\}$, the analytical gradients of the T10 shape functions are then\n$$\n\\begin{aligned}\n&\\nabla_{\\boldsymbol{x}} N_1 = (4L_1-1)\\,\\nabla_{\\boldsymbol{x}} L_1,\\;\\;\n\\nabla_{\\boldsymbol{x}} N_2 = (4L_2-1)\\,\\nabla_{\\boldsymbol{x}} L_2,\\;\\;\n\\nabla_{\\boldsymbol{x}} N_3 = (4L_3-1)\\,\\nabla_{\\boldsymbol{x}} L_3,\\;\\;\n\\nabla_{\\boldsymbol{x}} N_4 = (4L_4-1)\\,\\nabla_{\\boldsymbol{x}} L_4,\\\\\n&\\nabla_{\\boldsymbol{x}} N_5 = 4\\,(L_1\\,\\nabla_{\\boldsymbol{x}} L_2 + L_2\\,\\nabla_{\\boldsymbol{x}} L_1),\\;\\;\n\\nabla_{\\boldsymbol{x}} N_6 = 4\\,(L_2\\,\\nabla_{\\boldsymbol{x}} L_3 + L_3\\,\\nabla_{\\boldsymbol{x}} L_2),\\\\\n&\\nabla_{\\boldsymbol{x}} N_7 = 4\\,(L_1\\,\\nabla_{\\boldsymbol{x}} L_3 + L_3\\,\\nabla_{\\boldsymbol{x}} L_1),\\;\\;\n\\nabla_{\\boldsymbol{x}} N_8 = 4\\,(L_1\\,\\nabla_{\\boldsymbol{x}} L_4 + L_4\\,\\nabla_{\\boldsymbol{x}} L_1),\\\\\n&\\nabla_{\\boldsymbol{x}} N_9 = 4\\,(L_2\\,\\nabla_{\\boldsymbol{x}} L_4 + L_4\\,\\nabla_{\\boldsymbol{x}} L_2),\\;\\;\n\\nabla_{\\boldsymbol{x}} N_{10} = 4\\,(L_3\\,\\nabla_{\\boldsymbol{x}} L_4 + L_4\\,\\nabla_{\\boldsymbol{x}} L_3).\n\\end{aligned}\n$$\n\nYour program must:\n- Implement a robust algorithm that, for each quadrature point, evaluates $\\nabla_{\\boldsymbol{\\xi}} N_a$, assembles $\\boldsymbol{J}$, computes $\\boldsymbol{J}^{-\\mathsf{T}}$ via a linear solve, and returns $\\nabla_{\\boldsymbol{x}} N_a$.\n- Use the following symmetric four-point quadrature rule on the reference tetrahedron, given in barycentric coordinates. Let $a = 0.1381966011250105$, and define four quadrature points with barycentric coordinates\n$$\n(L_1,L_2,L_3,L_4) \\in \\{(a,a,a,1-3a),\\;(1-3a,a,a,a),\\;(a,1-3a,a,a),\\;(a,a,1-3a,a)\\},\n$$\neach with equal weight (weights are not needed for this task but the points must be used). Convert these barycentric coordinates to reference coordinates via $(r,s,t) = (L_1,L_2,L_3)$.\n\nTest suite:\n- For each of the following three affine T10 elements, construct the $10$ node positions by placing the $4$ vertex nodes at the given coordinates and each of the $6$ mid-edge nodes at the midpoint of its corresponding straight edge. For each element, evaluate the gradients at the four quadrature points and compute the maximum Euclidean norm of the difference between the algorithmic gradients and the analytical gradients over all shape functions and quadrature points. Report that single maximum error per element.\n    1. Happy path element with right-angled unit tetrahedron:\n       - Vertex nodes: $\\boldsymbol{X}_1=(0,0,0)$, $\\boldsymbol{X}_2=(1,0,0)$, $\\boldsymbol{X}_3=(0,1,0)$, $\\boldsymbol{X}_4=(0,0,1)$.\n    2. Skewed, well-shaped element:\n       - Vertex nodes: $\\boldsymbol{X}_1=(0,0,0)$, $\\boldsymbol{X}_2=(3,0.1,0)$, $\\boldsymbol{X}_3=(0.2,2.5,0.1)$, $\\boldsymbol{X}_4=(0.1,0.2,2.0)$.\n    3. Nearly singular element (edge case):\n       - Vertex nodes: $\\boldsymbol{X}_1=(0,0,0)$, $\\boldsymbol{X}_2=(10^{-4},0,0)$, $\\boldsymbol{X}_3=(0,10^{-4},0)$, $\\boldsymbol{X}_4=(0,0,1)$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, for example, $[e_1,e_2,e_3]$, where $e_i$ is the maximum error for element $i$ as a floating-point number. No additional text should be printed.", "solution": "The problem requires the design and implementation of a program to compute the physical-space gradients of shape functions for a 10-node quadratic tetrahedral element (T10). The computation must be based on the isoparametric formulation and the chain rule. Furthermore, the results must be verified for the special case of an affine element geometry against an analytical solution derived from barycentric coordinate calculus.\n\nThe solution comprises four main stages: 1) derivation of the shape function gradients in the reference coordinate system, 2) formulation of the isoparametric mapping and the Jacobian matrix to transform these gradients into the physical coordinate system, 3) formulation of the analytical solution for affine geometries, and 4) an algorithmic procedure to compute and compare the results for the specified test cases.\n\nLet the reference coordinates on the unit tetrahedron be $\\boldsymbol{\\xi} = (r, s, t)^{\\mathsf{T}}$, where $r \\ge 0$, $s \\ge 0$, $t \\ge 0$, and $r+s+t \\le 1$. The physical coordinates are denoted by $\\boldsymbol{x}=(x,y,z)^{\\mathsf{T}}$.\n\nFirst, we define the barycentric coordinates, which are fundamental for defining the shape functions. For any point $\\boldsymbol{\\xi}$ in the reference tetrahedron, the barycentric coordinates $\\{L_i\\}_{i=1}^4$ are given by:\n$$\nL_1(\\boldsymbol{\\xi}) = r, \\quad L_2(\\boldsymbol{\\xi}) = s, \\quad L_3(\\boldsymbol{\\xi}) = t, \\quad L_4(\\boldsymbol{\\xi}) = 1 - r - s - t\n$$\nThese coordinates satisfy the property $\\sum_{i=1}^4 L_i = 1$. The ten shape functions for the T10 element are expressed elegantly using these barycentric coordinates. The nodes $1$ through $4$ are the vertices of the tetrahedron, and nodes $5$ through $10$ are the midpoints of the six edges. The shape functions are:\n$$\n\\begin{aligned}\nN_1 &= L_1(2L_1-1) & \\text{(Vertex 1)} \\\\\nN_2 &= L_2(2L_2-1) & \\text{(Vertex 2)} \\\\\nN_3 &= L_3(2L_3-1) & \\text{(Vertex 3)} \\\\\nN_4 &= L_4(2L_4-1) & \\text{(Vertex 4)} \\\\\nN_5 &= 4L_1 L_2 & \\text{(Midpoint of edge 1-2)} \\\\\nN_6 &= 4L_2 L_3 & \\text{(Midpoint of edge 2-3)} \\\\\nN_7 &= 4L_1 L_3 & \\text{(Midpoint of edge 1-3)} \\\\\nN_8 &= 4L_1 L_4 & \\text{(Midpoint of edge 1-4)} \\\\\nN_9 &= 4L_2 L_4 & \\text{(Midpoint of edge 2-4)} \\\\\nN_{10} &= 4L_3 L_4 & \\text{(Midpoint of edge 3-4)}\n\\end{aligned}\n$$\n\nTo compute the physical-space gradients $\\nabla_{\\boldsymbol{x}} N_a$, we first require the reference-space gradients $\\nabla_{\\boldsymbol{\\xi}} N_a$. These are found by applying the chain rule to the shape function definitions. The gradient of any shape function $N_a$ with respect to a reference coordinate, say $r$, is $\\frac{\\partial N_a}{\\partial r} = \\sum_{i=1}^4 \\frac{\\partial N_a}{\\partial L_i} \\frac{\\partial L_i}{\\partial r}$. The derivatives of the barycentric coordinates with respect to the reference coordinates are constants:\n$$\n\\nabla_{\\boldsymbol{\\xi}} L_1 = (1, 0, 0)^{\\mathsf{T}}, \\quad \\nabla_{\\boldsymbol{\\xi}} L_2 = (0, 1, 0)^{\\mathsf{T}}, \\quad \\nabla_{\\boldsymbol{\\xi}} L_3 = (0, 0, 1)^{\\mathsf{T}}, \\quad \\nabla_{\\boldsymbol{\\xi}} L_4 = (-1, -1, -1)^{\\mathsf{T}}\n$$\nThis leads to the following expressions for the components of $\\nabla_{\\boldsymbol{\\xi}} N_a$:\n$$\n\\frac{\\partial N_a}{\\partial r} = \\frac{\\partial N_a}{\\partial L_1} - \\frac{\\partial N_a}{\\partial L_4}, \\quad\n\\frac{\\partial N_a}{\\partial s} = \\frac{\\partial N_a}{\\partial L_2} - \\frac{\\partial N_a}{\\partial L_4}, \\quad\n\\frac{\\partial N_a}{\\partial t} = \\frac{\\partial N_a}{\\partial L_3} - \\frac{\\partial N_a}{\\partial L_4}\n$$\nThe derivatives $\\frac{\\partial N_a}{\\partial L_i}$ are found by differentiating the polynomial expressions for $N_a$. For example, for $N_1 = 2L_1^2 - L_1$, $\\frac{\\partial N_1}{\\partial L_1} = 4L_1-1$, and for $N_5=4L_1L_2$, $\\frac{\\partial N_5}{\\partial L_1} = 4L_2$ and $\\frac{\\partial N_5}{\\partial L_2} = 4L_1$. All other derivatives are zero. These are evaluated at a specific point defined by its barycentric coordinates.\n\nThe isoparametric formulation maps the reference element to the physical element using the same shape functions:\n$$\n\\boldsymbol{x}(\\boldsymbol{\\xi}) \\;=\\; \\sum_{a=1}^{10} N_a(\\boldsymbol{\\xi})\\,\\boldsymbol{X}_a\n$$\nwhere $\\boldsymbol{X}_a$ are the physical coordinates of the element's ten nodes. The gradient of this mapping defines the Jacobian matrix $\\boldsymbol{J}$:\n$$\n\\boldsymbol{J}(\\boldsymbol{\\xi}) = \\frac{\\partial \\boldsymbol{x}}{\\partial \\boldsymbol{\\xi}} = \\sum_{a=1}^{10} \\boldsymbol{X}_a \\otimes \\nabla_{\\boldsymbol{\\xi}} N_a(\\boldsymbol{\\xi})\n$$\nIn component form, $J_{ij} = \\frac{\\partial x_i}{\\partial \\xi_j} = \\sum_{a=1}^{10} X_{ai} \\frac{\\partial N_a}{\\partial \\xi_j}$. Here, $i \\in \\{1,2,3\\}$ refers to the physical dimensions $(x,y,z)$ and $j \\in \\{1,2,3\\}$ refers to the reference dimensions $(r,s,t)$.\n\nThe chain rule connects the physical and reference gradients: $\\nabla_{\\boldsymbol{\\xi}} N_a = \\boldsymbol{J}^{\\mathsf{T}} \\nabla_{\\boldsymbol{x}} N_a$. To find the desired physical gradients, we rearrange this relation:\n$$\n\\nabla_{\\boldsymbol{x}} N_a(\\boldsymbol{\\xi}) \\;=\\; \\boldsymbol{J}(\\boldsymbol{\\xi})^{-\\mathsf{T}} \\, \\nabla_{\\boldsymbol{\\xi}} N_a(\\boldsymbol{\\xi})\n$$\nComputationally, it is more stable and efficient to solve the linear system $\\boldsymbol{J}^{\\mathsf{T}} (\\nabla_{\\boldsymbol{x}} N_a) = \\nabla_{\\boldsymbol{\\xi}} N_a$ for each shape function $a$ rather than explicitly computing the inverse of $\\boldsymbol{J}^{\\mathsf{T}}$.\n\nFor verification, we use an analytical solution valid for affine elements, where all mid-edge nodes $\\boldsymbol{X}_{5-10}$ are located exactly at the geometric midpoint of the edges connecting the corresponding vertex nodes $\\boldsymbol{X}_{1-4}$. In this case, the mapping from physical to barycentric coordinates is affine. The gradients of the barycentric coordinates with respect to physical coordinates, $\\nabla_{\\boldsymbol{x}} L_i$, are constant vectors. They can be computed by first defining the matrix $\\boldsymbol{B}$ whose columns are formed by the vectors from vertex $4$ to vertices $1$, $2$, and $3$:\n$$\n\\boldsymbol{B} \\;=\\; \\begin{bmatrix} \\boldsymbol{X}_1 - \\boldsymbol{X}_4 & \\boldsymbol{X}_2 - \\boldsymbol{X}_4 & \\boldsymbol{X}_3 - \\boldsymbol{X}_4 \\end{bmatrix}\n$$\nThe gradients are then given by:\n$$\n\\nabla_{\\boldsymbol{x}} L_1 = \\boldsymbol{B}^{-\\mathsf{T}} \\boldsymbol{e}_1, \\;\\;\n\\nabla_{\\boldsymbol{x}} L_2 = \\boldsymbol{B}^{-\\mathsf{T}} \\boldsymbol{e}_2, \\;\\;\n\\nabla_{\\boldsymbol{x}} L_3 = \\boldsymbol{B}^{-\\mathsf{T}} \\boldsymbol{e}_3, \\;\\;\n\\nabla_{\\boldsymbol{x}} L_4 = -\\sum_{i=1}^{3} \\nabla_{\\boldsymbol{x}} L_i\n$$\nwhere $\\{\\boldsymbol{e}_i\\}$ are the standard Cartesian basis vectors. With these constant gradients, the analytical physical gradient of any shape function $N_a$ is found by applying the product rule to its definition in terms of $L_i$. For example, for $N_1=L_1(2L_1-1)$, the gradient is $\\nabla_{\\boldsymbol{x}} N_1 = (4L_1-1)\\nabla_{\\boldsymbol{x}} L_1$. For $N_5=4L_1L_2$, it is $\\nabla_{\\boldsymbol{x}} N_5 = 4(L_1 \\nabla_{\\boldsymbol{x}} L_2 + L_2 \\nabla_{\\boldsymbol{x}} L_1)$.\n\nThe overall algorithm for a given element is as follows:\n1. Define the $4$ vertex node coordinates $\\boldsymbol{X}_{1..4}$. Construct the $6$ mid-edge node coordinates $\\boldsymbol{X}_{5..10}$ (e.g., $\\boldsymbol{X}_5 = 0.5(\\boldsymbol{X}_1 + \\boldsymbol{X}_2)$). This forms the matrix of all $10$ node coordinates.\n2. For each of the four specified quadrature points, given in barycentric coordinates $(L_1, L_2, L_3, L_4)$:\n    a. Convert to reference coordinates $(r, s, t) = (L_1, L_2, L_3)$.\n    b. **Algorithmic Gradient Calculation**:\n        i. Evaluate the $10 \\times 3$ matrix of reference gradients, $\\boldsymbol{D}$, where $D_{aj} = (\\nabla_{\\boldsymbol{\\xi}} N_a)_j$.\n        ii. Assemble the $3 \\times 3$ Jacobian matrix $\\boldsymbol{J}$.\n        iii. For all $10$ shape functions simultaneously, solve the linear system $\\boldsymbol{J}^{\\mathsf{T}} \\boldsymbol{G}^{\\mathsf{T}} = \\boldsymbol{D}^{\\mathsf{T}}$ to find the $10 \\times 3$ matrix of physical gradients, $\\boldsymbol{G}$, where $G_{aj} = (\\nabla_{\\boldsymbol{x}} N_a)_j$.\n    c. **Analytical Gradient Calculation**:\n        i. Compute the constant physical gradients of the barycentric coordinates, $\\nabla_{\\boldsymbol{x}} L_i$.\n        ii. Use these and the barycentric coordinates of the quadrature point to compute the analytical physical gradients for all $10$ shape functions.\n    d. Compute the Euclidean norm of the vector difference between the algorithmic and analytical gradient for each shape function.\n3. The final error for the element is the maximum of these norms across all $10$ shape functions and all $4$ quadrature points.\nThis procedure is repeated for each of the three test elements provided.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import solve, inv\n\ndef solve_problem():\n    \"\"\"\n    Main function to solve the problem for the given test suite.\n    It computes the maximum error between algorithmic and analytical T10 gradients\n    for three different affine tetrahedral elements.\n    \"\"\"\n\n    # Test suite: vertex coordinates for three affine T10 elements.\n    test_cases = [\n        # 1. Happy path element: right-angled unit tetrahedron\n        np.array([\n            [0.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0]\n        ]),\n        # 2. Skewed, well-shaped element\n        np.array([\n            [0.0, 0.0, 0.0], [3.0, 0.1, 0.0], [0.2, 2.5, 0.1], [0.1, 0.2, 2.0]\n        ]),\n        # 3. Nearly singular element (edge case)\n        np.array([\n            [0.0, 0.0, 0.0], [1e-4, 0.0, 0.0], [0.0, 1e-4, 0.0], [0.0, 0.0, 1.0]\n        ]),\n    ]\n\n    # Quadrature points for a symmetric 4-point rule on the tetrahedron.\n    a = 0.1381966011250105\n    b = 1.0 - 3.0 * a\n    # Quadrature points are given in barycentric coordinates (L1, L2, L3, L4).\n    quad_points_bary = np.array([\n        [a, a, a, b],\n        [b, a, a, a],\n        [a, b, a, a],\n        [a, a, b, a],\n    ])\n\n    results = []\n    for vertices in test_cases:\n        # Construct the full 10-node coordinate matrix for the affine element.\n        # Nodes 1-4 are vertices.\n        # Nodes 5-10 are mid-edge nodes in the order: 1-2, 2-3, 1-3, 1-4, 2-4, 3-4.\n        all_nodes = np.zeros((10, 3))\n        all_nodes[0:4, :] = vertices\n        all_nodes[4, :] = 0.5 * (vertices[0] + vertices[1])  # Edge 1-2\n        all_nodes[5, :] = 0.5 * (vertices[1] + vertices[2])  # Edge 2-3\n        all_nodes[6, :] = 0.5 * (vertices[0] + vertices[2])  # Edge 1-3\n        all_nodes[7, :] = 0.5 * (vertices[0] + vertices[3])  # Edge 1-4\n        all_nodes[8, :] = 0.5 * (vertices[1] + vertices[3])  # Edge 2-4\n        all_nodes[9, :] = 0.5 * (vertices[2] + vertices[3])  # Edge 3-4\n        \n        max_error = compute_max_error(all_nodes, quad_points_bary)\n        results.append(max_error)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{err:.15e}' for err in results)}]\")\n\ndef get_ref_grads(bary_coords):\n    \"\"\"\n    Computes the gradients of the 10 T10 shape functions with respect to the\n    reference coordinates (r, s, t) at a point defined by its barycentric\n    coordinates.\n\n    Args:\n        bary_coords (np.ndarray): A (4,) array of barycentric coordinates [L1, L2, L3, L4].\n\n    Returns:\n        np.ndarray: A (10, 3) matrix of reference gradients, where row 'a' is\n                    the gradient of shape function N_a.\n    \"\"\"\n    L = bary_coords\n    \n    # partial derivatives of shape functions w.r.t. barycentric coordinates (dNa/dLi)\n    dNa_dLi = np.zeros((10, 4))\n    \n    # Vertex nodes (N1 to N4)\n    dNa_dLi[0, 0] = 4 * L[0] - 1\n    dNa_dLi[1, 1] = 4 * L[1] - 1\n    dNa_dLi[2, 2] = 4 * L[2] - 1\n    dNa_dLi[3, 3] = 4 * L[3] - 1\n    \n    # Mid-edge nodes (N5 to N10)\n    dNa_dLi[4, 0], dNa_dLi[4, 1] = 4 * L[1], 4 * L[0]  # N5 = 4*L1*L2\n    dNa_dLi[5, 1], dNa_dLi[5, 2] = 4 * L[2], 4 * L[1]  # N6 = 4*L2*L3\n    dNa_dLi[6, 0], dNa_dLi[6, 2] = 4 * L[2], 4 * L[0]  # N7 = 4*L1*L3\n    dNa_dLi[7, 0], dNa_dLi[7, 3] = 4 * L[3], 4 * L[0]  # N8 = 4*L1*L4\n    dNa_dLi[8, 1], dNa_dLi[8, 3] = 4 * L[3], 4 * L[1]  # N9 = 4*L2*L4\n    dNa_dLi[9, 2], dNa_dLi[9, 3] = 4 * L[3], 4 * L[2]  # N10 = 4*L3*L4\n    \n    # Chain rule: dNa/dr = dNa/dL1 - dNa/dL4, etc.\n    dNa_dxi = np.zeros((10, 3))\n    dNa_dxi[:, 0] = dNa_dLi[:, 0] - dNa_dLi[:, 3]  # d/dr\n    dNa_dxi[:, 1] = dNa_dLi[:, 1] - dNa_dLi[:, 3]  # d/ds\n    dNa_dxi[:, 2] = dNa_dLi[:, 2] - dNa_dLi[:, 3]  # d/dt\n    \n    return dNa_dxi\n\ndef compute_gradients_isoparametric(nodes, bary_coords):\n    \"\"\"\n    Computes physical gradients using the standard isoparametric formulation.\n    \"\"\"\n    ref_grads = get_ref_grads(bary_coords)\n    # Jacobian J_ij = sum_a X_ai * dNa/dxi_j\n    # In matrix form: J = ref_grads.T @ nodes\n    J = ref_grads.T @ nodes\n    \n    # Physical grads G_aj = sum_k (dNa/dxi_k) * inv(J)_kj\n    # Solved more robustly as J.T @ G.T = (dNa/dxi).T\n    phys_grads = solve(J.T, ref_grads.T).T\n    return phys_grads\n\ndef compute_gradients_analytical(nodes, bary_coords):\n    \"\"\"\n    Computes physical gradients using the analytical formulas for affine elements.\n    \"\"\"\n    vertices = nodes[0:4]\n    L = bary_coords\n\n    # Matrix B for computing barycentric coordinate gradients\n    B = np.zeros((3, 3))\n    B[:, 0] = vertices[0] - vertices[3]\n    B[:, 1] = vertices[1] - vertices[3]\n    B[:, 2] = vertices[2] - vertices[3]\n    \n    B_inv_T = inv(B).T\n    \n    # Gradients of barycentric coordinates w.r.t. physical coords (dLi/dx)\n    dL_dx = np.zeros((4, 3))\n    dL_dx[0, :] = B_inv_T[:, 0]\n    dL_dx[1, :] = B_inv_T[:, 1]\n    dL_dx[2, :] = B_inv_T[:, 2]\n    dL_dx[3, :] = -np.sum(dL_dx[0:3, :], axis=0)\n    \n    # Analytical physical gradients of shape functions\n    grad_N_an = np.zeros((10, 3))\n    grad_N_an[0, :] = (4 * L[0] - 1) * dL_dx[0]\n    grad_N_an[1, :] = (4 * L[1] - 1) * dL_dx[1]\n    grad_N_an[2, :] = (4 * L[2] - 1) * dL_dx[2]\n    grad_N_an[3, :] = (4 * L[3] - 1) * dL_dx[3]\n    \n    grad_N_an[4, :] = 4 * (L[1] * dL_dx[0] + L[0] * dL_dx[1])\n    grad_N_an[5, :] = 4 * (L[2] * dL_dx[1] + L[1] * dL_dx[2])\n    grad_N_an[6, :] = 4 * (L[2] * dL_dx[0] + L[0] * dL_dx[2])\n    grad_N_an[7, :] = 4 * (L[3] * dL_dx[0] + L[0] * dL_dx[3])\n    grad_N_an[8, :] = 4 * (L[3] * dL_dx[1] + L[1] * dL_dx[3])\n    grad_N_an[9, :] = 4 * (L[3] * dL_dx[2] + L[2] * dL_dx[3])\n\n    return grad_N_an\n\ndef compute_max_error(nodes, quad_points_bary):\n    \"\"\"\n    Computes the maximum error between algorithmic and analytical gradients\n    over all shape functions and quadrature points for a single element.\n    \"\"\"\n    max_err = 0.0\n    for qp_bary in quad_points_bary:\n        \n        # Algorithmic (isoparametric) computation\n        # Correction in Jacobian calculation: J = X.T @ dN_dxi is incorrect.\n        # J_ij = sum_a X_ai * dN_a/dxi_j. Correct matrix form is J = dN_dxi.T @ X\n        ref_grads = get_ref_grads(qp_bary)\n        J = ref_grads.T @ nodes\n        phys_grads_iso = solve(J.T, ref_grads.T).T\n\n        # Analytical computation for affine case\n        grad_an = compute_gradients_analytical(nodes, qp_bary)\n        \n        # Compute error for this quadrature point\n        diff = phys_grads_iso - grad_an\n        errors_at_qp = np.linalg.norm(diff, axis=1) # Norms for each shape function\n        \n        # Update overall maximum error\n        max_err = max(max_err, np.max(errors_at_qp))\n        \n    return max_err\n\nif __name__ == '__main__':\n    solve_problem()\n```", "id": "3605665"}]}