{"hands_on_practices": [{"introduction": "Understanding hourglass control begins with a hands-on implementation of the core concepts. This first practice challenges you to build the hourglass stabilization mechanism from the ground up for a single 8-node hexahedral element. By defining the hourglass mode vectors and calculating the resulting stabilization energy for various displacement fields, you will gain a fundamental appreciation for how these spurious modes are detected and penalized [@problem_id:3571351]. A key takeaway is verifying that these modes are orthogonal to rigid body motion and constant strain states, ensuring the stabilization does not interfere with physically meaningful deformations.", "problem": "Implement a complete and runnable program that, for a single under-integrated eight-node trilinear hexahedral finite element, constructs the four linear hourglass modes, evaluates a quadratic hourglass strain energy functional for specified nodal displacement patterns, and confirms that this energy vanishes for affine displacement fields. Your derivation and implementation must start from the foundational principles of finite element interpolation on the parent domain and symmetry arguments on the cube corners, without presupposing any shortcut formulas beyond the standard trilinear shape functions.\n\nThe element geometry is defined in the physical space by eight nodes occupying the corners of a rectangular parallelepiped centered at the origin. Let the physical coordinates of node $i$ be $\\mathbf{X}_i \\in \\mathbb{R}^3$ in meters, with edge lengths $L_x$, $L_y$, $L_z$ specified as $L_x = 0.3$, $L_y = 0.2$, $L_z = 0.1$. The nodes are ordered and located as follows:\n- Node $1$: $\\mathbf{X}_1 = \\left(-\\frac{L_x}{2}, -\\frac{L_y}{2}, -\\frac{L_z}{2}\\right)$,\n- Node $2$: $\\mathbf{X}_2 = \\left(\\frac{L_x}{2}, -\\frac{L_y}{2}, -\\frac{L_z}{2}\\right)$,\n- Node $3$: $\\mathbf{X}_3 = \\left(\\frac{L_x}{2}, \\frac{L_y}{2}, -\\frac{L_z}{2}\\right)$,\n- Node $4$: $\\mathbf{X}_4 = \\left(-\\frac{L_x}{2}, \\frac{L_y}{2}, -\\frac{L_z}{2}\\right)$,\n- Node $5$: $\\mathbf{X}_5 = \\left(-\\frac{L_x}{2}, -\\frac{L_y}{2}, \\frac{L_z}{2}\\right)$,\n- Node $6$: $\\mathbf{X}_6 = \\left(\\frac{L_x}{2}, -\\frac{L_y}{2}, \\frac{L_z}{2}\\right)$,\n- Node $7$: $\\mathbf{X}_7 = \\left(\\frac{L_x}{2}, \\frac{L_y}{2}, \\frac{L_z}{2}\\right)$,\n- Node $8$: $\\mathbf{X}_8 = \\left(-\\frac{L_x}{2}, \\frac{L_y}{2}, \\frac{L_z}{2}\\right)$.\n\nIn the parent (reference) domain, the corresponding natural coordinates for node $i$ are $\\left(\\xi_i,\\eta_i,\\zeta_i\\right) \\in \\{-1,1\\}^3$ with the same ordering as above:\n- Node $1$: $\\left(-1,-1,-1\\right)$,\n- Node $2$: $\\left(1,-1,-1\\right)$,\n- Node $3$: $\\left(1,1,-1\\right)$,\n- Node $4$: $\\left(-1,1,-1\\right)$,\n- Node $5$: $\\left(-1,-1,1\\right)$,\n- Node $6$: $\\left(1,-1,1\\right)$,\n- Node $7$: $\\left(1,1,1\\right)$,\n- Node $8$: $\\left(-1,1,1\\right)$.\n\nLet the standard trilinear shape functions be $N_i(\\xi,\\eta,\\zeta) = \\frac{1}{8} \\left(1 + \\xi \\, \\xi_i\\right)\\left(1 + \\eta \\, \\eta_i\\right)\\left(1 + \\zeta \\, \\zeta_i\\right)$. The Jacobian matrix at the element center $(\\xi,\\eta,\\zeta) = (0,0,0)$ is the $3 \\times 3$ matrix $\\mathbf{J} = \\frac{\\partial \\mathbf{X}}{\\partial (\\xi,\\eta,\\zeta)}$ evaluated at the center. Define the element volume as $V = 8 \\, \\det(\\mathbf{J})$ and the characteristic squared length as $L^2 = \\mathrm{tr}\\!\\left(\\mathbf{J}^\\mathsf{T} \\mathbf{J}\\right)$. These quantities must be computed from first principles using the definitions above.\n\nDefine the four scalar hourglass mode vectors $\\gamma^\\alpha \\in \\mathbb{R}^8$ ($\\alpha = 1,2,3,4$) evaluated at the nodes as the bilinear and trilinear monomials of the parent coordinates:\n- $\\gamma^1_i = \\xi_i \\, \\eta_i$,\n- $\\gamma^2_i = \\eta_i \\, \\zeta_i$,\n- $\\gamma^3_i = \\zeta_i \\, \\xi_i$,\n- $\\gamma^4_i = \\xi_i \\, \\eta_i \\, \\zeta_i$.\n\nGiven the nodal displacement vector field $\\mathbf{u}_i \\in \\mathbb{R}^3$ at the nodes (in meters), define the hourglass amplitudes $\\mathbf{a}^\\alpha \\in \\mathbb{R}^3$ by the centroidal mass-lumped projection\n$\\mathbf{a}^\\alpha = \\frac{1}{8} \\sum_{i=1}^{8} \\gamma^\\alpha_i \\, \\mathbf{u}_i$,\nand the hourglass strain energy as\n$W_{\\mathrm{hg}} = \\frac{1}{2} \\, \\beta \\, \\mu \\, \\frac{V}{L^2} \\, \\sum_{\\alpha=1}^{4} \\left\\| \\mathbf{a}^\\alpha \\right\\|^2,$\nwhere $\\mu$ is the shear modulus and $\\beta$ is a dimensionless stabilization parameter. Use $\\mu = 5.0 \\times 10^5$ (Pascals) and $\\beta = 1.0$ (dimensionless). The energy $W_{\\mathrm{hg}}$ must be expressed in Joules.\n\nYou must implement the full pipeline that:\n- Constructs $\\gamma^\\alpha$ from the parent coordinates,\n- Computes $\\mathbf{J}$ at the center, $V$, and $L^2$ from the nodal coordinates,\n- Computes $\\mathbf{a}^\\alpha$ for each test case and then $W_{\\mathrm{hg}}$.\n\nTest suite. You must evaluate $W_{\\mathrm{hg}}$ for the following four nodal displacement patterns, each defined as a function of the physical coordinates $\\mathbf{X}_i$ or as a direct nodal vector. All displacements are in meters:\n\n- Case A (affine field): $\\mathbf{u}_i = \\mathbf{A} \\, \\mathbf{X}_i + \\mathbf{b}$, where\n$\\mathbf{A} = \\begin{bmatrix}\n0.01 & 0.02 & -0.01 \\\\\n0.0 & -0.005 & 0.015 \\\\\n0.02 & 0.01 & 0.005\n\\end{bmatrix}$ and $\\mathbf{b} = \\begin{bmatrix} 0.001 \\\\ -0.0005 \\\\ 0.0002 \\end{bmatrix}$. The hourglass energy should vanish for any affine field.\n\n- Case B (pure hourglass mode): $\\mathbf{u}_i = \\begin{bmatrix} u_0 \\, \\gamma^1_i \\\\ 0 \\\\ 0 \\end{bmatrix}$ with $u_0 = 1.0 \\times 10^{-3}$.\n\n- Case C (affine plus hourglass): $\\mathbf{u}_i = \\mathbf{A} \\, \\mathbf{X}_i + \\mathbf{b} + \\begin{bmatrix} 0 \\\\ v_0 \\, \\gamma^3_i \\\\ 0 \\end{bmatrix}$ with $v_0 = 2.0 \\times 10^{-3}$.\n\n- Case D (zero field): $\\mathbf{u}_i = \\mathbf{0}$.\n\nYour program must produce a single line of output containing the four energies, as a comma-separated list enclosed in square brackets, in Joules, in the order [Case A, Case B, Case C, Case D]. For example, the output format should be exactly like \"[0.0,0.1,0.2,0.3]\" but with the correct numerical values for this problem. Angles are not involved in this problem. Percentages are not used. All results must be floats in Joules.\n\nDesign for coverage: this test suite covers the happy path (regular element), the boundary condition of zero field, the pure hourglass excitation, and the superposition with an affine field. The answers are floats. The code must be entirely self-contained and require no input.", "solution": "The problem requires the implementation and theoretical justification of an hourglass control method for a single eight-node trilinear hexahedral finite element. This involves constructing the hourglass modes, calculating geometric properties of the element, and evaluating a quadratic hourglass strain energy functional for several specified nodal displacement fields.\n\nThe solution proceeds in a sequence of logical steps: first, we establish the geometric relationship between the physical element and its parent domain; second, we define the hourglass modes and the corresponding energy functional; and third, we apply this framework to evaluate the energy for the specified test cases.\n\n**1. Element Geometry and Isoparametric Mapping**\n\nThe geometry of the finite element in physical space, $\\mathbf{X} \\in \\mathbb{R}^3$, is mapped from a canonical parent domain with natural coordinates $(\\xi, \\eta, \\zeta) \\in [-1, 1]^3$. This isoparametric mapping uses the same shape functions for interpolating geometry as for interpolating displacement fields. The physical coordinates $\\mathbf{X}$ are given by:\n$$ \\mathbf{X}(\\xi, \\eta, \\zeta) = \\sum_{i=1}^{8} N_i(\\xi, \\eta, \\zeta) \\mathbf{X}_i $$\nwhere $\\mathbf{X}_i$ are the physical coordinates of the eight nodes and $N_i$ are the trilinear shape functions:\n$$ N_i(\\xi, \\eta, \\zeta) = \\frac{1}{8} (1 + \\xi \\xi_i)(1 + \\eta \\eta_i)(1 + \\zeta \\zeta_i) $$\nHere, $(\\xi_i, \\eta_i, \\zeta_i)$ are the natural coordinates of node $i$, which take values in $\\{-1, 1\\}^3$.\n\n**2. Jacobian Matrix and Element-Level Quantities**\n\nThe hourglass formulation is based on single-point quadrature at the element's center, $(\\xi, \\eta, \\zeta) = (0, 0, 0)$. We need the Jacobian matrix $\\mathbf{J}$ of the mapping at this point. The entries of the Jacobian are $J_{ab} = \\frac{\\partial X_a}{\\partial \\xi_b}$, where $X_a$ is the $a$-th component of $\\mathbf{X}$ and $\\xi_b$ is the $b$-th natural coordinate (e.g., $\\xi_1 = \\xi$, $\\xi_2 = \\eta$, $\\xi_3 = \\zeta$).\n$$ \\mathbf{J} = \\frac{\\partial \\mathbf{X}}{\\partial (\\xi, \\eta, \\zeta)} \\bigg|_{(0,0,0)} = \\sum_{i=1}^{8} \\mathbf{X}_i \\otimes \\nabla N_i(0,0,0) $$\nThe gradient of the shape functions at the center is:\n$$ \\nabla N_i(0,0,0) = \\left( \\frac{\\partial N_i}{\\partial \\xi}, \\frac{\\partial N_i}{\\partial \\eta}, \\frac{\\partial N_i}{\\partial \\zeta} \\right) \\bigg|_{(0,0,0)} = \\frac{1}{8} (\\xi_i, \\eta_i, \\zeta_i) $$\nThe columns of $\\mathbf{J}$ are thus:\n$$ \\frac{\\partial \\mathbf{X}}{\\partial \\xi} \\bigg|_{(0,0,0)} = \\sum_{i=1}^{8} \\frac{\\xi_i}{8} \\mathbf{X}_i, \\quad \\frac{\\partial \\mathbf{X}}{\\partial \\eta} \\bigg|_{(0,0,0)} = \\sum_{i=1}^{8} \\frac{\\eta_i}{8} \\mathbf{X}_i, \\quad \\frac{\\partial \\mathbf{X}}{\\partial \\zeta} \\bigg|_{(0,0,0)} = \\sum_{i=1}^{8} \\frac{\\zeta_i}{8} \\mathbf{X}_i $$\nFor the specified rectangular parallelepiped, the nodal coordinates are $\\mathbf{X}_i = (\\frac{L_x}{2} \\xi_i, \\frac{L_y}{2} \\eta_i, \\frac{L_z}{2} \\zeta_i)$. Substituting this into the expressions, and using the orthogonality relations $\\sum_i \\xi_i \\eta_i = 0$, $\\sum_i \\xi_i \\zeta_i = 0$, etc., and the property $\\sum_i \\xi_i^2 = 8$, we find:\n$$ \\frac{\\partial \\mathbf{X}}{\\partial \\xi} \\bigg|_{(0,0,0)} = \\frac{1}{8} \\sum_{i=1}^{8} \\xi_i \\begin{pmatrix} \\frac{L_x}{2}\\xi_i \\\\ \\frac{L_y}{2}\\eta_i \\\\ \\frac{L_z}{2}\\zeta_i \\end{pmatrix} = \\frac{1}{8} \\begin{pmatrix} \\frac{L_x}{2}\\sum_i \\xi_i^2 \\\\ \\frac{L_y}{2}\\sum_i \\xi_i \\eta_i \\\\ \\frac{L_z}{2}\\sum_i \\xi_i \\zeta_i \\end{pmatrix} = \\begin{pmatrix} L_x/2 \\\\ 0 \\\\ 0 \\end{pmatrix} $$\nSimilarly, we find the other columns, resulting in a diagonal Jacobian matrix:\n$$ \\mathbf{J} = \\begin{bmatrix} L_x/2 & 0 & 0 \\\\ 0 & L_y/2 & 0 \\\\ 0 & 0 & L_z/2 \\end{bmatrix} $$\nWith $L_x=0.3$, $L_y=0.2$, and $L_z=0.1$, we have:\n$$ \\mathbf{J} = \\begin{bmatrix} 0.15 & 0 & 0 \\\\ 0 & 0.1 & 0 \\\\ 0 & 0 & 0.05 \\end{bmatrix} $$\nThe element volume $V$ and characteristic squared length $L^2$ are computed from $\\mathbf{J}$:\n$$ \\det(\\mathbf{J}) = (0.15)(0.1)(0.05) = 0.00075 $$\n$$ V = 8 \\det(\\mathbf{J}) = 8 \\times 0.00075 = 0.006 \\, \\mathrm{m}^3 $$\nThis correctly gives the volume $L_x L_y L_z = (0.3)(0.2)(0.1) = 0.006$.\n$$ L^2 = \\mathrm{tr}(\\mathbf{J}^\\mathsf{T} \\mathbf{J}) = \\mathrm{tr}(\\mathbf{J}^2) = (L_x/2)^2 + (L_y/2)^2 + (L_z/2)^2 = (0.15)^2 + (0.1)^2 + (0.05)^2 $$\n$$ L^2 = 0.0225 + 0.01 + 0.0025 = 0.035 \\, \\mathrm{m}^2 $$\n\n**3. Hourglass Formulation**\n\nHourglass modes are deformation patterns that produce zero strain at the single integration point, yet are non-zero. They must be controlled to prevent spurious mechanisms. The four scalar hourglass mode vectors $\\gamma^\\alpha \\in \\mathbb{R}^8$ are defined at the nodes by products of the natural coordinates:\n$$ \\gamma^1_i = \\xi_i \\eta_i, \\quad \\gamma^2_i = \\eta_i \\zeta_i, \\quad \\gamma^3_i = \\zeta_i \\xi_i, \\quad \\gamma^4_i = \\xi_i \\eta_i \\zeta_i $$\nThese vectors are orthogonal to the constant, linear, and bilinear fields that are correctly captured by the element's stiffness matrix. Specifically, they are orthogonal to nodal vectors corresponding to constant fields ($1$) and linear fields ($\\xi_i, \\eta_i, \\zeta_i$) under the summation $\\sum_{i=1}^8$.\n\nGiven a nodal displacement field $\\mathbf{u}_i$, the vector amplitudes of the hourglass modes, $\\mathbf{a}^\\alpha \\in \\mathbb{R}^3$, are found by projecting $\\mathbf{u}_i$ onto each mode shape $\\gamma^\\alpha_i$:\n$$ \\mathbf{a}^\\alpha = \\frac{1}{8} \\sum_{i=1}^{8} \\gamma^\\alpha_i \\mathbf{u}_i $$\nThe hourglass strain energy $W_{\\mathrm{hg}}$ is then defined as a quadratic function of these amplitudes:\n$$ W_{\\mathrm{hg}} = \\frac{1}{2} \\beta \\mu \\frac{V}{L^2} \\sum_{\\alpha=1}^{4} \\|\\mathbf{a}^\\alpha\\|^2 $$\nUsing the given parameters $\\mu = 5.0 \\times 10^5$ Pa and $\\beta = 1.0$, the energy pre-factor is:\n$$ \\frac{1}{2} \\beta \\mu \\frac{V}{L^2} = \\frac{1}{2} (1.0) (5.0 \\times 10^5) \\frac{0.006}{0.035} = \\frac{3 \\times 10^5}{7} \\, \\mathrm{J/m^2} $$\n\n**4. Evaluation of Test Cases**\n\n**Case A (Affine Field):** $\\mathbf{u}_i = \\mathbf{A} \\mathbf{X}_i + \\mathbf{b}$\nThe amplitude for mode $\\alpha$ is:\n$$ \\mathbf{a}^\\alpha = \\frac{1}{8} \\sum_{i=1}^{8} \\gamma^\\alpha_i (\\mathbf{A} \\mathbf{X}_i + \\mathbf{b}) = \\mathbf{A} \\left( \\frac{1}{8} \\sum_{i=1}^{8} \\gamma^\\alpha_i \\mathbf{X}_i \\right) + \\mathbf{b} \\left( \\frac{1}{8} \\sum_{i=1}^{8} \\gamma^\\alpha_i \\right) $$\nThe sum $\\sum_i \\gamma^\\alpha_i = 0$ for all $\\alpha=1, \\dots, 4$ due to orthogonality with the constant mode. The term $\\sum_i \\gamma^\\alpha_i \\mathbf{X}_i$ also vanishes. For example, for $\\alpha=1$ ($\\gamma^1_i = \\xi_i \\eta_i$):\n$$ \\sum_{i=1}^{8} \\gamma^1_i \\mathbf{X}_i = \\sum_{i=1}^{8} (\\xi_i \\eta_i) \\begin{pmatrix} \\frac{L_x}{2}\\xi_i \\\\ \\frac{L_y}{2}\\eta_i \\\\ \\frac{L_z}{2}\\zeta_i \\end{pmatrix} = \\begin{pmatrix} \\frac{L_x}{2}\\sum_i \\xi_i^2 \\eta_i \\\\ \\frac{L_y}{2}\\sum_i \\xi_i \\eta_i^2 \\\\ \\frac{L_z}{2}\\sum_i \\xi_i \\eta_i \\zeta_i \\end{pmatrix} = \\begin{pmatrix} \\frac{L_x}{2}\\sum_i \\eta_i \\\\ \\frac{L_y}{2}\\sum_i \\xi_i \\\\ \\frac{L_z}{2}\\sum_i (\\xi_i\\eta_i\\zeta_i) \\end{pmatrix} = \\mathbf{0} $$\nThis holds since $\\sum_i \\xi_i=\\sum_i\\eta_i=0$ and the trilinear mode $\\xi\\eta\\zeta$ is orthogonal to the bilinear mode $\\xi\\eta$. Similar derivations show this is true for all $\\gamma^\\alpha$. Thus, $\\mathbf{a}^\\alpha = \\mathbf{0}$ for all $\\alpha$, and $W_{\\mathrm{hg}} = 0$.\n\n**Case B (Pure Hourglass Mode):** $\\mathbf{u}_i = [u_0 \\gamma^1_i, 0, 0]^\\mathsf{T}$ with $u_0 = 1.0 \\times 10^{-3}$ m.\nDue to the orthogonality of the hourglass modes ($\\sum_i \\gamma^\\alpha_i \\gamma^\\beta_i = 8 \\delta_{\\alpha\\beta}$), only the amplitude $\\mathbf{a}^1$ will be non-zero.\n$$ \\mathbf{a}^1 = \\frac{1}{8} \\sum_{i=1}^{8} \\gamma^1_i \\begin{pmatrix} u_0 \\gamma^1_i \\\\ 0 \\\\ 0 \\end{pmatrix} = \\frac{1}{8} \\begin{pmatrix} u_0 \\sum_i (\\gamma^1_i)^2 \\\\ 0 \\\\ 0 \\end{pmatrix} = \\frac{1}{8} \\begin{pmatrix} u_0 \\cdot 8 \\\\ 0 \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} u_0 \\\\ 0 \\\\ 0 \\end{pmatrix} $$\n$$ \\mathbf{a}^2 = \\mathbf{a}^3 = \\mathbf{a}^4 = \\mathbf{0} $$\nThe total squared amplitude is $\\sum \\|\\mathbf{a}^\\alpha\\|^2 = \\|\\mathbf{a}^1\\|^2 = u_0^2 = (1.0 \\times 10^{-3})^2 = 1.0 \\times 10^{-6} \\, \\mathrm{m}^2$.\n$$ W_{\\mathrm{hg}} = \\left(\\frac{3 \\times 10^5}{7}\\right) \\times (1.0 \\times 10^{-6}) = \\frac{0.3}{7} \\approx 0.042857 \\, \\mathrm{J} $$\n\n**Case C (Affine + Hourglass):** $\\mathbf{u}_i = \\mathbf{A} \\mathbf{X}_i + \\mathbf{b} + [0, v_0 \\gamma^3_i, 0]^\\mathsf{T}$ with $v_0 = 2.0 \\times 10^{-3}$ m.\nBy linearity, the affine part of the displacement field does not contribute to the hourglass amplitudes. We only need to consider the pure hourglass part $\\mathbf{u}_i^{\\mathrm{hg}} = [0, v_0 \\gamma^3_i, 0]^\\mathsf{T}$.\nSimilar to Case B, only $\\mathbf{a}^3$ will be non-zero:\n$$ \\mathbf{a}^3 = \\frac{1}{8} \\sum_{i=1}^{8} \\gamma^3_i \\begin{pmatrix} 0 \\\\ v_0 \\gamma^3_i \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ v_0 \\\\ 0 \\end{pmatrix} $$\n$$ \\mathbf{a}^1 = \\mathbf{a}^2 = \\mathbf{a}^4 = \\mathbf{0} $$\nThe total squared amplitude is $\\sum \\|\\mathbf{a}^\\alpha\\|^2 = \\|\\mathbf{a}^3\\|^2 = v_0^2 = (2.0 \\times 10^{-3})^2 = 4.0 \\times 10^{-6} \\, \\mathrm{m}^2$.\n$$ W_{\\mathrm{hg}} = \\left(\\frac{3 \\times 10^5}{7}\\right) \\times (4.0 \\times 10^{-6}) = \\frac{1.2}{7} \\approx 0.171429 \\, \\mathrm{J} $$\n\n**Case D (Zero Field):** $\\mathbf{u}_i = \\mathbf{0}$\nIf all displacements are zero, the amplitudes are trivially $\\mathbf{a}^\\alpha = \\mathbf{0}$ for all $\\alpha$, and thus $W_{\\mathrm{hg}} = 0$.\n\n**Summary of Results:**\n-   Case A: $W_{\\mathrm{hg}} = 0.0$ J\n-   Case B: $W_{\\mathrm{hg}} \\approx 0.042857$ J\n-   Case C: $W_{\\mathrm{hg}} \\approx 0.171429$ J\n-   Case D: $W_{\\mathrm{hg}} = 0.0$ J", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements the hourglass control calculation for an 8-node hexahedral element.\n    \"\"\"\n    # 1. Define constants and element geometry\n    L_x, L_y, L_z = 0.3, 0.2, 0.1  # meters\n    mu = 5.0e5  # Pascals\n    beta = 1.0  # Dimensionless stabilization parameter\n\n    # Natural coordinates for nodes 1-8\n    natural_coords = np.array([\n        [-1, -1, -1],  # Node 1\n        [ 1, -1, -1],  # Node 2\n        [ 1,  1, -1],  # Node 3\n        [-1,  1, -1],  # Node 4\n        [-1, -1,  1],  # Node 5\n        [ 1, -1,  1],  # Node 6\n        [ 1,  1,  1],  # Node 7\n        [-1,  1,  1]   # Node 8\n    ])\n\n    # Physical coordinates\n    # X_i = (L_x/2 * xi_i, L_y/2 * eta_i, L_z/2 * zeta_i)\n    L_vec = np.array([L_x / 2.0, L_y / 2.0, L_z / 2.0])\n    physical_coords = natural_coords * L_vec\n\n    # 2. Compute Jacobian, Volume, and Characteristic Length\n    # Derivatives of shape functions at the center (xi,eta,zeta)=(0,0,0)\n    # dN_i/d_xi = (1/8)*xi_i, etc.\n    # The gradient vectors for all nodes are (1/8) * natural_coords\n    grad_N_center = 0.125 * natural_coords.T  # Shape (3, 8)\n\n    # Jacobian J_ij = sum_k (X_ik * dN_k/d_xi_j)\n    # J = X^T @ grad_N_center^T\n    J = physical_coords.T @ grad_N_center.T\n    \n    # For a rectangular element, J is diagonal:\n    # J = diag(L_x/2, L_y/2, L_z/2)\n    # This calculation is kept general for verification.\n\n    det_J = np.linalg.det(J)\n    V = 8.0 * det_J\n    L_sq = np.trace(J.T @ J)\n    \n    # 3. Construct hourglass mode vectors\n    xi = natural_coords[:, 0]\n    eta = natural_coords[:, 1]\n    zeta = natural_coords[:, 2]\n\n    gamma1 = xi * eta\n    gamma2 = eta * zeta\n    gamma3 = zeta * xi\n    gamma4 = xi * eta * zeta\n    \n    gammas = np.array([gamma1, gamma2, gamma3, gamma4]) # Shape (4, 8)\n\n    # 4. Define test cases\n    A = np.array([\n        [0.01, 0.02, -0.01],\n        [0.0, -0.005, 0.015],\n        [0.02, 0.01, 0.005]\n    ])\n    b = np.array([0.001, -0.0005, 0.0002])\n    u0 = 1.0e-3\n    v0 = 2.0e-3\n\n    # Case A: Affine field\n    u_A = (A @ physical_coords.T).T + b\n    \n    # Case B: Pure hourglass mode\n    u_B = np.zeros((8, 3))\n    u_B[:, 0] = u0 * gamma1\n\n    # Case C: Affine + hourglass\n    u_C_hg = np.zeros((8, 3))\n    u_C_hg[:, 1] = v0 * gamma3\n    u_C = u_A + u_C_hg\n\n    # Case D: Zero field\n    u_D = np.zeros((8, 3))\n\n    test_cases = [u_A, u_B, u_C, u_D]\n    results = []\n\n    # 5. Calculate hourglass energy for each case\n    energy_prefactor = 0.5 * beta * mu * V / L_sq\n    \n    for u in test_cases:\n        sum_a_sq_norm = 0.0\n        for alpha in range(4):\n            # Project displacements onto hourglass mode to get amplitude vector a_alpha\n            # a_alpha = (1/8) * sum(gamma_i * u_i)\n            # This is equivalent to (1/8) * u.T @ gamma\n            a_alpha = (1.0 / 8.0) * u.T @ gammas[alpha]\n            sum_a_sq_norm += np.linalg.norm(a_alpha)**2\n        \n        W_hg = energy_prefactor * sum_a_sq_norm\n        results.append(W_hg)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3571351"}, {"introduction": "While hourglass control is essential for stability, it introduces artificial stiffness into the model, which has important consequences for explicit dynamic simulations. This practice guides you through an analysis to quantify this effect by linking the stabilization coefficient $\\alpha$ to the wave propagation speed of the spurious hourglass mode [@problem_id:3571348]. By determining the threshold at which this numerical wave speed becomes a significant fraction of the physical shear wave speed, you will develop a crucial intuition for selecting appropriate stabilization parameters that balance stability with accuracy and computational efficiency.", "problem": "An eight-node trilinear hexahedral element with one-point (reduced) integration is used in an explicit dynamic simulation with mass lumping. The material is homogeneous, isotropic, and linearly elastic with mass density $\\rho$ and shear modulus $\\mu$. Consider a single element that is a cube of edge length $h$ and volume $V = h^{3}$. Hourglass control is applied using a stiffness-based stabilization whose stored energy for a single hourglass mode is modeled as\n$$\nE_{\\mathrm{hg}} = \\frac{1}{2}\\,\\alpha\\,\\mu\\,V\\,q^{2},\n$$\nwhere $\\alpha$ is a dimensionless hourglass coefficient and $q$ is a dimensionless hourglass deformation measure.\n\nFocus on the canonical hourglass mode associated with variation along the $\\xi$-direction in the parent domain. Let the eight nodes be ordered so that the sign vector $s = [s_{1},\\dots,s_{8}]^{T}$ satisfies $s_{i} = \\operatorname{sign}(\\xi_{i}) \\in \\{-1,1\\}$ at each corner of the reference cube. Prescribe a nodal displacement pattern in the global $x$-direction of the form $u_{i} = a\\,s_{i}$, where $a$ is a real amplitude, and define the hourglass measure by\n$$\nq = \\frac{1}{8h}\\sum_{i=1}^{8} s_{i}\\,u_{i}.\n$$\nAssume periodic repetition of this element along the $x$-direction so that the prescribed pattern mimics the element Nyquist wavenumber $k_{N} = \\pi/h$. Take the continuum shear wave speed to be $c_{s} = \\sqrt{\\mu/\\rho}$, and model the spurious hourglass mode as a discrete harmonic oscillator with phase speed $c_{\\mathrm{hg}} = \\omega_{\\mathrm{hg}}/k_{N}$, where $\\omega_{\\mathrm{hg}}$ is the natural angular frequency extracted from the ratio of quadratic forms of the hourglass energy and the lumped mass. Use lumped nodal mass $m_{n} = \\rho V/8$.\n\nDefine that the hourglass stiffness “significantly alters wave speed dispersion” when the spurious phase speed at the element Nyquist wavenumber equals a fraction $\\varepsilon$ of the physical shear speed, with $\\varepsilon = 0.05$. Under the stated assumptions, derive and compute the threshold value $\\alpha_{\\mathrm{th}}$ such that $c_{\\mathrm{hg}} = \\varepsilon\\,c_{s}$ holds at $k_{N} = \\pi/h$.\n\nRound your final numerical value of $\\alpha_{\\mathrm{th}}$ to four significant figures. Express the final answer as a dimensionless number.", "solution": "The problem requires the derivation of a threshold value for the dimensionless hourglass coefficient, $\\alpha_{\\mathrm{th}}$, under a specific set of modeling assumptions for an eight-node hexahedral element. The criterion for this threshold is that the phase speed of the spurious hourglass mode, $c_{\\mathrm{hg}}$, at the element Nyquist wavenumber equals a fraction $\\varepsilon$ of the physical shear wave speed, $c_s$.\n\nFirst, we determine the hourglass deformation measure, $q$, for the prescribed displacement pattern. The nodal displacements in the global $x$-direction are given as $u_{i} = a\\,s_{i}$, where $a$ is a time-dependent amplitude and $s_{i}$ is the sign of the local coordinate $\\xi_i$ for node $i$. The hourglass measure $q$ is defined as:\n$$\nq = \\frac{1}{8h}\\sum_{i=1}^{8} s_{i}\\,u_{i}\n$$\nSubstituting the expression for $u_i$:\n$$\nq = \\frac{1}{8h}\\sum_{i=1}^{8} s_{i}\\,(a\\,s_{i}) = \\frac{a}{8h}\\sum_{i=1}^{8} s_{i}^{2}\n$$\nSince $s_{i} \\in \\{-1, 1\\}$, we have $s_{i}^{2} = 1$ for all nodes $i=1, \\dots, 8$. The summation becomes $\\sum_{i=1}^{8} s_{i}^{2} = 8$. Therefore, the hourglass measure is directly proportional to the amplitude $a$:\n$$\nq = \\frac{a}{8h}(8) = \\frac{a}{h}\n$$\nNext, we express the stored hourglass energy, $E_{\\mathrm{hg}}$, in terms of the amplitude $a$. The model for hourglass energy is:\n$$\nE_{\\mathrm{hg}} = \\frac{1}{2}\\,\\alpha\\,\\mu\\,V\\,q^{2}\n$$\nSubstituting $q = a/h$ and the element volume $V = h^{3}$:\n$$\nE_{\\mathrm{hg}} = \\frac{1}{2}\\,\\alpha\\,\\mu\\,h^{3}\\,\\left(\\frac{a}{h}\\right)^{2} = \\frac{1}{2}\\,\\alpha\\,\\mu\\,h^{3}\\,\\frac{a^{2}}{h^{2}} = \\frac{1}{2}(\\alpha\\,\\mu\\,h)a^{2}\n$$\nThis expression is the potential energy of a harmonic oscillator. The effective stiffness of the hourglass mode, $K_{\\mathrm{hg}}$, can be identified from this quadratic form as:\n$$\nK_{\\mathrm{hg}} = \\alpha\\,\\mu\\,h\n$$\nNow, we determine the kinetic energy, $T$, of the element for the prescribed motion. The simulation uses a lumped mass matrix, with the mass at each node being $m_{n} = \\rho V/8$. The velocity of each node is $\\dot{u}_{i} = \\frac{d}{dt}(a s_i) = \\dot{a} s_i$. The total kinetic energy is the sum of the kinetic energies of the eight nodes:\n$$\nT = \\frac{1}{2}\\sum_{i=1}^{8} m_{n}\\,\\dot{u}_{i}^{2} = \\frac{1}{2}\\sum_{i=1}^{8} \\left(\\frac{\\rho V}{8}\\right)(\\dot{a} s_{i})^{2}\n$$\nSubstituting $V=h^3$ and factoring out the constant terms:\n$$\nT = \\frac{1}{2}\\left(\\frac{\\rho h^{3}}{8}\\right)\\dot{a}^{2}\\sum_{i=1}^{8}s_{i}^{2}\n$$\nAs before, $\\sum_{i=1}^{8} s_{i}^{2} = 8$. The kinetic energy becomes:\n$$\nT = \\frac{1}{2}\\left(\\frac{\\rho h^{3}}{8}\\right)\\dot{a}^{2}(8) = \\frac{1}{2}(\\rho h^{3})\\dot{a}^{2}\n$$\nFrom this quadratic form in $\\dot{a}$, we identify the effective mass of the hourglass mode:\n$$\nM_{\\mathrm{eff}} = \\rho h^{3}\n$$\nThe equation of motion for this single degree-of-freedom system (with generalized coordinate $a$) is that of a simple harmonic oscillator, $M_{\\mathrm{eff}}\\ddot{a} + K_{\\mathrm{hg}}a = 0$. The natural angular frequency, $\\omega_{\\mathrm{hg}}$, is given by:\n$$\n\\omega_{\\mathrm{hg}}^{2} = \\frac{K_{\\mathrm{hg}}}{M_{\\mathrm{eff}}} = \\frac{\\alpha\\,\\mu\\,h}{\\rho h^{3}} = \\frac{\\alpha\\,\\mu}{\\rho h^{2}}\n$$\nTaking the square root, we find the angular frequency:\n$$\n\\omega_{\\mathrm{hg}} = \\sqrt{\\frac{\\alpha\\,\\mu}{\\rho h^{2}}} = \\frac{1}{h}\\sqrt{\\frac{\\alpha\\,\\mu}{\\rho}}\n$$\nThe phase speed of the spurious hourglass mode, $c_{\\mathrm{hg}}$, is defined as the ratio of its angular frequency to the wavenumber, $c_{\\mathrm{hg}} = \\omega_{\\mathrm{hg}}/k_N$. The problem specifies the element Nyquist wavenumber, $k_{N} = \\pi/h$.\n$$\nc_{\\mathrm{hg}} = \\frac{\\omega_{\\mathrm{hg}}}{k_{N}} = \\frac{\\frac{1}{h}\\sqrt{\\frac{\\alpha \\mu}{\\rho}}}{\\frac{\\pi}{h}} = \\frac{1}{\\pi}\\sqrt{\\frac{\\alpha \\mu}{\\rho}}\n$$\nThe problem defines the threshold condition for \"significant alteration\" of wave speed dispersion as $c_{\\mathrm{hg}} = \\varepsilon\\,c_{s}$, where $c_{s} = \\sqrt{\\mu/\\rho}$ is the continuum shear wave speed and $\\varepsilon = 0.05$. We set the hourglass coefficient $\\alpha$ to its threshold value $\\alpha_{\\mathrm{th}}$ and enforce this condition:\n$$\n\\frac{1}{\\pi}\\sqrt{\\frac{\\alpha_{\\mathrm{th}}\\,\\mu}{\\rho}} = \\varepsilon \\sqrt{\\frac{\\mu}{\\rho}}\n$$\nAssuming $\\mu > 0$ and $\\rho > 0$, we can cancel the term $\\sqrt{\\mu/\\rho}$ from both sides:\n$$\n\\frac{1}{\\pi}\\sqrt{\\alpha_{\\mathrm{th}}} = \\varepsilon\n$$\nSolving for $\\alpha_{\\mathrm{th}}$:\n$$\n\\sqrt{\\alpha_{\\mathrm{th}}} = \\pi\\,\\varepsilon\n$$\n$$\n\\alpha_{\\mathrm{th}} = (\\pi\\,\\varepsilon)^{2}\n$$\nThis is the symbolic expression for the threshold value. Now, we substitute the given numerical value $\\varepsilon = 0.05$:\n$$\n\\alpha_{\\mathrm{th}} = (\\pi \\times 0.05)^{2} = (0.05\\pi)^{2}\n$$\nNumerically, this is:\n$$\n\\alpha_{\\mathrm{th}} \\approx (3.14159265 \\times 0.05)^{2} \\approx (0.15707963)^{2} \\approx 0.02467401\n$$\nRounding the result to four significant figures gives:\n$$\n\\alpha_{\\mathrm{th}} \\approx 0.02467\n$$", "answer": "$$\\boxed{0.02467}$$", "id": "3571348"}, {"introduction": "Static hourglass coefficients provide a simple stabilization method, but a more robust approach is to adapt the control based on the element's current state. This advanced practice involves deriving and implementing an adaptive rule that modulates the hourglass coefficient $c_h$ to maintain a healthy ratio between spurious hourglass energy and physical strain energy [@problem_id:3571380]. This technique ensures that stabilization is applied judiciously—strong enough to control zero-energy modes but not so strong as to pollute the solution with excessive artificial stiffness, leading to more accurate and reliable simulation results.", "problem": "Consider a single eight-node trilinear hexahedral finite element with one-point integration in three-dimensional linear elasticity. Under under-integration, non-physical zero-energy modes known as hourglass modes may appear. A common stabilization approach augments the discrete energy with an hourglass control term. Your task is to derive, from first principles, an adaptive rule for the hourglass coefficient that maintains the ratio between hourglass energy and elastic strain energy bounded by a prescribed tolerance, and then implement it.\n\nStart from the following fundamental bases:\n- The principle of virtual work and linear elasticity for small strains and small displacements.\n- The elastic strain energy density for linear isotropic materials, given by $w = \\frac{1}{2} \\boldsymbol{\\varepsilon} : \\boldsymbol{\\sigma}$, with $\\boldsymbol{\\sigma} = \\mathbf{C} \\boldsymbol{\\varepsilon}$ and $\\mathbf{C}$ the $6 \\times 6$ isotropic stiffness in Voigt notation.\n- For a constant-strain state within a one-point integrated hexahedral element, the elastic strain energy can be written as $W_e = \\frac{1}{2} \\boldsymbol{\\varepsilon}^\\mathsf{T} \\mathbf{C} \\, \\boldsymbol{\\varepsilon} \\, V$, where $V$ is the element volume.\n- An hourglass stabilization energy is modeled as $W_h = \\frac{1}{2} k_h \\, \\| \\mathbf{q} \\|^2$, where $\\mathbf{q}$ is the vector of hourglass mode amplitudes extracted from nodal displacements and $k_h$ is the scalar hourglass stiffness. In many physically motivated formulations, $k_h$ scales with shear modulus and volume as $k_h = c_h \\, G \\, V$, where $G$ is the shear modulus and $c_h$ is a dimensionless coefficient to be tuned.\n\nYour goal:\n1. Derive an adaptive rule for the hourglass coefficient $c_h$ such that the ratio $W_h/W_e \\le \\eta$, where $\\eta$ is a prescribed non-dimensional tolerance.\n2. Implement this rule in a program that computes $c_h$ for several test cases, using the element’s kinematics and material parameters.\n\nElement kinematics and operators to use:\n- Eight-node hexahedral element with nodes numbered $0$ to $7$ and natural coordinates $(\\xi_i,\\eta_i,\\zeta_i)$ assigned per node as:\n  - Node $0$: $(-1,-1,-1)$, Node $1$: $(+1,-1,-1)$, Node $2$: $(+1,+1,-1)$, Node $3$: $(-1,+1,-1)$,\n  - Node $4$: $(-1,-1,+1)$, Node $5$: $(+1,-1,+1)$, Node $6$: $(+1,+1,+1)$, Node $7$: $(-1,+1,+1)$.\n- Assume a unit cube mapping such that the physical volume is $V = 1.0$ and the mapping from natural to physical coordinates yields the derivatives of shape functions at the element center $(\\xi,\\eta,\\zeta)=(0,0,0)$ as $ \\partial N_i/\\partial x = \\xi_i/4$, $ \\partial N_i/\\partial y = \\eta_i/4$, $ \\partial N_i/\\partial z = \\zeta_i/4$.\n- Construct the strain-displacement matrix $\\mathbf{B}$ of size $6 \\times 24$ (Voigt order $\\boldsymbol{\\varepsilon} = [\\varepsilon_{xx}, \\varepsilon_{yy}, \\varepsilon_{zz}, \\varepsilon_{xy}, \\varepsilon_{yz}, \\varepsilon_{zx}]^\\mathsf{T}$) using:\n  - $\\varepsilon_{xx} = \\sum_{i=0}^{7} (\\partial N_i/\\partial x)\\, u_{x,i}$,\n  - $\\varepsilon_{yy} = \\sum_{i=0}^{7} (\\partial N_i/\\partial y)\\, u_{y,i}$,\n  - $\\varepsilon_{zz} = \\sum_{i=0}^{7} (\\partial N_i/\\partial z)\\, u_{z,i}$,\n  - $\\varepsilon_{xy} = \\sum_{i=0}^{7} [(\\partial N_i/\\partial x)\\, u_{y,i} + (\\partial N_i/\\partial y)\\, u_{x,i}]$,\n  - $\\varepsilon_{yz} = \\sum_{i=0}^{7} [(\\partial N_i/\\partial y)\\, u_{z,i} + (\\partial N_i/\\partial z)\\, u_{y,i}]$,\n  - $\\varepsilon_{zx} = \\sum_{i=0}^{7} [(\\partial N_i/\\partial z)\\, u_{x,i} + (\\partial N_i/\\partial x)\\, u_{z,i}]$,\n  where $u_{x,i}, u_{y,i}, u_{z,i}$ are the displacement components at node $i$.\n- Use the isotropic stiffness matrix $\\mathbf{C}$ in Voigt notation for three-dimensional linear elasticity:\n  - Compute the Lamé parameters $\\lambda = \\dfrac{E \\nu}{(1+\\nu)(1-2\\nu)}$ and $G = \\dfrac{E}{2(1+\\nu)}$ from Young’s modulus $E$ and Poisson’s ratio $\\nu$.\n  - Then\n    $$\\mathbf{C} = \\begin{bmatrix}\n    \\lambda+2G & \\lambda & \\lambda & 0 & 0 & 0 \\\\\n    \\lambda & \\lambda+2G & \\lambda & 0 & 0 & 0 \\\\\n    \\lambda & \\lambda & \\lambda+2G & 0 & 0 & 0 \\\\\n    0 & 0 & 0 & G & 0 & 0 \\\\\n    0 & 0 & 0 & 0 & G & 0 \\\\\n    0 & 0 & 0 & 0 & 0 & G\n    \\end{bmatrix}. $$\n\nHourglass amplitude extraction:\n- Use four standard Flanagan–Belytschko hourglass vectors $\\mathbf{H}_\\alpha$ for $\\alpha=1,2,3,4$ over the eight nodes:\n  - $\\mathbf{H}_1 = [\\, +1,-1,+1,-1,-1,+1,-1,+1 \\,]$,\n  - $\\mathbf{H}_2 = [\\, +1,+1,-1,-1,-1,-1,+1,+1 \\,]$,\n  - $\\mathbf{H}_3 = [\\, +1,-1,-1,+1,-1,+1,+1,-1 \\,]$,\n  - $\\mathbf{H}_4 = [\\, +1,+1,+1,+1,-1,-1,-1,-1 \\,]$.\n- Define the hourglass extraction operator $\\mathbf{Q}$ of size $12 \\times 24$ by building three component-specific rows per mode:\n  - For each mode $\\alpha$ and component $c \\in \\{x,y,z\\}$, define $q_{\\alpha c} = \\sum_{i=0}^{7} H_{\\alpha,i} \\, u_{c,i}$.\n  - Stack these into the vector $\\mathbf{q} \\in \\mathbb{R}^{12}$ as $\\mathbf{q} = [q_{1x},q_{1y},q_{1z},q_{2x},\\dots,q_{4z}]^\\mathsf{T}$ so that $\\mathbf{q} = \\mathbf{Q} \\mathbf{u}$, where $\\mathbf{u} \\in \\mathbb{R}^{24}$ is the nodal displacement vector ordered as $(u_{x,0},u_{y,0},u_{z,0},\\dots,u_{x,7},u_{y,7},u_{z,7})$.\n\nAdaptive rule objective:\n- Maintain $W_h/W_e \\le \\eta$ for a given $\\eta > 0$ by choosing $c_h$ adaptively at the current state. Assume $W_h = \\frac{1}{2} c_h \\, G \\, V \\, \\|\\mathbf{q}\\|^2$.\n- Derive an expression for $c_h$ in terms of $E$, $\\nu$, $V$, $\\mathbf{B}$, $\\mathbf{C}$, $\\mathbf{Q}$, and $\\mathbf{u}$, respecting the constraint $W_h/W_e \\le \\eta$.\n\nBoundary and degeneracy handling:\n- If $\\|\\mathbf{q}\\|^2 = 0$, set $c_h$ to a provided baseline $c_h^{\\text{base}}$.\n- Else if $W_e = 0$ and $\\|\\mathbf{q}\\|^2 > 0$, set $c_h = 0$.\n- Else choose $c_h$ as the minimum of $c_h^{\\text{base}}$ and the value implied by enforcing $W_h/W_e = \\eta$ exactly.\n\nUnits and final answer:\n- Use the International System of Units: $E$ in $\\mathrm{Pa}$, displacements $u$ in $\\mathrm{m}$, volume $V$ in $\\mathrm{m}^3$. The output $c_h$ is dimensionless. No angle units are involved.\n- Your program must compute $c_h$ for the test suite below and print a single line containing a list of four floating-point values $[c_{h,1},c_{h,2},c_{h,3},c_{h,4}]$, where each entry corresponds to a test case.\n\nTest suite specifications:\n- Common geometry: use the node natural coordinates listed, $V = 1.0$.\n- Construct $\\mathbf{B}$ and $\\mathbf{Q}$ exactly as described above.\n- Case $1$ (general mixed state):\n  - $E = 210 \\times 10^9$, $\\nu = 0.30$, $\\eta = 0.05$, $c_h^{\\text{base}} = 0.15$.\n  - Displacements are a superposition of a linear field and hourglass content:\n    - Linear field defined by $u_{x,i} = a_0 + a_1 \\xi_i + a_2 \\eta_i + a_3 \\zeta_i$, with $(a_0,a_1,a_2,a_3) = (0, 1.0\\times 10^{-3}, 2.0\\times 10^{-3}, -1.0\\times 10^{-3})$;\n      $u_{y,i} = b_0 + b_1 \\xi_i + b_2 \\eta_i + b_3 \\zeta_i$, with $(b_0,b_1,b_2,b_3) = (0, -0.5\\times 10^{-3}, 1.0\\times 10^{-3}, 0.5\\times 10^{-3})$;\n      $u_{z,i} = c_0 + c_1 \\xi_i + c_2 \\eta_i + c_3 \\zeta_i$, with $(c_0,c_1,c_2,c_3) = (0, 0.8\\times 10^{-3}, -1.2\\times 10^{-3}, 0.3\\times 10^{-3})$.\n    - Add hourglass components: add $2.0\\times 10^{-4} \\times \\mathbf{H}_1$ to $u_x$, $1.0\\times 10^{-4} \\times \\mathbf{H}_2$ to $u_y$, and $1.5\\times 10^{-4} \\times \\mathbf{H}_3$ to $u_z$.\n- Case $2$ (dominant hourglass, low elastic energy):\n  - $E = 70 \\times 10^9$, $\\nu = 0.33$, $\\eta = 0.02$, $c_h^{\\text{base}} = 0.10$.\n  - Displacements are purely hourglass: $u_x = 1.0\\times 10^{-3} \\times \\mathbf{H}_4$, $u_y = 1.0\\times 10^{-3} \\times \\mathbf{H}_4$, $u_z = 0.5\\times 10^{-3} \\times \\mathbf{H}_4$.\n- Case $3$ (pure linear field, no hourglass activation):\n  - $E = 100 \\times 10^9$, $\\nu = 0.25$, $\\eta = 0.10$, $c_h^{\\text{base}} = 0.20$.\n  - Displacements are purely linear with $(a_0,a_1,a_2,a_3) = (0, 0.5\\times 10^{-3}, -0.8\\times 10^{-3}, 0.6\\times 10^{-3})$, $(b_0,b_1,b_2,b_3) = (0, -0.3\\times 10^{-3}, 0.7\\times 10^{-3}, -0.2\\times 10^{-3})$, $(c_0,c_1,c_2,c_3) = (0, 0.4\\times 10^{-3}, 0.1\\times 10^{-3}, -0.5\\times 10^{-3})$.\n- Case $4$ (rigid translation):\n  - $E = 100 \\times 10^9$, $\\nu = 0.25$, $\\eta = 0.10$, $c_h^{\\text{base}} = 0.20$.\n  - Displacements are constant: $u_{x,i} = u_{y,i} = u_{z,i} = 1.0\\times 10^{-3}$ for all nodes $i$.\n\nFinal output format requirement:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, for example, $[c_{h,1},c_{h,2},c_{h,3},c_{h,4}]$.", "solution": "The problem requires the derivation and implementation of an adaptive rule for the dimensionless hourglass coefficient, denoted as $c_h$, for an eight-node trilinear hexahedral finite element using one-point integration. The rule must ensure that the ratio of the hourglass energy, $W_h$, to the elastic strain energy, $W_e$, remains bounded by a prescribed tolerance, $\\eta$.\n\nThe derivation proceeds from the fundamental principles and definitions provided.\n\nThe elastic strain energy for the element is given by:\n$$ W_e = \\frac{1}{2} \\boldsymbol{\\varepsilon}^\\mathsf{T} \\mathbf{C} \\, \\boldsymbol{\\varepsilon} \\, V $$\nwhere $\\boldsymbol{\\varepsilon} \\in \\mathbb{R}^6$ is the strain vector in Voigt notation, $\\mathbf{C} \\in \\mathbb{R}^{6 \\times 6}$ is the symmetric, positive-definite material stiffness matrix, and $V$ is the element volume. The strain $\\boldsymbol{\\varepsilon}$ is linearly related to the nodal displacement vector $\\mathbf{u} \\in \\mathbb{R}^{24}$ through the strain-displacement matrix $\\mathbf{B} \\in \\mathbb{R}^{6 \\times 24}$ as $\\boldsymbol{\\varepsilon} = \\mathbf{B} \\mathbf{u}$.\n\nThe hourglass stabilization energy is modeled as:\n$$ W_h = \\frac{1}{2} k_h \\, \\| \\mathbf{q} \\|^2 $$\nwhere $\\mathbf{q} \\in \\mathbb{R}^{12}$ is the vector of hourglass mode amplitudes, and $k_h$ is the scalar hourglass stiffness. The hourglass amplitudes are extracted from the nodal displacements via the operator $\\mathbf{Q} \\in \\mathbb{R}^{12 \\times 24}$, such that $\\mathbf{q} = \\mathbf{Q} \\mathbf{u}$. The hourglass stiffness $k_h$ is defined in terms of the dimensionless coefficient $c_h$, the material shear modulus $G$, and the element volume $V$:\n$$ k_h = c_h \\, G \\, V $$\n\nThe core objective is to maintain the following inequality:\n$$ \\frac{W_h}{W_e} \\le \\eta $$\nwhere $\\eta > 0$ is a non-dimensional tolerance.\n\nSubstituting the expressions for $W_h$ and $W_e$ into this inequality, we obtain:\n$$ \\frac{\\frac{1}{2} k_h \\, \\| \\mathbf{q} \\|^2}{\\frac{1}{2} \\boldsymbol{\\varepsilon}^\\mathsf{T} \\mathbf{C} \\, \\boldsymbol{\\varepsilon} \\, V} \\le \\eta $$\nSubstituting the expression for $k_h$ yields:\n$$ \\frac{\\frac{1}{2} (c_h \\, G \\, V) \\, \\| \\mathbf{q} \\|^2}{\\frac{1}{2} \\boldsymbol{\\varepsilon}^\\mathsf{T} \\mathbf{C} \\, \\boldsymbol{\\varepsilon} \\, V} \\le \\eta $$\nAssuming the element volume $V$ is non-zero, the terms $\\frac{1}{2}$ and $V$ cancel from the numerator and denominator, simplifying the expression to:\n$$ \\frac{c_h \\, G \\, \\| \\mathbf{q} \\|^2}{\\boldsymbol{\\varepsilon}^\\mathsf{T} \\mathbf{C} \\, \\boldsymbol{\\varepsilon}} \\le \\eta $$\n\nTo determine the value of $c_h$ that meets this criterion, we consider the boundary case where the ratio is exactly equal to $\\eta$. We can then solve for a target value, $c_h^{\\text{target}}$. This is only meaningful if the denominator terms are non-zero, specifically, if the element is undergoing some hourglass deformation ($\\| \\mathbf{q} \\|^2 > 0$) and possesses non-zero strain energy ($W_e > 0$, which implies $\\boldsymbol{\\varepsilon}^\\mathsf{T} \\mathbf{C} \\, \\boldsymbol{\\varepsilon} > 0$).\n$$ c_h \\, G \\, \\| \\mathbf{q} \\|^2 = \\eta \\, (\\boldsymbol{\\varepsilon}^\\mathsf{T} \\mathbf{C} \\, \\boldsymbol{\\varepsilon}) $$\nSolving for $c_h$ gives the target coefficient:\n$$ c_h^{\\text{target}} = \\eta \\frac{\\boldsymbol{\\varepsilon}^\\mathsf{T} \\mathbf{C} \\, \\boldsymbol{\\varepsilon}}{G \\, \\| \\mathbf{q} \\|^2} $$\n\nThe problem specifies a complete adaptive rule incorporating this derivation along with handling for degenerate cases:\n1.  **If $\\| \\mathbf{q} \\|^2 = 0$:** This indicates no hourglassing is present. The hourglass energy $W_h$ is zero regardless of $c_h$. In this case, there is no need for adaptive control, and a predefined baseline value $c_h^{\\text{base}}$ is used. So, $c_h = c_h^{\\text{base}}$.\n2.  **Else if $W_e = 0$ and $\\| \\mathbf{q} \\|^2 > 0$:** This corresponds to a pure hourglass mode, which, by definition, produces zero strain at the element's integration point. The numerator of the expression for $c_h^{\\text{target}}$ is zero, yielding $c_h^{\\text{target}} = 0$. The rule specifies setting $c_h = 0$. This prevents the addition of stabilization energy that would cause the ratio $W_h/W_e$ to become infinite.\n3.  **Else (General Case where $W_e > 0$ and $\\| \\mathbf{q} \\|^2 > 0$):** The derived target value $c_h^{\\text{target}}$ makes the energy ratio exactly equal to $\\eta$. To ensure the ratio is at most $\\eta$, any $c_h \\le c_h^{\\text{target}}$ is valid. To prevent the coefficient from becoming excessively large (which can cause numerical locking), it is capped at the baseline value. Thus, the rule is to choose the minimum of the two:\n    $$ c_h = \\min(c_h^{\\text{base}}, c_h^{\\text{target}}) $$\n\nAll mathematical entities in this text, such as symbols ($c_h$, $\\eta$), matrices ($\\mathbf{B}$), vectors ($\\mathbf{u}$), numbers ($8$, $24$), and equations, are rendered in LaTeX as required.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_ch(E, nu, eta, c_h_base, u_params):\n    \"\"\"\n    Computes the adaptive hourglass coefficient c_h for a single test case.\n    \"\"\"\n    # 1. Define Element Geometry and Kinematics\n    V = 1.0\n    # Natural coordinates for nodes 0-7\n    coords = np.array([\n        [-1, -1, -1], [1, -1, -1], [1, 1, -1], [-1, 1, -1],\n        [-1, -1, 1], [1, -1, 1], [1, 1, 1], [-1, 1, 1]\n    ])\n    \n    # Flanagan-Belytschko hourglass vectors\n    H_vectors = np.array([\n        [1, -1, 1, -1, -1, 1, -1, 1],\n        [1, 1, -1, -1, -1, -1, 1, 1],\n        [1, -1, -1, 1, -1, 1, 1, -1],\n        [1, 1, 1, 1, -1, -1, -1, -1]\n    ])\n    \n    # 2. Material Properties and Stiffness Matrix (C)\n    lam = (E * nu) / ((1 + nu) * (1 - 2 * nu))\n    G = E / (2 * (1 + nu))\n    \n    C = np.zeros((6, 6))\n    C[0, 0] = C[1, 1] = C[2, 2] = lam + 2 * G\n    C[0, 1] = C[0, 2] = C[1, 0] = C[1, 2] = C[2, 0] = C[2, 1] = lam\n    C[3, 3] = C[4, 4] = C[5, 5] = G\n    \n    # 3. Construct Strain-Displacement Matrix (B)\n    B = np.zeros((6, 24))\n    for i in range(8):\n        xi, yi, zi = coords[i]\n        dNi_dx = xi / 4.0\n        dNi_dy = yi / 4.0\n        dNi_dz = zi / 4.0\n        \n        # B_i block for node i\n        B_i = np.array([\n            [dNi_dx, 0, 0],\n            [0, dNi_dy, 0],\n            [0, 0, dNi_dz],\n            [dNi_dy, dNi_dx, 0],\n            [0, dNi_dz, dNi_dy],\n            [dNi_dz, 0, dNi_dx]\n        ])\n        \n        B[:, 3*i:3*i+3] = B_i\n\n    # 4. Construct Hourglass Extraction Matrix (Q)\n    Q = np.zeros((12, 24))\n    for alpha in range(4):  # Loop over H vectors\n        for c in range(3):  # Loop over components x, y, z\n            row = 3 * alpha + c\n            for i in range(8): # Loop over nodes\n                col = 3 * i + c\n                Q[row, col] = H_vectors[alpha, i]\n                \n    # 5. Construct Nodal Displacement Vector (u)\n    u = np.zeros(24)\n    if 'linear' in u_params:\n        ax, ay, az = u_params['linear']\n        for i in range(8):\n            xi, yi, zi = coords[i]\n            u[3*i + 0] = ax[0] + ax[1]*xi + ax[2]*yi + ax[3]*zi\n            u[3*i + 1] = ay[0] + ay[1]*xi + ay[2]*yi + ay[3]*zi\n            u[3*i + 2] = az[0] + az[1]*xi + az[2]*yi + az[3]*zi\n            \n    if 'hg' in u_params:\n        h_comps = u_params['hg']\n        for comp_idx, val, h_idx in h_comps: # (component, value, H_vector_index)\n            for i in range(8):\n                u[3*i + comp_idx] += val * H_vectors[h_idx-1, i]\n\n    if 'const' in u_params:\n        u[:] = u_params['const']\n\n    # 6. Calculate Key Quantities and Apply Adaptive Rule\n    q = Q @ u\n    q_norm_sq = np.dot(q, q)\n    \n    # Check for near-zero hourglass norm\n    if q_norm_sq < 1e-30:\n        return c_h_base\n        \n    epsilon = B @ u\n    strain_energy_density_term = epsilon.T @ C @ epsilon\n    \n    We = 0.5 * strain_energy_density_term * V\n    \n    # Check for near-zero elastic energy\n    if We < 1e-20:\n        return 0.0\n        \n    # General case\n    c_h_target = eta * strain_energy_density_term / (G * q_norm_sq)\n    \n    return min(c_h_base, c_h_target)\n\ndef solve():\n    # Test cases defined in the problem statement\n    test_cases = [\n        {\n            \"E\": 210e9, \"nu\": 0.30, \"eta\": 0.05, \"c_h_base\": 0.15,\n            \"u_params\": {\n                \"linear\": [\n                    (0, 1.0e-3, 2.0e-3, -1.0e-3),\n                    (0, -0.5e-3, 1.0e-3, 0.5e-3),\n                    (0, 0.8e-3, -1.2e-3, 0.3e-3)\n                ],\n                \"hg\": [\n                    (0, 2.0e-4, 1), # u_x component, value, H1\n                    (1, 1.0e-4, 2), # u_y component, value, H2\n                    (2, 1.5e-4, 3)  # u_z component, value, H3\n                ]\n            }\n        },\n        {\n            \"E\": 70e9, \"nu\": 0.33, \"eta\": 0.02, \"c_h_base\": 0.10,\n            \"u_params\": {\n                \"hg\": [\n                    (0, 1.0e-3, 4),\n                    (1, 1.0e-3, 4),\n                    (2, 0.5e-3, 4)\n                ]\n            }\n        },\n        {\n            \"E\": 100e9, \"nu\": 0.25, \"eta\": 0.10, \"c_h_base\": 0.20,\n            \"u_params\": {\n                \"linear\": [\n                    (0, 0.5e-3, -0.8e-3, 0.6e-3),\n                    (0, -0.3e-3, 0.7e-3, -0.2e-3),\n                    (0, 0.4e-3, 0.1e-3, -0.5e-3)\n                ]\n            }\n        },\n        {\n            \"E\": 100e9, \"nu\": 0.25, \"eta\": 0.10, \"c_h_base\": 0.20,\n            \"u_params\": {\n                \"const\": 1.0e-3\n            }\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        c_h = calculate_ch(case[\"E\"], case[\"nu\"], case[\"eta\"], case[\"c_h_base\"], case[\"u_params\"])\n        results.append(c_h)\n\n    print(f\"[{','.join(f'{r:.8f}' for r in results)}]\")\n\nsolve()\n```", "id": "3571380"}]}