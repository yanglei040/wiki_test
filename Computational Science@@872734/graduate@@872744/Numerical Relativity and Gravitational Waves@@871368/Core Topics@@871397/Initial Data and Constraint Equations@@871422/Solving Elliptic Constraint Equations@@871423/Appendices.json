{"hands_on_practices": [{"introduction": "The momentum constraint is a key part of the initial value problem in general relativity. This analytical exercise explores how the constraint equation transforms under a conformal decomposition and simplifies in a vacuum, constant mean curvature setting, revealing a fundamental elliptic structure for the vector potential $W^i$. By working through the derivation and applying uniqueness theorems for harmonic functions [@problem_id:3486526], you will gain a deep, first-principles understanding of how boundary conditions ensure a well-posed physical problem.", "problem": "Consider vacuum Cauchy initial data in the $3+1$ decomposition of General Relativity, where the momentum constraint is given by $D_{j}(K^{ij}-g^{ij}K)=0$. Adopt the conformal transverse-traceless decomposition with $g_{ij}=\\psi^{4}\\tilde{g}_{ij}$, $K=\\text{const}$, and the trace-free part of the extrinsic curvature decomposed as $A^{ij}=\\psi^{-10}(\\tilde{A}_{\\mathrm{TT}}^{ij}+(\\tilde{\\mathbb{L}}W)^{ij})$, where $\\tilde{A}_{\\mathrm{TT}}^{ij}$ is a prescribed transverse-traceless (TT) tensor with respect to the conformal metric $\\tilde{g}_{ij}$ and $(\\tilde{\\mathbb{L}}W)^{ij}$ is the conformal Killing operator acting on a vector field $W^{i}$, defined by $(\\tilde{\\mathbb{L}}W)^{ij}=\\tilde{D}^{i}W^{j}+\\tilde{D}^{j}W^{i}-\\tfrac{2}{3}\\tilde{g}^{ij}\\tilde{D}_{k}W^{k}$. Assume a conformally flat background, $\\tilde{g}_{ij}=\\delta_{ij}$, on the manifold $\\mathbb{R}^{3}$ with asymptotically Euclidean falloff, $\\tilde{A}_{\\mathrm{TT}}^{ij}=\\mathcal{O}(r^{-3})$ and $W^{i}=\\mathcal{O}(r^{-1})$ as $r\\to\\infty$, where $r$ is the Euclidean radius. Starting from the momentum constraint and the fundamental definitions above, derive the elliptic system that $W^{i}$ must satisfy in this setting, solve it under the stated boundary conditions, and justify uniqueness of $W^{i}$ modulo conformal Killing vectors (CKVs) of $\\tilde{g}_{ij}$. Express the final answer for the three components of the solution $W^{i}$ as a single row matrix. No rounding is required, and no physical units are involved in this problem.", "solution": "The problem requires us to derive and solve the elliptic system for the vector field $W^i$ which is part of the conformal transverse-traceless decomposition of the extrinsic curvature in vacuum General Relativity under the assumption of a constant mean curvature ($K=\\text{const}$) slice.\n\nThe starting point is the momentum constraint equation for vacuum spacetimes:\n$$\nD_{j}(K^{ij}-g^{ij}K)=0\n$$\nwhere $D_j$ is the covariant derivative compatible with the spatial metric $g_{ij}$, $K^{ij}$ is the extrinsic curvature tensor, and $K = g_{ij}K^{ij}$ is its trace.\n\nWe decompose the extrinsic curvature into its trace-free part $A^{ij}$ and its trace part:\n$$\nK^{ij} = A^{ij} + \\frac{1}{3}g^{ij}K\n$$\nSubstituting this into the momentum constraint gives:\n$$\nD_{j}(A^{ij} + \\frac{1}{3}g^{ij}K - g^{ij}K) = D_{j}(A^{ij} - \\frac{2}{3}g^{ij}K) = 0\n$$\nExpanding the divergence:\n$$\nD_{j}A^{ij} - \\frac{2}{3}D_{j}(g^{ij}K) = 0\n$$\n$$\nD_{j}A^{ij} - \\frac{2}{3}(K D_{j}g^{ij} + g^{ij}D_{j}K) = 0\n$$\nDue to metric compatibility, $D_{j}g^{ij}=0$. The problem states that $K=\\text{const}$, which implies its covariant derivative is zero, $D_j K = \\partial_j K = 0$. Thus, the momentum constraint simplifies significantly to:\n$$\nD_{j}A^{ij} = 0\n$$\nNext, we apply the conformal decomposition. The spatial metric is $g_{ij} = \\psi^4 \\tilde{g}_{ij}$, which implies the inverse metric is $g^{ij} = \\psi^{-4} \\tilde{g}^{ij}$. The trace-free part of the extrinsic curvature is given by $A^{ij}=\\psi^{-10}\\tilde{A}^{ij}$, where $\\tilde{A}^{ij} = \\tilde{A}_{\\mathrm{TT}}^{ij}+(\\tilde{\\mathbb{L}}W)^{ij}$. The tensor $\\tilde{A}^{ij}$ is trace-free with respect to the conformal metric $\\tilde{g}_{ij}$, i.e., $\\tilde{g}_{ij}\\tilde{A}^{ij}=0$.\n\nWe need to relate the physical divergence $D_j A^{ij}$ to the divergence with respect to the conformal metric, $\\tilde{D}_j \\tilde{A}^{ij}$. The standard transformation law for the covariant divergence of a conformally scaled, symmetric, trace-free, rank-2 contravariant tensor density of weight -10 is:\n$$\nD_j A^{ij} = \\psi^{-10} \\tilde{D}_j \\tilde{A}^{ij}\n$$\nThus, the momentum constraint $D_j A^{ij} = 0$ is equivalent to $\\tilde{D}_j \\tilde{A}^{ij} = 0$.\nWe now substitute the decomposition $\\tilde{A}^{ij} = \\tilde{A}_{\\mathrm{TT}}^{ij} + (\\tilde{\\mathbb{L}}W)^{ij}$:\n$$\n\\tilde{D}_j (\\tilde{A}_{\\mathrm{TT}}^{ij} + (\\tilde{\\mathbb{L}}W)^{ij}) = 0\n$$\nBy definition, a transverse-traceless tensor $\\tilde{A}_{\\mathrm{TT}}^{ij}$ is divergence-free with respect to the conformal metric, i.e., $\\tilde{D}_j \\tilde{A}_{\\mathrm{TT}}^{ij} = 0$. This leaves us with an elliptic equation for the vector field $W^i$:\n$$\n\\tilde{D}_j (\\tilde{\\mathbb{L}}W)^{ij} = 0\n$$\nThe problem specifies a conformally flat background on $\\mathbb{R}^3$, so $\\tilde{g}_{ij}=\\delta_{ij}$. In this case, the conformal covariant derivative $\\tilde{D}_j$ becomes the ordinary partial derivative $\\partial_j$. The conformal Killing operator becomes:\n$$\n(\\tilde{\\mathbb{L}}W)^{ij} = \\partial^{i}W^{j}+\\partial^{j}W^{i}-\\frac{2}{3}\\delta^{ij}\\partial_{k}W^{k}\n$$\nThe equation for $W^i$ is $\\partial_j (\\tilde{\\mathbb{L}}W)^{ij} = 0$. Let's expand this:\n$$\n\\partial_j \\left(\\partial^{i}W^{j}+\\partial^{j}W^{i}-\\frac{2}{3}\\delta^{ij}\\partial_{k}W^{k}\\right) = 0\n$$\n$$\n\\partial^i(\\partial_j W^j) + \\partial_j\\partial^j W^i - \\frac{2}{3}\\partial^i(\\partial_k W^k) = 0\n$$\nUsing vector notation where $\\vec{\\nabla}\\cdot\\vec{W} = \\partial_j W^j$ is the divergence and $\\nabla^2 = \\partial_j \\partial^j$ is the Laplacian, this equation for the $i$-th component of $\\vec{W}$ is:\n$$\n\\nabla^2 W^i + \\frac{1}{3} \\partial^i (\\partial_j W^j) = 0\n$$\nThis is the elliptic system that $W^i$ must satisfy. To solve it, we take its divergence by applying $\\partial_i$:\n$$\n\\partial_i(\\nabla^2 W^i) + \\partial_i\\left(\\frac{1}{3} \\partial^i (\\partial_j W^j)\\right) = 0\n$$\n$$\n\\nabla^2 (\\partial_i W^i) + \\frac{1}{3} \\nabla^2 (\\partial_j W^j) = 0\n$$\nLet $\\theta = \\partial_j W^j$. The equation becomes $\\frac{4}{3}\\nabla^2\\theta=0$, which implies $\\nabla^2\\theta=0$. So, the divergence of $\\vec{W}$ is a harmonic function on $\\mathbb{R}^3$.\nThe boundary condition on $W^i$ is $W^i = \\mathcal{O}(r^{-1})$ as $r \\to \\infty$. This implies that its derivatives fall off faster: $\\partial_j W^i = \\mathcal{O}(r^{-2})$. Therefore, $\\theta = \\partial_j W^j = \\mathcal{O}(r^{-2})$. A harmonic function on $\\mathbb{R}^3$ that vanishes at infinity (which $\\mathcal{O}(r^{-2})$ does) must be identically zero. Thus, $\\theta = \\partial_j W^j = 0$.\n\nSubstituting $\\partial_j W^j = 0$ back into the elliptic system for $W^i$, we get:\n$$\n\\nabla^2 W^i = 0\n$$\nEach component $W^i$ must be a harmonic function on $\\mathbb{R}^3$. The boundary condition is $W^i = \\mathcal{O}(r^{-1})$, which implies $\\lim_{r\\to\\infty} W^i(x) = 0$. By a standard theorem of potential theory (a corollary of Liouville's theorem for harmonic functions), any harmonic function on all of $\\mathbb{R}^n$ ($n\\geq 2$) which falls off like $\\mathcal{O}(r^{2-n})$ must be identically zero. For $n=3$, this condition is $\\mathcal{O}(r^{-1})$.\nTherefore, the unique solution satisfying the given conditions is $W^i = 0$ for $i=1, 2, 3$.\n\nThe problem mentions uniqueness modulo conformal Killing vectors (CKVs). A vector field $X^i$ is a CKV of $\\tilde{g}_{ij}$ if its conformal Killing operator vanishes, $(\\tilde{\\mathbb{L}}X)^{ij}=0$. If $W^i$ is a solution to $\\tilde{D}_j(\\tilde{\\mathbb{L}}W)^{ij}=0$, then $W^i+X^i$ is also a solution. This constitutes the ambiguity. However, the solution must satisfy the boundary condition $W^i = \\mathcal{O}(r^{-1})$. If two solutions $W_1^i$ and $W_2^i$ satisfy this condition, their difference $\\delta W^i = W_1^i - W_2^i$ must also satisfy it, so $\\delta W^i=\\mathcal{O}(r^{-1})$. This difference must be a CKV. The CKVs of flat space $\\mathbb{R}^3$ are translations ($X^i=c^i$), rotations ($X^i=\\omega^i_j x^j$), dilatations ($X^i=cx^i$), and special conformal transformations ($X^i=b^i r^2 - 2x^i(b\\cdot x)$). None of these non-trivial CKVs fall off at infinity. The only CKV that satisfies the $\\mathcal{O}(r^{-1})$ falloff condition is the trivial one, $X^i=0$. Therefore, the boundary condition fixes the solution uniquely, removing any ambiguity from CKVs. The solution is $W^i=0$.\n\nThe three components of the solution vector $W^i$ are $(W^1, W^2, W^3) = (0, 0, 0)$.", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n0 & 0 & 0\n\\end{pmatrix}\n}\n$$", "id": "3486526"}, {"introduction": "Numerically constructing black hole initial data involves solving the constraint equations on a domain with an inner boundary representing an apparent horizon (AH). This practice [@problem_id:3486554] guides you through implementing a finite-difference solver for a simplified model that captures this essential feature, focusing on the physically motivated Robin and Neumann boundary conditions at the AH. This task provides critical hands-on experience with the numerical techniques and verification methods used in modern black hole simulations.", "problem": "You are to design and implement a program that numerically solves a simplified model of the elliptic constraint equations encountered in General Relativity (GR) initial data construction for black holes under quasi-equilibrium conditions and mixed inner boundary conditions at apparent horizons. The target mathematical model is strictly one-dimensional, spherically symmetric, and dimensionless, with all quantities treated as pure numbers without units.\n\nStart from the conformal decomposition of the spatial metric and the vacuum Hamiltonian constraint and momentum constraint, invoking a time-symmetric initial slice and spherical symmetry. Use the following foundational facts as your base: (i) in a time-symmetric vacuum slice, the extrinsic curvature vanishes, and the vacuum Hamiltonian constraint reduces to a homogeneous linear elliptic equation for the conformal factor, and (ii) in spherical symmetry, the flat-space Laplacian acting on a radially dependent scalar reduces to a radial operator. Avoid assuming any pre-derived discretization expressions or solution formulas; your derivation must follow from these principles.\n\nConsider a spherical shell domain with radius $r \\in [R_{\\mathrm{h}}, R_{\\max}]$, where $R_{\\mathrm{h}} > 0$ is a prescribed inner boundary representing an Apparent Horizon (AH), and $R_{\\max} > R_{\\mathrm{h}}$ is a finite outer boundary approximating spatial infinity. Let $\\psi(r)$ denote the conformal factor and $\\beta^r(r)$ the radial component of the shift vector. Assume a conformally flat background and time symmetry, so that the vacuum Hamiltonian constraint reduces to a homogeneous elliptic equation for $\\psi(r)$, and assume a homogeneous elliptic equation for $\\beta^r(r)$ in spherical symmetry consistent with the vanishing of sources and torques in a non-rotating, spherically symmetric quasi-equilibrium configuration.\n\nImpose the following boundary conditions:\n- Inner boundary at $r = R_{\\mathrm{h}}$:\n  - For the conformal factor $\\psi(r)$, enforce a quasi-equilibrium Apparent Horizon (AH) condition in the form of a Robin boundary condition consistent with an isolated isometry throat in spherical symmetry: $r \\,\\partial_r \\psi + \\psi = 0$ at $r = R_{\\mathrm{h}}$.\n  - For the shift component $\\beta^r(r)$, enforce a Neumann condition that represents no normal coordinate motion of the AH: $\\partial_r \\beta^r = 0$ at $r = R_{\\mathrm{h}}$.\n- Outer boundary at $r = R_{\\max}$:\n  - Asymptotic flatness for the conformal factor: $\\psi(R_{\\max}) = 1$.\n  - Vanishing shift in an inertial frame: $\\beta^r(R_{\\max}) = 0$.\n\nTasks:\n1. Derive, from the divergence form of the Laplacian in spherical symmetry, the one-dimensional operator that acts on any radially dependent function $u(r)$, and write the homogeneous elliptic equations satisfied by $\\psi(r)$ and $\\beta^r(r)$ in the domain $r \\in (R_{\\mathrm{h}}, R_{\\max})$.\n2. Derive a second-order finite difference scheme on a uniform grid of $N+1$ nodes, with $N \\in \\mathbb{N}$, covering the interval $[R_{\\mathrm{h}}, R_{\\max}]$. Ensure that your interior stencil is second-order accurate and that you consistently and stably enforce the mixed inner boundary conditions (Robin for $\\psi$, Neumann for $\\beta^r$) and the outer Dirichlet conditions (for both fields). Your implementation must assemble and solve the resulting linear systems for $\\psi$ and $\\beta^r$.\n3. For $\\psi(r)$, derive the analytic solution in spherical symmetry to the corresponding homogeneous elliptic equation with the given mixed boundary conditions. Use this analytic solution as a reference to quantify a maximum-norm relative error across the grid.\n4. Define the following diagnostic measures to evaluate quasi-equilibrium enforcement and solution quality:\n   - $E_{\\psi}^{\\infty}$: the maximum relative error of $\\psi$ with respect to the derived analytic solution over all grid nodes, computed as the maximum over $i$ of $\\left|\\psi_{\\mathrm{num}}(r_i) - \\psi_{\\mathrm{ref}}(r_i)\\right|$ divided by the maximum over $i$ of $\\left|\\psi_{\\mathrm{ref}}(r_i)\\right|$.\n   - $R_{\\psi}^{\\infty}$: the maximum absolute value over interior nodes of the discrete elliptic operator applied to $\\psi_{\\mathrm{num}}$, i.e., the discrete residual in the interior.\n   - $B_{\\psi}$: the absolute value of the discrete inner boundary residual $R_{\\mathrm{h}} \\,(\\partial_r \\psi)_{\\mathrm{disc}} + \\psi$ evaluated at $r = R_{\\mathrm{h}}$.\n   - $R_{\\beta}^{\\infty}$: the maximum absolute value over interior nodes of the discrete elliptic operator applied to $\\beta^r_{\\mathrm{num}}$.\n   - $B_{\\beta}$: the absolute value of the discrete inner boundary residual $(\\partial_r \\beta^r)_{\\mathrm{disc}}$ evaluated at $r = R_{\\mathrm{h}}$.\n5. For each test case below, compute a single scalar quality score $q$ defined by $q = \\max\\{ E_{\\psi}^{\\infty}, R_{\\psi}^{\\infty}, B_{\\psi}, R_{\\beta}^{\\infty}, B_{\\beta} \\}$. Your program must output these quality scores for the specified test suite as a single line.\n\nAll computations are dimensionless. Angles do not appear. Express all final numerical outputs as floating-point numbers without units.\n\nTest suite:\n- Case $1$: $R_{\\mathrm{h}} = 2$, $R_{\\max} = 10$, $N = 200$.\n- Case $2$: $R_{\\mathrm{h}} = 2$, $R_{\\max} = 10$, $N = 40$.\n- Case $3$: $R_{\\mathrm{h}} = 9$, $R_{\\max} = 10$, $N = 200$.\n- Case $4$: $R_{\\mathrm{h}} = 0.5$, $R_{\\max} = 5$, $N = 200$.\n\nFinal output format requirement:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of the test cases, i.e., $[q_1, q_2, q_3, q_4]$.\n\nYour submission must be a complete, runnable program that implements the above, without requiring any user input or external files, and must strictly follow the final output format.", "solution": "The user has provided a valid, well-posed problem in computational physics, specifically concerning the numerical solution of simplified elliptic constraint equations in general relativity. The problem is scientifically grounded, objective, and contains all necessary information to proceed with a unique solution.\n\n### 1. Governing Equations and Analytic Solutions\n\nThe problem requires solving homogeneous elliptic equations for the conformal factor $\\psi(r)$ and the radial shift vector component $\\beta^r(r)$ in a spherically symmetric, one-dimensional domain $r \\in [R_{\\mathrm{h}}, R_{\\max}]$. The appropriate operator is the Laplacian in spherical coordinates acting on a purely radial function $u(r)$. Starting from the divergence form, $\\nabla^2 u = \\vec{\\nabla} \\cdot (\\vec{\\nabla} u)$, we note that for $u(r)$, the gradient is $\\vec{\\nabla} u = \\frac{du}{dr} \\hat{r}$. The divergence of this vector field is $\\vec{\\nabla} \\cdot (\\frac{du}{dr} \\hat{r}) = \\frac{1}{r^2} \\frac{d}{dr}(r^2 \\frac{du}{dr})$. Expanding this gives the operator:\n$$\n\\nabla^2 u(r) = \\frac{d^2 u}{dr^2} + \\frac{2}{r} \\frac{du}{dr}\n$$\nThe governing equations for both fields are instances of Laplace's equation, $\\nabla^2 u = 0$:\n$$\n\\frac{d^2 \\psi}{dr^2} + \\frac{2}{r} \\frac{d \\psi}{dr} = 0\n$$\n$$\n\\frac{d^2 \\beta^r}{dr^2} + \\frac{2}{r} \\frac{d \\beta^r}{dr} = 0\n$$\nThese are Cauchy-Euler ordinary differential equations. The general solution is of the form $u(r) = A + B/r$, where $A$ and $B$ are constants determined by boundary conditions.\n\n**Analytic Solution for $\\psi(r)$:**\nThe boundary conditions are $\\psi(R_{\\max}) = 1$ and the Robin condition $r \\frac{d\\psi}{dr} + \\psi = 0$ at $r=R_{\\mathrm{h}}$.\nApplying the Robin condition to the general form $\\psi(r) = A + B/r$ (with derivative $\\frac{d\\psi}{dr} = -B/r^2$):\n$$\nR_{\\mathrm{h}} \\left(-\\frac{B}{R_{\\mathrm{h}}^2}\\right) + \\left(A + \\frac{B}{R_{\\mathrm{h}}}\\right) = 0 \\implies -\\frac{B}{R_{\\mathrm{h}}} + A + \\frac{B}{R_{\\mathrm{h}}} = 0 \\implies A = 0\n$$\nThe solution must be of the form $\\psi(r) = B/r$. Applying the outer Dirichlet condition:\n$$\n\\psi(R_{\\max}) = \\frac{B}{R_{\\max}} = 1 \\implies B = R_{\\max}\n$$\nThus, the analytic reference solution is $\\psi_{\\mathrm{ref}}(r) = R_{\\max}/r$.\n\n**Analytic Solution for $\\beta^r(r)$:**\nThe boundary conditions are $\\beta^r(R_{\\max}) = 0$ and the Neumann condition $\\frac{d\\beta^r}{dr} = 0$ at $r=R_{\\mathrm{h}}$.\nApplying the Neumann condition to the general form $\\beta^r(r) = C + D/r$:\n$$\n\\frac{d\\beta^r}{dr}\\bigg|_{r=R_{\\mathrm{h}}} = -\\frac{D}{R_{\\mathrm{h}}^2} = 0 \\implies D = 0\n$$\nThe solution must be of the form $\\beta^r(r) = C$. Applying the outer Dirichlet condition:\n$$\n\\beta^r(R_{\\max}) = C = 0 \\implies C = 0\n$$\nThus, the analytic solution is the trivial solution $\\beta^r(r) = 0$.\n\n### 2. Finite Difference Discretization\nWe discretize the domain $[R_{\\mathrm{h}}, R_{\\max}]$ using $N+1$ uniformly spaced nodes $r_i = R_{\\mathrm{h}} + i \\cdot \\Delta r$ for $i=0, 1, \\dots, N$, where the grid spacing is $\\Delta r = (R_{\\max} - R_{\\mathrm{h}})/N$. Let $u_i$ denote the numerical approximation of $u(r_i)$.\n\n**Interior Stencil:** For interior nodes $i=1, \\dots, N-1$, we use second-order central differences for the derivatives:\n$$\n\\frac{d u}{d r}\\bigg|_{r_i} \\approx \\frac{u_{i+1} - u_{i-1}}{2\\Delta r}, \\quad \\frac{d^2 u}{d r^2}\\bigg|_{r_i} \\approx \\frac{u_{i+1} - 2u_i + u_{i-1}}{(\\Delta r)^2}\n$$\nSubstituting these into the governing equation $u'' + (2/r)u' = 0$ gives the discrete equation for each interior node:\n$$\n\\left(1 - \\frac{\\Delta r}{r_i}\\right)u_{i-1} - 2u_i + \\left(1 + \\frac{\\Delta r}{r_i}\\right)u_{i+1} = 0\n$$\n\n**Boundary Conditions:**\nThe unknowns are the values $u_0, u_1, \\dots, u_{N-1}$. The value $u_N$ is fixed by the outer boundary condition. This results in a linear system of $N$ equations for $N$ unknowns.\n\n- **Outer Boundary ($r_N = R_{\\max}$):** The Dirichlet conditions are enforced exactly:\n  - $\\psi_N = 1$\n  - $\\beta^r_N = 0$\n  These values are not unknowns; they are incorporated into the right-hand side of the linear system for the equation at node $i=N-1$.\n\n- **Inner Boundary for $\\psi$ ($r_0 = R_{\\mathrm{h}}$):** The Robin condition $r\\psi' + \\psi = 0$ is discretized using a second-order accurate one-sided finite difference for the derivative $\\psi'(r_0)$:\n  $$\n  \\psi'(r_0) \\approx \\frac{-3\\psi_0 + 4\\psi_1 - \\psi_2}{2\\Delta r}\n  $$\n  Substituting this into the Robin condition gives the first equation of the linear system for $\\psi$:\n  $$\n  R_{\\mathrm{h}}\\left(\\frac{-3\\psi_0 + 4\\psi_1 - \\psi_2}{2\\Delta r}\\right) + \\psi_0 = 0 \\implies (-3R_{\\mathrm{h}} + 2\\Delta r)\\psi_0 + (4R_{\\mathrm{h}})\\psi_1 - R_{\\mathrm{h}}\\psi_2 = 0\n  $$\n\n- **Inner Boundary for $\\beta^r$ ($r_0 = R_{\\mathrm{h}}$):** The Neumann condition $(\\beta^r)'=0$ is discretized using the ghost point method to maintain second-order accuracy. We introduce a ghost point at $r_{-1} = r_0 - \\Delta r$ and enforce both the boundary condition and the governing PDE at $r_0$.\n  1. Central difference for BC: $\\frac{\\beta^r_1 - \\beta^r_{-1}}{2\\Delta r} = 0 \\implies \\beta^r_{-1} = \\beta^r_1$.\n  2. PDE at $r_0$: $(\\beta^r)'' + \\frac{2}{r_0}(\\beta^r)' = 0$. Using central differences, this relates $\\beta^r_{-1}, \\beta^r_0, \\beta^r_1$.\n  Substituting $\\beta^r_{-1} = \\beta^r_1$ into the discretized PDE at $r_0$ simplifies to:\n  $$\n  \\beta^r_0 - \\beta^r_1 = 0\n  $$\n  This provides the first equation for the $\\beta^r$ system. Although it appears first-order, it arises from a second-order accurate procedure.\n\n### 3. Linear Systems and Diagnostics\n\nFor each field, $\\psi$ and $\\beta^r$, we assemble an $N \\times N$ linear system $A\\mathbf{u} = \\mathbf{b}$, which is then solved for the vector of unknowns $\\mathbf{u} = [u_0, \\dots, u_{N-1}]^T$. The matrices $A$ are nearly tridiagonal.\n\nThe quality of the numerical solutions $\\psi_{\\mathrm{num}}$ and $\\beta^r_{\\mathrm{num}}$ is assessed using five diagnostic measures:\n\n1.  $E_{\\psi}^{\\infty}$: The maximum-norm relative error of $\\psi$, comparing the numerical solution $\\psi_{\\mathrm{num}}$ to the analytic reference $\\psi_{\\mathrm{ref}}(r_i) = R_{\\max}/r_i$.\n    $$\n    E_{\\psi}^{\\infty} = \\frac{\\max_i |\\psi_{\\mathrm{num}}(r_i) - \\psi_{\\mathrm{ref}}(r_i)|}{\\max_i |\\psi_{\\mathrm{ref}}(r_i)|}\n    $$\n2.  $R_{\\psi}^{\\infty}$: The maximum absolute residual of the discrete elliptic operator in the interior of the domain, a measure of how well the numerical solution satisfies the governing equation.\n    $$\n    R_{\\psi}^{\\infty} = \\max_{i=1,\\dots,N-1} \\left| \\frac{1}{(\\Delta r)^2} \\left[ \\left(1 - \\frac{\\Delta r}{r_i}\\right)\\psi_{\\mathrm{num},i-1} - 2\\psi_{\\mathrm{num},i} + \\left(1 + \\frac{\\Delta r}{r_i}\\right)\\psi_{\\mathrm{num},i+1} \\right] \\right|\n    $$\n3.  $B_{\\psi}$: The absolute residual of the Robin boundary condition at the inner boundary, evaluated using a consistent second-order one-sided derivative.\n    $$\n    B_{\\psi} = \\left| R_{\\mathrm{h}} \\left(\\frac{-3\\psi_{\\mathrm{num},0} + 4\\psi_{\\mathrm{num},1} - \\psi_{\\mathrm{num},2}}{2 \\Delta r}\\right) + \\psi_{\\mathrm{num},0} \\right|\n    $$\n4.  $R_{\\beta}^{\\infty}$: The maximum absolute interior residual for $\\beta^r$, analogous to $R_{\\psi}^{\\infty}$.\n5.  $B_{\\beta}$: The absolute residual of the Neumann boundary condition at the inner boundary, evaluated using the same second-order one-sided derivative for consistency.\n    $$\n    B_{\\beta} = \\left| \\frac{-3\\beta^r_{\\mathrm{num},0} + 4\\beta^r_{\\mathrm{num},1} - \\beta^r_{\\mathrm{num},2}}{2 \\Delta r} \\right|\n    $$\nFinally, for each test case, a single quality score $q$ is computed as the maximum of these five diagnostic values:\n$$\nq = \\max\\{ E_{\\psi}^{\\infty}, R_{\\psi}^{\\infty}, B_{\\psi}, R_{\\beta}^{\\infty}, B_{\\beta} \\}\n$$", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve_system_and_get_q(Rh, Rmax, N):\n    \"\"\"\n    Solves the 1D elliptic equations for psi and beta_r and computes the quality score q.\n    \"\"\"\n    # 1. Setup grid\n    delta_r = (Rmax - Rh) / N\n    # r is a grid of N+1 nodes from Rh to Rmax\n    r = np.linspace(Rh, Rmax, N + 1)\n    \n    # 2. Solve for psi\n    # We solve for N unknowns: psi_0 to psi_{N-1}. psi_N is known.\n    # We construct and solve the linear system A_psi * x = b_psi.\n    A_psi = np.zeros((N, N))\n    b_psi = np.zeros(N)\n    \n    psi_N = 1.0\n\n    # The problem constraints ensure N is large enough (>= 40), so N > 2.\n    # Row 0: Inner Robin BC for psi (using 2nd-order one-sided derivative)\n    # (-3*Rh + 2*delta_r)*psi_0 + (4*Rh)*psi_1 - Rh*psi_2 = 0\n    A_psi[0, 0] = -3 * Rh + 2 * delta_r\n    A_psi[0, 1] = 4 * Rh\n    A_psi[0, 2] = -Rh\n    # b_psi[0] is 0\n    \n    # Rows 1 to N-2: Interior points\n    for i in range(1, N - 1):\n        ri = r[i]\n        A_psi[i, i - 1] = 1.0 - delta_r / ri\n        A_psi[i, i] = -2.0\n        A_psi[i, i + 1] = 1.0 + delta_r / ri\n        # b_psi[i] is 0\n        \n    # Row N-1: Interior point adjacent to outer boundary\n    r_nm1 = r[N - 1]\n    A_psi[N - 1, N - 2] = 1.0 - delta_r / r_nm1\n    A_psi[N - 1, N - 1] = -2.0\n    b_psi[N - 1] = -(1.0 + delta_r / r_nm1) * psi_N\n    \n    psi_sol = np.linalg.solve(A_psi, b_psi)\n    psi_num = np.append(psi_sol, psi_N)\n\n    # 3. Solve for beta_r\n    # We solve for N unknowns: beta_0 to beta_{N-1}. beta_N is known.\n    A_beta = np.zeros((N, N))\n    b_beta = np.zeros(N) # b_beta is entirely zeros\n\n    beta_N = 0.0\n    \n    # Row 0: Inner Neumann BC for beta (from 2nd-order ghost point method)\n    # beta_0 - beta_1 = 0\n    A_beta[0, 0] = 1.0\n    A_beta[0, 1] = -1.0\n    \n    # Rows 1 to N-2: Interior points\n    for i in range(1, N - 1):\n        ri = r[i]\n        A_beta[i, i - 1] = 1.0 - delta_r / ri\n        A_beta[i, i] = -2.0\n        A_beta[i, i + 1] = 1.0 + delta_r / ri\n\n    # Row N-1: Interior point adjacent to outer boundary\n    r_nm1 = r[N - 1]\n    A_beta[N - 1, N - 2] = 1.0 - delta_r / r_nm1\n    A_beta[N - 1, N - 1] = -2.0\n    # b_beta[N-1] is -(1.0 + delta_r/r_nm1) * beta_N = 0\n    \n    beta_sol = np.linalg.solve(A_beta, b_beta)\n    beta_num = np.append(beta_sol, beta_N)\n    \n    # 4. Calculate diagnostic measures\n    # Analytic solution for psi\n    psi_ref = Rmax / r\n    \n    # E_psi_inf: Max-norm relative error for psi\n    E_psi_inf_num = np.max(np.abs(psi_num - psi_ref))\n    E_psi_inf_den = np.max(np.abs(psi_ref)) # This is psi_ref[0] = Rmax/Rh\n    E_psi_inf = E_psi_inf_num / E_psi_inf_den\n\n    # R_psi_inf: Max absolute interior residual for psi\n    residuals_psi = []\n    for i in range(1, N): # Interior nodes are from r_1 to r_{N-1}\n        ri = r[i]\n        op_val = (1.0 / (delta_r**2)) * \\\n                 ((1.0 - delta_r / ri) * psi_num[i - 1] - 2.0 * psi_num[i] + (1.0 + delta_r / ri) * psi_num[i + 1])\n        residuals_psi.append(np.abs(op_val))\n    R_psi_inf = np.max(residuals_psi) if residuals_psi else 0.0\n\n    # B_psi: Absolute inner boundary residual for psi\n    d_psi_dr_0 = (-3*psi_num[0] + 4*psi_num[1] - psi_num[2]) / (2.0 * delta_r)\n    B_psi = np.abs(Rh * d_psi_dr_0 + psi_num[0])\n    \n    # R_beta_inf: Max absolute interior residual for beta_r\n    residuals_beta = []\n    for i in range(1, N):\n        ri = r[i]\n        op_val = (1.0 / (delta_r**2)) * \\\n                 ((1.0 - delta_r / ri) * beta_num[i - 1] - 2.0 * beta_num[i] + (1.0 + delta_r / ri) * beta_num[i + 1])\n        residuals_beta.append(np.abs(op_val))\n    R_beta_inf = np.max(residuals_beta) if residuals_beta else 0.0\n    \n    # B_beta: Absolute inner boundary residual for beta_r\n    d_beta_dr_0 = (-3*beta_num[0] + 4*beta_num[1] - beta_num[2]) / (2.0 * delta_r)\n    B_beta = np.abs(d_beta_dr_0)\n    \n    # 5. Compute quality score q\n    q = np.max([E_psi_inf, R_psi_inf, B_psi, R_beta_inf, B_beta])\n    \n    return q\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (Rh, Rmax, N)\n        (2.0, 10.0, 200),\n        (2.0, 10.0, 40),\n        (9.0, 10.0, 200),\n        (0.5, 5.0, 200),\n    ]\n\n    results = []\n    for case in test_cases:\n        Rh, Rmax, N = case\n        q = solve_system_and_get_q(Rh, Rmax, int(N))\n        results.append(q)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3486554"}, {"introduction": "In realistic scenarios, the Einstein constraint equations are a coupled system of nonlinear elliptic equations that demand sophisticated numerical solvers. This exercise [@problem_id:3486586] immerses you in this complexity by tasking you with building a globalized Newton-Kantorovich solver for a representative model of the non-CMC XCTS system. You will learn to linearize the system, form its Jacobian, and implement a backtracking line search to guarantee convergence, mastering the core algorithm used in state-of-the-art numerical relativity codes.", "problem": "Consider a simplified one-dimensional representation of the non-Constant Mean Curvature (non-CMC) extended conformal thin sandwich (XCTS) elliptic constraint system arising in numerical relativity for gravitational wave initial data. Start from the Einstein constraint equations and the conformal thin sandwich decomposition as the fundamental base. In the conformal decomposition, the leading-order structure is an elliptic system for the conformal factor, the lapse, and the shift. To design a numerically testable problem, model the system on the domain $[0,1]$ with Dirichlet boundary conditions, and use smooth, prescribed background fields.\n\nDefine unknowns $u(x) = (\\phi(x), \\alpha(x), \\beta(x))$ as the conformal factor $\\phi$, the lapse $\\alpha$, and the shift $\\beta$ in one spatial dimension. Let $x \\in [0,1]$ and the angle arguments be interpreted in radians. Consider the following semilinear elliptic system inspired by the XCTS structure:\n$$\n\\begin{aligned}\n&-\\frac{d^2 \\phi}{dx^2} + a_1 S(x)\\,\\phi(x)^{-7} + a_2 K(x)^2\\,\\phi(x)^{5} + a_3 \\rho(x)\\,\\phi(x)^{5} = 0, \\\\\n&-\\frac{d^2 \\beta}{dx^2} + b_1 \\frac{dK}{dx}(x) + b_2 \\phi(x)^{-6}\\,\\beta(x) = 0, \\\\\n&-\\frac{d^2 \\alpha}{dx^2} + c_1 \\phi(x)^{4}\\,\\alpha(x) + c_2 K(x)^2\\,\\alpha(x) - c_3 \\phi(x)^{6} = 0,\n\\end{aligned}\n$$\nsubject to Dirichlet boundary conditions\n$$\n\\phi(0) = 1,\\quad \\phi(1) = 1,\\quad \\alpha(0) = 1,\\quad \\alpha(1) = 1,\\quad \\beta(0) = 0,\\quad \\beta(1) = 0.\n$$\nHere $S(x)$, $K(x)$, and $\\rho(x)$ are prescribed smooth functions representing, respectively, a measure of the square of the traceless part of the extrinsic curvature, the mean curvature, and the matter density. The constants $a_1$, $a_2$, $a_3$, $b_1$, $b_2$, $c_1$, $c_2$, $c_3$ are positive and set the scale of coupling terms. The angle arguments in $S(x)$ and $K(x)$ are in radians.\n\nDiscretize the domain $[0,1]$ using $N$ uniformly spaced points with spacing $h = \\frac{1}{N-1}$. Use second-order centered finite differences for the second derivative:\n$$\n\\frac{d^2 u}{dx^2}\\biggr|_{x_i} \\approx \\frac{u_{i-1} - 2 u_i + u_{i+1}}{h^2},\n$$\nfor interior points $i$, and enforce the Dirichlet boundary conditions by residual equations of the form $u_i - u_{\\text{bc},i} = 0$ at the boundaries.\n\nLet $F(U)$ denote the assembled nonlinear residual vector over all grid points for all three fields, and $J(U)$ its Jacobian matrix with respect to $U$. Implement a Newton–Kantorovich iteration\n$$\nJ(U_k)\\,\\delta U_k = -F(U_k),\\quad U_{k+1}^{\\text{trial}} = U_k + \\lambda\\,\\delta U_k,\n$$\nglobalized by a backtracking line search on the merit function\n$$\n\\Phi(U) = \\frac{1}{2}\\,\\|F(U)\\|_2^2,\n$$\nwith an Armijo sufficient decrease condition\n$$\n\\Phi(U_k + \\lambda\\,\\delta U_k) \\le \\Phi(U_k) + c\\,\\lambda\\,\\frac{d}{d\\lambda}\\Phi(U_k + \\lambda\\,\\delta U_k)\\biggr|_{\\lambda=0}.\n$$\nUse the fact that along the Newton direction $\\delta U_k$, the directional derivative satisfies\n$$\n\\frac{d}{d\\lambda}\\Phi(U_k + \\lambda\\,\\delta U_k)\\biggr|_{\\lambda=0} = F(U_k)^\\top J(U_k)\\,\\delta U_k = -\\|F(U_k)\\|_2^2.\n$$\nChoose $c \\in (0,1)$ and employ backtracking with factor $\\tau \\in (0,1)$ until the Armijo condition holds or a minimum step size is reached. To maintain physical admissibility, enforce $\\phi(x) > 0$ at every step by projecting to a positive floor value after the trial update is formed.\n\nImplement the following specific discretization details for the Jacobian blocks at interior points:\n- For the $\\phi$-equation row, the diagonal contribution from the Laplacian is $\\frac{2}{h^2}$ and the off-diagonals are $-\\frac{1}{h^2}$; add the local derivative of the nonlinear terms\n$$\n\\partial_\\phi\\left(a_1 S\\,\\phi^{-7}\\right) = -7 a_1 S\\,\\phi^{-8},\\quad\n\\partial_\\phi\\left(a_2 K^2\\,\\phi^{5}\\right) = 5 a_2 K^2\\,\\phi^{4},\\quad\n\\partial_\\phi\\left(a_3 \\rho\\,\\phi^{5}\\right) = 5 a_3 \\rho\\,\\phi^{4}.\n$$\n- For the $\\beta$-equation row, the Laplacian contributions are as above for $\\beta$, with the local derivative contributions\n$$\n\\partial_\\beta\\left(b_2 \\phi^{-6}\\,\\beta\\right) = b_2 \\phi^{-6},\\quad\n\\partial_\\phi\\left(b_2 \\phi^{-6}\\,\\beta\\right) = -6 b_2 \\phi^{-7}\\,\\beta.\n$$\n- For the $\\alpha$-equation row, the Laplacian contributions are as above for $\\alpha$, with local derivatives\n$$\n\\partial_\\alpha\\left(c_1 \\phi^{4}\\,\\alpha + c_2 K^2\\,\\alpha\\right) = c_1 \\phi^{4} + c_2 K^2,\\quad\n\\partial_\\phi\\left(c_1 \\phi^{4}\\,\\alpha - c_3 \\phi^{6}\\right) = 4 c_1 \\phi^{3}\\,\\alpha - 6 c_3 \\phi^{5}.\n$$\nAt boundary points, set Jacobian rows as identity for the corresponding unknown enforcing $u_i - u_{\\text{bc},i} = 0$.\n\nChoose the background fields\n$$\nS(x) = s_0 + s_1 \\sin(2\\pi x),\\quad\nK(x) = K_0 + K_1 \\sin(\\pi x),\\quad\n\\frac{dK}{dx}(x) = K_1 \\pi \\cos(\\pi x),\\quad\n\\rho(x) = r_0 \\exp\\left(-\\frac{(x - 1/2)^2}{\\sigma^2}\\right),\n$$\nwith angles in radians.\n\nYour program must implement the Newton–Kantorovich iteration with the globalization strategy described, using sparse matrices for the Jacobian and solving the linear system with a direct sparse solver, and a fallback to a least-squares iterative solver if needed. The initial guess should be the boundary data extended to the interior: $\\phi(x) \\equiv 1$, $\\alpha(x) \\equiv 1$, $\\beta(x) \\equiv 0$.\n\nTest Suite:\nProvide three test cases by varying the parameters to exercise different regimes:\n- Case $1$ (happy path): $N = 64$, $a_1 = 0.125$, $a_2 = \\frac{1}{12}$, $a_3 = 0.1$, $b_1 = 0.05$, $b_2 = 0.1$, $c_1 = 0.5$, $c_2 = 0.1$, $c_3 = 0.01$, $K_0 = 0.1$, $K_1 = 0.05$, $s_0 = 0.1$, $s_1 = 0.05$, $r_0 = 0.01$, $\\sigma = 0.15$.\n- Case $2$ (strong nonlinearity): $N = 64$, $a_1 = 0.125$, $a_2 = \\frac{1}{12}$, $a_3 = 0.1$, $b_1 = 0.05$, $b_2 = 0.1$, $c_1 = 0.5$, $c_2 = 0.1$, $c_3 = 0.01$, $K_0 = 0.1$, $K_1 = 0.3$, $s_0 = 0.5$, $s_1 = 0.3$, $r_0 = 0.2$, $\\sigma = 0.15$.\n- Case $3$ (edge case with coarse grid and sign-varying curvature): $N = 32$, $a_1 = 0.125$, $a_2 = \\frac{1}{12}$, $a_3 = 0.1$, $b_1 = 0.05$, $b_2 = 0.1$, $c_1 = 0.5$, $c_2 = 0.1$, $c_3 = 0.01$, $K_0 = -0.05$, $K_1 = 0.2$, $s_0 = 0.2$, $s_1 = 0.15$, $r_0 = 0.05$, $\\sigma = 0.2$.\n\nStopping criteria:\nUse a tolerance $\\varepsilon = 10^{-10}$ on the residual norm $\\|F(U)\\|_2$, a maximum of $50$ Newton iterations, Armijo parameter $c = 10^{-4}$, backtracking factor $\\tau = \\frac{1}{2}$, and minimum step size $\\lambda_{\\min} = 10^{-6}$. Enforce a positivity floor $\\phi_{\\min} = 10^{-8}$ after each trial update.\n\nRequired final output format:\nYour program should produce a single line of output containing the residual norms at termination (either convergence or reaching the iteration limit) for the three test cases, as a comma-separated list enclosed in square brackets, for example, $[\\text{result}_1,\\text{result}_2,\\text{result}_3]$. Each entry must be a floating-point number.", "solution": "The problem presented is a valid and well-posed task in computational physics, specifically a testbed for numerical methods in general relativity. It involves solving a system of three coupled, nonlinear, second-order ordinary differential equations of the elliptic type on a finite domain with Dirichlet boundary conditions. The system is a simplified one-dimensional analogue of the extended conformal thin-sandwich (XCTS) equations used to generate initial data for simulations of gravitational waves. The provided numerical strategy, a Newton-Kantorovich method globalized with a backtracking line search, is a standard and robust approach for such problems. The following section details the step-by-step procedure for its implementation.\n\n**Discretization and System Formulation**\n\nThe continuous domain $x \\in [0, 1]$ is discretized into a uniform grid of $N$ points $x_i = i h$ for $i=0, 1, \\dots, N-1$, where the grid spacing is $h = 1/(N-1)$. The continuous unknown functions $\\phi(x)$, $\\alpha(x)$, and $\\beta(x)$ are represented by their values at these grid points, denoted as $\\phi_i$, $\\alpha_i$, and $\\beta_i$. These discrete values are assembled into a single state vector $U$ of size $3N$:\n$$\nU = [\\phi_0, \\dots, \\phi_{N-1}, \\alpha_0, \\dots, \\alpha_{N-1}, \\beta_0, \\dots, \\beta_{N-1}]^\\top.\n$$\nThe system of differential equations is converted into a system of nonlinear algebraic equations $F(U) = 0$. For the interior grid points $i=1, \\dots, N-2$, the second-order derivative operator is approximated using a second-order centered finite difference stencil:\n$$\n\\frac{d^2 u}{dx^2}\\biggr|_{x_i} \\approx \\frac{u_{i-1} - 2 u_i + u_{i+1}}{h^2}.\n$$\nApplying this to the three governing equations yields the discrete residual equations for the interior points:\n\nFor $\\phi_i$ (component $i$ of the residual vector, $F_i$):\n$$\nF_i(U) = -\\frac{\\phi_{i-1} - 2\\phi_i + \\phi_{i+1}}{h^2} + a_1 S_i \\phi_i^{-7} + (a_2 K_i^2 + a_3 \\rho_i) \\phi_i^5 = 0.\n$$\nFor $\\alpha_i$ (component $N+i$ of the residual vector, $F_{N+i}$):\n$$\nF_{N+i}(U) = -\\frac{\\alpha_{i-1} - 2\\alpha_i + \\alpha_{i+1}}{h^2} + (c_1 \\phi_i^4 + c_2 K_i^2)\\alpha_i - c_3 \\phi_i^6 = 0.\n$$\nFor $\\beta_i$ (component $2N+i$ of the residual vector, $F_{2N+i}$):\n$$\nF_{2N+i}(U) = -\\frac{\\beta_{i-1} - 2\\beta_i + \\beta_{i+1}}{h^2} + b_1 \\left(\\frac{dK}{dx}\\right)_i + b_2 \\phi_i^{-6} \\beta_i = 0.\n$$\nHere, $S_i$, $K_i$, $\\rho_i$, and $(dK/dx)_i$ are the values of the prescribed background fields at grid point $x_i$.\n\nFor the boundary points ($i=0$ and $i=N-1$), the Dirichlet conditions are enforced directly as residual equations:\n$$\nF_0(U) = \\phi_0 - 1 = 0, \\quad F_{N-1}(U) = \\phi_{N-1} - 1 = 0,\n$$\n$$\nF_N(U) = \\alpha_0 - 1 = 0, \\quad F_{2N-1}(U) = \\alpha_{N-1} - 1 = 0,\n$$\n$$\nF_{2N}(U) = \\beta_0 - 0 = 0, \\quad F_{3N-1}(U) = \\beta_{N-1} - 0 = 0.\n$$\n\n**The Newton-Kantorovich Iteration**\n\nThe nonlinear system $F(U) = 0$ is solved iteratively using the Newton-Kantorovich method. Starting from an initial guess $U_0$, the method generates a sequence of approximations $U_k$ that converges to the solution. Each iteration involves solving a linear system for the update step $\\delta U_k$:\n$$\nJ(U_k) \\delta U_k = -F(U_k),\n$$\nwhere $J(U_k)$ is the Jacobian matrix of the residual vector $F$ evaluated at the current iterate $U_k$. The entries of the Jacobian are $J_{ij} = \\partial F_i / \\partial U_j$. Due to the local nature of the finite difference stencil and the coupling, the Jacobian is a large but sparse matrix. The structure of the nonzero elements is as follows:\n\n*   **Boundary Rows:** For rows corresponding to boundary conditions, the Jacobian is an identity row, i.e., $J_{p,p} = 1$ and $J_{p,q}=0$ for $q \\ne p$, where $p$ is the index of the boundary variable. For example, for $F_0 = \\phi_0 - 1$, the first row of $J$ has $J_{0,0}=1$ and all other entries are zero.\n\n*   **Interior Rows (for $i \\in \\{1, \\dots, N-2\\}$):**\n    *   **$\\phi$-equation (row $i$):**\n        *   $\\frac{\\partial F_i}{\\partial \\phi_{i-1}} = -1/h^2$\n        *   $\\frac{\\partial F_i}{\\partial \\phi_i} = 2/h^2 - 7a_1 S_i \\phi_i^{-8} + 5(a_2 K_i^2 + a_3 \\rho_i) \\phi_i^4$\n        *   $\\frac{\\partial F_i}{\\partial \\phi_{i+1}} = -1/h^2$\n    *   **$\\alpha$-equation (row $N+i$):**\n        *   $\\frac{\\partial F_{N+i}}{\\partial \\phi_i} = 4c_1 \\phi_i^3 \\alpha_i - 6c_3 \\phi_i^5$\n        *   $\\frac{\\partial F_{N+i}}{\\partial \\alpha_{i-1}} = -1/h^2$\n        *   $\\frac{\\partial F_{N+i}}{\\partial \\alpha_i} = 2/h^2 + c_1 \\phi_i^4 + c_2 K_i^2$\n        *   $\\frac{\\partial F_{N+i}}{\\partial \\alpha_{i+1}} = -1/h^2$\n    *   **$\\beta$-equation (row $2N+i$):**\n        *   $\\frac{\\partial F_{2N+i}}{\\partial \\phi_i} = -6b_2 \\phi_i^{-7} \\beta_i$\n        *   $\\frac{\\partial F_{2N+i}}{\\partial \\beta_{i-1}} = -1/h^2$\n        *   $\\frac{\\partial F_{2N+i}}{\\partial \\beta_i} = 2/h^2 + b_2 \\phi_i^{-6}$\n        *   $\\frac{\\partial F_{2N+i}}{\\partial \\beta_{i+1}} = -1/h^2$\n\nAll other partial derivatives are zero. This defines a block matrix structure where the diagonal blocks are tridiagonal and some off-diagonal blocks are diagonal. This sparse structure is exploited by using sparse matrix data structures and linear solvers.\n\n**Globalization and Regularization**\n\nThe raw Newton step $\\delta U_k$ does not guarantee a decrease in the residual, especially far from the solution. A globalization strategy is required. A backtracking line search is employed to find a suitable step length $\\lambda \\in (0,1]$ for the update:\n$$\nU_{k+1} = U_k + \\lambda \\delta U_k.\n$$\nThe step length $\\lambda$ is chosen to satisfy the Armijo sufficient decrease condition on the merit function $\\Phi(U) = \\frac{1}{2}\\|F(U)\\|_2^2$. The condition is:\n$$\n\\Phi(U_k + \\lambda \\delta U_k) \\le \\Phi(U_k) + c \\lambda \\nabla\\Phi(U_k)^\\top \\delta U_k,\n$$\nwhere $c$ is a small constant (here, $c=10^{-4}$). The directional derivative $\\nabla\\Phi(U_k)^\\top \\delta U_k$ simplifies to $-F(U_k)^\\top J(U_k) J(U_k)^{-1} F(U_k) = -\\|F(U_k)\\|_2^2$. Thus, the condition becomes:\n$$\n\\Phi(U_{k+1}^{\\text{trial}}) \\le \\Phi(U_k) - c \\lambda \\|F(U_k)\\|_2^2.\n$$\nThe search for $\\lambda$ starts with $\\lambda=1$ and decrements it by a factor $\\tau = 1/2$ until the condition is met or a minimum step size $\\lambda_{\\min}$ is reached.\n\nAdditionally, the physics of the problem requires the conformal factor to be positive, $\\phi(x) > 0$. The presence of terms like $\\phi^{-7}$ and $\\phi^{-8}$ makes the system singular as $\\phi \\to 0$. To prevent the iterates from entering this unphysical and numerically unstable regime, a positivity constraint is enforced after each trial update by projecting any value of $\\phi_i$ below a floor value $\\phi_{\\min} = 10^{-8}$ back up to the floor: $\\phi_i \\leftarrow \\max(\\phi_i, \\phi_{\\min})$.\n\n**Algorithm Summary**\n\nThe complete algorithm proceeds as follows:\n1.  **Initialization:** For a given set of parameters, construct the grid $x_i$ and evaluate the background fields $S_i, K_i, \\rho_i, (dK/dx)_i$. Initialize the state vector $U_0$ with $\\phi_i \\equiv 1$, $\\alpha_i \\equiv 1$, and $\\beta_i \\equiv 0$.\n2.  **Iteration:** For $k = 0, 1, \\dots, \\text{max\\_iterations}-1$:\n    a. Compute the residual vector $F(U_k)$ and its Euclidean norm $\\|F(U_k)\\|_2$.\n    b. Check for convergence: if $\\|F(U_k)\\|_2 < \\varepsilon$, terminate and report success.\n    c. Compute the sparse Jacobian matrix $J(U_k)$.\n    d. Solve the linear system $J(U_k) \\delta U_k = -F(U_k)$ to find the Newton step $\\delta U_k$. A direct sparse solver is used, with a fallback to an iterative least-squares solver for robustness.\n    e. Perform the backtracking line search to find an acceptable step length $\\lambda$.\n    f. Update the solution: $U_{k+1} = U_k + \\lambda \\delta U_k$.\n    g. Enforce positivity: for each $i$, set $\\phi_i \\leftarrow \\max(\\phi_i, \\phi_{\\min})$.\n3.  **Termination:** If the loop finishes due to reaching the maximum number of iterations, the process terminates, and the final residual norm is reported.\n\nThis procedure is applied to each of the three test cases specified in the problem statement to obtain the required final results.", "answer": "```python\nimport numpy as np\nfrom scipy import sparse\nfrom scipy.sparse.linalg import spsolve, lsqr\n\ndef compute_residual(U, N, h, p):\n    \"\"\"Computes the nonlinear residual vector F(U).\"\"\"\n    phi = U[0:N]\n    alpha = U[N:2*N]\n    beta = U[2*N:3*N]\n    F = np.zeros(3 * N)\n    \n    # Unpack parameters\n    a1, a2, a3 = p['a1'], p['a2'], p['a3']\n    b1, b2 = p['b1'], p['b2']\n    c1, c2, c3 = p['c1'], p['c2'], p['c3']\n    S, K, dKdx, rho = p['S_vals'], p['K_vals'], p['dKdx_vals'], p['rho_vals']\n    h2 = h**2\n\n    # Interior points\n    for i in range(1, N - 1):\n        # Phi equation\n        lap_phi = (phi[i-1] - 2 * phi[i] + phi[i+1]) / h2\n        F[i] = -lap_phi + a1 * S[i] * phi[i]**-7 + (a2 * K[i]**2 + a3 * rho[i]) * phi[i]**5\n        \n        # Beta equation\n        lap_beta = (beta[i-1] - 2 * beta[i] + beta[i+1]) / h2\n        F[2*N + i] = -lap_beta + b1 * dKdx[i] + b2 * phi[i]**-6 * beta[i]\n\n        # Alpha equation\n        lap_alpha = (alpha[i-1] - 2 * alpha[i] + alpha[i+1]) / h2\n        F[N + i] = -lap_alpha + (c1 * phi[i]**4 + c2 * K[i]**2) * alpha[i] - c3 * phi[i]**6\n        \n    # Boundary conditions\n    F[0] = phi[0] - 1.0\n    F[N-1] = phi[N-1] - 1.0\n    F[N] = alpha[0] - 1.0\n    F[2*N-1] = alpha[N-1] - 1.0\n    F[2*N] = beta[0] - 0.0\n    F[3*N-1] = beta[N-1] - 0.0\n\n    return F\n\ndef run_newton_solver(params):\n    \"\"\"\n    Solves the 1D non-linear elliptic system using a Newton-Kantorovich method.\n    \"\"\"\n    # Unpack general parameters\n    N = params['N']\n    tol = params['tol']\n    max_iter = params['max_iter']\n    armijo_c = params['armijo_c']\n    backtrack_tau = params['backtrack_tau']\n    min_lambda = params['min_lambda']\n    phi_min = params['phi_min']\n\n    # Grid setup\n    x = np.linspace(0, 1, N)\n    h = 1.0 / (N - 1)\n    h2 = h**2\n    \n    # Evaluate background fields\n    K0, K1, s0, s1, r0, sigma = params['K0'], params['K1'], params['s0'], params['s1'], params['r0'], params['sigma']\n    params['S_vals'] = s0 + s1 * np.sin(2 * np.pi * x)\n    params['K_vals'] = K0 + K1 * np.sin(np.pi * x)\n    params['dKdx_vals'] = K1 * np.pi * np.cos(np.pi * x)\n    params['rho_vals'] = r0 * np.exp(-(x - 0.5)**2 / sigma**2)\n\n    # Initial guess\n    U = np.zeros(3 * N)\n    U[0:N] = 1.0      # phi\n    U[N:2*N] = 1.0    # alpha\n    U[2*N:3*N] = 0.0  # beta\n\n    # Unpack physics parameters\n    a1, a2, a3 = params['a1'], params['a2'], params['a3']\n    b1, b2 = params['b1'], params['b2']\n    c1, c2, c3 = params['c1'], params['c2'], params['c3']\n    S, K, dKdx, rho = params['S_vals'], params['K_vals'], params['dKdx_vals'], params['rho_vals']\n    \n    final_res_norm = -1.0\n    for k in range(max_iter):\n        F = compute_residual(U, N, h, params)\n        res_norm = np.linalg.norm(F)\n        final_res_norm = res_norm\n\n        if res_norm < tol:\n            break\n\n        # Assemble Jacobian\n        J = sparse.lil_matrix((3 * N, 3 * N))\n        phi, alpha, beta = U[0:N], U[N:2*N], U[2*N:3*N]\n\n        for i in range(1, N - 1):\n            # Phi equation row (index i)\n            J[i, i-1] = -1.0 / h2\n            J[i, i] = 2.0 / h2 - 7 * a1 * S[i] * phi[i]**-8 + 5 * (a2 * K[i]**2 + a3 * rho[i]) * phi[i]**4\n            J[i, i+1] = -1.0 / h2\n            \n            # Beta equation row (index 2N+i)\n            J[2*N + i, 2*N + i-1] = -1.0 / h2\n            J[2*N + i, 2*N + i] = 2.0 / h2 + b2 * phi[i]**-6\n            J[2*N + i, 2*N + i+1] = -1.0 / h2\n            J[2*N + i, i] = -6 * b2 * phi[i]**-7 * beta[i]\n\n            # Alpha equation row (index N+i)\n            J[N + i, N + i-1] = -1.0 / h2\n            J[N + i, N + i] = 2.0 / h2 + c1 * phi[i]**4 + c2 * K[i]**2\n            J[N + i, N + i+1] = -1.0 / h2\n            J[N + i, i] = 4 * c1 * phi[i]**3 * alpha[i] - 6 * c3 * phi[i]**5\n        \n        # Boundary rows in Jacobian\n        J[0, 0] = J[N-1, N-1] = 1.0\n        J[N, N] = J[2*N-1, 2*N-1] = 1.0\n        J[2*N, 2*N] = J[3*N-1, 3*N-1] = 1.0\n        \n        J_csc = J.tocsc()\n        \n        # Solve linear system\n        try:\n            dU = spsolve(J_csc, -F)\n            if np.any(np.isnan(dU)):\n                raise np.linalg.LinAlgError(\"NaNs in solution from spsolve\")\n        except (np.linalg.LinAlgError, RuntimeError):\n            # Fallback to least-squares iterative solver\n            dU = lsqr(J_csc, -F)[0]\n        \n        # Backtracking line search\n        lambda_ = 1.0\n        merit_k = 0.5 * res_norm**2\n        search_dir_dot_grad = -res_norm**2\n        \n        while lambda_ > min_lambda:\n            U_trial = U + lambda_ * dU\n            # Enforce positivity on phi\n            phi_trial = U_trial[0:N]\n            phi_trial[phi_trial < phi_min] = phi_min\n            U_trial[0:N] = phi_trial\n\n            F_trial = compute_residual(U_trial, N, h, params)\n            merit_trial = 0.5 * np.linalg.norm(F_trial)**2\n            \n            if merit_trial <= merit_k + armijo_c * lambda_ * search_dir_dot_grad:\n                break\n            \n            lambda_ *= backtrack_tau\n        \n        U = U + lambda_ * dU\n        # Final enforcement of positivity after step\n        U[0:N][U[0:N] < phi_min] = phi_min\n\n    return final_res_norm\n\ndef solve():\n    # Define solver settings\n    solver_settings = {\n        'tol': 1e-10,\n        'max_iter': 50,\n        'armijo_c': 1e-4,\n        'backtrack_tau': 0.5,\n        'min_lambda': 1e-6,\n        'phi_min': 1e-8\n    }\n    \n    # Define test cases\n    test_cases = [\n        # Case 1\n        {**solver_settings, 'N': 64, 'a1': 0.125, 'a2': 1.0/12.0, 'a3': 0.1, 'b1': 0.05, 'b2': 0.1, \n         'c1': 0.5, 'c2': 0.1, 'c3': 0.01, 'K0': 0.1, 'K1': 0.05, 's0': 0.1, 's1': 0.05, 'r0': 0.01, 'sigma': 0.15},\n        # Case 2\n        {**solver_settings, 'N': 64, 'a1': 0.125, 'a2': 1.0/12.0, 'a3': 0.1, 'b1': 0.05, 'b2': 0.1,\n         'c1': 0.5, 'c2': 0.1, 'c3': 0.01, 'K0': 0.1, 'K1': 0.3, 's0': 0.5, 's1': 0.3, 'r0': 0.2, 'sigma': 0.15},\n        # Case 3\n        {**solver_settings, 'N': 32, 'a1': 0.125, 'a2': 1.0/12.0, 'a3': 0.1, 'b1': 0.05, 'b2': 0.1,\n         'c1': 0.5, 'c2': 0.1, 'c3': 0.01, 'K0': -0.05, 'K1': 0.2, 's0': 0.2, 's1': 0.15, 'r0': 0.05, 'sigma': 0.2},\n    ]\n\n    results = []\n    for case in test_cases:\n        final_norm = run_newton_solver(case)\n        results.append(final_norm)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3486586"}]}