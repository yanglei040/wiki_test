{"hands_on_practices": [{"introduction": "To build a robust understanding of neutrino transport, we begin with its most fundamental approximation: the diffusion limit. This analytical exercise provides a solid foundation by exploring a steady-state scenario where the neutrino flux is driven by the gradient of energy density. By solving for the neutrino energy profile within a medium of spatially varying opacity, you will develop crucial physical intuition about how the properties of the matter dictate the flow of radiation, a concept that underpins more complex transport schemes [@problem_id:3480971].", "problem": "Consider a plane-parallel, one-dimensional slab representing the vertical structure of an optically thick neutrino-opaque layer in a neutron star merger remnant, occupying $0 \\leq z \\leq L$. In the steady state, assume the neutrino radiation field is well described by the diffusion approximation: the neutrino energy flux $F^{z}(z)$ is related to the gradient of the neutrino energy density $E(z)$ by\n$$\nF^{z}(z) = - D(z) \\, \\partial_{z} E(z),\n$$\nwhere the diffusion coefficient $D(z)$ is given by\n$$\nD(z) = \\frac{c}{3 \\, \\kappa_{t}(z)},\n$$\nwith $c$ the speed of light and $\\kappa_{t}(z)$ the transport opacity. Assume the medium is in steady state, so that neutrino energy conservation reduces to\n$$\n\\partial_{z} F^{z}(z) = 0,\n$$\nand the transport opacity varies linearly across the slab according to\n$$\n\\kappa_{t}(z) = \\kappa_{0} \\left( 1 + \\alpha \\, \\frac{z}{L} \\right),\n$$\nwith $\\kappa_{0} > 0$ and $\\alpha > -1$ a dimensionless gradient parameter ensuring $\\kappa_{t}(z) > 0$ throughout the slab. Impose fixed neutrino energy density boundary conditions\n$$\nE(0) = E_{0}, \\qquad E(L) = E_{L},\n$$\nwith $E_{0}$ and $E_{L}$ finite and not necessarily equal. Starting from the stated conservation law and closure, derive the constant steady-state flux $F^{z}$ and the energy density profile $E(z)$ across the slab. Discuss the physical limits $\\alpha \\to 0$ and $\\alpha \\to +\\infty$ for the shape of $E(z)$ and the magnitude of $F^{z}$, in terms of the optical properties of the medium.\n\nFor your final answer, provide the closed-form dimensionless profile\n$$\n\\phi(z) \\equiv \\frac{E(z) - E_{L}}{E_{0} - E_{L}},\n$$\nexpressed as a single analytic function of $z$, $L$, and $\\alpha$. This final answer is dimensionless; no units are required. No numerical rounding is requested.", "solution": "The starting point is the steady-state neutrino energy conservation law in one dimension,\n$$\n\\partial_{z} F^{z}(z) = 0\n$$\nIntegrating this equation with respect to $z$ shows that the neutrino energy flux $F^{z}$ is constant throughout the slab. Let this constant flux be denoted by $F^{z}_{0}$.\n$$\nF^{z}(z) = F^{z}_{0}\n$$\nThe problem states that the flux is related to the gradient of the neutrino energy density $E(z)$ via the diffusion approximation,\n$$\nF^{z}_{0} = -D(z) \\, \\partial_{z} E(z)\n$$\nwhere $D(z)$ is the diffusion coefficient. This can be rewritten as a differential equation for $E(z)$:\n$$\n\\frac{dE}{dz} = -\\frac{F^{z}_{0}}{D(z)}\n$$\nThe diffusion coefficient is given by $D(z) = \\frac{c}{3\\kappa_{t}(z)}$, with $c$ being the speed of light and $\\kappa_{t}(z)$ the transport opacity. Substituting this into the differential equation yields:\n$$\n\\frac{dE}{dz} = -F^{z}_{0} \\frac{3\\kappa_{t}(z)}{c}\n$$\nWe are given the linear profile for the transport opacity:\n$$\n\\kappa_{t}(z) = \\kappa_{0} \\left( 1 + \\alpha \\frac{z}{L} \\right)\n$$\nwhere $\\kappa_{0} > 0$ and $\\alpha > -1$. Substituting this into the equation for the energy density gradient gives:\n$$\n\\frac{dE}{dz} = -\\frac{3\\kappa_{0}F^{z}_{0}}{c} \\left( 1 + \\alpha \\frac{z}{L} \\right)\n$$\nTo find the energy profile $E(z)$ and the constant flux $F^{z}_{0}$, we integrate this equation and apply the boundary conditions $E(0) = E_{0}$ and $E(L) = E_{L}$. We can separate variables and integrate from $z=0$ to an arbitrary position $z$:\n$$\n\\int_{E(0)}^{E(z)} dE' = \\int_{0}^{z} -\\frac{3\\kappa_{0}F^{z}_{0}}{c} \\left( 1 + \\alpha \\frac{z'}{L} \\right) dz'\n$$\n$$\nE(z) - E(0) = -\\frac{3\\kappa_{0}F^{z}_{0}}{c} \\left[ z' + \\frac{\\alpha z'^{2}}{2L} \\right]_{0}^{z}\n$$\nUsing $E(0) = E_{0}$, we obtain an intermediate expression for $E(z)$:\n$$\nE(z) - E_{0} = -\\frac{3\\kappa_{0}F^{z}_{0}}{c} \\left( z + \\frac{\\alpha z^{2}}{2L} \\right)\n$$\nTo determine the unknown flux $F^{z}_{0}$, we apply the second boundary condition at $z=L$:\n$$\nE(L) - E_{0} = -\\frac{3\\kappa_{0}F^{z}_{0}}{c} \\left( L + \\frac{\\alpha L^{2}}{2L} \\right)\n$$\nSubstituting $E(L)=E_{L}$ and simplifying the term in the parentheses:\n$$\nE_{L} - E_{0} = -\\frac{3\\kappa_{0}F^{z}_{0}L}{c} \\left( 1 + \\frac{\\alpha}{2} \\right)\n$$\nWe can now solve for the constant flux $F^{z}_{0}$:\n$$\nF^{z}_{0} = -\\frac{c(E_{L}-E_{0})}{3\\kappa_{0}L(1+\\frac{\\alpha}{2})} = \\frac{c(E_{0}-E_{L})}{3\\kappa_{0}L(\\frac{2+\\alpha}{2})} = \\frac{2c(E_{0}-E_{L})}{3\\kappa_{0}L(2+\\alpha)}\n$$\nThis is the expression for the constant steady-state flux. The condition $\\alpha > -1$ ensures that the denominator $2+\\alpha > 1$ is never zero.\n\nNow we can derive the final expression for the energy density profile $E(z)$ by substituting the expression for $F^{z}_{0}$ back into the equation for $E(z)$:\n$$\nE(z) = E_{0} -\\frac{3\\kappa_{0}}{c} \\left( \\frac{2c(E_{0}-E_{L})}{3\\kappa_{0}L(2+\\alpha)} \\right) \\left( z + \\frac{\\alpha z^{2}}{2L} \\right)\n$$\n$$\nE(z) = E_{0} - (E_{0}-E_{L}) \\frac{2}{L(2+\\alpha)} \\left( z + \\frac{\\alpha z^{2}}{2L} \\right)\n$$\n\nWe now discuss the physical limits.\nCase 1: $\\alpha \\to 0$. Here, the opacity becomes uniform, $\\kappa_{t}(z) = \\kappa_{0}$. The medium is homogeneous.\nThe flux simplifies to:\n$$\nF^{z}_{0} = \\lim_{\\alpha \\to 0} \\frac{2c(E_{0}-E_{L})}{3\\kappa_{0}L(2+\\alpha)} = \\frac{c(E_{0}-E_{L})}{3\\kappa_{0}L}\n$$\nThe energy density profile becomes:\n$$\nE(z) = \\lim_{\\alpha \\to 0} \\left[ E_{0} - (E_{0}-E_{L}) \\frac{2(z + \\frac{\\alpha z^{2}}{2L})}{L(2+\\alpha)} \\right] = E_{0} - (E_{0}-E_{L})\\frac{2z}{2L} = E_{0} - (E_{0}-E_{L})\\frac{z}{L}\n$$\nThis is a linear profile, $E(z) = E_{0}(1-\\frac{z}{L}) + E_{L}\\frac{z}{L}$, which is the expected result for diffusion in a homogeneous medium.\n\nCase 2: $\\alpha \\to +\\infty$. Here, the opacity gradient is extremely steep. The opacity $\\kappa_{t}(z)$ is finite at $z=0$ but grows without bound for $z>0$.\nThe flux becomes:\n$$\nF^{z}_{0} = \\lim_{\\alpha \\to +\\infty} \\frac{2c(E_{0}-E_{L})}{3\\kappa_{0}L(2+\\alpha)} = 0\n$$\nThe total optical depth of the slab diverges, and the slab becomes impervious to energy transport, so the flux vanishes.\nFor the energy density profile, we examine the limit of the term multiplying $(E_{0}-E_{L})$:\n$$\n\\lim_{\\alpha \\to +\\infty} \\frac{2(z + \\frac{\\alpha z^{2}}{2L})}{L(2+\\alpha)} = \\lim_{\\alpha \\to \\infty} \\frac{2z/L + \\alpha z^{2}/L^{2}}{2+\\alpha} = \\lim_{\\alpha \\to \\infty} \\frac{\\alpha(2z/(\\alpha L) + z^2/L^2)}{\\alpha(2/\\alpha + 1)} = \\frac{z^2}{L^2}\n$$\nSo, the profile becomes:\n$$\nE(z) = E_{0} - (E_{0}-E_{L})\\frac{z^{2}}{L^{2}}\n$$\nThis is a parabolic profile. The gradient magnitude $|dE/dz|$ is proportional to $\\kappa_t(z)$ to maintain a constant flux $F^z_0=-D(z)dE/dz$. Since $\\kappa_t(z)$ increases with $z$ for $\\alpha>0$, the profile must be flatter near $z=0$ and steeper near $z=L$. The limiting parabolic profile $E_0 - (E_0-E_L)(z/L)^2$ indeed has zero slope at $z=0$ and its steepest slope at $z=L$, consistent with this physical reasoning.\n\nFinally, we derive the dimensionless profile $\\phi(z) \\equiv \\frac{E(z) - E_{L}}{E_{0} - E_{L}}$, assuming $E_{0} \\neq E_{L}$.\nFrom the profile $E(z)$, we have:\n$$\nE(z) - E_{L} = \\left[ E_{0} - (E_{0}-E_{L}) \\frac{2(z + \\frac{\\alpha z^{2}}{2L})}{L(2+\\alpha)} \\right] - E_{L}\n$$\n$$\nE(z) - E_{L} = (E_{0} - E_{L}) - (E_{0}-E_{L}) \\frac{2(z + \\frac{\\alpha z^{2}}{2L})}{L(2+\\alpha)}\n$$\n$$\nE(z) - E_{L} = (E_{0}-E_{L}) \\left[ 1 - \\frac{2(z + \\frac{\\alpha z^{2}}{2L})}{L(2+\\alpha)} \\right]\n$$\nDividing by $(E_{0}-E_{L})$ gives $\\phi(z)$:\n$$\n\\phi(z) = 1 - \\frac{2z + \\frac{\\alpha z^{2}}{L}}{L(2+\\alpha)} = 1 - \\frac{2z/L + \\alpha z^{2}/L^{2}}{2+\\alpha}\n$$\nThis is the required dimensionless profile.", "answer": "$$\n\\boxed{1 - \\frac{\\frac{2z}{L} + \\frac{\\alpha z^{2}}{L^{2}}}{2 + \\alpha}}\n$$", "id": "3480971"}, {"introduction": "Moving beyond the diffusion limit, moment-based methods must confront a fundamental challenge: ensuring the solution remains physically realizable. The neutrino energy density $E$ and flux $F$ are not independent; they must satisfy the causality constraint $|F| \\le cE$. This coding practice tackles this issue head-on by guiding you through the implementation of a flux limiter, a critical component in virtually all modern radiation hydrodynamics codes, using illustrative analogies to traffic flow to build an intuitive grasp of its function [@problem_id:3480969].", "problem": "Consider neutrino radiation transport in the moment formalism in one spatial dimension, interpreted through a traffic-flow analogy. Let $E$ denote the neutrino energy density, and $F$ denote the neutrino flux. In the local rest frame of the fluid and in natural units where the speed of light $c$ satisfies $c=1$ (all quantities dimensionless), fundamental constraints from kinetic theory and causality impose the realizability conditions $E \\ge 0$ and $\\lvert F \\rvert \\le E$. Define the flux factor $f$ by $f = \\lvert F \\rvert / E$ for $E>0$, and $f=0$ for $E=0$. A closure prescribes an Eddington factor $\\chi(f)$ that maps the flux factor to an effective radiation pressure, with the following physically motivated endpoint conditions: $\\chi(0)=1/3$ in the isotropic diffusion limit and $\\chi(1)=1$ in the free-streaming limit. Additionally, $\\chi(f)$ must satisfy $1/3 \\le \\chi(f) \\le 1$ and be monotonically non-decreasing in $f \\in [0,1]$.\n\nYour task is to write a complete program that, for each test case in the suite below, performs the following steps:\n\n1) Interpret the given configuration as a set of one-dimensional mono-directional beams indexed by $i$, each with nonnegative energy contribution $e_i \\ge 0$ and direction $s_i \\in \\{-1,+1\\}$. Construct the raw moments by superposition:\n   - $E_{\\mathrm{raw}} = \\sum_i e_i$,\n   - $F_{\\mathrm{raw}} = \\sum_i e_i s_i$.\n   In specific tests, a multiplicative overshoot factor $\\alpha \\ge 0$ may be applied to $F_{\\mathrm{raw}}$ to mimic numerical overshoot, resulting in $F_{\\mathrm{raw}} \\leftarrow \\alpha\\, F_{\\mathrm{raw}}$ before limiting. In one test, raw moments $(E_{\\mathrm{raw}},F_{\\mathrm{raw}})$ are given directly, without beams.\n\n2) Apply a flux limiter to obtain realizable moments $(E,F)$ by modifying only the magnitude of $F_{\\mathrm{raw}}$ if necessary (preserve its sign), such that the realizability constraints $E \\ge 0$ and $\\lvert F \\rvert \\le E$ hold. Use a minimal modification principle that reduces the magnitude of $F_{\\mathrm{raw}}$ only when required to satisfy $\\lvert F \\rvert \\le E$.\n\n3) Compute the flux factor $f$ from the limited moments $(E,F)$ using $f=\\lvert F \\rvert/E$ for $E>0$, and $f=0$ if $E=0$.\n\n4) Use a closure $\\chi(f)$ that is consistent with the fundamental endpoints and monotonicity stated above to compute the Eddington factor for each case.\n\n5) For each test case, evaluate the specified pass/fail conditions stated below.\n\nTraffic-flow interpretation: View $E$ as an analog of car density and $F$ as the net flow, with a maximum possible flow magnitude $\\lvert F \\rvert \\le E$. Superposition of opposing beams corresponds to crossing traffic; the limiter must prevent unphysical jams (violations of $\\lvert F \\rvert \\le E$) or rarefactions (increases in $f$ due to adding counter-flow).\n\nWork in natural units with $c=1$ so that all quantities are dimensionless.\n\nTest suite. Implement the following five test cases exactly:\n\n- Test 1 (free-streaming single beam, no overshoot): one beam with $(e_1,s_1)=(1.0,+1)$. No overshoot factor, i.e., $\\alpha=1.0$. After limiting and closure, the case passes if all of the following hold with tolerance $\\varepsilon=10^{-12}$:\n  - Realizability: $E \\ge 0$ and $\\lvert F \\rvert \\le E$,\n  - Endpoint consistency: $\\lvert f - 1 \\rvert \\le \\varepsilon$ and $\\lvert \\chi(f) - 1 \\rvert \\le \\varepsilon$.\n\n- Test 2 (isotropic two-beam crossing, no overshoot): two beams $(e_1,s_1)=(1.0,+1)$ and $(e_2,s_2)=(1.0,-1)$. No overshoot, i.e., $\\alpha=1.0$. After limiting and closure, the case passes if:\n  - Realizability holds,\n  - Isotropic endpoint: $\\lvert f - 0 \\rvert \\le \\varepsilon$ and $\\lvert \\chi(f) - 1/3 \\rvert \\le \\varepsilon$ with $\\varepsilon=10^{-12}$.\n\n- Test 3 (monotonicity under added counter-flow): compare two configurations A and B.\n  - A: one beam $(e_1,s_1)=(1.0,+1)$, no overshoot.\n  - B: two beams $(e_1,s_1)=(1.0,+1)$ and $(e_2,s_2)=(0.2,-1)$, no overshoot.\n  The test passes if the limited flux factors satisfy $f_B \\le f_A + \\varepsilon$ with $\\varepsilon=10^{-12}$.\n\n- Test 4 (overshoot correction): one beam $(e_1,s_1)=(1.0,+1)$ with overshoot factor $\\alpha=1.5$ applied to $F_{\\mathrm{raw}}$ before limiting. The test passes if after limiting:\n  - Realizability holds,\n  - The limited flux factor satisfies $\\lvert f - 1 \\rvert \\le \\varepsilon$ with $\\varepsilon=10^{-12}$,\n  - The sign of $F$ matches the sign of the raw $F_{\\mathrm{raw}}$ prior to limiting.\n\n- Test 5 (zero-energy limit handling): raw moments are given directly as $(E_{\\mathrm{raw}},F_{\\mathrm{raw}})=(0.0,0.7)$. The test passes if after limiting:\n  - Realizability holds,\n  - $E=0$ and $F=0$, hence $f=0$.\n\nFinal output format. Your program should produce a single line of output containing the results of the five tests as a comma-separated list of boolean values enclosed in square brackets (e.g., \"[True,False,True,True,True]\"). No other output is permitted.\n\nNotes:\n- You must implement a closure $\\chi(f)$ that satisfies the fundamental endpoint conditions $\\chi(0)=1/3$ and $\\chi(1)=1$, is monotonically non-decreasing on $[0,1]$, and remains within $[1/3,1]$. You must justify your choice from the fundamental base in your solution derivation.\n- Angle units are not applicable.\n- All quantities are dimensionless due to the choice $c=1$.", "solution": "### Solution Derivation\n\nThe problem requires the implementation and testing of a flux-limiting procedure for neutrino radiation transport moments in one spatial dimension. The solution comprises four main components: calculation of raw moments, application of a flux limiter to ensure physical realizability, calculation of the flux and Eddington factors, and verification against a suite of test cases.\n\n**1. Raw Moment Calculation**\nThe zeroth and first angular moments of the neutrino distribution function correspond to the energy density $E$ and the flux $F$, respectively. For a collection of one-dimensional, mono-directional beams, these moments are constructed by linear superposition. Given a set of beams, each with energy contribution $e_i \\ge 0$ and direction $s_i \\in \\{-1, +1\\}$, the raw moments are:\n$$ E_{\\mathrm{raw}} = \\sum_i e_i $$\n$$ F_{\\mathrm{raw}} = \\sum_i e_i s_i $$\nIn some numerical contexts, the flux can be subject to spurious oscillations or overshoots. This effect is modeled by applying a multiplicative factor $\\alpha \\ge 0$ to the raw flux, $F_{\\mathrm{raw}} \\leftarrow \\alpha F_{\\mathrm{raw}}$, before any further processing.\n\n**2. Realizability and the Flux Limiter**\nFrom kinetic theory, the energy density must be non-negative ($E \\ge 0$), and the magnitude of the flux cannot exceed the energy density (in units where $c=1$), i.e., $\\lvert F \\rvert \\le E$. These are the \"realizability conditions.\" Since the beam energies $e_i$ are non-negative, the resulting raw energy density $E_{\\mathrm{raw}} = \\sum_i e_i$ is also non-negative, so we set the final energy density $E = E_{\\mathrm{raw}}$, satisfying the first condition.\n\nThe second condition, $\\lvert F \\rvert \\le E$, may be violated by the raw flux, $F_{\\mathrm{raw}}$, particularly after an overshoot is applied. A flux limiter is a function that modifies $F_{\\mathrm{raw}}$ to produce a new flux $F$ that satisfies the condition. The problem specifies a \"minimal modification principle\": the magnitude of $F_{\\mathrm{raw}}$ should be reduced only if it is unphysically large, and its sign must be preserved. This leads to the following prescription for the limited flux $F$:\n$$ F = \\begin{cases} F_{\\mathrm{raw}} & \\text{if } |F_{\\mathrm{raw}}| \\le E \\\\ \\text{sgn}(F_{\\mathrm{raw}}) \\cdot E & \\text{if } |F_{\\mathrm{raw}}| > E \\end{cases} $$\nThis can be expressed compactly as:\n$$ F = \\text{sgn}(F_{\\mathrm{raw}}) \\cdot \\min(|F_{\\mathrm{raw}}|, E) $$\nwhere $\\text{sgn}(x)$ is the sign function. This formulation correctly handles all cases, including when $E=0$, which forces $F=0$.\n\n**3. Flux and Eddington Factors**\nThe flux factor $f$ is a normalized measure of the flux magnitude, defined as:\n$$ f = \\begin{cases} \\frac{\\lvert F \\rvert}{E} & \\text{if } E > 0 \\\\ 0 & \\text{if } E = 0 \\end{cases} $$\nBy construction, $0 \\le f \\le 1$. The Eddington factor, $\\chi(f)$, relates the radiation pressure to the energy density and is provided by a \"closure\" relation. The problem requires a choice of $\\chi(f)$ that satisfies:\n- $\\chi(0) = 1/3$ (isotropic diffusion limit)\n- $\\chi(1) = 1$ (free-streaming limit)\n- Monotonically non-decreasing on $f \\in [0,1]$.\n\nA simple polynomial choice that satisfies these conditions is:\n$$ \\chi(f) = \\frac{1}{3} + \\frac{2}{3}f^2 $$\nLet us verify this choice. At $f=0$, $\\chi(0) = 1/3$. At $f=1$, $\\chi(1) = 1/3 + 2/3 = 1$. The derivative is $\\chi'(f) = 4f/3$, which is non-negative for $f \\in [0,1]$, ensuring monotonicity. This closure will be used for the test cases requiring evaluation of $\\chi(f)$.\n\n**4. Test Case Evaluation**\nWe now apply this framework to each test case with a numerical tolerance of $\\varepsilon = 10^{-12}$.\n\n- **Test 1 (Free-streaming single beam)**:\n  - Input: Beam $(e_1,s_1)=(1.0,+1)$, $\\alpha=1.0$.\n  - Raw moments: $E_{\\mathrm{raw}} = 1.0$, $F_{\\mathrm{raw}} = 1.0 \\times (+1) = 1.0$.\n  - Limiter: $E=1.0$. Since $|F_{\\mathrm{raw}}|=1.0 \\le E=1.0$, no modification is needed. $F=1.0$.\n  - Realizability: $E=1.0 \\ge 0$ and $|F|=1.0 \\le E=1.0$. Holds.\n  - Factors: $f = |1.0|/1.0 = 1.0$. $\\chi(1.0) = 1/3 + 2/3(1.0)^2 = 1.0$.\n  - Conditions: $|f-1.0|=0 \\le \\varepsilon$ and $|\\chi(f)-1.0|=0 \\le \\varepsilon$. Both pass.\n  - Result: **True**.\n\n- **Test 2 (Isotropic two-beam crossing)**:\n  - Input: Beams $(1.0,+1)$ and $(1.0,-1)$, $\\alpha=1.0$.\n  - Raw moments: $E_{\\mathrm{raw}} = 1.0+1.0=2.0$, $F_{\\mathrm{raw}} = 1.0 \\times (+1) + 1.0 \\times (-1) = 0.0$.\n  - Limiter: $E=2.0$. Since $|F_{\\mathrm{raw}}|=0.0 \\le E=2.0$, no modification is needed. $F=0.0$.\n  - Realizability: $E=2.0 \\ge 0$ and $|F|=0.0 \\le E=2.0$. Holds.\n  - Factors: $f = |0.0|/2.0 = 0.0$. $\\chi(0.0) = 1/3 + 2/3(0.0)^2 = 1/3$.\n  - Conditions: $|f-0.0|=0 \\le \\varepsilon$ and $|\\chi(f)-1/3| \\approx 0 \\le \\varepsilon$. Both pass.\n  - Result: **True**.\n\n- **Test 3 (Monotonicity)**:\n  - Config A: One beam $(1.0,+1)$. From Test 1, we find $E_A=1.0, F_A=1.0 \\implies f_A = 1.0$.\n  - Config B: Beams $(1.0,+1)$ and $(0.2,-1)$.\n    - Raw moments: $E_{\\mathrm{raw}} = 1.0+0.2=1.2$, $F_{\\mathrm{raw}} = 1.0 \\times (+1) + 0.2 \\times (-1) = 0.8$.\n    - Limiter: $E_B=1.2$. Since $|F_{\\mathrm{raw}}|=0.8 \\le E_B=1.2$, no modification. $F_B=0.8$.\n    - Factor: $f_B = |0.8|/1.2 = 2/3$.\n  - Condition: Is $f_B \\le f_A + \\varepsilon$? Is $2/3 \\le 1.0 + \\varepsilon$? Yes.\n  - Result: **True**.\n\n- **Test 4 (Overshoot correction)**:\n  - Input: Beam $(1.0,+1)$, $\\alpha=1.5$.\n  - Raw moments: $E_{\\mathrm{raw}} = 1.0$. $F_{\\mathrm{raw}}$ before overshoot is $1.0$. Sign is positive. After overshoot, $F_{\\mathrm{raw}} = 1.5 \\times 1.0 = 1.5$.\n  - Limiter: $E=1.0$. Since $|F_{\\mathrm{raw}}|=1.5 > E=1.0$, the limiter activates. $F = \\text{sgn}(1.5) \\cdot \\min(1.5, 1.0) = 1.0 \\times 1.0 = 1.0$.\n  - Realizability: $E=1.0 \\ge 0$ and $|F|=1.0 \\le E=1.0$. Holds.\n  - Factor: $f = |1.0|/1.0 = 1.0$.\n  - Conditions: $|f-1.0|=0 \\le \\varepsilon$. Passes. The sign of $F=1.0$ is positive, matching the pre-overshoot $F_{\\mathrm{raw}}$ of $1.0$. Passes.\n  - Result: **True**.\n\n- **Test 5 (Zero-energy limit handling)**:\n  - Input: Raw moments $(E_{\\mathrm{raw}},F_{\\mathrm{raw}})=(0.0, 0.7)$.\n  - Limiter: $E=0.0$. Since $|F_{\\mathrm{raw}}|=0.7 > E=0.0$, the limiter activates. $F = \\text{sgn}(0.7) \\cdot \\min(0.7, 0.0) = 1.0 \\times 0.0 = 0.0$.\n  - Realizability: $E=0.0 \\ge 0$ and $|F|=0.0 \\le E=0.0$. Holds.\n  - Factor: Since $E=0$, $f=0$ by definition.\n  - Conditions: $E=0.0$, $F=0.0$, and $f=0.0$. All hold.\n  - Result: **True**.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\n# Global tolerance for floating point comparisons\nEPSILON = 1e-12\n\ndef chi(f):\n    \"\"\"\n    Computes the Eddington factor using a simple polynomial closure.\n    This closure satisfies chi(0)=1/3, chi(1)=1, and is monotonic.\n    The formula is chi(f) = 1/3 + 2/3 * f^2.\n    \"\"\"\n    return 1/3 + (2/3) * f**2\n\ndef process_moments(E_raw, F_raw):\n    \"\"\"\n    Applies the flux limiter to raw moments and computes the flux factor.\n    \n    Args:\n        E_raw (float): Raw energy density.\n        F_raw (float): Raw flux.\n        \n    Returns:\n        tuple: A tuple containing the limited (E, F) and the flux factor f.\n    \"\"\"\n    E = E_raw\n\n    # Apply the flux limiter based on the minimal modification principle.\n    # The magnitude of the flux is capped at E, while its sign is preserved.\n    # F = sgn(F_raw) * min(|F_raw|, E).\n    # np.copysign is used for a robust implementation of sgn(F_raw) * magnitude.\n    magnitude_F = min(abs(F_raw), E)\n    F = np.copysign(magnitude_F, F_raw) if F_raw != 0 else 0.0\n    \n    # If E is exactly zero, the realizability condition |F| <= E forces F to be zero.\n    # The line above handles this correctly since min(abs(F_raw), 0) is 0.\n\n    # Compute the flux factor f, handling the E=0 case.\n    if E > 0:\n        f = abs(F) / E\n    else:  # E is zero, so f is zero by definition.\n        f = 0.0\n        \n    return E, F, f\n\ndef test_1():\n    \"\"\"Test 1: Free-streaming single beam, no overshoot.\"\"\"\n    beams = [(1.0, 1.0)]  # (e_i, s_i)\n    alpha = 1.0\n    \n    E_raw = sum(e for e, s in beams)\n    F_raw_pre = sum(e * s for e, s in beams)\n    F_raw = alpha * F_raw_pre\n    \n    E, F, f = process_moments(E_raw, F_raw)\n    \n    realizability_ok = (E >= 0 and abs(F) <= E + EPSILON)\n    f_ok = abs(f - 1.0) <= EPSILON\n    chi_val = chi(f)\n    chi_ok = abs(chi_val - 1.0) <= EPSILON\n    \n    return all([realizability_ok, f_ok, chi_ok])\n\ndef test_2():\n    \"\"\"Test 2: Isotropic two-beam crossing, no overshoot.\"\"\"\n    beams = [(1.0, 1.0), (1.0, -1.0)]\n    alpha = 1.0\n\n    E_raw = sum(e for e, s in beams)\n    F_raw_pre = sum(e * s for e, s in beams)\n    F_raw = alpha * F_raw_pre\n    \n    E, F, f = process_moments(E_raw, F_raw)\n    \n    realizability_ok = (E >= 0 and abs(F) <= E + EPSILON)\n    f_ok = abs(f - 0.0) <= EPSILON\n    chi_val = chi(f)\n    chi_ok = abs(chi_val - (1/3)) <= EPSILON\n    \n    return all([realizability_ok, f_ok, chi_ok])\n\ndef test_3():\n    \"\"\"Test 3: Monotonicity under added counter-flow.\"\"\"\n    # Configuration A\n    beams_A = [(1.0, 1.0)]\n    E_raw_A = sum(e for e, s in beams_A)\n    F_raw_A = sum(e * s for e, s in beams_A)\n    _, _, f_A = process_moments(E_raw_A, F_raw_A)\n\n    # Configuration B\n    beams_B = [(1.0, 1.0), (0.2, -1.0)]\n    E_raw_B = sum(e for e, s in beams_B)\n    F_raw_B = sum(e * s for e, s in beams_B)\n    _, _, f_B = process_moments(E_raw_B, F_raw_B)\n    \n    monotonicity_ok = f_B <= f_A + EPSILON\n    return monotonicity_ok\n\ndef test_4():\n    \"\"\"Test 4: Overshoot correction.\"\"\"\n    beams = [(1.0, 1.0)]\n    alpha = 1.5\n    \n    E_raw = sum(e for e, s in beams)\n    F_raw_pre = sum(e * s for e, s in beams)\n    sign_F_raw_pre = np.sign(F_raw_pre)\n    \n    F_raw = alpha * F_raw_pre\n    \n    E, F, f = process_moments(E_raw, F_raw)\n    \n    realizability_ok = (E >= 0 and abs(F) <= E + EPSILON)\n    f_ok = abs(f - 1.0) <= EPSILON\n\n    # If F is zero, its sign can be considered to match any other sign for this problem's purpose\n    sign_F = np.sign(F) if F != 0 else sign_F_raw_pre\n    sign_ok = sign_F == sign_F_raw_pre\n\n    return all([realizability_ok, f_ok, sign_ok])\n\ndef test_5():\n    \"\"\"Test 5: Zero-energy limit handling.\"\"\"\n    E_raw = 0.0\n    F_raw = 0.7\n    \n    E, F, f = process_moments(E_raw, F_raw)\n    \n    realizability_ok = (E >= 0 and abs(F) <= E + EPSILON)\n    E_ok = (E == 0.0)\n    F_ok = (F == 0.0)\n    f_ok = (f == 0.0)\n    \n    return all([realizability_ok, E_ok, F_ok, f_ok])\n\ndef solve():\n    \"\"\"\n    Executes all test cases and prints the results in the required format.\n    \"\"\"\n    test_cases = [\n        test_1,\n        test_2,\n        test_3,\n        test_4,\n        test_5\n    ]\n\n    results = []\n    for test_func in test_cases:\n        results.append(test_func())\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == '__main__':\n    solve()\n```", "id": "3480969"}, {"introduction": "A robust numerical simulation requires not only a stable interior evolution but also physically consistent boundary conditions. This is especially true in numerical relativity, where outflow or excision boundaries are commonplace. This advanced exercise challenges you to design and test a constraint-preserving outflow boundary condition by analyzing the characteristic (wave-like) structure of the moment equations. Mastering this technique is essential for minimizing spurious reflections and ensuring the accuracy of simulations involving dynamic astrophysical phenomena like compact object mergers [@problem_id:3480949].", "problem": "You are to design and test a constraint-preserving boundary condition for neutrino two-moment transport at excision or outflow boundaries within a one-dimensional reduction suitable for numerical relativity applications. Start from the following fundamental base and definitions.\n\nThe two-moment approximation (also called the M1 closure in its simplest form) models the neutrino radiation field using the energy density moment and flux moment. Consider a one-dimensional, dimensionless, linearized system with a constant Eddington factor closure:\n$$\n\\partial_t E + \\partial_x F = 0,\\qquad \\partial_t F + \\partial_x \\left(\\chi E\\right) = 0,\n$$\nwhere $E$ is the neutrino energy density moment, $F$ is the neutrino flux moment, and $\\chi \\in (0,1]$ is a constant Eddington factor standing in for the closure. This system represents the hyperbolic part of the neutrino transport under special-relativistic units with $c=1$ and no source terms. The physically admissible state must satisfy the causality constraint $E \\ge |F|$.\n\nYour task is to:\n- Derive the characteristic structure (eigenvalues and eigenvectors) of the above hyperbolic system and write the incoming and outgoing characteristic variables at a boundary.\n- Formulate an outflow (no-inflow) boundary condition at a boundary with outward unit normal $n$ that sets the incoming characteristic variable to zero while preserving the outgoing characteristic variable from the interior. The boundary condition must be constraint-preserving in the sense that the boundary state must satisfy $E \\ge |F|$ after application of the boundary condition.\n- Implement a first-order conservative finite-volume integrator using a local Lax-Friedrichs (Rusanov) numerical flux for the above system on the spatial domain $x \\in [0, L]$ with $L=1$. Use a uniform grid with $N_x$ cells and a time step chosen by a Courant–Friedrichs–Lewy (CFL) number $\\text{CFL} \\in (0,1)$.\n- Initialize a purely right-moving neutrino pulse by choosing the initial condition\n$$\nE(x,0) = E_0 \\exp\\!\\left(-\\frac{(x-x_0)^2}{2 \\sigma^2}\\right),\\qquad F(x,0) = \\lambda E(x,0),\n$$\nwhere $\\lambda$ is the positive characteristic speed of the system and $(E_0,\\; x_0,\\; \\sigma)$ are constants. This ensures a right-going characteristic with negligible left-going content initially.\n- Evolve the system to a final time\n$$\nT_{\\text{end}} = \\alpha \\frac{L - x_0}{\\lambda},\n$$\nwhere $\\alpha>1$ ensures that the pulse has fully interacted with the right boundary, and measure spurious reflections through the time-integrated incoming normal flux at both boundaries, defined by the following. Let $F^i n_i$ be the projection of the flux moment onto the outward unit normal at a boundary face. Define the incoming magnitude $\\mathcal{I}(t)$ at a boundary as the positive part of $-\\left(F^i n_i\\right)$, i.e., $\\mathcal{I}(t) = \\max\\left(0, -F^i n_i\\right)$. The total incoming measure over the simulation is\n$$\n\\mathcal{R} = \\frac{1}{\\int_0^L E(x,0)\\,dx}\\int_0^{T_{\\text{end}}}\\left[\\mathcal{I}_{\\text{left}}(t) + \\mathcal{I}_{\\text{right}}(t)\\right]\\,dt,\n$$\nwhere the denominator normalizes by the initial total energy in the domain. The value $\\mathcal{R}$ is dimensionless.\n\nImplement and compare two boundary conditions at both domain boundaries:\n- A naive zero-gradient boundary condition, defined by copying the interior cell into the ghost cell.\n- Your derived characteristic no-inflow, constraint-preserving boundary condition that sets the incoming characteristic variable to zero and preserves the outgoing one.\n\nFor numerical clarity, take $L=1$ (dimensionless), $E_0=1$ (dimensionless), $\\sigma=0.05$ (dimensionless), $x_0=0.25$ (dimensionless), and $\\alpha=1.1$ (dimensionless). Ensure that all computations are performed in dimensionless units.\n\nTest suite. For each parameter tuple $(\\chi,\\; \\text{CFL},\\; N_x,\\; \\text{BC})$, compute the reflection metric $\\mathcal{R}$ as defined above. Use the following five test cases:\n- Test $1$: $(\\chi = 1/3,\\; \\text{CFL} = 2/5,\\; N_x = 400,\\; \\text{BC} = \\text{char})$.\n- Test $2$: $(\\chi = 1/3,\\; \\text{CFL} = 2/5,\\; N_x = 400,\\; \\text{BC} = \\text{naive})$.\n- Test $3$: $(\\chi = 9/10,\\; \\text{CFL} = 2/5,\\; N_x = 400,\\; \\text{BC} = \\text{char})$.\n- Test $4$: $(\\chi = 9/10,\\; \\text{CFL} = 2/5,\\; N_x = 400,\\; \\text{BC} = \\text{naive})$.\n- Test $5$: $(\\chi = 9/10,\\; \\text{CFL} = 19/20,\\; N_x = 200,\\; \\text{BC} = \\text{char})$.\n\nYour program should compute the list of five $\\mathcal{R}$ values, one per test in the order above, as floating-point numbers rounded to $6$ decimal places. The final program output must be a single line containing the results as a comma-separated list enclosed in square brackets, for example, $[r_1,r_2,r_3,r_4,r_5]$, where each $r_j$ is the rounded value for test $j$. All outputs are dimensionless numbers. Angles do not appear in this problem. Percentages do not appear in this problem. No physical units are required because all quantities are dimensionless. The output must strictly adhere to this format and contain no additional text.", "solution": "### Solution Derivation\n\n#### 1. Characteristic Structure of the System\nThe system of equations can be written in vector form as $\\partial_t \\mathbf{U} + \\partial_x \\mathbf{F}(\\mathbf{U}) = 0$, where the state vector is $\\mathbf{U} = [E, F]^T$ and the flux vector is $\\mathbf{F}(\\mathbf{U}) = [F, \\chi E]^T$. For this linear system, this is equivalent to $\\partial_t \\mathbf{U} + A\\partial_x \\mathbf{U} = 0$, where $A$ is the Jacobian matrix of the flux:\n$$\nA = \\frac{\\partial \\mathbf{F}}{\\partial \\mathbf{U}} = \\begin{pmatrix} 0 & 1 \\\\ \\chi & 0 \\end{pmatrix}\n$$\nThe characteristic speeds are the eigenvalues $\\lambda$ of $A$, found by solving $\\det(A - \\lambda I) = 0$:\n$$\n(-\\lambda)(-\\lambda) - (1)(\\chi) = \\lambda^2 - \\chi = 0 \\implies \\lambda_\\pm = \\pm\\sqrt{\\chi}\n$$\nThe right eigenvectors $\\mathbf{r}_\\pm$, satisfying $A\\mathbf{r}_\\pm = \\lambda_\\pm \\mathbf{r}_\\pm$, are:\n$$\n\\mathbf{r}_+ = \\begin{pmatrix} 1 \\\\ \\sqrt{\\chi} \\end{pmatrix} \\quad (\\text{for } \\lambda_+ = \\sqrt{\\chi}), \\qquad \\mathbf{r}_- = \\begin{pmatrix} 1 \\\\ -\\sqrt{\\chi} \\end{pmatrix} \\quad (\\text{for } \\lambda_- = -\\sqrt{\\chi})\n$$\nThe corresponding left eigenvectors $\\mathbf{l}_\\pm$, satisfying $\\mathbf{l}_\\pm A = \\lambda_\\pm \\mathbf{l}_\\pm$ (and normalized such that $\\mathbf{l}_i \\cdot \\mathbf{r}_j = \\delta_{ij}$), are the rows of the inverse of the matrix of right eigenvectors. An unnormalized set is $\\mathbf{l}_+ = [\\sqrt{\\chi}, 1]$ and $\\mathbf{l}_- = [\\sqrt{\\chi}, -1]$.\nThe characteristic variables, which diagonalize the system, are formed by projecting the state vector onto the left eigenvectors:\n$$\nw_+ = \\sqrt{\\chi}E + F \\quad (\\text{right-going, associated with } \\lambda_+ > 0)\n$$\n$$\nw_- = \\sqrt{\\chi}E - F \\quad (\\text{left-going, associated with } \\lambda_- < 0)\n$$\nThe initial condition $F(x,0) = \\lambda E(x,0)$ with $\\lambda = \\sqrt{\\chi}$ implies that $w_-(x,0) = \\sqrt{\\chi}E(x,0) - \\sqrt{\\chi}E(x,0) = 0$. Thus, the initial pulse is purely right-going.\n\n#### 2. Characteristic Outflow Boundary Condition\nAn outflow boundary condition prevents spurious information from entering the domain. This is achieved by setting the incoming characteristic variables to zero at the boundary.\n\n**At the right boundary ($x=L=1$):**\nThe outward unit normal is $n=+1$. A wave is incoming if its speed $\\lambda$ satisfies $\\lambda n < 0$.\n- The wave associated with $\\lambda_+ = \\sqrt{\\chi}$ is outgoing ($\\lambda_+ n > 0$).\n- The wave associated with $\\lambda_- = -\\sqrt{\\chi}$ is incoming ($\\lambda_- n < 0$).\nThe boundary condition is thus:\n1.  Set the incoming characteristic to zero: $w_{-, g} = 0$, where the subscript $g$ denotes the ghost cell state $(E_g, F_g)$. This implies $\\sqrt{\\chi}E_g - F_g = 0$.\n2.  Preserve the outgoing characteristic from the interior: $w_{+, g} = w_{+, i}$, where $i$ denotes the last interior cell state $(E_i, F_i)$. This implies $\\sqrt{\\chi}E_g + F_g = \\sqrt{\\chi}E_i + F_i$.\nSolving this $2 \\times 2$ system yields the ghost cell state:\n$$\nE_g = \\frac{1}{2}\\left(E_i + \\frac{F_i}{\\sqrt{\\chi}}\\right), \\qquad F_g = \\sqrt{\\chi} E_g\n$$\n\n**At the left boundary ($x=0$):**\nThe outward unit normal is $n=-1$. A wave is incoming if $\\lambda n < 0$.\n- The wave associated with $\\lambda_+ = \\sqrt{\\chi}$ is incoming ($\\lambda_+ n < 0$).\n- The wave associated with $\\lambda_- = -\\sqrt{\\chi}$ is outgoing ($\\lambda_- n > 0$).\nThe boundary condition is:\n1.  Set the incoming characteristic to zero: $w_{+, g} = 0 \\implies \\sqrt{\\chi}E_g + F_g = 0$.\n2.  Preserve the outgoing characteristic from the interior: $w_{-, g} = w_{-, i} \\implies \\sqrt{\\chi}E_g - F_g = \\sqrt{\\chi}E_i - F_i$.\nSolving for the ghost cell state gives:\n$$\nE_g = \\frac{1}{2}\\left(E_i - \\frac{F_i}{\\sqrt{\\chi}}\\right), \\qquad F_g = -\\sqrt{\\chi} E_g\n$$\n\n**Constraint Preservation:** The derived ghost cell state satisfies $|F_g| = \\sqrt{\\chi}|E_g|$. For the constraint $E_g \\ge |F_g|$ to hold, we need $E_g \\ge \\sqrt{\\chi}|E_g|$, which is true if $E_g \\ge 0$ since $\\sqrt{\\chi} \\le 1$. However, the formula for $E_g$ can yield a negative value if the interior state $(E_i, F_i)$ has a flux magnitude $|F_i|$ that is large relative to $E_i$. For example, at the right boundary, if $F_i < -\\sqrt{\\chi}E_i$, $E_g$ will be negative (which is physically invalid). To enforce constraint preservation, we add a floor: if the computed $E_g$ is negative, the state represents a vacuum. We therefore set the ghost cell state to $(E_g, F_g) = (0, 0)$. This state trivially satisfies both the no-inflow condition and the physical constraint.\n\n#### 3. Numerical Integration Scheme\nWe use a first-order finite-volume method on a uniform grid with cell width $\\Delta x = L/N_x$. The state in cell $j$ is updated via:\n$$\n\\mathbf{U}_j^{n+1} = \\mathbf{U}_j^n - \\frac{\\Delta t}{\\Delta x}(\\mathbf{F}^*_{j+1/2} - \\mathbf{F}^*_{j-1/2})\n$$\nwhere $\\mathbf{F}^*_{j+1/2}$ is the numerical flux at the interface between cells $j$ and $j+1$. We use the local Lax-Friedrichs (Rusanov) flux:\n$$\n\\mathbf{F}^*(\\mathbf{U}_L, \\mathbf{U}_R) = \\frac{1}{2}\\left(\\mathbf{F}(\\mathbf{U}_L) + \\mathbf{F}(\\mathbf{U}_R)\\right) - \\frac{S_{\\max}}{2}(\\mathbf{U}_R - \\mathbf{U}_L)\n$$\nHere, $\\mathbf{U}_L$ and $\\mathbf{U}_R$ are the states to the left and right of the interface. For this system, the maximum characteristic speed is $S_{\\max} = \\max(|\\lambda_\\pm|) = \\sqrt{\\chi}$. The time step is chosen to satisfy the CFL condition:\n$$\n\\Delta t = \\text{CFL} \\frac{\\Delta x}{S_{\\max}} = \\text{CFL} \\frac{\\Delta x}{\\sqrt{\\chi}}\n$$\n\n#### 4. Reflection Metric Calculation\nThe reflection metric $\\mathcal{R}$ normalizes the total time-integrated incoming flux by the total initial energy.\n- The total initial energy is calculated by summing over the grid: $\\int_0^L E(x,0) dx \\approx \\sum_{j=0}^{N_x-1} E_j(t=0) \\Delta x$.\n- The time integral is approximated by a sum over time steps: $\\int_0^{T_{\\text{end}}} (\\dots) dt \\approx \\sum_n (\\dots) \\Delta t$.\n- The incoming flux magnitude, $\\mathcal{I}(t) = \\max(0, -F^i n_i)$, is computed at each boundary.\n    - At the left boundary ($x=0$, $n=-1$): $\\mathcal{I}_{\\text{left}}(t) = \\max(0, F(x=0, t))$.\n    - At the right boundary ($x=L$, $n=1$): $\\mathcal{I}_{\\text{right}}(t) = \\max(0, -F(x=L, t))$.\n- The physical flux $F$ at a boundary interface is approximated by the energy component of the numerical flux vector $\\mathbf{F}^*$ evaluated at that interface. For instance, $F(x=L, t)$ is approximated by the first component of $\\mathbf{F}^*_{N_x-1/2}$. This ensures consistency with the numerical scheme.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite for neutrino transport boundary conditions.\n    \"\"\"\n\n    def run_simulation(chi, cfl, Nx, bc_type):\n        \"\"\"\n        Runs a single 1D neutrino transport simulation and computes the reflection metric.\n\n        Args:\n            chi (float): The Eddington factor.\n            cfl (float): The CFL number for time-stepping.\n            Nx (int): The number of spatial grid cells.\n            bc_type (str): The boundary condition type ('char' or 'naive').\n\n        Returns:\n            float: The computed reflection metric R.\n        \"\"\"\n        # --- 1. Setup Simulation Parameters and Grid ---\n        L = 1.0\n        E0 = 1.0\n        sigma = 0.05\n        x0 = 0.25\n        alpha = 1.1\n\n        dx = L / Nx\n        x = np.linspace(dx / 2.0, L - dx / 2.0, Nx)\n\n        lambda_speed = np.sqrt(chi)\n        dt = cfl * dx / lambda_speed\n        T_end = alpha * (L - x0) / lambda_speed\n\n        # --- 2. Initial Conditions ---\n        E = E0 * np.exp(-((x - x0) ** 2) / (2.0 * sigma**2))\n        F = lambda_speed * E\n        U = np.array([E, F])\n\n        initial_total_energy = np.sum(U[0, :]) * dx\n\n        # --- 3. Main Evolution Loop ---\n        t = 0.0\n        total_integrated_inflow = 0.0\n        num_ghost_cells = 1\n\n        while t < T_end:\n            # Ensure the final step does not overshoot T_end\n            current_dt = min(dt, T_end - t)\n\n            # --- 3a. Apply Boundary Conditions ---\n            U_g = np.zeros((2, Nx + 2 * num_ghost_cells))\n            U_g[:, num_ghost_cells:-num_ghost_cells] = U\n\n            if bc_type == 'naive':\n                # Zero-gradient BC: copy interior to ghost\n                U_g[:, 0] = U_g[:, 1]  # Left ghost cell\n                U_g[:, -1] = U_g[:, -2]  # Right ghost cell\n            elif bc_type == 'char':\n                # Characteristic no-inflow BC\n                # Left boundary (x=0)\n                E_i_left, F_i_left = U[:, 0]\n                E_g_left = 0.5 * (E_i_left - F_i_left / lambda_speed)\n                if E_g_left < 0.0:\n                    U_g[:, 0] = 0.0\n                else:\n                    U_g[0, 0] = E_g_left\n                    U_g[1, 0] = -lambda_speed * E_g_left\n\n                # Right boundary (x=L)\n                E_i_right, F_i_right = U[:, -1]\n                E_g_right = 0.5 * (E_i_right + F_i_right / lambda_speed)\n                if E_g_right < 0.0:\n                    U_g[:, -1] = 0.0\n                else:\n                    U_g[0, -1] = E_g_right\n                    U_g[1, -1] = lambda_speed * E_g_right\n            \n            # --- 3b. Compute Numerical Fluxes (Rusanov) ---\n            # Physical flux F(U) = [F, chi*E]\n            def physical_flux(state_vec):\n                flux_vec = np.zeros_like(state_vec)\n                flux_vec[0, :] = state_vec[1, :]       # Flux of E is F\n                flux_vec[1, :] = chi * state_vec[0, :]  # Flux of F is chi*E\n                return flux_vec\n\n            U_L = U_g[:, :-1]\n            U_R = U_g[:, 1:]\n            \n            F_phys_L = physical_flux(U_L)\n            F_phys_R = physical_flux(U_R)\n            \n            s_max = lambda_speed\n            F_num = 0.5 * (F_phys_L + F_phys_R) - 0.5 * s_max * (U_R - U_L)\n\n            # --- 3c. Calculate and Accumulate Reflection Metric ---\n            # At left boundary (x=0), normal n=-1. Incoming flux F > 0.\n            # Use energy component of numerical flux at interface 0.\n            F_bdy_left = F_num[0, 0]\n            inflow_left = max(0.0, F_bdy_left)\n            \n            # At right boundary (x=L), normal n=1. Incoming flux F < 0.\n            # Use energy component of numerical flux at last interface.\n            F_bdy_right = F_num[0, -1]\n            inflow_right = max(0.0, -F_bdy_right)\n\n            total_integrated_inflow += (inflow_left + inflow_right) * current_dt\n\n            # --- 3d. Update State Vector (First-Order Finite Volume) ---\n            U -= (current_dt / dx) * (F_num[:, 1:] - F_num[:, :-1])\n            \n            t += current_dt\n\n        # --- 4. Compute Final Metric ---\n        if initial_total_energy > 0:\n            R = total_integrated_inflow / initial_total_energy\n        else:\n            R = 0.0\n        \n        return R\n\n    # --- Test Suite ---\n    test_cases = [\n        # (chi, cfl, Nx, bc_type)\n        (1.0/3.0, 2.0/5.0, 400, 'char'),\n        (1.0/3.0, 2.0/5.0, 400, 'naive'),\n        (9.0/10.0, 2.0/5.0, 400, 'char'),\n        (9.0/10.0, 2.0/5.0, 400, 'naive'),\n        (9.0/10.0, 19.0/20.0, 200, 'char'),\n    ]\n\n    results = []\n    for case in test_cases:\n        chi, cfl, Nx, bc_type = case\n        result = run_simulation(chi, cfl, Nx, bc_type)\n        results.append(round(result, 6))\n\n    # --- Final Output ---\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```", "id": "3480949"}]}